# Tree View:
```
.
â”œâ”€â”€ CLAUDE.md
â”œâ”€â”€ clear-storage.html
â”œâ”€â”€ debug-chat.html
â”œâ”€â”€ FIX_SUMMARY.md
â”œâ”€â”€ imgs
â”‚   â””â”€â”€ pc.gif
â”œâ”€â”€ index.html
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ react-grab-js
â”‚   â”œâ”€â”€ claude-client.global.js
â”‚   â”œâ”€â”€ cursor-client.global.js
â”‚   â”œâ”€â”€ gemini-client.global.js
â”‚   â””â”€â”€ index.global.js
â”œâ”€â”€ README.md
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ components
â”‚   â”‚   â”œâ”€â”€ chat
â”‚   â”‚   â”‚   â””â”€â”€ components
â”‚   â”‚   â”‚       â”œâ”€â”€ ChatHeader.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ ChatInputArea.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ ChatMessage.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ ChatMessageList.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ ChatModelSelector.tsx
â”‚   â”‚   â”‚       â””â”€â”€ ChatQuickReplies.tsx
â”‚   â”‚   â”œâ”€â”€ ChatInterface.tsx
â”‚   â”‚   â”œâ”€â”€ GenerateSettingsModal.tsx
â”‚   â”‚   â”œâ”€â”€ GitCommit.tsx
â”‚   â”‚   â”œâ”€â”€ layout
â”‚   â”‚   â”‚   â”œâ”€â”€ DesktopLayout.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TopModelSelector.tsx
â”‚   â”‚   â”‚   â””â”€â”€ TopNavigation.tsx
â”‚   â”‚   â”œâ”€â”€ modules
â”‚   â”‚   â”‚   â”œâ”€â”€ GenerateModule.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ library
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ components
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ PromptDetailModal.tsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ PromptList.tsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ VersionDetailModal.tsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ VersionHistoryContent.tsx
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ VersionHistoryPanel.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ LibraryModule.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ optimize
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ComparisonPanel.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationMessage.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dialogs
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SaveUserPromptDialog.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DiffViewer.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OptimizeSectionRedesign.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ quick
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OptimizeQualityIndicator.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuickOptimizeInput.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuickOptimizeResult.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SystemPromptModal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserPromptQuickOptimize.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsModal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SystemPromptModal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ VersionSelector.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ hooks
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ useComparison.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ OptimizeModule.tsx
â”‚   â”‚   â”‚   â””â”€â”€ PlaygroundModule.tsx
â”‚   â”‚   â”œâ”€â”€ NotificationContainer.tsx
â”‚   â”‚   â”œâ”€â”€ playground
â”‚   â”‚   â”‚   â”œâ”€â”€ MindMap.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PlaygroundApp.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PlaygroundChatPanel.tsx
â”‚   â”‚   â”‚   â””â”€â”€ PreviewPanel.tsx
â”‚   â”‚   â”œâ”€â”€ preview
â”‚   â”‚   â”‚   â””â”€â”€ components
â”‚   â”‚   â”‚       â”œâ”€â”€ common
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ EmptyState.tsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ LoadingState.tsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ PreviewHeader.tsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ TabButton.tsx
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ TabContainer.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ dialogs
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ SavePromptDialog.tsx
â”‚   â”‚   â”‚       â””â”€â”€ tabs
â”‚   â”‚   â”‚           â”œâ”€â”€ AdviceTab.tsx
â”‚   â”‚   â”‚           â”œâ”€â”€ FinalTab.tsx
â”‚   â”‚   â”‚           â”œâ”€â”€ InitialTab.tsx
â”‚   â”‚   â”‚           â”œâ”€â”€ ReportTab.tsx
â”‚   â”‚   â”‚           â””â”€â”€ ThinkingTab.tsx
â”‚   â”‚   â”œâ”€â”€ PreviewPanel.tsx
â”‚   â”‚   â””â”€â”€ settings
â”‚   â”‚       â”œâ”€â”€ components
â”‚   â”‚       â”‚   â”œâ”€â”€ OptimizeTab.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ SettingsButton.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ SettingsHeader.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ tabs
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ ModelParamsTab.tsx
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ PromptsTab.tsx
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ ProvidersTab.tsx
â”‚   â”‚       â”‚   â””â”€â”€ TestDetailDialog.tsx
â”‚   â”‚       â”œâ”€â”€ composables
â”‚   â”‚       â”‚   â”œâ”€â”€ useModelParams.ts
â”‚   â”‚       â”‚   â””â”€â”€ usePromptRules.ts
â”‚   â”‚       â””â”€â”€ SettingsModal.tsx
â”‚   â”œâ”€â”€ composables
â”‚   â”‚   â””â”€â”€ useConfirmDialog.ts
â”‚   â”œâ”€â”€ config
â”‚   â”‚   â”œâ”€â”€ playgroundInstructions.ts
â”‚   â”‚   â”œâ”€â”€ promptGenerator.ts
â”‚   â”‚   â”œâ”€â”€ prompts
â”‚   â”‚   â”‚   â”œâ”€â”€ finalPromptGenerationRules.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ optimizationAdvice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ optimizationApplication.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ promptOptimization.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ promptTemplates.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ qualityAnalysis.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â”‚   â”œâ”€â”€ requirementReportRules.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ systemPromptGeneration.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ systemPromptRules.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ systemPromptSlimRules.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ thinkingPointsExtraction.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ userGuidedRules.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ userPromptOptimization.ts
â”‚   â”‚   â”‚   â””â”€â”€ userPromptQualityAnalysis.ts
â”‚   â”‚   â””â”€â”€ prompts.ts
â”‚   â”œâ”€â”€ env.d.ts
â”‚   â”œâ”€â”€ hooks
â”‚   â”‚   â”œâ”€â”€ useChatAttachments.ts
â”‚   â”‚   â”œâ”€â”€ useChatInput.ts
â”‚   â”‚   â”œâ”€â”€ useChatLogic.ts
â”‚   â”‚   â”œâ”€â”€ useChatMessageOperations.ts
â”‚   â”‚   â”œâ”€â”€ useChatMessages.ts
â”‚   â”‚   â”œâ”€â”€ useChatModel.ts
â”‚   â”‚   â”œâ”€â”€ useChatQuickReplies.ts
â”‚   â”‚   â”œâ”€â”€ useConversationMessages.ts
â”‚   â”‚   â”œâ”€â”€ useEnsureAIConfig.ts
â”‚   â”‚   â”œâ”€â”€ useOptimizeModule.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewClipboard.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewConversion.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewExecution.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewHelpers.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewListOperations.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewScrollSync.ts
â”‚   â”‚   â”œâ”€â”€ usePreviewTabs.ts
â”‚   â”‚   â””â”€â”€ useUserPromptQuickOptimize.ts
â”‚   â”œâ”€â”€ main.tsx
â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”œâ”€â”€ ai
â”‚   â”‚   â”‚   â”œâ”€â”€ errors
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AIErrorHandler.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorParser.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ multimodal
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnthropicAttachmentHandler.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AttachmentConverter.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleAttachmentHandler.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OpenAIAttachmentHandler.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ providers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnthropicProvider.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BaseProvider.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleProvider.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ OpenAIProvider.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ streaming
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SSEParser.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StreamFilter.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ StreamProcessor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ utils
â”‚   â”‚   â”‚       â”œâ”€â”€ apiUrlBuilder.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ ModelFetcher.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ ResponseCleaner.ts
â”‚   â”‚   â”‚       â””â”€â”€ responseCleaners.ts
â”‚   â”‚   â”œâ”€â”€ aiGuideService.ts
â”‚   â”‚   â”œâ”€â”€ aiService.ts
â”‚   â”‚   â”œâ”€â”€ apiService.ts
â”‚   â”‚   â”œâ”€â”€ capabilityDetector.ts
â”‚   â”‚   â”œâ”€â”€ mockApiService.ts
â”‚   â”‚   â”œâ”€â”€ playground
â”‚   â”‚   â”‚   â”œâ”€â”€ aiPlaygroundService.ts
â”‚   â”‚   â”‚   â””â”€â”€ artifactParser.ts
â”‚   â”‚   â”œâ”€â”€ promptGeneratorService.ts
â”‚   â”‚   â”œâ”€â”€ promptOptimizationService.ts
â”‚   â”‚   â”œâ”€â”€ settingsApi.ts
â”‚   â”‚   â””â”€â”€ versionService.ts
â”‚   â”œâ”€â”€ stores
â”‚   â”‚   â”œâ”€â”€ authStore.ts
â”‚   â”‚   â”œâ”€â”€ navigationStore.ts
â”‚   â”‚   â”œâ”€â”€ notificationStore.ts
â”‚   â”‚   â”œâ”€â”€ optimizeStore.ts
â”‚   â”‚   â”œâ”€â”€ promptStore.ts
â”‚   â”‚   â”œâ”€â”€ providerStore.ts
â”‚   â”‚   â””â”€â”€ settingsStore.ts
â”‚   â”œâ”€â”€ style
â”‚   â”‚   â””â”€â”€ playground.css
â”‚   â”œâ”€â”€ style.css
â”‚   â”œâ”€â”€ types
â”‚   â”‚   â”œâ”€â”€ global.d.ts
â”‚   â”‚   â”œâ”€â”€ optimize.ts
â”‚   â”‚   â””â”€â”€ prompt.ts
â”‚   â”œâ”€â”€ utils
â”‚   â”‚   â”œâ”€â”€ aiResponseUtils.ts
â”‚   â”‚   â”œâ”€â”€ chartLazyLoader.ts
â”‚   â”‚   â”œâ”€â”€ clipboardUtils.ts
â”‚   â”‚   â”œâ”€â”€ ensureAIConfig.ts
â”‚   â”‚   â”œâ”€â”€ fileUtils.ts
â”‚   â”‚   â”œâ”€â”€ jsonParser.ts
â”‚   â”‚   â””â”€â”€ playgroundGlobals.ts
â”‚   â””â”€â”€ views
â”‚       â””â”€â”€ LoginView.tsx
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ test-auto-generation.html
â”œâ”€â”€ test-fix.html
â”œâ”€â”€ test_persist.html
â”œâ”€â”€ tsconfig.json
â””â”€â”€ vite.config.ts

```

# Content:

## CLAUDE.md

````md
# CLAUDE.md

æœ¬æ–‡ä»¶ä¸º Claude Code (claude.ai/code) åœ¨æ­¤ä»£ç åº“ä¸­å·¥ä½œæ—¶æä¾›æŒ‡å¯¼ã€‚

## é¡¹ç›®æ¦‚è¿°

YPrompt æ˜¯ä¸€ä¸ªåŸºäº React 18 çš„å‰ç«¯åº”ç”¨ç¨‹åºï¼Œç”¨äº AI é©±åŠ¨çš„æç¤ºè¯ç”Ÿæˆå’Œç®¡ç†ã€‚å®ƒæä¾›äº†æ¨¡å—åŒ–ç•Œé¢ï¼ŒåŒ…å«ç”Ÿæˆã€ä¼˜åŒ–ã€æ“ç»ƒåœºå’Œåº“ç­‰åŠŸèƒ½åŒºåŸŸã€‚è¯¥åº”ç”¨ä½¿ç”¨æœ¬åœ°ç”¨æˆ·å/å¯†ç è®¤è¯é…åˆ JWT tokenï¼Œå¹¶é€šè¿‡ç»Ÿä¸€æ¥å£æ”¯æŒå¤šä¸ª AI æä¾›å•†ã€‚

## å¼€å‘å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆåŒ…å«ç±»å‹æ£€æŸ¥ï¼‰
npm run build

# ä»…ç±»å‹æ£€æŸ¥ï¼ˆæ’é™¤ optimize æ¨¡å—ï¼‰
npm run type-check

# ä»£ç æ£€æŸ¥å’Œä¿®å¤
npm run lint

# ä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç 
npm run format

# é¢„è§ˆç”Ÿäº§æ„å»º
npm run preview

# æµ‹è¯• AI æä¾›å•†é…ç½®
node test_default_provider_model.js

# å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ— éœ€åç«¯ï¼‰
VITE_DEBUG_MODE=true npm run dev
```

## æ¶æ„æ¦‚è¿°

### æŠ€æœ¯æ ˆ
- **React 18.3** é…åˆ TypeScript å’Œç°ä»£ Hooks
- **Vite 5.0** ä½œä¸ºæ„å»ºå·¥å…·å’Œå¼€å‘æœåŠ¡å™¨
- **Zustand 4.5** ç”¨äºçŠ¶æ€ç®¡ç†
- **React Router 6.26** ç”¨äºè·¯ç”±
- **Tailwind CSS 3.3** ç”¨äºæ ·å¼
- **å…³é”®åº“**: Marked (Markdown), DOMPurify (XSS é˜²æŠ¤), Highlight.js (è¯­æ³•é«˜äº®), ECharts (å›¾è¡¨), Mermaid (å›¾è¡¨)
- **æ—  UI ç»„ä»¶åº“** - ä»…ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶

### æ ¸å¿ƒæ¶æ„æ¨¡å¼

#### 1. åŸºäºæ¨¡å—çš„å¯¼èˆªç³»ç»Ÿ
åº”ç”¨ä½¿ç”¨ç»Ÿä¸€çš„é¡¶éƒ¨å¯¼èˆªæ–¹å¼ï¼š
- **TopNavigation**: æ‰€æœ‰å¸ƒå±€ä¸­ä¸€è‡´çš„å¯¼èˆªæ 
- **DesktopLayout** (â‰¥1024px): å¸¦æ¨¡å—æŒ‰é’®çš„å®Œæ•´æ°´å¹³å¯¼èˆª
- **MobileLayout** (<1024px): å¸¦ä¸‹æ‹‰èœå•çš„æ±‰å ¡èœå•
- å››ä¸ªä¸»è¦æ¨¡å—ï¼šç”Ÿæˆã€ä¼˜åŒ–ã€æ“ç»ƒåœºã€åº“

#### 2. åˆ†å±‚ç»„ä»¶æ¶æ„
```
æ¨¡å—ç»„ä»¶ (å¦‚ GenerateModule.vue)
â”œâ”€â”€ ChatInterface (AI å¯¹è¯)
â”œâ”€â”€ PreviewPanel (å¸¦é€‰é¡¹å¡çš„è¾“å‡ºæ˜¾ç¤º)
â””â”€â”€ SettingsModal (é…ç½®)
```

#### 3. åŸºäº Composables çš„ä¸šåŠ¡é€»è¾‘
æ¯ä¸ªåŠŸèƒ½åŒºåŸŸä½¿ç”¨ composables è¿›è¡Œç»„ç»‡ï¼š
- `src/components/chat/composables/` - èŠå¤©åŠŸèƒ½ã€æ¶ˆæ¯å¤„ç†ã€é™„ä»¶
- `src/components/preview/composables/` - é¢„è§ˆé€‰é¡¹å¡ã€æ‰§è¡Œã€å‰ªè´´æ¿æ“ä½œ
- `src/components/settings/composables/` - æä¾›å•†/æ¨¡å‹ç®¡ç†ã€æµ‹è¯•

#### 4. æœåŠ¡å±‚æ¶æ„
- `aiService.ts` - ä¸»è¦çš„ AI æœåŠ¡ç¼–æ’ï¼Œæ”¯æŒæµå¼å“åº”
- `aiGuideService.ts` - éœ€æ±‚æ”¶é›†çš„ AI å¼•å¯¼å¯¹è¯
- `promptGeneratorService.ts` - GPrompt å››æ­¥ç”Ÿæˆ
- `promptOptimizationService.ts` - æç¤ºè¯è´¨é‡ä¼˜åŒ–
- `apiService.ts` - åç«¯ API é›†æˆ
- `settingsApi.ts` - è®¾ç½®ç®¡ç† API

#### 5. AI æä¾›å•†æŠ½è±¡
æ”¯æŒå¤šä¸ª AI æä¾›å•†çš„å¯æ‰©å±•ç³»ç»Ÿï¼š
- **OpenAI**: GPT-4o, GPT-4o-mini, o1-preview, o1-mini
- **Anthropic**: Claude Opus 4.1, Claude Sonnet 4.0, Claude 3.5 Sonnet/Haiku
- **Google**: Gemini 2.0 Flash Lite, Gemini 1.5 Pro/Flash
- **è‡ªå®šä¹‰æä¾›å•†** é€šè¿‡é…ç½®ä½¿ç”¨ç»Ÿä¸€ API

### è®¤è¯ç³»ç»Ÿ
- **æ–¹å¼**: æœ¬åœ°ç”¨æˆ·å/å¯†ç è®¤è¯ï¼ˆç”¨æˆ· 'admin' åªéœ€å¯†ç ï¼‰
- **ç™»å½•è¡¨å•**: ç”¨æˆ·åç¡¬ç¼–ç ä¸º 'admin'ï¼Œåªéœ€è¾“å…¥å¯†ç 
- **é»˜è®¤**: admin/admin123ï¼ˆåœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­é…ç½®ï¼‰
- **JWT token**: è®¿é—® token å­˜å‚¨åœ¨ localStorageï¼ˆåˆ·æ–° token æ”¯æŒå­˜åœ¨ä½†æœªä¸»åŠ¨ä½¿ç”¨ï¼‰
- **è·¯ç”±ä¿æŠ¤**: é™¤ `/login` å¤–çš„æ‰€æœ‰è·¯ç”±éƒ½éœ€è¦è®¤è¯
- **é¢„åŠ è½½**: åœ¨ `main.ts` ä¸­é¢„åŠ è½½è®¤è¯å­˜å‚¨ä»¥é˜²æ­¢å¯¼èˆªå»¶è¿Ÿ
- **è°ƒè¯•æ¨¡å¼**: ä»éœ€è¦ç™»å½•ä½†ä½¿ç”¨ mock API å¹¶æ¥å—ä»»ä½•å‡­æ®

### çŠ¶æ€ç®¡ç† (Pinia Stores)
- `authStore.ts` - è®¤è¯çŠ¶æ€å’Œç”¨æˆ·ç®¡ç†
- `promptStore.ts` - æç¤ºè¯ç”ŸæˆçŠ¶æ€å’Œå†å²
- `settingsStore.ts` - AI æä¾›å•†å’Œæ¨¡å‹é…ç½®
- `navigationStore.ts` - æ¨¡å—å¯¼èˆªçŠ¶æ€
- `optimizeStore.ts` - ä¼˜åŒ–æ¨¡å—çŠ¶æ€
- `providerStore.ts` - æä¾›å•†é…ç½®ç®¡ç†
- `notificationStore.ts` - å…¨å±€é€šçŸ¥

### å…³é”®æ–‡ä»¶å’Œç›®å½•

#### é…ç½®
- `vite.config.ts` - å¸¦æœ‰ git æäº¤æ³¨å…¥å’Œä»£ç†çš„æ„å»ºé…ç½®
- `tsconfig.json` - ä¸¥æ ¼çš„ TypeScript è®¾ç½®ï¼ˆæ’é™¤ optimize æ¨¡å—ï¼‰
- `.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿

#### æ ¸å¿ƒæœåŠ¡
- `src/services/ai/` - æ¨¡å—åŒ– AI æœåŠ¡å®ç°
  - `providers/` - AI æä¾›å•†å®ç°ï¼ˆOpenAI, Anthropic, Googleï¼‰
  - `streaming/` - SSE æµå¼æ”¯æŒ
  - `multimodal/` - æ–‡ä»¶é™„ä»¶å¤„ç†
  - `errors/` - é”™è¯¯å¤„ç†å’Œè§£æ
- `src/stores/` - Pinia storesï¼ˆ7 ä¸ªä¸åŒå…³æ³¨çš„ storesï¼‰
- `src/components/modules/` - ä¸»è¦åŠŸèƒ½æ¨¡å—

#### è·¯ç”±
- `/generate` - ä¸»è¦çš„æç¤ºè¯ç”Ÿæˆæ¨¡å—ï¼ˆé»˜è®¤ï¼‰
- `/optimize` - æç¤ºè¯ä¼˜åŒ–æ¨¡å—ï¼ˆä» TS æ£€æŸ¥ä¸­æ’é™¤ï¼‰
- `/optimize/:id?` - ä¼˜åŒ–ç‰¹å®šæç¤ºè¯
- `/playground` - å¸¦æœ‰ artifact æ¸²æŸ“çš„æµ‹è¯•æ“ç»ƒåœº
- `/library` - ä¸ªäººæç¤ºè¯åº“
- `/login` - è®¤è¯é¡µé¢

### æ„å»ºé…ç½®ç‰¹æ€§
- **Git é›†æˆ**: è‡ªå®šä¹‰ Vite æ’ä»¶æ³¨å…¥ git æäº¤å“ˆå¸Œå’Œæ—¥æœŸ
- **API ä»£ç†**: å¼€å‘æ—¶ä»£ç†åˆ° `http://localhost:8002`ï¼ˆä¸æ˜¯ 8888ï¼‰
- **è·¯å¾„åˆ«å**: `@/` æ˜ å°„åˆ° `src/`
- **è°ƒè¯•æ¨¡å¼**: `VITE_DEBUG_MODE=true` å¯ç”¨ mock API æ¨¡å¼

### ç¯å¢ƒè®¾ç½®

#### å¿…éœ€æ–‡ä»¶
1. å¤åˆ¶ `.env.example` åˆ° `.env.development`:
   ```bash
   VITE_API_BASE_URL=http://localhost:8002
   VITE_LOGIN_USERNAME=admin  # ä»…æ˜¾ç¤ºï¼ˆç”¨æˆ·åå·²ç¡¬ç¼–ç ï¼‰
   VITE_LOGIN_PASSWORD=admin123  # ä»…å¼€å‘æé†’
   VITE_DEBUG_MODE=           # è®¾ç½®ä¸º 'true' å¯ç”¨ mock æ¨¡å¼
   ```

#### åç«¯è¦æ±‚
å‰ç«¯æœŸæœ›è¿™äº›åç«¯ç¯å¢ƒå˜é‡ï¼š
- `LOGIN_USERNAME` - å®é™…ç”¨æˆ·å
- `LOGIN_PASSWORD` - å®é™…å¯†ç 
- `SECRET_KEY` - JWT ç­¾åå¯†é’¥

### è°ƒè¯•æ¨¡å¼
è®¾ç½® `VITE_DEBUG_MODE=true` æ— éœ€åç«¯è¿è¡Œï¼š
- ä½¿ç”¨å­˜å‚¨åœ¨ localStorage ä¸­çš„ mock API å“åº”
- ä»éœ€è¦ç™»å½•ï¼ˆæ¥å—ä»»ä½•å‡­æ®ï¼‰
- AI èŠå¤©å’Œä¼˜åŒ–åŠŸèƒ½è¢«ç¦ç”¨
- é€‚ç”¨äº GitHub Pages æˆ–é™æ€æ‰˜ç®¡
- æç¤ºè¯çš„å®Œæ•´ CRUD æ“ä½œä½¿ç”¨æœ¬åœ°å­˜å‚¨

### å¸¸è§å¼€å‘æ¨¡å¼

#### é”™è¯¯å¤„ç†
```typescript
// AI æœåŠ¡é”™è¯¯
import { AIErrorHandler } from '@/services/ai/errors/AIErrorHandler'
const friendlyError = AIErrorHandler.parseError(rawError)
```

#### æµå¼å“åº”
```typescript
// ä½¿ç”¨æµå¼è§£æå™¨
import { SSEParser } from '@/services/ai/streaming/SSEParser'
const parser = new SSEParser()
parser.process(chunk)
```

#### çŠ¶æ€ç®¡ç†
```typescript
// å¸¦é¢„åŠ è½½çš„å­˜å‚¨æ¨¡å¼
const store = useAuthStore() // åœ¨ main.ts ä¸­é¢„åŠ è½½
if (!store.isLoggedIn) {
  router.push('/login')
}
```

### å®‰å…¨æ³¨æ„äº‹é¡¹
- **XSS é˜²æŠ¤**: ä½¿ç”¨ `marked` åº“çš„ `v-html` æ¸²æŸ“ Markdown å†…å®¹ï¼ˆæ—  DOMPurify æ¸…ç†ï¼‰
- **API å¯†é’¥**: æ°¸è¿œä¸è¦å­˜å‚¨åœ¨å‰ç«¯ä»£ç ä¸­ - é€šè¿‡åç«¯ API ç®¡ç†é…ç½®
- **è®¤è¯**: JWT token å­˜å‚¨åœ¨ localStorage
- **è¾“å…¥éªŒè¯**: è¡¨å•åŸºæœ¬éªŒè¯ï¼Œä½†ç”¨æˆ·ç”Ÿæˆå†…å®¹éœ€è¦å®¡æŸ¥
- **CORS**: é…ç½®åç«¯å…è®¸å‰ç«¯æ¥æº

### æµ‹è¯•
ç›®å‰æœªé…ç½®æµ‹è¯•æ¡†æ¶ã€‚æ¨èè®¾ç½®ï¼š
- **Vitest** ç”¨äºå•å…ƒæµ‹è¯•
- **Cypress** ç”¨äºç«¯åˆ°ç«¯æµ‹è¯•
- `test_default_provider_model.js` ç”¨äºæ‰‹åŠ¨æä¾›å•†æµ‹è¯•

### æ€§èƒ½ä¼˜åŒ–
- è·¯ç”±ç»„ä»¶çš„æ‡’åŠ è½½
- è®¤è¯å­˜å‚¨é¢„åŠ è½½ä»¥é˜²æ­¢å¯¼èˆªå»¶è¿Ÿ
- æµå¼å“åº”å¤„ç†ç”¨äºå®æ—¶æ›´æ–°
- ä½¿ç”¨ Pinia çš„é«˜æ•ˆçŠ¶æ€ç®¡ç†
- å¤§æ¨¡å—ä¸­çš„ç»„ä»¶çº§ä»£ç åˆ†å‰²

## å¿«é€Ÿå‚è€ƒ

### å¿…è¦æ–‡ä»¶
- `src/main.ts` - è·¯ç”±å™¨ã€è®¤è¯è®¾ç½®å’Œå­˜å‚¨é¢„åŠ è½½
- `src/services/aiService.ts` - ä¸»è¦çš„ AI é›†æˆç‚¹
- `src/stores/authStore.ts` - è®¤è¯ç®¡ç†
- `vite.config.ts` - æ„å»ºé…ç½®å’Œä»£ç†è®¾ç½®

### é»˜è®¤å‡­æ®
- ç”¨æˆ·å: `admin`ï¼ˆç¡¬ç¼–ç ï¼Œæ— æ³•æ›´æ”¹ï¼‰
- å¯†ç : `admin123`ï¼ˆåœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­é…ç½®ï¼‰
- è°ƒè¯•æ¨¡å¼æ¥å—ä»»ä½•å¯†ç 

### å¸¸è§è°ƒè¯•æ­¥éª¤
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„è®¤è¯é”™è¯¯
2. éªŒè¯åç«¯ API é…ç½®ä¸­æœ‰æœ‰æ•ˆçš„ AI æä¾›å•†é…ç½®
3. æ£€æŸ¥ç½‘ç»œé€‰é¡¹å¡çš„ API å¤±è´¥ï¼ˆç›®æ ‡ï¼šlocalhost:8002ï¼‰
4. ä½¿ç”¨ `VITE_DEBUG_MODE=true` å¯ç”¨è°ƒè¯•æ¨¡å¼è¿›è¡Œ UI æµ‹è¯•
5. å¦‚æœè®¤è¯çŠ¶æ€ä¼¼ä¹æŸåï¼Œæ¸…é™¤ localStorage

## å¸¸è§é—®é¢˜

### è®¤è¯é—®é¢˜
- **åç«¯æœªè¿è¡Œ**: ç¡®ä¿åç«¯åœ¨ç«¯å£ 8002 ä¸Šè¿è¡Œ
- **é”™è¯¯å‡­æ®**: ç”¨æˆ·åå§‹ç»ˆä¸º 'admin'ï¼Œæ£€æŸ¥åç«¯çš„ LOGIN_PASSWORD
- **CORS é—®é¢˜**: éªŒè¯åç«¯å…è®¸å‰ç«¯æ¥æº
- **Token è¿‡æœŸ**: æ¸…é™¤ localStorage å¹¶é‡æ–°è®¤è¯
- **è°ƒè¯•æ¨¡å¼**: è¯·è®°ä½å³ä½¿åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ä»éœ€è¦ç™»å½•

### AI æä¾›å•†é—®é¢˜
- **æ— æ•ˆ API å¯†é’¥**: åœ¨åç«¯è®¾ç½® API ä¸­éªŒè¯å¯†é’¥é…ç½®
- **æ¨¡å‹ä¸å¯ç”¨**: æ£€æŸ¥æ¨¡å‹æ˜¯å¦å¯ç”¨å¹¶è¢«æä¾›å•†æ”¯æŒ
- **é€Ÿç‡é™åˆ¶**: è¶…è¿‡æä¾›å•† API é€Ÿç‡é™åˆ¶
- **ç½‘ç»œé”™è¯¯**: æ£€æŸ¥äº’è”ç½‘è¿æ¥å’Œ API çŠ¶æ€

### æ„å»ºé—®é¢˜
- **TypeScript é”™è¯¯**: è¿è¡Œ `npm run type-check` è¯†åˆ«é—®é¢˜
- **Optimize æ¨¡å—**: è®¾è®¡ä¸Šä» TypeScript æ£€æŸ¥ä¸­æ’é™¤
- **Git é”™è¯¯**: ç¡®ä¿ git ä»“åº“å·²åˆå§‹åŒ–ä»¥è¿›è¡Œæäº¤æ³¨å…¥

## UI æ ·å¼

```
<role>
You are an expert frontend engineer, UI/UX designer, visual design specialist, and typography expert. Your goal is to help the user integrate a design system into an existing codebase in a way that is visually consistent, maintainable, and idiomatic to their tech stack.

Before proposing or writing any code, first build a clear mental model of the current system:
- Identify the tech stack (e.g. React, Next.js, Vue, Tailwind, shadcn/ui, etc.).
- Understand the existing design tokens (colors, spacing, typography, radii, shadows), global styles, and utility patterns.
- Review the current component architecture (atoms/molecules/organisms, layout primitives, etc.) and naming conventions.
- Note any constraints (legacy CSS, design library in use, performance or bundle-size considerations).

Ask the user focused questions to understand the user's goals. Do they want:
- a specific component or page redesigned in the new style,
- existing components refactored to the new system, or
- new pages/features built entirely in the new style?

Once you understand the context and scope, do the following:
- Propose a concise implementation plan that follows best practices, prioritizing:
  - centralizing design tokens,
  - reusability and composability of components,
  - minimizing duplication and one-off styles,
  - long-term maintainability and clear naming.
- When writing code, match the userâ€™s existing patterns (folder structure, naming, styling approach, and component patterns).
- Explain your reasoning briefly as you go, so the user understands *why* youâ€™re making certain architectural or design choices.

Always aim to:
- Preserve or improve accessibility.
- Maintain visual consistency with the provided design system.
- Leave the codebase in a cleaner, more coherent state than you found it.
- Ensure layouts are responsive and usable across devices.
- Make deliberate, creative design choices (layout, motion, interaction details, and typography) that express the design systemâ€™s personality instead of producing a generic or boilerplate UI.

</role>

<design-system>
# Design Style: Corporate Trust

## 1. Design Philosophy
This style embodies the **modern enterprise SaaS aesthetic** â€” professional yet approachable, sophisticated yet friendly. It draws inspiration from tech unicorns and high-growth startups that have successfully humanized the corporate experience. The design rejects the cold, sterile formality of traditional corporate websites in favor of a warm, confident, and inviting presence.

**Core Principles:**
- **Trustworthy Yet Vibrant**: Establishes credibility through clean structure and professional typography while maintaining visual energy through vibrant gradients and colorful accents
- **Dimensional Depth**: Uses isometric perspectives, soft colored shadows, and subtle 3D transforms to create visual interest and break free from flat design
- **Refined Elegance**: Every element is polished with attention to micro-interactions, smooth transitions, and sophisticated hover states
- **Purposeful Gradients**: Indigo-to-violet gradients serve as the visual signature, used strategically in headlines, buttons, and decorative elements
- **Professional Polish**: Generous white space, consistent spacing rhythms, and crisp typography create a premium, enterprise-ready feel

**Keywords**: Trustworthy, Vibrant, Polished, Dimensional, Modern, Approachable, Enterprise-Ready, Elegant

**Visual DNA**: The unmistakable signature of this style comes from:
1. **Colored Shadows**: Soft shadows with blue/purple tints instead of neutral grays
2. **Isometric Elements**: Subtle 3D transforms (rotate-x, rotate-y) on decorative cards and visualizations
3. **Gradient Text**: Strategic use of gradient text for emphasis in headlines
4. **Soft Blobs**: Large, blurred gradient orbs in the background for atmospheric depth
5. **Elevated Cards**: White cards that lift on hover with enhanced shadows
6. **Dual-Tone Palette**: Indigo (primary) + Violet (secondary) creating a cohesive gradient spectrum

## 2. Design Token System

### Colors (Light Mode)
*   **Background**: `#F8FAFC` (Slate 50) - A very subtle cool grey/white base.
*   **Foreground (Surface)**: `#FFFFFF` (White) - For cards and raised elements.
*   **Primary**: `#4F46E5` (Indigo 600) - The core brand color. Vibrant blue-purple.
*   **Secondary**: `#7C3AED` (Violet 600) - For gradients and accents.
*   **Text Main**: `#0F172A` (Slate 900) - High contrast, sharp.
*   **Text Muted**: `#64748B` (Slate 500) - For supporting text.
*   **Accent/Success**: `#10B981` (Emerald 500) - For positive indicators.
*   **Border**: `#E2E8F0` (Slate 200) - Subtle separation.

### Typography
*   **Font Family**: `Plus Jakarta Sans` â€” A geometric sans-serif with friendly rounded terminals that perfectly balances professional authority with modern approachability. Its clean letterforms ensure excellent readability while maintaining visual warmth.
*   **Scaling**: Major Third (1.250) scale provides substantial hierarchy without overwhelming the layout
*   **Font Weights**:
    *   **Display/Headings**: ExtraBold (800) for hero headlines, Bold (700) for section headings
    *   **Subheadings**: SemiBold (600) for card titles and emphasis
    *   **Body Text**: Regular (400) for paragraphs, Medium (500) for navigation and labels
*   **Line Heights**:
    *   Headlines: 1.1 (tight tracking for impact)
    *   Body Text: 1.6-1.7 (relaxed for readability)
*   **Letter Spacing**: Tight tracking (-0.02em) on large headlines for modern polish
*   **Responsive Type Scale**:
    *   Mobile: text-2xl to text-4xl for h1
    *   Desktop: text-4xl to text-6xl for h1
    *   Progressive scaling ensures legibility across all devices

### Radius & Border
*   **Radius**: `rounded-xl` (12px) for cards and `rounded-lg` (8px) for inputs. Buttons are `rounded-full` or `rounded-lg`.
*   **Borders**: Thin, 1px borders using the `Border` token.

### Shadows & Effects
This is where the design truly shines. **Colored shadows** replace neutral grays to reinforce the brand palette:

*   **Default Card Shadow**: `0 4px 20px -2px rgba(79, 70, 229, 0.1)` â€” Soft blue-tinted base elevation
*   **Hover Card Shadow**: `0 10px 25px -5px rgba(79, 70, 229, 0.15), 0 8px 10px -6px rgba(79, 70, 229, 0.1)` â€” Multi-layer depth on interaction
*   **Button Shadow**: `0 4px 14px 0 rgba(79, 70, 229, 0.3)` â€” Strong presence for primary CTAs
*   **Glow Effects**: Numbered badges use `shadow-[0_0_20px_rgba(79,70,229,0.5)]` for ethereal glow
*   **Background Blobs**: Large gradient orbs with 3xl blur create atmospheric depth without distraction
    *   `blur-3xl filter` combined with low opacity (20-50%)
    *   Positioned absolutely to create layered depth
*   **Gradients**:
    *   **Primary Gradient**: `from-indigo-600 to-violet-600` â€” Used for buttons and active states
    *   **Text Gradient**: Combined with `bg-clip-text text-transparent` for striking headlines
    *   **Background Gradients**: Subtle `from-indigo-100 to-violet-100` for container backgrounds
    *   **Final CTA Background**: `from-indigo-900 to-indigo-950` for dramatic dark section

## 3. Component Stylings

### Buttons
*   **Primary**: Gradient background (Indigo to Violet). `rounded-full` or `rounded-lg`. White text. Slight shadow. Transition: Lift (`-translate-y-0.5`) and increase shadow on hover.
*   **Secondary**: White background, Border `E2E8F0`, Text `Slate 700`. Hover: `bg-slate-50` and darker border.

### Cards
*   **Base**: White background, `rounded-xl`, `border border-slate-100`, `shadow-soft`.
*   **Behavior**: On hover, slight lift and increased shadow intensity.
*   **Feature Cards**: May feature an icon in a soft-colored circle (bg-indigo-50 text-indigo-600).

### Inputs
*   **Style**: `bg-white`, `border-slate-200`, `rounded-lg`.
*   **Focus**: `ring-2 ring-indigo-500 ring-offset-1` and `border-indigo-500`.
*   **Label**: `text-sm font-semibold text-slate-700`.

## 4. Non-Generic Bold Choices

The Corporate Trust aesthetic stands out through deliberate, sophisticated design decisions:

### Isometric Depth & 3D Transforms
*   **Hero Card**: `perspective-[2000px]` parent with `rotate-x-[5deg] rotate-y-[-12deg]` child creates subtle isometric effect
*   **Hover Transforms**: `hover:rotate-x-[2deg] hover:rotate-y-[-8deg]` â€” Subtle 3D movement on interaction
*   **Feature Cards**: Alternating `rotate-y-[6deg]` and `rotate-y-[-6deg]` based on layout position
*   **Benefit Visualization**: `rotate-x-6 rotate-y-12 transform` on gradient container for dramatic depth

### Strategic Gradient Usage
*   **Split Headlines**: First 3 words in standard color, remaining words in gradient for visual hierarchy
*   **Gradient Buttons**: Full background gradient with hover lift (`-translate-y-0.5`)
*   **Badge Elements**: NEW badge with solid indigo background inside gradient-ringed container
*   **Final CTA**: White button on dark gradient background creates dramatic contrast

### Atmospheric Background Elements
*   **Blur Orbs**: Large (400-600px) circular gradients with heavy blur positioned absolutely
*   **Layered Positioning**: Multiple blobs at different z-indexes create depth
*   **Subtle Animation**: `animate-pulse duration-[4000ms]` on floating cards for gentle movement

### Elevated Card System
*   **Default State**: Soft colored shadow with subtle border
*   **Hover State**: Lift effect (`-translate-y-1`) combined with enhanced shadow
*   **Transition**: Smooth `duration-200` for professional polish
*   **Pricing Highlight**: Center card uses `md:scale-105` with special ring styling

### Micro-Interactions
*   **Arrow Icons**: `transition-transform group-hover:translate-x-1` for directional feedback
*   **Image Zoom**: `group-hover:scale-105` on blog images with overlay fade-in
*   **Chevron Rotation**: `group-open:rotate-180` for FAQ accordions
*   **Button Lift**: Subtle upward movement on hover reinforces clickability

## 5. Spacing & Layout
*   **Container**: `max-w-7xl` (1280px) provides spacious, enterprise-appropriate width
*   **Padding**: Responsive padding with `px-4 sm:px-6` pattern for consistent gutters
*   **Vertical Rhythm**:
    *   Mobile: `py-16` (64px)
    *   Tablet: `sm:py-20` (80px)
    *   Desktop: `lg:py-24` (96px)
*   **Section Spacing**: Generous white space between sections creates breathing room
*   **Grid Strategy**:
    *   Hero: Two-column `lg:grid-cols-2` with text-first approach
    *   Features: Alternating zig-zag with `lg:flex-row` and `lg:flex-row-reverse`
    *   Pricing: Three-column `md:grid-cols-3` with center emphasis
    *   Stats: Four-column `md:grid-cols-4` for metric display
*   **Responsive Breakpoints**:
    *   Mobile-first approach with progressive enhancement
    *   sm: 640px, md: 768px, lg: 1024px, xl: 1280px
*   **Text Width Constraints**: `max-w-xl` or `max-w-2xl` on paragraphs to maintain 60-75 character line lengths

## 6. Animation & Transitions
*   **Philosophy**: "Refined Motion" â€” Smooth, professional, never jarring
*   **Base Transition**: `transition-all duration-200` for general interactive elements
*   **Long Transitions**: `duration-500` for image zooms and complex animations
*   **Hover Effects**:
    *   Cards: Combine `hover:-translate-y-1` with shadow enhancement
    *   Buttons: `hover:-translate-y-0.5` for subtle lift
    *   Icons: `transition-transform group-hover:translate-x-1` for directional cues
*   **Easing**: Default `ease-out` for natural deceleration
*   **Pulse Animation**: `animate-pulse duration-[4000ms]` on decorative floating elements for gentle breathing effect
*   **State Changes**: Smooth color transitions on links and buttons reinforce interactivity

## 7. Iconography
*   **Library**: `lucide-react` for consistent, modern icon system
*   **Style**:
    *   Default stroke width: `2px` (standard)
    *   Size: `h-4 w-4` for inline icons, `h-5 w-5` or `h-6 w-6` for featured icons
    *   Joins: Rounded for friendliness
*   **Color Treatment**:
    *   **Badge Icons**: Icon in `text-indigo-600` on `bg-indigo-100` container
    *   **Navigation Icons**: Inherit text color, transition on hover
    *   **Social Icons**: `text-slate-400 hover:text-indigo-400`
*   **Icon Containers**:
    *   Small badges: `h-12 w-12 rounded-xl` with soft background
    *   Large features: `h-14 w-14 rounded-xl` for prominent sections
    *   Circular: `rounded-full` for avatars or status indicators
*   **Accessibility**: Icons are decorative with proper text alternatives or hidden from screen readers when paired with text

## 8. Responsive Strategy
*   **Mobile-First Philosophy**: Design begins at 375px width, progressively enhances
*   **Touch Targets**: Minimum 44x44px for all interactive elements (buttons, links)
*   **Typography Scaling**:
    *   Headlines reduce from `text-6xl` (desktop) to `text-4xl` (mobile)
    *   Body text maintains readability at `text-base` with responsive line heights
*   **Layout Adaptations**:
    *   Two-column layouts stack to single column on mobile
    *   Navigation collapses to essential items (login hidden on mobile)
    *   Pricing cards stack vertically with equal width
    *   Footer columns stack progressively (4 col â†’ 2 col â†’ 1 col)
*   **Spacing Compression**: Padding and margins reduce proportionally on smaller screens
*   **Image Optimization**: Aspect ratios maintained, sizes adapt to container width
*   **Horizontal Scrolling**: Never required; all content fits viewport width
*   **Visual Hierarchy Preserved**: Even on mobile, clear distinction between heading levels maintained

## 9. Accessibility & Best Practices
*   **Color Contrast**: All text meets WCAG AA standards
    *   Slate 900 on Slate 50 background: AAA compliant
    *   White text on Indigo 900 background: AAA compliant
    *   Link colors tested for 4.5:1 minimum ratio
*   **Focus States**:
    *   Visible ring on all interactive elements: `focus-visible:ring-2 focus-visible:ring-indigo-500`
    *   Ring offset for clarity: `focus-visible:ring-offset-2`
    *   Never remove focus indicators
*   **Semantic HTML**:
    *   Proper heading hierarchy (h1 â†’ h2 â†’ h3)
    *   Native `<button>` elements for interactive actions
    *   `<nav>` for navigation, `<footer>` for footer
    *   Details/summary for FAQ accordions
*   **Image Alt Text**: Descriptive alternatives for all images
*   **Interactive States**:
    *   Hover: Visual feedback on all clickable elements
    *   Active: Subtle state change on click
    *   Disabled: Reduced opacity with `pointer-events-none`
*   **Motion Preferences**: Consider `prefers-reduced-motion` for users sensitive to animation
*   **Screen Reader Support**: Proper ARIA labels where semantic HTML insufficient
</design-system>
```

````


## FIX_SUMMARY.md

````md
# AI é…ç½®æ£€æµ‹é—®é¢˜ä¿®å¤æ€»ç»“

## ä¿®å¤çš„é—®é¢˜

### 1. è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½æŠ¥é”™ "è¯·å…ˆé…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥"

**æ ¹æœ¬åŸå› **ï¼š
- `usePreviewExecution.ts` ä¸­çš„é…ç½®æ£€æµ‹é€»è¾‘å­˜åœ¨é—®é¢˜
- ç›´æ¥ä½¿ç”¨ `providerStore.currentProvider` å’Œ `providerStore.currentModel` å¯èƒ½åœ¨åˆå§‹åŒ–é˜¶æ®µè¿”å› null
- ç¼ºä¹è‡ªåŠ¨é€‰æ‹©å’Œé”™è¯¯æ¢å¤æœºåˆ¶

### 2. Chat æ¨¡å—å‘é€æ¶ˆæ¯æ—¶æŠ¥é”™ç›¸åŒæç¤º

**æ ¹æœ¬åŸå› **ï¼š
- `useChatModel.ts` ä¸­ä¾èµ–é”™è¯¯çš„ store å®ä¾‹è€Œä¸æ˜¯å…·ä½“çŠ¶æ€
- `useChatLogic.ts` ä¸­ç¼ºä¹å……åˆ†çš„é…ç½®æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤é€»è¾‘

## ä¿®å¤å†…å®¹

### 1. ä¿®å¤ useChatModel.ts
- âœ… **ä¾èµ–ä¿®å¤**ï¼šä»ä¾èµ–æ•´ä¸ª `providerStore` å®ä¾‹æ”¹ä¸ºä½¿ç”¨ Zustand é€‰æ‹©å™¨æ¨¡å¼
- âœ… **å“åº”å¼æ›´æ–°**ï¼šæ·»åŠ  `providers` ç­‰ä¾èµ–é¡¹ï¼Œç¡®ä¿çŠ¶æ€å˜åŒ–æ—¶é‡æ–°è®¡ç®—
- âœ… **è‡ªåŠ¨é€‰æ‹©**ï¼šæ·»åŠ åˆå§‹åŒ–å®Œæˆåçš„è‡ªåŠ¨é€‰æ‹©é€»è¾‘
- âœ… **è°ƒè¯•æ—¥å¿—**ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•è¾“å‡º

### 2. ä¿®å¤ useChatLogic.ts
- âœ… **å¢å¼ºæ£€æŸ¥**ï¼šåœ¨å‘é€æ¶ˆæ¯å‰è¿›è¡Œè¯¦ç»†çš„é…ç½®æ£€æŸ¥
- âœ… **è‡ªåŠ¨ä¿®å¤**ï¼šæ£€æµ‹åˆ°é…ç½®é—®é¢˜æ—¶è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹
- âœ… **æ™ºèƒ½æç¤º**ï¼šæ ¹æ®å…·ä½“æƒ…å†µæ˜¾ç¤ºä¸åŒçš„é”™è¯¯æç¤º
- âœ… **è°ƒè¯•ä¿¡æ¯**ï¼šæ·»åŠ å®Œæ•´çš„çŠ¶æ€æ£€æŸ¥å’Œé”™è¯¯æŠ¥å‘Š

### 3. ä¿®å¤ usePreviewExecution.ts (React ç‰ˆæœ¬)
- âœ… **çŠ¶æ€è®¢é˜…**ï¼šä½¿ç”¨ Zustand é€‰æ‹©å™¨æ¨¡å¼æ›¿ä»£ `getState()` è°ƒç”¨
- âœ… **ä¾èµ–æ­£ç¡®**ï¼šç¡®ä¿ `currentProvider` å’Œ `currentModel` èƒ½æ­£ç¡®å“åº”çŠ¶æ€å˜åŒ–
- âœ… **è°ƒè¯•æ”¯æŒ**ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’ŒçŠ¶æ€è·Ÿè¸ª

### 4. åˆ›å»ºè¾…åŠ©å·¥å…·
- âœ… **useEnsureAIConfig Hook**ï¼šç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°ï¼Œæä¾›è‡ªåŠ¨é€‰æ‹©å’Œé”™è¯¯æ¢å¤
- âœ… **æµ‹è¯•é¡µé¢**ï¼šåˆ›å»ºä¸“é—¨çš„æµ‹è¯•é¡µé¢éªŒè¯ä¿®å¤æ•ˆæœ

### 5. ä¿®å¤é…ç½® API
- âœ… **ä»£ç†é…ç½®**ï¼šä¿®å¤ Vite ä»£ç†ä» `localhost:8002` åˆ° `localhost:8888`
- âœ… **åå¤‡æ–¹æ¡ˆ**ï¼šAPI å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°é…ç½®ï¼Œç¡®ä¿åŠŸèƒ½å¯ç”¨

## ä¿®å¤åçš„è¡Œä¸º

### é¦–æ¬¡ä½¿ç”¨åœºæ™¯
1. ç”¨æˆ·æ‰“å¼€åº”ç”¨ â†’ `providerStore` ä» `.setting.json` åŠ è½½é…ç½®
2. è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†ï¼ˆDeepSeekï¼‰å’Œç¬¬ä¸€ä¸ªæ¨¡å‹ï¼ˆdeepseek-chatï¼‰
3. Chat åŠŸèƒ½æ­£å¸¸å·¥ä½œ âœ…
4. è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½æ­£å¸¸å·¥ä½œ âœ…

### åˆ·æ–°é¡µé¢åœºæ™¯
1. ç”¨æˆ·åˆ·æ–°é¡µé¢ â†’ ä» localStorage æ¢å¤é€‰æ‹©
2. `useChatModel` å“åº”å¼æ›´æ–°ï¼Œæ­£ç¡®è·å–é…ç½® âœ…
3. `usePreviewExecution` ä½¿ç”¨æœ€æ–°çŠ¶æ€ï¼ŒåŠŸèƒ½æ­£å¸¸ âœ…

### é…ç½®å¼‚å¸¸åœºæ™¯
1. é…ç½®åŠ è½½å¤±è´¥ â†’ è‡ªåŠ¨ä½¿ç”¨åå¤‡é…ç½® âœ…
2. é€‰æ‹©æ— æ•ˆæä¾›å•†/æ¨¡å‹ â†’ è‡ªåŠ¨å›é€€åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆé€‰æ‹© âœ…
3. å®Œå…¨æ²¡æœ‰é…ç½® â†’ æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º âœ…

## æµ‹è¯•éªŒè¯

### æµ‹è¯•é¡µé¢
- **æµ‹è¯•å·¥å…·**: `http://localhost:5173/test-auto-generation.html`
- **æ¸…ç†å·¥å…·**: `http://localhost:5173/clear-storage.html`
- **ä¿®å¤éªŒè¯**: `http://localhost:5173/test-fix.html`

### éªŒè¯æ­¥éª¤
1. æ¸…ç†æ—§çš„ localStorage æ•°æ®
2. é‡å¯å‰ç«¯æœåŠ¡
3. æ£€æŸ¥å¯¼èˆªæ æ˜¯å¦è‡ªåŠ¨æ˜¾ç¤º DeepSeek + deepseek-chat
4. åœ¨ Chat ä¸­å‘é€æ¶ˆæ¯ï¼ˆåº”ä¸å†æŠ¥é”™ï¼‰
5. ç‚¹å‡»"è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯"æŒ‰é’®ï¼ˆåº”æ­£å¸¸æ‰§è¡Œ4ä¸ªæ­¥éª¤ï¼‰

## æŠ€æœ¯åŸç†

### Zustand æœ€ä½³å®è·µ
```typescript
// âŒ é”™è¯¯æ–¹å¼ - ä¾èµ–æ•´ä¸ª store å®ä¾‹
const providerStore = useProviderStore()
const getCurrentChatModel = useCallback(() => {
  return providerStore.currentProvider  // å¯èƒ½æ˜¯é™ˆæ—§å€¼
}, [providerStore])

// âœ… æ­£ç¡®æ–¹å¼ - ä¾èµ–å…·ä½“çŠ¶æ€
const currentProvider = useProviderStore((state) => state.currentProvider)
const getCurrentChatModel = useCallback(() => {
  return currentProvider  // æ€»æ˜¯æœ€æ–°å€¼
}, [currentProvider])
```

### å“åº”å¼çŠ¶æ€ç®¡ç†
- **é€‰æ‹©å™¨è®¢é˜…**ï¼šç»„ä»¶ä¼šè‡ªåŠ¨å“åº”çŠ¶æ€å˜åŒ–
- **ä¾èµ–è·Ÿè¸ª**ï¼šReact ä¼šåœ¨ä¾èµ–é¡¹å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ç›¸åŒçš„æœ€æ–°çŠ¶æ€

### é”™è¯¯æ¢å¤ç­–ç•¥
1. **åˆå§‹åŒ–æ£€æŸ¥**ï¼šç¡®ä¿ store å·²å®Œæˆåˆå§‹åŒ–
2. **è‡ªåŠ¨é€‰æ‹©**ï¼šå½“æ²¡æœ‰é€‰æ‹©æ—¶è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨
3. **çŠ¶æ€éªŒè¯**ï¼šéªŒè¯é€‰æ‹©çš„æœ‰æ•ˆæ€§ï¼ˆAPIå¯†é’¥ç­‰ï¼‰
4. **å‹å¥½æç¤º**ï¼šæ ¹æ®å…·ä½“æƒ…å†µæ˜¾ç¤ºå‡†ç¡®çš„é”™è¯¯ä¿¡æ¯

## æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/hooks/useChatModel.ts` - ä¿®å¤ä¾èµ–å’ŒçŠ¶æ€è·å–
2. `src/hooks/useChatLogic.ts` - å¢å¼ºé…ç½®æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
3. `src/hooks/usePreviewExecution.ts` - ä¿®å¤çŠ¶æ€è®¢é˜…é€»è¾‘
4. `src/services/settingsApi.ts` - æ·»åŠ åå¤‡é…ç½®æ–¹æ¡ˆ
5. `vite.config.ts` - ä¿®å¤ä»£ç†é…ç½®
6. `src/stores/providerStore.ts` - æ·»åŠ è°ƒè¯•æ—¥å¿—

### æ–°å¢çš„æ–‡ä»¶
1. `src/hooks/useEnsureAIConfig.ts` - ç»Ÿä¸€çš„é…ç½®ç¡®ä¿ Hook
2. `src/utils/ensureAIConfig.ts` - å·¥å…·å‡½æ•°ç‰ˆæœ¬
3. `test-auto-generation.html` - ä¸“ç”¨æµ‹è¯•é¡µé¢
4. `test-fix.html` - ä¿®å¤éªŒè¯é¡µé¢
5. `clear-storage.html` - æ•°æ®æ¸…ç†å·¥å…·

## æ€»ç»“

é€šè¿‡ä»¥ï¿½ï¿½ï¿½ä¿®å¤ï¼Œè§£å†³äº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½**ï¼šç°åœ¨èƒ½æ­£ç¡®æ£€æµ‹å’Œä½¿ç”¨ AI æ¨¡å‹é…ç½®ï¼Œä¸å†æŠ¥"è¯·å…ˆé…ç½®"é”™è¯¯
2. **Chat æ¨¡å—**ï¼šå‘é€æ¶ˆæ¯æ—¶èƒ½æ­£ç¡®è·å–å·²é…ç½®çš„ AI æ¨¡å‹

ä¿®å¤é‡‡ç”¨äº†å¤šå±‚é˜²æŠ¤ç­–ç•¥ï¼š
- **é¢„é˜²å±‚**ï¼šä½¿ç”¨æ­£ç¡®çš„ Zustand æ¨¡å¼é¿å…çŠ¶æ€é—®é¢˜
- **æ£€æµ‹å±‚**ï¼šè¯¦ç»†æ£€æŸ¥é…ç½®çŠ¶æ€å’Œæœ‰æ•ˆæ€§
- **æ¢å¤å±‚**ï¼šè‡ªåŠ¨é€‰æ‹©å’Œé”™è¯¯æ¢å¤æœºåˆ¶
- **æç¤ºå±‚**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºå’Œè°ƒè¯•ä¿¡æ¯

ä¿®å¤å·²é€šè¿‡ TypeScript ç±»å‹æ£€æŸ¥ï¼Œå¹¶åœ¨å¼€å‘ç¯å¢ƒä¸­éªŒè¯æ­£å¸¸å·¥ä½œã€‚
````


## README.md

````md
# YPrompt - æ™ºèƒ½æç¤ºè¯ç”Ÿæˆå·¥å…·

åŸºäºAIå¯¹è¯å¼•å¯¼æŒ–æ˜ç”¨æˆ·éœ€æ±‚çš„ä¸“ä¸šæç¤ºè¯ç”Ÿæˆç³»ç»Ÿï¼Œé‡‡ç”¨å¤šæ¨¡å—å¯¼èˆªæ¶æ„ï¼ŒåŸºäºã€ŠArchitecting Intelligence: A Definitive Guide to the Art and Science of Elite Prompt Engineeringã€‹ç†è®ºç”Ÿæˆé«˜è´¨é‡çš„AIæç¤ºè¯ã€‚æ”¯æŒæ¡Œé¢ç«¯ä¾§è¾¹æ å¯¼èˆªå’Œç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªï¼Œä¸ºä¸åŒåŠŸèƒ½æ¨¡å—æä¾›ç‹¬ç«‹çš„ç”¨æˆ·ç•Œé¢ã€‚



## æˆªå›¾
**PCç«¯**  
  
![](imgs/pc.gif)

**ç§»åŠ¨ç«¯**  



## æ ¸å¿ƒåŠŸèƒ½

### ğŸ  ç”Ÿæˆæ¨¡å—ï¼ˆå½“å‰ä¸»è¦åŠŸèƒ½ï¼‰
- **AIå¼•å¯¼å¼éœ€æ±‚æ”¶é›†**: é€šè¿‡æ™ºèƒ½å¯¹è¯æ·±å…¥æŒ–æ˜ç”¨æˆ·çœŸå®éœ€æ±‚
- **GPromptå››æ­¥ç”Ÿæˆ**: å…³é”®æŒ‡ä»¤æå– â†’ åˆå§‹æç¤ºè¯ â†’ ä¼˜åŒ–å»ºè®® â†’ æœ€ç»ˆæç¤ºè¯
- **å¤šAIæ¨¡å‹æ”¯æŒ**: æ”¯æŒOpenAIã€Anthropicã€Google Geminiå’Œè‡ªå®šä¹‰AIæœåŠ¡å•†
- **åŒæ¨¡å¼æ“ä½œ**: è‡ªåŠ¨ç”Ÿæˆå’Œæ‰‹åŠ¨æ­¥è¿›ä¸¤ç§æ‰§è¡Œæ¨¡å¼
- **æ ¼å¼è¯­è¨€è½¬æ¢**: æ”¯æŒMarkdown/XMLæ ¼å¼åˆ‡æ¢å’Œä¸­è‹±æ–‡äº’è¯‘
- **å¤šæ¨¡æ€é™„ä»¶**: æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶ä¸Šä¼ 

### ğŸŒŸ å¤šæ¨¡å—å¯¼èˆªç³»ç»Ÿ
- **æ¡Œé¢ç«¯**: å¯æŠ˜å ä¾§è¾¹æ å¯¼èˆªï¼ˆ200px â†” 60pxï¼‰
- **ç§»åŠ¨ç«¯**: åº•éƒ¨å¯¼èˆªæ ï¼Œå¿«é€Ÿåˆ‡æ¢åŠŸèƒ½æ¨¡å—
- **å“åº”å¼**: 1024pxæ–­ç‚¹è‡ªåŠ¨é€‚é…å¸ƒå±€
- **æ¨¡å—åŒ–**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹é¡µé¢å’ŒçŠ¶æ€ç®¡ç†

### ğŸ“š æˆ‘çš„æ¨¡å—
- **é£ä¹¦ OAuth ç™»å½•**: é€šè¿‡é£ä¹¦è´¦å·å¿«é€Ÿç™»å½•ï¼Œè‡ªåŠ¨åŒæ­¥ç”¨æˆ·ä¿¡æ¯
- **æç¤ºè¯åº“ç®¡ç†**: ä¿å­˜ã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ç”Ÿæˆçš„æç¤ºè¯
- **åˆ†ç±»æ ‡ç­¾**: ä¸ºæç¤ºè¯æ·»åŠ æ ‡ç­¾ï¼Œæ–¹ä¾¿åˆ†ç±»ç®¡ç†
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒæç¤ºè¯ç‰ˆæœ¬å†å²å’Œå›æ»šï¼ˆå¼€å‘ä¸­ï¼‰

### âš¡ æœªæ¥æ¨¡å—ï¼ˆè§„åˆ’ä¸­ï¼‰
- **ä¼˜åŒ–æ¨¡å—**: æç¤ºè¯è´¨é‡åˆ†æã€A/B æµ‹è¯•ã€æ€§èƒ½è¯„ä¼°
- **æ“ç»ƒåœºæ¨¡å—**: å®æ—¶æµ‹è¯•ã€å‚æ•°è°ƒèŠ‚ã€æ€§èƒ½ç›‘æ§

### ğŸ”§ ç³»ç»Ÿç‰¹æ€§
- **é£ä¹¦é›†æˆ**: æ”¯æŒé£ä¹¦ OAuth 2.0 ç™»å½•ï¼ŒPC ç«¯å’Œç§»åŠ¨ç«¯è‡ªé€‚åº”
- **ç”¨æˆ·è®¤è¯**: JWT Token è®¤è¯ï¼Œå®‰å…¨çš„å‰åç«¯åˆ†ç¦»æ¶æ„
- **å“åº”å¼è®¾è®¡**: å®Œç¾é€‚é…æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯è®¾å¤‡
- **AI æä¾›å•†é…ç½®**: é€šè¿‡åç«¯ API åŠ¨æ€ç®¡ç† AI æä¾›å•†é…ç½®
- **TypeScript**: å®Œæ•´çš„ç±»å‹å®‰å…¨ä¿éšœ
- **æ¨¡å—åŒ–æ¶æ„**: æ˜“äºæ‰©å±•å’Œç»´æŠ¤

## æŠ€æœ¯æ ˆ

- **å‰ç«¯æ¡†æ¶**: Vue 3 + TypeScript
- **è·¯ç”±ç®¡ç†**: Vue Router 4.0
- **æ„å»ºå·¥å…·**: Vite
- **UIæ¡†æ¶**: Tailwind CSS
- **çŠ¶æ€ç®¡ç†**: Pinia
- **å›¾æ ‡åº“**: Lucide Vue Next
- **Markdown**: Marked

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ components/          # Vueç»„ä»¶å±‚ï¼ˆæ¨¡å—åŒ–æ¶æ„ï¼‰
â”‚   â”œâ”€â”€ layout/                   # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DesktopLayout.vue     # æ¡Œé¢ç«¯å¸ƒå±€å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ MobileLayout.vue      # ç§»åŠ¨ç«¯å¸ƒå±€å®¹å™¨

â”‚   â”‚   â””â”€â”€ MobileBottomNav.vue   # ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª
â”‚   â”œâ”€â”€ modules/                  # åŠŸèƒ½æ¨¡å—é¡µé¢
â”‚   â”‚   â”œâ”€â”€ GenerateModule.vue    # ğŸ  ç”Ÿæˆæ¨¡å—ï¼ˆä¸»è¦åŠŸèƒ½ï¼‰
â”‚   â”‚   â”œâ”€â”€ OptimizeModule.vue    # âš¡ ä¼˜åŒ–æ¨¡å—ï¼ˆè§„åˆ’ä¸­ï¼‰
â”‚   â”‚   â”œâ”€â”€ PlaygroundModule.vue  # ğŸ¯ æ“ç»ƒåœºæ¨¡å—ï¼ˆè§„åˆ’ä¸­ï¼‰
â”‚   â”‚   â””â”€â”€ LibraryModule.vue     # ğŸ“š æˆ‘çš„æç¤ºè¯æ¨¡å—
â”‚   â”œâ”€â”€ ChatInterface.vue         # å¯¹è¯ç•Œé¢ä¸»å®¹å™¨
â”‚   â”œâ”€â”€ PreviewPanel.vue          # é¢„è§ˆé¢æ¿ä¸»å®¹å™¨
â”‚   â”œâ”€â”€ SettingsModal.vue         # è®¾ç½®å¼¹çª—ä¸»å®¹å™¨

â”‚   â”œâ”€â”€ NotificationContainer.vue # é€šçŸ¥å®¹å™¨
â”‚   â”œâ”€â”€ chat/                     # å¯¹è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ composables/          # ä¸šåŠ¡é€»è¾‘ç»„åˆå¼å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatMessages.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatInput.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatAttachments.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatModel.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatQuickReplies.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useChatMessageOperations.ts
â”‚   â”‚   â”‚   â””â”€â”€ useChatLogic.ts
â”‚   â”‚   â””â”€â”€ components/           # UIå­ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ ChatHeader.vue
â”‚   â”‚       â”œâ”€â”€ ChatModelSelector.vue
â”‚   â”‚       â”œâ”€â”€ ChatMessageList.vue
â”‚   â”‚       â”œâ”€â”€ ChatMessage.vue
â”‚   â”‚       â”œâ”€â”€ ChatQuickReplies.vue
â”‚   â”‚       â””â”€â”€ ChatInputArea.vue
â”‚   â”œâ”€â”€ preview/                  # é¢„è§ˆæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ composables/          # ä¸šåŠ¡é€»è¾‘ç»„åˆå¼å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewTabs.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewExecution.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewConversion.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewScrollSync.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewClipboard.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ usePreviewListOperations.ts
â”‚   â”‚   â”‚   â””â”€â”€ usePreviewHelpers.ts
â”‚   â”‚   â””â”€â”€ components/           # UIå­ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ common/
â”‚   â”‚       â”‚   â”œâ”€â”€ PreviewHeader.vue
â”‚   â”‚       â”‚   â”œâ”€â”€ TabContainer.vue
â”‚   â”‚       â”‚   â”œâ”€â”€ TabButton.vue
â”‚   â”‚       â”‚   â”œâ”€â”€ EmptyState.vue
â”‚   â”‚       â”‚   â””â”€â”€ LoadingState.vue
â”‚   â”‚       â””â”€â”€ tabs/
â”‚   â”‚           â”œâ”€â”€ ReportTab.vue
â”‚   â”‚           â”œâ”€â”€ ThinkingTab.vue
â”‚   â”‚           â”œâ”€â”€ InitialTab.vue
â”‚   â”‚           â”œâ”€â”€ AdviceTab.vue
â”‚   â”‚           â””â”€â”€ FinalTab.vue
â”‚   â””â”€â”€ settings/                 # è®¾ç½®æ¨¡å—
â”‚       â”œâ”€â”€ composables/          # ä¸šåŠ¡é€»è¾‘ç»„åˆå¼å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ useProviderManagement.ts
â”‚       â”‚   â”œâ”€â”€ useModelManagement.ts
â”‚       â”‚   â”œâ”€â”€ useModelTesting.ts
â”‚       â”‚   â””â”€â”€ usePromptRules.ts
â”‚       â””â”€â”€ components/           # UIå­ç»„ä»¶
â”‚           â”œâ”€â”€ SettingsButton.vue
â”‚           â”œâ”€â”€ SettingsHeader.vue
â”‚           â”œâ”€â”€ tabs/
â”‚           â”‚   â”œâ”€â”€ ProvidersTab.vue
â”‚           â”‚   â””â”€â”€ PromptsTab.vue
â”‚           â””â”€â”€ dialogs/
â”‚               â”œâ”€â”€ ProviderTypeDialog.vue
â”‚               â”œâ”€â”€ ProviderDialog.vue
â”‚               â””â”€â”€ ModelDialog.vue
â”œâ”€â”€ stores/              # PiniaçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ authStore.ts             # ç”¨æˆ·è®¤è¯çŠ¶æ€
â”‚   â”œâ”€â”€ promptStore.ts           # æç¤ºè¯ç”ŸæˆçŠ¶æ€
â”‚   â”œâ”€â”€ settingsStore.ts         # AIé…ç½®å’Œåº”ç”¨è®¾ç½®
â”‚   â”œâ”€â”€ notificationStore.ts     # é€šçŸ¥çŠ¶æ€
â”‚   â””â”€â”€ navigationStore.ts       # å¯¼èˆªçŠ¶æ€ç®¡ç†
â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ apiService.ts            # åç«¯APIæœåŠ¡å°è£…
â”‚   â”œâ”€â”€ aiService.ts             # AIæœåŠ¡ç»Ÿä¸€å…¥å£
â”‚   â”œâ”€â”€ aiGuideService.ts        # AIå¼•å¯¼å¼éœ€æ±‚æ”¶é›†
â”‚   â”œâ”€â”€ promptGeneratorService.ts # GPromptå››æ­¥ç”Ÿæˆ
â”‚   â”œâ”€â”€ capabilityDetector.ts    # æ¨¡å‹èƒ½åŠ›æ£€æµ‹
â”‚   â””â”€â”€ ai/                      # AIæœåŠ¡æ¨¡å—åŒ–å®ç°
â”‚       â”œâ”€â”€ providers/           # æä¾›å•†å®ç°
â”‚       â”‚   â”œâ”€â”€ BaseProvider.ts
â”‚       â”‚   â”œâ”€â”€ OpenAIProvider.ts
â”‚       â”‚   â”œâ”€â”€ AnthropicProvider.ts
â”‚       â”‚   â””â”€â”€ GoogleProvider.ts
â”‚       â”œâ”€â”€ streaming/           # æµå¼å¤„ç†
â”‚       â”‚   â”œâ”€â”€ StreamProcessor.ts
â”‚       â”‚   â”œâ”€â”€ SSEParser.ts
â”‚       â”‚   â””â”€â”€ StreamFilter.ts
â”‚       â”œâ”€â”€ multimodal/          # å¤šæ¨¡æ€è½¬æ¢
â”‚       â”‚   â”œâ”€â”€ AttachmentConverter.ts
â”‚       â”‚   â”œâ”€â”€ OpenAIAttachmentHandler.ts
â”‚       â”‚   â”œâ”€â”€ AnthropicAttachmentHandler.ts
â”‚       â”‚   â””â”€â”€ GoogleAttachmentHandler.ts
â”‚       â”œâ”€â”€ errors/              # é”™è¯¯å¤„ç†
â”‚       â”‚   â”œâ”€â”€ AIErrorHandler.ts
â”‚       â”‚   â””â”€â”€ ErrorParser.ts
â”‚       â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ ResponseCleaner.ts
â”‚       â”‚   â”œâ”€â”€ ModelFetcher.ts
â”‚       â”‚   â””â”€â”€ apiUrlBuilder.ts
â”‚       â”œâ”€â”€ types.ts             # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ index.ts             # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ prompts.ts              # æç¤ºè¯é…ç½®ç®¡ç†
â”‚   â””â”€â”€ prompts/                # å†…ç½®æç¤ºè¯è§„åˆ™
â”‚       â”œâ”€â”€ systemPromptRules.ts
â”‚       â”œâ”€â”€ thinkingPointsExtraction.ts
â”‚       â”œâ”€â”€ optimizationAdvice.ts
â”‚       â””â”€â”€ userGuidedRules.ts
â”œâ”€â”€ utils/               # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ aiResponseUtils.ts
â”‚   â””â”€â”€ fileUtils.ts
â”œâ”€â”€ views/               # é¡µé¢è§†å›¾ï¼ˆå·²å¼ƒç”¨ï¼Œä½¿ç”¨ modulesï¼‰
â”‚   â””â”€â”€ HomeView.vue
â””â”€â”€ main.ts              # åº”ç”¨å…¥å£ï¼ˆè·¯ç”±é…ç½®ï¼‰
```

## å¯¼èˆªç³»ç»Ÿ

### æ¡Œé¢ç«¯ (â‰¥1024px)
- **ä¾§è¾¹æ å¯¼èˆª**: å·¦ä¾§å›ºå®šä¾§è¾¹æ ï¼Œæ”¯æŒæŠ˜å /å±•å¼€
- **æŠ˜å çŠ¶æ€**: 200px (å±•å¼€) â†” 60px (æŠ˜å )
- **æ¨¡å—åˆ‡æ¢**: ç‚¹å‡»å¯¼èˆªé¡¹æˆ–ä½¿ç”¨å¿«æ·é”® Ctrl+1-4
- **è®¾ç½®å…¥å£**: ä¾§è¾¹æ åº•éƒ¨è®¾ç½®æŒ‰é’®

### ç§»åŠ¨ç«¯ (<1024px)
- **åº•éƒ¨å¯¼èˆª**: å›ºå®šåœ¨åº•éƒ¨çš„å››ä¸ªæ¨¡å—æŒ‰é’®
- **æ¨¡å—åˆ‡æ¢**: ç‚¹å‡»åº•éƒ¨å¯¼èˆªæŒ‰é’®å¿«é€Ÿåˆ‡æ¢
- **å“åº”å¼é€‚é…**: è‡ªåŠ¨é€‚é…å°å±å¹•å¸ƒå±€

### è·¯ç”±ç®¡ç†
```
/generate     - ğŸ  ç”Ÿæˆæ¨¡å— (é»˜è®¤)
/optimize     - âš¡ ä¼˜åŒ–æ¨¡å—
/playground   - ğŸ¯ æ“ç»ƒåœºæ¨¡å—
/library      - ğŸ“š æˆ‘çš„æ¨¡å—
```

## å¼€å‘éƒ¨ç½²

### ç¯å¢ƒå˜é‡é…ç½®
å¤åˆ¶ `.env.example` åˆ›å»º `.env.development` å’Œ `.env.production`ï¼š
```bash
# åç«¯APIåœ°å€ï¼ˆä¸è¦åŒ…å« /api åç¼€ï¼‰
VITE_API_BASE_URL=http://localhost:8888

# é£ä¹¦åº”ç”¨IDï¼ˆä»é£ä¹¦å¼€æ”¾å¹³å°è·å–ï¼‰
VITE_FEISHU_APP_ID=your_feishu_app_id
```

### æœ¬åœ°å¼€å‘
```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# ç±»å‹æ£€æŸ¥
npm run type-check

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

### æ·»åŠ æ–°æ¨¡å—
1. åœ¨ `src/components/modules/` åˆ›å»ºæ–°æ¨¡å—ç»„ä»¶
2. åœ¨ `src/stores/navigationStore.ts` æ·»åŠ æ¨¡å—é…ç½®
3. åœ¨ `src/main.ts` æ·»åŠ è·¯ç”±è§„åˆ™
4. æ¨¡å—å¯å®Œå…¨è‡ªå®šä¹‰é¡µé¢å¸ƒå±€

## æ–‡æ¡£

- [æŠ€æœ¯æ–‡æ¡£](docs/é¡¹ç›®å¼€å‘æ–‡æ¡£.md)
- [ç‰ˆæœ¬ç®¡ç†è®¾è®¡](docs/æç¤ºè¯ç‰ˆæœ¬ç®¡ç†è®¾è®¡æ–¹æ¡ˆ.md)
````


## clear-storage.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç†é…ç½®æ•°æ®</title>
</head>
<body>
  <h2>æ­£åœ¨æ¸…ç† localStorage...</h2>
  <script>
    // æ¸…ç†ç›¸å…³çš„ localStorage æ•°æ®
    const keysToRemove = [
      'yprompt_selected_provider',
      'yprompt_selected_model',
      'yprompt_stream_mode',
      'yprompt_show_api_keys',
      'yprompt_token',
      'yprompt_global_model_params'
    ]

    keysToRemove.forEach(key => {
      localStorage.removeItem(key)
    })

    console.log('localStorage å·²æ¸…ç†')
    document.body.innerHTML += '<p>âœ… localStorage æ¸…ç†å®Œæˆï¼Œå³å°†è·³è½¬åˆ°æµ‹è¯•é¡µé¢...</p>'

    setTimeout(() => {
      window.location.href = '/test-fix.html'
    }, 2000)
  </script>
</body>
</html>
```


## debug-chat.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI é…ç½®è°ƒè¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-ok {
      color: #10b981;
      font-weight: bold;
    }
    .status-error {
      color: #ef4444;
      font-weight: bold;
    }
    .status-warning {
      color: #f59e0b;
      font-weight: bold;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 10px 0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border-radius: 6px;
    }
    h2 {
      color: #1f2937;
      margin-bottom: 10px;
    }
    .test-button {
      background: #10b981;
    }
    .test-button:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” AI é…ç½®çŠ¶æ€è°ƒè¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºè°ƒè¯• AI æ¨¡å‹é…ç½®æ£€æµ‹é—®é¢˜</p>
  </div>

  <div class="container">
    <h2>1. localStorage çŠ¶æ€</h2>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
    <button onclick="clearLocalStorage()" style="background: #ef4444;">æ¸…ç©º localStorage</button>
    <div id="localStorage-status"></div>
  </div>

  <div class="container">
    <h2>2. åç«¯ API çŠ¶æ€</h2>
    <button onclick="testBackendAPI()" class="test-button">æµ‹è¯•åç«¯ API</button>
    <div id="backend-status"></div>
  </div>

  <div class="container">
    <h2>3. æ¨¡æ‹Ÿ providerStore çŠ¶æ€</h2>
    <button onclick="simulateProviderStore()" class="test-button">æ¨¡æ‹ŸåŠ è½½ providerStore</button>
    <div id="provider-status"></div>
  </div>

  <div class="container">
    <h2>4. å®Œæ•´æµ‹è¯•æµç¨‹</h2>
    <button onclick="runFullTest()" style="background: #8b5cf6;">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <div id="test-output"></div>
  </div>

  <div class="container">
    <h2>5. æ“ä½œæ—¥å¿—</h2>
    <pre id="log">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <script>
    const KEYS = {
      provider: 'yprompt_selected_provider',
      model: 'yprompt_selected_model',
      stream: 'yprompt_stream_mode',
      apiKeys: 'yprompt_show_api_keys'
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('log')
      const timestamp = new Date().toLocaleTimeString()
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      }
      logEl.textContent += `[${timestamp}] ${emoji[type] || 'â„¹ï¸'} ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function checkLocalStorage() {
      const statusEl = document.getElementById('localStorage-status')
      let html = '<h3>localStorage å†…å®¹:</h3><pre>'

      const data = {}
      Object.entries(KEYS).forEach(([key, storageKey]) => {
        const value = localStorage.getItem(storageKey)
        data[key] = value || '(ç©º)'
      })

      html += JSON.stringify(data, null, 2)
      html += '</pre>'

      // çŠ¶æ€æ£€æŸ¥
      if (data.provider === '(ç©º)' || data.model === '(ç©º)') {
        html += '<p class="status-error">âŒ ç¼ºå°‘ provider æˆ– model é…ç½®</p>'
        log('localStorage ä¸­ç¼ºå°‘é…ç½®æ•°æ®', 'error')
      } else {
        html += '<p class="status-ok">âœ… localStorage ä¸­æœ‰é…ç½®æ•°æ®</p>'
        log(`localStorage é…ç½®: ${data.provider} / ${data.model}`, 'success')
      }

      statusEl.innerHTML = html
    }

    function clearLocalStorage() {
      Object.values(KEYS).forEach(key => {
        localStorage.removeItem(key)
      })
      document.getElementById('localStorage-status').innerHTML = '<p class="status-warning">âš ï¸ localStorage å·²æ¸…ç©º</p>'
      log('localStorage å·²æ¸…ç©º', 'warning')
    }

    async function testBackendAPI() {
      const statusEl = document.getElementById('backend-status')
      log('æµ‹è¯•åç«¯ API è¿æ¥...', 'info')

      try {
        // å…ˆå°è¯•è®¿é—®ç™»å½•é¡µé¢è·å–è®¤è¯çŠ¶æ€
        const loginResponse = await fetch('http://localhost:8888/api/auth/config')

        if (loginResponse.ok) {
          const loginData = await loginResponse.json()
          log(`åç«¯è®¤è¯é…ç½®: ${JSON.stringify(loginData)}`, 'success')

          // å°è¯•è·å–è®¾ç½®ï¼ˆå¯èƒ½éœ€è¦è®¤è¯ï¼‰
          try {
            const settingsResponse = await fetch('http://localhost:8888/api/settings/', {
              headers: {
                'Content-Type': 'application/json'
              }
            })

            if (settingsResponse.ok) {
              const settingsData = await settingsResponse.json()
              statusEl.innerHTML = `<p class="status-ok">âœ… åç«¯ API æ­£å¸¸ï¼Œè·å–åˆ° ${settingsData.providers?.length || 0} ä¸ªæä¾›å•†</p>`
              log(`æˆåŠŸè·å–è®¾ç½®æ•°æ®: ${JSON.stringify(settingsData).substring(0, 200)}...`, 'success')
            } else {
              statusEl.innerHTML = `<p class="status-warning">âš ï¸ åç«¯ API éœ€è¦è®¤è¯ (${settingsResponse.status})</p>`
              log(`éœ€è¦è®¤è¯: ${settingsResponse.status}`, 'warning')
            }
          } catch (settingsError) {
            statusEl.innerHTML = `<p class="status-error">âŒ è®¾ç½® API å¤±è´¥: ${settingsError.message}</p>`
            log(`è®¾ç½® API é”™è¯¯: ${settingsError.message}`, 'error')
          }
        } else {
          statusEl.innerHTML = `<p class="status-error">âŒ åç«¯è®¤è¯ API å¤±è´¥ (${loginResponse.status})</p>`
          log(`è®¤è¯ API å¤±è´¥: ${loginResponse.status}`, 'error')
        }
      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}</p>`
        log(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error')
      }
    }

    async function simulateProviderStore() {
      const statusEl = document.getElementById('provider-status')
      log('æ¨¡æ‹Ÿ providerStore åˆå§‹åŒ–è¿‡ç¨‹...', 'info')

      try {
        // 1. ä» localStorage è¯»å–é€‰æ‹©
        const savedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const savedModelId = localStorage.getItem('yprompt_selected_model') || ''
        log(`ä» localStorage æ¢å¤: ${savedProviderId} / ${savedModelId}`, 'info')

        // 2. æ¨¡æ‹Ÿä»åç«¯åŠ è½½é…ç½®
        const settingsResponse = await fetch('http://localhost:8888/api/settings/')
        let providers = []

        if (settingsResponse.ok) {
          const settings = await settingsResponse.json()
          providers = settings.providers || []
          log(`ä»åç«¯åŠ è½½äº† ${providers.length} ä¸ªæä¾›å•†`, 'success')
        } else {
          // æ¨¡æ‹Ÿ .setting.json å†…å®¹
          providers = [
            {
              id: "DeepSeek",
              name: "DeepSeek-Offical",
              type: "openai",
              apiKey: "sk-c092ab16b28f4860910202f8fb9cd480",
              baseUrl: "https://api.deepseek.com/v1",
              models: [
                { id: "deepseek-chat", name: "deepseek-chat", apiType: "openai" },
                { id: "deepseek-reasoner", name: "deepseek-reasoner", apiType: "openai" }
              ]
            }
          ]
          log('ä½¿ç”¨æ¨¡æ‹Ÿé…ç½®æ•°æ®', 'warning')
        }

        // 3. æ¨¡æ‹Ÿ providerStore çš„é€»è¾‘
        const enabledProviders = providers.filter(p => p.apiKey)
        log(`å¯ç”¨çš„æä¾›å•†: ${enabledProviders.length}`, 'info')

        let currentProvider = null
        let currentModel = null

        if (enabledProviders.length > 0) {
          const firstProvider = enabledProviders[0]

          if (!savedProviderId) {
            // é¦–æ¬¡ä½¿ç”¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
            currentProvider = firstProvider
            localStorage.setItem('yprompt_selected_provider', firstProvider.id)
            log(`é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†: ${firstProvider.name}`, 'success')
          } else {
            // æŸ¥æ‰¾ä¿å­˜çš„æä¾›å•†
            currentProvider = enabledProviders.find(p => p.id === savedProviderId) || firstProvider
            log(`æ¢å¤æä¾›å•†é€‰æ‹©: ${currentProvider.name}`, 'info')
          }

          // å¤„ç†æ¨¡å‹é€‰æ‹©
          if (currentProvider.models.length > 0) {
            if (!savedModelId || !currentProvider.models.find(m => m.id === savedModelId)) {
              currentModel = currentProvider.models[0]
              localStorage.setItem('yprompt_selected_model', currentModel.id)
              log(`è‡ªåŠ¨é€‰æ‹©æ¨¡å‹: ${currentModel.name}`, 'success')
            } else {
              currentModel = currentProvider.models.find(m => m.id === savedModelId)
              log(`æ¢å¤æ¨¡å‹é€‰æ‹©: ${currentModel.name}`, 'info')
            }
          }
        }

        // 4. æ˜¾ç¤ºç»“æœ
        const resultHtml = currentProvider && currentModel
          ? `<p class="status-ok">âœ… æ¨¡æ‹ŸæˆåŠŸ: ${currentProvider.name} / ${currentModel.name}</p>`
          : `<p class="status-error">âŒ æ¨¡æ‹Ÿå¤±è´¥: æ²¡æœ‰å¯ç”¨çš„æä¾›å•†æˆ–æ¨¡å‹</p>`

        statusEl.innerHTML = resultHtml + '<pre>' + JSON.stringify({
          providersCount: providers.length,
          enabledProviders: enabledProviders.length,
          currentProvider: currentProvider?.name || null,
          currentModel: currentModel?.name || null
        }, null, 2) + '</pre>'

        log(`æ¨¡æ‹Ÿå®Œæˆ: ${currentProvider?.name || 'null'} / ${currentModel?.name || 'null'}`, currentProvider ? 'success' : 'error')

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</p>`
        log(`æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error')
      }
    }

    async function runFullTest() {
      const outputEl = document.getElementById('test-output')
      outputEl.innerHTML = '<p>ğŸ”„ è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...</p>'

      log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹', 'info')

      // 1. æ¸…ç©ºå¹¶é‡æ–°è®¾ç½®
      clearLocalStorage()
      await new Promise(resolve => setTimeout(resolve, 100))

      // 2. æ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨
      await simulateProviderStore()
      await new Promise(resolve => setTimeout(resolve, 100))

      // 3. æ£€æŸ¥çŠ¶æ€
      checkLocalStorage()

      // 4. æ€»ç»“
      const savedProvider = localStorage.getItem('yprompt_selected_provider')
      const savedModel = localStorage.getItem('yprompt_selected_model')

      if (savedProvider && savedModel) {
        outputEl.innerHTML = `
          <p class="status-ok">âœ… å®Œæ•´æµ‹è¯•é€šè¿‡</p>
          <p>é…ç½®ç»“æœ: ${savedProvider} / ${savedModel}</p>
          <button onclick="window.open('/', '_blank')" style="background: #10b981;">æµ‹è¯•ä¸»åº”ç”¨</button>
        `
        log('å®Œæ•´æµ‹è¯•é€šè¿‡ï¼é…ç½®å·²æ­£ç¡®è®¾ç½®', 'success')
      } else {
        outputEl.innerHTML = `<p class="status-error">âŒ å®Œæ•´æµ‹è¯•å¤±è´¥ï¼Œé…ç½®æœªæ­£ç¡®è®¾ç½®</p>`
        log('å®Œæ•´æµ‹è¯•å¤±è´¥', 'error')
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ', 'info')
      checkLocalStorage()
    })
  </script>
</body>
</html>
```


## index.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <title>YPrompt</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- React Grab -->
  <script type="module" src="./react-grab-js/index.global.js"></script>
  <!-- Cursor Provider (ä½¿ç”¨æœ¬åœ°æ„å»ºç‰ˆæœ¬ï¼Œå·²é…ç½® serverUrl) -->
  <script type="module" src="./react-grab-js/cursor-client.global.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>

```


## package-lock.json

```json
{
  "name": "yprompt",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "yprompt",
      "version": "1.0.0",
      "dependencies": {
        "@react-grab/cursor": "^0.0.88",
        "@tailwindcss/typography": "^0.5.18",
        "@types/marked": "^5.0.2",
        "dompurify": "^3.1.7",
        "echarts": "^5.5.0",
        "highlight.js": "^11.9.0",
        "lucide-react": "^0.544.0",
        "marked": "^16.3.0",
        "mermaid": "^10.9.1",
        "react": "^18.3.1",
        "react-dom": "^18.3.1",
        "react-router-dom": "^6.26.0",
        "zustand": "^4.5.5"
      },
      "devDependencies": {
        "@react-grab/gemini": "^0.0.88",
        "@types/d3": "^7.4.3",
        "@types/node": "^20.10.0",
        "@types/react": "^18.3.5",
        "@types/react-dom": "^18.3.0",
        "@vitejs/plugin-react": "^4.3.1",
        "autoprefixer": "^10.4.16",
        "baseline-browser-mapping": "^2.8.29",
        "postcss": "^8.4.32",
        "react-grab": "^0.0.88",
        "tailwindcss": "^3.3.6",
        "typescript": "~5.3.0",
        "vite": "^5.0.0"
      }
    },
    "node_modules/@alloc/quick-lru": {
      "version": "5.2.0",
      "resolved": "https://registry.npmmirror.com/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
      "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.5.tgz",
      "integrity": "sha512-6uFXyCayocRbqhZOB+6XcuZbkMNimwfVGFji8CTZnCzOHVGvDqzvitu1re2AU5LROliz7eQPhB8CpAMvnx9EjA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.5.tgz",
      "integrity": "sha512-e7jT4DxYvIDLk1ZHmU/m/mB19rex9sv0c2ftBtjSBv+kVM/902eh0fINUzD7UwLLNR+jU585GxUJ8/EBfAM5fw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/core/node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
      "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets/node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/@babel/helper-compilation-targets/node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmmirror.com/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
      "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.5"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.27.2.tgz",
      "integrity": "sha512-LPDZ85aEJyYSd18/DkjNh4/y1ntkE5KwUHWTiqgRxruuZL2F1yuHligVHLvcHY2vMHXttKFpJn6LwfI7cw7ODw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/parser": "^7.27.2",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.5.tgz",
      "integrity": "sha512-TCCj4t55U90khlYkVV/0TfkJkAkUg3jZFA3Neb7unZT8CPok7iiRfaX0F+WnqWqt7OxhOn0uBKXCw4lbL8W0aQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.5",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.5.tgz",
      "integrity": "sha512-qQ5m48eI/MFLQ5PxQj4PFaprjyCTLI37ElWMmNs0K8Lk3dVeOdNpB3ks8jc7yM5CDmVC73eMVk/trk3fgmrUpA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@braintree/sanitize-url": {
      "version": "6.0.4",
      "resolved": "https://registry.npmjs.org/@braintree/sanitize-url/-/sanitize-url-6.0.4.tgz",
      "integrity": "sha512-s3jaWicZd0pkP0jf5ysyHUI/RE7MHos6qlToFcGWXVp+ykHOy77OUMrfbgJ9it2C5bow7OIQwYYaHjk9XlBQ2A==",
      "license": "MIT"
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@hono/node-server": {
      "version": "1.19.7",
      "resolved": "https://registry.npmjs.org/@hono/node-server/-/node-server-1.19.7.tgz",
      "integrity": "sha512-vUcD0uauS7EU2caukW8z5lJKtoGMokxNbJtBiwHgpqxEXokaHCBkQUmCHhjFB1VUTWdqj25QoMkMKzgjq+uhrw==",
      "license": "MIT",
      "engines": {
        "node": ">=18.14.1"
      },
      "peerDependencies": {
        "hono": "^4"
      }
    },
    "node_modules/@isaacs/cliui": {
      "version": "8.0.2",
      "resolved": "https://registry.npmmirror.com/@isaacs/cliui/-/cliui-8.0.2.tgz",
      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
      "license": "ISC",
      "dependencies": {
        "string-width": "^5.1.2",
        "string-width-cjs": "npm:string-width@^4.2.0",
        "strip-ansi": "^7.0.1",
        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
        "wrap-ansi": "^8.1.0",
        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmmirror.com/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmmirror.com/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmmirror.com/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "license": "MIT"
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmmirror.com/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@nodelib/fs.scandir": {
      "version": "2.1.5",
      "resolved": "https://registry.npmmirror.com/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
      "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.stat": "2.0.5",
        "run-parallel": "^1.1.9"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.stat": {
      "version": "2.0.5",
      "resolved": "https://registry.npmmirror.com/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
      "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
      "license": "MIT",
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.walk": {
      "version": "1.2.8",
      "resolved": "https://registry.npmmirror.com/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
      "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.scandir": "2.1.5",
        "fastq": "^1.6.0"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@pkgjs/parseargs": {
      "version": "0.11.0",
      "resolved": "https://registry.npmmirror.com/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
      "license": "MIT",
      "optional": true,
      "engines": {
        "node": ">=14"
      }
    },
    "node_modules/@react-grab/cursor": {
      "version": "0.0.88",
      "resolved": "https://registry.npmjs.org/@react-grab/cursor/-/cursor-0.0.88.tgz",
      "integrity": "sha512-zwqGYqyjeO8IQN0cnY0aSATEeil/p4xac4qUWJBk0c9McCUTt1YaKZYy4SudzzSDPxJiC7GYqR/iXNP7vSExSw==",
      "dependencies": {
        "@hono/node-server": "^1.19.6",
        "execa": "^9.6.0",
        "fkill": "^9.0.0",
        "hono": "^4.0.0",
        "picocolors": "^1.1.1",
        "react-grab": "0.0.88"
      },
      "bin": {
        "react-grab-cursor": "dist/cli.cjs"
      }
    },
    "node_modules/@react-grab/gemini": {
      "version": "0.0.88",
      "resolved": "https://registry.npmjs.org/@react-grab/gemini/-/gemini-0.0.88.tgz",
      "integrity": "sha512-m6kbLlE0O0Yt1OUwvcXgl83se2JKzE4RJiV2ItZeiTpG0smVhK6A+YeAWzM0CzRreR2E19pDg+bm+0UC6W35mQ==",
      "dev": true,
      "dependencies": {
        "@hono/node-server": "^1.19.6",
        "execa": "^9.6.0",
        "fkill": "^9.0.0",
        "hono": "^4.0.0",
        "picocolors": "^1.1.1",
        "react-grab": "0.0.88"
      },
      "bin": {
        "react-grab-gemini": "dist/cli.cjs"
      }
    },
    "node_modules/@remix-run/router": {
      "version": "1.23.1",
      "resolved": "https://registry.npmjs.org/@remix-run/router/-/router-1.23.1.tgz",
      "integrity": "sha512-vDbaOzF7yT2Qs4vO6XV1MHcJv+3dgR1sT+l3B8xxOVhUC336prMvqrvsLL/9Dnw2xr6Qhz4J0dmS0llNAbnUmQ==",
      "license": "MIT",
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.27",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.27.tgz",
      "integrity": "sha512-+d0F4MKMCbeVUJwG96uQ4SgAznZNSq93I3V+9NHA4OpvqG8mRCpGdKmK8l/dl02h2CCDHwW2FqilnTyDcAnqjA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.50.2.tgz",
      "integrity": "sha512-uLN8NAiFVIRKX9ZQha8wy6UUs06UNSZ32xj6giK/rmMXAgKahwExvK6SsmgU5/brh4w/nSgj8e0k3c1HBQpa0A==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.50.2.tgz",
      "integrity": "sha512-oEouqQk2/zxxj22PNcGSskya+3kV0ZKH+nQxuCCOGJ4oTXBdNTbv+f/E3c74cNLeMO1S5wVWacSws10TTSB77g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.50.2.tgz",
      "integrity": "sha512-OZuTVTpj3CDSIxmPgGH8en/XtirV5nfljHZ3wrNwvgkT5DQLhIKAeuFSiwtbMto6oVexV0k1F1zqURPKf5rI1Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.50.2.tgz",
      "integrity": "sha512-Wa/Wn8RFkIkr1vy1k1PB//VYhLnlnn5eaJkfTQKivirOvzu5uVd2It01ukeQstMursuz7S1bU+8WW+1UPXpa8A==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.50.2.tgz",
      "integrity": "sha512-QkzxvH3kYN9J1w7D1A+yIMdI1pPekD+pWx7G5rXgnIlQ1TVYVC6hLl7SOV9pi5q9uIDF9AuIGkuzcbF7+fAhow==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.50.2.tgz",
      "integrity": "sha512-dkYXB0c2XAS3a3jmyDkX4Jk0m7gWLFzq1C3qUnJJ38AyxIF5G/dyS4N9B30nvFseCfgtCEdbYFhk0ChoCGxPog==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.50.2.tgz",
      "integrity": "sha512-9VlPY/BN3AgbukfVHAB8zNFWB/lKEuvzRo1NKev0Po8sYFKx0i+AQlCYftgEjcL43F2h9Ui1ZSdVBc4En/sP2w==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.50.2.tgz",
      "integrity": "sha512-+GdKWOvsifaYNlIVf07QYan1J5F141+vGm5/Y8b9uCZnG/nxoGqgCmR24mv0koIWWuqvFYnbURRqw1lv7IBINw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.50.2.tgz",
      "integrity": "sha512-df0Eou14ojtUdLQdPFnymEQteENwSJAdLf5KCDrmZNsy1c3YaCNaJvYsEUHnrg+/DLBH612/R0xd3dD03uz2dg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.50.2.tgz",
      "integrity": "sha512-iPeouV0UIDtz8j1YFR4OJ/zf7evjauqv7jQ/EFs0ClIyL+by++hiaDAfFipjOgyz6y6xbDvJuiU4HwpVMpRFDQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.50.2.tgz",
      "integrity": "sha512-OL6KaNvBopLlj5fTa5D5bau4W82f+1TyTZRr2BdnfsrnQnmdxh4okMxR2DcDkJuh4KeoQZVuvHvzuD/lyLn2Kw==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.50.2.tgz",
      "integrity": "sha512-I21VJl1w6z/K5OTRl6aS9DDsqezEZ/yKpbqlvfHbW0CEF5IL8ATBMuUx6/mp683rKTK8thjs/0BaNrZLXetLag==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.50.2.tgz",
      "integrity": "sha512-Hq6aQJT/qFFHrYMjS20nV+9SKrXL2lvFBENZoKfoTH2kKDOJqff5OSJr4x72ZaG/uUn+XmBnGhfr4lwMRrmqCQ==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.50.2.tgz",
      "integrity": "sha512-82rBSEXRv5qtKyr0xZ/YMF531oj2AIpLZkeNYxmKNN6I2sVE9PGegN99tYDLK2fYHJITL1P2Lgb4ZXnv0PjQvw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.50.2.tgz",
      "integrity": "sha512-4Q3S3Hy7pC6uaRo9gtXUTJ+EKo9AKs3BXKc2jYypEcMQ49gDPFU2P1ariX9SEtBzE5egIX6fSUmbmGazwBVF9w==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.50.2.tgz",
      "integrity": "sha512-9Jie/At6qk70dNIcopcL4p+1UirusEtznpNtcq/u/C5cC4HBX7qSGsYIcG6bdxj15EYWhHiu02YvmdPzylIZlA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.50.2.tgz",
      "integrity": "sha512-HPNJwxPL3EmhzeAnsWQCM3DcoqOz3/IC6de9rWfGR8ZCuEHETi9km66bH/wG3YH0V3nyzyFEGUZeL5PKyy4xvw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.50.2.tgz",
      "integrity": "sha512-nMKvq6FRHSzYfKLHZ+cChowlEkR2lj/V0jYj9JnGUVPL2/mIeFGmVM2mLaFeNa5Jev7W7TovXqXIG2d39y1KYA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.50.2.tgz",
      "integrity": "sha512-eFUvvnTYEKeTyHEijQKz81bLrUQOXKZqECeiWH6tb8eXXbZk+CXSG2aFrig2BQ/pjiVRj36zysjgILkqarS2YA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.50.2.tgz",
      "integrity": "sha512-cBaWmXqyfRhH8zmUxK3d3sAhEWLrtMjWBRwdMMHJIXSjvjLKvv49adxiEz+FJ8AP90apSDDBx2Tyd/WylV6ikA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.50.2.tgz",
      "integrity": "sha512-APwKy6YUhvZaEoHyM+9xqmTpviEI+9eL7LoCH+aLcvWYHJ663qG5zx7WzWZY+a9qkg5JtzcMyJ9z0WtQBMDmgA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@sec-ant/readable-stream": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/@sec-ant/readable-stream/-/readable-stream-0.4.1.tgz",
      "integrity": "sha512-831qok9r2t8AlxLko40y2ebgSDhenenCatLVeW/uBtnHPyhHOvG0C7TvfgecV+wHzIm5KUICgzmVpWS+IMEAeg==",
      "license": "MIT"
    },
    "node_modules/@sindresorhus/merge-streams": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/@sindresorhus/merge-streams/-/merge-streams-4.0.0.tgz",
      "integrity": "sha512-tlqY9xq5ukxTUZBmoOp+m61cqwQD5pHJtFY3Mn8CA8ps6yghLH/Hw8UPdqg4OLmFW3IFlcXnQNmo/dh8HzXYIQ==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@tailwindcss/typography": {
      "version": "0.5.18",
      "resolved": "https://registry.npmmirror.com/@tailwindcss/typography/-/typography-0.5.18.tgz",
      "integrity": "sha512-dDIgwZOlf+tVkZ7A029VvQ1+ngKATENDjMEx2N35s2yPjfTS05RWSM8ilhEWSa5DMJ6ci2Ha9WNZEd2GQjrdQg==",
      "license": "MIT",
      "dependencies": {
        "postcss-selector-parser": "6.0.10"
      },
      "peerDependencies": {
        "tailwindcss": ">=3.0.0 || insiders || >=4.0.0-alpha.20 || >=4.0.0-beta.1"
      }
    },
    "node_modules/@tailwindcss/typography/node_modules/postcss-selector-parser": {
      "version": "6.0.10",
      "resolved": "https://registry.npmmirror.com/postcss-selector-parser/-/postcss-selector-parser-6.0.10.tgz",
      "integrity": "sha512-IQ7TZdoaqbT+LCpShg46jnZVlhWD2w6iQYAcYXfHARZ7X1t/UGhhceQDs5X0cGqKvYlHNOuv7Oa1xmb0oQuA3w==",
      "license": "MIT",
      "dependencies": {
        "cssesc": "^3.0.0",
        "util-deprecate": "^1.0.2"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.27.0",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
      "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
      "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.2"
      }
    },
    "node_modules/@types/d3": {
      "version": "7.4.3",
      "resolved": "https://registry.npmjs.org/@types/d3/-/d3-7.4.3.tgz",
      "integrity": "sha512-lZXZ9ckh5R8uiFVt8ogUNf+pIrK4EsWrx2Np75WvF/eTpJ0FMHNhjXk8CKEx/+gpHbNQyJWehbFaTvqmHWB3ww==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-array": "*",
        "@types/d3-axis": "*",
        "@types/d3-brush": "*",
        "@types/d3-chord": "*",
        "@types/d3-color": "*",
        "@types/d3-contour": "*",
        "@types/d3-delaunay": "*",
        "@types/d3-dispatch": "*",
        "@types/d3-drag": "*",
        "@types/d3-dsv": "*",
        "@types/d3-ease": "*",
        "@types/d3-fetch": "*",
        "@types/d3-force": "*",
        "@types/d3-format": "*",
        "@types/d3-geo": "*",
        "@types/d3-hierarchy": "*",
        "@types/d3-interpolate": "*",
        "@types/d3-path": "*",
        "@types/d3-polygon": "*",
        "@types/d3-quadtree": "*",
        "@types/d3-random": "*",
        "@types/d3-scale": "*",
        "@types/d3-scale-chromatic": "*",
        "@types/d3-selection": "*",
        "@types/d3-shape": "*",
        "@types/d3-time": "*",
        "@types/d3-time-format": "*",
        "@types/d3-timer": "*",
        "@types/d3-transition": "*",
        "@types/d3-zoom": "*"
      }
    },
    "node_modules/@types/d3-array": {
      "version": "3.2.2",
      "resolved": "https://registry.npmjs.org/@types/d3-array/-/d3-array-3.2.2.tgz",
      "integrity": "sha512-hOLWVbm7uRza0BYXpIIW5pxfrKe0W+D5lrFiAEYR+pb6w3N2SwSMaJbXdUfSEv+dT4MfHBLtn5js0LAWaO6otw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-axis": {
      "version": "3.0.6",
      "resolved": "https://registry.npmjs.org/@types/d3-axis/-/d3-axis-3.0.6.tgz",
      "integrity": "sha512-pYeijfZuBd87T0hGn0FO1vQ/cgLk6E1ALJjfkC0oJ8cbwkZl3TpgS8bVBLZN+2jjGgg38epgxb2zmoGtSfvgMw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-selection": "*"
      }
    },
    "node_modules/@types/d3-brush": {
      "version": "3.0.6",
      "resolved": "https://registry.npmjs.org/@types/d3-brush/-/d3-brush-3.0.6.tgz",
      "integrity": "sha512-nH60IZNNxEcrh6L1ZSMNA28rj27ut/2ZmI3r96Zd+1jrZD++zD3LsMIjWlvg4AYrHn/Pqz4CF3veCxGjtbqt7A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-selection": "*"
      }
    },
    "node_modules/@types/d3-chord": {
      "version": "3.0.6",
      "resolved": "https://registry.npmjs.org/@types/d3-chord/-/d3-chord-3.0.6.tgz",
      "integrity": "sha512-LFYWWd8nwfwEmTZG9PfQxd17HbNPksHBiJHaKuY1XeqscXacsS2tyoo6OdRsjf+NQYeB6XrNL3a25E3gH69lcg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-color": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/@types/d3-color/-/d3-color-3.1.3.tgz",
      "integrity": "sha512-iO90scth9WAbmgv7ogoq57O9YpKmFBbmoEoCHDB2xMBY0+/KVrqAaCDyCE16dUspeOvIxFFRI+0sEtqDqy2b4A==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-contour": {
      "version": "3.0.6",
      "resolved": "https://registry.npmjs.org/@types/d3-contour/-/d3-contour-3.0.6.tgz",
      "integrity": "sha512-BjzLgXGnCWjUSYGfH1cpdo41/hgdWETu4YxpezoztawmqsvCeep+8QGfiY6YbDvfgHz/DkjeIkkZVJavB4a3rg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-array": "*",
        "@types/geojson": "*"
      }
    },
    "node_modules/@types/d3-delaunay": {
      "version": "6.0.4",
      "resolved": "https://registry.npmjs.org/@types/d3-delaunay/-/d3-delaunay-6.0.4.tgz",
      "integrity": "sha512-ZMaSKu4THYCU6sV64Lhg6qjf1orxBthaC161plr5KuPHo3CNm8DTHiLw/5Eq2b6TsNP0W0iJrUOFscY6Q450Hw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-dispatch": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/@types/d3-dispatch/-/d3-dispatch-3.0.7.tgz",
      "integrity": "sha512-5o9OIAdKkhN1QItV2oqaE5KMIiXAvDWBDPrD85e58Qlz1c1kI/J0NcqbEG88CoTwJrYe7ntUCVfeUl2UJKbWgA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-drag": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/@types/d3-drag/-/d3-drag-3.0.7.tgz",
      "integrity": "sha512-HE3jVKlzU9AaMazNufooRJ5ZpWmLIoc90A37WU2JMmeq28w1FQqCZswHZ3xR+SuxYftzHq6WU6KJHvqxKzTxxQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-selection": "*"
      }
    },
    "node_modules/@types/d3-dsv": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/@types/d3-dsv/-/d3-dsv-3.0.7.tgz",
      "integrity": "sha512-n6QBF9/+XASqcKK6waudgL0pf/S5XHPPI8APyMLLUHd8NqouBGLsU8MgtO7NINGtPBtk9Kko/W4ea0oAspwh9g==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-ease": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/@types/d3-ease/-/d3-ease-3.0.2.tgz",
      "integrity": "sha512-NcV1JjO5oDzoK26oMzbILE6HW7uVXOHLQvHshBUW4UMdZGfiY6v5BeQwh9a9tCzv+CeefZQHJt5SRgK154RtiA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-fetch": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/@types/d3-fetch/-/d3-fetch-3.0.7.tgz",
      "integrity": "sha512-fTAfNmxSb9SOWNB9IoG5c8Hg6R+AzUHDRlsXsDZsNp6sxAEOP0tkP3gKkNSO/qmHPoBFTxNrjDprVHDQDvo5aA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-dsv": "*"
      }
    },
    "node_modules/@types/d3-force": {
      "version": "3.0.10",
      "resolved": "https://registry.npmjs.org/@types/d3-force/-/d3-force-3.0.10.tgz",
      "integrity": "sha512-ZYeSaCF3p73RdOKcjj+swRlZfnYpK1EbaDiYICEEp5Q6sUiqFaFQ9qgoshp5CzIyyb/yD09kD9o2zEltCexlgw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-format": {
      "version": "3.0.4",
      "resolved": "https://registry.npmjs.org/@types/d3-format/-/d3-format-3.0.4.tgz",
      "integrity": "sha512-fALi2aI6shfg7vM5KiR1wNJnZ7r6UuggVqtDA+xiEdPZQwy/trcQaHnwShLuLdta2rTymCNpxYTiMZX/e09F4g==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-geo": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/@types/d3-geo/-/d3-geo-3.1.0.tgz",
      "integrity": "sha512-856sckF0oP/diXtS4jNsiQw/UuK5fQG8l/a9VVLeSouf1/PPbBE1i1W852zVwKwYCBkFJJB7nCFTbk6UMEXBOQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/geojson": "*"
      }
    },
    "node_modules/@types/d3-hierarchy": {
      "version": "3.1.7",
      "resolved": "https://registry.npmjs.org/@types/d3-hierarchy/-/d3-hierarchy-3.1.7.tgz",
      "integrity": "sha512-tJFtNoYBtRtkNysX1Xq4sxtjK8YgoWUNpIiUee0/jHGRwqvzYxkq0hGVbbOGSz+JgFxxRu4K8nb3YpG3CMARtg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-interpolate": {
      "version": "3.0.4",
      "resolved": "https://registry.npmjs.org/@types/d3-interpolate/-/d3-interpolate-3.0.4.tgz",
      "integrity": "sha512-mgLPETlrpVV1YRJIglr4Ez47g7Yxjl1lj7YKsiMCb27VJH9W8NVM6Bb9d8kkpG/uAQS5AmbA48q2IAolKKo1MA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-color": "*"
      }
    },
    "node_modules/@types/d3-path": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/@types/d3-path/-/d3-path-3.1.1.tgz",
      "integrity": "sha512-VMZBYyQvbGmWyWVea0EHs/BwLgxc+MKi1zLDCONksozI4YJMcTt8ZEuIR4Sb1MMTE8MMW49v0IwI5+b7RmfWlg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-polygon": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/@types/d3-polygon/-/d3-polygon-3.0.2.tgz",
      "integrity": "sha512-ZuWOtMaHCkN9xoeEMr1ubW2nGWsp4nIql+OPQRstu4ypeZ+zk3YKqQT0CXVe/PYqrKpZAi+J9mTs05TKwjXSRA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-quadtree": {
      "version": "3.0.6",
      "resolved": "https://registry.npmjs.org/@types/d3-quadtree/-/d3-quadtree-3.0.6.tgz",
      "integrity": "sha512-oUzyO1/Zm6rsxKRHA1vH0NEDG58HrT5icx/azi9MF1TWdtttWl0UIUsjEQBBh+SIkrpd21ZjEv7ptxWys1ncsg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-random": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/@types/d3-random/-/d3-random-3.0.3.tgz",
      "integrity": "sha512-Imagg1vJ3y76Y2ea0871wpabqp613+8/r0mCLEBfdtqC7xMSfj9idOnmBYyMoULfHePJyxMAw3nWhJxzc+LFwQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-scale": {
      "version": "4.0.9",
      "resolved": "https://registry.npmjs.org/@types/d3-scale/-/d3-scale-4.0.9.tgz",
      "integrity": "sha512-dLmtwB8zkAeO/juAMfnV+sItKjlsw2lKdZVVy6LRr0cBmegxSABiLEpGVmSJJ8O08i4+sGR6qQtb6WtuwJdvVw==",
      "license": "MIT",
      "dependencies": {
        "@types/d3-time": "*"
      }
    },
    "node_modules/@types/d3-scale-chromatic": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/@types/d3-scale-chromatic/-/d3-scale-chromatic-3.1.0.tgz",
      "integrity": "sha512-iWMJgwkK7yTRmWqRB5plb1kadXyQ5Sj8V/zYlFGMUBbIPKQScw+Dku9cAAMgJG+z5GYDoMjWGLVOvjghDEFnKQ==",
      "license": "MIT"
    },
    "node_modules/@types/d3-selection": {
      "version": "3.0.11",
      "resolved": "https://registry.npmjs.org/@types/d3-selection/-/d3-selection-3.0.11.tgz",
      "integrity": "sha512-bhAXu23DJWsrI45xafYpkQ4NtcKMwWnAC/vKrd2l+nxMFuvOT3XMYTIj2opv8vq8AO5Yh7Qac/nSeP/3zjTK0w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-shape": {
      "version": "3.1.7",
      "resolved": "https://registry.npmjs.org/@types/d3-shape/-/d3-shape-3.1.7.tgz",
      "integrity": "sha512-VLvUQ33C+3J+8p+Daf+nYSOsjB4GXp19/S/aGo60m9h1v6XaxjiT82lKVWJCfzhtuZ3yD7i/TPeC/fuKLLOSmg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-path": "*"
      }
    },
    "node_modules/@types/d3-time": {
      "version": "3.0.4",
      "resolved": "https://registry.npmjs.org/@types/d3-time/-/d3-time-3.0.4.tgz",
      "integrity": "sha512-yuzZug1nkAAaBlBBikKZTgzCeA+k1uy4ZFwWANOfKw5z5LRhV0gNA7gNkKm7HoK+HRN0wX3EkxGk0fpbWhmB7g==",
      "license": "MIT"
    },
    "node_modules/@types/d3-time-format": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/@types/d3-time-format/-/d3-time-format-4.0.3.tgz",
      "integrity": "sha512-5xg9rC+wWL8kdDj153qZcsJ0FWiFt0J5RB6LYUNZjwSnesfblqrI/bJ1wBdJ8OQfncgbJG5+2F+qfqnqyzYxyg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-timer": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/@types/d3-timer/-/d3-timer-3.0.2.tgz",
      "integrity": "sha512-Ps3T8E8dZDam6fUyNiMkekK3XUsaUEik+idO9/YjPtfj2qruF8tFBXS7XhtE4iIXBLxhmLjP3SXpLhVf21I9Lw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/d3-transition": {
      "version": "3.0.9",
      "resolved": "https://registry.npmjs.org/@types/d3-transition/-/d3-transition-3.0.9.tgz",
      "integrity": "sha512-uZS5shfxzO3rGlu0cC3bjmMFKsXv+SmZZcgp0KD22ts4uGXp5EVYGzu/0YdwZeKmddhcAccYtREJKkPfXkZuCg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-selection": "*"
      }
    },
    "node_modules/@types/d3-zoom": {
      "version": "3.0.8",
      "resolved": "https://registry.npmjs.org/@types/d3-zoom/-/d3-zoom-3.0.8.tgz",
      "integrity": "sha512-iqMC4/YlFCSlO8+2Ii1GGGliCAY4XdeG748w5vQUbevlbDu0zSjH/+jojorQVBK/se0j6DUFNPBGSqD3YWYnDw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/d3-interpolate": "*",
        "@types/d3-selection": "*"
      }
    },
    "node_modules/@types/debug": {
      "version": "4.1.12",
      "resolved": "https://registry.npmjs.org/@types/debug/-/debug-4.1.12.tgz",
      "integrity": "sha512-vIChWdVG3LG1SMxEvI/AK+FWJthlrqlTu7fbrlywTkkaONwk/UAGaULXRlf8vkzFBLVm0zkMdCquhL5aOjhXPQ==",
      "license": "MIT",
      "dependencies": {
        "@types/ms": "*"
      }
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmmirror.com/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/geojson": {
      "version": "7946.0.16",
      "resolved": "https://registry.npmjs.org/@types/geojson/-/geojson-7946.0.16.tgz",
      "integrity": "sha512-6C8nqWur3j98U6+lXDfTUWIfgvZU+EumvpHKcYjujKH7woYyLj2sUmff0tRhrqM7BohUw7Pz3ZB1jj2gW9Fvmg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/marked": {
      "version": "5.0.2",
      "resolved": "https://registry.npmmirror.com/@types/marked/-/marked-5.0.2.tgz",
      "integrity": "sha512-OucS4KMHhFzhz27KxmWg7J+kIYqyqoW5kdIEI319hqARQQUTqhao3M/F+uFnDXD0Rg72iDDZxZNxq5gvctmLlg==",
      "license": "MIT"
    },
    "node_modules/@types/mdast": {
      "version": "3.0.15",
      "resolved": "https://registry.npmjs.org/@types/mdast/-/mdast-3.0.15.tgz",
      "integrity": "sha512-LnwD+mUEfxWMa1QpDraczIn6k0Ee3SMicuYSSzS6ZYl2gKS09EClnJYGd8Du6rfc5r/GZEk5o1mRb8TaTj03sQ==",
      "license": "MIT",
      "dependencies": {
        "@types/unist": "^2"
      }
    },
    "node_modules/@types/ms": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/@types/ms/-/ms-2.1.0.tgz",
      "integrity": "sha512-GsCCIZDE/p3i96vtEqx+7dBUGXrc7zeSK3wwPHIaRThS+9OhWIXRqzs4d6k1SVU8g91DrNRWxWUGhp5KXQb2VA==",
      "license": "MIT"
    },
    "node_modules/@types/node": {
      "version": "20.19.17",
      "resolved": "https://registry.npmmirror.com/@types/node/-/node-20.19.17.tgz",
      "integrity": "sha512-gfehUI8N1z92kygssiuWvLiwcbOB3IRktR6hTDgJlXMYh5OvkPSRmgfoBUmfZt+vhwJtX7v1Yw4KvvAf7c5QKQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "undici-types": "~6.21.0"
      }
    },
    "node_modules/@types/prop-types": {
      "version": "15.7.15",
      "resolved": "https://registry.npmjs.org/@types/prop-types/-/prop-types-15.7.15.tgz",
      "integrity": "sha512-F6bEyamV9jKGAFBEmlQnesRPGOQqS2+Uwi0Em15xenOxHaf2hv6L8YCVn3rPdPJOiJfPiCnLIRyvwVaqMY3MIw==",
      "license": "MIT"
    },
    "node_modules/@types/react": {
      "version": "18.3.27",
      "resolved": "https://registry.npmjs.org/@types/react/-/react-18.3.27.tgz",
      "integrity": "sha512-cisd7gxkzjBKU2GgdYrTdtQx1SORymWyaAFhaxQPK9bYO9ot3Y5OikQRvY0VYQtvwjeQnizCINJAenh/V7MK2w==",
      "license": "MIT",
      "dependencies": {
        "@types/prop-types": "*",
        "csstype": "^3.2.2"
      }
    },
    "node_modules/@types/react-dom": {
      "version": "18.3.7",
      "resolved": "https://registry.npmjs.org/@types/react-dom/-/react-dom-18.3.7.tgz",
      "integrity": "sha512-MEe3UeoENYVFXzoXEWsvcpg6ZvlrFNlOQ7EOsvhI3CfAXwzPfO8Qwuxd40nepsYKqyyVQnTdEfv68q91yLcKrQ==",
      "dev": true,
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "^18.0.0"
      }
    },
    "node_modules/@types/react-reconciler": {
      "version": "0.28.9",
      "resolved": "https://registry.npmjs.org/@types/react-reconciler/-/react-reconciler-0.28.9.tgz",
      "integrity": "sha512-HHM3nxyUZ3zAylX8ZEyrDNd2XZOnQ0D5XfunJF5FLQnZbHHYq4UWvW1QfelQNXv1ICNkwYhfxjwfnqivYB6bFg==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "*"
      }
    },
    "node_modules/@types/trusted-types": {
      "version": "2.0.7",
      "resolved": "https://registry.npmjs.org/@types/trusted-types/-/trusted-types-2.0.7.tgz",
      "integrity": "sha512-ScaPdn1dQczgbl0QFTeTOmVHFULt394XJgOQNoyVhZ6r2vLnMLJfBPd53SB52T/3G36VI1/g2MZaX0cwDuXsfw==",
      "license": "MIT",
      "optional": true
    },
    "node_modules/@types/unist": {
      "version": "2.0.11",
      "resolved": "https://registry.npmjs.org/@types/unist/-/unist-2.0.11.tgz",
      "integrity": "sha512-CmBKiL6NNo/OqgmMn95Fk9Whlp2mtvIv+KNpQKN2F4SjvrEesubTRWGYSg+BnWZOnlCaSTU1sMpsBOzgbYhnsA==",
      "license": "MIT"
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "4.7.0",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.7.0.tgz",
      "integrity": "sha512-gUu9hwfWvvEDBBmgtAowQCojwZmJ5mcLn3aufeCsitijs3+f2NsrPtlAWIR6OPiqljl96GVCUbLe0HyqIpVaoA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/core": "^7.28.0",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.27",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.17.0"
      },
      "engines": {
        "node": "^14.18.0 || >=16.0.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/aggregate-error": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/aggregate-error/-/aggregate-error-5.0.0.tgz",
      "integrity": "sha512-gOsf2YwSlleG6IjRYG2A7k0HmBMEo6qVNk9Bp/EaLgAJT5ngH6PXbqa4ItvnEwCm/velL5jAnQgsHsWnjhGmvw==",
      "license": "MIT",
      "dependencies": {
        "clean-stack": "^5.2.0",
        "indent-string": "^5.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/ansi-regex": {
      "version": "6.2.2",
      "resolved": "https://registry.npmmirror.com/ansi-regex/-/ansi-regex-6.2.2.tgz",
      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
      }
    },
    "node_modules/ansi-styles": {
      "version": "6.2.3",
      "resolved": "https://registry.npmmirror.com/ansi-styles/-/ansi-styles-6.2.3.tgz",
      "integrity": "sha512-4Dj6M28JB+oAH8kFkTLUo+a2jwOFkuqb3yucU0CANcRRUbxS0cP0nZYCGjcc3BNXwRIsUVmDGgzawme7zvJHvg==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/any-promise": {
      "version": "1.3.0",
      "resolved": "https://registry.npmmirror.com/any-promise/-/any-promise-1.3.0.tgz",
      "integrity": "sha512-7UvmKalWRt1wgjL1RrGxoSJW/0QZFIegpeGvZG9kjp8vrRu55XTHbwnqq2GpXm9uLbcuhxm3IqX9OB4MZR1b2A==",
      "license": "MIT"
    },
    "node_modules/anymatch": {
      "version": "3.1.3",
      "resolved": "https://registry.npmmirror.com/anymatch/-/anymatch-3.1.3.tgz",
      "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
      "license": "ISC",
      "dependencies": {
        "normalize-path": "^3.0.0",
        "picomatch": "^2.0.4"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/arg": {
      "version": "5.0.2",
      "resolved": "https://registry.npmmirror.com/arg/-/arg-5.0.2.tgz",
      "integrity": "sha512-PYjyFOLKQ9y57JvQ6QLo8dAgNqswh8M1RMJYdQduT6xbWSgK36P/Z/v+p888pM69jMMfS8Xd8F6I1kQ/I9HUGg==",
      "license": "MIT"
    },
    "node_modules/autoprefixer": {
      "version": "10.4.21",
      "resolved": "https://registry.npmmirror.com/autoprefixer/-/autoprefixer-10.4.21.tgz",
      "integrity": "sha512-O+A6LWV5LDHSJD3LjHYoNi4VLsj/Whi7k6zG12xTYaU4cQ8oxQGckXNX8cRHK5yOZ/ppVHe0ZBXGzSV9jXdVbQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/autoprefixer"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "browserslist": "^4.24.4",
        "caniuse-lite": "^1.0.30001702",
        "fraction.js": "^4.3.7",
        "normalize-range": "^0.1.2",
        "picocolors": "^1.1.1",
        "postcss-value-parser": "^4.2.0"
      },
      "bin": {
        "autoprefixer": "bin/autoprefixer"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      },
      "peerDependencies": {
        "postcss": "^8.1.0"
      }
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmmirror.com/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "license": "MIT"
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.8.29",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.8.29.tgz",
      "integrity": "sha512-sXdt2elaVnhpDNRDz+1BDx1JQoJRuNk7oVlAlbGiFkLikHCAQiccexF/9e91zVi6RCgqspl04aP+6Cnl9zRLrA==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/binary-extensions": {
      "version": "2.3.0",
      "resolved": "https://registry.npmmirror.com/binary-extensions/-/binary-extensions-2.3.0.tgz",
      "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/bippy": {
      "version": "0.5.26",
      "resolved": "https://registry.npmjs.org/bippy/-/bippy-0.5.26.tgz",
      "integrity": "sha512-pOy5vxOX2gXo0L7lIwo5H9mqvrgAE5mCZgrPOli5SaxxXx8VnPHi1vxDr5nancX5F6rYqmigMpAalPrM2I3nCA==",
      "license": "MIT",
      "dependencies": {
        "@types/react-reconciler": "^0.28.9"
      },
      "peerDependencies": {
        "react": ">=17.0.1"
      }
    },
    "node_modules/brace-expansion": {
      "version": "2.0.2",
      "resolved": "https://registry.npmmirror.com/brace-expansion/-/brace-expansion-2.0.2.tgz",
      "integrity": "sha512-Jt0vHyM+jmUBqojB7E1NIYadt0vI0Qxjxd2TErW94wDz+E2LAm5vKMXXwg6ZZBTHPuUlDgQHKXvjGBdfcF1ZDQ==",
      "license": "MIT",
      "dependencies": {
        "balanced-match": "^1.0.0"
      }
    },
    "node_modules/braces": {
      "version": "3.0.3",
      "resolved": "https://registry.npmmirror.com/braces/-/braces-3.0.3.tgz",
      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
      "license": "MIT",
      "dependencies": {
        "fill-range": "^7.1.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/browserslist": {
      "version": "4.26.2",
      "resolved": "https://registry.npmmirror.com/browserslist/-/browserslist-4.26.2.tgz",
      "integrity": "sha512-ECFzp6uFOSB+dcZ5BK/IBaGWssbSYBHvuMeMt3MMFyhI0Z8SqGgEkBLARgpRH3hutIgPVsALcMwbDrJqPxQ65A==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "baseline-browser-mapping": "^2.8.3",
        "caniuse-lite": "^1.0.30001741",
        "electron-to-chromium": "^1.5.218",
        "node-releases": "^2.0.21",
        "update-browserslist-db": "^1.1.3"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/camelcase-css": {
      "version": "2.0.1",
      "resolved": "https://registry.npmmirror.com/camelcase-css/-/camelcase-css-2.0.1.tgz",
      "integrity": "sha512-QOSvevhslijgYwRx6Rv7zKdMF8lbRmx+uQGx2+vDc+KI/eBnsy9kit5aj23AgGu3pa4t9AgwbnXWqS+iOY+2aA==",
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001743",
      "resolved": "https://registry.npmmirror.com/caniuse-lite/-/caniuse-lite-1.0.30001743.tgz",
      "integrity": "sha512-e6Ojr7RV14Un7dz6ASD0aZDmQPT/A+eZU+nuTNfjqmRrmkmQlnTNWH0SKmqagx9PeW87UVqapSurtAXifmtdmw==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "CC-BY-4.0"
    },
    "node_modules/character-entities": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/character-entities/-/character-entities-2.0.2.tgz",
      "integrity": "sha512-shx7oQ0Awen/BRIdkjkvz54PnEEI/EjwXDSIZp86/KKdbafHh1Df/RYGBhn4hbe2+uKC9FnT5UCEdyPz3ai9hQ==",
      "license": "MIT",
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/wooorm"
      }
    },
    "node_modules/chokidar": {
      "version": "3.6.0",
      "resolved": "https://registry.npmmirror.com/chokidar/-/chokidar-3.6.0.tgz",
      "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
      "license": "MIT",
      "dependencies": {
        "anymatch": "~3.1.2",
        "braces": "~3.0.2",
        "glob-parent": "~5.1.2",
        "is-binary-path": "~2.1.0",
        "is-glob": "~4.0.1",
        "normalize-path": "~3.0.0",
        "readdirp": "~3.6.0"
      },
      "engines": {
        "node": ">= 8.10.0"
      },
      "funding": {
        "url": "https://paulmillr.com/funding/"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/chokidar/node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmmirror.com/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/clean-stack": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/clean-stack/-/clean-stack-5.3.0.tgz",
      "integrity": "sha512-9ngPTOhYGQqNVSfeJkYXHmF7AGWp4/nN5D/QqNQs3Dvxd1Kk/WpjHfNujKHYUQ/5CoGyOyFNoWSPk5afzP0QVg==",
      "license": "MIT",
      "dependencies": {
        "escape-string-regexp": "5.0.0"
      },
      "engines": {
        "node": ">=14.16"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/color-convert": {
      "version": "2.0.1",
      "resolved": "https://registry.npmmirror.com/color-convert/-/color-convert-2.0.1.tgz",
      "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
      "license": "MIT",
      "dependencies": {
        "color-name": "~1.1.4"
      },
      "engines": {
        "node": ">=7.0.0"
      }
    },
    "node_modules/color-name": {
      "version": "1.1.4",
      "resolved": "https://registry.npmmirror.com/color-name/-/color-name-1.1.4.tgz",
      "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
      "license": "MIT"
    },
    "node_modules/commander": {
      "version": "4.1.1",
      "resolved": "https://registry.npmmirror.com/commander/-/commander-4.1.1.tgz",
      "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA==",
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/cose-base": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/cose-base/-/cose-base-1.0.3.tgz",
      "integrity": "sha512-s9whTXInMSgAp/NVXVNuVxVKzGH2qck3aQlVHxDCdAEPgtMKwc4Wq6/QKhgdEdgbLSi9rBTAcPoRa6JpiG4ksg==",
      "license": "MIT",
      "dependencies": {
        "layout-base": "^1.0.0"
      }
    },
    "node_modules/cross-spawn": {
      "version": "7.0.6",
      "resolved": "https://registry.npmmirror.com/cross-spawn/-/cross-spawn-7.0.6.tgz",
      "integrity": "sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==",
      "license": "MIT",
      "dependencies": {
        "path-key": "^3.1.0",
        "shebang-command": "^2.0.0",
        "which": "^2.0.1"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/cssesc": {
      "version": "3.0.0",
      "resolved": "https://registry.npmmirror.com/cssesc/-/cssesc-3.0.0.tgz",
      "integrity": "sha512-/Tb/JcjK111nNScGob5MNtsntNM1aCNUDipB/TkwZFhyDrrE47SOx/18wF2bbjgc3ZzCSKW1T5nt5EbFoAz/Vg==",
      "license": "MIT",
      "bin": {
        "cssesc": "bin/cssesc"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/csstype": {
      "version": "3.2.3",
      "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.2.3.tgz",
      "integrity": "sha512-z1HGKcYy2xA8AGQfwrn0PAy+PB7X/GSj3UVJW9qKyn43xWa+gl5nXmU4qqLMRzWVLFC8KusUX8T/0kCiOYpAIQ==",
      "license": "MIT"
    },
    "node_modules/cytoscape": {
      "version": "3.33.1",
      "resolved": "https://registry.npmjs.org/cytoscape/-/cytoscape-3.33.1.tgz",
      "integrity": "sha512-iJc4TwyANnOGR1OmWhsS9ayRS3s+XQ185FmuHObThD+5AeJCakAAbWv8KimMTt08xCCLNgneQwFp+JRJOr9qGQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/cytoscape-cose-bilkent": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/cytoscape-cose-bilkent/-/cytoscape-cose-bilkent-4.1.0.tgz",
      "integrity": "sha512-wgQlVIUJF13Quxiv5e1gstZ08rnZj2XaLHGoFMYXz7SkNfCDOOteKBE6SYRfA9WxxI/iBc3ajfDoc6hb/MRAHQ==",
      "license": "MIT",
      "dependencies": {
        "cose-base": "^1.0.0"
      },
      "peerDependencies": {
        "cytoscape": "^3.2.0"
      }
    },
    "node_modules/d3": {
      "version": "7.9.0",
      "resolved": "https://registry.npmjs.org/d3/-/d3-7.9.0.tgz",
      "integrity": "sha512-e1U46jVP+w7Iut8Jt8ri1YsPOvFpg46k+K8TpCb0P+zjCkjkPnV7WzfDJzMHy1LnA+wj5pLT1wjO901gLXeEhA==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "3",
        "d3-axis": "3",
        "d3-brush": "3",
        "d3-chord": "3",
        "d3-color": "3",
        "d3-contour": "4",
        "d3-delaunay": "6",
        "d3-dispatch": "3",
        "d3-drag": "3",
        "d3-dsv": "3",
        "d3-ease": "3",
        "d3-fetch": "3",
        "d3-force": "3",
        "d3-format": "3",
        "d3-geo": "3",
        "d3-hierarchy": "3",
        "d3-interpolate": "3",
        "d3-path": "3",
        "d3-polygon": "3",
        "d3-quadtree": "3",
        "d3-random": "3",
        "d3-scale": "4",
        "d3-scale-chromatic": "3",
        "d3-selection": "3",
        "d3-shape": "3",
        "d3-time": "3",
        "d3-time-format": "4",
        "d3-timer": "3",
        "d3-transition": "3",
        "d3-zoom": "3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-array": {
      "version": "3.2.4",
      "resolved": "https://registry.npmjs.org/d3-array/-/d3-array-3.2.4.tgz",
      "integrity": "sha512-tdQAmyA18i4J7wprpYq8ClcxZy3SC31QMeByyCFyRt7BVHdREQZ5lpzoe5mFEYZUWe+oq8HBvk9JjpibyEV4Jg==",
      "license": "ISC",
      "dependencies": {
        "internmap": "1 - 2"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-axis": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-axis/-/d3-axis-3.0.0.tgz",
      "integrity": "sha512-IH5tgjV4jE/GhHkRV0HiVYPDtvfjHQlQfJHs0usq7M30XcSBvOotpmH1IgkcXsO/5gEQZD43B//fc7SRT5S+xw==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-brush": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-brush/-/d3-brush-3.0.0.tgz",
      "integrity": "sha512-ALnjWlVYkXsVIGlOsuWH1+3udkYFI48Ljihfnh8FZPF2QS9o+PzGLBslO0PjzVoHLZ2KCVgAM8NVkXPJB2aNnQ==",
      "license": "ISC",
      "dependencies": {
        "d3-dispatch": "1 - 3",
        "d3-drag": "2 - 3",
        "d3-interpolate": "1 - 3",
        "d3-selection": "3",
        "d3-transition": "3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-chord": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-chord/-/d3-chord-3.0.1.tgz",
      "integrity": "sha512-VE5S6TNa+j8msksl7HwjxMHDM2yNK3XCkusIlpX5kwauBfXuyLAtNg9jCp/iHH61tgI4sb6R/EIMWCqEIdjT/g==",
      "license": "ISC",
      "dependencies": {
        "d3-path": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-color": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-color/-/d3-color-3.1.0.tgz",
      "integrity": "sha512-zg/chbXyeBtMQ1LbD/WSoW2DpC3I0mpmPdW+ynRTj/x2DAWYrIY7qeZIHidozwV24m4iavr15lNwIwLxRmOxhA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-contour": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/d3-contour/-/d3-contour-4.0.2.tgz",
      "integrity": "sha512-4EzFTRIikzs47RGmdxbeUvLWtGedDUNkTcmzoeyg4sP/dvCexO47AaQL7VKy/gul85TOxw+IBgA8US2xwbToNA==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "^3.2.0"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-delaunay": {
      "version": "6.0.4",
      "resolved": "https://registry.npmjs.org/d3-delaunay/-/d3-delaunay-6.0.4.tgz",
      "integrity": "sha512-mdjtIZ1XLAM8bm/hx3WwjfHt6Sggek7qH043O8KEjDXN40xi3vx/6pYSVTwLjEgiXQTbvaouWKynLBiUZ6SK6A==",
      "license": "ISC",
      "dependencies": {
        "delaunator": "5"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-dispatch": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-dispatch/-/d3-dispatch-3.0.1.tgz",
      "integrity": "sha512-rzUyPU/S7rwUflMyLc1ETDeBj0NRuHKKAcvukozwhshr6g6c5d8zh4c2gQjY2bZ0dXeGLWc1PF174P2tVvKhfg==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-drag": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-drag/-/d3-drag-3.0.0.tgz",
      "integrity": "sha512-pWbUJLdETVA8lQNJecMxoXfH6x+mO2UQo8rSmZ+QqxcbyA3hfeprFgIT//HW2nlHChWeIIMwS2Fq+gEARkhTkg==",
      "license": "ISC",
      "dependencies": {
        "d3-dispatch": "1 - 3",
        "d3-selection": "3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-dsv": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-dsv/-/d3-dsv-3.0.1.tgz",
      "integrity": "sha512-UG6OvdI5afDIFP9w4G0mNq50dSOsXHJaRE8arAS5o9ApWnIElp8GZw1Dun8vP8OyHOZ/QJUKUJwxiiCCnUwm+Q==",
      "license": "ISC",
      "dependencies": {
        "commander": "7",
        "iconv-lite": "0.6",
        "rw": "1"
      },
      "bin": {
        "csv2json": "bin/dsv2json.js",
        "csv2tsv": "bin/dsv2dsv.js",
        "dsv2dsv": "bin/dsv2dsv.js",
        "dsv2json": "bin/dsv2json.js",
        "json2csv": "bin/json2dsv.js",
        "json2dsv": "bin/json2dsv.js",
        "json2tsv": "bin/json2dsv.js",
        "tsv2csv": "bin/dsv2dsv.js",
        "tsv2json": "bin/dsv2json.js"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-dsv/node_modules/commander": {
      "version": "7.2.0",
      "resolved": "https://registry.npmjs.org/commander/-/commander-7.2.0.tgz",
      "integrity": "sha512-QrWXB+ZQSVPmIWIhtEO9H+gwHaMGYiF5ChvoJ+K9ZGHG/sVsa6yiesAD1GC/x46sET00Xlwo1u49RVVVzvcSkw==",
      "license": "MIT",
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/d3-ease": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-ease/-/d3-ease-3.0.1.tgz",
      "integrity": "sha512-wR/XK3D3XcLIZwpbvQwQ5fK+8Ykds1ip7A2Txe0yxncXSdq1L9skcG7blcedkOX+ZcgxGAmLX1FrRGbADwzi0w==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-fetch": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-fetch/-/d3-fetch-3.0.1.tgz",
      "integrity": "sha512-kpkQIM20n3oLVBKGg6oHrUchHM3xODkTzjMoj7aWQFq5QEM+R6E4WkzT5+tojDY7yjez8KgCBRoj4aEr99Fdqw==",
      "license": "ISC",
      "dependencies": {
        "d3-dsv": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-force": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-force/-/d3-force-3.0.0.tgz",
      "integrity": "sha512-zxV/SsA+U4yte8051P4ECydjD/S+qeYtnaIyAs9tgHCqfguma/aAQDjo85A9Z6EKhBirHRJHXIgJUlffT4wdLg==",
      "license": "ISC",
      "dependencies": {
        "d3-dispatch": "1 - 3",
        "d3-quadtree": "1 - 3",
        "d3-timer": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-format": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-format/-/d3-format-3.1.0.tgz",
      "integrity": "sha512-YyUI6AEuY/Wpt8KWLgZHsIU86atmikuoOmCfommt0LYHiQSPjvX2AcFc38PX0CBpr2RCyZhjex+NS/LPOv6YqA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-geo": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/d3-geo/-/d3-geo-3.1.1.tgz",
      "integrity": "sha512-637ln3gXKXOwhalDzinUgY83KzNWZRKbYubaG+fGVuc/dxO64RRljtCTnf5ecMyE1RIdtqpkVcq0IbtU2S8j2Q==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "2.5.0 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-hierarchy": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/d3-hierarchy/-/d3-hierarchy-3.1.2.tgz",
      "integrity": "sha512-FX/9frcub54beBdugHjDCdikxThEqjnR93Qt7PvQTOHxyiNCAlvMrHhclk3cD5VeAaq9fxmfRp+CnWw9rEMBuA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-interpolate": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-interpolate/-/d3-interpolate-3.0.1.tgz",
      "integrity": "sha512-3bYs1rOD33uo8aqJfKP3JWPAibgw8Zm2+L9vBKEHJ2Rg+viTR7o5Mmv5mZcieN+FRYaAOWX5SJATX6k1PWz72g==",
      "license": "ISC",
      "dependencies": {
        "d3-color": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-path": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-path/-/d3-path-3.1.0.tgz",
      "integrity": "sha512-p3KP5HCf/bvjBSSKuXid6Zqijx7wIfNW+J/maPs+iwR35at5JCbLUT0LzF1cnjbCHWhqzQTIN2Jpe8pRebIEFQ==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-polygon": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-polygon/-/d3-polygon-3.0.1.tgz",
      "integrity": "sha512-3vbA7vXYwfe1SYhED++fPUQlWSYTTGmFmQiany/gdbiWgU/iEyQzyymwL9SkJjFFuCS4902BSzewVGsHHmHtXg==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-quadtree": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-quadtree/-/d3-quadtree-3.0.1.tgz",
      "integrity": "sha512-04xDrxQTDTCFwP5H6hRhsRcb9xxv2RzkcsygFzmkSIOJy3PeRJP7sNk3VRIbKXcog561P9oU0/rVH6vDROAgUw==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-random": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-random/-/d3-random-3.0.1.tgz",
      "integrity": "sha512-FXMe9GfxTxqd5D6jFsQ+DJ8BJS4E/fT5mqqdjovykEB2oFbTMDVdg1MGFxfQW+FBOGoB++k8swBrgwSHT1cUXQ==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-sankey": {
      "version": "0.12.3",
      "resolved": "https://registry.npmjs.org/d3-sankey/-/d3-sankey-0.12.3.tgz",
      "integrity": "sha512-nQhsBRmM19Ax5xEIPLMY9ZmJ/cDvd1BG3UVvt5h3WRxKg5zGRbvnteTyWAbzeSvlh3tW7ZEmq4VwR5mB3tutmQ==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "d3-array": "1 - 2",
        "d3-shape": "^1.2.0"
      }
    },
    "node_modules/d3-sankey/node_modules/d3-array": {
      "version": "2.12.1",
      "resolved": "https://registry.npmjs.org/d3-array/-/d3-array-2.12.1.tgz",
      "integrity": "sha512-B0ErZK/66mHtEsR1TkPEEkwdy+WDesimkM5gpZr5Dsg54BiTA5RXtYW5qTLIAcekaS9xfZrzBLF/OAkB3Qn1YQ==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "internmap": "^1.0.0"
      }
    },
    "node_modules/d3-sankey/node_modules/d3-path": {
      "version": "1.0.9",
      "resolved": "https://registry.npmjs.org/d3-path/-/d3-path-1.0.9.tgz",
      "integrity": "sha512-VLaYcn81dtHVTjEHd8B+pbe9yHWpXKZUC87PzoFmsFrJqgFwDe/qxfp5MlfsfM1V5E/iVt0MmEbWQ7FVIXh/bg==",
      "license": "BSD-3-Clause"
    },
    "node_modules/d3-sankey/node_modules/d3-shape": {
      "version": "1.3.7",
      "resolved": "https://registry.npmjs.org/d3-shape/-/d3-shape-1.3.7.tgz",
      "integrity": "sha512-EUkvKjqPFUAZyOlhY5gzCxCeI0Aep04LwIRpsZ/mLFelJiUfnK56jo5JMDSE7yyP2kLSb6LtF+S5chMk7uqPqw==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "d3-path": "1"
      }
    },
    "node_modules/d3-sankey/node_modules/internmap": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/internmap/-/internmap-1.0.1.tgz",
      "integrity": "sha512-lDB5YccMydFBtasVtxnZ3MRBHuaoE8GKsppq+EchKL2U4nK/DmEpPHNH8MZe5HkMtpSiTSOZwfN0tzYjO/lJEw==",
      "license": "ISC"
    },
    "node_modules/d3-scale": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/d3-scale/-/d3-scale-4.0.2.tgz",
      "integrity": "sha512-GZW464g1SH7ag3Y7hXjf8RoUuAFIqklOAq3MRl4OaWabTFJY9PN/E1YklhXLh+OQ3fM9yS2nOkCoS+WLZ6kvxQ==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "2.10.0 - 3",
        "d3-format": "1 - 3",
        "d3-interpolate": "1.2.0 - 3",
        "d3-time": "2.1.1 - 3",
        "d3-time-format": "2 - 4"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-scale-chromatic": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-scale-chromatic/-/d3-scale-chromatic-3.1.0.tgz",
      "integrity": "sha512-A3s5PWiZ9YCXFye1o246KoscMWqf8BsD9eRiJ3He7C9OBaxKhAd5TFCdEx/7VbKtxxTsu//1mMJFrEt572cEyQ==",
      "license": "ISC",
      "dependencies": {
        "d3-color": "1 - 3",
        "d3-interpolate": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-selection": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-selection/-/d3-selection-3.0.0.tgz",
      "integrity": "sha512-fmTRWbNMmsmWq6xJV8D19U/gw/bwrHfNXxrIN+HfZgnzqTHp9jOmKMhsTUjXOJnZOdZY9Q28y4yebKzqDKlxlQ==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-shape": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/d3-shape/-/d3-shape-3.2.0.tgz",
      "integrity": "sha512-SaLBuwGm3MOViRq2ABk3eLoxwZELpH6zhl3FbAoJ7Vm1gofKx6El1Ib5z23NUEhF9AsGl7y+dzLe5Cw2AArGTA==",
      "license": "ISC",
      "dependencies": {
        "d3-path": "^3.1.0"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-time": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-time/-/d3-time-3.1.0.tgz",
      "integrity": "sha512-VqKjzBLejbSMT4IgbmVgDjpkYrNWUYJnbCGo874u7MMKIWsILRX+OpX/gTk8MqjpT1A/c6HY2dCA77ZN0lkQ2Q==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "2 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-time-format": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/d3-time-format/-/d3-time-format-4.1.0.tgz",
      "integrity": "sha512-dJxPBlzC7NugB2PDLwo9Q8JiTR3M3e4/XANkreKSUxF8vvXKqm1Yfq4Q5dl8budlunRVlUUaDUgFt7eA8D6NLg==",
      "license": "ISC",
      "dependencies": {
        "d3-time": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-timer": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-timer/-/d3-timer-3.0.1.tgz",
      "integrity": "sha512-ndfJ/JxxMd3nw31uyKoY2naivF+r29V+Lc0svZxe1JvvIRmi8hUsrMvdOwgS1o6uBHmiz91geQ0ylPP0aj1VUA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-transition": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-transition/-/d3-transition-3.0.1.tgz",
      "integrity": "sha512-ApKvfjsSR6tg06xrL434C0WydLr7JewBB3V+/39RMHsaXTOG0zmt/OAXeng5M5LBm0ojmxJrpomQVZ1aPvBL4w==",
      "license": "ISC",
      "dependencies": {
        "d3-color": "1 - 3",
        "d3-dispatch": "1 - 3",
        "d3-ease": "1 - 3",
        "d3-interpolate": "1 - 3",
        "d3-timer": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      },
      "peerDependencies": {
        "d3-selection": "2 - 3"
      }
    },
    "node_modules/d3-zoom": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/d3-zoom/-/d3-zoom-3.0.0.tgz",
      "integrity": "sha512-b8AmV3kfQaqWAuacbPuNbL6vahnOJflOhexLzMMNLga62+/nh0JzvJ0aO/5a5MVgUFGS7Hu1P9P03o3fJkDCyw==",
      "license": "ISC",
      "dependencies": {
        "d3-dispatch": "1 - 3",
        "d3-drag": "2 - 3",
        "d3-interpolate": "1 - 3",
        "d3-selection": "2 - 3",
        "d3-transition": "2 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/dagre-d3-es": {
      "version": "7.0.13",
      "resolved": "https://registry.npmjs.org/dagre-d3-es/-/dagre-d3-es-7.0.13.tgz",
      "integrity": "sha512-efEhnxpSuwpYOKRm/L5KbqoZmNNukHa/Flty4Wp62JRvgH2ojwVgPgdYyr4twpieZnyRDdIH7PY2mopX26+j2Q==",
      "license": "MIT",
      "dependencies": {
        "d3": "^7.9.0",
        "lodash-es": "^4.17.21"
      }
    },
    "node_modules/dayjs": {
      "version": "1.11.19",
      "resolved": "https://registry.npmjs.org/dayjs/-/dayjs-1.11.19.tgz",
      "integrity": "sha512-t5EcLVS6QPBNqM2z8fakk/NKel+Xzshgt8FFKAn+qwlD1pzZWxh0nVCrvFK7ZDb6XucZeF9z8C7CBWTRIVApAw==",
      "license": "MIT"
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/decode-named-character-reference": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/decode-named-character-reference/-/decode-named-character-reference-1.2.0.tgz",
      "integrity": "sha512-c6fcElNV6ShtZXmsgNgFFV5tVX2PaV4g+MOAkb8eXHvn6sryJBrZa9r0zV6+dtTyoCKxtDy5tyQ5ZwQuidtd+Q==",
      "license": "MIT",
      "dependencies": {
        "character-entities": "^2.0.0"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/wooorm"
      }
    },
    "node_modules/delaunator": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/delaunator/-/delaunator-5.0.1.tgz",
      "integrity": "sha512-8nvh+XBe96aCESrGOqMp/84b13H9cdKbG5P2ejQCh4d4sK9RL4371qou9drQjMhvnPmhWl5hnmqbEE0fXr9Xnw==",
      "license": "ISC",
      "dependencies": {
        "robust-predicates": "^3.0.2"
      }
    },
    "node_modules/dequal": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/dequal/-/dequal-2.0.3.tgz",
      "integrity": "sha512-0je+qPKHEMohvfRTCEo3CrPG6cAzAYgmzKyxRiYSSDkS6eGJdyVJm7WaYA5ECaAD9wLB2T4EEeymA5aFVcYXCA==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/didyoumean": {
      "version": "1.2.2",
      "resolved": "https://registry.npmmirror.com/didyoumean/-/didyoumean-1.2.2.tgz",
      "integrity": "sha512-gxtyfqMg7GKyhQmb056K7M3xszy/myH8w+B4RT+QXBQsvAOdc3XymqDDPHx1BgPgsdAA5SIifona89YtRATDzw==",
      "license": "Apache-2.0"
    },
    "node_modules/diff": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/diff/-/diff-5.2.0.tgz",
      "integrity": "sha512-uIFDxqpRZGZ6ThOk84hEfqWoHx2devRFvpTZcTHur85vImfaxUbTW9Ryh4CpCuDnToOP1CEtXKIgytHBPVff5A==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.3.1"
      }
    },
    "node_modules/dlv": {
      "version": "1.1.3",
      "resolved": "https://registry.npmmirror.com/dlv/-/dlv-1.1.3.tgz",
      "integrity": "sha512-+HlytyjlPKnIG8XuRG8WvmBP8xs8P71y+SKKS6ZXWoEgLuePxtDoUEiH7WkdePWrQ5JBpE6aoVqfZfJUQkjXwA==",
      "license": "MIT"
    },
    "node_modules/dompurify": {
      "version": "3.3.0",
      "resolved": "https://registry.npmjs.org/dompurify/-/dompurify-3.3.0.tgz",
      "integrity": "sha512-r+f6MYR1gGN1eJv0TVQbhA7if/U7P87cdPl3HN5rikqaBSBxLiCb/b9O+2eG0cxz0ghyU+mU1QkbsOwERMYlWQ==",
      "license": "(MPL-2.0 OR Apache-2.0)",
      "optionalDependencies": {
        "@types/trusted-types": "^2.0.7"
      }
    },
    "node_modules/eastasianwidth": {
      "version": "0.2.0",
      "resolved": "https://registry.npmmirror.com/eastasianwidth/-/eastasianwidth-0.2.0.tgz",
      "integrity": "sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==",
      "license": "MIT"
    },
    "node_modules/echarts": {
      "version": "5.6.0",
      "resolved": "https://registry.npmjs.org/echarts/-/echarts-5.6.0.tgz",
      "integrity": "sha512-oTbVTsXfKuEhxftHqL5xprgLoc0k7uScAwtryCgWF6hPYFLRwOUHiFmHGCBKP5NPFNkDVopOieyUqYGH8Fa3kA==",
      "license": "Apache-2.0",
      "dependencies": {
        "tslib": "2.3.0",
        "zrender": "5.6.1"
      }
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.221",
      "resolved": "https://registry.npmmirror.com/electron-to-chromium/-/electron-to-chromium-1.5.221.tgz",
      "integrity": "sha512-/1hFJ39wkW01ogqSyYoA4goOXOtMRy6B+yvA1u42nnsEGtHzIzmk93aPISumVQeblj47JUHLC9coCjUxb1EvtQ==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/elkjs": {
      "version": "0.9.3",
      "resolved": "https://registry.npmjs.org/elkjs/-/elkjs-0.9.3.tgz",
      "integrity": "sha512-f/ZeWvW/BCXbhGEf1Ujp29EASo/lk1FDnETgNKwJrsVvGZhUWCZyg3xLJjAsxfOmt8KjswHmI5EwCQcPMpOYhQ==",
      "license": "EPL-2.0"
    },
    "node_modules/emoji-regex": {
      "version": "9.2.2",
      "resolved": "https://registry.npmmirror.com/emoji-regex/-/emoji-regex-9.2.2.tgz",
      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
      "license": "MIT"
    },
    "node_modules/esbuild": {
      "version": "0.21.5",
      "resolved": "https://registry.npmmirror.com/esbuild/-/esbuild-0.21.5.tgz",
      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.21.5",
        "@esbuild/android-arm": "0.21.5",
        "@esbuild/android-arm64": "0.21.5",
        "@esbuild/android-x64": "0.21.5",
        "@esbuild/darwin-arm64": "0.21.5",
        "@esbuild/darwin-x64": "0.21.5",
        "@esbuild/freebsd-arm64": "0.21.5",
        "@esbuild/freebsd-x64": "0.21.5",
        "@esbuild/linux-arm": "0.21.5",
        "@esbuild/linux-arm64": "0.21.5",
        "@esbuild/linux-ia32": "0.21.5",
        "@esbuild/linux-loong64": "0.21.5",
        "@esbuild/linux-mips64el": "0.21.5",
        "@esbuild/linux-ppc64": "0.21.5",
        "@esbuild/linux-riscv64": "0.21.5",
        "@esbuild/linux-s390x": "0.21.5",
        "@esbuild/linux-x64": "0.21.5",
        "@esbuild/netbsd-x64": "0.21.5",
        "@esbuild/openbsd-x64": "0.21.5",
        "@esbuild/sunos-x64": "0.21.5",
        "@esbuild/win32-arm64": "0.21.5",
        "@esbuild/win32-ia32": "0.21.5",
        "@esbuild/win32-x64": "0.21.5"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmmirror.com/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/escape-string-regexp": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-5.0.0.tgz",
      "integrity": "sha512-/veY75JbMK4j1yjvuUxuVsiS/hr/4iHs9FTT6cgTexxdE0Ly/glccBAkloH/DofkjRbZU3bnoj38mOmhkZ0lHw==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/execa": {
      "version": "9.6.1",
      "resolved": "https://registry.npmjs.org/execa/-/execa-9.6.1.tgz",
      "integrity": "sha512-9Be3ZoN4LmYR90tUoVu2te2BsbzHfhJyfEiAVfz7N5/zv+jduIfLrV2xdQXOHbaD6KgpGdO9PRPM1Y4Q9QkPkA==",
      "license": "MIT",
      "dependencies": {
        "@sindresorhus/merge-streams": "^4.0.0",
        "cross-spawn": "^7.0.6",
        "figures": "^6.1.0",
        "get-stream": "^9.0.0",
        "human-signals": "^8.0.1",
        "is-plain-obj": "^4.1.0",
        "is-stream": "^4.0.1",
        "npm-run-path": "^6.0.0",
        "pretty-ms": "^9.2.0",
        "signal-exit": "^4.1.0",
        "strip-final-newline": "^4.0.0",
        "yoctocolors": "^2.1.1"
      },
      "engines": {
        "node": "^18.19.0 || >=20.5.0"
      },
      "funding": {
        "url": "https://github.com/sindresorhus/execa?sponsor=1"
      }
    },
    "node_modules/fast-glob": {
      "version": "3.3.3",
      "resolved": "https://registry.npmmirror.com/fast-glob/-/fast-glob-3.3.3.tgz",
      "integrity": "sha512-7MptL8U0cqcFdzIzwOTHoilX9x5BrNqye7Z/LuC7kCMRio1EMSyqRK3BEAUD7sXRq4iT4AzTVuZdhgQ2TCvYLg==",
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.stat": "^2.0.2",
        "@nodelib/fs.walk": "^1.2.3",
        "glob-parent": "^5.1.2",
        "merge2": "^1.3.0",
        "micromatch": "^4.0.8"
      },
      "engines": {
        "node": ">=8.6.0"
      }
    },
    "node_modules/fast-glob/node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmmirror.com/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/fastq": {
      "version": "1.19.1",
      "resolved": "https://registry.npmmirror.com/fastq/-/fastq-1.19.1.tgz",
      "integrity": "sha512-GwLTyxkCXjXbxqIhTsMI2Nui8huMPtnxg7krajPJAjnEG/iiOS7i+zCtWGZR9G0NBKbXKh6X9m9UIsYX/N6vvQ==",
      "license": "ISC",
      "dependencies": {
        "reusify": "^1.0.4"
      }
    },
    "node_modules/figures": {
      "version": "6.1.0",
      "resolved": "https://registry.npmjs.org/figures/-/figures-6.1.0.tgz",
      "integrity": "sha512-d+l3qxjSesT4V7v2fh+QnmFnUWv9lSpjarhShNTgBOfA0ttejbQUAlHLitbjkoRiDulW0OPoQPYIGhIC8ohejg==",
      "license": "MIT",
      "dependencies": {
        "is-unicode-supported": "^2.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fill-range": {
      "version": "7.1.1",
      "resolved": "https://registry.npmmirror.com/fill-range/-/fill-range-7.1.1.tgz",
      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
      "license": "MIT",
      "dependencies": {
        "to-regex-range": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/fkill": {
      "version": "9.0.0",
      "resolved": "https://registry.npmjs.org/fkill/-/fkill-9.0.0.tgz",
      "integrity": "sha512-MdYSsbdCaIRjzo5edthZtWmEZVMfr1qrtYZUHIdO3swCE+CoZA8S5l0s4jDsYlTa9ZiXv0pTgpzE7s4N8NeUOA==",
      "license": "MIT",
      "dependencies": {
        "aggregate-error": "^5.0.0",
        "execa": "^8.0.1",
        "pid-port": "^1.0.0",
        "process-exists": "^5.0.0",
        "ps-list": "^8.1.1",
        "taskkill": "^5.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fkill/node_modules/execa": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/execa/-/execa-8.0.1.tgz",
      "integrity": "sha512-VyhnebXciFV2DESc+p6B+y0LjSm0krU4OgJN44qFAhBY0TJ+1V61tYD2+wHusZ6F9n5K+vl8k0sTy7PEfV4qpg==",
      "license": "MIT",
      "dependencies": {
        "cross-spawn": "^7.0.3",
        "get-stream": "^8.0.1",
        "human-signals": "^5.0.0",
        "is-stream": "^3.0.0",
        "merge-stream": "^2.0.0",
        "npm-run-path": "^5.1.0",
        "onetime": "^6.0.0",
        "signal-exit": "^4.1.0",
        "strip-final-newline": "^3.0.0"
      },
      "engines": {
        "node": ">=16.17"
      },
      "funding": {
        "url": "https://github.com/sindresorhus/execa?sponsor=1"
      }
    },
    "node_modules/fkill/node_modules/get-stream": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-8.0.1.tgz",
      "integrity": "sha512-VaUJspBffn/LMCJVoMvSAdmscJyS1auj5Zulnn5UoYcY531UWmdwhRWkcGKnGU93m5HSXP9LP2usOryrBtQowA==",
      "license": "MIT",
      "engines": {
        "node": ">=16"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fkill/node_modules/human-signals": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/human-signals/-/human-signals-5.0.0.tgz",
      "integrity": "sha512-AXcZb6vzzrFAUE61HnN4mpLqd/cSIwNQjtNWR0euPm6y0iqx3G4gOXaIDdtdDwZmhwe82LA6+zinmW4UBWVePQ==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=16.17.0"
      }
    },
    "node_modules/fkill/node_modules/is-stream": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-3.0.0.tgz",
      "integrity": "sha512-LnQR4bZ9IADDRSkvpqMGvt/tEJWclzklNgSw48V5EAaAeDd6qGvN8ei6k5p0tvxSR171VmGyHuTiAOfxAbr8kA==",
      "license": "MIT",
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fkill/node_modules/npm-run-path": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-5.3.0.tgz",
      "integrity": "sha512-ppwTtiJZq0O/ai0z7yfudtBpWIoxM8yE6nHi1X47eFR2EWORqfbu6CnPlNsjeN683eT0qG6H/Pyf9fCcvjnnnQ==",
      "license": "MIT",
      "dependencies": {
        "path-key": "^4.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fkill/node_modules/path-key": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-4.0.0.tgz",
      "integrity": "sha512-haREypq7xkM7ErfgIyA0z+Bj4AGKlMSdlQE2jvJo6huWD1EdkKYV+G/T4nq0YEF2vgTT8kqMFKo1uHn950r4SQ==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/fkill/node_modules/strip-final-newline": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/strip-final-newline/-/strip-final-newline-3.0.0.tgz",
      "integrity": "sha512-dOESqjYr96iWYylGObzd39EuNTa5VJxyvVAEm5Jnh7KGo75V43Hk1odPQkNDyXNmUR6k+gEiDVXnjB8HJ3crXw==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/foreground-child": {
      "version": "3.3.1",
      "resolved": "https://registry.npmmirror.com/foreground-child/-/foreground-child-3.3.1.tgz",
      "integrity": "sha512-gIXjKqtFuWEgzFRJA9WCQeSJLZDjgJUOMCMzxtvFq/37KojM1BFGufqsCy0r4qSQmYLsZYMeyRqzIWOMup03sw==",
      "license": "ISC",
      "dependencies": {
        "cross-spawn": "^7.0.6",
        "signal-exit": "^4.0.1"
      },
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/fraction.js": {
      "version": "4.3.7",
      "resolved": "https://registry.npmmirror.com/fraction.js/-/fraction.js-4.3.7.tgz",
      "integrity": "sha512-ZsDfxO51wGAXREY55a7la9LScWpwv9RxIrYABrlvOFBlH/ShPnrtsXeuUIfXKKOVicNxQ+o8JTbJvjS4M89yew==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "*"
      },
      "funding": {
        "type": "patreon",
        "url": "https://github.com/sponsors/rawify"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmmirror.com/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmmirror.com/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/get-stream": {
      "version": "9.0.1",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-9.0.1.tgz",
      "integrity": "sha512-kVCxPF3vQM/N0B1PmoqVUqgHP+EeVjmZSQn+1oCRPxd2P21P2F19lIgbR3HBosbB1PUhOAoctJnfEn2GbN2eZA==",
      "license": "MIT",
      "dependencies": {
        "@sec-ant/readable-stream": "^0.4.1",
        "is-stream": "^4.0.1"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/glob": {
      "version": "10.5.0",
      "resolved": "https://registry.npmjs.org/glob/-/glob-10.5.0.tgz",
      "integrity": "sha512-DfXN8DfhJ7NH3Oe7cFmu3NCu1wKbkReJ8TorzSAFbSKrlNaQSKfIzqYqVY8zlbs2NLBbWpRiU52GX2PbaBVNkg==",
      "license": "ISC",
      "dependencies": {
        "foreground-child": "^3.1.0",
        "jackspeak": "^3.1.2",
        "minimatch": "^9.0.4",
        "minipass": "^7.1.2",
        "package-json-from-dist": "^1.0.0",
        "path-scurry": "^1.11.1"
      },
      "bin": {
        "glob": "dist/esm/bin.mjs"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/glob-parent": {
      "version": "6.0.2",
      "resolved": "https://registry.npmmirror.com/glob-parent/-/glob-parent-6.0.2.tgz",
      "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.3"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmmirror.com/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/highlight.js": {
      "version": "11.11.1",
      "resolved": "https://registry.npmjs.org/highlight.js/-/highlight.js-11.11.1.tgz",
      "integrity": "sha512-Xwwo44whKBVCYoliBQwaPvtd/2tYFkRQtXDWj1nackaV2JPXx3L0+Jvd8/qCJ2p+ML0/XVkJ2q+Mr+UVdpJK5w==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=12.0.0"
      }
    },
    "node_modules/hono": {
      "version": "4.11.0",
      "resolved": "https://registry.npmjs.org/hono/-/hono-4.11.0.tgz",
      "integrity": "sha512-Jg8uZzN2ul8/qlyid5FO8O624F3AK0wKtkgoeEON1qBum1rM1itYBxoMKu/1SPJC7F1+xlIZsJMmc4HHhJ1AWg==",
      "license": "MIT",
      "engines": {
        "node": ">=16.9.0"
      }
    },
    "node_modules/human-signals": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/human-signals/-/human-signals-8.0.1.tgz",
      "integrity": "sha512-eKCa6bwnJhvxj14kZk5NCPc6Hb6BdsU9DZcOnmQKSnO1VKrfV0zCvtttPZUsBvjmNDn8rpcJfpwSYnHBjc95MQ==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=18.18.0"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.6.3",
      "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.6.3.tgz",
      "integrity": "sha512-4fCk79wshMdzMp2rH06qWrJE4iolqLhCUH+OiuIgU++RB0+94NlDL81atO7GX55uUKueo0txHNtvEyI6D7WdMw==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/indent-string": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/indent-string/-/indent-string-5.0.0.tgz",
      "integrity": "sha512-m6FAo/spmsW2Ab2fU35JTYwtOKa2yAwXSwgjSv1TJzh4Mh7mC3lzAOVLBprb72XsTrgkEIsl7YrFNAiDiRhIGg==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/internmap": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/internmap/-/internmap-2.0.3.tgz",
      "integrity": "sha512-5Hh7Y1wQbvY5ooGgPbDaL5iYLAPzMTUrjMulskHLH6wnv/A+1q5rgEaiuqEjB+oxGXIVZs1FF+R/KPN3ZSQYYg==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/is-binary-path": {
      "version": "2.1.0",
      "resolved": "https://registry.npmmirror.com/is-binary-path/-/is-binary-path-2.1.0.tgz",
      "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
      "license": "MIT",
      "dependencies": {
        "binary-extensions": "^2.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-core-module": {
      "version": "2.16.1",
      "resolved": "https://registry.npmmirror.com/is-core-module/-/is-core-module-2.16.1.tgz",
      "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
      "license": "MIT",
      "dependencies": {
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmmirror.com/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-fullwidth-code-point": {
      "version": "3.0.0",
      "resolved": "https://registry.npmmirror.com/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmmirror.com/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "license": "MIT",
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-number": {
      "version": "7.0.0",
      "resolved": "https://registry.npmmirror.com/is-number/-/is-number-7.0.0.tgz",
      "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
      "license": "MIT",
      "engines": {
        "node": ">=0.12.0"
      }
    },
    "node_modules/is-plain-obj": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/is-plain-obj/-/is-plain-obj-4.1.0.tgz",
      "integrity": "sha512-+Pgi+vMuUNkJyExiMBt5IlFoMyKnr5zhJ4Uspz58WOhBF5QoIZkFyNHIbBAtHwzVAgk5RtndVNsDRN61/mmDqg==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/is-stream": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-4.0.1.tgz",
      "integrity": "sha512-Dnz92NInDqYckGEUJv689RbRiTSEHCQ7wOVeALbkOz999YpqT46yMRIGtSNl2iCL1waAZSx40+h59NV/EwzV/A==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/is-unicode-supported": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/is-unicode-supported/-/is-unicode-supported-2.1.0.tgz",
      "integrity": "sha512-mE00Gnza5EEB3Ds0HfMyllZzbBrmLOX3vfWoj9A9PEnTfratQ/BcaJOuMhnkhjXvb2+FkY3VuHqtAGpTPmglFQ==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/isexe": {
      "version": "2.0.0",
      "resolved": "https://registry.npmmirror.com/isexe/-/isexe-2.0.0.tgz",
      "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
      "license": "ISC"
    },
    "node_modules/jackspeak": {
      "version": "3.4.3",
      "resolved": "https://registry.npmmirror.com/jackspeak/-/jackspeak-3.4.3.tgz",
      "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
      "license": "BlueOak-1.0.0",
      "dependencies": {
        "@isaacs/cliui": "^8.0.2"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      },
      "optionalDependencies": {
        "@pkgjs/parseargs": "^0.11.0"
      }
    },
    "node_modules/jiti": {
      "version": "1.21.7",
      "resolved": "https://registry.npmmirror.com/jiti/-/jiti-1.21.7.tgz",
      "integrity": "sha512-/imKNG4EbWNrVjoNC/1H5/9GFy+tqjGBHCaSsN+P2RnPqjsLmv6UD3Ej+Kj8nBWaRAwyk7kK5ZUc+OEatnTR3A==",
      "license": "MIT",
      "bin": {
        "jiti": "bin/jiti.js"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
      "license": "MIT"
    },
    "node_modules/jsesc": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
      "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/katex": {
      "version": "0.16.25",
      "resolved": "https://registry.npmjs.org/katex/-/katex-0.16.25.tgz",
      "integrity": "sha512-woHRUZ/iF23GBP1dkDQMh1QBad9dmr8/PAwNA54VrSOVYgI12MAcE14TqnDdQOdzyEonGzMepYnqBMYdsoAr8Q==",
      "funding": [
        "https://opencollective.com/katex",
        "https://github.com/sponsors/katex"
      ],
      "license": "MIT",
      "dependencies": {
        "commander": "^8.3.0"
      },
      "bin": {
        "katex": "cli.js"
      }
    },
    "node_modules/katex/node_modules/commander": {
      "version": "8.3.0",
      "resolved": "https://registry.npmjs.org/commander/-/commander-8.3.0.tgz",
      "integrity": "sha512-OkTL9umf+He2DZkUq8f8J9of7yL6RJKI24dVITBmNfZBmri9zYZQrKkuXiKhyfPSu8tUhnVBB1iKXevvnlR4Ww==",
      "license": "MIT",
      "engines": {
        "node": ">= 12"
      }
    },
    "node_modules/khroma": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/khroma/-/khroma-2.1.0.tgz",
      "integrity": "sha512-Ls993zuzfayK269Svk9hzpeGUKob/sIgZzyHYdjQoAdQetRKpOLj+k/QQQ/6Qi0Yz65mlROrfd+Ev+1+7dz9Kw=="
    },
    "node_modules/kleur": {
      "version": "4.1.5",
      "resolved": "https://registry.npmjs.org/kleur/-/kleur-4.1.5.tgz",
      "integrity": "sha512-o+NO+8WrRiQEE4/7nwRJhN1HWpVmJm511pBHUxPLtp0BUISzlBplORYSmTclCnJvQq2tKu/sgl3xVpkc7ZWuQQ==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/layout-base": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/layout-base/-/layout-base-1.0.2.tgz",
      "integrity": "sha512-8h2oVEZNktL4BH2JCOI90iD1yXwL6iNW7KcCKT2QZgQJR2vbqDsldCTPRU9NifTCqHZci57XvQQ15YTu+sTYPg==",
      "license": "MIT"
    },
    "node_modules/lilconfig": {
      "version": "3.1.3",
      "resolved": "https://registry.npmmirror.com/lilconfig/-/lilconfig-3.1.3.tgz",
      "integrity": "sha512-/vlFKAoH5Cgt3Ie+JLhRbwOsCQePABiU3tJ1egGvyQ+33R/vcwM2Zl2QR/LzjsBeItPt3oSVXapn+m4nQDvpzw==",
      "license": "MIT",
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/antonk52"
      }
    },
    "node_modules/lines-and-columns": {
      "version": "1.2.4",
      "resolved": "https://registry.npmmirror.com/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
      "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
      "license": "MIT"
    },
    "node_modules/lodash-es": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash-es/-/lodash-es-4.17.21.tgz",
      "integrity": "sha512-mKnC+QJ9pWVzv+C4/U3rRsHapFfHvQFoFB92e52xeyGMcX6/OlIl78je1u8vePzYZSkkogMPJ2yjxxsb89cxyw==",
      "license": "MIT"
    },
    "node_modules/loose-envify": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
      "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
      "license": "MIT",
      "dependencies": {
        "js-tokens": "^3.0.0 || ^4.0.0"
      },
      "bin": {
        "loose-envify": "cli.js"
      }
    },
    "node_modules/lru-cache": {
      "version": "10.4.3",
      "resolved": "https://registry.npmmirror.com/lru-cache/-/lru-cache-10.4.3.tgz",
      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
      "license": "ISC"
    },
    "node_modules/lucide-react": {
      "version": "0.544.0",
      "resolved": "https://registry.npmjs.org/lucide-react/-/lucide-react-0.544.0.tgz",
      "integrity": "sha512-t5tS44bqd825zAW45UQxpG2CvcC4urOwn2TrwSH8u+MjeE+1NnWl6QqeQ/6NdjMqdOygyiT9p3Ev0p1NJykxjw==",
      "license": "ISC",
      "peerDependencies": {
        "react": "^16.5.1 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/marked": {
      "version": "16.3.0",
      "resolved": "https://registry.npmmirror.com/marked/-/marked-16.3.0.tgz",
      "integrity": "sha512-K3UxuKu6l6bmA5FUwYho8CfJBlsUWAooKtdGgMcERSpF7gcBUrCGsLH7wDaaNOzwq18JzSUDyoEb/YsrqMac3w==",
      "license": "MIT",
      "bin": {
        "marked": "bin/marked.js"
      },
      "engines": {
        "node": ">= 20"
      }
    },
    "node_modules/mdast-util-from-markdown": {
      "version": "1.3.1",
      "resolved": "https://registry.npmjs.org/mdast-util-from-markdown/-/mdast-util-from-markdown-1.3.1.tgz",
      "integrity": "sha512-4xTO/M8c82qBcnQc1tgpNtubGUW/Y1tBQ1B0i5CtSoelOLKFYlElIr3bvgREYYO5iRqbMY1YuqZng0GVOI8Qww==",
      "license": "MIT",
      "dependencies": {
        "@types/mdast": "^3.0.0",
        "@types/unist": "^2.0.0",
        "decode-named-character-reference": "^1.0.0",
        "mdast-util-to-string": "^3.1.0",
        "micromark": "^3.0.0",
        "micromark-util-decode-numeric-character-reference": "^1.0.0",
        "micromark-util-decode-string": "^1.0.0",
        "micromark-util-normalize-identifier": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0",
        "unist-util-stringify-position": "^3.0.0",
        "uvu": "^0.5.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/unified"
      }
    },
    "node_modules/mdast-util-to-string": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/mdast-util-to-string/-/mdast-util-to-string-3.2.0.tgz",
      "integrity": "sha512-V4Zn/ncyN1QNSqSBxTrMOLpjr+IKdHl2v3KVLoWmDPscP4r9GcCi71gjgvUV1SFSKh92AjAG4peFuBl2/YgCJg==",
      "license": "MIT",
      "dependencies": {
        "@types/mdast": "^3.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/unified"
      }
    },
    "node_modules/merge-stream": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/merge-stream/-/merge-stream-2.0.0.tgz",
      "integrity": "sha512-abv/qOcuPfk3URPfDzmZU1LKmuw8kT+0nIHvKrKgFrwifol/doWcdA4ZqsWQ8ENrFKkd67Mfpo/LovbIUsbt3w==",
      "license": "MIT"
    },
    "node_modules/merge2": {
      "version": "1.4.1",
      "resolved": "https://registry.npmmirror.com/merge2/-/merge2-1.4.1.tgz",
      "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
      "license": "MIT",
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/mermaid": {
      "version": "10.9.5",
      "resolved": "https://registry.npmjs.org/mermaid/-/mermaid-10.9.5.tgz",
      "integrity": "sha512-eRlKEjzak4z1rcXeCd1OAlyawhrptClQDo8OuI8n6bSVqJ9oMfd5Lrf3Q+TdJHewi/9AIOc3UmEo8Fz+kNzzuQ==",
      "license": "MIT",
      "dependencies": {
        "@braintree/sanitize-url": "^6.0.1",
        "@types/d3-scale": "^4.0.3",
        "@types/d3-scale-chromatic": "^3.0.0",
        "cytoscape": "^3.28.1",
        "cytoscape-cose-bilkent": "^4.1.0",
        "d3": "^7.4.0",
        "d3-sankey": "^0.12.3",
        "dagre-d3-es": "7.0.13",
        "dayjs": "^1.11.7",
        "dompurify": "^3.2.4",
        "elkjs": "^0.9.0",
        "katex": "^0.16.9",
        "khroma": "^2.0.0",
        "lodash-es": "^4.17.21",
        "mdast-util-from-markdown": "^1.3.0",
        "non-layered-tidy-tree-layout": "^2.0.2",
        "stylis": "^4.1.3",
        "ts-dedent": "^2.2.0",
        "uuid": "^9.0.0",
        "web-worker": "^1.2.0"
      }
    },
    "node_modules/micromark": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/micromark/-/micromark-3.2.0.tgz",
      "integrity": "sha512-uD66tJj54JLYq0De10AhWycZWGQNUvDI55xPgk2sQM5kn1JYlhbCMTtEeT27+vAhW2FBQxLlOmS3pmA7/2z4aA==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "@types/debug": "^4.0.0",
        "debug": "^4.0.0",
        "decode-named-character-reference": "^1.0.0",
        "micromark-core-commonmark": "^1.0.1",
        "micromark-factory-space": "^1.0.0",
        "micromark-util-character": "^1.0.0",
        "micromark-util-chunked": "^1.0.0",
        "micromark-util-combine-extensions": "^1.0.0",
        "micromark-util-decode-numeric-character-reference": "^1.0.0",
        "micromark-util-encode": "^1.0.0",
        "micromark-util-normalize-identifier": "^1.0.0",
        "micromark-util-resolve-all": "^1.0.0",
        "micromark-util-sanitize-uri": "^1.0.0",
        "micromark-util-subtokenize": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.1",
        "uvu": "^0.5.0"
      }
    },
    "node_modules/micromark-core-commonmark": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-core-commonmark/-/micromark-core-commonmark-1.1.0.tgz",
      "integrity": "sha512-BgHO1aRbolh2hcrzL2d1La37V0Aoz73ymF8rAcKnohLy93titmv62E0gP8Hrx9PKcKrqCZ1BbLGbP3bEhoXYlw==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "decode-named-character-reference": "^1.0.0",
        "micromark-factory-destination": "^1.0.0",
        "micromark-factory-label": "^1.0.0",
        "micromark-factory-space": "^1.0.0",
        "micromark-factory-title": "^1.0.0",
        "micromark-factory-whitespace": "^1.0.0",
        "micromark-util-character": "^1.0.0",
        "micromark-util-chunked": "^1.0.0",
        "micromark-util-classify-character": "^1.0.0",
        "micromark-util-html-tag-name": "^1.0.0",
        "micromark-util-normalize-identifier": "^1.0.0",
        "micromark-util-resolve-all": "^1.0.0",
        "micromark-util-subtokenize": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.1",
        "uvu": "^0.5.0"
      }
    },
    "node_modules/micromark-factory-destination": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-factory-destination/-/micromark-factory-destination-1.1.0.tgz",
      "integrity": "sha512-XaNDROBgx9SgSChd69pjiGKbV+nfHGDPVYFs5dOoDd7ZnMAE+Cuu91BCpsY8RT2NP9vo/B8pds2VQNCLiu0zhg==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-character": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-factory-label": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-factory-label/-/micromark-factory-label-1.1.0.tgz",
      "integrity": "sha512-OLtyez4vZo/1NjxGhcpDSbHQ+m0IIGnT8BoPamh+7jVlzLJBH98zzuCoUeMxvM6WsNeh8wx8cKvqLiPHEACn0w==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-character": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0",
        "uvu": "^0.5.0"
      }
    },
    "node_modules/micromark-factory-space": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-factory-space/-/micromark-factory-space-1.1.0.tgz",
      "integrity": "sha512-cRzEj7c0OL4Mw2v6nwzttyOZe8XY/Z8G0rzmWQZTBi/jjwyw/U4uqKtUORXQrR5bAZZnbTI/feRV/R7hc4jQYQ==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-character": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-factory-title": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-factory-title/-/micromark-factory-title-1.1.0.tgz",
      "integrity": "sha512-J7n9R3vMmgjDOCY8NPw55jiyaQnH5kBdV2/UXCtZIpnHH3P6nHUKaH7XXEYuWwx/xUJcawa8plLBEjMPU24HzQ==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-factory-space": "^1.0.0",
        "micromark-util-character": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-factory-whitespace": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-factory-whitespace/-/micromark-factory-whitespace-1.1.0.tgz",
      "integrity": "sha512-v2WlmiymVSp5oMg+1Q0N1Lxmt6pMhIHD457whWM7/GUlEks1hI9xj5w3zbc4uuMKXGisksZk8DzP2UyGbGqNsQ==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-factory-space": "^1.0.0",
        "micromark-util-character": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-util-character": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/micromark-util-character/-/micromark-util-character-1.2.0.tgz",
      "integrity": "sha512-lXraTwcX3yH/vMDaFWCQJP1uIszLVebzUa3ZHdrgxr7KEU/9mL4mVgCpGbyhvNLNlauROiNUq7WN5u7ndbY6xg==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-util-chunked": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-chunked/-/micromark-util-chunked-1.1.0.tgz",
      "integrity": "sha512-Ye01HXpkZPNcV6FiyoW2fGZDUw4Yc7vT0E9Sad83+bEDiCJ1uXu0S3mr8WLpsz3HaG3x2q0HM6CTuPdcZcluFQ==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-symbol": "^1.0.0"
      }
    },
    "node_modules/micromark-util-classify-character": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-classify-character/-/micromark-util-classify-character-1.1.0.tgz",
      "integrity": "sha512-SL0wLxtKSnklKSUplok1WQFoGhUdWYKggKUiqhX+Swala+BtptGCu5iPRc+xvzJ4PXE/hwM3FNXsfEVgoZsWbw==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-character": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-util-combine-extensions": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-combine-extensions/-/micromark-util-combine-extensions-1.1.0.tgz",
      "integrity": "sha512-Q20sp4mfNf9yEqDL50WwuWZHUrCO4fEyeDCnMGmG5Pr0Cz15Uo7KBs6jq+dq0EgX4DPwwrh9m0X+zPV1ypFvUA==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-chunked": "^1.0.0",
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-util-decode-numeric-character-reference": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-decode-numeric-character-reference/-/micromark-util-decode-numeric-character-reference-1.1.0.tgz",
      "integrity": "sha512-m9V0ExGv0jB1OT21mrWcuf4QhP46pH1KkfWy9ZEezqHKAxkj4mPCy3nIH1rkbdMlChLHX531eOrymlwyZIf2iw==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-symbol": "^1.0.0"
      }
    },
    "node_modules/micromark-util-decode-string": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-decode-string/-/micromark-util-decode-string-1.1.0.tgz",
      "integrity": "sha512-YphLGCK8gM1tG1bd54azwyrQRjCFcmgj2S2GoJDNnh4vYtnL38JS8M4gpxzOPNyHdNEpheyWXCTnnTDY3N+NVQ==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "decode-named-character-reference": "^1.0.0",
        "micromark-util-character": "^1.0.0",
        "micromark-util-decode-numeric-character-reference": "^1.0.0",
        "micromark-util-symbol": "^1.0.0"
      }
    },
    "node_modules/micromark-util-encode": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-encode/-/micromark-util-encode-1.1.0.tgz",
      "integrity": "sha512-EuEzTWSTAj9PA5GOAs992GzNh2dGQO52UvAbtSOMvXTxv3Criqb6IOzJUBCmEqrrXSblJIJBbFFv6zPxpreiJw==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT"
    },
    "node_modules/micromark-util-html-tag-name": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/micromark-util-html-tag-name/-/micromark-util-html-tag-name-1.2.0.tgz",
      "integrity": "sha512-VTQzcuQgFUD7yYztuQFKXT49KghjtETQ+Wv/zUjGSGBioZnkA4P1XXZPT1FHeJA6RwRXSF47yvJ1tsJdoxwO+Q==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT"
    },
    "node_modules/micromark-util-normalize-identifier": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-normalize-identifier/-/micromark-util-normalize-identifier-1.1.0.tgz",
      "integrity": "sha512-N+w5vhqrBihhjdpM8+5Xsxy71QWqGn7HYNUvch71iV2PM7+E3uWGox1Qp90loa1ephtCxG2ftRV/Conitc6P2Q==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-symbol": "^1.0.0"
      }
    },
    "node_modules/micromark-util-resolve-all": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-resolve-all/-/micromark-util-resolve-all-1.1.0.tgz",
      "integrity": "sha512-b/G6BTMSg+bX+xVCshPTPyAu2tmA0E4X98NSR7eIbeC6ycCqCeE7wjfDIgzEbkzdEVJXRtOG4FbEm/uGbCRouA==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-types": "^1.0.0"
      }
    },
    "node_modules/micromark-util-sanitize-uri": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/micromark-util-sanitize-uri/-/micromark-util-sanitize-uri-1.2.0.tgz",
      "integrity": "sha512-QO4GXv0XZfWey4pYFndLUKEAktKkG5kZTdUNaTAkzbuJxn2tNBOr+QtxR2XpWaMhbImT2dPzyLrPXLlPhph34A==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-character": "^1.0.0",
        "micromark-util-encode": "^1.0.0",
        "micromark-util-symbol": "^1.0.0"
      }
    },
    "node_modules/micromark-util-subtokenize": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-subtokenize/-/micromark-util-subtokenize-1.1.0.tgz",
      "integrity": "sha512-kUQHyzRoxvZO2PuLzMt2P/dwVsTiivCK8icYTeR+3WgbuPqfHgPPy7nFKbeqRivBvn/3N3GBiNC+JRTMSxEC7A==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "micromark-util-chunked": "^1.0.0",
        "micromark-util-symbol": "^1.0.0",
        "micromark-util-types": "^1.0.0",
        "uvu": "^0.5.0"
      }
    },
    "node_modules/micromark-util-symbol": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-symbol/-/micromark-util-symbol-1.1.0.tgz",
      "integrity": "sha512-uEjpEYY6KMs1g7QfJ2eX1SQEV+ZT4rUD3UcF6l57acZvLNK7PBZL+ty82Z1qhK1/yXIY4bdx04FKMgR0g4IAag==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT"
    },
    "node_modules/micromark-util-types": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/micromark-util-types/-/micromark-util-types-1.1.0.tgz",
      "integrity": "sha512-ukRBgie8TIAcacscVHSiddHjO4k/q3pnedmzMQ4iwDcK0FtFCohKOlFbaOL/mPgfnPsL3C1ZyxJa4sbWrBl3jg==",
      "funding": [
        {
          "type": "GitHub Sponsors",
          "url": "https://github.com/sponsors/unifiedjs"
        },
        {
          "type": "OpenCollective",
          "url": "https://opencollective.com/unified"
        }
      ],
      "license": "MIT"
    },
    "node_modules/micromatch": {
      "version": "4.0.8",
      "resolved": "https://registry.npmmirror.com/micromatch/-/micromatch-4.0.8.tgz",
      "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
      "license": "MIT",
      "dependencies": {
        "braces": "^3.0.3",
        "picomatch": "^2.3.1"
      },
      "engines": {
        "node": ">=8.6"
      }
    },
    "node_modules/mimic-fn": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/mimic-fn/-/mimic-fn-4.0.0.tgz",
      "integrity": "sha512-vqiC06CuhBTUdZH+RYl8sFrL096vA45Ok5ISO6sE/Mr1jRbGH4Csnhi8f3wKVl7x8mO4Au7Ir9D3Oyv1VYMFJw==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/minimatch": {
      "version": "9.0.5",
      "resolved": "https://registry.npmmirror.com/minimatch/-/minimatch-9.0.5.tgz",
      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
      "license": "ISC",
      "dependencies": {
        "brace-expansion": "^2.0.1"
      },
      "engines": {
        "node": ">=16 || 14 >=14.17"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/minipass": {
      "version": "7.1.2",
      "resolved": "https://registry.npmmirror.com/minipass/-/minipass-7.1.2.tgz",
      "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
      "license": "ISC",
      "engines": {
        "node": ">=16 || 14 >=14.17"
      }
    },
    "node_modules/mri": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/mri/-/mri-1.2.0.tgz",
      "integrity": "sha512-tzzskb3bG8LvYGFF/mDTpq3jpI6Q9wc3LEmBaghu+DdCssd1FakN7Bc0hVNmEyGq1bq3RgfkCb3cmQLpNPOroA==",
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/mz": {
      "version": "2.7.0",
      "resolved": "https://registry.npmmirror.com/mz/-/mz-2.7.0.tgz",
      "integrity": "sha512-z81GNO7nnYMEhrGh9LeymoE4+Yr0Wn5McHIZMK5cfQCl+NDX08sCZgUc9/6MHni9IWuFLm1Z3HTCXu2z9fN62Q==",
      "license": "MIT",
      "dependencies": {
        "any-promise": "^1.0.0",
        "object-assign": "^4.0.1",
        "thenify-all": "^1.0.0"
      }
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmmirror.com/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.21",
      "resolved": "https://registry.npmmirror.com/node-releases/-/node-releases-2.0.21.tgz",
      "integrity": "sha512-5b0pgg78U3hwXkCM8Z9b2FJdPZlr9Psr9V2gQPESdGHqbntyFJKFW4r5TeWGFzafGY3hzs1JC62VEQMbl1JFkw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/non-layered-tidy-tree-layout": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/non-layered-tidy-tree-layout/-/non-layered-tidy-tree-layout-2.0.2.tgz",
      "integrity": "sha512-gkXMxRzUH+PB0ax9dUN0yYF0S25BqeAYqhgMaLUFmpXLEk7Fcu8f4emJuOAY0V8kjDICxROIKsTAKsV/v355xw==",
      "license": "MIT"
    },
    "node_modules/normalize-path": {
      "version": "3.0.0",
      "resolved": "https://registry.npmmirror.com/normalize-path/-/normalize-path-3.0.0.tgz",
      "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/normalize-range": {
      "version": "0.1.2",
      "resolved": "https://registry.npmmirror.com/normalize-range/-/normalize-range-0.1.2.tgz",
      "integrity": "sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/npm-run-path": {
      "version": "6.0.0",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-6.0.0.tgz",
      "integrity": "sha512-9qny7Z9DsQU8Ou39ERsPU4OZQlSTP47ShQzuKZ6PRXpYLtIFgl/DEBYEXKlvcEa+9tHVcK8CF81Y2V72qaZhWA==",
      "license": "MIT",
      "dependencies": {
        "path-key": "^4.0.0",
        "unicorn-magic": "^0.3.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/npm-run-path/node_modules/path-key": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-4.0.0.tgz",
      "integrity": "sha512-haREypq7xkM7ErfgIyA0z+Bj4AGKlMSdlQE2jvJo6huWD1EdkKYV+G/T4nq0YEF2vgTT8kqMFKo1uHn950r4SQ==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://registry.npmmirror.com/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-hash": {
      "version": "3.0.0",
      "resolved": "https://registry.npmmirror.com/object-hash/-/object-hash-3.0.0.tgz",
      "integrity": "sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==",
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/onetime": {
      "version": "6.0.0",
      "resolved": "https://registry.npmjs.org/onetime/-/onetime-6.0.0.tgz",
      "integrity": "sha512-1FlR+gjXK7X+AsAHso35MnyN5KqGwJRi/31ft6x0M194ht7S+rWAvd7PHss9xSKMzE0asv1pyIHaJYq+BbacAQ==",
      "license": "MIT",
      "dependencies": {
        "mimic-fn": "^4.0.0"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/package-json-from-dist": {
      "version": "1.0.1",
      "resolved": "https://registry.npmmirror.com/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
      "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw==",
      "license": "BlueOak-1.0.0"
    },
    "node_modules/parse-ms": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/parse-ms/-/parse-ms-4.0.0.tgz",
      "integrity": "sha512-TXfryirbmq34y8QBwgqCVLi+8oA3oWx2eAnSn62ITyEhEYaWRlVZ2DvMM9eZbMs/RfxPu/PK/aBLyGj4IrqMHw==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/path-key": {
      "version": "3.1.1",
      "resolved": "https://registry.npmmirror.com/path-key/-/path-key-3.1.1.tgz",
      "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/path-parse": {
      "version": "1.0.7",
      "resolved": "https://registry.npmmirror.com/path-parse/-/path-parse-1.0.7.tgz",
      "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
      "license": "MIT"
    },
    "node_modules/path-scurry": {
      "version": "1.11.1",
      "resolved": "https://registry.npmmirror.com/path-scurry/-/path-scurry-1.11.1.tgz",
      "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
      "license": "BlueOak-1.0.0",
      "dependencies": {
        "lru-cache": "^10.2.0",
        "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
      },
      "engines": {
        "node": ">=16 || 14 >=14.18"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmmirror.com/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "license": "ISC"
    },
    "node_modules/picomatch": {
      "version": "2.3.1",
      "resolved": "https://registry.npmmirror.com/picomatch/-/picomatch-2.3.1.tgz",
      "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
      "license": "MIT",
      "engines": {
        "node": ">=8.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/pid-port": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/pid-port/-/pid-port-1.0.2.tgz",
      "integrity": "sha512-Khqp07zX8IJpmIg56bHrLxS3M0iSL4cq6wnMq8YE7r/hSw3Kn4QxYS6QJg8Bs22Z7CSVj7eSsxFuigYVIFWmjg==",
      "license": "MIT",
      "dependencies": {
        "execa": "^8.0.1"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pid-port/node_modules/execa": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/execa/-/execa-8.0.1.tgz",
      "integrity": "sha512-VyhnebXciFV2DESc+p6B+y0LjSm0krU4OgJN44qFAhBY0TJ+1V61tYD2+wHusZ6F9n5K+vl8k0sTy7PEfV4qpg==",
      "license": "MIT",
      "dependencies": {
        "cross-spawn": "^7.0.3",
        "get-stream": "^8.0.1",
        "human-signals": "^5.0.0",
        "is-stream": "^3.0.0",
        "merge-stream": "^2.0.0",
        "npm-run-path": "^5.1.0",
        "onetime": "^6.0.0",
        "signal-exit": "^4.1.0",
        "strip-final-newline": "^3.0.0"
      },
      "engines": {
        "node": ">=16.17"
      },
      "funding": {
        "url": "https://github.com/sindresorhus/execa?sponsor=1"
      }
    },
    "node_modules/pid-port/node_modules/get-stream": {
      "version": "8.0.1",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-8.0.1.tgz",
      "integrity": "sha512-VaUJspBffn/LMCJVoMvSAdmscJyS1auj5Zulnn5UoYcY531UWmdwhRWkcGKnGU93m5HSXP9LP2usOryrBtQowA==",
      "license": "MIT",
      "engines": {
        "node": ">=16"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pid-port/node_modules/human-signals": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/human-signals/-/human-signals-5.0.0.tgz",
      "integrity": "sha512-AXcZb6vzzrFAUE61HnN4mpLqd/cSIwNQjtNWR0euPm6y0iqx3G4gOXaIDdtdDwZmhwe82LA6+zinmW4UBWVePQ==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=16.17.0"
      }
    },
    "node_modules/pid-port/node_modules/is-stream": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-3.0.0.tgz",
      "integrity": "sha512-LnQR4bZ9IADDRSkvpqMGvt/tEJWclzklNgSw48V5EAaAeDd6qGvN8ei6k5p0tvxSR171VmGyHuTiAOfxAbr8kA==",
      "license": "MIT",
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pid-port/node_modules/npm-run-path": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-5.3.0.tgz",
      "integrity": "sha512-ppwTtiJZq0O/ai0z7yfudtBpWIoxM8yE6nHi1X47eFR2EWORqfbu6CnPlNsjeN683eT0qG6H/Pyf9fCcvjnnnQ==",
      "license": "MIT",
      "dependencies": {
        "path-key": "^4.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pid-port/node_modules/path-key": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-4.0.0.tgz",
      "integrity": "sha512-haREypq7xkM7ErfgIyA0z+Bj4AGKlMSdlQE2jvJo6huWD1EdkKYV+G/T4nq0YEF2vgTT8kqMFKo1uHn950r4SQ==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pid-port/node_modules/strip-final-newline": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/strip-final-newline/-/strip-final-newline-3.0.0.tgz",
      "integrity": "sha512-dOESqjYr96iWYylGObzd39EuNTa5VJxyvVAEm5Jnh7KGo75V43Hk1odPQkNDyXNmUR6k+gEiDVXnjB8HJ3crXw==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/pify": {
      "version": "2.3.0",
      "resolved": "https://registry.npmmirror.com/pify/-/pify-2.3.0.tgz",
      "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/pirates": {
      "version": "4.0.7",
      "resolved": "https://registry.npmmirror.com/pirates/-/pirates-4.0.7.tgz",
      "integrity": "sha512-TfySrs/5nm8fQJDcBDuUng3VOUKsd7S+zqvbOTiGXHfxX4wK31ard+hoNuvkicM/2YFzlpDgABOevKSsB4G/FA==",
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmmirror.com/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/postcss-import": {
      "version": "15.1.0",
      "resolved": "https://registry.npmmirror.com/postcss-import/-/postcss-import-15.1.0.tgz",
      "integrity": "sha512-hpr+J05B2FVYUAXHeK1YyI267J/dDDhMU6B6civm8hSY1jYJnBXxzKDKDswzJmtLHryrjhnDjqqp/49t8FALew==",
      "license": "MIT",
      "dependencies": {
        "postcss-value-parser": "^4.0.0",
        "read-cache": "^1.0.0",
        "resolve": "^1.1.7"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "postcss": "^8.0.0"
      }
    },
    "node_modules/postcss-js": {
      "version": "4.1.0",
      "resolved": "https://registry.npmmirror.com/postcss-js/-/postcss-js-4.1.0.tgz",
      "integrity": "sha512-oIAOTqgIo7q2EOwbhb8UalYePMvYoIeRY2YKntdpFQXNosSu3vLrniGgmH9OKs/qAkfoj5oB3le/7mINW1LCfw==",
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "camelcase-css": "^2.0.1"
      },
      "engines": {
        "node": "^12 || ^14 || >= 16"
      },
      "peerDependencies": {
        "postcss": "^8.4.21"
      }
    },
    "node_modules/postcss-load-config": {
      "version": "4.0.2",
      "resolved": "https://registry.npmmirror.com/postcss-load-config/-/postcss-load-config-4.0.2.tgz",
      "integrity": "sha512-bSVhyJGL00wMVoPUzAVAnbEoWyqRxkjv64tUl427SKnPrENtq6hJwUojroMz2VB+Q1edmi4IfrAPpami5VVgMQ==",
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "lilconfig": "^3.0.0",
        "yaml": "^2.3.4"
      },
      "engines": {
        "node": ">= 14"
      },
      "peerDependencies": {
        "postcss": ">=8.0.9",
        "ts-node": ">=9.0.0"
      },
      "peerDependenciesMeta": {
        "postcss": {
          "optional": true
        },
        "ts-node": {
          "optional": true
        }
      }
    },
    "node_modules/postcss-nested": {
      "version": "6.2.0",
      "resolved": "https://registry.npmmirror.com/postcss-nested/-/postcss-nested-6.2.0.tgz",
      "integrity": "sha512-HQbt28KulC5AJzG+cZtj9kvKB93CFCdLvog1WFLf1D+xmMvPGlBstkpTEZfK5+AN9hfJocyBFCNiqyS48bpgzQ==",
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "postcss-selector-parser": "^6.1.1"
      },
      "engines": {
        "node": ">=12.0"
      },
      "peerDependencies": {
        "postcss": "^8.2.14"
      }
    },
    "node_modules/postcss-selector-parser": {
      "version": "6.1.2",
      "resolved": "https://registry.npmmirror.com/postcss-selector-parser/-/postcss-selector-parser-6.1.2.tgz",
      "integrity": "sha512-Q8qQfPiZ+THO/3ZrOrO0cJJKfpYCagtMUkXbnEfmgUjwXg6z/WBeOyS9APBBPCTSiDV+s4SwQGu8yFsiMRIudg==",
      "license": "MIT",
      "dependencies": {
        "cssesc": "^3.0.0",
        "util-deprecate": "^1.0.2"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/postcss-value-parser": {
      "version": "4.2.0",
      "resolved": "https://registry.npmmirror.com/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
      "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
      "license": "MIT"
    },
    "node_modules/pretty-ms": {
      "version": "9.3.0",
      "resolved": "https://registry.npmjs.org/pretty-ms/-/pretty-ms-9.3.0.tgz",
      "integrity": "sha512-gjVS5hOP+M3wMm5nmNOucbIrqudzs9v/57bWRHQWLYklXqoXKrVfYW2W9+glfGsqtPgpiz5WwyEEB+ksXIx3gQ==",
      "license": "MIT",
      "dependencies": {
        "parse-ms": "^4.0.0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/process-exists": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/process-exists/-/process-exists-5.0.0.tgz",
      "integrity": "sha512-6QPRh5fyHD8MaXr4GYML8K/YY0Sq5dKHGIOrAKS3cYpHQdmygFCcijIu1dVoNKAZ0TWAMoeh8KDK9dF8auBkJA==",
      "license": "MIT",
      "dependencies": {
        "ps-list": "^8.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/ps-list": {
      "version": "8.1.1",
      "resolved": "https://registry.npmjs.org/ps-list/-/ps-list-8.1.1.tgz",
      "integrity": "sha512-OPS9kEJYVmiO48u/B9qneqhkMvgCxT+Tm28VCEJpheTpl8cJ0ffZRRNgS5mrQRTrX5yRTpaJ+hRDeefXYmmorQ==",
      "license": "MIT",
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/queue-microtask": {
      "version": "1.2.3",
      "resolved": "https://registry.npmmirror.com/queue-microtask/-/queue-microtask-1.2.3.tgz",
      "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/react": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
      "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-dom": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
      "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0",
        "scheduler": "^0.23.2"
      },
      "peerDependencies": {
        "react": "^18.3.1"
      }
    },
    "node_modules/react-grab": {
      "version": "0.0.88",
      "resolved": "https://registry.npmjs.org/react-grab/-/react-grab-0.0.88.tgz",
      "integrity": "sha512-5AJp+ZoN+SqQRT3D8DkqcchFLelU6j9Q+BAPxcHxjtjfnFnziTWx+Wg+5qLPNc0G42bcGsATL9qifP62dX09Hw==",
      "license": "MIT",
      "dependencies": {
        "bippy": "^0.5.25",
        "solid-js": "^1.9.10"
      },
      "bin": {
        "react-grab": "dist/cli.cjs"
      }
    },
    "node_modules/react-refresh": {
      "version": "0.17.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.17.0.tgz",
      "integrity": "sha512-z6F7K9bV85EfseRCp2bzrpyQ0Gkw1uLoCel9XBVWPg/TjRj94SkJzUTGfOa4bs7iJvBWtQG0Wq7wnI0syw3EBQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-router": {
      "version": "6.30.2",
      "resolved": "https://registry.npmjs.org/react-router/-/react-router-6.30.2.tgz",
      "integrity": "sha512-H2Bm38Zu1bm8KUE5NVWRMzuIyAV8p/JrOaBJAwVmp37AXG72+CZJlEBw6pdn9i5TBgLMhNDgijS4ZlblpHyWTA==",
      "license": "MIT",
      "dependencies": {
        "@remix-run/router": "1.23.1"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8"
      }
    },
    "node_modules/react-router-dom": {
      "version": "6.30.2",
      "resolved": "https://registry.npmjs.org/react-router-dom/-/react-router-dom-6.30.2.tgz",
      "integrity": "sha512-l2OwHn3UUnEVUqc6/1VMmR1cvZryZ3j3NzapC2eUXO1dB0sYp5mvwdjiXhpUbRb21eFow3qSxpP8Yv6oAU824Q==",
      "license": "MIT",
      "dependencies": {
        "@remix-run/router": "1.23.1",
        "react-router": "6.30.2"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8",
        "react-dom": ">=16.8"
      }
    },
    "node_modules/read-cache": {
      "version": "1.0.0",
      "resolved": "https://registry.npmmirror.com/read-cache/-/read-cache-1.0.0.tgz",
      "integrity": "sha512-Owdv/Ft7IjOgm/i0xvNDZ1LrRANRfew4b2prF3OWMQLxLfu3bS8FVhCsrSCMK4lR56Y9ya+AThoTpDCTxCmpRA==",
      "license": "MIT",
      "dependencies": {
        "pify": "^2.3.0"
      }
    },
    "node_modules/readdirp": {
      "version": "3.6.0",
      "resolved": "https://registry.npmmirror.com/readdirp/-/readdirp-3.6.0.tgz",
      "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
      "license": "MIT",
      "dependencies": {
        "picomatch": "^2.2.1"
      },
      "engines": {
        "node": ">=8.10.0"
      }
    },
    "node_modules/resolve": {
      "version": "1.22.10",
      "resolved": "https://registry.npmmirror.com/resolve/-/resolve-1.22.10.tgz",
      "integrity": "sha512-NPRy+/ncIMeDlTAsuqwKIiferiawhefFJtkNSW0qZJEqMEb+qBt/77B/jGeeek+F0uOeN05CDa6HXbbIgtVX4w==",
      "license": "MIT",
      "dependencies": {
        "is-core-module": "^2.16.0",
        "path-parse": "^1.0.7",
        "supports-preserve-symlinks-flag": "^1.0.0"
      },
      "bin": {
        "resolve": "bin/resolve"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/reusify": {
      "version": "1.1.0",
      "resolved": "https://registry.npmmirror.com/reusify/-/reusify-1.1.0.tgz",
      "integrity": "sha512-g6QUff04oZpHs0eG5p83rFLhHeV00ug/Yf9nZM6fLeUrPguBTkTQOdpAWWspMh55TZfVQDPaN3NQJfbVRAxdIw==",
      "license": "MIT",
      "engines": {
        "iojs": ">=1.0.0",
        "node": ">=0.10.0"
      }
    },
    "node_modules/robust-predicates": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/robust-predicates/-/robust-predicates-3.0.2.tgz",
      "integrity": "sha512-IXgzBWvWQwE6PrDI05OvmXUIruQTcoMDzRsOd5CDvHCVLcLHMTSYvOK5Cm46kWqlV3yAbuSpBZdJ5oP5OUoStg==",
      "license": "Unlicense"
    },
    "node_modules/rollup": {
      "version": "4.50.2",
      "resolved": "https://registry.npmmirror.com/rollup/-/rollup-4.50.2.tgz",
      "integrity": "sha512-BgLRGy7tNS9H66aIMASq1qSYbAAJV6Z6WR4QYTvj5FgF15rZ/ympT1uixHXwzbZUBDbkvqUI1KR0fH1FhMaQ9w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.50.2",
        "@rollup/rollup-android-arm64": "4.50.2",
        "@rollup/rollup-darwin-arm64": "4.50.2",
        "@rollup/rollup-darwin-x64": "4.50.2",
        "@rollup/rollup-freebsd-arm64": "4.50.2",
        "@rollup/rollup-freebsd-x64": "4.50.2",
        "@rollup/rollup-linux-arm-gnueabihf": "4.50.2",
        "@rollup/rollup-linux-arm-musleabihf": "4.50.2",
        "@rollup/rollup-linux-arm64-gnu": "4.50.2",
        "@rollup/rollup-linux-arm64-musl": "4.50.2",
        "@rollup/rollup-linux-loong64-gnu": "4.50.2",
        "@rollup/rollup-linux-ppc64-gnu": "4.50.2",
        "@rollup/rollup-linux-riscv64-gnu": "4.50.2",
        "@rollup/rollup-linux-riscv64-musl": "4.50.2",
        "@rollup/rollup-linux-s390x-gnu": "4.50.2",
        "@rollup/rollup-linux-x64-gnu": "4.50.2",
        "@rollup/rollup-linux-x64-musl": "4.50.2",
        "@rollup/rollup-openharmony-arm64": "4.50.2",
        "@rollup/rollup-win32-arm64-msvc": "4.50.2",
        "@rollup/rollup-win32-ia32-msvc": "4.50.2",
        "@rollup/rollup-win32-x64-msvc": "4.50.2",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/run-parallel": {
      "version": "1.2.0",
      "resolved": "https://registry.npmmirror.com/run-parallel/-/run-parallel-1.2.0.tgz",
      "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "queue-microtask": "^1.2.2"
      }
    },
    "node_modules/rw": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/rw/-/rw-1.3.3.tgz",
      "integrity": "sha512-PdhdWy89SiZogBLaw42zdeqtRJ//zFd2PgQavcICDUgJT5oW10QCRKbJ6bg4r0/UY2M6BWd5tkxuGFRvCkgfHQ==",
      "license": "BSD-3-Clause"
    },
    "node_modules/sade": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/sade/-/sade-1.8.1.tgz",
      "integrity": "sha512-xal3CZX1Xlo/k4ApwCFrHVACi9fBqJ7V+mwhBsuf/1IOKbBy098Fex+Wa/5QMubw09pSZ/u8EY8PWgevJsXp1A==",
      "license": "MIT",
      "dependencies": {
        "mri": "^1.1.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
      "license": "MIT"
    },
    "node_modules/scheduler": {
      "version": "0.23.2",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
      "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0"
      }
    },
    "node_modules/seroval": {
      "version": "1.3.2",
      "resolved": "https://registry.npmjs.org/seroval/-/seroval-1.3.2.tgz",
      "integrity": "sha512-RbcPH1n5cfwKrru7v7+zrZvjLurgHhGyso3HTyGtRivGWgYjbOmGuivCQaORNELjNONoK35nj28EoWul9sb1zQ==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/seroval-plugins": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/seroval-plugins/-/seroval-plugins-1.3.3.tgz",
      "integrity": "sha512-16OL3NnUBw8JG1jBLUoZJsLnQq0n5Ua6aHalhJK4fMQkz1lqR7Osz1sA30trBtd9VUDc2NgkuRCn8+/pBwqZ+w==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "seroval": "^1.0"
      }
    },
    "node_modules/shebang-command": {
      "version": "2.0.0",
      "resolved": "https://registry.npmmirror.com/shebang-command/-/shebang-command-2.0.0.tgz",
      "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
      "license": "MIT",
      "dependencies": {
        "shebang-regex": "^3.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/shebang-regex": {
      "version": "3.0.0",
      "resolved": "https://registry.npmmirror.com/shebang-regex/-/shebang-regex-3.0.0.tgz",
      "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/signal-exit": {
      "version": "4.1.0",
      "resolved": "https://registry.npmmirror.com/signal-exit/-/signal-exit-4.1.0.tgz",
      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
      "license": "ISC",
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/solid-js": {
      "version": "1.9.10",
      "resolved": "https://registry.npmjs.org/solid-js/-/solid-js-1.9.10.tgz",
      "integrity": "sha512-Coz956cos/EPDlhs6+jsdTxKuJDPT7B5SVIWgABwROyxjY7Xbr8wkzD68Et+NxnV7DLJ3nJdAC2r9InuV/4Jew==",
      "license": "MIT",
      "dependencies": {
        "csstype": "^3.1.0",
        "seroval": "~1.3.0",
        "seroval-plugins": "~1.3.0"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmmirror.com/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/string-width": {
      "version": "5.1.2",
      "resolved": "https://registry.npmmirror.com/string-width/-/string-width-5.1.2.tgz",
      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
      "license": "MIT",
      "dependencies": {
        "eastasianwidth": "^0.2.0",
        "emoji-regex": "^9.2.2",
        "strip-ansi": "^7.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/string-width-cjs": {
      "name": "string-width",
      "version": "4.2.3",
      "resolved": "https://registry.npmmirror.com/string-width/-/string-width-4.2.3.tgz",
      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
      "license": "MIT",
      "dependencies": {
        "emoji-regex": "^8.0.0",
        "is-fullwidth-code-point": "^3.0.0",
        "strip-ansi": "^6.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/string-width-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmmirror.com/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/string-width-cjs/node_modules/emoji-regex": {
      "version": "8.0.0",
      "resolved": "https://registry.npmmirror.com/emoji-regex/-/emoji-regex-8.0.0.tgz",
      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
      "license": "MIT"
    },
    "node_modules/string-width-cjs/node_modules/strip-ansi": {
      "version": "6.0.1",
      "resolved": "https://registry.npmmirror.com/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-ansi": {
      "version": "7.1.2",
      "resolved": "https://registry.npmmirror.com/strip-ansi/-/strip-ansi-7.1.2.tgz",
      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^6.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
      }
    },
    "node_modules/strip-ansi-cjs": {
      "name": "strip-ansi",
      "version": "6.0.1",
      "resolved": "https://registry.npmmirror.com/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-ansi-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmmirror.com/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-final-newline": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/strip-final-newline/-/strip-final-newline-4.0.0.tgz",
      "integrity": "sha512-aulFJcD6YK8V1G7iRB5tigAP4TsHBZZrOV8pjV++zdUwmeV8uzbY7yn6h9MswN62adStNZFuCIx4haBnRuMDaw==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/stylis": {
      "version": "4.3.6",
      "resolved": "https://registry.npmjs.org/stylis/-/stylis-4.3.6.tgz",
      "integrity": "sha512-yQ3rwFWRfwNUY7H5vpU0wfdkNSnvnJinhF9830Swlaxl03zsOjCfmX0ugac+3LtK0lYSgwL/KXc8oYL3mG4YFQ==",
      "license": "MIT"
    },
    "node_modules/sucrase": {
      "version": "3.35.0",
      "resolved": "https://registry.npmmirror.com/sucrase/-/sucrase-3.35.0.tgz",
      "integrity": "sha512-8EbVDiu9iN/nESwxeSxDKe0dunta1GOlHufmSSXxMD2z2/tMZpDMpvXQGsc+ajGo8y2uYUmixaSRUc/QPoQ0GA==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.2",
        "commander": "^4.0.0",
        "glob": "^10.3.10",
        "lines-and-columns": "^1.1.6",
        "mz": "^2.7.0",
        "pirates": "^4.0.1",
        "ts-interface-checker": "^0.1.9"
      },
      "bin": {
        "sucrase": "bin/sucrase",
        "sucrase-node": "bin/sucrase-node"
      },
      "engines": {
        "node": ">=16 || 14 >=14.17"
      }
    },
    "node_modules/supports-preserve-symlinks-flag": {
      "version": "1.0.0",
      "resolved": "https://registry.npmmirror.com/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
      "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/tailwindcss": {
      "version": "3.4.17",
      "resolved": "https://registry.npmmirror.com/tailwindcss/-/tailwindcss-3.4.17.tgz",
      "integrity": "sha512-w33E2aCvSDP0tW9RZuNXadXlkHXqFzSkQew/aIa2i/Sj8fThxwovwlXHSPXTbAHwEIhBFXAedUhP2tueAKP8Og==",
      "license": "MIT",
      "dependencies": {
        "@alloc/quick-lru": "^5.2.0",
        "arg": "^5.0.2",
        "chokidar": "^3.6.0",
        "didyoumean": "^1.2.2",
        "dlv": "^1.1.3",
        "fast-glob": "^3.3.2",
        "glob-parent": "^6.0.2",
        "is-glob": "^4.0.3",
        "jiti": "^1.21.6",
        "lilconfig": "^3.1.3",
        "micromatch": "^4.0.8",
        "normalize-path": "^3.0.0",
        "object-hash": "^3.0.0",
        "picocolors": "^1.1.1",
        "postcss": "^8.4.47",
        "postcss-import": "^15.1.0",
        "postcss-js": "^4.0.1",
        "postcss-load-config": "^4.0.2",
        "postcss-nested": "^6.2.0",
        "postcss-selector-parser": "^6.1.2",
        "resolve": "^1.22.8",
        "sucrase": "^3.35.0"
      },
      "bin": {
        "tailwind": "lib/cli.js",
        "tailwindcss": "lib/cli.js"
      },
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/taskkill": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/taskkill/-/taskkill-5.0.0.tgz",
      "integrity": "sha512-+HRtZ40Vc+6YfCDWCeAsixwxJgMbPY4HHuTgzPYH3JXvqHWUlsCfy+ylXlAKhFNcuLp4xVeWeFBUhDk+7KYUvQ==",
      "license": "MIT",
      "dependencies": {
        "execa": "^6.1.0"
      },
      "engines": {
        "node": ">=14.16"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/taskkill/node_modules/execa": {
      "version": "6.1.0",
      "resolved": "https://registry.npmjs.org/execa/-/execa-6.1.0.tgz",
      "integrity": "sha512-QVWlX2e50heYJcCPG0iWtf8r0xjEYfz/OYLGDYH+IyjWezzPNxz63qNFOu0l4YftGWuizFVZHHs8PrLU5p2IDA==",
      "license": "MIT",
      "dependencies": {
        "cross-spawn": "^7.0.3",
        "get-stream": "^6.0.1",
        "human-signals": "^3.0.1",
        "is-stream": "^3.0.0",
        "merge-stream": "^2.0.0",
        "npm-run-path": "^5.1.0",
        "onetime": "^6.0.0",
        "signal-exit": "^3.0.7",
        "strip-final-newline": "^3.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sindresorhus/execa?sponsor=1"
      }
    },
    "node_modules/taskkill/node_modules/get-stream": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-6.0.1.tgz",
      "integrity": "sha512-ts6Wi+2j3jQjqi70w5AlN8DFnkSwC+MqmxEzdEALB2qXZYV3X/b1CTfgPLGJNMeAWxdPfU8FO1ms3NUfaHCPYg==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/taskkill/node_modules/human-signals": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/human-signals/-/human-signals-3.0.1.tgz",
      "integrity": "sha512-rQLskxnM/5OCldHo+wNXbpVgDn5A17CUoKX+7Sokwaknlq7CdSnphy0W39GU8dw59XiCXmFXDg4fRuckQRKewQ==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=12.20.0"
      }
    },
    "node_modules/taskkill/node_modules/is-stream": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-3.0.0.tgz",
      "integrity": "sha512-LnQR4bZ9IADDRSkvpqMGvt/tEJWclzklNgSw48V5EAaAeDd6qGvN8ei6k5p0tvxSR171VmGyHuTiAOfxAbr8kA==",
      "license": "MIT",
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/taskkill/node_modules/npm-run-path": {
      "version": "5.3.0",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-5.3.0.tgz",
      "integrity": "sha512-ppwTtiJZq0O/ai0z7yfudtBpWIoxM8yE6nHi1X47eFR2EWORqfbu6CnPlNsjeN683eT0qG6H/Pyf9fCcvjnnnQ==",
      "license": "MIT",
      "dependencies": {
        "path-key": "^4.0.0"
      },
      "engines": {
        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/taskkill/node_modules/path-key": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-4.0.0.tgz",
      "integrity": "sha512-haREypq7xkM7ErfgIyA0z+Bj4AGKlMSdlQE2jvJo6huWD1EdkKYV+G/T4nq0YEF2vgTT8kqMFKo1uHn950r4SQ==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/taskkill/node_modules/signal-exit": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
      "license": "ISC"
    },
    "node_modules/taskkill/node_modules/strip-final-newline": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/strip-final-newline/-/strip-final-newline-3.0.0.tgz",
      "integrity": "sha512-dOESqjYr96iWYylGObzd39EuNTa5VJxyvVAEm5Jnh7KGo75V43Hk1odPQkNDyXNmUR6k+gEiDVXnjB8HJ3crXw==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/thenify": {
      "version": "3.3.1",
      "resolved": "https://registry.npmmirror.com/thenify/-/thenify-3.3.1.tgz",
      "integrity": "sha512-RVZSIV5IG10Hk3enotrhvz0T9em6cyHBLkH/YAZuKqd8hRkKhSfCGIcP2KUY0EPxndzANBmNllzWPwak+bheSw==",
      "license": "MIT",
      "dependencies": {
        "any-promise": "^1.0.0"
      }
    },
    "node_modules/thenify-all": {
      "version": "1.6.0",
      "resolved": "https://registry.npmmirror.com/thenify-all/-/thenify-all-1.6.0.tgz",
      "integrity": "sha512-RNxQH/qI8/t3thXJDwcstUO4zeqo64+Uy/+sNVRBx4Xn2OX+OZ9oP+iJnNFqplFra2ZUVeKCSa2oVWi3T4uVmA==",
      "license": "MIT",
      "dependencies": {
        "thenify": ">= 3.1.0 < 4"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/to-regex-range": {
      "version": "5.0.1",
      "resolved": "https://registry.npmmirror.com/to-regex-range/-/to-regex-range-5.0.1.tgz",
      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
      "license": "MIT",
      "dependencies": {
        "is-number": "^7.0.0"
      },
      "engines": {
        "node": ">=8.0"
      }
    },
    "node_modules/ts-dedent": {
      "version": "2.2.0",
      "resolved": "https://registry.npmjs.org/ts-dedent/-/ts-dedent-2.2.0.tgz",
      "integrity": "sha512-q5W7tVM71e2xjHZTlgfTDoPF/SmqKG5hddq9SzR49CH2hayqRKJtQ4mtRlSxKaJlR/+9rEM+mnBHf7I2/BQcpQ==",
      "license": "MIT",
      "engines": {
        "node": ">=6.10"
      }
    },
    "node_modules/ts-interface-checker": {
      "version": "0.1.13",
      "resolved": "https://registry.npmmirror.com/ts-interface-checker/-/ts-interface-checker-0.1.13.tgz",
      "integrity": "sha512-Y/arvbn+rrz3JCKl9C4kVNfTfSm2/mEp5FSz5EsZSANGPSlQrpRI5M4PKF+mJnE52jOO90PnPSc3Ur3bTQw0gA==",
      "license": "Apache-2.0"
    },
    "node_modules/tslib": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.3.0.tgz",
      "integrity": "sha512-N82ooyxVNm6h1riLCoyS9e3fuJ3AMG2zIZs2Gd1ATcSFjSA23Q0fzjjZeh0jbJvWVDZ0cJT8yaNNaaXHzueNjg==",
      "license": "0BSD"
    },
    "node_modules/typescript": {
      "version": "5.3.3",
      "resolved": "https://registry.npmmirror.com/typescript/-/typescript-5.3.3.tgz",
      "integrity": "sha512-pXWcraxM0uxAS+tN0AG/BF2TyqmHO014Z070UsJ+pFvYuRSq8KH8DmWpnbXe0pEPDHXZV3FcAbJkijJ5oNEnWw==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=14.17"
      }
    },
    "node_modules/undici-types": {
      "version": "6.21.0",
      "resolved": "https://registry.npmmirror.com/undici-types/-/undici-types-6.21.0.tgz",
      "integrity": "sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/unicorn-magic": {
      "version": "0.3.0",
      "resolved": "https://registry.npmjs.org/unicorn-magic/-/unicorn-magic-0.3.0.tgz",
      "integrity": "sha512-+QBBXBCvifc56fsbuxZQ6Sic3wqqc3WWaqxs58gvJrcOuN83HGTCwz3oS5phzU9LthRNE9VrJCFCLUgHeeFnfA==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/unist-util-stringify-position": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/unist-util-stringify-position/-/unist-util-stringify-position-3.0.3.tgz",
      "integrity": "sha512-k5GzIBZ/QatR8N5X2y+drfpWG8IDBzdnVj6OInRNWm1oXrzydiaAT2OQiA8DPRRZyAKb9b6I2a6PxYklZD0gKg==",
      "license": "MIT",
      "dependencies": {
        "@types/unist": "^2.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/unified"
      }
    },
    "node_modules/update-browserslist-db": {
      "version": "1.1.3",
      "resolved": "https://registry.npmmirror.com/update-browserslist-db/-/update-browserslist-db-1.1.3.tgz",
      "integrity": "sha512-UxhIZQ+QInVdunkDAaiazvvT/+fXL5Osr0JZlJulepYu6Jd7qJtDZjlur0emRlT71EN3ScPoE7gvsuIKKNavKw==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/use-sync-external-store": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/use-sync-external-store/-/use-sync-external-store-1.6.0.tgz",
      "integrity": "sha512-Pp6GSwGP/NrPIrxVFAIkOQeyw8lFenOHijQWkUTrDvrF4ALqylP2C/KCkeS9dpUM3KvYRQhna5vt7IL95+ZQ9w==",
      "license": "MIT",
      "peerDependencies": {
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://registry.npmmirror.com/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "license": "MIT"
    },
    "node_modules/uuid": {
      "version": "9.0.1",
      "resolved": "https://registry.npmjs.org/uuid/-/uuid-9.0.1.tgz",
      "integrity": "sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==",
      "funding": [
        "https://github.com/sponsors/broofa",
        "https://github.com/sponsors/ctavan"
      ],
      "license": "MIT",
      "bin": {
        "uuid": "dist/bin/uuid"
      }
    },
    "node_modules/uvu": {
      "version": "0.5.6",
      "resolved": "https://registry.npmjs.org/uvu/-/uvu-0.5.6.tgz",
      "integrity": "sha512-+g8ENReyr8YsOc6fv/NVJs2vFdHBnBNdfE49rshrTzDWOlUx4Gq7KOS2GD8eqhy2j+Ejq29+SbKH8yjkAqXqoA==",
      "license": "MIT",
      "dependencies": {
        "dequal": "^2.0.0",
        "diff": "^5.0.0",
        "kleur": "^4.0.3",
        "sade": "^1.7.3"
      },
      "bin": {
        "uvu": "bin.js"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/vite": {
      "version": "5.4.21",
      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.21.tgz",
      "integrity": "sha512-o5a9xKjbtuhY6Bi5S3+HvbRERmouabWbyUcpXXUA1u+GNUKoROi9byOJ8M0nHbHYHkYICiMlqxkg1KkYmm25Sw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "^0.21.3",
        "postcss": "^8.4.43",
        "rollup": "^4.20.0"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^18.0.0 || >=20.0.0",
        "less": "*",
        "lightningcss": "^1.21.0",
        "sass": "*",
        "sass-embedded": "*",
        "stylus": "*",
        "sugarss": "*",
        "terser": "^5.4.0"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        }
      }
    },
    "node_modules/web-worker": {
      "version": "1.5.0",
      "resolved": "https://registry.npmjs.org/web-worker/-/web-worker-1.5.0.tgz",
      "integrity": "sha512-RiMReJrTAiA+mBjGONMnjVDP2u3p9R1vkcGz6gDIrOMT3oGuYwX2WRMYI9ipkphSuE5XKEhydbhNEJh4NY9mlw==",
      "license": "Apache-2.0"
    },
    "node_modules/which": {
      "version": "2.0.2",
      "resolved": "https://registry.npmmirror.com/which/-/which-2.0.2.tgz",
      "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
      "license": "ISC",
      "dependencies": {
        "isexe": "^2.0.0"
      },
      "bin": {
        "node-which": "bin/node-which"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/wrap-ansi": {
      "version": "8.1.0",
      "resolved": "https://registry.npmmirror.com/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
      "license": "MIT",
      "dependencies": {
        "ansi-styles": "^6.1.0",
        "string-width": "^5.0.1",
        "strip-ansi": "^7.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs": {
      "name": "wrap-ansi",
      "version": "7.0.0",
      "resolved": "https://registry.npmmirror.com/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
      "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
      "license": "MIT",
      "dependencies": {
        "ansi-styles": "^4.0.0",
        "string-width": "^4.1.0",
        "strip-ansi": "^6.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmmirror.com/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/ansi-styles": {
      "version": "4.3.0",
      "resolved": "https://registry.npmmirror.com/ansi-styles/-/ansi-styles-4.3.0.tgz",
      "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
      "license": "MIT",
      "dependencies": {
        "color-convert": "^2.0.1"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
      "version": "8.0.0",
      "resolved": "https://registry.npmmirror.com/emoji-regex/-/emoji-regex-8.0.0.tgz",
      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
      "license": "MIT"
    },
    "node_modules/wrap-ansi-cjs/node_modules/string-width": {
      "version": "4.2.3",
      "resolved": "https://registry.npmmirror.com/string-width/-/string-width-4.2.3.tgz",
      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
      "license": "MIT",
      "dependencies": {
        "emoji-regex": "^8.0.0",
        "is-fullwidth-code-point": "^3.0.0",
        "strip-ansi": "^6.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/strip-ansi": {
      "version": "6.0.1",
      "resolved": "https://registry.npmmirror.com/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/yaml": {
      "version": "2.8.1",
      "resolved": "https://registry.npmmirror.com/yaml/-/yaml-2.8.1.tgz",
      "integrity": "sha512-lcYcMxX2PO9XMGvAJkJ3OsNMw+/7FKes7/hgerGUYWIoWu5j/+YQqcZr5JnPZWzOsEBgMbSbiSTn/dv/69Mkpw==",
      "license": "ISC",
      "bin": {
        "yaml": "bin.mjs"
      },
      "engines": {
        "node": ">= 14.6"
      }
    },
    "node_modules/yoctocolors": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/yoctocolors/-/yoctocolors-2.1.2.tgz",
      "integrity": "sha512-CzhO+pFNo8ajLM2d2IW/R93ipy99LWjtwblvC1RsoSUMZgyLbYFr221TnSNT7GjGdYui6P459mw9JH/g/zW2ug==",
      "license": "MIT",
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/zrender": {
      "version": "5.6.1",
      "resolved": "https://registry.npmjs.org/zrender/-/zrender-5.6.1.tgz",
      "integrity": "sha512-OFXkDJKcrlx5su2XbzJvj/34Q3m6PvyCZkVPHGYpcCJ52ek4U/ymZyfuV1nKE23AyBJ51E/6Yr0mhZ7xGTO4ag==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "tslib": "2.3.0"
      }
    },
    "node_modules/zustand": {
      "version": "4.5.7",
      "resolved": "https://registry.npmjs.org/zustand/-/zustand-4.5.7.tgz",
      "integrity": "sha512-CHOUy7mu3lbD6o6LJLfllpjkzhHXSBlX8B9+qPddUsIfeF5S/UZ5q0kmCsnRqT1UHFQZchNFDDzMbQsuesHWlw==",
      "license": "MIT",
      "dependencies": {
        "use-sync-external-store": "^1.2.2"
      },
      "engines": {
        "node": ">=12.7.0"
      },
      "peerDependencies": {
        "@types/react": ">=16.8",
        "immer": ">=9.0.6",
        "react": ">=16.8"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "immer": {
          "optional": true
        },
        "react": {
          "optional": true
        }
      }
    }
  }
}

```


## package.json

```json
{
  "name": "yprompt",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "type-check": "tsc --noEmit",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx --fix --ignore-path .gitignore",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "@tailwindcss/typography": "^0.5.18",
    "@types/marked": "^5.0.2",
    "dompurify": "^3.1.7",
    "echarts": "^5.5.0",
    "highlight.js": "^11.9.0",
    "lucide-react": "^0.544.0",
    "marked": "^16.3.0",
    "mermaid": "^10.9.1",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.26.0",
    "zustand": "^4.5.5"
  },
  "devDependencies": {
    "@types/d3": "^7.4.3",
    "@types/node": "^20.10.0",
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.16",
    "baseline-browser-mapping": "^2.8.29",
    "postcss": "^8.4.32",
    "react-grab": "^0.0.88",
    "tailwindcss": "^3.3.6",
    "typescript": "~5.3.0",
    "vite": "^5.0.0"
  }
}

```


## postcss.config.js

```js
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```


## react-grab-js/claude-client.global.js

```js
var ReactGrabClaudeCode=(function(exports){'use strict';var y=5e3,b="react-grab:agent-sessions",v=t=>{let e="",o="";for(let n of t.split(`
`))n.startsWith("event:")?e=n.slice(6).trim():n.startsWith("data:")&&(o=n.slice(5).trim());return {eventType:e,data:o}},T=async function*(t,e){let o=t.getReader(),n=new TextDecoder,r="",s=false,i=()=>{s=true,o.cancel().catch(()=>{});};e.addEventListener("abort",i);try{if(e.aborted)throw new DOMException("Aborted","AbortError");for(;;){let d=await o.read();if(s||e.aborted)throw new DOMException("Aborted","AbortError");let{done:a,value:l}=d;l&&(r+=n.decode(l,{stream:!0}));let c;for(;(c=r.indexOf(`

`))!==-1;){let{eventType:f,data:p}=v(r.slice(0,c));if(r=r.slice(c+2),f==="done")return;if(f==="error")throw new Error(p||"Agent error");p&&(yield p);}if(a)break}}finally{e.removeEventListener("abort",i);try{o.releaseLock();}catch{}}},h=t=>typeof t=="object"&&t!==null,S=(t,e,o=b)=>{let n=t.getItem(o);if(!n)throw new Error("No sessions to resume");let r;try{r=JSON.parse(n);}catch{throw new Error("Failed to parse stored sessions")}if(!h(r))throw new Error("Invalid stored sessions");let s=r[e];if(!h(s))throw new Error(`Session ${e} not found`);let i=s.context;if(!h(i))throw new Error(`Session ${e} is invalid`);let d=i.content,a=i.prompt;if(typeof d!="string"||typeof a!="string")throw new Error(`Session ${e} is invalid`);let l=i.options,c=i.sessionId;return {content:d,prompt:a,options:l,sessionId:typeof c=="string"?c:void 0}},g=async function*(t,e,o){let n=Date.now(),r=e.sessionId,s=t.pollIntervalMs??100,i=`${t.serverUrl}${t.agentPath??"/agent"}`,d=()=>{if(!r)return;let a=t.abortPath?.(r)??`/abort/${r}`;fetch(`${t.serverUrl}${a}`,{method:"POST"}).catch(()=>{});};o.addEventListener("abort",d);try{let a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:o});if(!a.ok)throw new Error(`Server error: ${a.status}`);if(!a.body)throw new Error("No response body");let l=T(a.body,o)[Symbol.asyncIterator](),c=!1,f=l.next(),p=null;for(;!c;){let A=await Promise.race([f.then(u=>({type:"status",iteratorResult:u})),new Promise(u=>setTimeout(()=>u({type:"timeout"}),s))]),m=(Date.now()-n)/1e3;if(A.type==="status"){let u=A.iteratorResult;c=u.done??!1,!c&&u.value&&(p=u.value,f=l.next());}p===t.completedStatus?yield `Completed in ${m.toFixed(1)}s`:p?yield `${p} ${m.toFixed(1)}s`:yield `Working\u2026 ${m.toFixed(1)}s`;}}finally{o.removeEventListener("abort",d);}},E=(t,e=y)=>{let o=null;return async()=>{let n=Date.now();if(o&&n-o.timestamp<e)return o.result;try{let r=await t();return o={result:r,timestamp:n},r}catch{return o={result:false,timestamp:n},false}}};var w="Completed successfully";var O="https://claude-react-grab.xiechengqi.top",x={systemPrompt:{type:"preset",preset:"claude_code",append:`You are helping a user make changes to a React component based on a selected element.
The user has selected an element from their UI and wants you to help modify it.
Provide clear, concise status updates as you work.`},model:"haiku",permissionMode:"bypassPermissions",maxTurns:10},C=t=>typeof t=="object"&&t!==null&&"setAgent"in t,_=(t={})=>{let{serverUrl:e=O,getOptions:o}=t,n=s=>({...x,...o?.()??{},...s??{}}),r=E(async()=>(await fetch(`${e}/health`,{method:"GET"})).ok,y);return {send:async function*(s,i){let d={...s,options:n(s.options)};yield*g({serverUrl:e,completedStatus:w},d,i);},resume:async function*(s,i,d){let a=S(d,s),l={content:a.content,prompt:a.prompt,options:a.options,sessionId:a.sessionId??s},c={...l,options:n(l.options)};yield "Resuming...",yield*g({serverUrl:e,completedStatus:w},c,i);},supportsResume:true,supportsFollowUp:true,checkConnection:r,undo:async()=>{try{await fetch(`${e}/undo`,{method:"POST"});}catch{}}}},R=async()=>{if(typeof window>"u")return;let t=_(),e=r=>{r.setAgent({provider:t,storage:sessionStorage});},o=window.__REACT_GRAB__;if(C(o)){e(o);return}window.addEventListener("react-grab:init",r=>{r instanceof CustomEvent&&C(r.detail)&&e(r.detail);},{once:true});let n=window.__REACT_GRAB__;C(n)&&e(n);};R();exports.attachAgent=R;exports.createClaudeAgentProvider=_;return exports;})({});
```


## react-grab-js/cursor-client.global.js

```js
var ReactGrabCursor=(function(exports){'use strict';var A=5e3,b="react-grab:agent-sessions",v=e=>{let t="",r="";for(let n of e.split(`
`))n.startsWith("event:")?t=n.slice(6).trim():n.startsWith("data:")&&(r=n.slice(5).trim());return {eventType:t,data:r}},T=async function*(e,t){let r=e.getReader(),n=new TextDecoder,o="",s=false,a=()=>{s=true,r.cancel().catch(()=>{});};t.addEventListener("abort",a);try{if(t.aborted)throw new DOMException("Aborted","AbortError");for(;;){let d=await r.read();if(s||t.aborted)throw new DOMException("Aborted","AbortError");let{done:i,value:l}=d;l&&(o+=n.decode(l,{stream:!0}));let c;for(;(c=o.indexOf(`

`))!==-1;){let{eventType:f,data:p}=v(o.slice(0,c));if(o=o.slice(c+2),f==="done")return;if(f==="error")throw new Error(p||"Agent error");p&&(yield p);}if(i)break}}finally{t.removeEventListener("abort",a);try{r.releaseLock();}catch{}}},m=e=>typeof e=="object"&&e!==null,S=(e,t,r=b)=>{let n=e.getItem(r);if(!n)throw new Error("No sessions to resume");let o;try{o=JSON.parse(n);}catch{throw new Error("Failed to parse stored sessions")}if(!m(o))throw new Error("Invalid stored sessions");let s=o[t];if(!m(s))throw new Error(`Session ${t} not found`);let a=s.context;if(!m(a))throw new Error(`Session ${t} is invalid`);let d=a.content,i=a.prompt;if(typeof d!="string"||typeof i!="string")throw new Error(`Session ${t} is invalid`);let l=a.options,c=a.sessionId;return {content:d,prompt:i,options:l,sessionId:typeof c=="string"?c:void 0}},h=async function*(e,t,r){let n=Date.now(),o=t.sessionId,s=e.pollIntervalMs??100,a=`${e.serverUrl}${e.agentPath??"/agent"}`,d=()=>{if(!o)return;let i=e.abortPath?.(o)??`/abort/${o}`;fetch(`${e.serverUrl}${i}`,{method:"POST"}).catch(()=>{});};r.addEventListener("abort",d);try{let i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:r});if(!i.ok)throw new Error(`Server error: ${i.status}`);if(!i.body)throw new Error("No response body");let l=T(i.body,r)[Symbol.asyncIterator](),c=!1,f=l.next(),p=null;for(;!c;){let C=await Promise.race([f.then(u=>({type:"status",iteratorResult:u})),new Promise(u=>setTimeout(()=>u({type:"timeout"}),s))]),g=(Date.now()-n)/1e3;if(C.type==="status"){let u=C.iteratorResult;c=u.done??!1,!c&&u.value&&(p=u.value,f=l.next());}p===e.completedStatus?yield `Completed in ${g.toFixed(1)}s`:p?yield `${p} ${g.toFixed(1)}s`:yield `Working\u2026 ${g.toFixed(1)}s`;}}finally{r.removeEventListener("abort",d);}},E=(e,t=A)=>{let r=null;return async()=>{let n=Date.now();if(r&&n-r.timestamp<t)return r.result;try{let o=await e();return r={result:o,timestamp:n},o}catch{return r={result:false,timestamp:n},false}}};var w="Completed successfully";var x="https://cursor-react-grab-server.xiechengqi.top",y=e=>typeof e=="object"&&e!==null&&"setAgent"in e,O=(e={})=>{let{serverUrl:t=x,getOptions:r}=e,n=s=>({...r?.()??{},...s??{}}),o=E(async()=>(await fetch(`${t}/health`,{method:"GET"})).ok,A);return {send:async function*(s,a){let d={...s,options:n(s.options)};yield*h({serverUrl:t,completedStatus:w},d,a);},resume:async function*(s,a,d){let i=S(d,s),l={content:i.content,prompt:i.prompt,options:i.options,sessionId:i.sessionId??s},c={...l,options:n(l.options)};yield "Resuming...",yield*h({serverUrl:t,completedStatus:w},c,a);},supportsResume:true,supportsFollowUp:true,checkConnection:o,abort:async s=>{try{await fetch(`${t}/abort/${s}`,{method:"POST"});}catch{}},undo:async()=>{try{await fetch(`${t}/undo`,{method:"POST"});}catch{}}}},_=async()=>{if(typeof window>"u")return;let e=O(),t=o=>{o.setAgent({provider:e,storage:sessionStorage});},r=window.__REACT_GRAB__;if(y(r)){t(r);return}window.addEventListener("react-grab:init",o=>{o instanceof CustomEvent&&y(o.detail)&&t(o.detail);},{once:true});let n=window.__REACT_GRAB__;y(n)&&t(n);};_();
exports.attachAgent=_;exports.createCursorAgentProvider=O;return exports;})({});
```


## react-grab-js/gemini-client.global.js

```js
var ReactGrabGemini=(function(exports){'use strict';var A=5e3,v="react-grab:agent-sessions",C=e=>{let t="",n="";for(let o of e.split(`
`))o.startsWith("event:")?t=o.slice(6).trim():o.startsWith("data:")&&(n=o.slice(5).trim());return {eventType:t,data:n}},T=async function*(e,t){let n=e.getReader(),o=new TextDecoder,r="",s=false,a=()=>{s=true,n.cancel().catch(()=>{});};t.addEventListener("abort",a);try{if(t.aborted)throw new DOMException("Aborted","AbortError");for(;;){let d=await n.read();if(s||t.aborted)throw new DOMException("Aborted","AbortError");let{done:i,value:l}=d;l&&(r+=o.decode(l,{stream:!0}));let c;for(;(c=r.indexOf(`

`))!==-1;){let{eventType:f,data:p}=C(r.slice(0,c));if(r=r.slice(c+2),f==="done")return;if(f==="error")throw new Error(p||"Agent error");p&&(yield p);}if(i)break}}finally{t.removeEventListener("abort",a);try{n.releaseLock();}catch{}}},g=e=>typeof e=="object"&&e!==null,E=(e,t,n=v)=>{let o=e.getItem(n);if(!o)throw new Error("No sessions to resume");let r;try{r=JSON.parse(o);}catch{throw new Error("Failed to parse stored sessions")}if(!g(r))throw new Error("Invalid stored sessions");let s=r[t];if(!g(s))throw new Error(`Session ${t} not found`);let a=s.context;if(!g(a))throw new Error(`Session ${t} is invalid`);let d=a.content,i=a.prompt;if(typeof d!="string"||typeof i!="string")throw new Error(`Session ${t} is invalid`);let l=a.options,c=a.sessionId;return {content:d,prompt:i,options:l,sessionId:typeof c=="string"?c:void 0}},h=async function*(e,t,n){let o=Date.now(),r=t.sessionId,s=e.pollIntervalMs??100,a=`${e.serverUrl}${e.agentPath??"/agent"}`,d=()=>{if(!r)return;let i=e.abortPath?.(r)??`/abort/${r}`;fetch(`${e.serverUrl}${i}`,{method:"POST"}).catch(()=>{});};n.addEventListener("abort",d);try{let i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n});if(!i.ok)throw new Error(`Server error: ${i.status}`);if(!i.body)throw new Error("No response body");let l=T(i.body,n)[Symbol.asyncIterator](),c=!1,f=l.next(),p=null;for(;!c;){let S=await Promise.race([f.then(u=>({type:"status",iteratorResult:u})),new Promise(u=>setTimeout(()=>u({type:"timeout"}),s))]),m=(Date.now()-o)/1e3;if(S.type==="status"){let u=S.iteratorResult;c=u.done??!1,!c&&u.value&&(p=u.value,f=l.next());}p===e.completedStatus?yield `Completed in ${m.toFixed(1)}s`:p?yield `${p} ${m.toFixed(1)}s`:yield `Working\u2026 ${m.toFixed(1)}s`;}}finally{n.removeEventListener("abort",d);}},b=(e,t=A)=>{let n=null;return async()=>{let o=Date.now();if(n&&o-n.timestamp<t)return n.result;try{let r=await e();return n={result:r,timestamp:o},r}catch{return n={result:false,timestamp:o},false}}};var y="Completed successfully";var x="https://gemini-react-grab.xiechengqi.top",w=e=>typeof e=="object"&&e!==null&&"setAgent"in e,O=(e={})=>{let{serverUrl:t=x,getOptions:n}=e,o=s=>({...n?.()??{},...s??{}}),r=b(async()=>(await fetch(`${t}/health`,{method:"GET"})).ok,A);return {send:async function*(s,a){let d={...s,options:o(s.options)};yield*h({serverUrl:t,completedStatus:y},d,a);},resume:async function*(s,a,d){let i=E(d,s),l={content:i.content,prompt:i.prompt,options:i.options,sessionId:i.sessionId??s},c={...l,options:o(l.options)};yield "Resuming...",yield*h({serverUrl:t,completedStatus:y},c,a);},supportsResume:true,supportsFollowUp:true,checkConnection:r,abort:async s=>{try{await fetch(`${t}/abort/${s}`,{method:"POST"});}catch{}},undo:async()=>{try{await fetch(`${t}/undo`,{method:"POST"});}catch{}}}},_=async()=>{if(typeof window>"u")return;let e=O(),t=r=>{r.setAgent({provider:e,storage:sessionStorage});},n=window.__REACT_GRAB__;if(w(n)){t(n);return}window.addEventListener("react-grab:init",r=>{r instanceof CustomEvent&&w(r.detail)&&t(r.detail);},{once:true});let o=window.__REACT_GRAB__;w(o)&&t(o);};_();
exports.attachAgent=_;exports.createGeminiAgentProvider=O;return exports;})({});
```


## react-grab-js/index.global.js

```js
var ReactGrab=(function(exports){'use strict';/**
 * @license MIT
 *
 * Copyright (c) 2025 Aiden Bai
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
var ia=(e,t)=>e===t;var zo=Symbol("solid-track"),Rn={equals:ia},jo=Wo,ze=1,un=2,Vo={owned:null,cleanups:null,context:null,owner:null},yr={},re=null,E=null,zt=null,ue=null,Ee=null,Le=null,Mn=0;function lt(e,t){let n=ue,r=re,i=e.length===0,o=t===void 0?r:t,a=i?Vo:{owned:null,cleanups:null,context:o?o.context:null,owner:o},l=i?e:()=>e(()=>Me(()=>bt(a)));re=a,ue=null;try{return He(l,!0)}finally{ue=n,re=r;}}function N(e,t){t=t?Object.assign({},Rn,t):Rn;let n={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},r=i=>(typeof i=="function"&&(i=i(n.value)),Xo(n,i));return [Ko.bind(n),r]}function Do(e,t,n){let r=Pn(e,t,true,ze);Vt(r);}function de(e,t,n){let r=Pn(e,t,false,ze);Vt(r);}function oe(e,t,n){jo=ua;let r=Pn(e,t,false,ze);(r.user=true),Le?Le.push(r):Vt(r);}function ce(e,t,n){n=n?Object.assign({},Rn,n):Rn;let r=Pn(e,t,true,0);return r.observers=null,r.observerSlots=null,r.comparator=n.equals||void 0,Vt(r),Ko.bind(r)}function sa(e){return e&&typeof e=="object"&&"then"in e}function On(e,t,n){let r,i,o;typeof t=="function"?(r=e,i=t,o={}):(r=true,i=e,o=t||{});let a=null,l=yr,g=false,p="initialValue"in o,k=typeof r=="function"&&ce(r),y=new Set,[x,_]=(o.storage||N)(o.initialValue),[H,V]=N(void 0),[C,$]=N(void 0,{equals:false}),[Z,v]=N(p?"ready":"unresolved");function M(h,m,f,b){return a===h&&(a=null,b!==void 0&&(p=true),(h===l||m===l)&&o.onHydrated&&queueMicrotask(()=>o.onHydrated(b,{value:m})),l=yr,W(m,f)),m}function W(h,m){He(()=>{m===void 0&&_(()=>h),v(m!==void 0?"errored":p?"ready":"unresolved"),V(m);for(let f of y.keys())f.decrement();y.clear();},false);}function z(){let h=dn,m=x(),f=H();if(f!==void 0&&!a)throw f;return ue&&!ue.user&&h,m}function q(h=true){if(h!==false&&g)return;g=false;let m=k?k():r;if(m==null||m===false){M(a,Me(x));return}let f,b=l!==yr?l:Me(()=>{try{return i(m,{value:x(),refetching:h})}catch(L){f=L;}});if(f!==void 0){M(a,void 0,Nn(f),m);return}else if(!sa(b))return M(a,b,void 0,m),b;return a=b,"v"in b?(b.s===1?M(a,b.v,void 0,m):M(a,void 0,Nn(b.v),m),b):(g=true,queueMicrotask(()=>g=false),He(()=>{v(p?"refreshing":"pending"),$();},false),b.then(L=>M(b,L,void 0,m),L=>M(b,void 0,Nn(L),m)))}Object.defineProperties(z,{state:{get:()=>Z()},error:{get:()=>H()},loading:{get(){let h=Z();return h==="pending"||h==="refreshing"}},latest:{get(){if(!p)return z();let h=H();if(h&&!a)throw h;return x()}}});let O=re;return k?Do(()=>(O=re,q(false))):q(false),[z,{refetch:h=>Uo(O,()=>q(h)),mutate:_}]}function Me(e){if(ue===null)return e();let t=ue;ue=null;try{return zt?zt.untrack(e):e()}finally{ue=t;}}function Pe(e,t,n){let r=Array.isArray(e),i;return a=>{let l;if(r){l=Array(e.length);for(let u=0;u<e.length;u++)l[u]=e[u]();}else l=e();let c=Me(()=>t(l,i,a));return i=l,c}}function mn(e){oe(()=>Me(e));}function be(e){return re===null||(re.cleanups===null?re.cleanups=[e]:re.cleanups.push(e)),e}function Uo(e,t){let n=re,r=ue;re=e,ue=null;try{return He(t,!0)}catch(i){$n(i);}finally{re=n,ue=r;}}var[bu,Fo]=N(false);var dn;function Ko(){let e=E;if(this.sources&&(this.state))if((this.state)===ze)Vt(this);else {let t=Ee;Ee=null,He(()=>In(this),false),Ee=t;}if(ue){let t=this.observers?this.observers.length:0;ue.sources?(ue.sources.push(this),ue.sourceSlots.push(t)):(ue.sources=[this],ue.sourceSlots=[t]),this.observers?(this.observers.push(ue),this.observerSlots.push(ue.sources.length-1)):(this.observers=[ue],this.observerSlots=[ue.sources.length-1]);}return e&&E.sources.has(this)?this.tValue:this.value}function Xo(e,t,n){let r=e.value;if(!e.comparator||!e.comparator(r,t)){e.value=t;e.observers&&e.observers.length&&He(()=>{for(let i=0;i<e.observers.length;i+=1){let o=e.observers[i],a=E&&E.running;a&&E.disposed.has(o)||((a?!o.tState:!o.state)&&(o.pure?Ee.push(o):Le.push(o),o.observers&&Yo(o)),a?o.tState=ze:o.state=ze);}if(Ee.length>1e6)throw Ee=[],new Error},false);}return t}function Vt(e){if(!e.fn)return;bt(e);let t=Mn;Bo(e,e.value,t);}function Bo(e,t,n){let r,i=re,o=ue;ue=re=e;try{r=e.fn(t);}catch(a){return e.pure&&((e.state=ze,e.owned&&e.owned.forEach(bt),e.owned=null)),e.updatedAt=n+1,$n(a)}finally{ue=o,re=i;}(!e.updatedAt||e.updatedAt<=n)&&(e.updatedAt!=null&&"observers"in e?Xo(e,r):e.value=r,e.updatedAt=n);}function Pn(e,t,n,r=ze,i){let o={fn:e,state:r,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:re,context:re?re.context:null,pure:n};if(re===null||re!==Vo&&(re.owned?re.owned.push(o):re.owned=[o]),zt);return o}function fn(e){let t=E;if((e.state)===0)return;if((e.state)===un)return In(e);if(e.suspense&&Me(e.suspense.inFallback))return e.suspense.effects.push(e);let n=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<Mn);){(e.state)&&n.push(e);}for(let r=n.length-1;r>=0;r--){if(e=n[r],t);if((e.state)===ze)Vt(e);else if((e.state)===un){let i=Ee;Ee=null,He(()=>In(e,n[0]),false),Ee=i;}}}function He(e,t){if(Ee)return e();let n=false;t||(Ee=[]),Le?n=true:Le=[],Mn++;try{let r=e();return la(n),r}catch(r){n||(Le=null),Ee=null,$n(r);}}function la(e){if(Ee&&(Wo(Ee),Ee=null),e)return;let n=Le;Le=null,n.length&&He(()=>jo(n),false);}function Wo(e){for(let t=0;t<e.length;t++)fn(e[t]);}function ua(e){let t,n=0;for(t=0;t<e.length;t++){let r=e[t];r.user?e[n++]=r:fn(r);}for(t=0;t<n;t++)fn(e[t]);}function In(e,t){e.state=0;for(let r=0;r<e.sources.length;r+=1){let i=e.sources[r];if(i.sources){let o=i.state;o===ze?i!==t&&(!i.updatedAt||i.updatedAt<Mn)&&fn(i):o===un&&In(i,t);}}}function Yo(e){for(let n=0;n<e.observers.length;n+=1){let r=e.observers[n];(!r.state)&&(r.state=un,r.pure?Ee.push(r):Le.push(r),r.observers&&Yo(r));}}function bt(e){let t;if(e.sources)for(;e.sources.length;){let n=e.sources.pop(),r=e.sourceSlots.pop(),i=n.observers;if(i&&i.length){let o=i.pop(),a=n.observerSlots.pop();r<i.length&&(o.sourceSlots[a]=r,i[r]=o,n.observerSlots[r]=a);}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)bt(e.tOwned[t]);delete e.tOwned;}if(e.owned){for(t=e.owned.length-1;t>=0;t--)bt(e.owned[t]);e.owned=null;}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null;}e.state=0;}function Nn(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function $n(e,t=re){let r=Nn(e);throw r;}var xr=Symbol("fallback");function Ln(e){for(let t=0;t<e.length;t++)e[t]();}function da(e,t,n={}){let r=[],i=[],o=[],a=0,l=t.length>1?[]:null;return be(()=>Ln(o)),()=>{let c=e()||[],u=c.length,g,p;return c[zo],Me(()=>{let y,x,_,H,V,C,$,Z,v;if(u===0)a!==0&&(Ln(o),o=[],r=[],i=[],a=0,l&&(l=[])),n.fallback&&(r=[xr],i[0]=lt(M=>(o[0]=M,n.fallback())),a=1);else if(a===0){for(i=new Array(u),p=0;p<u;p++)r[p]=c[p],i[p]=lt(k);a=u;}else {for(_=new Array(u),H=new Array(u),l&&(V=new Array(u)),C=0,$=Math.min(a,u);C<$&&r[C]===c[C];C++);for($=a-1,Z=u-1;$>=C&&Z>=C&&r[$]===c[Z];$--,Z--)_[Z]=i[$],H[Z]=o[$],l&&(V[Z]=l[$]);for(y=new Map,x=new Array(Z+1),p=Z;p>=C;p--)v=c[p],g=y.get(v),x[p]=g===void 0?-1:g,y.set(v,p);for(g=C;g<=$;g++)v=r[g],p=y.get(v),p!==void 0&&p!==-1?(_[p]=i[g],H[p]=o[g],l&&(V[p]=l[g]),p=x[p],y.set(v,p)):o[g]();for(p=C;p<u;p++)p in _?(i[p]=_[p],o[p]=H[p],l&&(l[p]=V[p],l[p](p))):i[p]=lt(k);i=i.slice(0,a=u),r=c.slice(0);}return i});function k(y){if(o[p]=y,l){let[x,_]=N(p);return l[p]=_,t(c[p],x)}return t(c[p])}}}function fa(e,t,n={}){let r=[],i=[],o=[],a=[],l=0,c;return be(()=>Ln(o)),()=>{let u=e()||[],g=u.length;return u[zo],Me(()=>{if(g===0)return l!==0&&(Ln(o),o=[],r=[],i=[],l=0,a=[]),n.fallback&&(r=[xr],i[0]=lt(k=>(o[0]=k,n.fallback())),l=1),i;for(r[0]===xr&&(o[0](),o=[],r=[],i=[],l=0),c=0;c<g;c++)c<r.length&&r[c]!==u[c]?a[c](()=>u[c]):c>=r.length&&(i[c]=lt(p));for(;c<r.length;c++)o[c]();return l=a.length=o.length=g,r=u.slice(0),i=i.slice(0,l)});function p(k){o[c]=k;let[y,x]=N(u[c]);return a[c]=x,t(y,c)}}}function A(e,t){return Me(()=>e(t||{}))}var pa=e=>`Stale read from <${e}>.`;function Dn(e){let t="fallback"in e&&{fallback:()=>e.fallback};return ce(da(()=>e.each,e.children,t||void 0))}function vr(e){let t="fallback"in e&&{fallback:()=>e.fallback};return ce(fa(()=>e.each,e.children,t||void 0))}function Q(e){let t=e.keyed,n=ce(()=>e.when,void 0,void 0),r=t?n:ce(n,void 0,{equals:(i,o)=>!i==!o});return ce(()=>{let i=r();if(i){let o=e.children;return typeof o=="function"&&o.length>0?Me(()=>o(t?i:()=>{if(!Me(r))throw pa("Show");return n()})):o}return e.fallback},void 0,void 0)}var ye=e=>ce(()=>e());function ba(e,t,n){let r=n.length,i=t.length,o=r,a=0,l=0,c=t[i-1].nextSibling,u=null;for(;a<i||l<o;){if(t[a]===n[l]){a++,l++;continue}for(;t[i-1]===n[o-1];)i--,o--;if(i===a){let g=o<r?l?n[l-1].nextSibling:n[o-l]:c;for(;l<o;)e.insertBefore(n[l++],g);}else if(o===l)for(;a<i;)(!u||!u.has(t[a]))&&t[a].remove(),a++;else if(t[a]===n[o-1]&&n[l]===t[i-1]){let g=t[--i].nextSibling;e.insertBefore(n[l++],t[a++].nextSibling),e.insertBefore(n[--o],g),t[i]=n[o];}else {if(!u){u=new Map;let p=l;for(;p<o;)u.set(n[p],p++);}let g=u.get(t[a]);if(g!=null)if(l<g&&g<o){let p=a,k=1,y;for(;++p<i&&p<o&&!((y=u.get(t[p]))==null||y!==g+k);)k++;if(k>g-l){let x=t[a];for(;l<g;)e.insertBefore(n[l++],x);}else e.replaceChild(n[l++],t[a++]);}else a++;else t[a++].remove();}}}var Zo="_$DX_DELEGATE";function Qo(e,t,n,r={}){let i;return lt(o=>{i=o,t===document?e():B(t,e(),t.firstChild?null:void 0,n);},r.owner),()=>{i(),t.textContent="";}}function K(e,t,n,r){let i,o=()=>{let l=document.createElement("template");return l.innerHTML=e,l.content.firstChild},a=()=>(i||(i=o())).cloneNode(true);return a.cloneNode=a,a}function Bn(e,t=window.document){let n=t[Zo]||(t[Zo]=new Set);for(let r=0,i=e.length;r<i;r++){let o=e[r];n.has(o)||(n.add(o),t.addEventListener(o,ya));}}function ve(e,t,n){(n==null?e.removeAttribute(t):e.setAttribute(t,n));}function Ge(e,t){(t==null?e.removeAttribute("class"):e.className=t);}function yt(e,t,n,r){Array.isArray(n)?(e[`$$${t}`]=n[0],e[`$$${t}Data`]=n[1]):e[`$$${t}`]=n;}function ei(e,t,n){if(!t)return n?ve(e,"style"):t;let r=e.style;if(typeof t=="string")return r.cssText=t;typeof n=="string"&&(r.cssText=n=void 0),n||(n={}),t||(t={});let i,o;for(o in n)t[o]==null&&r.removeProperty(o),delete n[o];for(o in t)i=t[o],i!==n[o]&&(r.setProperty(o,i),n[o]=i);return n}function _e(e,t,n){n!=null?e.style.setProperty(t,n):e.style.removeProperty(t);}function Gt(e,t,n){return Me(()=>e(t,n))}function B(e,t,n,r){if(n!==void 0&&!r&&(r=[]),typeof t!="function")return Fn(e,t,r,n);de(i=>Fn(e,t(),i,n),r);}function ya(e){let t=e.target,n=`$$${e.type}`,r=e.target,i=e.currentTarget,o=c=>Object.defineProperty(e,"target",{configurable:true,value:c}),a=()=>{let c=t[n];if(c&&!t.disabled){let u=t[`${n}Data`];if(u!==void 0?c.call(t,u,e):c.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&o(t.host),true},l=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:true,get(){return t||document}}),e.composedPath){let c=e.composedPath();o(c[0]);for(let u=0;u<c.length-2&&(t=c[u],!!a());u++){if(t._$host){t=t._$host,l();break}if(t.parentNode===i)break}}else l();o(r);}function Fn(e,t,n,r,i){for(;typeof n=="function";)n=n();if(t===n)return n;let a=typeof t,l=r!==void 0;if(e=l&&n[0]&&n[0].parentNode||e,a==="string"||a==="number"){if(a==="number"&&(t=t.toString(),t===n))return n;if(l){let c=n[0];c&&c.nodeType===3?c.data!==t&&(c.data=t):c=document.createTextNode(t),n=Ut(e,n,r,c);}else n!==""&&typeof n=="string"?n=e.firstChild.data=t:n=e.textContent=t;}else if(t==null||a==="boolean"){n=Ut(e,n,r);}else {if(a==="function")return de(()=>{let c=t();for(;typeof c=="function";)c=c();n=Fn(e,c,n,r);}),()=>n;if(Array.isArray(t)){let c=[],u=n&&Array.isArray(n);if(Sr(c,t,n,i))return de(()=>n=Fn(e,c,n,r,true)),()=>n;if(c.length===0){if(n=Ut(e,n,r),l)return n}else u?n.length===0?Jo(e,c,r):ba(e,n,c):(n&&Ut(e),Jo(e,c));n=c;}else if(t.nodeType){if(Array.isArray(n)){if(l)return n=Ut(e,n,r,t);Ut(e,n,null,t);}else n==null||n===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);n=t;}}return n}function Sr(e,t,n,r){let i=false;for(let o=0,a=t.length;o<a;o++){let l=t[o],c=n&&n[e.length],u;if(!(l==null||l===true||l===false))if((u=typeof l)=="object"&&l.nodeType)e.push(l);else if(Array.isArray(l))i=Sr(e,l,c)||i;else if(u==="function")if(r){for(;typeof l=="function";)l=l();i=Sr(e,Array.isArray(l)?l:[l],Array.isArray(c)?c:[c])||i;}else e.push(l),i=true;else {let g=String(l);c&&c.nodeType===3&&c.data===g?e.push(c):e.push(document.createTextNode(g));}}return i}function Jo(e,t,n=null){for(let r=0,i=t.length;r<i;r++)e.insertBefore(t[r],n);}function Ut(e,t,n,r){if(n===void 0)return e.textContent="";let i=r||document.createTextNode("");if(t.length){let o=false;for(let a=t.length-1;a>=0;a--){let l=t[a];if(i!==l){let c=l.parentNode===e;!o&&!a?c?e.replaceChild(i,l):e.insertBefore(i,n):c&&l.remove();}else o=true;}}else e.insertBefore(i,n);return [i]}var ti=`/*! tailwindcss v4.1.17 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0;--tw-scale-x:1;--tw-scale-y:1;--tw-scale-z:1;--tw-rotate-x:initial;--tw-rotate-y:initial;--tw-rotate-z:initial;--tw-skew-x:initial;--tw-skew-y:initial;--tw-border-style:solid;--tw-leading:initial;--tw-font-weight:initial;--tw-ordinal:initial;--tw-slashed-zero:initial;--tw-numeric-figure:initial;--tw-numeric-spacing:initial;--tw-numeric-fraction:initial;--tw-blur:initial;--tw-brightness:initial;--tw-contrast:initial;--tw-grayscale:initial;--tw-hue-rotate:initial;--tw-invert:initial;--tw-opacity:initial;--tw-saturate:initial;--tw-sepia:initial;--tw-drop-shadow:initial;--tw-drop-shadow-color:initial;--tw-drop-shadow-alpha:100%;--tw-drop-shadow-size:initial;--tw-duration:initial;--tw-ease:initial;--tw-contain-size:initial;--tw-contain-layout:initial;--tw-contain-paint:initial;--tw-contain-style:initial}}}@layer theme{:root,:host{--font-sans:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--color-black:#000;--color-white:#fff;--spacing:.25rem;--font-weight-medium:500;--radius-xs:.125rem;--ease-out:cubic-bezier(0,0,.2,1);--animate-pulse:pulse 2s cubic-bezier(.4,0,.6,1)infinite;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4,0,.2,1);--default-font-family:var(--font-sans);--default-mono-font-family:var(--font-mono);--color-grab-pink:#b21c8e;--color-grab-purple:#d239c0;--color-label-tag-border:#730079;--color-label-muted:#767676}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1}@supports (not ((-webkit-appearance:-apple-pay-button))) or (contain-intrinsic-size:1px){::placeholder{color:currentColor}@supports (color:color-mix(in lab, red, red)){::placeholder{color:color-mix(in oklab,currentcolor 50%,transparent)}}}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}::-webkit-calendar-picker-indicator{line-height:1}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){appearance:button}::file-selector-button{appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.pointer-events-auto{pointer-events:auto}.pointer-events-none{pointer-events:none}.visible{visibility:visible}.absolute{position:absolute}.fixed{position:fixed}.top-0{top:calc(var(--spacing)*0)}.left-0{left:calc(var(--spacing)*0)}.z-2147483645{z-index:2147483645}.z-2147483646{z-index:2147483646}.z-2147483647{z-index:2147483647}.z-\\[2147483645\\]{z-index:2147483645}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.m-0{margin:calc(var(--spacing)*0)}.-mt-px{margin-top:-1px}.mb-0\\.5{margin-bottom:calc(var(--spacing)*.5)}.-ml-\\[2px\\]{margin-left:-2px}.ml-1{margin-left:calc(var(--spacing)*1)}.box-border{box-sizing:border-box}.flex{display:flex}.grid{display:grid}.hidden{display:none}.size-fit{width:fit-content;height:fit-content}.h-0{height:calc(var(--spacing)*0)}.h-4{height:calc(var(--spacing)*4)}.h-5{height:calc(var(--spacing)*5)}.h-5\\.5{height:calc(var(--spacing)*5.5)}.h-\\[7px\\]{height:7px}.h-\\[17px\\]{height:17px}.h-\\[18px\\]{height:18px}.h-fit{height:fit-content}.min-h-0{min-height:calc(var(--spacing)*0)}.min-h-4{min-height:calc(var(--spacing)*4)}.w-0{width:calc(var(--spacing)*0)}.w-0\\.5{width:calc(var(--spacing)*.5)}.w-1{width:calc(var(--spacing)*1)}.w-\\[7px\\]{width:7px}.w-\\[17px\\]{width:17px}.w-auto{width:auto}.w-fit{width:fit-content}.w-full{width:100%}.max-w-\\[280px\\]{max-width:280px}.flex-1{flex:1}.shrink{flex-shrink:1}.shrink-0{flex-shrink:0}.-translate-x-1\\/2{--tw-translate-x:calc(calc(1/2*100%)*-1);translate:var(--tw-translate-x)var(--tw-translate-y)}.-translate-y-1\\/2{--tw-translate-y:calc(calc(1/2*100%)*-1);translate:var(--tw-translate-x)var(--tw-translate-y)}.scale-75{--tw-scale-x:75%;--tw-scale-y:75%;--tw-scale-z:75%;scale:var(--tw-scale-x)var(--tw-scale-y)}.scale-100{--tw-scale-x:100%;--tw-scale-y:100%;--tw-scale-z:100%;scale:var(--tw-scale-x)var(--tw-scale-y)}.transform{transform:var(--tw-rotate-x,)var(--tw-rotate-y,)var(--tw-rotate-z,)var(--tw-skew-x,)var(--tw-skew-y,)}.animate-pulse{animation:var(--animate-pulse)}.cursor-crosshair{cursor:crosshair}.cursor-pointer{cursor:pointer}.resize{resize:both}.resize-none{resize:none}.flex-col{flex-direction:column}.items-center{align-items:center}.items-end{align-items:flex-end}.items-start{align-items:flex-start}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.gap-0\\.5{gap:calc(var(--spacing)*.5)}.gap-1{gap:calc(var(--spacing)*1)}.gap-\\[3px\\]{gap:3px}.gap-\\[5px\\]{gap:5px}.gap-px{gap:1px}.self-stretch{align-self:stretch}.truncate{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded-\\[1\\.5px\\]{border-radius:1.5px}.rounded-\\[1px\\]{border-radius:1px}.rounded-full{border-radius:3.40282e38px}.rounded-xs{border-radius:var(--radius-xs)}.rounded-t-none{border-top-left-radius:0;border-top-right-radius:0}.rounded-b-xs{border-bottom-right-radius:var(--radius-xs);border-bottom-left-radius:var(--radius-xs)}.border{border-style:var(--tw-border-style);border-width:1px}.\\[border-width\\:0\\.5px\\]{border-width:.5px}.\\[border-top-width\\:0\\.5px\\]{border-top-width:.5px}.border-none{--tw-border-style:none;border-style:none}.border-solid{--tw-border-style:solid;border-style:solid}.border-\\[\\#7e0002\\]{border-color:#7e0002}.border-\\[\\#B3B3B3\\]{border-color:#b3b3b3}.border-grab-purple{border-color:var(--color-grab-purple)}.border-grab-purple\\/40{border-color:#d239c066}@supports (color:color-mix(in lab, red, red)){.border-grab-purple\\/40{border-color:color-mix(in oklab,var(--color-grab-purple)40%,transparent)}}.border-grab-purple\\/50{border-color:#d239c080}@supports (color:color-mix(in lab, red, red)){.border-grab-purple\\/50{border-color:color-mix(in oklab,var(--color-grab-purple)50%,transparent)}}.border-label-tag-border{border-color:var(--color-label-tag-border)}.border-white{border-color:var(--color-white)}.border-t-\\[\\#D9D9D9\\]{border-top-color:#d9d9d9}.bg-\\[\\#F7F7F7\\]{background-color:#f7f7f7}.bg-black{background-color:var(--color-black)}.bg-grab-pink{background-color:var(--color-grab-pink)}.bg-grab-purple{background-color:var(--color-grab-purple)}.bg-grab-purple\\/5{background-color:#d239c00d}@supports (color:color-mix(in lab, red, red)){.bg-grab-purple\\/5{background-color:color-mix(in oklab,var(--color-grab-purple)5%,transparent)}}.bg-grab-purple\\/8{background-color:#d239c014}@supports (color:color-mix(in lab, red, red)){.bg-grab-purple\\/8{background-color:color-mix(in oklab,var(--color-grab-purple)8%,transparent)}}.bg-transparent{background-color:#0000}.bg-white{background-color:var(--color-white)}.p-0{padding:calc(var(--spacing)*0)}.p-1{padding:calc(var(--spacing)*1)}.px-0{padding-inline:calc(var(--spacing)*0)}.px-1\\.5{padding-inline:calc(var(--spacing)*1.5)}.px-2{padding-inline:calc(var(--spacing)*2)}.px-\\[2px\\]{padding-inline:2px}.px-\\[3px\\]{padding-inline:3px}.py-0{padding-block:calc(var(--spacing)*0)}.py-\\[2px\\]{padding-block:2px}.py-\\[3px\\]{padding-block:3px}.py-\\[5px\\]{padding-block:5px}.py-px{padding-block:1px}.pt-1{padding-top:calc(var(--spacing)*1)}.pt-1\\.5{padding-top:calc(var(--spacing)*1.5)}.pr-1{padding-right:calc(var(--spacing)*1)}.pr-1\\.5{padding-right:calc(var(--spacing)*1.5)}.pb-1{padding-bottom:calc(var(--spacing)*1)}.pl-1\\.5{padding-left:calc(var(--spacing)*1.5)}.align-middle{vertical-align:middle}.font-mono{font-family:var(--font-mono)}.font-sans{font-family:var(--font-sans)}.text-\\[9px\\]{font-size:9px}.text-\\[11\\.5px\\]{font-size:11.5px}.text-\\[11px\\]{font-size:11px}.text-\\[12px\\]{font-size:12px}.leading-3{--tw-leading:calc(var(--spacing)*3);line-height:calc(var(--spacing)*3)}.leading-3\\.5{--tw-leading:calc(var(--spacing)*3.5);line-height:calc(var(--spacing)*3.5)}.leading-4{--tw-leading:calc(var(--spacing)*4);line-height:calc(var(--spacing)*4)}.leading-none{--tw-leading:1;line-height:1}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.wrap-break-word{overflow-wrap:break-word}.whitespace-normal{white-space:normal}.whitespace-nowrap{white-space:nowrap}.text-\\[\\#0C0C0C\\]{color:#0c0c0c}.text-\\[\\#47004A\\]{color:#47004a}.text-\\[\\#71717a\\]{color:#71717a}.text-\\[\\#B91C1C\\]{color:#b91c1c}.text-\\[\\#a1a1aa\\]{color:#a1a1aa}.text-\\[\\#c00002\\]{color:#c00002}.text-black{color:var(--color-black)}.text-black\\/50{color:#00000080}@supports (color:color-mix(in lab, red, red)){.text-black\\/50{color:color-mix(in oklab,var(--color-black)50%,transparent)}}.text-label-muted{color:var(--color-label-muted)}.text-label-tag-border{color:var(--color-label-tag-border)}.text-white{color:var(--color-white)}.italic{font-style:italic}.tabular-nums{--tw-numeric-spacing:tabular-nums;font-variant-numeric:var(--tw-ordinal,)var(--tw-slashed-zero,)var(--tw-numeric-figure,)var(--tw-numeric-spacing,)var(--tw-numeric-fraction,)}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.opacity-0{opacity:0}.opacity-50{opacity:.5}.opacity-100{opacity:1}.opacity-\\[0\\.99\\]{opacity:.99}.brightness-125{--tw-brightness:brightness(125%);filter:var(--tw-blur,)var(--tw-brightness,)var(--tw-contrast,)var(--tw-grayscale,)var(--tw-hue-rotate,)var(--tw-invert,)var(--tw-saturate,)var(--tw-sepia,)var(--tw-drop-shadow,)}.filter{filter:var(--tw-blur,)var(--tw-brightness,)var(--tw-contrast,)var(--tw-grayscale,)var(--tw-hue-rotate,)var(--tw-invert,)var(--tw-saturate,)var(--tw-sepia,)var(--tw-drop-shadow,)}.filter-\\[drop-shadow\\(0px_0px_4px_\\#51515180\\)\\]{filter:drop-shadow(0 0 4px #51515180)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter,display,content-visibility,overlay,pointer-events;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-\\[grid-template-rows\\]{transition-property:grid-template-rows;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-\\[width\\,height\\]{transition-property:width,height;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-all{transition-property:all;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-opacity{transition-property:opacity;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-none{transition-property:none}.duration-30{--tw-duration:30ms;transition-duration:30ms}.duration-100{--tw-duration:.1s;transition-duration:.1s}.duration-150{--tw-duration:.15s;transition-duration:.15s}.duration-300{--tw-duration:.3s;transition-duration:.3s}.ease-out{--tw-ease:var(--ease-out);transition-timing-function:var(--ease-out)}.will-change-\\[transform\\,width\\,height\\]{will-change:transform,width,height}.contain-layout{--tw-contain-layout:layout;contain:var(--tw-contain-size,)var(--tw-contain-layout,)var(--tw-contain-paint,)var(--tw-contain-style,)}.outline-none{--tw-outline-style:none;outline-style:none}.select-none{-webkit-user-select:none;user-select:none}.\\[font-synthesis\\:none\\]{font-synthesis:none}@media (hover:hover){.hover\\:scale-105:hover{--tw-scale-x:105%;--tw-scale-y:105%;--tw-scale-z:105%;scale:var(--tw-scale-x)var(--tw-scale-y)}.hover\\:bg-\\[\\#F5F5F5\\]:hover{background-color:#f5f5f5}.hover\\:bg-\\[\\#FEF2F2\\]:hover{background-color:#fef2f2}.hover\\:opacity-100:hover{opacity:1}}}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}@property --tw-scale-x{syntax:"*";inherits:false;initial-value:1}@property --tw-scale-y{syntax:"*";inherits:false;initial-value:1}@property --tw-scale-z{syntax:"*";inherits:false;initial-value:1}@property --tw-rotate-x{syntax:"*";inherits:false}@property --tw-rotate-y{syntax:"*";inherits:false}@property --tw-rotate-z{syntax:"*";inherits:false}@property --tw-skew-x{syntax:"*";inherits:false}@property --tw-skew-y{syntax:"*";inherits:false}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-ordinal{syntax:"*";inherits:false}@property --tw-slashed-zero{syntax:"*";inherits:false}@property --tw-numeric-figure{syntax:"*";inherits:false}@property --tw-numeric-spacing{syntax:"*";inherits:false}@property --tw-numeric-fraction{syntax:"*";inherits:false}@property --tw-blur{syntax:"*";inherits:false}@property --tw-brightness{syntax:"*";inherits:false}@property --tw-contrast{syntax:"*";inherits:false}@property --tw-grayscale{syntax:"*";inherits:false}@property --tw-hue-rotate{syntax:"*";inherits:false}@property --tw-invert{syntax:"*";inherits:false}@property --tw-opacity{syntax:"*";inherits:false}@property --tw-saturate{syntax:"*";inherits:false}@property --tw-sepia{syntax:"*";inherits:false}@property --tw-drop-shadow{syntax:"*";inherits:false}@property --tw-drop-shadow-color{syntax:"*";inherits:false}@property --tw-drop-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-drop-shadow-size{syntax:"*";inherits:false}@property --tw-duration{syntax:"*";inherits:false}@property --tw-ease{syntax:"*";inherits:false}@property --tw-contain-size{syntax:"*";inherits:false}@property --tw-contain-layout{syntax:"*";inherits:false}@property --tw-contain-paint{syntax:"*";inherits:false}@property --tw-contain-style{syntax:"*";inherits:false}@keyframes pulse{50%{opacity:.5}}`;var xa=["input","textarea","select","searchbox","slider","spinbutton","menuitem","menuitemcheckbox","menuitemradio","option","radio","textbox"],va=e=>!!e.tagName&&!e.tagName.startsWith("-")&&e.tagName.includes("-"),Sa=e=>Array.isArray(e),Ca=(e,t=false)=>{let{composed:n,target:r}=e,i,o;if(r instanceof HTMLElement&&va(r)&&n){let l=e.composedPath()[0];l instanceof HTMLElement&&(i=l.tagName,o=l.role);}else r instanceof HTMLElement&&(i=r.tagName,o=r.role);return Sa(t)?!!(i&&t&&t.some(a=>typeof i=="string"&&a.toLowerCase()===i.toLowerCase()||a===o)):!!(i&&t&&t)},tt=e=>Ca(e,xa);var ni=e=>{let t=e.tagName.toLowerCase();return !!(t==="input"||t==="textarea"||e instanceof HTMLElement&&e.isContentEditable)},ri=(e,t)=>{let n=document.activeElement;if(n){let r=n;for(;r;){if(ni(r))return  true;r=r.parentElement;}}if(e!==void 0&&t!==void 0){let r=document.elementsFromPoint(e,t);for(let i of r)if(ni(i))return  true}return  false};var Kt="data-react-grab",oi=e=>{let t=document.querySelector(`[${Kt}]`);if(t){let a=t.shadowRoot?.querySelector(`[${Kt}]`);if(a instanceof HTMLDivElement&&t.shadowRoot)return a}let n=document.createElement("div");n.setAttribute(Kt,"true"),n.style.zIndex="2147483646",n.style.position="fixed",n.style.top="0",n.style.left="0";let r=n.attachShadow({mode:"open"});{let a=document.createElement("style");a.textContent=e,r.appendChild(a);}let i=document.createElement("div");i.setAttribute(Kt,"true"),r.appendChild(i);let o=document.body??document.documentElement;return o.appendChild(n),setTimeout(()=>{o.contains(n)||o.appendChild(n);},1e3),i};var Ea="https://react-grab.com",Hn=(e,t)=>{let n=t?`&line=${t}`:"";return `${Ea}/open-file?url=${encodeURIComponent(e)}${n}`};var ii="0.0.88";var zn=["Meta","Control","Shift","Alt"],si='<svg width="294" height="294" viewBox="0 0 294 294" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_0_3)"><mask id="mask0_0_3" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="294" height="294"><path d="M294 0H0V294H294V0Z" fill="white"/></mask><g mask="url(#mask0_0_3)"><path d="M144.599 47.4924C169.712 27.3959 194.548 20.0265 212.132 30.1797C227.847 39.2555 234.881 60.3243 231.926 89.516C231.677 92.0069 231.328 94.5423 230.94 97.1058L228.526 110.14C228.517 110.136 228.505 110.132 228.495 110.127C228.486 110.165 228.479 110.203 228.468 110.24L216.255 105.741C216.256 105.736 216.248 105.728 216.248 105.723C207.915 103.125 199.421 101.075 190.82 99.5888L190.696 99.5588L173.526 97.2648L173.511 97.2631C173.492 97.236 173.467 97.2176 173.447 97.1905C163.862 96.2064 154.233 95.7166 144.599 95.7223C134.943 95.7162 125.295 96.219 115.693 97.2286C110.075 105.033 104.859 113.118 100.063 121.453C95.2426 129.798 90.8624 138.391 86.939 147.193C90.8624 155.996 95.2426 164.588 100.063 172.933C104.866 181.302 110.099 189.417 115.741 197.245C115.749 197.245 115.758 197.246 115.766 197.247L115.752 197.27L115.745 197.283L115.754 197.296L126.501 211.013L126.574 211.089C132.136 217.767 138.126 224.075 144.507 229.974L144.609 230.082L154.572 238.287C154.539 238.319 154.506 238.35 154.472 238.38C154.485 238.392 154.499 238.402 154.513 238.412L143.846 247.482L143.827 247.497C126.56 261.128 109.472 268.745 94.8019 268.745C88.5916 268.837 82.4687 267.272 77.0657 264.208C61.3496 255.132 54.3164 234.062 57.2707 204.871C57.528 202.307 57.8806 199.694 58.2904 197.054C28.3363 185.327 9.52301 167.51 9.52301 147.193C9.52301 129.042 24.2476 112.396 50.9901 100.375C53.3443 99.3163 55.7938 98.3058 58.2904 97.3526C57.8806 94.7023 57.528 92.0803 57.2707 89.516C54.3164 60.3243 61.3496 39.2555 77.0657 30.1797C94.6494 20.0265 119.486 27.3959 144.599 47.4924ZM70.6423 201.315C70.423 202.955 70.2229 204.566 70.0704 206.168C67.6686 229.567 72.5478 246.628 83.3615 252.988L83.5176 253.062C95.0399 259.717 114.015 254.426 134.782 238.38C125.298 229.45 116.594 219.725 108.764 209.314C95.8516 207.742 83.0977 205.066 70.6423 201.315ZM80.3534 163.438C77.34 171.677 74.8666 180.104 72.9484 188.664C81.1787 191.224 89.5657 193.247 98.0572 194.724L98.4618 194.813C95.2115 189.865 92.0191 184.66 88.9311 179.378C85.8433 174.097 83.003 168.768 80.3534 163.438ZM60.759 110.203C59.234 110.839 57.7378 111.475 56.27 112.11C34.7788 121.806 22.3891 134.591 22.3891 147.193C22.3891 160.493 36.4657 174.297 60.7494 184.26C63.7439 171.581 67.8124 159.182 72.9104 147.193C67.822 135.23 63.7566 122.855 60.759 110.203ZM98.4137 99.6404C89.8078 101.145 81.3075 103.206 72.9676 105.809C74.854 114.203 77.2741 122.468 80.2132 130.554L80.3059 130.939C82.9938 125.6 85.8049 120.338 88.8834 115.008C91.9618 109.679 95.1544 104.569 98.4137 99.6404ZM94.9258 38.5215C90.9331 38.4284 86.9866 39.3955 83.4891 41.3243C72.6291 47.6015 67.6975 64.5954 70.0424 87.9446L70.0416 88.2194C70.194 89.8208 70.3941 91.4325 70.6134 93.0624C83.0737 89.3364 95.8263 86.6703 108.736 85.0924C116.57 74.6779 125.28 64.9532 134.773 56.0249C119.877 44.5087 105.895 38.5215 94.9258 38.5215ZM205.737 41.3148C202.268 39.398 198.355 38.4308 194.394 38.5099L194.29 38.512C183.321 38.512 169.34 44.4991 154.444 56.0153C163.93 64.9374 172.634 74.6557 180.462 85.064C193.375 86.6345 206.128 89.3102 218.584 93.0624C218.812 91.4325 219.003 89.8118 219.165 88.2098C221.548 64.7099 216.65 47.6164 205.737 41.3148ZM144.552 64.3097C138.104 70.2614 132.054 76.6306 126.443 83.3765C132.39 82.995 138.426 82.8046 144.552 82.8046C150.727 82.8046 156.778 83.0143 162.707 83.3765C157.08 76.6293 151.015 70.2596 144.552 64.3097Z" fill="white"/><path d="M144.598 47.4924C169.712 27.3959 194.547 20.0265 212.131 30.1797C227.847 39.2555 234.88 60.3243 231.926 89.516C231.677 92.0069 231.327 94.5423 230.941 97.1058L228.526 110.14L228.496 110.127C228.487 110.165 228.478 110.203 228.469 110.24L216.255 105.741L216.249 105.723C207.916 103.125 199.42 101.075 190.82 99.5888L190.696 99.5588L173.525 97.2648L173.511 97.263C173.492 97.236 173.468 97.2176 173.447 97.1905C163.863 96.2064 154.234 95.7166 144.598 95.7223C134.943 95.7162 125.295 96.219 115.693 97.2286C110.075 105.033 104.859 113.118 100.063 121.453C95.2426 129.798 90.8622 138.391 86.939 147.193C90.8622 155.996 95.2426 164.588 100.063 172.933C104.866 181.302 110.099 189.417 115.741 197.245L115.766 197.247L115.752 197.27L115.745 197.283L115.754 197.296L126.501 211.013L126.574 211.089C132.136 217.767 138.126 224.075 144.506 229.974L144.61 230.082L154.572 238.287C154.539 238.319 154.506 238.35 154.473 238.38L154.512 238.412L143.847 247.482L143.827 247.497C126.56 261.13 109.472 268.745 94.8018 268.745C88.5915 268.837 82.4687 267.272 77.0657 264.208C61.3496 255.132 54.3162 234.062 57.2707 204.871C57.528 202.307 57.8806 199.694 58.2904 197.054C28.3362 185.327 9.52298 167.51 9.52298 147.193C9.52298 129.042 24.2476 112.396 50.9901 100.375C53.3443 99.3163 55.7938 98.3058 58.2904 97.3526C57.8806 94.7023 57.528 92.0803 57.2707 89.516C54.3162 60.3243 61.3496 39.2555 77.0657 30.1797C94.6493 20.0265 119.486 27.3959 144.598 47.4924ZM70.6422 201.315C70.423 202.955 70.2229 204.566 70.0704 206.168C67.6686 229.567 72.5478 246.628 83.3615 252.988L83.5175 253.062C95.0399 259.717 114.015 254.426 134.782 238.38C125.298 229.45 116.594 219.725 108.764 209.314C95.8515 207.742 83.0977 205.066 70.6422 201.315ZM80.3534 163.438C77.34 171.677 74.8666 180.104 72.9484 188.664C81.1786 191.224 89.5657 193.247 98.0572 194.724L98.4618 194.813C95.2115 189.865 92.0191 184.66 88.931 179.378C85.8433 174.097 83.003 168.768 80.3534 163.438ZM60.7589 110.203C59.234 110.839 57.7378 111.475 56.2699 112.11C34.7788 121.806 22.3891 134.591 22.3891 147.193C22.3891 160.493 36.4657 174.297 60.7494 184.26C63.7439 171.581 67.8124 159.182 72.9103 147.193C67.822 135.23 63.7566 122.855 60.7589 110.203ZM98.4137 99.6404C89.8078 101.145 81.3075 103.206 72.9676 105.809C74.8539 114.203 77.2741 122.468 80.2132 130.554L80.3059 130.939C82.9938 125.6 85.8049 120.338 88.8834 115.008C91.9618 109.679 95.1544 104.569 98.4137 99.6404ZM94.9258 38.5215C90.9331 38.4284 86.9866 39.3955 83.4891 41.3243C72.629 47.6015 67.6975 64.5954 70.0424 87.9446L70.0415 88.2194C70.194 89.8208 70.3941 91.4325 70.6134 93.0624C83.0737 89.3364 95.8262 86.6703 108.736 85.0924C116.57 74.6779 125.28 64.9532 134.772 56.0249C119.877 44.5087 105.895 38.5215 94.9258 38.5215ZM205.737 41.3148C202.268 39.398 198.355 38.4308 194.394 38.5099L194.291 38.512C183.321 38.512 169.34 44.4991 154.443 56.0153C163.929 64.9374 172.634 74.6557 180.462 85.064C193.374 86.6345 206.129 89.3102 218.584 93.0624C218.813 91.4325 219.003 89.8118 219.166 88.2098C221.548 64.7099 216.65 47.6164 205.737 41.3148ZM144.551 64.3097C138.103 70.2614 132.055 76.6306 126.443 83.3765C132.389 82.995 138.427 82.8046 144.551 82.8046C150.727 82.8046 156.779 83.0143 162.707 83.3765C157.079 76.6293 151.015 70.2596 144.551 64.3097Z" fill="#FF40E0"/></g><mask id="mask1_0_3" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="102" y="84" width="161" height="162"><path d="M235.282 84.827L102.261 112.259L129.693 245.28L262.714 217.848L235.282 84.827Z" fill="white"/></mask><g mask="url(#mask1_0_3)"><path d="M136.863 129.916L213.258 141.224C220.669 142.322 222.495 152.179 215.967 155.856L187.592 171.843L184.135 204.227C183.339 211.678 173.564 213.901 169.624 207.526L129.021 141.831C125.503 136.14 130.245 128.936 136.863 129.916Z" fill="#FF40E0" stroke="#FF40E0" stroke-width="0.817337" stroke-linecap="round" stroke-linejoin="round"/></g></g><defs><clipPath id="clip0_0_3"><rect width="294" height="294" fill="white"/></clipPath></defs></svg>';var wt=(e,t,n)=>e+(t-e)*n;function ai(e){var t,n,r="";if(typeof e=="string"||typeof e=="number")r+=e;else if(typeof e=="object")if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(n=ai(e[t]))&&(r&&(r+=" "),r+=n);}else for(n in e)e[n]&&(r&&(r+=" "),r+=n);return r}function li(){for(var e,t,n=0,r="",i=arguments.length;n<i;n++)(e=arguments[n])&&(t=ai(e))&&(r&&(r+=" "),r+=t);return r}var Tr="-",ka=e=>{let t=Aa(e),{conflictingClassGroups:n,conflictingClassGroupModifiers:r}=e;return {getClassGroupId:a=>{let l=a.split(Tr);return l[0]===""&&l.length!==1&&l.shift(),di(l,t)||Ta(a)},getConflictingClassGroupIds:(a,l)=>{let c=n[a]||[];return l&&r[a]?[...c,...r[a]]:c}}},di=(e,t)=>{if(e.length===0)return t.classGroupId;let n=e[0],r=t.nextPart.get(n),i=r?di(e.slice(1),r):void 0;if(i)return i;if(t.validators.length===0)return;let o=e.join(Tr);return t.validators.find(({validator:a})=>a(o))?.classGroupId},ci=/^\[(.+)\]$/,Ta=e=>{if(ci.test(e)){let t=ci.exec(e)[1],n=t?.substring(0,t.indexOf(":"));if(n)return "arbitrary.."+n}},Aa=e=>{let{theme:t,prefix:n}=e,r={nextPart:new Map,validators:[]};return Na(Object.entries(e.classGroups),n).forEach(([o,a])=>{kr(a,r,o,t);}),r},kr=(e,t,n,r)=>{e.forEach(i=>{if(typeof i=="string"){let o=i===""?t:ui(t,i);o.classGroupId=n;return}if(typeof i=="function"){if(_a(i)){kr(i(r),t,n,r);return}t.validators.push({validator:i,classGroupId:n});return}Object.entries(i).forEach(([o,a])=>{kr(a,ui(t,o),n,r);});});},ui=(e,t)=>{let n=e;return t.split(Tr).forEach(r=>{n.nextPart.has(r)||n.nextPart.set(r,{nextPart:new Map,validators:[]}),n=n.nextPart.get(r);}),n},_a=e=>e.isThemeGetter,Na=(e,t)=>t?e.map(([n,r])=>{let i=r.map(o=>typeof o=="string"?t+o:typeof o=="object"?Object.fromEntries(Object.entries(o).map(([a,l])=>[t+a,l])):o);return [n,i]}):e,Ra=e=>{if(e<1)return {get:()=>{},set:()=>{}};let t=0,n=new Map,r=new Map,i=(o,a)=>{n.set(o,a),t++,t>e&&(t=0,r=n,n=new Map);};return {get(o){let a=n.get(o);if(a!==void 0)return a;if((a=r.get(o))!==void 0)return i(o,a),a},set(o,a){n.has(o)?n.set(o,a):i(o,a);}}},fi="!",Ia=e=>{let{separator:t,experimentalParseClassName:n}=e,r=t.length===1,i=t[0],o=t.length,a=l=>{let c=[],u=0,g=0,p;for(let H=0;H<l.length;H++){let V=l[H];if(u===0){if(V===i&&(r||l.slice(H,H+o)===t)){c.push(l.slice(g,H)),g=H+o;continue}if(V==="/"){p=H;continue}}V==="["?u++:V==="]"&&u--;}let k=c.length===0?l:l.substring(g),y=k.startsWith(fi),x=y?k.substring(1):k,_=p&&p>g?p-g:void 0;return {modifiers:c,hasImportantModifier:y,baseClassName:x,maybePostfixModifierPosition:_}};return n?l=>n({className:l,parseClassName:a}):a},La=e=>{if(e.length<=1)return e;let t=[],n=[];return e.forEach(r=>{r[0]==="["?(t.push(...n.sort(),r),n=[]):n.push(r);}),t.push(...n.sort()),t},Ma=e=>({cache:Ra(e.cacheSize),parseClassName:Ia(e),...ka(e)}),Oa=/\s+/,Pa=(e,t)=>{let{parseClassName:n,getClassGroupId:r,getConflictingClassGroupIds:i}=t,o=[],a=e.trim().split(Oa),l="";for(let c=a.length-1;c>=0;c-=1){let u=a[c],{modifiers:g,hasImportantModifier:p,baseClassName:k,maybePostfixModifierPosition:y}=n(u),x=!!y,_=r(x?k.substring(0,y):k);if(!_){if(!x){l=u+(l.length>0?" "+l:l);continue}if(_=r(k),!_){l=u+(l.length>0?" "+l:l);continue}x=false;}let H=La(g).join(":"),V=p?H+fi:H,C=V+_;if(o.includes(C))continue;o.push(C);let $=i(_,x);for(let Z=0;Z<$.length;++Z){let v=$[Z];o.push(V+v);}l=u+(l.length>0?" "+l:l);}return l};function $a(){let e=0,t,n,r="";for(;e<arguments.length;)(t=arguments[e++])&&(n=mi(t))&&(r&&(r+=" "),r+=n);return r}var mi=e=>{if(typeof e=="string")return e;let t,n="";for(let r=0;r<e.length;r++)e[r]&&(t=mi(e[r]))&&(n&&(n+=" "),n+=t);return n};function Da(e,...t){let n,r,i,o=a;function a(c){let u=t.reduce((g,p)=>p(g),e());return n=Ma(u),r=n.cache.get,i=n.cache.set,o=l,l(c)}function l(c){let u=r(c);if(u)return u;let g=Pa(c,n);return i(c,g),g}return function(){return o($a.apply(null,arguments))}}var he=e=>{let t=n=>n[e]||[];return t.isThemeGetter=true,t},pi=/^\[(?:([a-z-]+):)?(.+)\]$/i,Fa=/^\d+\/\d+$/,Ba=new Set(["px","full","screen"]),Ha=/^(\d+(\.\d+)?)?(xs|sm|md|lg|xl)$/,za=/\d+(%|px|r?em|[sdl]?v([hwib]|min|max)|pt|pc|in|cm|mm|cap|ch|ex|r?lh|cq(w|h|i|b|min|max))|\b(calc|min|max|clamp)\(.+\)|^0$/,ja=/^(rgba?|hsla?|hwb|(ok)?(lab|lch))\(.+\)$/,Va=/^(inset_)?-?((\d+)?\.?(\d+)[a-z]+|0)_-?((\d+)?\.?(\d+)[a-z]+|0)/,Ua=/^(url|image|image-set|cross-fade|element|(repeating-)?(linear|radial|conic)-gradient)\(.+\)$/,ct=e=>Xt(e)||Ba.has(e)||Fa.test(e),xt=e=>Wt(e,"length",Ja),Xt=e=>!!e&&!Number.isNaN(Number(e)),Er=e=>Wt(e,"number",Xt),pn=e=>!!e&&Number.isInteger(Number(e)),Ga=e=>e.endsWith("%")&&Xt(e.slice(0,-1)),J=e=>pi.test(e),vt=e=>Ha.test(e),Ka=new Set(["length","size","percentage"]),Xa=e=>Wt(e,Ka,gi),Wa=e=>Wt(e,"position",gi),Ya=new Set(["image","url"]),qa=e=>Wt(e,Ya,el),Za=e=>Wt(e,"",Qa),gn=()=>true,Wt=(e,t,n)=>{let r=pi.exec(e);return r?r[1]?typeof t=="string"?r[1]===t:t.has(r[1]):n(r[2]):false},Ja=e=>za.test(e)&&!ja.test(e),gi=()=>false,Qa=e=>Va.test(e),el=e=>Ua.test(e);var tl=()=>{let e=he("colors"),t=he("spacing"),n=he("blur"),r=he("brightness"),i=he("borderColor"),o=he("borderRadius"),a=he("borderSpacing"),l=he("borderWidth"),c=he("contrast"),u=he("grayscale"),g=he("hueRotate"),p=he("invert"),k=he("gap"),y=he("gradientColorStops"),x=he("gradientColorStopPositions"),_=he("inset"),H=he("margin"),V=he("opacity"),C=he("padding"),$=he("saturate"),Z=he("scale"),v=he("sepia"),M=he("skew"),W=he("space"),z=he("translate"),q=()=>["auto","contain","none"],O=()=>["auto","hidden","clip","visible","scroll"],h=()=>["auto",J,t],m=()=>[J,t],f=()=>["",ct,xt],b=()=>["auto",Xt,J],L=()=>["bottom","center","left","left-bottom","left-top","right","right-bottom","right-top","top"],j=()=>["solid","dashed","dotted","double","none"],ne=()=>["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],te=()=>["start","end","center","between","around","evenly","stretch"],se=()=>["","0",J],S=()=>["auto","avoid","all","avoid-page","page","left","right","column"],D=()=>[Xt,J];return {cacheSize:500,separator:":",theme:{colors:[gn],spacing:[ct,xt],blur:["none","",vt,J],brightness:D(),borderColor:[e],borderRadius:["none","","full",vt,J],borderSpacing:m(),borderWidth:f(),contrast:D(),grayscale:se(),hueRotate:D(),invert:se(),gap:m(),gradientColorStops:[e],gradientColorStopPositions:[Ga,xt],inset:h(),margin:h(),opacity:D(),padding:m(),saturate:D(),scale:D(),sepia:se(),skew:D(),space:m(),translate:m()},classGroups:{aspect:[{aspect:["auto","square","video",J]}],container:["container"],columns:[{columns:[vt]}],"break-after":[{"break-after":S()}],"break-before":[{"break-before":S()}],"break-inside":[{"break-inside":["auto","avoid","avoid-page","avoid-column"]}],"box-decoration":[{"box-decoration":["slice","clone"]}],box:[{box:["border","content"]}],display:["block","inline-block","inline","flex","inline-flex","table","inline-table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row-group","table-row","flow-root","grid","inline-grid","contents","list-item","hidden"],float:[{float:["right","left","none","start","end"]}],clear:[{clear:["left","right","both","none","start","end"]}],isolation:["isolate","isolation-auto"],"object-fit":[{object:["contain","cover","fill","none","scale-down"]}],"object-position":[{object:[...L(),J]}],overflow:[{overflow:O()}],"overflow-x":[{"overflow-x":O()}],"overflow-y":[{"overflow-y":O()}],overscroll:[{overscroll:q()}],"overscroll-x":[{"overscroll-x":q()}],"overscroll-y":[{"overscroll-y":q()}],position:["static","fixed","absolute","relative","sticky"],inset:[{inset:[_]}],"inset-x":[{"inset-x":[_]}],"inset-y":[{"inset-y":[_]}],start:[{start:[_]}],end:[{end:[_]}],top:[{top:[_]}],right:[{right:[_]}],bottom:[{bottom:[_]}],left:[{left:[_]}],visibility:["visible","invisible","collapse"],z:[{z:["auto",pn,J]}],basis:[{basis:h()}],"flex-direction":[{flex:["row","row-reverse","col","col-reverse"]}],"flex-wrap":[{flex:["wrap","wrap-reverse","nowrap"]}],flex:[{flex:["1","auto","initial","none",J]}],grow:[{grow:se()}],shrink:[{shrink:se()}],order:[{order:["first","last","none",pn,J]}],"grid-cols":[{"grid-cols":[gn]}],"col-start-end":[{col:["auto",{span:["full",pn,J]},J]}],"col-start":[{"col-start":b()}],"col-end":[{"col-end":b()}],"grid-rows":[{"grid-rows":[gn]}],"row-start-end":[{row:["auto",{span:[pn,J]},J]}],"row-start":[{"row-start":b()}],"row-end":[{"row-end":b()}],"grid-flow":[{"grid-flow":["row","col","dense","row-dense","col-dense"]}],"auto-cols":[{"auto-cols":["auto","min","max","fr",J]}],"auto-rows":[{"auto-rows":["auto","min","max","fr",J]}],gap:[{gap:[k]}],"gap-x":[{"gap-x":[k]}],"gap-y":[{"gap-y":[k]}],"justify-content":[{justify:["normal",...te()]}],"justify-items":[{"justify-items":["start","end","center","stretch"]}],"justify-self":[{"justify-self":["auto","start","end","center","stretch"]}],"align-content":[{content:["normal",...te(),"baseline"]}],"align-items":[{items:["start","end","center","baseline","stretch"]}],"align-self":[{self:["auto","start","end","center","stretch","baseline"]}],"place-content":[{"place-content":[...te(),"baseline"]}],"place-items":[{"place-items":["start","end","center","baseline","stretch"]}],"place-self":[{"place-self":["auto","start","end","center","stretch"]}],p:[{p:[C]}],px:[{px:[C]}],py:[{py:[C]}],ps:[{ps:[C]}],pe:[{pe:[C]}],pt:[{pt:[C]}],pr:[{pr:[C]}],pb:[{pb:[C]}],pl:[{pl:[C]}],m:[{m:[H]}],mx:[{mx:[H]}],my:[{my:[H]}],ms:[{ms:[H]}],me:[{me:[H]}],mt:[{mt:[H]}],mr:[{mr:[H]}],mb:[{mb:[H]}],ml:[{ml:[H]}],"space-x":[{"space-x":[W]}],"space-x-reverse":["space-x-reverse"],"space-y":[{"space-y":[W]}],"space-y-reverse":["space-y-reverse"],w:[{w:["auto","min","max","fit","svw","lvw","dvw",J,t]}],"min-w":[{"min-w":[J,t,"min","max","fit"]}],"max-w":[{"max-w":[J,t,"none","full","min","max","fit","prose",{screen:[vt]},vt]}],h:[{h:[J,t,"auto","min","max","fit","svh","lvh","dvh"]}],"min-h":[{"min-h":[J,t,"min","max","fit","svh","lvh","dvh"]}],"max-h":[{"max-h":[J,t,"min","max","fit","svh","lvh","dvh"]}],size:[{size:[J,t,"auto","min","max","fit"]}],"font-size":[{text:["base",vt,xt]}],"font-smoothing":["antialiased","subpixel-antialiased"],"font-style":["italic","not-italic"],"font-weight":[{font:["thin","extralight","light","normal","medium","semibold","bold","extrabold","black",Er]}],"font-family":[{font:[gn]}],"fvn-normal":["normal-nums"],"fvn-ordinal":["ordinal"],"fvn-slashed-zero":["slashed-zero"],"fvn-figure":["lining-nums","oldstyle-nums"],"fvn-spacing":["proportional-nums","tabular-nums"],"fvn-fraction":["diagonal-fractions","stacked-fractions"],tracking:[{tracking:["tighter","tight","normal","wide","wider","widest",J]}],"line-clamp":[{"line-clamp":["none",Xt,Er]}],leading:[{leading:["none","tight","snug","normal","relaxed","loose",ct,J]}],"list-image":[{"list-image":["none",J]}],"list-style-type":[{list:["none","disc","decimal",J]}],"list-style-position":[{list:["inside","outside"]}],"placeholder-color":[{placeholder:[e]}],"placeholder-opacity":[{"placeholder-opacity":[V]}],"text-alignment":[{text:["left","center","right","justify","start","end"]}],"text-color":[{text:[e]}],"text-opacity":[{"text-opacity":[V]}],"text-decoration":["underline","overline","line-through","no-underline"],"text-decoration-style":[{decoration:[...j(),"wavy"]}],"text-decoration-thickness":[{decoration:["auto","from-font",ct,xt]}],"underline-offset":[{"underline-offset":["auto",ct,J]}],"text-decoration-color":[{decoration:[e]}],"text-transform":["uppercase","lowercase","capitalize","normal-case"],"text-overflow":["truncate","text-ellipsis","text-clip"],"text-wrap":[{text:["wrap","nowrap","balance","pretty"]}],indent:[{indent:m()}],"vertical-align":[{align:["baseline","top","middle","bottom","text-top","text-bottom","sub","super",J]}],whitespace:[{whitespace:["normal","nowrap","pre","pre-line","pre-wrap","break-spaces"]}],break:[{break:["normal","words","all","keep"]}],hyphens:[{hyphens:["none","manual","auto"]}],content:[{content:["none",J]}],"bg-attachment":[{bg:["fixed","local","scroll"]}],"bg-clip":[{"bg-clip":["border","padding","content","text"]}],"bg-opacity":[{"bg-opacity":[V]}],"bg-origin":[{"bg-origin":["border","padding","content"]}],"bg-position":[{bg:[...L(),Wa]}],"bg-repeat":[{bg:["no-repeat",{repeat:["","x","y","round","space"]}]}],"bg-size":[{bg:["auto","cover","contain",Xa]}],"bg-image":[{bg:["none",{"gradient-to":["t","tr","r","br","b","bl","l","tl"]},qa]}],"bg-color":[{bg:[e]}],"gradient-from-pos":[{from:[x]}],"gradient-via-pos":[{via:[x]}],"gradient-to-pos":[{to:[x]}],"gradient-from":[{from:[y]}],"gradient-via":[{via:[y]}],"gradient-to":[{to:[y]}],rounded:[{rounded:[o]}],"rounded-s":[{"rounded-s":[o]}],"rounded-e":[{"rounded-e":[o]}],"rounded-t":[{"rounded-t":[o]}],"rounded-r":[{"rounded-r":[o]}],"rounded-b":[{"rounded-b":[o]}],"rounded-l":[{"rounded-l":[o]}],"rounded-ss":[{"rounded-ss":[o]}],"rounded-se":[{"rounded-se":[o]}],"rounded-ee":[{"rounded-ee":[o]}],"rounded-es":[{"rounded-es":[o]}],"rounded-tl":[{"rounded-tl":[o]}],"rounded-tr":[{"rounded-tr":[o]}],"rounded-br":[{"rounded-br":[o]}],"rounded-bl":[{"rounded-bl":[o]}],"border-w":[{border:[l]}],"border-w-x":[{"border-x":[l]}],"border-w-y":[{"border-y":[l]}],"border-w-s":[{"border-s":[l]}],"border-w-e":[{"border-e":[l]}],"border-w-t":[{"border-t":[l]}],"border-w-r":[{"border-r":[l]}],"border-w-b":[{"border-b":[l]}],"border-w-l":[{"border-l":[l]}],"border-opacity":[{"border-opacity":[V]}],"border-style":[{border:[...j(),"hidden"]}],"divide-x":[{"divide-x":[l]}],"divide-x-reverse":["divide-x-reverse"],"divide-y":[{"divide-y":[l]}],"divide-y-reverse":["divide-y-reverse"],"divide-opacity":[{"divide-opacity":[V]}],"divide-style":[{divide:j()}],"border-color":[{border:[i]}],"border-color-x":[{"border-x":[i]}],"border-color-y":[{"border-y":[i]}],"border-color-s":[{"border-s":[i]}],"border-color-e":[{"border-e":[i]}],"border-color-t":[{"border-t":[i]}],"border-color-r":[{"border-r":[i]}],"border-color-b":[{"border-b":[i]}],"border-color-l":[{"border-l":[i]}],"divide-color":[{divide:[i]}],"outline-style":[{outline:["",...j()]}],"outline-offset":[{"outline-offset":[ct,J]}],"outline-w":[{outline:[ct,xt]}],"outline-color":[{outline:[e]}],"ring-w":[{ring:f()}],"ring-w-inset":["ring-inset"],"ring-color":[{ring:[e]}],"ring-opacity":[{"ring-opacity":[V]}],"ring-offset-w":[{"ring-offset":[ct,xt]}],"ring-offset-color":[{"ring-offset":[e]}],shadow:[{shadow:["","inner","none",vt,Za]}],"shadow-color":[{shadow:[gn]}],opacity:[{opacity:[V]}],"mix-blend":[{"mix-blend":[...ne(),"plus-lighter","plus-darker"]}],"bg-blend":[{"bg-blend":ne()}],filter:[{filter:["","none"]}],blur:[{blur:[n]}],brightness:[{brightness:[r]}],contrast:[{contrast:[c]}],"drop-shadow":[{"drop-shadow":["","none",vt,J]}],grayscale:[{grayscale:[u]}],"hue-rotate":[{"hue-rotate":[g]}],invert:[{invert:[p]}],saturate:[{saturate:[$]}],sepia:[{sepia:[v]}],"backdrop-filter":[{"backdrop-filter":["","none"]}],"backdrop-blur":[{"backdrop-blur":[n]}],"backdrop-brightness":[{"backdrop-brightness":[r]}],"backdrop-contrast":[{"backdrop-contrast":[c]}],"backdrop-grayscale":[{"backdrop-grayscale":[u]}],"backdrop-hue-rotate":[{"backdrop-hue-rotate":[g]}],"backdrop-invert":[{"backdrop-invert":[p]}],"backdrop-opacity":[{"backdrop-opacity":[V]}],"backdrop-saturate":[{"backdrop-saturate":[$]}],"backdrop-sepia":[{"backdrop-sepia":[v]}],"border-collapse":[{border:["collapse","separate"]}],"border-spacing":[{"border-spacing":[a]}],"border-spacing-x":[{"border-spacing-x":[a]}],"border-spacing-y":[{"border-spacing-y":[a]}],"table-layout":[{table:["auto","fixed"]}],caption:[{caption:["top","bottom"]}],transition:[{transition:["none","all","","colors","opacity","shadow","transform",J]}],duration:[{duration:D()}],ease:[{ease:["linear","in","out","in-out",J]}],delay:[{delay:D()}],animate:[{animate:["none","spin","ping","pulse","bounce",J]}],transform:[{transform:["","gpu","none"]}],scale:[{scale:[Z]}],"scale-x":[{"scale-x":[Z]}],"scale-y":[{"scale-y":[Z]}],rotate:[{rotate:[pn,J]}],"translate-x":[{"translate-x":[z]}],"translate-y":[{"translate-y":[z]}],"skew-x":[{"skew-x":[M]}],"skew-y":[{"skew-y":[M]}],"transform-origin":[{origin:["center","top","top-right","right","bottom-right","bottom","bottom-left","left","top-left",J]}],accent:[{accent:["auto",e]}],appearance:[{appearance:["none","auto"]}],cursor:[{cursor:["auto","default","pointer","wait","text","move","help","not-allowed","none","context-menu","progress","cell","crosshair","vertical-text","alias","copy","no-drop","grab","grabbing","all-scroll","col-resize","row-resize","n-resize","e-resize","s-resize","w-resize","ne-resize","nw-resize","se-resize","sw-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out",J]}],"caret-color":[{caret:[e]}],"pointer-events":[{"pointer-events":["none","auto"]}],resize:[{resize:["none","y","x",""]}],"scroll-behavior":[{scroll:["auto","smooth"]}],"scroll-m":[{"scroll-m":m()}],"scroll-mx":[{"scroll-mx":m()}],"scroll-my":[{"scroll-my":m()}],"scroll-ms":[{"scroll-ms":m()}],"scroll-me":[{"scroll-me":m()}],"scroll-mt":[{"scroll-mt":m()}],"scroll-mr":[{"scroll-mr":m()}],"scroll-mb":[{"scroll-mb":m()}],"scroll-ml":[{"scroll-ml":m()}],"scroll-p":[{"scroll-p":m()}],"scroll-px":[{"scroll-px":m()}],"scroll-py":[{"scroll-py":m()}],"scroll-ps":[{"scroll-ps":m()}],"scroll-pe":[{"scroll-pe":m()}],"scroll-pt":[{"scroll-pt":m()}],"scroll-pr":[{"scroll-pr":m()}],"scroll-pb":[{"scroll-pb":m()}],"scroll-pl":[{"scroll-pl":m()}],"snap-align":[{snap:["start","end","center","align-none"]}],"snap-stop":[{snap:["normal","always"]}],"snap-type":[{snap:["none","x","y","both"]}],"snap-strictness":[{snap:["mandatory","proximity"]}],touch:[{touch:["auto","none","manipulation"]}],"touch-x":[{"touch-pan":["x","left","right"]}],"touch-y":[{"touch-pan":["y","up","down"]}],"touch-pz":["touch-pinch-zoom"],select:[{select:["none","text","all","auto"]}],"will-change":[{"will-change":["auto","scroll","contents","transform",J]}],fill:[{fill:[e,"none"]}],"stroke-w":[{stroke:[ct,xt,Er]}],stroke:[{stroke:[e,"none"]}],sr:["sr-only","not-sr-only"],"forced-color-adjust":[{"forced-color-adjust":["auto","none"]}]},conflictingClassGroups:{overflow:["overflow-x","overflow-y"],overscroll:["overscroll-x","overscroll-y"],inset:["inset-x","inset-y","start","end","top","right","bottom","left"],"inset-x":["right","left"],"inset-y":["top","bottom"],flex:["basis","grow","shrink"],gap:["gap-x","gap-y"],p:["px","py","ps","pe","pt","pr","pb","pl"],px:["pr","pl"],py:["pt","pb"],m:["mx","my","ms","me","mt","mr","mb","ml"],mx:["mr","ml"],my:["mt","mb"],size:["w","h"],"font-size":["leading"],"fvn-normal":["fvn-ordinal","fvn-slashed-zero","fvn-figure","fvn-spacing","fvn-fraction"],"fvn-ordinal":["fvn-normal"],"fvn-slashed-zero":["fvn-normal"],"fvn-figure":["fvn-normal"],"fvn-spacing":["fvn-normal"],"fvn-fraction":["fvn-normal"],"line-clamp":["display","overflow"],rounded:["rounded-s","rounded-e","rounded-t","rounded-r","rounded-b","rounded-l","rounded-ss","rounded-se","rounded-ee","rounded-es","rounded-tl","rounded-tr","rounded-br","rounded-bl"],"rounded-s":["rounded-ss","rounded-es"],"rounded-e":["rounded-se","rounded-ee"],"rounded-t":["rounded-tl","rounded-tr"],"rounded-r":["rounded-tr","rounded-br"],"rounded-b":["rounded-br","rounded-bl"],"rounded-l":["rounded-tl","rounded-bl"],"border-spacing":["border-spacing-x","border-spacing-y"],"border-w":["border-w-s","border-w-e","border-w-t","border-w-r","border-w-b","border-w-l"],"border-w-x":["border-w-r","border-w-l"],"border-w-y":["border-w-t","border-w-b"],"border-color":["border-color-s","border-color-e","border-color-t","border-color-r","border-color-b","border-color-l"],"border-color-x":["border-color-r","border-color-l"],"border-color-y":["border-color-t","border-color-b"],"scroll-m":["scroll-mx","scroll-my","scroll-ms","scroll-me","scroll-mt","scroll-mr","scroll-mb","scroll-ml"],"scroll-mx":["scroll-mr","scroll-ml"],"scroll-my":["scroll-mt","scroll-mb"],"scroll-p":["scroll-px","scroll-py","scroll-ps","scroll-pe","scroll-pt","scroll-pr","scroll-pb","scroll-pl"],"scroll-px":["scroll-pr","scroll-pl"],"scroll-py":["scroll-pt","scroll-pb"],touch:["touch-x","touch-y","touch-pz"],"touch-x":["touch"],"touch-y":["touch"],"touch-pz":["touch"]},conflictingClassGroupModifiers:{"font-size":["leading"]}}};var hi=Da(tl);var je=(...e)=>hi(li(e));var rl=K("<div style=overflow:visible>"),Rt=e=>{let[t,n]=N(e.bounds.x),[r,i]=N(e.bounds.y),[o,a]=N(e.bounds.width),[l,c]=N(e.bounds.height),[u,g]=N(1),p=false,k=null,y=null,x=e.bounds,_=false,H=()=>e.lerpFactor!==void 0?e.lerpFactor:e.variant==="drag"?.7:.95,V=()=>{if(_)return;_=true;let C=()=>{let $=wt(t(),x.x,H()),Z=wt(r(),x.y,H()),v=wt(o(),x.width,H()),M=wt(l(),x.height,H());n($),i(Z),a(v),c(M),Math.abs($-x.x)<.5&&Math.abs(Z-x.y)<.5&&Math.abs(v-x.width)<.5&&Math.abs(M-x.height)<.5?(k=null,_=false):k=requestAnimationFrame(C);};k=requestAnimationFrame(C);};return oe(Pe(()=>e.bounds,C=>{if(x=C,!p){n(x.x),i(x.y),a(x.width),c(x.height),p=true;return}V();})),oe(()=>{e.variant==="grabbed"&&e.createdAt&&(y=window.setTimeout(()=>{g(0);},1500));}),be(()=>{k!==null&&(cancelAnimationFrame(k),k=null),y!==null&&(window.clearTimeout(y),y=null),_=false;}),A(Q,{get when(){return e.visible!==false},get children(){var C=rl();return de($=>{var Z=je("fixed box-border",e.variant==="drag"&&"pointer-events-none",e.variant!=="drag"&&"pointer-events-auto",e.variant==="grabbed"&&"z-2147483645",e.variant!=="grabbed"&&"z-2147483646",e.variant==="drag"&&"border border-solid border-grab-purple/40 bg-grab-purple/5 will-change-[transform,width,height] cursor-crosshair",e.variant==="selection"&&"border border-solid border-grab-purple/50 bg-grab-purple/8 transition-opacity duration-100 ease-out",e.variant==="grabbed"&&"border border-solid border-grab-purple/50 bg-grab-purple/8",e.variant==="processing"&&!e.isCompleted&&"border border-solid border-grab-purple/50 bg-grab-purple/8",e.variant==="processing"&&e.isCompleted&&"border border-solid border-grab-purple/50 bg-grab-purple/8"),v=`${r()}px`,M=`${t()}px`,W=`${o()}px`,z=`${l()}px`,q=e.bounds.borderRadius,O=e.bounds.transform,h=e.isFading?0:u(),m=e.variant==="drag"?"layout paint size":void 0;return Z!==$.e&&Ge(C,$.e=Z),v!==$.t&&_e(C,"top",$.t=v),M!==$.a&&_e(C,"left",$.a=M),W!==$.o&&_e(C,"width",$.o=W),z!==$.i&&_e(C,"height",$.i=z),q!==$.n&&_e(C,"border-radius",$.n=q),O!==$.s&&_e(C,"transform",$.s=O),h!==$.h&&_e(C,"opacity",$.h=h),m!==$.r&&_e(C,"contain",$.r=m),$},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),C}})};var bi=e=>{let t=e.lerpFactor??.3,n=e.convergenceThreshold??.5,[r,i]=N(e.x()),[o,a]=N(e.y()),l=e.x(),c=e.y(),u=null,g=false,p=()=>{let y=wt(r(),l,t),x=wt(o(),c,t);i(y),a(x),Math.abs(y-l)<n&&Math.abs(x-c)<n?u=null:u=requestAnimationFrame(p);},k=()=>{u===null&&(u=requestAnimationFrame(p));};return oe(()=>{if(l=e.x(),c=e.y(),!g){i(l),a(c),g=true;return}k();}),be(()=>{u!==null&&(cancelAnimationFrame(u),u=null);}),{x:r,y:o}};var ol=K('<canvas class="fixed top-0 left-0 pointer-events-none z-[2147483645]">'),yi=e=>{let t,n=null,r=0,i=0,o=1,a=bi({x:()=>e.mouseX,y:()=>e.mouseY,lerpFactor:.3}),l=()=>{t&&(o=Math.max(window.devicePixelRatio||1,2),r=window.innerWidth,i=window.innerHeight,t.width=r*o,t.height=i*o,t.style.width=`${r}px`,t.style.height=`${i}px`,n=t.getContext("2d"),n&&n.scale(o,o));},c=()=>{n&&(n.clearRect(0,0,r,i),n.strokeStyle="rgba(210, 57, 192)",n.lineWidth=1,n.beginPath(),n.moveTo(a.x(),0),n.lineTo(a.x(),i),n.moveTo(0,a.y()),n.lineTo(r,a.y()),n.stroke());};return oe(()=>{l(),c();let u=()=>{l(),c();};window.addEventListener("resize",u),be(()=>{window.removeEventListener("resize",u);});}),oe(()=>{a.x(),a.y(),c();}),A(Q,{get when(){return e.visible!==false},get children(){var u=ol(),g=t;return typeof g=="function"?Gt(g,u):t=u,u}})};var wi=e=>{let t,[n,r]=N(false),i=()=>typeof window<"u"&&(!!window.SpeechRecognition||!!window.webkitSpeechRecognition),o=()=>{if(!i())return;let c=window.SpeechRecognition||window.webkitSpeechRecognition;if(!c)return;t=new c,t.continuous=true,t.interimResults=true,t.lang=navigator.language||"en-US";let u="",g="";t.onresult=p=>{let k=e.getCurrentValue(),y;u&&k.endsWith(u)||k===g&&u?y=k.slice(0,-u.length):y=k;let x="",_="";for(let V=p.resultIndex;V<p.results.length;V++){let C=p.results[V][0].transcript;p.results[V].isFinal?x+=C:_+=C;}u=_;let H=y+x+_;g=H,e.onTranscript(H);},t.onerror=()=>{r(false);},t.onend=()=>{r(false);},t.start(),r(true);},a=()=>{t&&(t.stop(),t=void 0),r(false);},l=()=>{n()?a():o();};return be(()=>{a();}),{isListening:n,isSupported:i,start:o,stop:a,toggle:l}};var il=K('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M12 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6"></path><path d="M11 13l9-9"></path><path d="M15 4h5v5">'),xi=e=>{let t=()=>e.size??12;return (()=>{var n=il();return de(r=>{var i=t(),o=t(),a=e.class;return i!==r.e&&ve(n,"width",r.e=i),o!==r.t&&ve(n,"height",r.t=o),a!==r.a&&ve(n,"class",r.a=a),r},{e:void 0,t:void 0,a:void 0}),n})()};var sl=K('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1=12 x2=12 y1=19 y2=22>'),vi=e=>{let t=()=>e.size??12;return (()=>{var n=sl();return de(r=>{var i=t(),o=t(),a=e.class;return i!==r.e&&ve(n,"width",r.e=i),o!==r.t&&ve(n,"height",r.t=o),a!==r.a&&ve(n,"class",r.a=a),r},{e:void 0,t:void 0,a:void 0}),n})()};var al=K('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 22 19"fill=none><path d="M6.76263 18.6626C7.48251 18.6626 7.95474 18.1682 7.95474 17.4895C7.95474 17.1207 7.80474 16.8576 7.58683 16.6361L5.3018 14.4137L2.84621 12.3589L2.44374 13.0037L5.92137 13.1622H17.9232C20.4842 13.1622 21.593 12.021 21.593 9.47237V3.66983C21.593 1.10875 20.4842 0 17.9232 0H12.5414C11.8179 0 11.3018 0.545895 11.3018 1.21695C11.3018 1.888 11.8179 2.43389 12.5414 2.43389H17.8424C18.7937 2.43389 19.1897 2.83653 19.1897 3.78784V9.35747C19.1897 10.3257 18.7937 10.7314 17.8424 10.7314H5.92137L2.44374 10.8832L2.84621 11.5281L5.3018 9.47993L7.58683 7.2606C7.80474 7.03914 7.95474 6.7693 7.95474 6.40049C7.95474 5.72854 7.48251 5.22747 6.76263 5.22747C6.46129 5.22747 6.12975 5.36905 5.89231 5.6096L0.376815 11.0425C0.134921 11.2777 0 11.6141 0 11.9452C0 12.2728 0.134921 12.6158 0.376815 12.848L5.89231 18.2871C6.12975 18.5276 6.46129 18.6626 6.76263 18.6626Z"fill=currentColor>'),hn=e=>{let t=()=>e.size??12;return (()=>{var n=al();return de(r=>{var i=t(),o=t()*19/22,a=e.class;return i!==r.e&&ve(n,"width",r.e=i),o!==r.t&&ve(n,"height",r.t=o),a!==r.a&&ve(n,"class",r.a=a),r},{e:void 0,t:void 0,a:void 0}),n})()};var ll=K('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"fill=none><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"fill=currentColor>'),Si=e=>{let t=()=>e.size??12;return (()=>{var n=ll();return de(r=>{var i=t(),o=t(),a=e.class;return i!==r.e&&ve(n,"width",r.e=i),o!==r.t&&ve(n,"height",r.t=o),a!==r.a&&ve(n,"class",r.a=a),r},{e:void 0,t:void 0,a:void 0}),n})()};var cl=K('<div style="background-image:linear-gradient(in oklab 180deg, oklab(88.7% 0.086 -0.058) 0%, oklab(83.2% 0.132 -0.089) 100%)"><span>'),ul=K('<div class="contain-layout shrink-0 flex items-center w-fit h-4 rounded-[1px] gap-1 px-[3px] [border-width:0.5px] border-solid border-[#B3B3B3] py-0 bg-[#F7F7F7]"><span class="text-[#0C0C0C] text-[11.5px] leading-3.5 shrink-0 font-medium w-fit h-fit">'),dl=K('<div class="contain-layout shrink-0 flex items-center w-fit h-4 rounded-[1px] gap-1 px-[3px] [border-width:0.5px] border-solid border-white py-0"><span class="text-[#0C0C0C] text-[11.5px] leading-3.5 shrink-0 font-medium w-fit h-fit">&gt;'),fl=K('<div class="absolute w-0 h-0"style="border-left:8px solid transparent;border-right:8px solid transparent">'),ml=K('<div role=button><div class="text-black text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit">'),pl=K('<div class="[font-synthesis:none] contain-layout shrink-0 flex flex-col items-start px-2 py-[5px] w-auto h-fit self-stretch [border-top-width:0.5px] border-t-solid border-t-[#D9D9D9] antialiased rounded-t-none rounded-b-xs -mt-px"style="background-image:linear-gradient(in oklab 180deg, oklab(100% 0 0) 0%, oklab(96.1% 0 0) 5.92%)">'),gl=K('<div class="contain-layout shrink-0 flex items-center justify-end gap-[5px] w-full h-fit"><button class="contain-layout shrink-0 flex items-center justify-center px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] cursor-pointer transition-all hover:bg-[#F5F5F5] h-[17px]"><span class="text-black text-[11px] leading-3.5 font-sans font-medium">No</span></button><button class="contain-layout shrink-0 flex items-center justify-center gap-1 px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#7e0002] cursor-pointer transition-all hover:bg-[#FEF2F2] h-[17px]"><span class="text-[#B91C1C] text-[11px] leading-3.5 font-sans font-medium">Yes'),hl=K('<div class="contain-layout shrink-0 flex flex-col justify-center items-end gap-1 w-fit h-fit"><div class="contain-layout shrink-0 flex items-center gap-1 pt-1 px-1.5 w-full h-fit"><span class="text-black text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit">Discard?'),bl=K('<div class="contain-layout shrink-0 flex items-center justify-end gap-[5px] w-full h-fit"><button class="contain-layout shrink-0 flex items-center justify-center gap-1 px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] cursor-pointer transition-all hover:bg-[#F5F5F5] h-[17px]"><span class="text-black text-[11px] leading-3.5 font-sans font-medium">Retry</span></button><button class="contain-layout shrink-0 flex items-center justify-center gap-1 px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] cursor-pointer transition-all hover:bg-[#F5F5F5] h-[17px]"><span class="text-black text-[11px] leading-3.5 font-sans font-medium">Ok'),yl=K('<div class="contain-layout shrink-0 flex flex-col justify-center items-end gap-1 w-fit h-fit max-w-[280px]"><div class="contain-layout shrink-0 flex items-center gap-1 pt-1 px-1.5 w-full h-fit"><span class="text-[#B91C1C] text-[12px] leading-4 font-sans font-medium">'),wl=K('<button class="contain-layout shrink-0 flex items-center justify-center px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#7e0002] cursor-pointer transition-all hover:bg-[#FEF2F2] h-[17px]"><span class="text-[#B91C1C] text-[11px] leading-3.5 font-sans font-medium">Undo'),xl=K('<button class="contain-layout shrink-0 flex items-center justify-center px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] cursor-pointer transition-all hover:bg-[#F5F5F5] h-[17px]"><span class="text-black text-[11px] leading-3.5 font-sans font-medium">Reply'),vl=K('<button class="contain-layout shrink-0 flex items-center justify-center gap-1 px-[3px] py-px rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] cursor-pointer transition-all hover:bg-[#F5F5F5] h-[17px]"><span class="text-black text-[11px] leading-3.5 font-sans font-medium">'),Sl=K('<div class="contain-layout shrink-0 flex items-center justify-end gap-[5px] w-full h-fit">'),Cl=K('<div class="[font-synthesis:none] contain-layout shrink-0 flex flex-col justify-center items-end rounded-xs bg-white antialiased w-fit h-fit"><div class="contain-layout shrink-0 flex items-center gap-1 pt-1.5 pb-1 px-1.5 w-full h-fit"><span class="text-black text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit tabular-nums">'),El=K('<button data-react-grab-ignore-events class="contain-layout shrink-0 flex flex-col items-start rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] p-1 size-fit cursor-pointer ml-1 transition-none hover:scale-105"><div data-react-grab-ignore-events class="shrink-0 w-[7px] h-[7px] rounded-[1px] bg-black pointer-events-none">'),kl=K('<div class="shrink-0 flex justify-between items-end w-full min-h-4"><textarea data-react-grab-ignore-events class="text-black text-[12px] leading-4 font-medium bg-transparent border-none outline-none resize-none flex-1 p-0 m-0 opacity-50 wrap-break-word overflow-y-auto"placeholder="type to edit"rows=1 disabled style=field-sizing:content;min-height:16px;max-height:95px;scrollbar-width:none>'),Tl=K('<div class="contain-layout shrink-0 flex flex-col justify-center items-start gap-1 w-fit h-fit max-w-[280px]"><div class="contain-layout shrink-0 flex items-center gap-1 pt-1 px-1.5 w-auto h-fit"><div class="contain-layout flex items-center px-0 py-px w-auto h-fit rounded-[1.5px] gap-[3px]"><span class="text-[12px] leading-4 font-sans font-medium w-auto h-fit whitespace-normal text-[#71717a] animate-pulse tabular-nums">'),Ci=K('<div class="contain-layout shrink-0 flex items-center gap-px w-fit h-fit">'),Al=K('<span class="text-label-muted text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit">Double click to edit'),_l=K('<div class="contain-layout shrink-0 flex flex-col items-start px-[3px] py-[3px] rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] size-fit">'),Nl=K('<span class="text-label-muted text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit">Press'),Rl=K('<div class="contain-layout shrink-0 flex items-center justify-center px-[3px] py-[2px] rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] size-fit"><span class="text-[9px] leading-none font-medium text-black">Esc'),Il=K('<span class="text-label-muted text-[12px] leading-4 shrink-0 font-sans font-medium w-fit h-fit">to dismiss'),Ll=K('<div class="contain-layout shrink-0 flex items-center gap-1 w-fit h-fit">'),Ml=K('<div class="contain-layout shrink-0 flex flex-col justify-center items-start gap-1 w-fit h-fit"><div></div><div class="grid transition-[grid-template-rows] duration-30 ease-out self-stretch"><div>'),Ol=K('<div class="shrink-0 flex items-center gap-0.5 w-full mb-0.5 overflow-hidden"><span class="text-[#a1a1aa] text-[9px] leading-3 shrink-0">>previously:</span><span class="text-[#a1a1aa] text-[9px] leading-3 italic truncate whitespace-nowrap">'),Pl=K("<button>"),$l=K('<button class="contain-layout shrink-0 flex flex-col items-start px-[3px] py-[3px] rounded-xs bg-white [border-width:0.5px] border-solid border-[#B3B3B3] size-fit cursor-pointer transition-all hover:scale-105">'),Dl=K('<div class="shrink-0 flex justify-between items-end w-full min-h-4"><textarea data-react-grab-ignore-events class="text-black text-[12px] leading-4 font-medium bg-transparent border-none outline-none resize-none flex-1 p-0 m-0 wrap-break-word overflow-y-auto"rows=1 style=field-sizing:content;min-height:16px;max-height:95px;scrollbar-width:none></textarea><div class="flex items-center gap-0.5 ml-1 w-[17px] h-[17px] justify-end">'),Fl=K('<div class="contain-layout shrink-0 flex flex-col justify-center items-start gap-1 w-fit h-fit max-w-[280px]"><div>'),Bl=K('<div data-react-grab-ignore-events class="fixed font-sans antialiased transition-opacity duration-300 ease-out filter-[drop-shadow(0px_0px_4px_#51515180)] select-none"style=z-index:2147483647><div class="[font-synthesis:none] contain-layout flex items-center gap-[5px] rounded-xs bg-white antialiased w-fit h-fit p-0">'),Ei=8,ki=4,Hl=400;var jn=e=>{let[t,n]=N(false),r=()=>{n(true),e.onHoverChange?.(true);},i=()=>{n(false),e.onHoverChange?.(false);};return (()=>{var o=cl(),a=o.firstChild;return yt(o,"click",e.onClick),o.addEventListener("mouseleave",i),o.addEventListener("mouseenter",r),B(a,()=>e.tagName),B(o,A(Q,{get when(){return e.isClickable||e.forceShowIcon},get children(){return A(xi,{size:10,get class(){return je("text-label-tag-border transition-all duration-100",t()||e.forceShowIcon?"opacity-100 scale-100":"opacity-0 scale-75 -ml-[2px] w-0")}})}}),null),de(l=>{var c=je("contain-layout flex items-center px-[3px] py-0 h-4 rounded-[1px] gap-0.5 [border-width:0.5px] border-solid border-label-tag-border",e.shrink&&"shrink-0 w-fit",e.isClickable&&"cursor-pointer"),u=je("text-[#47004A] text-[11.5px] leading-3.5 shrink-0 w-fit h-fit font-medium");return c!==l.e&&Ge(o,l.e=c),u!==l.t&&Ge(a,l.t=u),l},{e:void 0,t:void 0}),o})()},Ti=e=>(()=>{var t=ul(),n=t.firstChild;return B(n,()=>e.name),t})(),Ai=()=>dl(),zl=e=>{let t=()=>e.color??"white";return (()=>{var n=fl();return de(r=>ei(n,{left:`${e.leftPx}px`,...e.position==="bottom"?{top:"0",transform:"translateX(-50%) translateY(-100%)"}:{bottom:"0",transform:"translateX(-50%) translateY(100%)"},...e.position==="bottom"?{"border-bottom":`8px solid ${t()}`}:{"border-top":`8px solid ${t()}`}},r)),n})()},_i=e=>{let t=()=>e.hasAgent?"Selecting":e.hasParent?"Copy":"Click to copy";return (()=>{var n=ml(),r=n.firstChild;return yt(n,"click",e.onClick),B(r,t),de(()=>Ge(n,je("contain-layout shrink-0 flex items-center px-0 py-px w-fit h-[18px] rounded-[1.5px] gap-[3px]",e.asButton&&"cursor-pointer",e.dimmed&&"opacity-50 hover:opacity-100 transition-opacity"))),n})()};var Yt=e=>(()=>{var t=pl();return B(t,()=>e.children),t})(),$e=null,Ni=e=>{let t=Symbol(),n=i=>{$e===t&&(tt(i)||(i.code==="Enter"||i.code==="Escape")&&(i.preventDefault(),i.stopPropagation(),e.onConfirm?.()));},r=()=>{$e=t;};return mn(()=>{$e=t,window.addEventListener("keydown",n,{capture:true});}),be(()=>{$e===t&&($e=null),window.removeEventListener("keydown",n,{capture:true});}),(()=>{var i=hl();i.firstChild;return i.$$click=r,i.$$pointerdown=r,B(i,A(Yt,{get children(){var a=gl(),l=a.firstChild,c=l.nextSibling;c.firstChild;return yt(l,"click",e.onCancel),yt(c,"click",e.onConfirm),B(c,A(hn,{size:10,class:"text-[#c00002]"}),null),a}}),null),i})()},Ri=50,jl=e=>{let t=Symbol(),n=o=>{$e===t&&(tt(o)||(o.code==="Enter"?(o.preventDefault(),o.stopPropagation(),e.onRetry?.()):o.code==="Escape"&&(o.preventDefault(),o.stopPropagation(),e.onAcknowledge?.())));},r=()=>{$e=t;},i=()=>{let o=e.error;return o.length<=Ri?o:`${o.slice(0,Ri)}\u2026`};return mn(()=>{$e=t,window.addEventListener("keydown",n,{capture:true});}),be(()=>{$e===t&&($e=null),window.removeEventListener("keydown",n,{capture:true});}),(()=>{var o=yl(),a=o.firstChild,l=a.firstChild;return o.$$click=r,o.$$pointerdown=r,B(l,i),B(o,A(Yt,{get children(){var c=bl(),u=c.firstChild;u.firstChild;var p=u.nextSibling;return yt(u,"click",e.onRetry),B(u,A(Si,{size:10,class:"text-black/50"}),null),yt(p,"click",e.onAcknowledge),c}}),null),de(()=>ve(l,"title",e.error)),o})()},Vl=e=>{let t=Symbol(),n=i=>{$e===t&&(tt(i)||(i.code==="Enter"||i.code==="Escape")&&(i.preventDefault(),i.stopPropagation(),e.onDismiss?.()));},r=()=>{$e=t;};return mn(()=>{$e=t,window.addEventListener("keydown",n,{capture:true});}),be(()=>{$e===t&&($e=null),window.removeEventListener("keydown",n,{capture:true});}),(()=>{var i=Cl(),o=i.firstChild,a=o.firstChild;return i.$$click=r,i.$$pointerdown=r,B(a,()=>e.statusText),B(i,A(Q,{get when(){return e.onDismiss||e.onUndo||e.onReply},get children(){return A(Yt,{get children(){var l=Sl();return B(l,A(Q,{get when(){return ye(()=>!!e.supportsUndo)()&&e.onUndo},get children(){var c=wl();return c.$$click=()=>e.onUndo?.(),c}}),null),B(l,A(Q,{get when(){return ye(()=>!!e.supportsFollowUp)()&&e.onReply},get children(){var c=xl();return c.$$click=()=>e.onReply?.(),c}}),null),B(l,A(Q,{get when(){return e.onDismiss},get children(){var c=vl(),u=c.firstChild;return c.$$click=()=>e.onDismiss?.(),B(u,()=>e.dismissButtonText??"Ok"),B(c,A(hn,{size:10,class:"text-black/50"}),null),c}}),null),l}})}}),null),i})()},qt=e=>{let t,n,r=false,i=null,o=null,[a,l]=N(0),[c,u]=N(0),[g,p]=N("bottom"),[k,y]=N(0),[x,_]=N(false),[H,V]=N(false),C=wi({onTranscript:S=>e.onInputChange?.(S),getCurrentValue:()=>e.inputValue??""}),$=()=>e.status!=="copying"&&e.status!=="copied"&&e.status!=="fading",Z=()=>{if(t&&!r){let S=t.getBoundingClientRect();l(S.width),u(S.height);}},v=S=>{r=S;},M=()=>{y(S=>S+1);},W,z=()=>{_(false),W&&clearTimeout(W),W=setTimeout(()=>{_(true);},Hl);},q=S=>{tt(S)||S.code==="Enter"&&x()&&!e.isInputExpanded&&$()&&(S.preventDefault(),S.stopPropagation(),S.stopImmediatePropagation(),e.onToggleExpand?.());};mn(()=>{Z(),window.addEventListener("scroll",M,true),window.addEventListener("resize",M),window.addEventListener("keydown",q,{capture:true}),z();}),be(()=>{window.removeEventListener("scroll",M,true),window.removeEventListener("resize",M),window.removeEventListener("keydown",q,{capture:true}),W&&clearTimeout(W);}),oe(()=>{let S=`${e.tagName??""}:${e.componentName??""}`;S!==o&&(o=S,z());}),oe(()=>{e.tagName,e.componentName,e.statusText,e.inputValue,e.hasAgent,e.isInputExpanded,e.isPendingDismiss,e.error,e.isPendingAbort,requestAnimationFrame(Z);}),oe(()=>{e.visible&&requestAnimationFrame(Z);}),oe(()=>{e.status,requestAnimationFrame(Z);}),oe(()=>{e.isInputExpanded&&n?setTimeout(()=>{n?.focus();},0):C.stop();});let O=()=>{k();let S=e.selectionBounds,D=a(),X=c(),Y=D>0&&X>0,G=S&&S.width>0&&S.height>0;if(!Y||!G)return i??{left:-9999,top:-9999,arrowLeft:0};let U=window.innerWidth,ae=window.innerHeight,ee=S.x+S.width/2,fe=e.mouseX??ee,me=S.y+S.height,we=S.y,pe=fe-D/2,Te=me+Ei+ki;pe+D>U-8&&(pe=U-D-8),pe<8&&(pe=8);let Se=X+Ei+ki;Te+X<=ae-8?p("bottom"):(Te=we-Se,p("top")),Te<8&&(Te=8);let De=Math.max(12,Math.min(fe-pe,D-12)),Ve={left:pe,top:Te,arrowLeft:De};return i=Ve,V(true),Ve},h=S=>{if(S.stopPropagation(),S.stopImmediatePropagation(),S.code==="Enter"&&!S.shiftKey){if(S.preventDefault(),!e.inputValue?.trim())return;C.stop(),e.onSubmit?.();}else S.code==="Escape"&&(S.preventDefault(),C.stop(),e.onConfirmDismiss?.());},m=S=>{let D=S.target;e.onInputChange?.(D.value);},f=()=>e.tagName||"element",b=S=>{S.stopPropagation(),S.stopImmediatePropagation(),e.filePath&&e.onOpen&&e.onOpen();},L=()=>!!(e.filePath&&e.onOpen),j=S=>{S.stopPropagation(),S.stopImmediatePropagation();},ne=S=>{j(S),$()&&e.isInputExpanded&&!e.isPendingDismiss&&n&&n.focus();},te=()=>{e.isInputExpanded&&!e.inputValue?.trim()||(C.stop(),e.onSubmit?.());},se=()=>H()&&(e.status==="copied"||e.status==="fading");return A(Q,{get when(){return ye(()=>e.visible!==false)()&&(e.selectionBounds||se())},get children(){var S=Bl(),D=S.firstChild;S.$$click=j,S.$$mousedown=j,S.$$pointerdown=ne;var X=t;return typeof X=="function"?Gt(X,S):t=S,B(S,A(zl,{get position(){return g()},get leftPx(){return O().arrowLeft}}),D),B(S,A(Q,{get when(){return ye(()=>e.status==="copied"||e.status==="fading")()&&!e.error},get children(){return A(Vl,{get statusText(){return ye(()=>!!e.hasAgent)()?e.statusText??"Completed":"Copied"},get supportsUndo(){return e.supportsUndo},get supportsFollowUp(){return e.supportsFollowUp},get dismissButtonText(){return e.dismissButtonText},get onDismiss(){return e.onDismiss},get onUndo(){return e.onUndo},get onReply(){return e.onReply}})}}),D),B(D,A(Q,{get when(){return ye(()=>e.status==="copying")()&&!e.isPendingAbort},get children(){var Y=Tl(),G=Y.firstChild,U=G.firstChild,ae=U.firstChild;return B(ae,()=>e.statusText??"Grabbing\u2026"),B(Y,A(Yt,{get children(){var ee=kl(),fe=ee.firstChild,me=n;return typeof me=="function"?Gt(me,fe):n=fe,B(ee,A(Q,{get when(){return e.onAbort},get children(){var we=El();return we.$$click=pe=>{pe.stopPropagation(),e.onAbort?.();},we.$$pointerup=pe=>{pe.stopPropagation(),e.onAbort?.();},we.$$mousedown=pe=>pe.stopPropagation(),we.$$pointerdown=pe=>pe.stopPropagation(),we}}),null),de(()=>fe.value=e.inputValue??""),ee}}),null),Y}}),null),B(D,A(Q,{get when(){return ye(()=>e.status==="copying")()&&e.isPendingAbort},get children(){return A(Ni,{get onConfirm(){return e.onConfirmAbort},get onCancel(){return e.onCancelAbort}})}}),null),B(D,A(Q,{get when(){return ye(()=>!!$())()&&!e.isInputExpanded},get children(){var Y=Ml(),G=Y.firstChild,U=G.nextSibling,ae=U.firstChild;return B(G,A(_i,{onClick:te,shrink:true,get hasParent(){return !!e.componentName},get hasAgent(){return e.hasAgent}}),null),B(G,A(Q,{get when(){return e.componentName},get children(){var ee=Ci();return B(ee,A(Ti,{get name(){return e.componentName}}),null),B(ee,A(Ai,{}),null),B(ee,A(jn,{get tagName(){return f()},get isClickable(){return L()},onClick:b,onHoverChange:v,shrink:true}),null),ee}}),null),B(G,A(Q,{get when(){return !e.componentName},get children(){return A(jn,{get tagName(){return f()},get isClickable(){return L()},onClick:b,onHoverChange:v,shrink:true})}}),null),B(ae,A(Yt,{get children(){var ee=Ll();return B(ee,A(Q,{get when(){return e.hasAgent},get children(){return [Al(),(()=>{var fe=_l();return B(fe,A(hn,{size:10,class:"opacity-[0.99] text-black"})),fe})()]}}),null),B(ee,A(Q,{get when(){return !e.hasAgent},get children(){return [Nl(),Rl(),Il()]}}),null),ee}})),de(ee=>{var fe=je("contain-layout shrink-0 flex items-center gap-1 pt-1 w-fit h-fit pl-1.5",e.componentName?"pr-1.5":"pr-1"),me=x()?"1fr":"0fr",we=je("overflow-hidden min-h-0",!x()&&"w-0");return fe!==ee.e&&Ge(G,ee.e=fe),me!==ee.t&&_e(U,"grid-template-rows",ee.t=me),we!==ee.a&&Ge(ae,ee.a=we),ee},{e:void 0,t:void 0,a:void 0}),Y}}),null),B(D,A(Q,{get when(){return ye(()=>!!($()&&e.isInputExpanded))()&&!e.isPendingDismiss},get children(){var Y=Fl(),G=Y.firstChild;return B(G,A(_i,{onClick:te,dimmed:true,shrink:true,get hasParent(){return !!e.componentName},get hasAgent(){return e.hasAgent}}),null),B(G,A(Q,{get when(){return e.componentName},get children(){var U=Ci();return B(U,A(Ti,{get name(){return e.componentName}}),null),B(U,A(Ai,{}),null),B(U,A(jn,{get tagName(){return f()},get isClickable(){return L()},onClick:b,onHoverChange:v,shrink:true,forceShowIcon:true}),null),U}}),null),B(G,A(Q,{get when(){return !e.componentName},get children(){return A(jn,{get tagName(){return f()},get isClickable(){return L()},onClick:b,onHoverChange:v,shrink:true,forceShowIcon:true})}}),null),B(Y,A(Yt,{get children(){return [A(Q,{get when(){return e.replyToPrompt},get children(){var U=Ol(),ae=U.firstChild,ee=ae.nextSibling;return B(ee,()=>e.replyToPrompt),U}}),(()=>{var U=Dl(),ae=U.firstChild,ee=ae.nextSibling;ae.$$keydown=h,ae.$$input=m;var fe=n;return typeof fe=="function"?Gt(fe,ae):n=ae,B(ee,A(Q,{get when(){return ye(()=>!!(e.hasAgent&&C.isSupported()))()&&!e.inputValue},get children(){var me=Pl();return yt(me,"click",C.toggle),B(me,A(vi,{size:11,get class(){return C.isListening()?"animate-pulse":""}})),de(we=>{var pe=je("contain-layout shrink-0 flex items-center justify-center px-[2px] py-[2px] rounded-xs [border-width:0.5px] border-solid size-fit cursor-pointer transition-all hover:scale-105",C.isListening()?"bg-grab-purple border-grab-purple text-white":"bg-white border-[#B3B3B3] text-black"),Te=C.isListening()?"Stop listening":"Start voice input";return pe!==we.e&&Ge(me,we.e=pe),Te!==we.t&&ve(me,"title",we.t=Te),we},{e:void 0,t:void 0}),me}}),null),B(ee,A(Q,{get when(){return e.inputValue},get children(){var me=$l();return me.$$click=te,B(me,A(hn,{size:10,class:"opacity-[0.99] text-black"})),me}}),null),de(()=>ve(ae,"placeholder",C.isListening()?"listening...":"type prompt")),de(()=>ae.value=e.inputValue??""),U})()]}}),null),de(()=>Ge(G,je("contain-layout shrink-0 flex items-center gap-1 pt-1 w-fit h-fit pl-1.5",e.componentName?"pr-1.5":"pr-1"))),Y}}),null),B(D,A(Q,{get when(){return e.isPendingDismiss},get children(){return A(Ni,{get onConfirm(){return e.onConfirmDismiss},get onCancel(){return e.onCancelDismiss}})}}),null),B(D,A(Q,{get when(){return e.error},get children(){return A(jl,{get error(){return e.error},get onAcknowledge(){return e.onAcknowledgeError},get onRetry(){return e.onRetry}})}}),null),de(Y=>{var G=`${O().top}px`,U=`${O().left}px`,ae=e.isInputExpanded||e.status==="copied"&&e.onDismiss||e.status==="copying"&&e.onAbort?"auto":"none",ee=e.status==="fading"?0:1,fe=(e.status==="copied"||e.status==="fading")&&!e.error?"none":void 0;return G!==Y.e&&_e(S,"top",Y.e=G),U!==Y.t&&_e(S,"left",Y.t=U),ae!==Y.a&&_e(S,"pointer-events",Y.a=ae),ee!==Y.o&&_e(S,"opacity",Y.o=ee),fe!==Y.i&&_e(D,"display",Y.i=fe),Y},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),S}})};Bn(["click","pointerdown","mousedown","pointerup","input","keydown"]);var Gl=K('<div class="fixed z-2147483647"><button data-react-grab-selection-cursor>'),Ii=e=>{let[t,n]=N(false),[r,i]=N(false);oe(()=>{let a=e.visible!==false;if(e.x,e.y,i(false),a){let l=setTimeout(()=>i(true),500);be(()=>clearTimeout(l));}}),oe(()=>{if(!r()||!e.onEnter)return;let a=l=>{tt(l)||!(l.code==="Enter"||l.code==="NumpadEnter")||(l.preventDefault(),l.stopPropagation(),l.stopImmediatePropagation(),e.onEnter?.());};window.addEventListener("keydown",a,true),be(()=>{window.removeEventListener("keydown",a,true);});});let o=a=>{a.preventDefault(),a.stopPropagation(),e.onClick?.();};return A(Q,{get when(){return r()},get children(){return [A(Q,{get when(){return ye(()=>!!t())()&&e.elementBounds},get children(){return A(Rt,{variant:"selection",get bounds(){return e.elementBounds},visible:true})}}),(()=>{var a=Gl(),l=a.firstChild;return a.addEventListener("mouseleave",()=>n(false)),a.addEventListener("mouseenter",()=>n(true)),l.$$click=o,de(c=>{var u=`${e.x}px`,g=`${e.y}px`,p=je("absolute left-0 top-0 -translate-x-1/2 -translate-y-1/2 bg-grab-pink cursor-pointer rounded-full transition-[width,height] duration-150",t()?"w-1 h-5.5 brightness-125":"w-0.5 h-5 animate-pulse");return u!==c.e&&_e(a,"left",c.e=u),g!==c.t&&_e(a,"top",c.t=g),p!==c.a&&Ge(l,c.a=p),c},{e:void 0,t:void 0,a:void 0}),a})(),A(Q,{get when(){return ye(()=>!!t())()&&e.elementBounds},get children(){return A(qt,{get tagName(){return e.tagName},get componentName(){return e.componentName},get selectionBounds(){return e.elementBounds},get mouseX(){return e.x},visible:true,get onSubmit(){return e.onClick}})}})]}})};Bn(["click"]);var Li=e=>{let t=ce(()=>e.agentSessions?Array.from(e.agentSessions.values()):[]);return [A(Q,{get when(){return ye(()=>!!e.selectionVisible)()&&e.selectionBounds},get children(){return A(Rt,{variant:"selection",get bounds(){return e.selectionBounds},get visible(){return e.selectionVisible},get isFading(){return e.selectionLabelStatus==="fading"}})}}),A(Q,{get when(){return ye(()=>e.crosshairVisible===true&&e.mouseX!==void 0)()&&e.mouseY!==void 0},get children(){return A(yi,{get mouseX(){return e.mouseX},get mouseY(){return e.mouseY},visible:true})}}),A(Q,{get when(){return ye(()=>!!e.dragVisible)()&&e.dragBounds},get children(){return A(Rt,{variant:"drag",get bounds(){return e.dragBounds},get visible(){return e.dragVisible}})}}),A(Dn,{get each(){return e.grabbedBoxes??[]},children:n=>A(Rt,{variant:"grabbed",get bounds(){return n.bounds},get createdAt(){return n.createdAt}})}),A(vr,{get each(){return t()},children:n=>[A(Q,{get when(){return n().selectionBounds},get children(){return A(Rt,{variant:"processing",get bounds(){return n().selectionBounds},visible:true,get isCompleted(){return !n().isStreaming}})}}),A(qt,{get tagName(){return n().tagName},get componentName(){return n().componentName},get selectionBounds(){return n().selectionBounds},get mouseX(){return n().position.x},visible:true,hasAgent:true,isAgentConnected:true,get status(){return n().isStreaming?"copying":"copied"},get statusText(){return n().lastStatus||"Thinking\u2026"},get inputValue(){return n().context.prompt},get supportsUndo(){return e.supportsUndo},get supportsFollowUp(){return e.supportsFollowUp},get dismissButtonText(){return e.dismissButtonText},onAbort:()=>e.onAbortSession?.(n().id),get onDismiss(){return n().isStreaming?void 0:()=>e.onDismissSession?.(n().id)},get onUndo(){return n().isStreaming?void 0:()=>e.onUndoSession?.(n().id)},get onReply(){return n().isStreaming?void 0:()=>e.onReplySession?.(n().id)},get error(){return n().error},onAcknowledgeError:()=>e.onAcknowledgeSessionError?.(n().id),onRetry:()=>e.onRetrySession?.(n().id),get isPendingAbort(){return ye(()=>!!n().isStreaming)()?e.isPendingAgentAbort:false},get onConfirmAbort(){return e.onConfirmAgentAbort},get onCancelAbort(){return e.onCancelAgentAbort}})]}),A(Q,{get when(){return ye(()=>!!e.selectionLabelVisible)()&&e.selectionBounds},get children(){return A(qt,{get tagName(){return e.selectionTagName},get componentName(){return e.selectionComponentName},get selectionBounds(){return e.selectionBounds},get mouseX(){return e.mouseX},get visible(){return e.selectionLabelVisible},get isInputExpanded(){return e.isInputExpanded},get inputValue(){return e.inputValue},get replyToPrompt(){return e.replyToPrompt},get hasAgent(){return e.hasAgent},get isAgentConnected(){return e.isAgentConnected},get status(){return e.selectionLabelStatus},get filePath(){return e.selectionFilePath},get lineNumber(){return e.selectionLineNumber},get onInputChange(){return e.onInputChange},get onSubmit(){return e.onInputSubmit},get onCancel(){return e.onInputCancel},get onToggleExpand(){return e.onToggleExpand},get isPendingDismiss(){return e.isPendingDismiss},get onConfirmDismiss(){return e.onConfirmDismiss},get onCancelDismiss(){return e.onCancelDismiss},onOpen:()=>{if(e.selectionFilePath){let n=Hn(e.selectionFilePath,e.selectionLineNumber);window.open(n,"_blank");}}})}}),A(Dn,{get each(){return e.labelInstances??[]},children:n=>A(qt,{get tagName(){return n.tagName},get componentName(){return n.componentName},get selectionBounds(){return n.bounds},get mouseX(){return n.mouseX},visible:true,get status(){return n.status}})}),A(Q,{get when(){return ye(()=>!!(e.nativeSelectionCursorVisible&&e.nativeSelectionCursorX!==void 0))()&&e.nativeSelectionCursorY!==void 0},get children(){return A(Ii,{get x(){return e.nativeSelectionCursorX},get y(){return e.nativeSelectionCursorY},get tagName(){return e.nativeSelectionTagName},get componentName(){return e.nativeSelectionComponentName},get elementBounds(){return e.nativeSelectionBounds},get visible(){return e.nativeSelectionCursorVisible},get onClick(){return e.onNativeSelectionCopy},get onEnter(){return e.onNativeSelectionEnter}})}})]};var Pi="0.5.26",Gn=`bippy-${Pi}`,Mi=Object.defineProperty,Kl=Object.prototype.hasOwnProperty,bn=()=>{},$i=e=>{try{Function.prototype.toString.call(e).indexOf("^_^")>-1&&setTimeout(()=>{throw Error("React is running in production mode, but dead code elimination has not been applied. Read how to correctly configure React for production: https://reactjs.org/link/perf-use-production-build")});}catch{}},Kn=(e=ut())=>"getFiberRoots"in e,Di=false,Oi,yn=(e=ut())=>Di?true:(typeof e.inject=="function"&&(Oi=e.inject.toString()),!!Oi?.includes("(injected)")),Vn=new Set,Lt=new Set,Fi=e=>{let t=new Map,n=0,r={_instrumentationIsActive:false,_instrumentationSource:Gn,checkDCE:$i,hasUnsupportedRendererAttached:false,inject(i){let o=++n;return t.set(o,i),Lt.add(i),r._instrumentationIsActive||(r._instrumentationIsActive=true,Vn.forEach(a=>a())),o},on:bn,onCommitFiberRoot:bn,onCommitFiberUnmount:bn,onPostCommitFiberRoot:bn,renderers:t,supportsFiber:true,supportsFlight:true};try{Mi(globalThis,"__REACT_DEVTOOLS_GLOBAL_HOOK__",{configurable:!0,enumerable:!0,get(){return r},set(a){if(a&&typeof a=="object"){let l=r.renderers;r=a,l.size>0&&(l.forEach((c,u)=>{Lt.add(c),a.renderers.set(u,c);}),Un(e));}}});let i=window.hasOwnProperty,o=!1;Mi(window,"hasOwnProperty",{configurable:!0,value:function(...a){try{if(!o&&a[0]==="__REACT_DEVTOOLS_GLOBAL_HOOK__")return globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__=void 0,o=!0,-0}catch{}return i.apply(this,a)},writable:!0});}catch{Un(e);}return r},Un=e=>{try{let t=globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!t)return;if(!t._instrumentationSource){t.checkDCE=$i,t.supportsFiber=!0,t.supportsFlight=!0,t.hasUnsupportedRendererAttached=!1,t._instrumentationSource=Gn,t._instrumentationIsActive=!1;let n=Kn(t);if(n||(t.on=bn),t.renderers.size){t._instrumentationIsActive=!0,Vn.forEach(o=>o());return}let r=t.inject,i=yn(t);i&&!n&&(Di=!0,t.inject({scheduleRefresh(){}})&&(t._instrumentationIsActive=!0)),t.inject=o=>{let a=r(o);return Lt.add(o),i&&t.renderers.set(a,o),t._instrumentationIsActive=!0,Vn.forEach(l=>l()),a};}(t.renderers.size||t._instrumentationIsActive||yn())&&e?.();}catch{}},Ar=()=>Kl.call(globalThis,"__REACT_DEVTOOLS_GLOBAL_HOOK__"),ut=e=>Ar()?(Un(e),globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__):Fi(e),Bi=()=>!!(typeof window<"u"&&(window.document?.createElement||window.navigator?.product==="ReactNative")),_r=()=>{try{Bi()&&ut();}catch{}};var Nr=0,Rr=1;var Ir=5;var Lr=11,Mr=13;var Or=15,Pr=16;var $r=19;var Dr=26,Fr=27,Br=28,Hr=30;function zr(e,t,n=false){if(!e)return null;let r=t(e);if(r instanceof Promise)return (async()=>{if(await r===true)return e;let o=n?e.return:e.child;for(;o;){let a=await Vr(o,t,n);if(a)return a;o=n?null:o.sibling;}return null})();if(r===true)return e;let i=n?e.return:e.child;for(;i;){let o=jr(i,t,n);if(o)return o;i=n?null:i.sibling;}return null}var jr=(e,t,n=false)=>{if(!e)return null;if(t(e)===true)return e;let r=n?e.return:e.child;for(;r;){let i=jr(r,t,n);if(i)return i;r=n?null:r.sibling;}return null},Vr=async(e,t,n=false)=>{if(!e)return null;if(await t(e)===true)return e;let r=n?e.return:e.child;for(;r;){let i=await Vr(r,t,n);if(i)return i;r=n?null:r.sibling;}return null};var Ur=e=>{let t=e;return typeof t=="function"?t:typeof t=="object"&&t?Ur(t.type||t.render):null},wn=e=>{let t=e;if(typeof t=="string")return t;if(typeof t!="function"&&!(typeof t=="object"&&t))return null;let n=t.displayName||t.name||null;if(n)return n;let r=Ur(t);return r&&(r.displayName||r.name)||null};var Zt=()=>!!ut()._instrumentationIsActive||Kn()||yn();var Gr=e=>{let t=ut();for(let n of t.renderers.values())try{let r=n.findFiberByHostInstance?.(e);if(r)return r}catch{}if(typeof e=="object"&&e){if("_reactRootContainer"in e)return e._reactRootContainer?._internalRoot?.current?.child;for(let n in e)if(n.startsWith("__reactContainer$")||n.startsWith("__reactInternalInstance$")||n.startsWith("__reactFiber"))return e[n]||null}return null};var tc=Object.create,Xi=Object.defineProperty,nc=Object.getOwnPropertyDescriptor,rc=Object.getOwnPropertyNames,oc=Object.getPrototypeOf,ic=Object.prototype.hasOwnProperty,sc=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ac=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(var i=rc(t),o=0,a=i.length,l;o<a;o++)l=i[o],!ic.call(e,l)&&l!==n&&Xi(e,l,{get:(c=>t[c]).bind(null,l),enumerable:!(r=nc(t,l))||r.enumerable});return e},lc=(e,t,n)=>(n=e==null?{}:tc(oc(e)),ac(Xi(n,"default",{value:e,enumerable:true}),e)),Hi=/^[a-zA-Z][a-zA-Z\d+\-.]*:/,cc=["rsc://","file:///","webpack://","webpack-internal://","node:","turbopack://","metro://","/app-pages-browser/"],zi="about://React/",uc=["<anonymous>","eval",""],dc=/\.(jsx|tsx|ts|js)$/,fc=/(\.min|bundle|chunk|vendor|vendors|runtime|polyfill|polyfills)\.(js|mjs|cjs)$|(chunk|bundle|vendor|vendors|runtime|polyfill|polyfills|framework|app|main|index)[-_.][A-Za-z0-9_-]{4,}\.(js|mjs|cjs)$|[\da-f]{8,}\.(js|mjs|cjs)$|[-_.][\da-f]{20,}\.(js|mjs|cjs)$|\/dist\/|\/build\/|\/.next\/|\/out\/|\/node_modules\/|\.webpack\.|\.vite\.|\.turbopack\./i,mc=/^\?[\w~.\-]+(?:=[^&#]*)?(?:&[\w~.\-]+(?:=[^&#]*)?)*$/,Wi="(at Server)",pc=/(^|@)\S+:\d+/,Yi=/^\s*at .*(\S+:\d+|\(native\))/m,gc=/^(eval@)?(\[native code\])?$/;var qi=(e,t)=>{{let n=e.split(`
`),r=[];for(let i of n)if(/^\s*at\s+/.test(i)){let o=ji(i,void 0)[0];o&&r.push(o);}else if(/^\s*in\s+/.test(i)){let o=i.replace(/^\s*in\s+/,"").replace(/\s*\(at .*\)$/,"");r.push({functionName:o,source:i});}else if(i.match(pc)){let o=Vi(i,void 0)[0];o&&r.push(o);}return Wr(r,t)}},Zi=e=>{if(!e.includes(":"))return [e,void 0,void 0];let t=/(.+?)(?::(\d+))?(?::(\d+))?$/,n=t.exec(e.replace(/[()]/g,""));return [n[1],n[2]||void 0,n[3]||void 0]},Wr=(e,t)=>t&&t.slice!=null?Array.isArray(t.slice)?e.slice(t.slice[0],t.slice[1]):e.slice(0,t.slice):e;var ji=(e,t)=>Wr(e.split(`
`).filter(r=>!!r.match(Yi)),t).map(r=>{let i=r;i.includes("(eval ")&&(i=i.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));let o=i.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),a=o.match(/ (\(.+\)$)/);o=a?o.replace(a[0],""):o;let l=Zi(a?a[1]:o),c=a&&o||void 0,u=["eval","<anonymous>"].includes(l[0])?void 0:l[0];return {functionName:c,fileName:u,lineNumber:l[1]?+l[1]:void 0,columnNumber:l[2]?+l[2]:void 0,source:i}});var Vi=(e,t)=>Wr(e.split(`
`).filter(r=>!r.match(gc)),t).map(r=>{let i=r;if(i.includes(" > eval")&&(i=i.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),!i.includes("@")&&!i.includes(":"))return {functionName:i};{let o=/(([^\n\r"\u2028\u2029]*".[^\n\r"\u2028\u2029]*"[^\n\r@\u2028\u2029]*(?:@[^\n\r"\u2028\u2029]*"[^\n\r@\u2028\u2029]*)*(?:[\n\r\u2028\u2029][^@]*)?)?[^@]*)@/,a=i.match(o),l=a&&a[1]?a[1]:void 0,c=Zi(i.replace(o,""));return {functionName:l,fileName:c[0],lineNumber:c[1]?+c[1]:void 0,columnNumber:c[2]?+c[2]:void 0,source:i}}});var hc=sc((e,t)=>{(function(n,r){typeof e=="object"&&t!==void 0?r(e):typeof define=="function"&&define.amd?define(["exports"],r):(n=typeof globalThis<"u"?globalThis:n||self,r(n.sourcemapCodec={}));})(void 0,function(n){let r=44,i=59,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=new Uint8Array(64),l=new Uint8Array(128);for(let h=0;h<o.length;h++){let m=o.charCodeAt(h);a[h]=m,l[m]=h;}function c(h,m){let f=0,b=0,L=0;do{let ne=h.next();L=l[ne],f|=(L&31)<<b,b+=5;}while(L&32);let j=f&1;return f>>>=1,j&&(f=-2147483648|-f),m+f}function u(h,m,f){let b=m-f;b=b<0?-b<<1|1:b<<1;do{let L=b&31;b>>>=5,b>0&&(L|=32),h.write(a[L]);}while(b>0);return m}function g(h,m){return h.pos>=m?false:h.peek()!==r}let p=1024*16,k=typeof TextDecoder<"u"?new TextDecoder:typeof Buffer<"u"?{decode(h){return Buffer.from(h.buffer,h.byteOffset,h.byteLength).toString()}}:{decode(h){let m="";for(let f=0;f<h.length;f++)m+=String.fromCharCode(h[f]);return m}};class y{constructor(){this.pos=0,this.out="",this.buffer=new Uint8Array(p);}write(m){let{buffer:f}=this;f[this.pos++]=m,this.pos===p&&(this.out+=k.decode(f),this.pos=0);}flush(){let{buffer:m,out:f,pos:b}=this;return b>0?f+k.decode(m.subarray(0,b)):f}}class x{constructor(m){this.pos=0,this.buffer=m;}next(){return this.buffer.charCodeAt(this.pos++)}peek(){return this.buffer.charCodeAt(this.pos)}indexOf(m){let{buffer:f,pos:b}=this,L=f.indexOf(m,b);return L===-1?f.length:L}}let _=[];function H(h){let{length:m}=h,f=new x(h),b=[],L=[],j=0;for(;f.pos<m;f.pos++){j=c(f,j);let ne=c(f,0);if(!g(f,m)){let Y=L.pop();Y[2]=j,Y[3]=ne;continue}let te=c(f,0),se=c(f,0),S=se&1,D=S?[j,ne,0,0,te,c(f,0)]:[j,ne,0,0,te],X=_;if(g(f,m)){X=[];do{let Y=c(f,0);X.push(Y);}while(g(f,m))}D.vars=X,b.push(D),L.push(D);}return b}function V(h){let m=new y;for(let f=0;f<h.length;)f=C(h,f,m,[0]);return m.flush()}function C(h,m,f,b){let L=h[m],{0:j,1:ne,2:te,3:se,4:S,vars:D}=L;m>0&&f.write(r),b[0]=u(f,j,b[0]),u(f,ne,0),u(f,S,0);let X=L.length===6?1:0;u(f,X,0),L.length===6&&u(f,L[5],0);for(let Y of D)u(f,Y,0);for(m++;m<h.length;){let Y=h[m],{0:G,1:U}=Y;if(G>te||G===te&&U>=se)break;m=C(h,m,f,b);}return f.write(r),b[0]=u(f,te,b[0]),u(f,se,0),m}function $(h){let{length:m}=h,f=new x(h),b=[],L=[],j=0,ne=0,te=0,se=0,S=0,D=0,X=0,Y=0;do{let G=f.indexOf(";"),U=0;for(;f.pos<G;f.pos++){if(U=c(f,U),!g(f,G)){let Se=L.pop();Se[2]=j,Se[3]=U;continue}let ae=c(f,0),ee=ae&1,fe=ae&2,me=ae&4,we=null,pe=_,Te;if(ee){let Se=c(f,ne);te=c(f,ne===Se?te:0),ne=Se,Te=[j,U,0,0,Se,te];}else Te=[j,U,0,0];if(Te.isScope=!!me,fe){let Se=se,rt=S;se=c(f,se);let De=Se===se;S=c(f,De?S:0),D=c(f,De&&rt===S?D:0),we=[se,S,D];}if(Te.callsite=we,g(f,G)){pe=[];do{X=j,Y=U;let Se=c(f,0),rt;if(Se<-1){rt=[[c(f,0)]];for(let De=-1;De>Se;De--){let Ve=X;X=c(f,X),Y=c(f,X===Ve?Y:0);let nn=c(f,0);rt.push([nn,X,Y]);}}else rt=[[Se]];pe.push(rt);}while(g(f,G))}Te.bindings=pe,b.push(Te),L.push(Te);}j++,f.pos=G+1;}while(f.pos<m);return b}function Z(h){if(h.length===0)return "";let m=new y;for(let f=0;f<h.length;)f=v(h,f,m,[0,0,0,0,0,0,0]);return m.flush()}function v(h,m,f,b){let L=h[m],{0:j,1:ne,2:te,3:se,isScope:S,callsite:D,bindings:X}=L;b[0]<j?(M(f,b[0],j),b[0]=j,b[1]=0):m>0&&f.write(r),b[1]=u(f,L[1],b[1]);let Y=(L.length===6?1:0)|(D?2:0)|(S?4:0);if(u(f,Y,0),L.length===6){let{4:G,5:U}=L;G!==b[2]&&(b[3]=0),b[2]=u(f,G,b[2]),b[3]=u(f,U,b[3]);}if(D){let{0:G,1:U,2:ae}=L.callsite;G===b[4]?U!==b[5]&&(b[6]=0):(b[5]=0,b[6]=0),b[4]=u(f,G,b[4]),b[5]=u(f,U,b[5]),b[6]=u(f,ae,b[6]);}if(X)for(let G of X){G.length>1&&u(f,-G.length,0);let U=G[0][0];u(f,U,0);let ae=j,ee=ne;for(let fe=1;fe<G.length;fe++){let me=G[fe];ae=u(f,me[1],ae),ee=u(f,me[2],ee),u(f,me[0],0);}}for(m++;m<h.length;){let G=h[m],{0:U,1:ae}=G;if(U>te||U===te&&ae>=se)break;m=v(h,m,f,b);}return b[0]<te?(M(f,b[0],te),b[0]=te,b[1]=0):f.write(r),b[1]=u(f,se,b[1]),m}function M(h,m,f){do h.write(i);while(++m<f)}function W(h){let{length:m}=h,f=new x(h),b=[],L=0,j=0,ne=0,te=0,se=0;do{let S=f.indexOf(";"),D=[],X=true,Y=0;for(L=0;f.pos<S;){let G;L=c(f,L),L<Y&&(X=false),Y=L,g(f,S)?(j=c(f,j),ne=c(f,ne),te=c(f,te),g(f,S)?(se=c(f,se),G=[L,j,ne,te,se]):G=[L,j,ne,te]):G=[L],D.push(G),f.pos++;}X||z(D),b.push(D),f.pos=S+1;}while(f.pos<=m);return b}function z(h){h.sort(q);}function q(h,m){return h[0]-m[0]}function O(h){let m=new y,f=0,b=0,L=0,j=0;for(let ne=0;ne<h.length;ne++){let te=h[ne];if(ne>0&&m.write(i),te.length===0)continue;let se=0;for(let S=0;S<te.length;S++){let D=te[S];S>0&&m.write(r),se=u(m,D[0],se),D.length!==1&&(f=u(m,D[1],f),b=u(m,D[2],b),L=u(m,D[3],L),D.length!==4&&(j=u(m,D[4],j)));}}return m.flush()}n.decode=W,n.decodeGeneratedRanges=$,n.decodeOriginalScopes=H,n.encode=O,n.encodeGeneratedRanges=Z,n.encodeOriginalScopes=V,Object.defineProperty(n,"__esModule",{value:true});});}),Ji=lc(hc()),Qi=/^[a-zA-Z][a-zA-Z\d+\-.]*:/,bc=/^data:application\/json[^,]+base64,/,yc=/(?:\/\/[@#][ \t]+sourceMappingURL=([^\s'"]+?)[ \t]*$)|(?:\/\*[@#][ \t]+sourceMappingURL=([^*]+?)[ \t]*(?:\*\/)[ \t]*$)/,es=typeof WeakRef<"u",xn=new Map,Xn=new Map,wc=e=>es&&e instanceof WeakRef,Ui=(e,t,n,r)=>{if(n<0||n>=e.length)return null;let i=e[n];if(!i||i.length===0)return null;let o=null;for(let g of i)if(g[0]<=r)o=g;else break;if(!o||o.length<4)return null;let[,a,l,c]=o;if(a===void 0||l===void 0||c===void 0)return null;let u=t[a];return u?{columnNumber:c,fileName:u,lineNumber:l+1}:null},xc=(e,t,n)=>{if(e.sections){let r=null;for(let a of e.sections)if(t>a.offset.line||t===a.offset.line&&n>=a.offset.column)r=a;else break;if(!r)return null;let i=t-r.offset.line,o=t===r.offset.line?n-r.offset.column:n;return Ui(r.map.mappings,r.map.sources,i,o)}return Ui(e.mappings,e.sources,t-1,n)},vc=(e,t)=>{let n=t.split(`
`),r;for(let o=n.length-1;o>=0&&!r;o--){let a=n[o].match(yc);a&&(r=a[1]||a[2]);}if(!r)return null;let i=Qi.test(r);if(!(bc.test(r)||i||r.startsWith("/"))){let o=e.split("/");o[o.length-1]=r,r=o.join("/");}return r},Sc=e=>({file:e.file,mappings:(0, Ji.decode)(e.mappings),names:e.names,sourceRoot:e.sourceRoot,sources:e.sources,sourcesContent:e.sourcesContent,version:3}),Cc=e=>{let t=e.sections.map(({map:r,offset:i})=>({map:{...r,mappings:(0, Ji.decode)(r.mappings)},offset:i})),n=new Set;for(let r of t)for(let i of r.map.sources)n.add(i);return {file:e.file,mappings:[],names:[],sections:t,sourceRoot:void 0,sources:Array.from(n),sourcesContent:void 0,version:3}},Gi=e=>{if(!e)return  false;let t=e.trim();if(!t)return  false;let n=t.match(Qi);if(!n)return  true;let r=n[0].toLowerCase();return r==="http:"||r==="https:"},Ec=async(e,t=fetch)=>{if(!Gi(e))return null;let n;try{n=await(await t(e)).text();}catch{return null}if(!n)return null;let r=vc(e,n);if(!r||!Gi(r))return null;try{let i=await t(r),o=await i.json();return "sections"in o?Cc(o):Sc(o)}catch{return null}},kc=async(e,t=true,n)=>{if(t&&xn.has(e)){let o=xn.get(e);if(o==null)return null;if(wc(o)){let a=o.deref();if(a)return a;xn.delete(e);}else return o}if(t&&Xn.has(e))return Xn.get(e);let r=Ec(e,n);t&&Xn.set(e,r);let i=await r;return t&&Xn.delete(e),t&&(i===null?xn.set(e,null):xn.set(e,es?new WeakRef(i):i)),i},Tc=async(e,t=true,n)=>await Promise.all(e.map(async r=>{if(!r.fileName)return r;let i=await kc(r.fileName,t,n);if(!i||typeof r.lineNumber!="number"||typeof r.columnNumber!="number")return r;let o=xc(i,r.lineNumber,r.columnNumber);return o?{...r,source:o.fileName&&r.source?r.source.replace(r.fileName,o.fileName):r.source,fileName:o.fileName,lineNumber:o.lineNumber,columnNumber:o.columnNumber,isSymbolicated:true}:r})),Ac=e=>e._debugStack instanceof Error&&typeof e._debugStack?.stack=="string",_c=()=>{let e=ut();for(let t of [...Array.from(Lt),...Array.from(e.renderers.values())]){let n=t.currentDispatcherRef;if(n&&typeof n=="object")return "H"in n?n.H:n.current}return null},Ki=e=>{for(let t of Lt){let n=t.currentDispatcherRef;n&&typeof n=="object"&&("H"in n?n.H=e:n.current=e);}},dt=e=>`
    in ${e}`,Nc=(e,t)=>{let n=dt(e);return t&&(n+=` (at ${t})`),n},Kr=false,Xr=(e,t)=>{if(!e||Kr)return "";let n=Error.prepareStackTrace;Error.prepareStackTrace=void 0,Kr=true;let r=_c();Ki(null);let i=console.error,o=console.warn;console.error=()=>{},console.warn=()=>{};try{let c={DetermineComponentFrameRoot(){let k;try{if(t){let y=function(){throw Error()};if(Object.defineProperty(y.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(y,[]);}catch(x){k=x;}Reflect.construct(e,[],y);}else {try{y.call();}catch(x){k=x;}e.call(y.prototype);}}else {try{throw Error()}catch(x){k=x;}let y=e();y&&typeof y.catch=="function"&&y.catch(()=>{});}}catch(y){if(y instanceof Error&&k instanceof Error&&typeof y.stack=="string")return [y.stack,k.stack]}return [null,null]}};c.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot",Object.getOwnPropertyDescriptor(c.DetermineComponentFrameRoot,"name")?.configurable&&Object.defineProperty(c.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});let[g,p]=c.DetermineComponentFrameRoot();if(g&&p){let k=g.split(`
`),y=p.split(`
`),x=0,_=0;for(;x<k.length&&!k[x].includes("DetermineComponentFrameRoot");)x++;for(;_<y.length&&!y[_].includes("DetermineComponentFrameRoot");)_++;if(x===k.length||_===y.length)for(x=k.length-1,_=y.length-1;x>=1&&_>=0&&k[x]!==y[_];)_--;for(;x>=1&&_>=0;x--,_--)if(k[x]!==y[_]){if(x!==1||_!==1)do if(x--,_--,_<0||k[x]!==y[_]){let H=`
${k[x].replace(" at new "," at ")}`,V=wn(e);return V&&H.includes("<anonymous>")&&(H=H.replace("<anonymous>",V)),H}while(x>=1&&_>=0);break}}}finally{Kr=false,Error.prepareStackTrace=n,Ki(r),console.error=i,console.warn=o;}let a=e?wn(e):"";return a?dt(a):""},Rc=(e,t)=>{let n=e.tag,r="";switch(n){case Br:r=dt("Activity");break;case Rr:r=Xr(e.type,true);break;case Lr:r=Xr(e.type.render,false);break;case Nr:case Or:r=Xr(e.type,false);break;case Ir:case Dr:case Fr:r=dt(e.type);break;case Pr:r=dt("Lazy");break;case Mr:r=e.child!==t&&t!==null?dt("Suspense Fallback"):dt("Suspense");break;case $r:r=dt("SuspenseList");break;case Hr:r=dt("ViewTransition");break;default:return ""}return r},Ic=e=>{try{let t="",n=e,r=null;do{t+=Rc(n,r);let i=n._debugInfo;if(i&&Array.isArray(i))for(let o=i.length-1;o>=0;o--){let a=i[o];typeof a.name=="string"&&(t+=Nc(a.name,a.env));}r=n,n=n.return;}while(n);return t}catch(t){return t instanceof Error?`
Error generating stack: ${t.message}
${t.stack}`:""}},Lc=e=>{let t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;let n=e;if(!n)return "";Error.prepareStackTrace=t,n.startsWith(`Error: react-stack-top-frame
`)&&(n=n.slice(29));let r=n.indexOf(`
`);if(r!==-1&&(n=n.slice(r+1)),r=Math.max(n.indexOf("react_stack_bottom_frame"),n.indexOf("react-stack-bottom-frame")),r!==-1&&(r=n.lastIndexOf(`
`,r)),r!==-1)n=n.slice(0,r);else return "";return n},Mc=e=>!!(e.fileName?.startsWith("rsc://")&&e.functionName),Oc=(e,t)=>e.fileName===t.fileName&&e.lineNumber===t.lineNumber&&e.columnNumber===t.columnNumber,Pc=e=>{let t=new Map;for(let n of e)for(let r of n.stackFrames){if(!Mc(r))continue;let i=r.functionName,o=t.get(i)??[];o.some(l=>Oc(l,r))||(o.push(r),t.set(i,o));}return t},$c=(e,t,n)=>{if(!e.functionName)return {...e,isServer:true};let r=t.get(e.functionName);if(!r||r.length===0)return {...e,isServer:true};let i=n.get(e.functionName)??0,o=r[i%r.length];return n.set(e.functionName,i+1),{...e,isServer:true,fileName:o.fileName,lineNumber:o.lineNumber,columnNumber:o.columnNumber,source:e.source?.replace(Wi,`(${o.fileName}:${o.lineNumber}:${o.columnNumber})`)}},Dc=e=>{let t=[];return zr(e,n=>{if(!Ac(n))return;let r=typeof n.type=="string"?n.type:wn(n.type)||"<anonymous>";t.push({componentName:r,stackFrames:qi(Lc(n._debugStack?.stack))});},true),t},ts=async(e,t=true,n)=>{let r=Dc(e),i=qi(Ic(e)),o=Pc(r),a=new Map,l=i.map(u=>u.source?.includes(Wi)??false?$c(u,o,a):u),c=l.filter((u,g,p)=>{if(g===0)return  true;let k=p[g-1];return u.functionName!==k.functionName});return Tc(c,t,n)};var vn=e=>{if(!e||uc.some(i=>i===e))return "";let t=e;if(t.startsWith("http://")||t.startsWith("https://"))try{t=new URL(t).pathname;}catch{}if(t.startsWith(zi)){let i=t.slice(zi.length),o=i.indexOf("/"),a=i.indexOf(":");t=o!==-1&&(a===-1||o<a)?i.slice(o+1):i;}let n=true;for(;n;){n=false;for(let i of cc)if(t.startsWith(i)){t=t.slice(i.length),i==="file:///"&&(t=`/${t.replace(/^\/+/,"")}`),n=true;break}}if(Hi.test(t)){let i=t.match(Hi);i&&(t=t.slice(i[0].length));}if(t.startsWith("//")){let i=t.indexOf("/",2);t=i===-1?"":t.slice(i);}let r=t.indexOf("?");if(r!==-1){let i=t.slice(r);mc.test(i)&&(t=t.slice(0,r));}return t},Wn=e=>{let t=vn(e);return !(!t||!dc.test(t)||fc.test(t))};var ns=e=>e.length>0&&/^[A-Z]/.test(e);_r();var Fc=new Set(["InnerLayoutRouter","RedirectErrorBoundary","RedirectBoundary","HTTPAccessFallbackErrorBoundary","HTTPAccessFallbackBoundary","LoadingBoundary","ErrorBoundary","InnerScrollAndFocusHandler","ScrollAndFocusHandler","RenderFromTemplateContext","OuterLayoutRouter","body","html","DevRootHTTPAccessFallbackBoundary","AppDevOverlayErrorBoundary","AppDevOverlay","HotReload","Router","ErrorBoundaryHandler","AppRouter","ServerRoot","SegmentStateProvider","RootErrorBoundary","LoadableComponent","MotionDOMComponent"]),Bc=()=>typeof document>"u"?false:!!(document.getElementById("__NEXT_DATA__")||document.querySelector("nextjs-portal")),Hc=e=>!!(e.startsWith("_")||Fc.has(e)),Yr=e=>!(Hc(e)||!ns(e)||e.startsWith("Primitive.")||e.includes("Provider")&&e.includes("Context")),Jt=async e=>{if(!Zt())return [];let t=Gr(e);return t?await ts(t):null},Ze=async e=>{if(!Zt())return null;let t=await Jt(e);if(!t)return null;for(let n of t)if(n.functionName&&Yr(n.functionName))return n.functionName;return null},Yn=async(e,t={})=>{let{maxLines:n=3}=t,r=zc(e),i=await Jt(e),o=Bc(),a=[];if(i)for(let l of i){if(a.length>=n)break;if(l.isServer&&(!l.functionName||Yr(l.functionName))){a.push(`
  in ${l.functionName||"<anonymous>"} (at Server)`);continue}if(l.fileName&&Wn(l.fileName)){let c=`
  in `,u=l.functionName&&Yr(l.functionName);u&&(c+=`${l.functionName} (at `),c+=vn(l.fileName),o&&l.lineNumber&&l.columnNumber&&(c+=`:${l.lineNumber}:${l.columnNumber}`),u&&(c+=")"),a.push(c);}}return `${r}${a.join("")}`},zc=e=>{let t=e.tagName.toLowerCase();if(!(e instanceof HTMLElement))return `<${t} />`;let n=e.innerText?.trim()??e.textContent?.trim()??"",r="",i=Array.from(e.attributes);for(let y of i){let x=y.name,_=y.value;_.length>20&&(_=`${_.slice(0,20)}...`),r+=` ${x}="${_}"`;}let o=[],a=[],l=false,c=Array.from(e.childNodes);for(let y of c)y.nodeType!==Node.COMMENT_NODE&&(y.nodeType===Node.TEXT_NODE?y.textContent&&y.textContent.trim().length>0&&(l=true):y instanceof Element&&(l?a.push(y):o.push(y)));let u=y=>y.length===0?"":y.length<=2?y.map(x=>`<${x.tagName.toLowerCase()} ...>`).join(`
  `):`(${y.length} elements)`,g="",p=u(o);if(p&&(g+=`
  ${p}`),n.length>0){let y=n.length>100?`${n.slice(0,100)}...`:n;g+=`
  ${y}`;}let k=u(a);return k&&(g+=`
  ${k}`),g.length>0?`<${t}${r}>${g}
</${t}>`:`<${t}${r} />`};var qr=e=>({activate:()=>{},deactivate:()=>{},toggle:()=>{},isActive:()=>false,dispose:()=>{},copyElement:()=>Promise.resolve(false),getState:()=>({isActive:false,isDragging:false,isCopying:false,isInputMode:false,targetElement:null,dragBounds:null}),updateTheme:()=>{},getTheme:()=>e,setAgent:()=>{},updateOptions:()=>{}});var rs=()=>{let e=new AbortController,t=(r,i,o={})=>{window.addEventListener(r,i,{...o,signal:e.signal});},n=(r,i,o={})=>{document.addEventListener(r,i,{...o,signal:e.signal});};return {signal:e.signal,abort:()=>e.abort(),addWindowListener:t,addDocumentListener:n}};var os=e=>({createLabelInstance:(i,o,a,l,c,u)=>{let g=`label-${Date.now()}-${Math.random().toString(36).slice(2)}`;return e(p=>[...p,{id:g,bounds:i,tagName:o,componentName:a,status:l,createdAt:Date.now(),element:c,mouseX:u}]),g},updateLabelInstance:(i,o)=>{e(a=>a.map(l=>l.id===i?{...l,status:o}:l));},removeLabelInstance:i=>{e(o=>o.filter(a=>a.id!==i));}});var jc="application/x-react-grab",Qt=(e,t)=>{let n=JSON.stringify({version:ii,content:e,timestamp:Date.now(),...t?.prompt&&{prompt:t.prompt}}),r=o=>{o.preventDefault(),o.clipboardData?.setData("text/plain",e),o.clipboardData?.setData(jc,n);};document.addEventListener("copy",r);let i=document.createElement("textarea");i.value=e,i.style.position="fixed",i.style.left="-9999px",i.ariaHidden="true",document.body.appendChild(i),i.select();try{let o=document.execCommand("copy");return o&&t?.onSuccess?.(),o}finally{document.removeEventListener("copy",r),i.remove();}};var en=async(e,t={})=>{let r=(await Promise.allSettled(e.map(i=>Yn(i,t)))).map(i=>i.status==="fulfilled"?i.value:"").filter(i=>i.trim());return r.length===0?"":r.join(`

`)};var Vc=e=>"innerText"in e,Uc=e=>Vc(e)?e.innerText:e.textContent??"",is=e=>e.map(t=>Uc(t).trim()).filter(t=>t.length>0).join(`

`),ss=async(e,t,n)=>{let r=false,i="";await e.onBeforeCopy?.(t);try{if(e.getContent){let o=await e.getContent(t);if(o.trim()){let a=n?`${n}

${o}`:o;i=a,r=Qt(a,{prompt:n});}}else {let o=await en(t,{maxLines:e.maxContextLines});if(o.trim()){let a=n?`${n}

${o}`:o;i=a,r=Qt(a,{prompt:n});}if(!r){let a=is(t);if(a.length>0){let l=n?`${n}

${a}`:a;i=l,r=Qt(l,{prompt:n});}}}}catch(o){let a=o instanceof Error?o:new Error(String(o));e.onCopyError?.(a);let l=is(t);if(l.length>0){let c=n?`${n}

${l}`:l;i=c,r=Qt(c,{prompt:n});}}return r&&e.onCopySuccess?.(t,i),e.onAfterCopy?.(t,r),r};var as=(e,t=window.getComputedStyle(e))=>t.display!=="none"&&t.visibility!=="hidden"&&t.opacity!=="0";var Je=e=>{if(e.closest(`[${Kt}]`))return  false;let t=window.getComputedStyle(e);return !(!as(e,t)||t.pointerEvents==="none")};var Zr=(e,t)=>{let n=document.elementsFromPoint(e,t);for(let r of n)if(Je(r))return r;return null};var Gc=(e,t)=>{let n=Math.max(e.left,t.left),r=Math.max(e.top,t.top),i=Math.min(e.right,t.right),o=Math.min(e.bottom,t.bottom),a=Math.max(0,i-n),l=Math.max(0,o-r);return a*l},Kc=(e,t)=>e.left<t.right&&e.right>t.left&&e.top<t.bottom&&e.bottom>t.top,tn=(e,t,n)=>Math.min(n,Math.max(t,e)),Xc=e=>e.sort((t,n)=>{if(t===n)return 0;let r=t.compareDocumentPosition(n);return r&Node.DOCUMENT_POSITION_FOLLOWING?-1:r&Node.DOCUMENT_POSITION_PRECEDING?1:0}),Wc=e=>{if(e.width<=0||e.height<=0)return [];let t=window.innerWidth,n=window.innerHeight,r=e.x,i=e.y,o=e.x+e.width,a=e.y+e.height,l=r+e.width/2,c=i+e.height/2,u=tn(Math.ceil(e.width/24),3,30),g=tn(Math.ceil(e.height/24),3,30),p=u*g,k=p>600?Math.sqrt(600/p):1,y=tn(Math.floor(u*k),3,30),x=tn(Math.floor(g*k),3,30),_=new Set,H=[],V=($,Z)=>{let v=tn(Math.round($),0,t-1),M=tn(Math.round(Z),0,n-1),W=`${v}:${M}`;_.has(W)||(_.add(W),H.push({x:v,y:M}));},C=1;V(r+C,i+C),V(o-C,i+C),V(r+C,a-C),V(o-C,a-C),V(l,i+C),V(l,a-C),V(r+C,c),V(o-C,c),V(l,c);for(let $=0;$<y;$+=1){let Z=r+($+.5)/y*e.width;for(let v=0;v<x;v+=1){let M=i+(v+.5)/x*e.height;V(Z,M);}}return H},ls=(e,t,n)=>{let r={left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height},i=new Set,o=Wc(e);for(let l of o){let c=document.elementsFromPoint(l.x,l.y);for(let u of c)i.add(u);}let a=[];for(let l of i){if(!n){let g=(l.tagName||"").toUpperCase();if(g==="HTML"||g==="BODY")continue}if(!t(l))continue;let c=l.getBoundingClientRect();if(c.width<=0||c.height<=0)continue;let u={left:c.left,top:c.top,right:c.left+c.width,bottom:c.top+c.height};if(n){let g=Gc(r,u),p=c.width*c.height;p>0&&g/p>=.75&&a.push(l);}else Kc(u,r)&&a.push(l);}return Xc(a)},cs=e=>e.filter(t=>!e.some(n=>n!==t&&n.contains(t))),us=(e,t)=>{let n=ls(e,t,true);return cs(n)},ds=(e,t)=>{let n=ls(e,t,false);return cs(n)};var Yc=e=>typeof e=="number"&&!Number.isNaN(e)&&Number.isFinite(e),qc=e=>{let t=e.trim();if(!t)return null;let n=parseFloat(t);return Yc(n)?n:null},fs=(e,t)=>{let n=e.split(",");if(n.length!==t)return null;let r=[];for(let i of n){let o=qc(i);if(o===null)return null;r.push(o);}return r},Zc=(e,t,n,r)=>e===1&&t===0&&n===0&&r===1,Jc=e=>e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[15]===1,qn=e=>{try{if(!(e instanceof Element))return "none";let t=window.getComputedStyle(e);if(!t)return "none";let n=t.transform;if(!n||n==="none")return "none";let r=n.match(/^matrix3d\(([^)]+)\)$/);if(r){let o=fs(r[1],16);if(o&&o.length===16){let a=[...o];return a[12]=0,a[13]=0,a[14]=0,Jc(a)?"none":`matrix3d(${a.join(", ")})`}}let i=n.match(/^matrix\(([^)]+)\)$/);if(i){let o=fs(i[1],6);if(o&&o.length===6){let[a,l,c,u]=o;return Zc(a,l,c,u)?"none":`matrix(${a}, ${l}, ${c}, ${u}, 0, 0)`}}return "none"}catch{return "none"}};var ke=e=>{let t=e.getBoundingClientRect();return {borderRadius:window.getComputedStyle(e).borderRadius||"0px",height:t.height,transform:qn(e),width:t.width,x:t.left,y:t.top}};var Qc=new Set(["c","C","\u0441","\u0421","\u023C","\u023B","\u2184","\u2183","\u1D04","\u1D9C","\u2C7C","\u217D","\u216D","\xE7","\xC7","\u0107","\u0106","\u010D","\u010C","\u0109","\u0108","\u010B","\u010A"]),Zn=(e,t)=>t==="KeyC"?true:!e||e.length!==1?false:Qc.has(e);var Jr=(e,t)=>{let n=e.toLowerCase();return t.startsWith("Key")?t.slice(3).toLowerCase()===n:t.startsWith("Digit")?t.slice(5)===n:false},Qr=(e,t)=>{if(t.activationShortcut)return t.activationShortcut(e);if(t.activationKey){let{key:r,metaKey:i,ctrlKey:o,shiftKey:a,altKey:l}=t.activationKey;if(!r){if(!zn.includes(e.key))return  false;let k=i?e.metaKey||e.key==="Meta":true,y=o?e.ctrlKey||e.key==="Control":true,x=a?e.shiftKey||e.key==="Shift":true,_=l?e.altKey||e.key==="Alt":true,H=k&&y&&x&&_,V=[i,o,a,l].filter(Boolean).length,C=[e.metaKey||e.key==="Meta",e.ctrlKey||e.key==="Control",e.shiftKey||e.key==="Shift",e.altKey||e.key==="Alt"].filter(Boolean).length;return H&&C>=V}let u=e.key?.toLowerCase()===r.toLowerCase()||Jr(r,e.code),p=i||o||a||l?(i?e.metaKey:true)&&(o?e.ctrlKey:true)&&(a?e.shiftKey:true)&&(l?e.altKey:true):e.metaKey||e.ctrlKey;return u&&p}let n=(e.metaKey||e.ctrlKey)&&!e.shiftKey&&!e.altKey;return !!(e.key&&n&&Zn(e.key,e.code))};var ft=(e,t)=>{try{return e.composedPath().some(n=>n instanceof HTMLElement&&n.hasAttribute(t))}catch{return  false}};var Jn={enabled:true,hue:0,selectionBox:{enabled:true},dragBox:{enabled:true},grabbedBoxes:{enabled:true},elementLabel:{enabled:true},crosshair:{enabled:true}},ms=(e,t)=>({enabled:t.enabled??e.enabled,hue:t.hue??e.hue,selectionBox:{enabled:t.selectionBox?.enabled??e.selectionBox.enabled},dragBox:{enabled:t.dragBox?.enabled??e.dragBox.enabled},grabbedBoxes:{enabled:t.grabbedBoxes?.enabled??e.grabbedBoxes.enabled},elementLabel:{enabled:t.elementLabel?.enabled??e.elementLabel.enabled},crosshair:{enabled:t.crosshair?.enabled??e.crosshair.enabled}}),eo=e=>e?ms(Jn,e):Jn,ps=ms;var to="react-grab:agent-sessions",eu=()=>`session-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,gs=(e,t,n,r,i)=>{let o=Date.now();return {id:eu(),context:e,lastStatus:"",isStreaming:true,createdAt:o,lastUpdatedAt:o,position:t,selectionBounds:n,tagName:r,componentName:i}},no=e=>e||null,Mt=new Map,Qn=(e,t)=>{let n=no(t);if(!n){Mt.clear(),e.forEach((r,i)=>Mt.set(i,r));return}try{let r=Object.fromEntries(e);n.setItem(to,JSON.stringify(r));}catch{Mt.clear(),e.forEach((r,i)=>Mt.set(i,r));}},er=(e,t)=>{let n=tr(t);n.set(e.id,e),Qn(n,t);},tr=e=>{let t=no(e);if(!t)return new Map(Mt);try{let n=t.getItem(to);if(!n)return new Map;let r=JSON.parse(n);return new Map(Object.entries(r))}catch{return new Map}};var nr=e=>{let t=no(e);if(!t){Mt.clear();return}try{t.removeItem(to);}catch{Mt.clear();}},ro=(e,t)=>{let n=tr(t);n.delete(e),Qn(n,t);},Ot=(e,t,n)=>{let r={...e,...t,lastUpdatedAt:Date.now()};return er(r,n),r};var hs=e=>{let[t,n]=N(new Map),r=new Map,i=new Map,o=e,a=v=>{o=v;},l=()=>o,c=()=>Array.from(t().values()).some(v=>v.isStreaming),u=async(v,M)=>{let W=o?.storage,z=false;try{for await(let h of M){let f=t().get(v.id);if(!f)break;let b=Ot(f,{lastStatus:h},W);n(L=>new Map(L).set(v.id,b)),o?.onStatus?.(h,b);}let O=t().get(v.id);if(O){let h=o?.provider?.getCompletionMessage?.(),m=Ot(O,{isStreaming:!1,...h?{lastStatus:h}:{}},W);n(L=>new Map(L).set(v.id,m));let f=i.get(v.id),b=await o?.onComplete?.(m,f);if(b?.error){let L=Ot(m,{error:b.error},W);n(j=>new Map(j).set(v.id,L));}}}catch(q){let h=t().get(v.id);if(q instanceof Error&&q.name==="AbortError"){if(z=true,h){let m=i.get(v.id);o?.onAbort?.(h,m);}}else {let m=q instanceof Error?q.message:"Unknown error";if(h){let f=Ot(h,{error:m,isStreaming:false},W);n(b=>new Map(b).set(v.id,f)),q instanceof Error&&o?.onError?.(q,f);}}}finally{r.delete(v.id),z&&(i.delete(v.id),ro(v.id,W),n(q=>{let O=new Map(q);return O.delete(v.id),O}));}},g=v=>{let{selectionBounds:M,tagName:W}=v;if(!M)return;let z=M.x+M.width/2,q=M.y+M.height/2,O=document.elementFromPoint(z,q);if(O&&!(W&&O.tagName.toLowerCase()!==W))return O},p=()=>{let v=o?.storage;if(!v)return;let M=tr(v);if(M.size===0)return;let W=Date.now(),z=Array.from(M.values()).filter(O=>{if(O.isStreaming)return  true;let h=O.lastUpdatedAt??O.createdAt;return W-h<1e4&&!!O.error});if(z.length===0){nr(v);return}if(!o?.provider?.supportsResume||!o.provider.resume){nr(v);return}let q=new Map(z.map(O=>[O.id,O]));n(q),Qn(q,v);for(let O of z){let h=g(O);h&&i.set(O.id,h);let m={...O,isStreaming:true,error:void 0,lastStatus:O.lastStatus||"Resuming...",position:O.position??{x:window.innerWidth/2,y:window.innerHeight/2}};n(L=>new Map(L).set(O.id,m)),o?.onResume?.(m);let f=new AbortController;r.set(O.id,f);let b=o.provider.resume(O.id,f.signal,v);u(O,b);}},k=async v=>{let{element:M,prompt:W,position:z,selectionBounds:q,sessionId:O}=v,h=o?.storage;if(!o?.provider)return;let m=O?t().get(O):void 0,f=!!O,L={content:m?m.context.content:await en([M],{maxLines:1/0}),prompt:W,options:o?.getOptions?.(),sessionId:f?O:void 0},j;if(m)j=Ot(m,{context:L,isStreaming:true,lastStatus:"Thinking\u2026"},h);else {let S=(M.tagName||"").toLowerCase()||void 0,D=await Ze(M)||void 0;j=gs(L,z,q,S,D),j.lastStatus="Thinking\u2026",i.set(j.id,M);}n(S=>new Map(S).set(j.id,j)),er(j,h),o.onStart?.(j,M);let ne=new AbortController;r.set(j.id,ne);let te={...L,sessionId:O??j.id},se=o.provider.send(te,ne.signal);u(j,se);},y=v=>{let M=r.get(v);M&&M.abort();},x=()=>{r.forEach(v=>v.abort()),r.clear(),n(new Map),nr(o?.storage);},_=v=>{let M=o?.storage;i.delete(v),ro(v,M),n(W=>{let z=new Map(W);return z.delete(v),z});};return {sessions:t,isProcessing:c,tryResumeSessions:p,startSession:k,abortSession:y,abortAllSessions:x,dismissSession:_,undoSession:v=>{let W=t().get(v);if(W){let z=i.get(v);o?.onUndo?.(W,z),o?.provider?.undo?.();}_(v);},acknowledgeSessionError:v=>{let z=t().get(v)?.context.prompt;return _(v),z},retrySession:v=>{let W=t().get(v);if(!W||!o?.provider)return;let z=o.storage,q=i.get(v),O=Ot(W,{error:void 0,isStreaming:true,lastStatus:"Retrying\u2026"},z);n(b=>new Map(b).set(v,O)),er(O,z),q&&o.onStart?.(O,q);let h=new AbortController;r.set(v,h);let m={...O.context,sessionId:v},f=o.provider.send(m,h.signal);u(O,f);},updateSessionBoundsOnViewportChange:()=>{let v=t();if(v.size===0)return;let M=new Map(v),W=false;for(let[z,q]of v){let O=i.get(z);if(O&&document.contains(O)){let h=ke(O);if(h){let m=q.selectionBounds,f=q.position;if(m){let b=m.x+m.width/2,L=q.position.x-b,j=h.x+h.width/2;f={...q.position,x:j+L};}M.set(z,{...q,selectionBounds:h,position:f}),W=true;}}}W&&n(M);},getSessionElement:v=>i.get(v),setOptions:a,getOptions:l}};var bs=K('<span class="tabular-nums align-middle">'),ys=K('<span class="font-mono tabular-nums align-middle">&lt;<!>>'),uu=K('<span class="tabular-nums ml-1 align-middle"> in '),du=e=>"scheduler"in globalThis?globalThis.scheduler.postTask(e,{priority:"background"}):"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0),io=false,fu=()=>{if(typeof window>"u")return null;try{let e=document.currentScript?.getAttribute("data-options");return e?JSON.parse(e):null}catch{return null}},so=e=>{let t=eo(e?.theme);if(typeof window>"u")return qr(t);let n=fu(),r={enabled:true,activationMode:"toggle",keyHoldDuration:200,allowActivationInsideInput:true,maxContextLines:3,...n,...e},i=eo(r.theme);return r.enabled===false||io?qr(i):(io=true,(()=>{try{let a="0.0.88",l=`data:image/svg+xml;base64,${btoa(si)}`;console.log(`%cReact Grab${a?` v${a}`:""}%c
https://react-grab.com`,`background: #330039; color: #ffffff; border: 1px solid #d75fcb; padding: 4px 4px 4px 24px; border-radius: 4px; background-image: url("${l}"); background-size: 16px 16px; background-repeat: no-repeat; background-position: 4px center; display: inline-block; margin-bottom: 4px;`,""),navigator.onLine&&a&&fetch(`https://www.react-grab.com/api/version?source=browser&t=${Date.now()}`,{referrerPolicy:"origin",keepalive:!0,priority:"low",cache:"no-store"}).then(c=>c.text()).then(c=>{c&&c!==a&&console.warn(`[React Grab] v${a} is outdated (latest: v${c})`);}).catch(()=>null);}catch{}})(),lt(a=>{let[l,c]=N(i),[u,g]=N(false),[p,k]=N(-1e3),[y,x]=N(-1e3),[_,H]=N(null),V=0,[C,$]=N(false),[Z,v]=N(-1e3),[M,W]=N(-1e3),[z,q]=N(false),[O,h]=N("idle"),[m,f]=N([]),[b,L]=N(null),[j,ne]=N(null),[te,se]=N(null),[S,D]=N([]),[X,Y]=N(false),[G,U]=N(false),[ae,ee]=N(false),[fe,me]=N(false),[we,pe]=N(-1e3),[Te,Se]=N(-1e3),[rt,De]=N(0),[Ve,nn]=N(0),[ge,Ke]=N(false),[sr,Xe]=N(""),[ws,ar]=N(false),[ao,lo]=N(void 0),[co,uo]=N(void 0),[$t,Fe]=N(false),[fo,Qe]=N(false),[St,mt]=N(null),[ot,xs]=N(!!r.agent?.provider),[vs,Ss]=N(false),[Cs,Es]=N(!!r.agent?.provider?.undo),[ks,Ts]=N(!!r.agent?.provider?.supportsFollowUp),[As,_s]=N(r.agent?.provider?.dismissButtonText),[Ns,Sn]=N(null),[Rs,mo]=N(null),[po,Dt]=N(false),[lr,Cn]=N(false),pt=new WeakMap,[cr,ur]=N(-1e3),[dr,fr]=N(-1e3),[rn,on]=N(false),[Ft,go]=N([]),it=s=>(s.tagName||"").toLowerCase(),ho=ce(()=>{let s=Ft();if(!(s.length===0||!s[0]))return it(s[0])||void 0}),[bo]=On(()=>{let s=Ft();return s.length===0||!s[0]?null:s[0]},async s=>{if(s)return await Ze(s)||void 0}),We=()=>{on(false),ur(-1e3),fr(-1e3),go([]);},Is=()=>{let s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0)return;let w=s.getRangeAt(0).getClientRects();if(w.length===0)return;let T=(()=>{if(!s.anchorNode||!s.focusNode)return  false;let F=s.anchorNode.compareDocumentPosition(s.focusNode);return F&Node.DOCUMENT_POSITION_FOLLOWING?false:F&Node.DOCUMENT_POSITION_PRECEDING?true:s.anchorOffset>s.focusOffset})(),R=T?w[0]:w[w.length-1],I=T?R.left:R.right,P=R.top+R.height/2;ur(I),fr(P);};oe(Pe(()=>Ve(),()=>{rn()&&Is();}));let mr=ce(()=>{Ve();let s=Ft();if(!(s.length===0||!s[0]))return ke(s[0])}),st=null,En=null,kn=null,Be=null,Ct=null,sn=null,et=null,Et=null,Ye=ce(()=>X()&&!z()),yo=(s,d)=>({top:d<25,bottom:d>window.innerHeight-25,left:s<25,right:s>window.innerWidth-25}),wo=(s,d)=>{let w=`grabbed-${Date.now()}-${Math.random()}`,T=Date.now(),R={id:w,bounds:s,createdAt:T,element:d},I=S();D([...I,R]),r.onGrabbedBox?.(s,d),setTimeout(()=>{D(P=>P.filter(F=>F.id!==w));},1700);},xo=s=>{let d=s.map(w=>({tagName:it(w)}));window.dispatchEvent(new CustomEvent("react-grab:element-selected",{detail:{elements:d}}));},{createLabelInstance:Ls,updateLabelInstance:vo,removeLabelInstance:Ms}=os(f),kt=async(s,d,w,T,R,I,P,F)=>{if(pe(s),Se(d),T){let Ae=T.x+T.width/2;De(s-Ae);}else De(0);q(true),$s();let ie=T&&R?Ls(T,R,I,"copying",P,s):null;await w().finally(()=>{q(false),me(true),P&&ne(P),Tn(),ie&&(vo(ie,"copied"),setTimeout(()=>{vo(ie,"fading"),setTimeout(()=>{Ms(ie);},350);},1500)),(G()||F)&&Oe();});},pr=(s,d)=>ss(r,s,d),an=async(s,d)=>{r.onElementSelect?.(s),l().grabbedBoxes.enabled&&wo(ke(s),s),await new Promise(w=>requestAnimationFrame(w)),await pr([s],d),xo([s]);},So=async s=>{if(s.length!==0){for(let d of s)r.onElementSelect?.(d);if(l().grabbedBoxes.enabled)for(let d of s)wo(ke(d),d);await new Promise(d=>requestAnimationFrame(d)),await pr(s),xo(s);}},Ne=ce(()=>{if(!Ye()||C())return null;let s=_();return s&&!document.contains(s)?null:s}),Bt=ce(()=>$t()?St():Ne());oe(()=>{let s=_();if(!s)return;let d=setInterval(()=>{document.contains(s)||H(null);},100);be(()=>clearInterval(d));}),oe(()=>{if($t())return;let s=Ne();s&&mt(s);});let Co=ce(()=>{Ve();let s=Bt();if(s)return ke(s)}),Eo=(s,d)=>{let w=s+window.scrollX,T=d+window.scrollY;return {x:Math.abs(w-Z()),y:Math.abs(T-M())}},ko=ce(()=>{if(!C())return  false;let s=Eo(p(),y());return s.x>2||s.y>2}),To=(s,d)=>{let w=s+window.scrollX,T=d+window.scrollY,R=Math.min(Z(),w),I=Math.min(M(),T),P=Math.abs(w-Z()),F=Math.abs(T-M());return {x:R-window.scrollX,y:I-window.scrollY,width:P,height:F}},gt=ce(()=>{if(!ko())return;let s=To(p(),y());return {borderRadius:"0px",height:s.height,transform:"none",width:s.width,x:s.x,y:s.y}}),[Os]=On(()=>Ne(),async s=>s?Ze(s):null),Ps=ce(()=>{let s=Ne(),d=z();if(!s)return (()=>{var R=bs();return B(R,d?"Processing\u2026":"1 element"),R})();let w=it(s),T=Os();return w&&T?[(()=>{var R=ys(),I=R.firstChild,P=I.nextSibling;P.nextSibling;return B(R,w,P),R})(),(()=>{var R=uu();R.firstChild;return B(R,T,null),R})()]:w?(()=>{var R=ys(),I=R.firstChild,P=I.nextSibling;P.nextSibling;return B(R,w,P),R})():(()=>{var R=bs();return B(R,d?"Processing\u2026":"1 element"),R})()}),gr=ce(()=>{if(z()||fo()){Ve();let s=St()||Ne();if(s){let d=ke(s);return {x:d.x+d.width/2+rt(),y:Te()}}return {x:we(),y:Te()}}return {x:p(),y:y()}});oe(Pe(()=>[Ne(),b()],([s,d])=>{d&&s&&d!==s&&L(null),s&&r.onElementHover?.(s);})),oe(Pe(()=>Ne(),s=>{let d=()=>{lo(void 0),uo(void 0);};if(!s){d();return}Jt(s).then(w=>{if(w){for(let T of w)if(T.fileName&&Wn(T.fileName)){lo(vn(T.fileName)),uo(T.lineNumber);return}d();}}).catch(d);})),oe(Pe(()=>Ve(),()=>Ce.updateSessionBoundsOnViewportChange())),oe(Pe(()=>[X(),C(),z(),ge(),Ne(),gt()],([s,d,w,T,R,I])=>{r.onStateChange?.({isActive:s,isDragging:d,isCopying:w,isInputMode:T,targetElement:R,dragBounds:I?{x:I.x,y:I.y,width:I.width,height:I.height}:null});})),oe(Pe(()=>[ge(),p(),y(),Ne()],([s,d,w,T])=>{r.onInputModeChange?.(s,{x:d,y:w,targetElement:T});})),oe(Pe(()=>[Lo(),Co(),Ne()],([s,d,w])=>{r.onSelectionBox?.(!!s,d??null,w);})),oe(Pe(()=>[Mo(),gt()],([s,d])=>{r.onDragBox?.(!!s,d??null);})),oe(Pe(()=>[Oo(),p(),y()],([s,d,w])=>{r.onCrosshair?.(!!s,{x:d,y:w});})),oe(Pe(()=>[ta(),ea(),Ps(),gr()],([s,d,w,T])=>{let R=typeof w=="string"?w:"";r.onElementLabel?.(!!s,d,{x:T.x,y:T.y,content:R});}));let ht=null,Tt=s=>{s?(ht||(ht=document.createElement("style"),ht.setAttribute("data-react-grab-cursor",""),document.head.appendChild(ht)),ht.textContent=`* { cursor: ${s} !important; }`):ht&&(ht.remove(),ht=null);};oe(Pe(()=>[X(),z(),C(),ge(),Ne()],([s,d,w,T,R])=>{Tt(d?"progress":T?null:s&&w?"crosshair":s&&R?"default":s?"crosshair":null);}));let $s=s=>{let d=Date.now(),w=r.keyHoldDuration??200;se(d);let T=()=>{let R=te();if(R===null)return;let P=(Date.now()-R)/w,F=1-Math.exp(-P);(z()?Math.min(F,.95):1)<1&&(kn=requestAnimationFrame(T));};T();},Tn=()=>{kn!==null&&(cancelAnimationFrame(kn),kn=null),se(null);},Ds=()=>{let s=()=>{if(!C()){ln();return}let d=yo(p(),y());d.top&&window.scrollBy(0,-10),d.bottom&&window.scrollBy(0,10),d.left&&window.scrollBy(-10,0),d.right&&window.scrollBy(10,0),d.top||d.bottom||d.left||d.right?Ct=requestAnimationFrame(s):Ct=null;};s();},ln=()=>{Ct!==null&&(cancelAnimationFrame(Ct),Ct=null);},at=()=>{Tn(),sn=document.activeElement,En=Date.now(),Y(true),r.onActivate?.();},Oe=()=>{if(U(false),g(false),Y(false),Ke(false),Xe(""),Fe(false),Qe(false),Dt(false),mt(null),h("idle"),me(false),C()&&($(false),document.body.style.userSelect=""),st&&window.clearTimeout(st),Be&&window.clearTimeout(Be),et){window.clearTimeout(et),et=null;let s=Et;if(Et=null,s){L(s.element);let d=ke(s.element),w=it(s.element);Ze(s.element).then(T=>{kt(s.clientX,s.clientY,()=>an(s.element),d,w,T??void 0,s.element);});}}ln(),Tn(),En=null,sn instanceof HTMLElement&&document.contains(sn)&&sn.focus(),sn=null,r.onDeactivate?.();},An=(s,d)=>{if(d&&document.contains(d)){let w=d.getBoundingClientRect(),T=w.top+w.height/2;k(s.position.x),x(T),mt(d),Xe(s.context.prompt),Qe(true),Ke(true),U(true),Fe(true),X()||at();}},Fs=r.agent?{...r.agent,onAbort:(s,d)=>{r.agent?.onAbort?.(s,d),An(s,d);},onUndo:(s,d)=>{r.agent?.onUndo?.(s,d),An(s,d);}}:void 0,Ce=hs(Fs),Bs=s=>{Xe(s);},Hs=()=>{ne(null);let s=St()||Ne(),d=ge()?sr().trim():"";if(!s){Oe();return}let w=ke(s),T=p(),R=w.x+w.width/2,I=w.y+w.height/2;if(ot()&&d){pt.delete(s),Oe();let F=Ns();Sn(null),mo(null),Ce.startSession({element:s,prompt:d,position:{x:T,y:I},selectionBounds:w,sessionId:F??void 0});return}k(R),x(I),Ke(false),Xe(""),d?pt.set(s,d):pt.delete(s);let P=it(s);Ze(s).then(F=>{kt(R,I,()=>an(s,d||void 0),w,P,F??void 0,s).then(()=>{Oe();});});},hr=()=>{if(ne(null),!ge())return;let s=sr().trim();if(s&&!po()){Dt(true);return}let d=St()||Ne();d&&s&&pt.set(d,s),Dt(false),Sn(null),Oe();},zs=()=>{Dt(false),Sn(null),Oe();},js=()=>{Dt(false);},Vs=()=>{Cn(false),Ce.abortAllSessions();},Us=()=>{Cn(false);},Gs=()=>{if(!ot())return;let s=St()||Ne();if(s){let d=ke(s),w=d.x+d.width/2;pe(p()),Se(y()),De(p()-w);let T=pt.get(s);T&&Xe(T);}U(true),Fe(true),Qe(true),Ke(true);},Ks=async()=>{let s=Ft();if(s.length===0)return;let d=cr(),w=dr(),T=mr(),R=ho();on(false),We(),window.getSelection()?.removeAllRanges();let I=bo();s.length===1?await kt(d,w,()=>an(s[0]),T,R,I):await kt(d,w,()=>So(s),T,R,I);},Xs=()=>{if(!ot()||Ft().length===0)return;let d=mr(),w=d?d.x+d.width/2:cr(),T=d?d.y+d.height/2:dr();on(false),We(),window.getSelection()?.removeAllRanges(),k(w),x(T),U(true),Fe(true),Qe(true),at(),Ke(true);},Ao=(s,d)=>{if(ge()||$t())return;me(false),k(s),x(d);let w=performance.now();if(w-V>=32&&(V=w,du(()=>{let T=Zr(s,d);H(T);})),C()){let T=yo(s,d),R=T.top||T.bottom||T.left||T.right;R&&Ct===null?Ds():!R&&Ct!==null&&ln();}},_o=(s,d)=>{if(!Ye()||z())return  false;$(true);let w=s+window.scrollX,T=d+window.scrollY;return v(w),W(T),document.body.style.userSelect="none",r.onDragStart?.(w,T),true},No=(s,d)=>{if(!C())return;let w=Eo(s,d),T=w.x>2||w.y>2;if($(false),ln(),document.body.style.userSelect="",T){ee(true);let R=To(s,d),I=us(R,Je),P=I.length>0?I:ds(R,Je);if(P.length>0){r.onDragEnd?.(P,R);let F=P[0],ie=F.getBoundingClientRect(),Ae={x:ie.left,y:ie.top,width:ie.width,height:ie.height,borderRadius:"0px",transform:qn(F)},Re=it(F),Ie=Ae.x+Ae.width/2,Ue=Ae.y+Ae.height/2;ot()?(k(Ie),x(Ue),mt(F),U(true),Fe(true),Qe(true),X()||at(),Ke(true)):Ze(F).then(qe=>{kt(Ie,Ue,()=>So(P),Ae,Re,qe??void 0,F,true);});}}else {let R=Zr(s,d);if(!R)return;if(ot()){if(et!==null){window.clearTimeout(et),et=null;let I=Et?.element??R;Et=null;let P=ke(I),F=P.x+P.width/2;pe(s),Se(d),De(s-F);let ie=pt.get(I);ie&&Xe(ie),k(s),x(d),mt(I),U(true),Fe(true),Qe(true),Ke(true);return}Et={clientX:s,clientY:d,element:R},et=window.setTimeout(()=>{et=null;let I=Et;if(Et=null,!I)return;L(I.element);let P=ke(I.element),F=it(I.element);Ze(I.element).then(ie=>{kt(I.clientX,I.clientY,()=>an(I.element),P,F,ie??void 0,I.element);});},250);}else {L(R);let I=ke(R),P=it(R);Ze(R).then(F=>{kt(s,d,()=>an(R),I,P,F??void 0,R);});}}},xe=rs(),Ro=new WeakSet,At=s=>s==="Enter"||s==="NumpadEnter",_t=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key"),Io=false;if(_t?.get&&!_t.get.__reactGrabPatched){Io=true;let s=_t.get,d=function(){return Ro.has(this)?"":s.call(this)};d.__reactGrabPatched=true,Object.defineProperty(KeyboardEvent.prototype,"key",{get:d,configurable:true});}let Ht=s=>{let d;try{d=_t?.get?_t.get.call(s):s.key;}catch{return  false}let w=d==="Enter"||At(s.code),T=X()||u();return w&&T&&!ge()&&!G()?(Ro.add(s),s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),true):false};xe.addDocumentListener("keydown",Ht,{capture:true}),xe.addDocumentListener("keyup",Ht,{capture:true}),xe.addDocumentListener("keypress",Ht,{capture:true}),xe.addWindowListener("keydown",s=>{Ht(s);let d=At(s.code)&&u()&&!ge();if(ge()&&Qr(s,r)&&!s.repeat){s.preventDefault(),s.stopPropagation(),Ke(false),Xe(""),Fe(false),Qe(false),Dt(false);return}if(ge()||ft(s,"data-react-grab-ignore-events")&&!d){s.key==="Escape"&&Ce.isProcessing()&&!lr()&&(s.preventDefault(),s.stopPropagation(),Cn(true));return}if(s.key==="Escape"){if(Ce.isProcessing()){lr()||(s.preventDefault(),s.stopPropagation(),Cn(true));return}if(u()){Oe();return}}if(u()&&!ge()){let I=St()||Ne();if(!I)return;let P=null;switch(s.key){case "ArrowUp":case "ArrowDown":{let F=ke(I),ie=document.elementsFromPoint(F.x+F.width/2,F.y+F.height/2).filter(Je),Ae=ie.indexOf(I);if(Ae!==-1){let Re=s.key==="ArrowUp"?1:-1;P=ie[Ae+Re]??null;}break}case "ArrowRight":case "ArrowLeft":{let F=s.key==="ArrowRight",ie=Re=>{let Ie=Array.from(Re.children),Ue=F?Ie:Ie.reverse();for(let qe of Ue)if(F){if(Je(qe))return qe;let cn=ie(qe);if(cn)return cn}else {let cn=ie(qe);if(cn)return cn;if(Je(qe))return qe}return null},Ae=Re=>F?Re.nextElementSibling:Re.previousElementSibling;if(F&&(P=ie(I)),!P){let Re=I;for(;Re;){let Ie=Ae(Re);for(;Ie;){let qe=ie(Ie);if(qe){P=qe;break}if(Je(Ie)){P=Ie;break}Ie=Ae(Ie);}if(P)break;let Ue=Re.parentElement;if(!F&&Ue&&Je(Ue)){P=Ue;break}Re=Ue;}}break}}if(P){s.preventDefault(),s.stopPropagation(),mt(P),Fe(true);let F=ke(P);k(F.x+F.width/2),x(F.y+F.height/2);return}}let w=j();if(At(s.code)&&!u()&&!ge()&&!X()&&w&&document.contains(w)&&ot()&&!m().some(I=>I.status==="copied"||I.status==="fading")){s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();let I=ke(w),P=I.x+I.width/2,F=I.y+I.height/2;k(P),x(F),pe(P),Se(F),De(0),mt(w),ne(null),f([]);let ie=pt.get(w);ie&&Xe(ie),U(true),Fe(true),Qe(true),at(),Ke(true);return}if(At(s.code)&&u()&&!ge()&&ot()){s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();let I=St()||Ne();if(I){let P=ke(I),F=P.x+P.width/2;pe(p()),Se(y()),De(p()-F);let ie=pt.get(I);ie&&Xe(ie);}U(true),Fe(true),Qe(true),Be!==null&&(window.clearTimeout(Be),Be=null),X()||(st&&window.clearTimeout(st),at()),Ke(true);return}if(s.key?.toLowerCase()==="o"&&!ge()&&X()&&(s.metaKey||s.ctrlKey)){let I=ao(),P=co();if(I)if(s.preventDefault(),s.stopPropagation(),r.onOpenFile)r.onOpenFile(I,P);else {let F=Hn(I,P);window.open(F,"_blank");}return}if(!r.allowActivationInsideInput&&tt(s)||!Qr(s,r)&&(X()&&!G()&&(s.metaKey||s.ctrlKey)&&!zn.includes(s.key)&&!At(s.code)&&Oe(),!At(s.code)||!u()))return;if((X()||u())&&!ge()&&(s.preventDefault(),At(s.code)&&(s.stopPropagation(),s.stopImmediatePropagation())),X()){if(G()&&r.activationMode!=="hold"||s.repeat)return;Be!==null&&window.clearTimeout(Be),Be=window.setTimeout(()=>{Oe();},200);return}if(u()&&s.repeat)return;st!==null&&window.clearTimeout(st),u()||g(true);let T=r.keyHoldDuration??200,R=tt(s)?T+150:T;st=window.setTimeout(()=>{r.activationMode!=="hold"&&U(true),at();},R);},{capture:true}),xe.addWindowListener("keyup",s=>{if(Ht(s)||!u()&&!X()||ge())return;let d=!!(r.activationShortcut||r.activationKey),T=(()=>{if(r.activationKey){let{metaKey:P,ctrlKey:F,shiftKey:ie,altKey:Ae}=r.activationKey;return {metaKey:!!P,ctrlKey:!!F,shiftKey:!!ie,altKey:!!Ae}}return {metaKey:true,ctrlKey:true,shiftKey:false,altKey:false}})(),R=T.metaKey||T.ctrlKey?!s.metaKey&&!s.ctrlKey:T.shiftKey&&!s.shiftKey||T.altKey&&!s.altKey,I=r.activationShortcut?!r.activationShortcut(s):r.activationKey?r.activationKey.key?s.key?.toLowerCase()===r.activationKey.key.toLowerCase()||Jr(r.activationKey.key,s.code):false:Zn(s.key,s.code);if(X()){if(R){if(G()&&r.activationMode!=="hold")return;Oe();}else !d&&I&&Be!==null&&(window.clearTimeout(Be),Be=null);return}if(I||R){if(G()&&r.activationMode!=="hold")return;Oe();}},{capture:true}),xe.addWindowListener("keypress",Ht,{capture:true}),xe.addWindowListener("mousemove",s=>{ar(false),!ft(s,"data-react-grab-ignore-events")&&(u()&&!ge()&&$t()&&Fe(false),Ao(s.clientX,s.clientY));}),xe.addWindowListener("mousedown",s=>{if(s.button!==0||ft(s,"data-react-grab-ignore-events"))return;if(ge()){hr();return}_o(s.clientX,s.clientY)&&(s.preventDefault(),s.stopPropagation());},{capture:true}),xe.addWindowListener("pointerdown",s=>{s.button===0&&(ft(s,"data-react-grab-ignore-events")||!Ye()||z()||ge()||s.stopPropagation());},{capture:true}),xe.addWindowListener("mouseup",s=>{s.button===0&&No(s.clientX,s.clientY);}),xe.addWindowListener("touchmove",s=>{s.touches.length!==0&&(ar(true),!ft(s,"data-react-grab-ignore-events")&&(u()&&!ge()&&$t()&&Fe(false),Ao(s.touches[0].clientX,s.touches[0].clientY)));},{passive:true}),xe.addWindowListener("touchstart",s=>{if(s.touches.length===0||(ar(true),ft(s,"data-react-grab-ignore-events")))return;if(ge()){hr();return}_o(s.touches[0].clientX,s.touches[0].clientY)&&s.preventDefault();},{passive:false}),xe.addWindowListener("touchend",s=>{s.changedTouches.length!==0&&No(s.changedTouches[0].clientX,s.changedTouches[0].clientY);}),xe.addWindowListener("click",s=>{ft(s,"data-react-grab-ignore-events")||(Ye()||z()||ae())&&(s.preventDefault(),s.stopPropagation(),ae()&&ee(false),G()&&!z()&&!ge()&&(u()?U(false):Oe()));},{capture:true}),xe.addDocumentListener("visibilitychange",()=>{document.hidden&&(D([]),X()&&!ge()&&En!==null&&Date.now()-En>500&&Oe());}),xe.addWindowListener("scroll",()=>{nn(s=>s+1);},{capture:true}),xe.addWindowListener("resize",()=>{nn(s=>s+1);}),xe.addWindowListener("popstate",()=>{We();});let Nt=null,Ws=()=>{let s=l().enabled&&(rn()||X()||z()||m().length>0||S().length>0||Ce.sessions().size>0);s&&Nt===null?Nt=window.setInterval(()=>{if(nn(d=>d+1),rn()){let d=Ft();d.length>0&&d[0]&&document.body.contains(d[0])||We();}},100):!s&&Nt!==null&&(window.clearInterval(Nt),Nt=null);};oe(()=>{l().enabled,rn(),X(),z(),m().length,S().length,Ce.sessions().size,Ws();}),be(()=>{Nt!==null&&window.clearInterval(Nt);}),xe.addDocumentListener("copy",s=>{ge()||ft(s,"data-react-grab-ignore-events")||(Ye()||z())&&s.preventDefault();},{capture:true});let _n=null;xe.addDocumentListener("selectionchange",()=>{if(Ye())return;_n!==null&&window.clearTimeout(_n),on(false);let s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0){We();return}_n=window.setTimeout(()=>{_n=null;let d=window.getSelection();if(!d||d.isCollapsed||d.rangeCount===0){We();return}let w=d.getRangeAt(0),T=w.getBoundingClientRect();if(T.width===0&&T.height===0){We();return}if(!d.toString().trim()){We();return}let I=(()=>{if(!d.anchorNode||!d.focusNode)return  false;let Ue=d.anchorNode.compareDocumentPosition(d.focusNode);return Ue&Node.DOCUMENT_POSITION_FOLLOWING?false:Ue&Node.DOCUMENT_POSITION_PRECEDING?true:d.anchorOffset>d.focusOffset})(),P=w.getClientRects();if(P.length===0){We();return}let F=I?P[0]:P[P.length-1],ie=I?F.left:F.right,Ae=F.top+F.height/2;if(ri(ie,Ae)){We();return}let Re=w.commonAncestorContainer,Ie=Re.nodeType===Node.ELEMENT_NODE?Re:Re.parentElement;Ie&&Je(Ie)?(ur(ie),fr(Ae),go([Ie]),on(true)):We();},150);}),be(()=>{xe.abort(),st&&window.clearTimeout(st),Be&&window.clearTimeout(Be),et&&window.clearTimeout(et),ln(),Tn(),document.body.style.userSelect="",Tt(null),Io&&_t&&Object.defineProperty(KeyboardEvent.prototype,"key",_t);});let br=oi(ti),Lo=ce(()=>!l().selectionBox.enabled||fe()?false:Ye()&&!C()&&!!Bt()),Ys=ce(()=>{let s=Bt();if(s)return it(s)||void 0}),[qs]=On(()=>Bt(),async s=>s?await Ze(s)??void 0:void 0),Zs=ce(()=>!l().elementLabel.enabled||fe()?false:Ye()&&!C()&&!!Bt()),Js=ce(()=>(Ve(),m().map(s=>!s.element||!document.body.contains(s.element)?s:{...s,bounds:ke(s.element)}))),Qs=ce(()=>(Ve(),S().map(s=>!s.element||!document.body.contains(s.element)?s:{...s,bounds:ke(s.element)}))),Mo=ce(()=>l().dragBox.enabled&&Ye()&&ko()),ea=ce(()=>z()?"processing":"hover"),ta=ce(()=>!l().elementLabel.enabled||ge()?false:z()?true:Ye()&&!C()&&!!Bt()),Oo=ce(()=>l().crosshair.enabled&&Ye()&&!C()&&!ws()&&!$t()),na=ce(()=>l().grabbedBoxes.enabled);return oe(Pe(l,s=>{s.hue!==0?br.style.filter=`hue-rotate(${s.hue}deg)`:br.style.filter="";})),l().enabled&&Qo(()=>A(Li,{get selectionVisible(){return Lo()},get selectionBounds(){return Co()},get selectionFilePath(){return ao()},get selectionLineNumber(){return co()},get selectionTagName(){return Ys()},get selectionComponentName(){return qs()},get selectionLabelVisible(){return Zs()},get selectionLabelStatus(){return O()},get labelInstances(){return Js()},get dragVisible(){return Mo()},get dragBounds(){return gt()},get grabbedBoxes(){return ye(()=>!!na())()?Qs():[]},labelZIndex:2147483647,get mouseX(){return gr().x},get mouseY(){return gr().y},get crosshairVisible(){return Oo()},get inputValue(){return sr()},get isInputExpanded(){return fo()},get replyToPrompt(){return Rs()??void 0},get hasAgent(){return ot()},get isAgentConnected(){return vs()},get agentSessions(){return Ce.sessions()},get supportsUndo(){return Cs()},get supportsFollowUp(){return ks()},get dismissButtonText(){return As()},onAbortSession:s=>Ce.abortSession(s),onDismissSession:s=>Ce.dismissSession(s),onUndoSession:s=>Ce.undoSession(s),onReplySession:s=>{let d=Ce.sessions().get(s),w=Ce.getSessionElement(s);if(d&&w){let T=d.position.x,R=w.getBoundingClientRect(),I=R.top+R.height/2,P=d.context.prompt;Ce.dismissSession(s),k(T),x(I),mt(w),Xe(""),Qe(true),Ke(true),U(true),Fe(true),Sn(d.context.sessionId??s),mo(P),X()||at();}},onAcknowledgeSessionError:s=>{let d=Ce.acknowledgeSessionError(s);d&&Xe(d);},onRetrySession:s=>{Ce.retrySession(s);},onInputChange:Bs,onInputSubmit:()=>void Hs(),onInputCancel:hr,onToggleExpand:Gs,get isPendingDismiss(){return po()},onConfirmDismiss:zs,onCancelDismiss:js,get isPendingAgentAbort(){return lr()},onConfirmAgentAbort:Vs,onCancelAgentAbort:Us,get nativeSelectionCursorVisible(){return rn()},get nativeSelectionCursorX(){return cr()},get nativeSelectionCursorY(){return dr()},get nativeSelectionTagName(){return ho()},get nativeSelectionComponentName(){return bo()},get nativeSelectionBounds(){return mr()},onNativeSelectionCopy:()=>void Ks(),onNativeSelectionEnter:Xs,get theme(){return l()}}),br),ot()&&Ce.tryResumeSessions(),{activate:()=>{X()||(U(true),at());},deactivate:()=>{X()&&Oe();},toggle:()=>{X()?Oe():(U(true),at());},isActive:()=>X(),dispose:()=>{io=false,a();},copyElement:async s=>{let d=Array.isArray(s)?s:[s];return d.length===0?false:await pr(d)},getState:()=>({isActive:X(),isDragging:C(),isCopying:z(),isInputMode:ge(),targetElement:Ne(),dragBounds:gt()?{x:gt().x,y:gt().y,width:gt().width,height:gt().height}:null}),updateTheme:s=>{let d=l(),w=ps(d,s);c(w);},getTheme:()=>l(),setAgent:s=>{let d=Ce.getOptions(),w={...d,...s,provider:s.provider??d?.provider,onAbort:(T,R)=>{s?.onAbort?.(T,R),An(T,R);},onUndo:(T,R)=>{s?.onUndo?.(T,R),An(T,R);}};Ce.setOptions(w),xs(!!w.provider),Es(!!w.provider?.undo),Ts(!!w.provider?.supportsFollowUp),_s(w.provider?.dismissButtonText),w.provider?.checkConnection&&w.provider.checkConnection().then(T=>{Ss(T);}),Ce.tryResumeSessions();},updateOptions:s=>{r={...r,...s};}}}))};var Pt=null,Wp=()=>typeof window>"u"?Pt:window.__REACT_GRAB__??Pt??null,Yp=e=>{Pt=e,typeof window<"u"&&(e?window.__REACT_GRAB__=e:delete window.__REACT_GRAB__);};typeof window<"u"&&(window.__REACT_GRAB__?Pt=window.__REACT_GRAB__:(Pt=so(),window.__REACT_GRAB__=Pt,window.dispatchEvent(new CustomEvent("react-grab:init",{detail:Pt}))));/*! Bundled license information:

bippy/dist/rdt-hook-CqLYUkwN.js:
  (**
   * @license bippy
   *
   * Copyright (c) Aiden Bai
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)

bippy/dist/core-BmxLxXeu.js:
  (**
   * @license bippy
   *
   * Copyright (c) Aiden Bai
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)

bippy/dist/source.js:
  (**
   * @license bippy
   *
   * Copyright (c) Aiden Bai
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)

bippy/dist/install-hook-only-B8zA_JcI.js:
  (**
   * @license bippy
   *
   * Copyright (c) Aiden Bai
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)

bippy/dist/index.js:
  (**
   * @license bippy
   *
   * Copyright (c) Aiden Bai
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)
*/exports.DEFAULT_THEME=Jn;exports.formatElementInfo=Yn;exports.generateSnippet=en;exports.getGlobalApi=Wp;exports.getStack=Jt;exports.init=so;exports.isInstrumentationActive=Zt;exports.setGlobalApi=Yp;return exports;})({});
```


## src/App.tsx

```tsx
import { useEffect } from 'react'
import { Routes, Route, useLocation, Navigate } from 'react-router-dom'
import { useAuthStore } from './stores/authStore'
import { useNavigationStore } from './stores/navigationStore'
import DesktopLayout from './components/layout/DesktopLayout'
import LoginView from './views/LoginView'
import GenerateModule from './components/modules/GenerateModule'
import OptimizeModule from './components/modules/OptimizeModule'
import PlaygroundModule from './components/modules/PlaygroundModule'
import LibraryModule from './components/modules/LibraryModule'
import SettingsModal from './components/settings/SettingsModal'
import NotificationContainer from './components/NotificationContainer'

function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const token = useAuthStore((state) => state.token)
  const user = useAuthStore((state) => state.user)
  const isLoggedIn = !!token && !!user
  
  if (!isLoggedIn) {
    return <Navigate to="/login" replace />
  }
  
  return <>{children}</>
}

function App() {
  const location = useLocation()
  const initialize = useAuthStore((state) => state.initialize)
  // ä½¿ç”¨ useRef æ¥å­˜å‚¨ç¨³å®šçš„å‡½æ•°å¼•ç”¨ï¼Œé¿å…æ— é™å¾ªç¯
  const navigationStore = useNavigationStore()
  const currentModule = useNavigationStore((state) => state.currentModule)
  
  const isLoginPage = location.pathname === '/login'
  
  // åˆå§‹åŒ–è®¤è¯çŠ¶æ€ - åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡
  useEffect(() => {
    initialize()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []) // ç©ºä¾èµ–æ•°ç»„ï¼Œåªåœ¨æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡
  
  // ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œæ›´æ–°å½“å‰æ¨¡å—
  // åªä¾èµ– location.pathname å’Œ isLoginPageï¼Œé¿å…ä¾èµ– store å‡½æ•°
  useEffect(() => {
    if (!isLoginPage) {
      const module = navigationStore.getModuleByPath(location.pathname)
      if (module && currentModule !== module.id) {
        navigationStore.setCurrentModule(module.id)
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [location.pathname, isLoginPage]) // ç§»é™¤å‡½æ•°ä¾èµ–ï¼Œåªä¾èµ–è·¯å¾„
  
  return (
    <div id="app" className="min-h-screen bg-[var(--ct-slate-50)] text-[var(--ct-slate-900)]">
      <Routes>
        <Route path="/login" element={<LoginView />} />
        <Route
          path="/"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <Navigate to="/generate" replace />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route
          path="/generate"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <GenerateModule />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route
          path="/optimize"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <OptimizeModule />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route
          path="/optimize/:id?"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <OptimizeModule />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route
          path="/playground"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <PlaygroundModule />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route
          path="/library"
          element={
            <ProtectedRoute>
              <DesktopLayout>
                <LibraryModule />
              </DesktopLayout>
            </ProtectedRoute>
          }
        />
        <Route path="*" element={<Navigate to="/login" replace />} />
      </Routes>
      
      {/* å…¨å±€è®¾ç½®å¼¹çª— */}
      <SettingsModal />
      
      {/* å…¨å±€é€šçŸ¥å®¹å™¨ */}
      <NotificationContainer />
    </div>
  )
}

export default App

```


## src/components/ChatInterface.tsx

```tsx
import { useRef, useEffect } from 'react'
import { Upload } from 'lucide-react'
import { usePromptStore } from '@/stores/promptStore'
import { useChatMessages } from '@/hooks/useChatMessages'
import { useChatInput } from '@/hooks/useChatInput'
import { useChatAttachments } from '@/hooks/useChatAttachments'
import { useChatModel } from '@/hooks/useChatModel'
import { useChatQuickReplies } from '@/hooks/useChatQuickReplies'
import { useChatLogic } from '@/hooks/useChatLogic'
import { useChatMessageOperations } from '@/hooks/useChatMessageOperations'
import ChatHeader from './chat/components/ChatHeader'
import ChatMessageList from './chat/components/ChatMessageList'
import ChatQuickReplies from './chat/components/ChatQuickReplies'
import ChatInputArea from './chat/components/ChatInputArea'

export default function ChatInterface() {
  const inputContainerRef = useRef<HTMLDivElement>(null)
  
  // ä½¿ç”¨é€‰æ‹©å™¨æ¥é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  const isGenerating = usePromptStore((state) => state.isGenerating)
  const isTyping = usePromptStore((state) => state.isTyping)
  const chatMessagesFromStore = usePromptStore((state) => state.chatMessages)
  
  const chatMessages = useChatMessages()
  const chatInput = useChatInput()
  const chatAttachments = useChatAttachments()
  const chatModel = useChatModel()
  const chatQuickReplies = useChatQuickReplies(inputContainerRef)
  const chatMessageOperations = useChatMessageOperations()
  
  const chatLogic = useChatLogic({
    chatMessages,
    chatModel,
    chatInput,
    chatAttachments,
    chatQuickReplies
  })

  useEffect(() => {
    chatLogic.initializeChat()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []) // åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–ä¸€æ¬¡

  const handleSendMessage = () => {
    if (!chatInput.userInput.trim() && chatAttachments.currentAttachments.length === 0) {
      return
    }
    
    chatLogic.sendMessage(chatInput.userInput)
  }

  const handleInputKeydown = (event: React.KeyboardEvent) => {
    chatInput.handleKeydown(event, handleSendMessage)
  }

  const handleQuickReplySelect = (reply: string) => {
    chatQuickReplies.selectQuickReply(reply, (selectedReply: string) => {
      chatInput.setUserInput(selectedReply)
      handleSendMessage()
    })
  }

  const handleClearChat = () => {
    chatLogic.clearChat()
  }

  const handleInterrupt = () => {
    chatLogic.interruptGeneration()
  }

  const handleRegenerate = (messageId: string, messageIndex: number) => {
    const { provider, model } = chatModel.getCurrentChatModel()
    chatLogic.regenerateMessage(messageId, messageIndex, provider, model)
  }

  const handleResend = (messageId: string, messageIndex: number) => {
    // å¤„ç†ç¼–è¾‘åçš„é‡æ–°å‘é€ - å…ˆä¿å­˜ç¼–è¾‘
    const message = chatMessagesFromStore.find(msg => msg.id === messageId)
    if (message && message.type === 'user' && message.isEditing) {
      chatMessageOperations.saveEdit(messageId)
    }
    const { provider, model } = chatModel.getCurrentChatModel()
    chatLogic.resendUserMessage(messageId, messageIndex, provider, model)
  }

  const handleResendUser = (messageId: string, messageIndex: number) => {
    const { provider, model } = chatModel.getCurrentChatModel()
    chatLogic.resendUserMessage(messageId, messageIndex, provider, model)
  }

  return (
    <div
      className="bg-white rounded-lg shadow-sm flex flex-col h-full max-h-full overflow-hidden relative"
      onDragOver={chatAttachments.handleGlobalDragOver}
      onDragEnter={chatAttachments.handleGlobalDragEnter}
      onDragLeave={chatAttachments.handleGlobalDragLeave}
      onDrop={chatAttachments.handleGlobalDrop}
    >
      {/* Chat Header */}
      <ChatHeader
        isStreamMode={chatModel.isStreamMode}
        isGenerating={isGenerating}
        isTyping={isTyping}
        onToggleStream={chatModel.toggleStreamMode}
        onClearChat={handleClearChat}
        onInterrupt={handleInterrupt}
      />

      {/* Chat Messages */}
      <ChatMessageList
        chatContainerRef={chatMessages.chatContainer}
        messages={chatMessagesFromStore}
        renderMarkdown={chatMessages.renderMarkdown}
        renderUserMessage={chatMessages.renderUserMessage}
        chatContainerMaxHeight={chatLogic.chatContainerMaxHeight}
        editingContent={chatMessageOperations.editingContent}
        isTyping={isTyping}
        isGenerating={isGenerating}
        onStartEdit={chatMessageOperations.startEdit}
        onSaveEdit={chatMessageOperations.saveEdit}
        onCancelEdit={chatMessageOperations.cancelEdit}
        onDelete={chatMessageOperations.deleteMessage}
        onCopy={chatMessageOperations.copyMessage}
        onRegenerate={handleRegenerate}
        onResend={handleResend}
        onResendUser={handleResendUser}
        onEditKeydown={chatMessageOperations.handleEditKeydown}
        onSetEditRef={chatMessageOperations.setEditTextareaRef}
        onSetMessageRef={chatMessageOperations.setMessageRef}
        onUpdateEditingContent={chatMessageOperations.updateEditingContent}
      />

      {/* å¿«é€Ÿå›å¤é€‰é¡¹ */}
      <ChatQuickReplies
        show={chatQuickReplies.shouldShowQuickReplies}
        replies={chatQuickReplies.quickReplies}
        quickRepliesContainerRef={chatQuickReplies.quickRepliesContainerRef}
        inputContainerRef={inputContainerRef}
        onSelect={handleQuickReplySelect}
      />

      {/* Input Area */}
      <div ref={inputContainerRef}>
        <ChatInputArea
          isEditing={chatMessageOperations.isEditing}
          userInput={chatInput.userInput}
          setUserInput={chatInput.setUserInput}
          attachments={chatAttachments.currentAttachments}
          placeholder={chatQuickReplies.shouldShowQuickReplies ? 'è¾“å…¥æˆ–ç‚¹å‡»ä¸Šæ–¹å¿«é€Ÿå›å¤...' : 'Shift+Enteræ¢è¡Œ'}
          isDisabled={isTyping || isGenerating}
          textareaRef={chatInput.textareaRef}
          showQuickReplies={chatQuickReplies.shouldShowQuickReplies}
          quickReplies={chatQuickReplies.quickReplies}
          quickRepliesContainerRef={chatQuickReplies.quickRepliesContainerRef}
          onKeydown={handleInputKeydown}
          onCompositionStart={chatInput.handleCompositionStart}
          onCompositionEnd={chatInput.handleCompositionEnd}
          onFocus={() => chatQuickReplies.setShowQuickReplies(true)}
          onSend={handleSendMessage}
          onFileSelect={chatAttachments.handleFileSelect}
          onRemoveAttachment={chatAttachments.removeAttachment}
          onClearAttachments={chatAttachments.clearAttachments}
          onQuickReplySelect={handleQuickReplySelect}
          fileInputRef={chatAttachments.fileInputRef}
        />
      </div>
      
      {/* å…¨å±€æ‹–æ‹½è¦†ç›–å±‚ */}
      {chatAttachments.isGlobalDragging && (
        <div className="absolute inset-0 bg-blue-50 bg-opacity-90 flex items-center justify-center z-50 border-2 border-dashed border-blue-400 rounded-lg">
          <div className="text-center">
            <Upload className="w-12 h-12 mx-auto mb-4 text-blue-500" />
            <div className="text-lg font-medium text-blue-700 mb-2">
              é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ 
            </div>
            <div className="text-sm text-blue-600">
              æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘ç­‰æ ¼å¼
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

```


## src/components/GenerateSettingsModal.tsx

```tsx
// å ä½ç»„ä»¶ - å¾…é‡æ„
export default function GenerateSettingsModal() {
  return null
}

```


## src/components/GitCommit.tsx

```tsx
export default function GitCommit() {
  const commitHash = import.meta.env.VITE_GIT_COMMIT_HASH || ''
  const commitDate = import.meta.env.VITE_GIT_COMMIT_DATE || ''
  
  if (!commitHash) {
    return null
  }
  
  return (
    <div
      className="git-commit-badge inline-flex items-center gap-1.5 px-1.5 py-0.5 bg-transparent border-0 rounded-none text-[10px] font-mono text-gray-400 cursor-default transition-colors hover:text-gray-500"
      title={`Git Commit: ${commitHash}${commitDate ? `\nDate: ${commitDate}` : ''}`}
    >
      <svg
        className="git-icon w-3 h-3 flex-shrink-0 opacity-50"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
      >
        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
      </svg>
      <span className="commit-hash font-normal tracking-wide select-text">{commitHash}</span>
    </div>
  )
}

```


## src/components/NotificationContainer.tsx

```tsx
import { createPortal } from 'react-dom'
import { CheckCircle, XCircle, AlertTriangle, Info, X } from 'lucide-react'
import { useNotificationStore } from '@/stores/notificationStore'
import { useState, useEffect } from 'react'

export default function NotificationContainer() {
  const notifications = useNotificationStore((state) => state.notifications)
  const removeNotification = useNotificationStore((state) => state.removeNotification)
  const confirmDialog = useNotificationStore((state) => state.confirmDialog)
  const closeConfirmDialog = useNotificationStore((state) => state.closeConfirmDialog)
  const [isDialogVisible, setIsDialogVisible] = useState(false)
  
  const getNotificationClasses = (type: string) => {
    switch (type) {
      case 'success':
        return 'bg-white/95 border border-green-200/50 text-green-800 shadow-green-100/50'
      case 'error':
        return 'bg-white/95 border border-red-200/50 text-red-800 shadow-red-100/50'
      case 'warning':
        return 'bg-white/95 border border-yellow-200/50 text-yellow-800 shadow-yellow-100/50'
      case 'info':
        return 'bg-white/95 border border-blue-200/50 text-blue-800 shadow-blue-100/50'
      default:
        return 'bg-white/95 border border-gray-200/50 text-gray-800 shadow-gray-100/50'
    }
  }
  
  const getIconColor = (type: string) => {
    switch (type) {
      case 'success':
        return 'text-green-600'
      case 'error':
        return 'text-red-600'
      case 'warning':
        return 'text-yellow-600'
      case 'info':
        return 'text-blue-600'
      default:
        return 'text-gray-600'
    }
  }
  
  const getIcon = (type: string) => {
    switch (type) {
      case 'success':
        return CheckCircle
      case 'error':
        return XCircle
      case 'warning':
        return AlertTriangle
      case 'info':
        return Info
      default:
        return Info
    }
  }
  
  // å¤„ç†ç¡®è®¤å¯¹è¯æ¡†çš„æ˜¾ç¤º/éšè—åŠ¨ç”»
  useEffect(() => {
    if (confirmDialog) {
      setIsDialogVisible(true)
    } else {
      setIsDialogVisible(false)
    }
  }, [confirmDialog])

  const content = (
    <>
      {/* é€šçŸ¥åˆ—è¡¨ */}
      <div className="fixed bottom-4 right-4 z-[9999] space-y-2 pointer-events-none">
        {notifications.map((notification) => {
          const Icon = getIcon(notification.type)
          return (
            <div
              key={notification.id}
              className={`max-w-sm w-full shadow-xl rounded-lg pointer-events-auto overflow-hidden backdrop-blur-sm transform transition-all duration-300 ease-out ${getNotificationClasses(notification.type)}`}
              style={{
                animation: 'slideIn 0.3s ease-out'
              }}
            >
              <div className="p-4">
                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0 mt-0.5">
                    <Icon className={`h-5 w-5 ${getIconColor(notification.type)}`} />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium break-words leading-relaxed">
                      {notification.message}
                    </p>
                  </div>
                  <div className="flex-shrink-0">
                    <button
                      onClick={() => removeNotification(notification.id)}
                      className="inline-flex text-gray-400 hover:text-gray-600 focus:outline-none transition-colors rounded p-0.5 hover:bg-black/5"
                    >
                      <X className="h-4 w-4" />
                    </button>
                  </div>
                </div>
              </div>
              {/* è¿›åº¦æ¡ */}
              {notification.duration && notification.duration > 0 && (
                <div className="h-1 bg-black/10 overflow-hidden">
                  <div
                    className="h-full bg-current opacity-30 transition-all linear"
                    style={{
                      animation: `shrink ${notification.duration}ms linear forwards`,
                      animationFillMode: 'forwards'
                    }}
                  />
                </div>
              )}
            </div>
          )
        })}
      </div>

      {/* ç¡®è®¤å¯¹è¯æ¡† */}
      {confirmDialog && (
        <div 
          className={`fixed bottom-4 right-4 z-[10000] transition-all duration-300 ease-out ${
            isDialogVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
          }`}
        >
          <div className="max-w-sm w-full bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden backdrop-blur-sm">
            <div className="p-4">
              <div className="flex items-start gap-3">
                <div className="flex-shrink-0 mt-0.5">
                  {confirmDialog.type === 'warning' ? (
                    <AlertTriangle className="h-5 w-5 text-yellow-600" />
                  ) : (
                    <Info className="h-5 w-5 text-blue-600" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-slate-900 break-words leading-relaxed">
                    {confirmDialog.message}
                  </p>
                </div>
              </div>
              <div className="flex items-center justify-end gap-2 mt-4">
                <button
                  onClick={() => closeConfirmDialog(false)}
                  className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                >
                  {confirmDialog.cancelText || 'å–æ¶ˆ'}
                </button>
                <button
                  onClick={() => closeConfirmDialog(true)}
                  className="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-violet-600 rounded-lg hover:shadow-lg hover:-translate-y-0.5 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                >
                  {confirmDialog.confirmText || 'ç¡®è®¤'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  )
  
  return createPortal(content, document.body)
}

```


## src/components/PreviewPanel.tsx

```tsx
import { useState, useEffect, useRef } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { usePreviewTabs } from '@/hooks/usePreviewTabs'
import { usePreviewExecution } from '@/hooks/usePreviewExecution'
import { usePreviewConversion } from '@/hooks/usePreviewConversion'
import { usePreviewScrollSync } from '@/hooks/usePreviewScrollSync'
import { usePreviewClipboard } from '@/hooks/usePreviewClipboard'
import { usePreviewListOperations } from '@/hooks/usePreviewListOperations'
import { usePreviewHelpers } from '@/hooks/usePreviewHelpers'
import PreviewHeader from './preview/components/common/PreviewHeader'
import TabContainer from './preview/components/common/TabContainer'
import TabButton from './preview/components/common/TabButton'
import EmptyState from './preview/components/common/EmptyState'
import LoadingState from './preview/components/common/LoadingState'
import ReportTab from './preview/components/tabs/ReportTab'
import ThinkingTab from './preview/components/tabs/ThinkingTab'
import InitialTab from './preview/components/tabs/InitialTab'
import AdviceTab from './preview/components/tabs/AdviceTab'
import FinalTab from './preview/components/tabs/FinalTab'
import SavePromptDialog from './preview/components/dialogs/SavePromptDialog'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''

export default function PreviewPanel() {
  // ä½¿ç”¨é€‰æ‹©å™¨æ¥é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  const notificationStore = useNotificationStore()
  
  const [isSaving, setIsSaving] = useState(false)
  const [showSaveDialog, setShowSaveDialog] = useState(false)
  const [currentPromptContent, setCurrentPromptContent] = useState('')

  const tabs = usePreviewTabs()
  const scrollSync = usePreviewScrollSync()
  const conversion = usePreviewConversion()
  const clipboard = usePreviewClipboard()
  const listOps = usePreviewListOperations()
  const helpers = usePreviewHelpers()

  const execution = usePreviewExecution({
    switchToTabWithScroll: tabs.switchToTabWithScroll,
    scrollToBottomOfContent: scrollSync.scrollToBottomOfContent
  })

  // ç›‘å¬ promptData å˜åŒ–ï¼Œè‡ªåŠ¨åˆ‡æ¢æ ‡ç­¾é¡µ
  // ä½¿ç”¨é€‰æ‹©å™¨æ¥é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  const requirementReport = usePromptStore((state) => state.promptData.requirementReport)
  const thinkingPoints = usePromptStore((state) => state.promptData.thinkingPoints)
  const initialPrompt = usePromptStore((state) => state.promptData.initialPrompt)
  const advice = usePromptStore((state) => state.promptData.advice)
  const generatedPrompt = usePromptStore((state) => state.promptData.generatedPrompt)
  const isGenerating = usePromptStore((state) => state.isGenerating)
  const chatMessages = usePromptStore((state) => state.chatMessages)
  
  // ä½¿ç”¨ useRef å­˜å‚¨ç¨³å®šçš„å‡½æ•°å¼•ç”¨
  const tabsRef = useRef(tabs)
  tabsRef.current = tabs

  // ç›‘å¬èŠå¤©æ¶ˆæ¯æ•°é‡ï¼Œæ¸…ç©ºæ—¶é‡ç½®æ ‡ç­¾é¡µ
  useEffect(() => {
    if (chatMessages.length === 0) {
      tabsRef.current.switchToTabWithScroll('report')
      tabsRef.current.setNewContentTabs(new Set())
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [chatMessages.length])

  useEffect(() => {
    if (requirementReport && requirementReport.trim().length > 0) {
      tabsRef.current.setNewContentTabs(prev => {
        const newSet = new Set(prev)
        newSet.add('report')
        return newSet
      })
      tabsRef.current.switchToTabWithScroll('report')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [requirementReport]) // åªä¾èµ–æ•°æ®ï¼Œä¸ä¾èµ–å‡½æ•°

  useEffect(() => {
    if (thinkingPoints && thinkingPoints.length > 0) {
      tabsRef.current.setNewContentTabs(prev => {
        const newSet = new Set(prev)
        newSet.add('thinking')
        return newSet
      })
      tabsRef.current.switchToTabWithScroll('thinking')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [thinkingPoints])

  useEffect(() => {
    if (initialPrompt && initialPrompt.trim().length > 0) {
      tabsRef.current.setNewContentTabs(prev => {
        const newSet = new Set(prev)
        newSet.add('initial')
        return newSet
      })
      tabsRef.current.switchToTabWithScroll('initial')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [initialPrompt])

  useEffect(() => {
    if (advice && advice.length > 0) {
      tabsRef.current.setNewContentTabs(prev => {
        const newSet = new Set(prev)
        newSet.add('advice')
        return newSet
      })
      tabsRef.current.switchToTabWithScroll('advice')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [advice])

  useEffect(() => {
    let hasContent = false
    if (typeof generatedPrompt === 'string') {
      hasContent = generatedPrompt.trim().length > 0
    } else if (generatedPrompt && typeof generatedPrompt === 'object' && 'markdown' in generatedPrompt && 'xml' in generatedPrompt) {
      hasContent = Boolean(
        (generatedPrompt.markdown.zh && generatedPrompt.markdown.zh.trim().length > 0) ||
        (generatedPrompt.markdown.en && generatedPrompt.markdown.en.trim().length > 0) ||
        (generatedPrompt.xml.zh && generatedPrompt.xml.zh.trim().length > 0) ||
        (generatedPrompt.xml.en && generatedPrompt.xml.en.trim().length > 0)
      )
    } else if (generatedPrompt && typeof generatedPrompt === 'object') {
      hasContent = Boolean(('zh' in generatedPrompt && generatedPrompt.zh && generatedPrompt.zh.trim().length > 0) || ('en' in generatedPrompt && generatedPrompt.en && generatedPrompt.en.trim().length > 0))
    }
    
    if (hasContent) {
      tabsRef.current.setNewContentTabs(prev => {
        const newSet = new Set(prev)
        newSet.add('zh')
        return newSet
      })
      tabsRef.current.switchToTabWithScroll('zh')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [generatedPrompt])

  // æµå¼è¾“å‡ºæ—¶è‡ªåŠ¨æ»šåŠ¨
  const activeTab = tabs.activeTab
  const scrollSyncRef = useRef(scrollSync)
  scrollSyncRef.current = scrollSync
  
  useEffect(() => {
    if (isGenerating && activeTab === 'report') {
      setTimeout(() => {
        scrollSyncRef.current.scrollContainerToBottom('reportScrollContainer')
      }, 0)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [requirementReport, isGenerating, activeTab])

  useEffect(() => {
    if (isGenerating && activeTab === 'thinking') {
      setTimeout(() => {
        scrollSyncRef.current.scrollContainerToBottom('thinkingScrollContainer')
      }, 0)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [thinkingPoints, isGenerating, activeTab])

  useEffect(() => {
    if (isGenerating && activeTab === 'initial') {
      setTimeout(() => {
        scrollSyncRef.current.scrollContainerToBottom('initialScrollContainer')
      }, 0)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [initialPrompt, isGenerating, activeTab])

  useEffect(() => {
    if (isGenerating && activeTab === 'advice') {
      setTimeout(() => {
        scrollSyncRef.current.scrollContainerToBottom('adviceScrollContainer')
      }, 0)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [advice, isGenerating, activeTab])

  useEffect(() => {
    if (isGenerating && activeTab === 'zh') {
      setTimeout(() => {
        scrollSyncRef.current.scrollContainerToBottom('finalScrollContainer')
      }, 0)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [generatedPrompt, isGenerating, activeTab])

  // ä½¿ç”¨é€‰æ‹©å™¨è·å–éœ€è¦çš„çŠ¶æ€å’Œæ–¹æ³•
  const getState = usePromptStore((state) => state.getState)
  const setState = usePromptStore((state) => state.setState)
  const setIsAutoMode = usePromptStore((state) => state.setIsAutoMode)
  
  const savePrompt = () => {
    const currentState = getState()
    let finalPrompt: string
    const gp = currentState.promptData.generatedPrompt
    if (typeof gp === 'string') {
      finalPrompt = gp
    } else if ('markdown' in gp && 'xml' in gp) {
      finalPrompt = gp.markdown.zh || gp.markdown.en || gp.xml.zh || gp.xml.en
    } else {
      finalPrompt = gp.zh || gp.en
    }

    if (!finalPrompt || !finalPrompt.trim()) {
      notificationStore.warning('æ²¡æœ‰å¯ä¿å­˜çš„æç¤ºè¯å†…å®¹', 2000)
      return
    }

    setCurrentPromptContent(finalPrompt)
    setShowSaveDialog(true)
  }

  const handleSaveConfirm = async (formData: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    promptType: string
  }) => {
    try {
      setIsSaving(true)

      const token = localStorage.getItem('yprompt_token')
      if (!token) {
        throw new Error('è¯·å…ˆç™»å½•')
      }

      const saveData = {
        title: formData.title,
        description: formData.description,
        final_prompt: currentPromptContent,
        language: 'zh',
        format: 'markdown',
        prompt_type: formData.promptType,
        tags: formData.tags,
        is_public: formData.isPublic ? 1 : 0
      }

      const response = await fetch(`${API_BASE_URL}/api/prompts/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(saveData)
      })

      if (!response.ok) {
        const errorText = await response.text()
        throw new Error(`HTTP ${response.status}: ${errorText}`)
      }

      const result = await response.json()

      if (result.code === 200) {
        notificationStore.success('æç¤ºè¯ä¿å­˜æˆåŠŸï¼', 2000)
        setShowSaveDialog(false)
      } else {
        throw new Error(result.message || 'ä¿å­˜å¤±è´¥')
      }

    } catch (err: any) {
      console.error('ä¿å­˜æç¤ºè¯å¤±è´¥:', err)
      notificationStore.error(`ä¿å­˜å¤±è´¥: ${err.message}`, 3000)
    } finally {
      setIsSaving(false)
    }
  }

  // ä½¿ç”¨é€‰æ‹©å™¨è·å–éœ€è¦çš„çŠ¶æ€
  const isAutoMode = usePromptStore((state) => state.isAutoMode)
  const currentExecutionStep = usePromptStore((state) => state.currentExecutionStep)
  const isGeneratingForHeader = usePromptStore((state) => state.isGenerating)
  const hasAnyContent = helpers.hasAnyContent

  return (
    <div className="bg-white rounded-lg shadow-sm flex flex-col h-full">
      <PreviewHeader
        isAutoMode={isAutoMode}
        currentExecutionStep={currentExecutionStep}
        isGenerating={isGeneratingForHeader}
        onUpdateIsAutoMode={setIsAutoMode}
      />

      {isGeneratingForHeader && !hasAnyContent && <LoadingState />}

      {hasAnyContent && (
        <div className="flex-1 flex flex-col overflow-hidden p-4">
            <TabContainer
              isGenerating={isGeneratingForHeader}
              onMounted={(el) => tabs.setTabRefs({ tabContainer: el })}
            >
              <TabButton
                isActive={tabs.activeTab === 'report'}
                activeClass="bg-orange-500 text-white"
                onClick={() => tabs.handleTabChange('report')}
                onMounted={(el) => tabs.setTabRefs({ reportTab: el })}
              >
                éœ€æ±‚æè¿°
              </TabButton>

              {thinkingPoints && (
              <TabButton
                isActive={tabs.activeTab === 'thinking'}
                activeClass="bg-purple-500 text-white"
                onClick={() => tabs.handleTabChange('thinking')}
                onMounted={(el) => tabs.setTabRefs({ thinkingTab: el })}
              >
                å…³é”®æŒ‡ä»¤
              </TabButton>
            )}

              {initialPrompt && (
              <TabButton
                isActive={tabs.activeTab === 'initial'}
                activeClass="bg-green-500 text-white"
                onClick={() => tabs.handleTabChange('initial')}
                onMounted={(el) => tabs.setTabRefs({ initialTab: el })}
              >
                åˆå§‹æç¤ºè¯
              </TabButton>
            )}

              {advice && (
              <TabButton
                isActive={tabs.activeTab === 'advice'}
                activeClass="bg-yellow-500 text-white"
                onClick={() => tabs.handleTabChange('advice')}
                onMounted={(el) => tabs.setTabRefs({ adviceTab: el })}
              >
                ä¼˜åŒ–å»ºè®®
              </TabButton>
            )}

            {conversion.currentGeneratedPrompt && (
              <TabButton
                isActive={tabs.activeTab === 'zh'}
                activeClass="bg-blue-500 text-white"
                onClick={() => tabs.handleTabChange('zh')}
                onMounted={(el) => tabs.setTabRefs({ zhTab: el })}
              >
                æœ€ç»ˆæç¤ºè¯
              </TabButton>
            )}
          </TabContainer>

          {tabs.activeTab === 'report' && (
            <ReportTab
              requirementReport={requirementReport}
              setRequirementReport={(value) => {
                const currentState = getState()
                setState({ promptData: { ...currentState.promptData, requirementReport: value } })
              }}
              hasConversationData={helpers.hasConversationData}
              isAutoMode={isAutoMode}
              isExecuting={execution.isExecuting}
              isGenerating={isGeneratingForHeader}
              currentExecutionStep={currentExecutionStep}
              isCopied={clipboard.copyStatus['report']}
              onRegenerate={execution.regenerateRequirementReport}
              onCopy={() => clipboard.copyToClipboard(requirementReport || '', 'report')}
              onExecuteFull={execution.executeFullWorkflow}
              onExecuteThinking={execution.executeThinkingPoints}
              onScrollMounted={(el) => scrollSync.setScrollContainerRefs({ reportScrollContainer: el })}
            />
          )}

          {tabs.activeTab === 'thinking' && thinkingPoints && (
            <ThinkingTab
              thinkingPoints={thinkingPoints}
              setThinkingPoints={(points) => {
                const currentState = getState()
                setState({ promptData: { ...currentState.promptData, thinkingPoints: points } })
              }}
              isAutoMode={isAutoMode}
              isExecuting={execution.isExecuting}
              isGenerating={isGeneratingForHeader}
              currentExecutionStep={currentExecutionStep}
              isCopied={clipboard.copyStatus['thinking']}
              onRegenerate={execution.regenerateThinkingPoints}
              onCopy={() => clipboard.copyToClipboard(thinkingPoints?.join('\n') || '', 'thinking')}
              onAddPoint={listOps.addThinkingPoint}
              onRemovePoint={listOps.removeThinkingPoint}
              onUpdatePoint={(index, value) => {
                const currentState = getState()
                if (currentState.promptData.thinkingPoints) {
                  const newPoints = [...currentState.promptData.thinkingPoints]
                  newPoints[index] = value
                  setState({ promptData: { ...currentState.promptData, thinkingPoints: newPoints } })
                }
              }}
              onExecuteInitial={execution.executeInitialPrompt}
              onScrollMounted={(el) => scrollSync.setScrollContainerRefs({ thinkingScrollContainer: el })}
            />
          )}

          {tabs.activeTab === 'initial' && initialPrompt && (
            <InitialTab
              initialPrompt={initialPrompt}
              setInitialPrompt={(value) => {
                const currentState = getState()
                setState({ promptData: { ...currentState.promptData, initialPrompt: value } })
              }}
              isAutoMode={isAutoMode}
              isExecuting={execution.isExecuting}
              isGenerating={isGeneratingForHeader}
              currentExecutionStep={currentExecutionStep}
              isCopied={clipboard.copyStatus['initial']}
              onRegenerate={execution.regenerateInitialPrompt}
              onCopy={() => clipboard.copyToClipboard(initialPrompt || '', 'initial')}
              onExecuteAdvice={execution.executeAdvice}
              onScrollMounted={(el) => scrollSync.setScrollContainerRefs({ initialScrollContainer: el })}
            />
          )}

          {tabs.activeTab === 'advice' && advice && (
            <AdviceTab
              advice={advice}
              setAdvice={(newAdvice) => {
                const currentState = getState()
                setState({ promptData: { ...currentState.promptData, advice: newAdvice } })
              }}
              isAutoMode={isAutoMode}
              isExecuting={execution.isExecuting}
              isGenerating={isGeneratingForHeader}
              currentExecutionStep={currentExecutionStep}
              isCopied={clipboard.copyStatus['advice']}
              onRegenerate={execution.regenerateAdvice}
              onCopy={() => clipboard.copyToClipboard(advice?.join('\n') || '', 'advice')}
              onAddItem={listOps.addAdviceItem}
              onRemoveItem={listOps.removeAdviceItem}
              onUpdateItem={(index, value) => {
                const currentState = getState()
                if (currentState.promptData.advice) {
                  const newAdvice = [...currentState.promptData.advice]
                  newAdvice[index] = value
                  setState({ promptData: { ...currentState.promptData, advice: newAdvice } })
                }
              }}
              onExecuteFinal={execution.executeFinalPrompt}
              onScrollMounted={(el) => scrollSync.setScrollContainerRefs({ adviceScrollContainer: el })}
            />
          )}

          {tabs.activeTab === 'zh' && conversion.currentGeneratedPrompt && (
            <FinalTab
              generatedPrompt={conversion.currentGeneratedPrompt}
              setGeneratedPrompt={conversion.setCurrentGeneratedPrompt}
              isExecuting={execution.isExecuting}
              isGenerating={isGeneratingForHeader}
              currentExecutionStep={currentExecutionStep}
              isCopied={clipboard.copyStatus['final']}
              isConvertingFormat={conversion.isConvertingFormat}
              isConvertingLanguage={conversion.isConvertingLanguage}
              isSaving={isSaving}
              formatState={conversion.formatState}
              languageState={conversion.languageState}
              onRegenerate={execution.regenerateFinalPrompt}
              onCopy={() => clipboard.copyToClipboard(conversion.currentGeneratedPrompt, 'final')}
              onToggleFormat={conversion.toggleFormat}
              onToggleLanguage={conversion.toggleLanguage}
              onSavePrompt={savePrompt}
              onScrollMounted={(el) => scrollSync.setScrollContainerRefs({ finalScrollContainer: el })}
            />
          )}
        </div>
      )}

      {!hasAnyContent && !isGeneratingForHeader && <EmptyState />}
      
      {/* ä¿å­˜æç¤ºè¯å¯¹è¯æ¡† */}
      <SavePromptDialog
        isOpen={showSaveDialog}
        promptContent={currentPromptContent}
        isSaving={isSaving}
        onSave={handleSaveConfirm}
        onCancel={() => setShowSaveDialog(false)}
      />
    </div>
  )
}

```


## src/components/chat/components/ChatHeader.tsx

```tsx
import { RefreshCw, Square } from 'lucide-react'

interface ChatHeaderProps {
  isStreamMode: boolean
  isGenerating: boolean
  isTyping: boolean
  onToggleStream: () => void
  onClearChat: () => void
  onInterrupt: () => void
}

export default function ChatHeader({
  isStreamMode,
  isGenerating,
  isTyping,
  onToggleStream,
  onClearChat,
  onInterrupt
}: ChatHeaderProps) {
  const shouldShowInterrupt = isGenerating || isTyping

  return (
    <div className="p-4 border-b border-gray-200 flex-shrink-0">
      <div className="flex justify-between items-center">
        <div className="flex items-center space-x-2">
          <h4 className="font-semibold text-gray-800">AIåŠ©æ‰‹å¯¹è¯</h4>
        </div>
        <div className="flex items-center space-x-3">
          <div className="flex items-center space-x-2">
            <span className="text-sm text-gray-600">æµå¼:</span>
            <button
              onClick={onToggleStream}
              className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none ${
                isStreamMode ? 'bg-blue-500' : 'bg-gray-300'
              }`}
              title={isStreamMode ? 'å…³é—­æµå¼æ¨¡å¼' : 'å¼€å¯æµå¼æ¨¡å¼'}
            >
              <span
                className={`inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${
                  isStreamMode ? 'translate-x-5' : 'translate-x-1'
                }`}
              />
            </button>
          </div>

          {shouldShowInterrupt && (
            <button
              onClick={onInterrupt}
              className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-orange-600 hover:bg-orange-100 rounded transition-colors"
              title="ä¸­æ–­ç”Ÿæˆ"
            >
              <Square className="w-4 h-4" />
              <span>ä¸­æ–­</span>
            </button>
          )}

          <button
            onClick={onClearChat}
            className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
            title="é‡æ–°å¼€å§‹"
          >
            <RefreshCw className="w-4 h-4" />
            <span>é‡æ–°å¼€å§‹</span>
          </button>
        </div>
      </div>
    </div>
  )
}

```


## src/components/chat/components/ChatInputArea.tsx

```tsx
import { X, ArrowUp, Paperclip } from 'lucide-react'
import { useRef, useEffect } from 'react'
import type { MessageAttachment } from '@/stores/promptStore'

interface ChatInputAreaProps {
  isEditing: boolean
  userInput: string
  setUserInput: (value: string) => void
  attachments: MessageAttachment[]
  placeholder: string
  isDisabled: boolean
  textareaRef: React.RefObject<HTMLTextAreaElement>
  showQuickReplies: boolean
  quickReplies: string[]
  quickRepliesContainerRef?: React.RefObject<HTMLDivElement>
  onKeydown: (event: React.KeyboardEvent) => void
  onCompositionStart: () => void
  onCompositionEnd: () => void
  onFocus: () => void
  onSend: () => void
  onFileSelect: (event: React.ChangeEvent<HTMLInputElement>) => void
  onRemoveAttachment: (id: string) => void
  onClearAttachments: () => void
  onQuickReplySelect: (reply: string) => void
  fileInputRef: React.RefObject<HTMLInputElement>
}

export default function ChatInputArea({
  isEditing,
  userInput,
  setUserInput,
  attachments,
  placeholder,
  isDisabled,
  textareaRef,
  showQuickReplies,
  quickReplies,
  quickRepliesContainerRef,
  onKeydown,
  onCompositionStart,
  onCompositionEnd,
  onFocus,
  onSend,
  onFileSelect,
  onRemoveAttachment,
  onClearAttachments,
  onQuickReplySelect,
  fileInputRef
}: ChatInputAreaProps) {
  const quickRepliesRef = useRef<HTMLDivElement>(null)

  // åŒæ­¥ quickRepliesRef åˆ°çˆ¶ç»„ä»¶
  useEffect(() => {
    if (quickRepliesContainerRef && quickRepliesRef.current) {
      // åœ¨Reactä¸­ï¼Œrefé€šè¿‡propsä¼ é€’ï¼Œè¿™é‡Œåªéœ€è¦ç¡®ä¿refæ­£ç¡®è®¾ç½®
      // å¦‚æœéœ€è¦ï¼Œå¯ä»¥é€šè¿‡callback refçš„æ–¹å¼åŒæ­¥
    }
  }, [quickRepliesContainerRef])

  const triggerFileSelect = () => {
    fileInputRef.current?.click()
  }

  const handleMouseDown = (event: React.MouseEvent<HTMLTextAreaElement>) => {
    const target = event.currentTarget
    if (document.activeElement !== target) {
      // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop
      const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft
      
      // è®©é»˜è®¤è¡Œä¸ºæ‰§è¡Œï¼Œä½†ç«‹å³æ¢å¤æ»šåŠ¨ä½ç½®
      setTimeout(() => {
        window.scrollTo(scrollLeft, scrollTop)
      }, 0)
    }
  }

  return (
    <div className="p-3 border-t border-gray-200 bg-white flex-shrink-0 relative z-20">
      {/* å¿«é€Ÿå›å¤é€‰é¡¹ - ç»å¯¹å®šä½åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */}
      {showQuickReplies && quickReplies && quickReplies.length > 0 && (
        <div ref={quickRepliesRef} className="absolute bottom-full left-0 right-0 px-6 py-3 bg-gray-50 border-b border-gray-200 shadow-lg">
          <div className="text-xs text-gray-500 mb-2">å¿«é€Ÿå›å¤ï¼š</div>
          <div className="flex flex-wrap gap-2">
            {quickReplies.map((reply) => (
              <button
                key={reply}
                onClick={() => onQuickReplySelect(reply)}
                className="px-3 py-1 text-sm bg-white border border-gray-300 rounded-full hover:bg-gray-50 transition-colors"
              >
                {reply}
              </button>
            ))}
          </div>
        </div>
      )}

      <input
        ref={fileInputRef}
        type="file"
        multiple
        accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.csv,.json,.xml,.html,.css,.js,.ts,.py,.java,.c,.cpp,.yaml,.yml"
        onChange={onFileSelect}
        className="hidden"
      />
      
      {attachments.length > 0 && (
        <div className="mb-3 p-3 bg-gray-50 rounded-lg">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm text-gray-600">å·²é€‰æ‹© {attachments.length} ä¸ªé™„ä»¶</span>
            <button
              onClick={onClearAttachments}
              className="text-xs text-red-500 hover:text-red-700"
            >
              æ¸…ç©ºå…¨éƒ¨
            </button>
          </div>
          <div className="flex gap-2 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 pb-1">
            {attachments.map((attachment) => (
              <div
                key={attachment.id}
                className="flex-shrink-0 flex items-center gap-2 bg-white px-3 py-2 rounded-md border border-gray-200 min-w-0"
              >
                <div className="flex items-center gap-2 min-w-0">
                  <div className="flex-shrink-0">
                    {attachment.type === 'image' && (
                      <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    )}
                    {attachment.type === 'document' && (
                      <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    )}
                    {attachment.type === 'audio' && (
                      <svg className="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                      </svg>
                    )}
                    {attachment.type === 'video' && (
                      <svg className="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    )}
                    {!['image', 'document', 'audio', 'video'].includes(attachment.type) && (
                      <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                      </svg>
                    )}
                  </div>
                  <div className="min-w-0 flex-1">
                    <div className="text-xs font-medium text-gray-700 truncate max-w-24" title={attachment.name}>
                      {attachment.name}
                    </div>
                    <div className="text-xs text-gray-500">
                      {(attachment.size / 1024).toFixed(1)}KB
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => onRemoveAttachment(attachment.id)}
                  className="flex-shrink-0 w-4 h-4 text-gray-400 hover:text-red-500 transition-colors"
                  title="ç§»é™¤é™„ä»¶"
                >
                  <X className="w-3 h-3" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {!isEditing && (
        <div className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden" style={{ height: '120px' }}>
          <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
            <textarea
              ref={textareaRef}
              value={userInput}
              onChange={(e) => setUserInput(e.target.value)}
              onKeyDown={onKeydown}
              onCompositionStart={onCompositionStart}
              onCompositionEnd={onCompositionEnd}
              onFocus={onFocus}
              onMouseDown={handleMouseDown}
              placeholder={placeholder}
              disabled={isDisabled}
              className="w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent"
              rows={1}
            />
          </div>
          <div className="absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none">
            <button
              onClick={triggerFileSelect}
              className="w-8 h-8 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors flex items-center justify-center pointer-events-auto relative"
              title="æ”¯æŒæ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘ç­‰æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§25MB"
            >
              <Paperclip className="w-4 h-4" />
              {attachments.length > 0 && (
                <span className="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-3 h-3 flex items-center justify-center" style={{ fontSize: '9px' }}>
                  {attachments.length}
                </span>
              )}
            </button>
            <button
              onClick={onSend}
              disabled={!userInput.trim() || isDisabled}
              className="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"
            >
              <ArrowUp className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}
    </div>
  )
}

```


## src/components/chat/components/ChatMessage.tsx

```tsx
import { memo, useRef, useEffect } from 'react'
import { RefreshCw, Edit2, Trash2, Copy, X, Send } from 'lucide-react'
import type { ChatMessage as ChatMessageType } from '@/stores/promptStore'

interface ChatMessageProps {
  message: ChatMessageType
  messageIndex: number
  renderMarkdown: (content: string) => string
  renderUserMessage: (content: string) => string
  editingContent?: string
  isDisabled?: boolean
  onStartEdit?: (messageId: string) => void
  onSaveEdit?: (messageId: string) => void
  onCancelEdit?: (messageId: string) => void
  onDelete?: (messageId: string) => void
  onCopy?: (content: string) => void
  onRegenerate?: (messageId: string) => void
  onResend?: (messageId: string) => void
  onResendUser?: (messageId: string) => void
  onEditKeydown?: (event: React.KeyboardEvent, messageId: string) => void
  onSetEditRef?: (messageId: string, el: HTMLTextAreaElement | null) => void
  onSetMessageRef?: (messageId: string, el: HTMLElement | null) => void
  onUpdateEditingContent?: (messageId: string, content: string) => void
}

const ChatMessage = memo(function ChatMessage({
  message,
  messageIndex: _messageIndex,
  renderMarkdown,
  renderUserMessage,
  editingContent = '',
  isDisabled = false,
  onStartEdit,
  onSaveEdit,
  onCancelEdit,
  onDelete,
  onCopy,
  onRegenerate,
  onResend,
  onResendUser,
  onEditKeydown,
  onSetEditRef,
  onSetMessageRef,
  onUpdateEditingContent
}: ChatMessageProps) {
  const messageRef = useRef<HTMLDivElement>(null)
  const editTextareaRef = useRef<HTMLTextAreaElement>(null)
  const isUser = message.type === 'user'
  const isEditing = message.isEditing || false

  useEffect(() => {
    if (onSetMessageRef && messageRef.current) {
      onSetMessageRef(message.id!, messageRef.current)
    }
  }, [message.id, onSetMessageRef])

  useEffect(() => {
    if (isEditing && editTextareaRef.current && onSetEditRef) {
      onSetEditRef(message.id!, editTextareaRef.current)
      editTextareaRef.current.focus()
      const length = editTextareaRef.current.value.length
      editTextareaRef.current.setSelectionRange(length, length)
    }
  }, [isEditing, message.id, onSetEditRef])

  const content = isUser ? renderUserMessage(message.content) : renderMarkdown(message.content)

  return (
    <div
      ref={messageRef}
      className={`flex group ${isUser ? 'justify-end' : 'justify-start'}`}
    >
      <div className={`flex flex-col w-full ${isEditing ? 'max-w-full sm:max-w-2xl' : 'max-w-xs lg:max-w-md'}`}>
        <div
          className={`${
            isEditing
              ? 'bg-transparent border-0 shadow-none p-0'
              : isUser
                ? 'bg-blue-500 text-white px-4 py-3 rounded-lg'
                : message.isProgress
                  ? 'bg-blue-50 text-blue-800 border border-blue-200 px-4 py-3 rounded-lg animate-pulse'
                  : 'bg-gray-100 text-gray-800 px-4 py-3 rounded-lg'
          } ${
            !isEditing && (isUser ? 'ml-auto' : 'mr-auto')
          } transition-all duration-300 relative`}
        >
          {isEditing ? (
            <div className="relative">
              <div className="relative border border-blue-300 rounded-2xl overflow-hidden bg-white">
                <div className="relative">
                  <textarea
                    ref={editTextareaRef}
                    value={editingContent}
                    onChange={(e) => onUpdateEditingContent?.(message.id!, e.target.value)}
                    onKeyDown={(e) => onEditKeydown?.(e, message.id!)}
                    className="w-full p-4 border-0 resize-none focus:outline-none text-gray-800 bg-white min-h-[80px] max-h-[200px] overflow-y-auto text-base"
                    placeholder="ç¼–è¾‘æ¶ˆæ¯å†…å®¹..."
                  />
                </div>
              </div>
            </div>
          ) : (
            <div>
              {message.type === 'ai' ? (
                <div
                  className="prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"
                  dangerouslySetInnerHTML={{ __html: content }}
                />
              ) : (
                <div
                  className="text-sm text-white [&_h1]:text-base [&_h1]:font-bold [&_h1]:text-white [&_h1]:mb-2 [&_h2]:text-sm [&_h2]:font-bold [&_h2]:text-white [&_h2]:mb-2 [&_h3]:text-sm [&_h3]:font-bold [&_h3]:text-white [&_h3]:mb-1 [&_h4]:text-sm [&_h4]:font-bold [&_h4]:text-white [&_h5]:text-sm [&_h5]:font-bold [&_h5]:text-white [&_h6]:text-sm [&_h6]:font-bold [&_h6]:text-white [&_p]:text-sm [&_p]:text-white [&_p]:mb-2 [&_strong]:font-bold [&_strong]:text-white [&_b]:font-bold [&_b]:text-white [&_em]:italic [&_em]:text-white [&_i]:italic [&_i]:text-white [&_ul]:list-disc [&_ul]:list-inside [&_ul]:text-white [&_ul]:text-sm [&_ul]:mb-2 [&_ol]:list-decimal [&_ol]:list-inside [&_ol]:text-white [&_ol]:text-sm [&_ol]:mb-2 [&_li]:text-sm [&_li]:text-white [&_li]:mb-1 [&_code]:bg-blue-600 [&_code]:text-blue-100 [&_code]:text-xs [&_code]:px-1 [&_code]:rounded [&_code]:font-mono [&_pre]:bg-blue-600 [&_pre]:text-blue-100 [&_pre]:text-xs [&_pre]:p-2 [&_pre]:rounded [&_pre]:overflow-x-auto [&_a]:text-blue-200 [&_a]:underline [&_a]:text-sm [&_blockquote]:border-l-2 [&_blockquote]:border-blue-300 [&_blockquote]:pl-2 [&_blockquote]:text-blue-100 [&_blockquote]:text-sm"
                  dangerouslySetInnerHTML={{ __html: content }}
                />
              )}
            </div>
          )}
        </div>

        {/* é™„ä»¶æ˜¾ç¤º */}
        {message.attachments && message.attachments.length > 0 && !isEditing && (
          <div className={`mt-2 ${isUser ? 'ml-auto max-w-xs lg:max-w-md' : 'mr-auto max-w-xs lg:max-w-md'}`}>
            <div className="text-xs text-gray-500 mb-1">é™„ä»¶ ({message.attachments.length})</div>
            <div className="flex gap-2 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 pb-1">
              {message.attachments.map((attachment) => (
                <div
                  key={attachment.id}
                  className={`flex-shrink-0 flex items-center gap-2 px-2 py-1.5 rounded-md text-xs border min-w-0 ${
                    isUser ? 'border-blue-200 bg-blue-50' : 'border-gray-200 bg-gray-100'
                  }`}
                >
                  <div className="flex items-center gap-2 min-w-0">
                    <div className="flex-shrink-0">
                      {attachment.type === 'image' && (
                        <svg className="w-3 h-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      )}
                      {attachment.type === 'document' && (
                        <svg className="w-3 h-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                      )}
                      {attachment.type === 'audio' && (
                        <svg className="w-3 h-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                      )}
                      {attachment.type === 'video' && (
                        <svg className="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                      )}
                    </div>
                    <div className="min-w-0 flex-1">
                      <div
                        className={`truncate max-w-20 font-medium text-xs ${
                          isUser ? 'text-blue-700' : 'text-gray-700'
                        }`}
                        title={attachment.name}
                      >
                        {attachment.name}
                      </div>
                      <div className={`text-xs ${isUser ? 'text-blue-500' : 'text-gray-500'}`}>
                        {(attachment.size / 1024).toFixed(1)}KB
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* æ“ä½œæŒ‰é’® */}
        {!message.isProgress && (
          <div
            className={`flex space-x-1 mt-2 transition-opacity duration-200 ${
              isEditing
                ? 'opacity-100 justify-end'
                : `opacity-0 group-hover:opacity-100 ${isUser ? 'justify-end' : 'justify-start'}`
            }`}
          >
            {isEditing ? (
              <>
                <button
                  onClick={() => isUser ? onResend?.(message.id!) : onSaveEdit?.(message.id!)}
                  className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                  title={isUser ? 'ä¿å­˜å¹¶é‡æ–°å‘é€' : 'ä¿å­˜ç¼–è¾‘'}
                  disabled={isDisabled}
                >
                  <Send className="w-3.5 h-3.5" />
                </button>
                <button
                  onClick={() => onCancelEdit?.(message.id!)}
                  className="p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100"
                  title="å–æ¶ˆç¼–è¾‘"
                >
                  <X className="w-3.5 h-3.5" />
                </button>
              </>
            ) : (
              <>
                {message.type === 'ai' && (
                  <button
                    onClick={() => onRegenerate?.(message.id!)}
                    className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                    title="é‡æ–°ç”Ÿæˆå›å¤"
                    disabled={isDisabled}
                  >
                    <RefreshCw className="w-3.5 h-3.5" />
                  </button>
                )}
                {message.type === 'user' && (
                  <button
                    onClick={() => onResendUser?.(message.id!)}
                    className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                    title="é‡æ–°å‘é€æ¶ˆæ¯"
                    disabled={isDisabled}
                  >
                    <Send className="w-3.5 h-3.5" />
                  </button>
                )}
                <button
                  onClick={() => onStartEdit?.(message.id!)}
                  className="p-1.5 text-gray-500 hover:text-green-600 transition-colors rounded-lg hover:bg-gray-100"
                  title="ç¼–è¾‘æ¶ˆæ¯"
                >
                  <Edit2 className="w-3.5 h-3.5" />
                </button>
                <button
                  onClick={() => onDelete?.(message.id!)}
                  className="p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100"
                  title="åˆ é™¤æ¶ˆæ¯"
                >
                  <Trash2 className="w-3.5 h-3.5" />
                </button>
                <button
                  onClick={() => onCopy?.(message.content)}
                  className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                  title="å¤åˆ¶æ¶ˆæ¯å†…å®¹"
                >
                  <Copy className="w-3.5 h-3.5" />
                </button>
              </>
            )}
          </div>
        )}
      </div>
    </div>
  )
})

export default ChatMessage

```


## src/components/chat/components/ChatMessageList.tsx

```tsx
import { useEffect, useMemo } from 'react'
import type { ChatMessage as ChatMessageType } from '@/stores/promptStore'
import ChatMessage from './ChatMessage'

interface ChatMessageListProps {
  chatContainerRef: React.RefObject<HTMLDivElement>
  messages: ChatMessageType[]
  renderMarkdown: (content: string) => string
  renderUserMessage: (content: string) => string
  chatContainerMaxHeight?: string
  editingContent?: Record<string, string>
  isTyping?: boolean
  isGenerating?: boolean
  onStartEdit?: (messageId: string) => void
  onSaveEdit?: (messageId: string) => void
  onCancelEdit?: (messageId: string) => void
  onDelete?: (messageId: string) => void
  onCopy?: (content: string) => void
  onRegenerate?: (messageId: string, messageIndex: number) => void
  onResend?: (messageId: string, messageIndex: number) => void
  onResendUser?: (messageId: string, messageIndex: number) => void
  onEditKeydown?: (event: React.KeyboardEvent, messageId: string) => void
  onSetEditRef?: (messageId: string, el: HTMLTextAreaElement | null) => void
  onSetMessageRef?: (messageId: string, el: HTMLElement | null) => void
  onUpdateEditingContent?: (messageId: string, content: string) => void
}

export default function ChatMessageList({
  chatContainerRef,
  messages,
  renderMarkdown,
  renderUserMessage,
  chatContainerMaxHeight,
  editingContent = {},
  isTyping = false,
  isGenerating = false,
  onStartEdit,
  onSaveEdit,
  onCancelEdit,
  onDelete,
  onCopy,
  onRegenerate,
  onResend,
  onResendUser,
  onEditKeydown,
  onSetEditRef,
  onSetMessageRef,
  onUpdateEditingContent
}: ChatMessageListProps) {
  // ä½¿ç”¨ useMemo ç¼“å­˜è¿‡æ»¤åçš„æ¶ˆæ¯åˆ—è¡¨ï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°è¿‡æ»¤
  const validMessages = useMemo(() => {
    return messages.filter(msg => !msg.isDeleted)
  }, [messages])

  useEffect(() => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [validMessages.length, isTyping]) // ä¾èµ–æ¶ˆæ¯æ•°é‡å’Œè¾“å…¥çŠ¶æ€

  return (
    <div
      ref={chatContainerRef}
      className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0"
      style={chatContainerMaxHeight ? { maxHeight: chatContainerMaxHeight } : undefined}
    >
      {validMessages.length === 0 ? (
        <div className="text-center text-gray-500 py-8">
          <p>å¼€å§‹å¯¹è¯ï¼ŒAI å°†å¼•å¯¼æ‚¨åˆ›å»ºä¸“ä¸šçš„æç¤ºè¯</p>
        </div>
      ) : (
        validMessages.map((message, index) => (
          <ChatMessage
            key={message.id}
            message={message}
            messageIndex={index}
            renderMarkdown={renderMarkdown}
            renderUserMessage={renderUserMessage}
            editingContent={editingContent[message.id!] || ''}
            isDisabled={isTyping || isGenerating}
            onStartEdit={onStartEdit}
            onSaveEdit={onSaveEdit}
            onCancelEdit={onCancelEdit}
            onDelete={onDelete}
            onCopy={onCopy}
            onRegenerate={(messageId) => onRegenerate?.(messageId, index)}
            onResend={(messageId) => onResend?.(messageId, index)}
            onResendUser={(messageId) => onResendUser?.(messageId, index)}
            onEditKeydown={onEditKeydown}
            onSetEditRef={onSetEditRef}
            onSetMessageRef={onSetMessageRef}
            onUpdateEditingContent={onUpdateEditingContent}
          />
        ))
      )}
      
      {/* è¾“å…¥ä¸­æŒ‡ç¤ºå™¨ */}
      {isTyping && (
        <div className="flex justify-start">
          <div className="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg">
            <div className="flex space-x-1">
              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

```


## src/components/chat/components/ChatModelSelector.tsx

```tsx
import { ProviderConfig, ModelConfig } from '@/stores/providerStore'

interface Props {
  show: boolean
  chatProvider: string
  chatModel: string
  availableProviders: ProviderConfig[]
  availableModels: ModelConfig[]
  modelDisplay: string
  onUpdateChatProvider: (value: string) => void
  onUpdateChatModel: (value: string) => void
  onReset: () => void
}

export default function ChatModelSelector({
  show,
  chatProvider,
  chatModel,
  availableProviders,
  availableModels,
  modelDisplay,
  onUpdateChatProvider,
  onUpdateChatModel,
  onReset
}: Props) {
  if (!show) return null

  return (
    <div className="px-4 pb-2 border-b border-gray-200 bg-gray-50">
      <div className="py-2 space-y-2">
        <div className="flex items-center justify-between">
          <label className="text-sm font-medium text-gray-700">AIåŠ©æ‰‹ä¸“ç”¨æ¨¡å‹</label>
          {chatProvider && (
            <button
              onClick={onReset}
              className="px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
              title="é‡ç½®ä¸ºå…¨å±€æ¨¡å‹"
            >
              é‡ç½®
            </button>
          )}
        </div>

        <div className="flex flex-col sm:flex-row gap-2">
          <div className="flex-1">
            <select
              value={chatProvider}
              onChange={(e) => onUpdateChatProvider(e.target.value)}
              className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">ä½¿ç”¨å…¨å±€æ¨¡å‹</option>
              {availableProviders.map((provider) => (
                <option key={provider.id} value={provider.id}>
                  {provider.name}
                </option>
              ))}
            </select>
          </div>

          <div className="flex-1">
            <select
              value={chatModel}
              onChange={(e) => onUpdateChatModel(e.target.value)}
              disabled={!chatProvider}
              className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"
            >
              <option value="">é€‰æ‹©æ¨¡å‹</option>
              {availableModels.map((model) => (
                <option key={model.id} value={model.id}>
                  {model.name}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="text-xs text-gray-500">
          {!chatProvider ? (
            <span>å½“å‰: è·Ÿéšå…¨å±€æ¨¡å‹è®¾ç½®</span>
          ) : !chatModel ? (
            <span>è¯·é€‰æ‹©æ¨¡å‹</span>
          ) : (
            <span>å½“å‰: {modelDisplay}</span>
          )}
        </div>
      </div>
    </div>
  )
}
```


## src/components/chat/components/ChatQuickReplies.tsx

```tsx
interface ChatQuickRepliesProps {
  show: boolean
  replies: string[]
  quickRepliesContainerRef: React.RefObject<HTMLDivElement>
  inputContainerRef: React.RefObject<HTMLElement>
  onSelect: (reply: string) => void
}

export default function ChatQuickReplies({
  show,
  replies,
  quickRepliesContainerRef,
  onSelect
}: ChatQuickRepliesProps) {
  if (!show) {
    return null
  }

  return (
    <div
      ref={quickRepliesContainerRef}
      className="absolute bottom-full left-0 right-0 px-6 py-3 bg-gray-50 border-b border-gray-200 shadow-lg z-10"
    >
      <div className="text-xs text-gray-500 mb-2">å¿«é€Ÿå›å¤ï¼š</div>
      <div className="flex flex-wrap gap-2">
        {replies.map((reply) => (
          <button
            key={reply}
            onClick={() => onSelect(reply)}
            className="px-3 py-1 text-sm bg-white border border-gray-300 rounded-full hover:bg-gray-50 transition-colors"
          >
            {reply}
          </button>
        ))}
      </div>
    </div>
  )
}

```


## src/components/layout/DesktopLayout.tsx

```tsx
import { ReactNode } from 'react'
import TopNavigation from './TopNavigation'
import GitCommit from '../GitCommit'

interface DesktopLayoutProps {
  children: ReactNode
}

export default function DesktopLayout({ children }: DesktopLayoutProps) {
  return (
    <div className="desktop-layout atmospheric-bg relative min-h-screen w-screen bg-[var(--ct-slate-50)] overflow-hidden flex flex-col">
      {/* Atmospheric Background Elements - ä½¿ç”¨ will-change å’Œ GPU åŠ é€Ÿä¼˜åŒ–æ€§èƒ½ */}
      <div className="background-orb orb-1 absolute rounded-full blur-3xl z-0 pointer-events-none opacity-60 w-[500px] h-[500px] -top-[200px] -left-[200px] bg-gradient-radial from-[rgba(79,70,229,0.15)] to-transparent animate-[float_20s_infinite_ease-in-out] will-change-transform" style={{ transform: 'translateZ(0)' }} />
      <div className="background-orb orb-2 absolute rounded-full blur-3xl z-0 pointer-events-none opacity-60 w-[400px] h-[400px] -bottom-[150px] -right-[150px] bg-gradient-radial from-[rgba(124,58,237,0.12)] to-transparent animate-[float_25s_infinite_ease-in-out_reverse] will-change-transform" style={{ transform: 'translateZ(0)' }} />
      <div className="background-orb orb-3 absolute rounded-full blur-3xl z-0 pointer-events-none opacity-60 w-[350px] h-[350px] top-[40%] left-[60%] bg-gradient-radial from-[rgba(139,92,246,0.08)] to-transparent animate-[float_30s_infinite_ease-in-out] will-change-transform" style={{ transform: 'translateZ(0)' }} />

      {/* Main Structure */}
      <div className="main-structure relative z-10 flex flex-col min-h-screen w-full">
        {/* Top Navigation Bar */}
        <TopNavigation />

        {/* Main Content Area */}
        <div className="content-area flex-1 flex flex-col min-w-0 min-h-0">
          {children}
        </div>

        {/* Footer Git Commit Section */}
        <div className="footer-container mt-auto flex justify-center items-center">
          <GitCommit />
        </div>
      </div>
    </div>
  )
}

```


## src/components/layout/TopModelSelector.tsx

```tsx
import { useEffect, useMemo } from 'react'
import { useProviderStore } from '@/stores/providerStore'

export default function TopModelSelector() {
  // ä½¿ç”¨é€‰æ‹©å™¨ç¡®ä¿å“åº”å¼æ›´æ–°
  const isInitialized = useProviderStore((state) => state.isInitialized)
  const initialize = useProviderStore((state) => state.initialize)
  const selectedProviderId = useProviderStore((state) => state.selectedProviderId)
  const selectedModelId = useProviderStore((state) => state.selectedModelId)
  const providers = useProviderStore((state) => state.providers)
  const setSelectedProvider = useProviderStore((state) => state.setSelectedProvider)
  const setSelectedModel = useProviderStore((state) => state.setSelectedModel)
  const getProviderById = useProviderStore((state) => state.getProviderById)
  const getAvailableModelsByProvider = useProviderStore((state) => state.getAvailableModelsByProvider)
  
  // åªåœ¨æœªåˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡
  useEffect(() => {
    if (!isInitialized) {
      initialize()
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isInitialized]) // ä¾èµ– isInitialized
  
  // è¾…åŠ©æ–¹æ³•ï¼šç”Ÿæˆ provider key (name + id)
  const getProviderKey = (provider: any) => {
    return `${provider.name}|${provider.id}`
  }
  
  // è¾…åŠ©æ–¹æ³•ï¼šè§£æ provider key
  const parseProviderKey = (key: string) => {
    const [name, id] = key.split('|')
    return { name, id }
  }
  
  // è¾…åŠ©æ–¹æ³•ï¼šè·å– provider æ˜¾ç¤ºæ–‡æœ¬
  const getProviderDisplay = (provider: any) => {
    return provider.name
  }
  
  // è¾…åŠ©æ–¹æ³•ï¼šè·å– model æ˜¾ç¤ºæ–‡æœ¬
  const getModelDisplay = (model: any) => {
    return model.name
  }
  
  // è¾…åŠ©æ–¹æ³•ï¼šç”Ÿæˆ model key (name + id)
  const getModelKey = (model: any) => {
    return `${model.name}|${model.id}`
  }
  
  // å¯ç”¨çš„æä¾›å•†ï¼ˆæœ‰API Keyçš„ï¼‰
  const availableProviders = useMemo(() => {
    return providers.filter(p => p.apiKey)
  }, [providers])
  
  // å½“å‰é€‰ä¸­çš„æä¾›å•†
  // é‡è¦ï¼šå¿…é¡»ä¾èµ– providersï¼Œç¡®ä¿ providers åŠ è½½åé‡æ–°è®¡ç®—
  const currentProvider = useMemo(() => {
    return selectedProviderId ? getProviderById(selectedProviderId) : null
  }, [selectedProviderId, getProviderById, providers])

  // å½“å‰é€‰ä¸­çš„æ¨¡å‹
  // é‡è¦ï¼šå¿…é¡»ä¾èµ– providersï¼Œç¡®ä¿ providers åŠ è½½åé‡æ–°è®¡ç®—
  const currentModel = useMemo(() => {
    if (!currentProvider || !selectedModelId) return null
    return currentProvider.models.find(m => m.id === selectedModelId) || null
  }, [currentProvider, selectedModelId, providers])

  // å¯ç”¨çš„æ¨¡å‹ï¼ˆåŸºäºé€‰ä¸­çš„æä¾›å•†ï¼‰
  // é‡è¦ï¼šå¿…é¡»ä¾èµ– providersï¼Œç¡®ä¿ providers åŠ è½½åé‡æ–°è®¡ç®—
  const availableModels = useMemo(() => {
    if (!selectedProviderId) return []
    return getAvailableModelsByProvider(selectedProviderId)
  }, [selectedProviderId, getAvailableModelsByProvider, providers])
  
  // å½“å‰é€‰ä¸­çš„ provider key
  const selectedProviderKey = useMemo(() => {
    if (!selectedProviderId || !currentProvider) return ''
    return getProviderKey(currentProvider)
  }, [selectedProviderId, currentProvider])
  
  // å½“å‰é€‰ä¸­çš„ model key
  const selectedModelKey = useMemo(() => {
    if (!selectedModelId || !currentModel) return ''
    return getModelKey(currentModel)
  }, [selectedModelId, currentModel])
  
  // æ³¨æ„ï¼šè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†å’Œæ¨¡å‹çš„é€»è¾‘å·²ç»åœ¨ providerStore.refreshProviders() ä¸­å®ç°
  // è¿™é‡Œä¸éœ€è¦é‡å¤å®ç°ï¼ŒproviderStore ä¼šåœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨å¤„ç†

  // ç›‘å¬æä¾›å•†å˜åŒ–ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
  // é‡è¦ï¼šåªåœ¨åˆå§‹åŒ–å®Œæˆåæ‰æ‰§è¡Œï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°æ—¶é”™è¯¯æ¸…ç©ºé€‰æ‹©
  useEffect(() => {
    // åªåœ¨å·²åˆå§‹åŒ–ä¸”æœ‰æä¾›å•†æ—¶æ‰§è¡Œ
    if (!isInitialized || !selectedProviderId) return

    if (availableModels.length > 0) {
      // å¦‚æœå½“å‰é€‰ä¸­çš„æ¨¡å‹ä¸åœ¨æ–°æä¾›å•†çš„æ¨¡å‹åˆ—è¡¨ä¸­ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
      const currentModelExists = availableModels.some(m => m.id === selectedModelId)
      if (!currentModelExists) {
        console.log('[TopModelSelector] å½“å‰æ¨¡å‹ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹:', availableModels[0].name)
        setSelectedModel(availableModels[0].id)
      }
    } else if (availableModels.length === 0) {
      // å¦‚æœæä¾›å•†æ²¡æœ‰æ¨¡å‹ï¼Œæ¸…ç©ºæ¨¡å‹é€‰æ‹©
      console.log('[TopModelSelector] æä¾›å•†æ²¡æœ‰æ¨¡å‹ï¼Œæ¸…ç©ºé€‰æ‹©')
      setSelectedModel('')
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isInitialized, selectedProviderId, availableModels.length]) // ä¾èµ–åˆå§‹åŒ–çŠ¶æ€ã€æä¾›å•†IDå’Œæ¨¡å‹æ•°é‡
  
  const onProviderChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const key = e.target.value
    if (!key) {
      setSelectedProvider('')
      setSelectedModel('')
      return
    }
    const { id } = parseProviderKey(key)
    setSelectedProvider(id)
    
    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹ï¼ˆuseEffectä¼šå¤„ç†ï¼‰
  }
  
  const onModelChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const key = e.target.value
    if (!key) {
      setSelectedModel('')
      return
    }
    const { id } = parseProviderKey(key)
    setSelectedModel(id)
  }
  
  return (
    <div className="flex items-center gap-3">
      {/* AIå›¾æ ‡ */}
      <div className="flex-shrink-0">
        <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>

      {/* æä¾›å•†é€‰æ‹© */}
      <div className="relative">
        <select
          value={selectedProviderKey}
          onChange={onProviderChange}
          className="px-2 py-1 text-sm font-medium text-slate-600 bg-transparent border-b-2 border-slate-300 focus:border-indigo-500 focus:outline-none cursor-pointer appearance-none pr-6 hover:text-slate-900 transition-colors"
        >
          <option value="" disabled>æä¾›å•†</option>
          {availableProviders.map((provider) => (
            <option key={provider.id} value={getProviderKey(provider)}>
              {getProviderDisplay(provider)}
            </option>
          ))}
        </select>
        {/* ç®€åŒ–çš„ä¸‹æ‹‰ç®­å¤´ */}
        <svg className="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      {/* æ¨¡å‹é€‰æ‹© */}
      <div className="relative">
        <select
          value={selectedModelKey}
          onChange={onModelChange}
          disabled={!selectedProviderId}
          className="px-2 py-1 text-sm font-medium text-slate-600 bg-transparent border-b-2 border-slate-300 focus:border-indigo-500 focus:outline-none appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed pr-6 hover:text-slate-900 transition-colors"
        >
          <option value="" disabled>æ¨¡å‹</option>
          {availableModels.map((model) => (
            <option key={model.id} value={getModelKey(model)}>
              {getModelDisplay(model)}
            </option>
          ))}
        </select>
        {/* ç®€åŒ–çš„ä¸‹æ‹‰ç®­å¤´ */}
        <svg className="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
  )
}

```


## src/components/layout/TopNavigation.tsx

```tsx
import { Link, useNavigate } from 'react-router-dom'
import { Settings, LogOut } from 'lucide-react'
import { useNavigationStore, type ModuleConfig } from '@/stores/navigationStore'
import { useSettingsStore } from '@/stores/settingsStore'
import { useAuthStore } from '@/stores/authStore'
import TopModelSelector from './TopModelSelector'

export default function TopNavigation() {
  const navigate = useNavigate()
  const modules = useNavigationStore((state) => state.modules)
  const currentModule = useNavigationStore((state) => state.currentModule)
  const setCurrentModule = useNavigationStore((state) => state.setCurrentModule)
  const setShowSettings = useSettingsStore((state) => state.setShowSettings)
  const token = useAuthStore((state) => state.token)
  const user = useAuthStore((state) => state.user)
  const logout = useAuthStore((state) => state.logout)
  
  const handleModuleClick = (module: ModuleConfig) => {
    setCurrentModule(module.id)
    navigate(module.path)
  }
  
  const handleLogout = async () => {
    try {
      await logout()
      navigate('/login')
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error)
    }
  }
  
  return (
    <nav className="nav-container atmospheric-bg sticky top-0 z-50 py-3 px-6 bg-[rgba(248,250,252,0.8)] backdrop-blur-xl border-b border-[var(--ct-slate-200)] transition-all duration-300">
      <div className="flex items-center justify-between w-full">
        {/* Logo Area */}
        <div className="flex items-center gap-3">
          <div className="w-9 h-9 flex items-center justify-center rounded-lg shadow-soft interactive">
            <div className="w-full h-full rounded-lg bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center">
              <span className="font-bold text-white text-sm tracking-tighter">YP</span>
            </div>
          </div>
          <h1 className="text-xl font-bold text-gradient bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent">
            YPrompt
          </h1>
        </div>

        {/* Center Navigation Menu */}
        <div className="flex items-center gap-2 p-1 bg-white/40 rounded-lg border border-slate-200 shadow-soft">
          {modules.map((module) => (
            <Link
              key={module.id}
              to={module.path}
              className={`nav-link interactive px-4 py-2 text-sm font-medium rounded transition-all duration-200 relative ${
                currentModule === module.id
                  ? 'text-white bg-gradient-to-r from-indigo-600 to-violet-600 shadow-[0_4px_14px_0_rgba(79,70,229,0.3)] hover:from-indigo-500 hover:to-violet-500 hover:shadow-[0_6px_20px_0_rgba(79,70,229,0.4)] hover:text-indigo-900'
                  : 'text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 hover:font-semibold'
              }`}
              onClick={(e) => {
                e.preventDefault()
                handleModuleClick(module)
              }}
            >
              <span>{module.name}</span>
            </Link>
          ))}

          {/* AI Model Selector after Library module */}
          <div className="ml-2 pl-2 border-l border-slate-200">
            <TopModelSelector />
          </div>
        </div>

        {/* Right Tools Area */}
        <div className="flex items-center gap-2">
          {/* Settings Button */}
          <button
            onClick={() => setShowSettings(true)}
            className="control-btn interactive w-10 h-10 rounded-lg text-slate-500 bg-white border border-slate-200 hover:bg-slate-50 hover:text-slate-700 transition-all duration-200 flex items-center justify-center"
            title="è®¾ç½®"
          >
            <Settings className="w-5 h-5" />
          </button>

          {/* Logout Button */}
          {token && user && (
            <button
              onClick={handleLogout}
              className="control-btn-danger interactive w-10 h-10 rounded-lg text-red-500 bg-white border border-red-200 hover:bg-red-50 hover:text-red-600 transition-all duration-200 flex items-center justify-center"
              title="ç™»å‡ºè´¦å·"
            >
              <LogOut className="w-5 h-5" />
            </button>
          )}
        </div>
      </div>
    </nav>
  )
}

```


## src/components/modules/GenerateModule.tsx

```tsx
import { useEffect } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import ChatInterface from '../ChatInterface'
import PreviewPanel from '../PreviewPanel'
import GenerateSettingsModal from '../GenerateSettingsModal'
import NotificationContainer from '../NotificationContainer'

export default function GenerateModule() {
  const isInitialized = useProviderStore((state) => state.isInitialized)
  const initialize = useProviderStore((state) => state.initialize)

  useEffect(() => {
    const init = async () => {
      // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–
      if (!isInitialized) {
        await initialize()
      }

      // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ˜¾ç¤ºè®¾ç½®ç•Œé¢
      const providerStore = useProviderStore.getState()
      const hasConfiguredProvider = providerStore.enabledProviders.length > 0
      if (!hasConfiguredProvider) {
        setTimeout(() => {
          // TODO: æ˜¾ç¤ºè®¾ç½®ç•Œé¢æˆ–æç¤ºç”¨æˆ·é…ç½®
        }, 1000)
      }
    }

    init()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isInitialized]) // åªä¾èµ– isInitialized

  return (
    <div className="w-full flex-1 flex flex-col overflow-hidden p-2 min-h-0">
      {/* è®¾ç½®æŒ‰é’® */}
      <GenerateSettingsModal />

      <div className="w-full flex-1 flex flex-col overflow-hidden min-h-0">
        {/* æ¨¡å—ç‰¹å®šé¡¶æ  */}
        <div className="bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0">
          <div className="flex items-center justify-between">
            <div className="min-w-0">
              <h2 className="text-xl lg:text-2xl font-bold text-gray-800 mb-1">æ™ºèƒ½æç¤ºè¯åˆ›å»º</h2>
              <p className="text-sm lg:text-base text-gray-600">AIå¼•å¯¼å¼å¯¹è¯ï¼Œå¸®æ‚¨æ„å»ºä¸“ä¸šçš„æç¤ºè¯</p>
            </div>
          </div>
        </div>

        {/* ä¸»å†…å®¹åŒºåŸŸ */}
        <div className="flex flex-row flex-1 min-h-0 gap-4 overflow-hidden">
          {/* å·¦ä¾§ - Chat Interface */}
          <div className="flex flex-col flex-1 min-h-0">
            <ChatInterface />
          </div>

          {/* å³ä¾§ - Preview Panel */}
          <div className="flex flex-col flex-1 min-h-0">
            <PreviewPanel />
          </div>
        </div>
      </div>

      {/* é€šçŸ¥å®¹å™¨ */}
      <NotificationContainer />
    </div>
  )
}

```


## src/components/modules/LibraryModule.tsx

```tsx
import { useState, useRef } from 'react'
import { useAuthStore } from '@/stores/authStore'
import { useNotificationStore } from '@/stores/notificationStore'
import PromptList from './library/components/PromptList'
import SavePromptDialog from '@/components/preview/components/dialogs/SavePromptDialog'
import { post } from '@/services/apiService'

function LibraryModule() {
  const token = useAuthStore((state) => state.token)
  const user = useAuthStore((state) => state.user)
  const notificationStore = useNotificationStore()

  // æ–°å»ºæç¤ºè¯çŠ¶æ€
  const [showCreateDialog, setShowCreateDialog] = useState(false)
  const [newPromptContent, setNewPromptContent] = useState('')
  const [isSaving, setIsSaving] = useState(false)

  // æœç´¢çŠ¶æ€
  const [searchKeyword, setSearchKeyword] = useState('')

  // PromptList ref
  const promptListRef = useRef<{ searchWithKeyword: (keyword: string) => void; loadPrompts: () => Promise<void> } | null>(null)

  // é˜²æŠ–å®šæ—¶å™¨
  const searchTimerRef = useRef<NodeJS.Timeout | null>(null)

  // æœç´¢å¤„ç†ï¼ˆé˜²æŠ–ï¼‰
  const handleSearch = () => {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (searchTimerRef.current) {
      clearTimeout(searchTimerRef.current)
    }

    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ500msåæ‰§è¡Œæœç´¢
    searchTimerRef.current = setTimeout(() => {
      // é€šè¿‡refè°ƒç”¨å­ç»„ä»¶çš„æœç´¢æ–¹æ³•
      if (promptListRef.current) {
        promptListRef.current.searchWithKeyword(searchKeyword)
      }
    }, 500)
  }

  // åˆ›å»ºæç¤ºè¯
  const handleCreatePrompt = async (formData: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    promptType: string
    content?: string
  }) => {
    try {
      setIsSaving(true)

      const result = await post('/api/prompts/', {
        title: formData.title,
        description: formData.description,
        final_prompt: formData.content || newPromptContent,
        language: 'zh',
        format: 'markdown',
        prompt_type: formData.promptType,
        tags: formData.tags,
        is_public: formData.isPublic ? 1 : 0
      })

      if (result.code === 200) {
        notificationStore.success('æç¤ºè¯åˆ›å»ºæˆåŠŸï¼', 2000)
        setShowCreateDialog(false)
        setNewPromptContent('')
        // åˆ·æ–°åˆ—è¡¨ï¼ˆè°ƒç”¨å­ç»„ä»¶çš„loadPromptsæ–¹æ³•ï¼‰
        if (promptListRef.current) {
          await promptListRef.current.loadPrompts()
        }
      } else {
        throw new Error(result.message || 'åˆ›å»ºå¤±è´¥')
      }
    } catch (err: any) {
      console.error('åˆ›å»ºæç¤ºè¯å¤±è´¥:', err)
      notificationStore.error(`åˆ›å»ºå¤±è´¥: ${err.message}`, 3000)
    } finally {
      setIsSaving(false)
    }
  }

  return (
    <div className="h-full flex flex-col overflow-hidden p-2">
      {/* æ¨¡å—ç‰¹å®šé¡¶æ ï¼ˆæœç´¢å’Œæ“ä½œåŠŸèƒ½ï¼‰ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-4 flex-shrink-0">
        {/* ä¸»è¦å†…å®¹åŒºåŸŸï¼šæœç´¢å’Œæ“ä½œ */}
        <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          {/* æ ‡é¢˜ */}
          <div className="min-w-0">
            <h2 className="text-xl lg:text-2xl font-bold text-gray-900">æ¨¡æ¿åº“</h2>
            <p className="text-sm text-gray-500 mt-1">ç®¡ç†å’Œä½¿ç”¨æ‚¨çš„æç¤ºè¯æ¨¡æ¿</p>
          </div>

          {/* æœç´¢å’Œæ“ä½œåŒºåŸŸ */}
          <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
            {/* æœç´¢æ¡† */}
            <div className="relative">
              <span className="absolute left-3.5 top-2.5 text-gray-400">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </span>
              <input
                value={searchKeyword}
                onChange={(e) => {
                  setSearchKeyword(e.target.value)
                  handleSearch()
                }}
                type="text"
                placeholder="æœç´¢æç¤ºè¯..."
                className="w-80 pl-11 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm outline-none"
              />
            </div>

            {/* æ“ä½œæŒ‰é’®ç»„ */}
            <div className="flex items-center gap-3">
              {/* æ–°å»ºæŒ‰é’® */}
              <button
                onClick={() => setShowCreateDialog(true)}
                className="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2 whitespace-nowrap text-sm font-medium"
              >
                <span>æ–°å»ºæç¤ºè¯</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="flex-1 bg-white rounded-lg shadow-sm overflow-hidden">
        {/* å·²ç™»å½•çŠ¶æ€ */}
        {token && user ? (
          <>
            {/* æç¤ºè¯åˆ—è¡¨ */}
            <PromptList
              ref={promptListRef}
              searchKeyword={searchKeyword}
              onCreatePrompt={() => setShowCreateDialog(true)}
            />

            {/* æ–°å»ºæç¤ºè¯å¯¹è¯æ¡† */}
            <SavePromptDialog
              isOpen={showCreateDialog}
              promptContent={newPromptContent}
              isSaving={isSaving}
              onSave={handleCreatePrompt}
              onCancel={() => setShowCreateDialog(false)}
            />
          </>
        ) : (
          /* æœªç™»å½•çŠ¶æ€ */
          <div className="h-full flex items-center justify-center">
            <div className="text-center max-w-md px-6">
              <svg className="w-16 h-16 mb-4 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <h4 className="text-2xl font-bold text-gray-800 mb-2">è¯·å…ˆç™»å½•</h4>
              <p className="text-gray-600">
                ç™»å½•åå³å¯è®¿é—®æ‚¨çš„ä¸ªäººæç¤ºè¯åº“
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default LibraryModule

```


## src/components/modules/OptimizeModule.tsx

```tsx
import { useState, useEffect, useRef } from 'react'
import { useParams } from 'react-router-dom'
import { useSettingsStore } from '@/stores/settingsStore'
import { useProviderStore } from '@/stores/providerStore'
import { useOptimizeStore } from '@/stores/optimizeStore'
import { useNotificationStore } from '@/stores/notificationStore'
import OptimizeSectionRedesign from './optimize/components/OptimizeSectionRedesign'
import DiffViewer from './optimize/components/DiffViewer'
import { get } from '@/services/apiService'

// localStorage key
const ACTIVE_MODE_KEY = 'yprompt_optimize_active_mode'

function OptimizeModule() {
  const params = useParams<{ id?: string }>()
  // ä½¿ç”¨é€‰æ‹©å™¨é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  const loadSettings = useSettingsStore((state) => state.loadSettings)
  const isProviderInitialized = useProviderStore((state) => state.isInitialized)
  const initializeProvider = useProviderStore((state) => state.initialize)
  const optimizeStore = useOptimizeStore()
  const notificationStore = useNotificationStore()

  const [showDiffModal, setShowDiffModal] = useState(false)
  const [activeMode, setActiveMode] = useState<'system' | 'user' | 'compare'>('system')
  const [windowWidth, setWindowWidth] = useState(window.innerWidth)
  // windowWidth ç”¨äºå“åº”å¼å¸ƒå±€ï¼Œæš‚æ—¶æœªç›´æ¥ä½¿ç”¨ä½†ä¿ç•™ç”¨äºæœªæ¥æ‰©å±•
  void windowWidth
  const [, setIsLoadingPrompt] = useState(false)

  const compareTriggerIntervalRef = useRef<NodeJS.Timeout | null>(null)

  // ä»localStorageæ¢å¤activeMode (ä»…å½“URLä¸­æ²¡æœ‰promptIdæ—¶)
  useEffect(() => {
    if (!params.id) {
      try {
        const savedMode = localStorage.getItem(ACTIVE_MODE_KEY)
        if (savedMode && ['system', 'user', 'compare'].includes(savedMode)) {
          setActiveMode(savedMode as 'system' | 'user' | 'compare')
        }
      } catch (e) {
        console.error('è¯»å–activeModeå¤±è´¥:', e)
      }
    }
  }, [params.id])

  // è®¡ç®—å±æ€§
  // const isDesktop = windowWidth >= 1200 // æš‚æ—¶æœªä½¿ç”¨

  const optimizationModes = [
    { key: 'system' as const, label: 'ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–' },
    { key: 'user' as const, label: 'ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–' },
    { key: 'compare' as const, label: 'æ•ˆæœå¯¹æ¯”' }
  ]

  // äº‹ä»¶å¤„ç†
  const handleModeChange = (mode: 'system' | 'user' | 'compare') => {
    setActiveMode(mode)
    // ä¿å­˜åˆ°localStorage
    try {
      localStorage.setItem(ACTIVE_MODE_KEY, mode)
    } catch (e) {
      console.error('ä¿å­˜activeModeå¤±è´¥:', e)
    }
  }

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–
  useEffect(() => {
    const handleResize = () => {
      setWindowWidth(window.innerWidth)
    }
    window.addEventListener('resize', handleResize)
    return () => window.removeEventListener('resize', handleResize)
  }, [])

  // ä»"æˆ‘çš„"é¡µé¢åŠ è½½æç¤ºè¯
  const loadPromptFromLibrary = async (promptId: number) => {
    setIsLoadingPrompt(true)

    try {
      const result = await get<{
        code: number
        message?: string
        data: {
          id: number
          title: string
          prompt_type: string
          final_prompt?: string
          system_prompt?: string
          conversation_history?: string
        }
      }>(`/api/prompts/${promptId}`)

      if (result.code === 200) {
        const prompt = result.data

        console.log('ğŸŸ¢ åŠ è½½æç¤ºè¯æˆåŠŸ:', {
          id: prompt.id,
          title: prompt.title,
          type: prompt.prompt_type,
          final_prompt_length: prompt.final_prompt?.length,
          system_prompt_length: prompt.system_prompt?.length,
          conversation_history_length: prompt.conversation_history?.length
        })

        // æ ¹æ®prompt_typeæ™ºèƒ½è·¯ç”±
        if (prompt.prompt_type === 'user') {
          // ç”¨æˆ·æç¤ºè¯ - åŠ è½½åˆ°ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–æ ‡ç­¾é¡µ
          setActiveMode('user')
          optimizeStore.setLoadedPromptId(prompt.id)
          console.log('ğŸ”µ ç”¨æˆ·æç¤ºè¯ - è®¾ç½®loadedPromptId:', prompt.id)

          // è¿™é‡Œéœ€è¦é€šè¿‡storeæˆ–è€…äº‹ä»¶å°†æ•°æ®ä¼ é€’ç»™OptimizeSectionRedesign
          // æš‚æ—¶ä½¿ç”¨localStorageä½œä¸ºä¸­è½¬
          const userData = {
            draftPrompt: prompt.final_prompt || '',
            systemPrompt: prompt.system_prompt || '',
            conversationHistory: prompt.conversation_history || ''
          }
          console.log('ğŸ”µ ä¿å­˜ç”¨æˆ·æç¤ºè¯æ•°æ®åˆ°localStorage:', userData)
          localStorage.setItem('yprompt_optimize_loaded_user_prompt', JSON.stringify(userData))
        } else {
          // ç³»ç»Ÿæç¤ºè¯ - åŠ è½½åˆ°ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–æ ‡ç­¾é¡µ
          setActiveMode('system')
          optimizeStore.setPrompts(prompt.final_prompt || '', '')
          optimizeStore.setLoadedPromptId(prompt.id)
          console.log('ğŸ”µ ç³»ç»Ÿæç¤ºè¯ - è®¾ç½®loadedPromptId:', prompt.id)
          console.log('ğŸ”µ è®¾ç½®ç³»ç»Ÿæç¤ºè¯åˆ°store:', prompt.final_prompt?.substring(0, 50))
        }

        // ä¿å­˜activeModeåˆ°localStorage
        localStorage.setItem(ACTIVE_MODE_KEY, activeMode)
      } else {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥')
      }
    } catch (error: any) {
      console.error('åŠ è½½æç¤ºè¯å¤±è´¥:', error)
      notificationStore.error(`åŠ è½½å¤±è´¥: ${error.message}`, 3000)
    } finally {
      setIsLoadingPrompt(false)
    }
  }

  // ç›‘å¬è·¯ç”±å˜åŒ–ï¼ŒåŠ è½½å¯¹åº”çš„æç¤ºè¯
  useEffect(() => {
    if (params.id) {
      loadPromptFromLibrary(Number(params.id))
    }
  }, [params.id])

  // ç›‘å¬å¯¹æ¯”è§¦å‘æ ‡å¿—å’Œè¿”å›ä¼˜åŒ–é¡µé¢æ ‡å¿—
  // ä½¿ç”¨ storage äº‹ä»¶ç›‘å¬æ›¿ä»£è½®è¯¢ï¼Œå¤§å¹…å‡å°‘ CPU ä½¿ç”¨
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'yprompt_trigger_compare' && e.newValue === 'true') {
        console.log('ğŸŸ¢ æ£€æµ‹åˆ°å¯¹æ¯”è§¦å‘ï¼Œåˆ‡æ¢åˆ°compareæ¨¡å¼')
        setActiveMode('compare')
        localStorage.removeItem('yprompt_trigger_compare')
        localStorage.setItem(ACTIVE_MODE_KEY, 'compare')
      }

      if (e.key === 'yprompt_back_to_optimize' && e.newValue === 'true') {
        console.log('ğŸŸ¢ æ£€æµ‹åˆ°è¿”å›è§¦å‘ï¼Œåˆ‡æ¢å›ä¼˜åŒ–æ¨¡å¼')
        const savedMode = localStorage.getItem(ACTIVE_MODE_KEY)
        if (savedMode && ['system', 'user'].includes(savedMode)) {
          setActiveMode(savedMode as 'system' | 'user')
        }
        localStorage.removeItem('yprompt_back_to_optimize')
      }
    }

    // ä½¿ç”¨ storage äº‹ä»¶ç›‘å¬ï¼Œé¿å…è½®è¯¢
    window.addEventListener('storage', handleStorageChange)
    
    // ä¹Ÿç›‘å¬åŒçª—å£å†…çš„ localStorage å˜åŒ–ï¼ˆé€šè¿‡è‡ªå®šä¹‰äº‹ä»¶ï¼‰
    const handleCustomStorageChange = (e: Event) => {
      const customEvent = e as CustomEvent<{ key: string; newValue: string | null }>
      if (customEvent.detail.key === 'yprompt_trigger_compare' && customEvent.detail.newValue === 'true') {
        console.log('ğŸŸ¢ æ£€æµ‹åˆ°å¯¹æ¯”è§¦å‘ï¼Œåˆ‡æ¢åˆ°compareæ¨¡å¼')
        setActiveMode('compare')
        localStorage.removeItem('yprompt_trigger_compare')
        localStorage.setItem(ACTIVE_MODE_KEY, 'compare')
      }

      if (customEvent.detail.key === 'yprompt_back_to_optimize' && customEvent.detail.newValue === 'true') {
        console.log('ğŸŸ¢ æ£€æµ‹åˆ°è¿”å›è§¦å‘ï¼Œåˆ‡æ¢å›ä¼˜åŒ–æ¨¡å¼')
        const savedMode = localStorage.getItem(ACTIVE_MODE_KEY)
        if (savedMode && ['system', 'user'].includes(savedMode)) {
          setActiveMode(savedMode as 'system' | 'user')
        }
        localStorage.removeItem('yprompt_back_to_optimize')
      }
    }
    
    window.addEventListener('localStorageChange', handleCustomStorageChange as EventListener)

    return () => {
      window.removeEventListener('storage', handleStorageChange)
      window.removeEventListener('localStorageChange', handleCustomStorageChange as EventListener)
      if (compareTriggerIntervalRef.current) {
        clearInterval(compareTriggerIntervalRef.current)
        compareTriggerIntervalRef.current = null
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []) // åªåœ¨æŒ‚è½½æ—¶è®¾ç½®ç›‘å¬å™¨

  // åˆå§‹åŒ–è®¾ç½®å’Œæ¨¡å‹åˆ—è¡¨
  useEffect(() => {
    loadSettings()
    if (!isProviderInitialized) {
      initializeProvider()
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []) // åªåœ¨æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡

  return (
    <div className="w-full flex-1 flex flex-col overflow-hidden p-2 min-h-0">
      {/* æ¨¡å—ç‰¹å®šé¡¶æ  */}
      <div className="bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0">
        <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div className="min-w-0">
            <h2 className="text-xl lg:text-2xl font-bold text-gray-800 mb-1">æç¤ºè¯ä¼˜åŒ–</h2>
          </div>
        </div>

        {/* ä¼˜åŒ–æ¨¡å¼é€‰æ‹© */}
        <div className="flex space-x-2 mt-4">
          {optimizationModes.map((mode) => (
            <button
              key={mode.key}
              onClick={() => handleModeChange(mode.key)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                activeMode === mode.key
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {mode.label}
            </button>
          ))}
        </div>
      </div>

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="flex-1 min-h-0 overflow-hidden">
        <OptimizeSectionRedesign
          activeMode={activeMode}
          onUpdateActiveMode={setActiveMode}
        />
      </div>

      {/* DiffæŸ¥çœ‹å™¨æ¨¡æ€æ¡† */}
      {showDiffModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-4xl max-h-[90vh] w-[90vw] overflow-hidden">
            <DiffViewer
              leftContent={optimizeStore.systemPrompt}
              rightContent={optimizeStore.optimizedPrompts.system}
              leftLabel="åŸå§‹ç‰ˆæœ¬"
              rightLabel="ä¼˜åŒ–ç‰ˆæœ¬"
              onClose={() => setShowDiffModal(false)}
            />
          </div>
        </div>
      )}
    </div>
  )
}

export default OptimizeModule

```


## src/components/modules/PlaygroundModule.tsx

```tsx
import { useState, useEffect } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import PlaygroundApp from '../playground/PlaygroundApp'
import SystemPromptModal from './optimize/components/quick/SystemPromptModal'

const STORAGE_KEY = 'yprompt_playground_system_prompt'

export default function PlaygroundModule() {
  const providerStore = useProviderStore()
  const [systemPrompt, setSystemPrompt] = useState('')
  const [systemPromptDraft, setSystemPromptDraft] = useState('')
  const [showSystemPromptModal, setShowSystemPromptModal] = useState(false)

  // åˆå§‹åŒ– providerStore
  useEffect(() => {
    if (!providerStore.isInitialized) {
      providerStore.initialize()
    }
  }, [providerStore])

  // ä» localStorage åŠ è½½ç³»ç»Ÿæç¤ºè¯
  useEffect(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY)
      if (saved) {
        setSystemPrompt(saved)
      }
    } catch (error) {
      console.warn('åŠ è½½ç³»ç»Ÿæç¤ºè¯å¤±è´¥', error)
    }
  }, [])

  // ä¿å­˜ç³»ç»Ÿæç¤ºè¯åˆ° localStorage
  useEffect(() => {
    if (systemPrompt) {
      localStorage.setItem(STORAGE_KEY, systemPrompt)
    }
  }, [systemPrompt])

  const openSystemPromptModal = () => {
    setSystemPromptDraft(systemPrompt)
    setShowSystemPromptModal(true)
  }

  const handleSystemPromptSave = () => {
    setSystemPrompt(systemPromptDraft)
    setShowSystemPromptModal(false)
  }

  return (
    <div className="w-full flex-1 flex flex-col overflow-hidden p-2 playground-container min-h-0">
      {showSystemPromptModal && (
        <SystemPromptModal
          isOpen={showSystemPromptModal}
          modelValue={systemPromptDraft}
          onUpdateModelValue={setSystemPromptDraft}
          onClose={() => setShowSystemPromptModal(false)}
          onSave={handleSystemPromptSave}
        />
      )}

      <div className="bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0">
        <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div className="min-w-0">
            <h2 className="text-xl lg:text-2xl font-bold text-gray-900">æç¤ºè¯æ“ç»ƒåœº</h2>
            <p className="text-sm text-gray-500">å®æ—¶è°ƒè¯•æç¤ºè¯ã€ç½‘é¡µã€å›¾è¡¨ä¸å¯è§†åŒ– Artifact</p>
          </div>
        </div>
      </div>

      <div className="flex-1 min-h-0 overflow-hidden">
        <PlaygroundApp systemPrompt={systemPrompt} onOpenSystemPrompt={openSystemPromptModal} />
      </div>
    </div>
  )
}

```


## src/components/modules/library/components/PromptDetailModal.tsx

```tsx
import { useState, useEffect, useRef, useMemo } from 'react'
import { X, Copy, Edit, Zap, Save, X as XIcon } from 'lucide-react'
import { copyToClipboard } from '@/utils/clipboardUtils'
import { useNotificationStore } from '@/stores/notificationStore'
import { put } from '@/services/apiService'
import VersionHistoryContent from './VersionHistoryContent'
import type { Prompt, PromptListItem } from '@/types/prompt'

interface PromptDetailModalProps {
  prompt: Prompt | PromptListItem | null
  onClose: () => void
  onEdit: (prompt: Prompt | PromptListItem) => void
  onOptimize: (prompt: Prompt | PromptListItem) => void
  onRollback: (versionNumber: string) => void
}

export default function PromptDetailModal({
  prompt,
  onClose,
  onEdit,
  onOptimize,
  onRollback
}: PromptDetailModalProps) {
  const notificationStore = useNotificationStore()

  const [activeTab, setActiveTab] = useState<'content' | 'info' | 'versions'>('content')
  const [isEditing, setIsEditing] = useState(false)
  const [editedContent, setEditedContent] = useState('')
  const [editedTitle, setEditedTitle] = useState('')
  const [editedDescription, setEditedDescription] = useState('')
  const [editedPromptType, setEditedPromptType] = useState<'system' | 'user'>('system')
  const [editedIsPublic, setEditedIsPublic] = useState(false)
  const [editedTags, setEditedTags] = useState<string[]>([])
  const [tagInput, setTagInput] = useState('')
  const [showTagInput, setShowTagInput] = useState(false)
  const [isSaving, setIsSaving] = useState(false)
  const tagInputRef = useRef<HTMLInputElement>(null)

  const isOpen = !!prompt

  // ç¡®ä¿ tags å§‹ç»ˆæ˜¯æ•°ç»„æ ¼å¼
  const promptTags = useMemo(() => {
    if (!prompt) return []
    const tags = prompt.tags
    return Array.isArray(tags)
      ? tags
      : typeof tags === 'string'
      ? tags.split(',').map((t: string) => t.trim()).filter((t: string) => t)
      : []
  }, [prompt])

  const tabs = [
    { key: 'content' as const, label: 'æç¤ºè¯å†…å®¹' },
    { key: 'info' as const, label: 'åŸºæœ¬ä¿¡æ¯' },
    { key: 'versions' as const, label: 'ç‰ˆæœ¬å†å²' }
  ]

  // ç›‘å¬æ ‡ç­¾è¾“å…¥æ¡†æ˜¾ç¤ºçŠ¶æ€ï¼Œè‡ªåŠ¨èšç„¦
  useEffect(() => {
    if (showTagInput && tagInputRef.current) {
      tagInputRef.current.focus()
    }
  }, [showTagInput])

  // åˆå§‹åŒ–ç¼–è¾‘çŠ¶æ€
  useEffect(() => {
    if (prompt && isEditing) {
      setEditedContent(prompt.final_prompt)
      setEditedTitle(prompt.title)
      setEditedDescription(prompt.description || '')
      setEditedPromptType((prompt.prompt_type as 'system' | 'user') || 'system')
      setEditedIsPublic(!!prompt.is_public)
      const tags = prompt.tags
      setEditedTags(
        Array.isArray(tags)
          ? [...tags]
          : typeof tags === 'string'
          ? tags.split(',').map((t: string) => t.trim()).filter((t: string) => t)
          : []
      )
    }
  }, [prompt, isEditing])

  // å…³é—­å¼¹çª—
  const handleClose = () => {
    setIsEditing(false)
    onClose()
    setActiveTab('content')
  }

  // å¼€å§‹ç¼–è¾‘
  const handleEdit = () => {
    if (!prompt) return
    setIsEditing(true)
  }

  // å–æ¶ˆç¼–è¾‘
  const handleCancelEdit = () => {
    setIsEditing(false)
    setEditedContent('')
    setEditedTitle('')
    setEditedDescription('')
    setEditedPromptType('system')
    setEditedIsPublic(false)
    setEditedTags([])
    setTagInput('')
    setShowTagInput(false)
  }

  // æ·»åŠ æ ‡ç­¾
  const addTag = () => {
    const tag = tagInput.trim()

    // éªŒè¯ï¼šéç©º
    if (!tag) {
      return
    }

    // éªŒè¯ï¼šæœ€å¤š5ä¸ªæ ‡ç­¾
    if (editedTags.length >= 5) {
      notificationStore.warning('æœ€å¤šåªèƒ½æ·»åŠ 5ä¸ªæ ‡ç­¾', 2000)
      return
    }

    // éªŒè¯ï¼šæ ‡ç­¾ä¸é‡å¤
    if (editedTags.includes(tag)) {
      notificationStore.warning('æ ‡ç­¾å·²å­˜åœ¨', 2000)
      setTagInput('')
      return
    }

    // éªŒè¯ï¼šæœ€å¤š8ä¸ªå­—ç¬¦
    if (tag.length > 8) {
      notificationStore.warning('æ ‡ç­¾æœ€å¤š8ä¸ªå­—ç¬¦', 2000)
      return
    }

    // æ·»åŠ æ ‡ç­¾
    setEditedTags([...editedTags, tag])
    setTagInput('')
    setShowTagInput(false)
  }

  // ç§»é™¤æ ‡ç­¾
  const removeTag = (index: number) => {
    setEditedTags(editedTags.filter((_, i) => i !== index))
  }

  // ä¿å­˜ç¼–è¾‘
  const handleSaveEdit = async () => {
    if (!prompt) return

    try {
      setIsSaving(true)

      const result = await put(`/api/prompts/${prompt.id}`, {
        title: editedTitle.trim(),
        description: editedDescription.trim(),
        final_prompt: editedContent,
        prompt_type: editedPromptType,
        is_public: editedIsPublic ? 1 : 0,
        tags: editedTags
      })

      if (result.code === 200) {
        notificationStore.success('ä¿å­˜æˆåŠŸ', 2000)
        setIsEditing(false)
        // æ›´æ–°æœ¬åœ°æ•°æ®
        const updatedPrompt = {
          ...prompt,
          title: editedTitle.trim(),
          description: editedDescription.trim(),
          final_prompt: editedContent,
          prompt_type: editedPromptType,
          is_public: editedIsPublic ? 1 : 0,
          tags: editedTags
        }
        // é€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°åˆ—è¡¨
        onEdit(updatedPrompt)
      } else {
        throw new Error(result.message || 'ä¿å­˜å¤±è´¥')
      }
    } catch (err: any) {
      console.error('ä¿å­˜å¤±è´¥:', err)
      notificationStore.error(`ä¿å­˜å¤±è´¥: ${err.message}`, 3000)
    } finally {
      setIsSaving(false)
    }
  }

  // å¤åˆ¶æç¤ºè¯
  const handleCopy = async () => {
    if (!prompt) return

    try {
      await copyToClipboard(prompt.final_prompt)
      notificationStore.success('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000)
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥:', err)
      notificationStore.error('å¤åˆ¶å¤±è´¥', 2000)
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  const formatDateTime = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    })
  }

  if (!isOpen || !prompt) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
      <div className="prompt-detail-modal bg-white rounded-lg shadow-xl w-full h-[90vh] max-w-6xl mx-4 overflow-hidden flex flex-col">
        {/* å¤´éƒ¨ */}
        <div className="flex items-start justify-between p-6 border-b bg-gray-50">
          <div className="flex-1 min-w-0">
            {/* ç¼–è¾‘æ¨¡å¼ */}
            {isEditing ? (
              <div className="space-y-3">
                <div className="flex items-center gap-4">
                  {/* æ ‡é¢˜è¾“å…¥ */}
                  <div className="flex-1 min-w-0">
                    <input
                      value={editedTitle}
                      onChange={(e) => setEditedTitle(e.target.value)}
                      type="text"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none text-xl font-semibold text-gray-900"
                      placeholder="è¯·è¾“å…¥æ ‡é¢˜"
                    />
                  </div>

                  {/* ç¼–è¾‘æ¨¡å¼æŒ‰é’® */}
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <button
                      onClick={handleCancelEdit}
                      className="px-3 py-1.5 text-sm bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center gap-1"
                    >
                      <XIcon className="w-4 h-4" />
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={handleSaveEdit}
                      disabled={isSaving}
                      className="px-3 py-1.5 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-1 disabled:opacity-50"
                    >
                      {isSaving ? (
                        'ä¿å­˜ä¸­...'
                      ) : (
                        <>
                          <Save className="w-4 h-4" />
                          ä¿å­˜
                        </>
                      )}
                    </button>
                  </div>
                </div>

                {/* æè¿°è¾“å…¥ */}
                <textarea
                  value={editedDescription}
                  onChange={(e) => setEditedDescription(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none text-sm text-gray-700 resize-none"
                  rows={2}
                  placeholder="è¯·è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰"
                />

                {/* æç¤ºè¯è®¾ç½®ï¼šç±»å‹ã€å¯è§æ€§ã€æ ‡ç­¾ï¼ˆç´§å‡‘å•è¡Œï¼‰ */}
                <div className="flex items-center gap-3 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
                  {/* ç±»å‹ */}
                  <div className="flex items-center gap-1.5">
                    <span className="text-xs font-medium text-gray-600">ç±»å‹</span>
                    <div className="flex gap-2">
                      <label className="flex items-center cursor-pointer group">
                        <input
                          type="radio"
                          checked={editedPromptType === 'system'}
                          onChange={() => setEditedPromptType('system')}
                          className="w-3.5 h-3.5 text-purple-600 border-gray-300 focus:ring-purple-500 focus:ring-1"
                        />
                        <span className="ml-1 text-xs text-gray-700 group-hover:text-purple-600">ç³»ç»Ÿ</span>
                      </label>
                      <label className="flex items-center cursor-pointer group">
                        <input
                          type="radio"
                          checked={editedPromptType === 'user'}
                          onChange={() => setEditedPromptType('user')}
                          className="w-3.5 h-3.5 text-blue-600 border-gray-300 focus:ring-blue-500 focus:ring-1"
                        />
                        <span className="ml-1 text-xs text-gray-700 group-hover:text-blue-600">ç”¨æˆ·</span>
                      </label>
                    </div>
                  </div>

                  <div className="w-px h-4 bg-gray-300"></div>

                  {/* å¯è§æ€§ */}
                  <label className="flex items-center cursor-pointer group">
                    <input
                      type="checkbox"
                      checked={editedIsPublic}
                      onChange={(e) => setEditedIsPublic(e.target.checked)}
                      className="w-3.5 h-3.5 text-green-600 border-gray-300 rounded focus:ring-green-500 focus:ring-1"
                    />
                    <span className="ml-1 text-xs text-gray-700 group-hover:text-green-600">å…¬å¼€</span>
                  </label>

                  <div className="w-px h-4 bg-gray-300"></div>

                  {/* æ ‡ç­¾ */}
                  <div className="flex items-center gap-1.5 flex-1 min-w-0">
                    <span className="text-xs font-medium text-gray-600 flex-shrink-0">æ ‡ç­¾</span>
                    {/* å·²æœ‰æ ‡ç­¾ */}
                    <div className="flex items-center gap-1 flex-wrap flex-1 min-w-0">
                      {editedTags.map((tag, index) => (
                        <span
                          key={index}
                          className="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors"
                        >
                          <span className="max-w-[80px] truncate">{tag}</span>
                          <button
                            onClick={() => removeTag(index)}
                            className="text-blue-600 hover:text-blue-800 font-bold text-sm leading-none"
                            title="ç§»é™¤æ ‡ç­¾"
                          >
                            Ã—
                          </button>
                        </span>
                      ))}
                      {/* æ·»åŠ æŒ‰é’® */}
                      {editedTags.length < 5 ? (
                        <button
                          onClick={() => setShowTagInput(!showTagInput)}
                          className="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-gray-200 hover:bg-gray-300 text-gray-600 text-xs rounded transition-colors"
                          title="æ·»åŠ æ ‡ç­¾"
                        >
                          <span>+</span>
                        </button>
                      ) : (
                        <span className="text-xs text-gray-400">(æœ€å¤š5ä¸ª)</span>
                      )}
                    </div>
                  </div>
                </div>

                {/* æ ‡ç­¾è¾“å…¥æ¡†ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰ */}
                {showTagInput && (
                  <div className="px-3">
                    <div className="flex items-center gap-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                      <input
                        ref={tagInputRef}
                        value={tagInput}
                        onChange={(e) => setTagInput(e.target.value)}
                        type="text"
                        placeholder="è¾“å…¥æ ‡ç­¾åï¼ˆæœ€å¤š8å­—ï¼‰"
                        maxLength={8}
                        className="flex-1 px-2 py-1 border border-gray-300 rounded outline-none text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.preventDefault()
                            addTag()
                          } else if (e.key === 'Escape') {
                            setShowTagInput(false)
                            setTagInput('')
                          }
                        }}
                      />
                      <button
                        onClick={addTag}
                        className="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors"
                      >
                        æ·»åŠ 
                      </button>
                      <button
                        onClick={() => {
                          setShowTagInput(false)
                          setTagInput('')
                        }}
                        className="px-3 py-1 bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm rounded transition-colors"
                      >
                        å–æ¶ˆ
                      </button>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              /* æŸ¥çœ‹æ¨¡å¼ */
              <div>
                <div className="flex items-center gap-4">
                  {/* æ ‡é¢˜å’Œæè¿° */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      <h2 className="text-xl font-semibold text-gray-900 truncate">{prompt.title}</h2>
                      {/* æç¤ºè¯ç±»å‹æ ‡ç­¾ */}
                      <span
                        className={`px-2 py-0.5 text-xs font-medium rounded border flex-shrink-0 ${
                          prompt.prompt_type === 'system'
                            ? 'bg-purple-100 text-purple-700 border-purple-200'
                            : 'bg-blue-100 text-blue-700 border-blue-200'
                        }`}
                      >
                        {prompt.prompt_type === 'system' ? 'ç³»ç»Ÿæç¤ºè¯' : 'ç”¨æˆ·æç¤ºè¯'}
                      </span>
                    </div>
                    {prompt.description && (
                      <p className="text-sm text-gray-600 mt-1 truncate">{prompt.description}</p>
                    )}
                  </div>

                  {/* æŸ¥çœ‹æ¨¡å¼æŒ‰é’® */}
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <button
                      onClick={handleCopy}
                      className="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center gap-1"
                    >
                      <Copy className="w-4 h-4" />
                      å¤åˆ¶
                    </button>
                    <button
                      onClick={handleEdit}
                      data-edit="prompt-detail"
                      className="px-3 py-1.5 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-1"
                    >
                      <Edit className="w-4 h-4" />
                      ç¼–è¾‘
                    </button>
                    <button
                      onClick={() => onOptimize(prompt)}
                      className="px-3 py-1.5 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-1"
                    >
                      <Zap className="w-4 h-4" />
                      ä¼˜åŒ–
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
          <button onClick={handleClose} className="text-gray-400 hover:text-gray-600 ml-4">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* å†…å®¹åŒºåŸŸ */}
        {prompt && (
          <div className="flex-1 overflow-hidden flex flex-col">
            {/* ç»Ÿè®¡ä¿¡æ¯æ ï¼ˆç¼–è¾‘æ¨¡å¼æ—¶éšè—ï¼‰ */}
            {!isEditing && (
              <div className="px-6 py-3 bg-gray-50 border-b">
                <div className="flex items-center flex-wrap gap-4 text-sm text-gray-600">
                  <span className="flex items-center gap-1">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {prompt.is_public ? 'å…¬å¼€' : 'ç§æœ‰'}
                  </span>

                  <span className="w-px h-4 bg-gray-300"></span>

                  <span className="flex items-center gap-1">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    {prompt.view_count || 0}
                  </span>

                  <span className="flex items-center gap-1">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    {prompt.use_count || 0}
                  </span>

                  <span className="flex items-center gap-1">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    v{prompt.current_version || '1.0.0'}
                  </span>

                  <span className="flex items-center gap-1">
                    {prompt.is_favorite ? (
                      <svg className="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                      </svg>
                    ) : (
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                      </svg>
                    )}
                    {prompt.is_favorite ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}
                  </span>

                  <span className="w-px h-4 bg-gray-300"></span>

                  {/* æ ‡ç­¾ï¼ˆä»…æŸ¥çœ‹æ¨¡å¼æ˜¾ç¤ºï¼‰ */}
                  <div className="flex items-center gap-2">
                    <span>æ ‡ç­¾:</span>
                    <div className="flex flex-wrap gap-1">
                      {promptTags.length > 0 ? (
                        promptTags.map((tag) => (
                          <span
                            key={tag}
                            className="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full"
                          >
                            {tag}
                          </span>
                        ))
                      ) : (
                        <span className="text-xs text-gray-500">æš‚æ— æ ‡ç­¾</span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* æ ‡ç­¾é¡µ */}
            <div className="flex-1 overflow-hidden flex flex-col">
              {/* æ ‡ç­¾æ  */}
              <div className="flex border-b">
                {tabs.map((tab) => (
                  <button
                    key={tab.key}
                    onClick={() => setActiveTab(tab.key)}
                    className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${
                      activeTab === tab.key
                        ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                        : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                    }`}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {/* æ ‡ç­¾å†…å®¹ */}
              <div className="flex-1 overflow-y-auto p-6">
                {/* æç¤ºè¯å†…å®¹ */}
                {activeTab === 'content' && (
                  <div className="h-full">
                    {/* ç¼–è¾‘æ¨¡å¼ */}
                    {isEditing ? (
                      <textarea
                        value={editedContent}
                        onChange={(e) => setEditedContent(e.target.value)}
                        className="w-full h-full p-4 outline-none resize-none text-sm text-gray-800 font-mono bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border border-gray-200"
                        placeholder="è¯·è¾“å…¥æç¤ºè¯å†…å®¹..."
                      />
                    ) : (
                      /* æŸ¥çœ‹æ¨¡å¼ */
                      <pre className="h-full p-4 whitespace-pre-wrap text-sm text-gray-800 font-mono overflow-auto bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border border-gray-200">
                        {prompt.final_prompt}
                      </pre>
                    )}
                  </div>
                )}

                {/* åŸºæœ¬ä¿¡æ¯ */}
                {activeTab === 'info' && (
                  <div className="space-y-4">
                    <div>
                      <dl className="space-y-3">
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">æ ‡é¢˜:</dt>
                          <dd className="text-sm text-gray-900">{prompt.title}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">æè¿°:</dt>
                          <dd className="text-sm text-gray-900">{prompt.description || 'æš‚æ— æè¿°'}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">è¯­è¨€:</dt>
                          <dd className="text-sm text-gray-900">{prompt.language === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">æ ¼å¼:</dt>
                          <dd className="text-sm text-gray-900">{prompt.format}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">å­—ç¬¦æ•°:</dt>
                          <dd className="text-sm text-gray-900">{prompt.final_prompt.length}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">åˆ›å»ºæ—¶é—´:</dt>
                          <dd className="text-sm text-gray-900">{formatDateTime(prompt.create_time)}</dd>
                        </div>
                        <div className="flex">
                          <dt className="w-32 text-sm font-medium text-gray-600">æ›´æ–°æ—¶é—´:</dt>
                          <dd className="text-sm text-gray-900">{formatDateTime(prompt.update_time)}</dd>
                        </div>

                        {/* ç”¨æˆ·æç¤ºè¯ç‰¹æœ‰å­—æ®µ */}
                        {prompt.prompt_type === 'user' && (
                          <>
                            <div className="pt-3 border-t border-gray-200">
                              <dt className="text-sm font-medium text-gray-600 mb-2">ç³»ç»Ÿæç¤ºè¯:</dt>
                              <dd className="text-sm text-gray-900">
                                {'system_prompt' in prompt && prompt.system_prompt ? (
                                  <pre className="p-3 bg-gray-50 rounded border border-gray-200 whitespace-pre-wrap font-mono text-xs">
                                    {prompt.system_prompt}
                                  </pre>
                                ) : (
                                  <span className="text-gray-400 italic">æœªè®¾ç½®</span>
                                )}
                              </dd>
                            </div>
                            <div className="pt-3 border-t border-gray-200">
                              <dt className="text-sm font-medium text-gray-600 mb-2">å¯¹è¯ä¸Šä¸‹æ–‡:</dt>
                              <dd className="text-sm text-gray-900">
                                {'conversation_history' in prompt && prompt.conversation_history ? (
                                  <pre className="p-3 bg-gray-50 rounded border border-gray-200 whitespace-pre-wrap font-mono text-xs">
                                    {prompt.conversation_history}
                                  </pre>
                                ) : (
                                  <span className="text-gray-400 italic">æœªè®¾ç½®</span>
                                )}
                              </dd>
                            </div>
                          </>
                        )}
                      </dl>
                    </div>
                  </div>
                )}

                {/* ç‰ˆæœ¬å†å² */}
                {activeTab === 'versions' && (
                  <div className="h-full">
                    <VersionHistoryContent promptId={prompt.id} onRollback={onRollback} />
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

```


## src/components/modules/library/components/PromptList.tsx

```tsx
import { useState, useEffect, forwardRef, useImperativeHandle } from 'react'
import { useNavigate } from 'react-router-dom'
import { useNavigationStore } from '@/stores/navigationStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { copyToClipboard } from '@/utils/clipboardUtils'
import PromptDetailModal from './PromptDetailModal'
import VersionHistoryPanel from './VersionHistoryPanel'
import type { PromptListItem } from '@/types/prompt'
import { get, del } from '@/services/apiService'

interface PromptListProps {
  searchKeyword: string
  onCreatePrompt: () => void
}

export interface PromptListRef {
  searchWithKeyword: (keyword: string) => void
  loadPrompts: () => Promise<void>
}

const PromptList = forwardRef<PromptListRef, PromptListProps>(({ searchKeyword }, ref) => {
  const navigate = useNavigate()
  const navigationStore = useNavigationStore()
  const notificationStore = useNotificationStore()

  // æ•°æ®çŠ¶æ€
  const [prompts, setPrompts] = useState<PromptListItem[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [currentPage, setCurrentPage] = useState(1)
  const pageSize = 10
  const [total, setTotal] = useState(0)

  // æœç´¢å’Œç­›é€‰
  const [selectedTag] = useState('')
  const [sortBy] = useState('create_time')
  const [onlyFavorites] = useState('0')
  const [, setAvailableTags] = useState<string[]>([])

  // UIçŠ¶æ€
  const [showActionMenu, setShowActionMenu] = useState<Record<number, boolean>>({})
  const [showDetailModal, setShowDetailModal] = useState(false)
  const [selectedPrompt, setSelectedPrompt] = useState<PromptListItem | null>(null)
  const [showVersionHistory, setShowVersionHistory] = useState(false)
  const [selectedPromptForVersion, setSelectedPromptForVersion] = useState<PromptListItem | null>(null)

  // å†…éƒ¨æœç´¢å…³é”®è¯çŠ¶æ€
  const [internalSearchKeyword, setInternalSearchKeyword] = useState('')

  // è®¡ç®—æ€»é¡µæ•°
  const totalPages = Math.ceil(total / pageSize)

  // æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
  useImperativeHandle(ref, () => ({
    searchWithKeyword: (keyword: string) => {
      setInternalSearchKeyword(keyword)
      setCurrentPage(1)
      loadPrompts()
    },
    loadPrompts
  }))

  // ç›‘å¬æœç´¢å…³é”®è¯å˜åŒ–
  useEffect(() => {
    if (searchKeyword !== internalSearchKeyword) {
      setInternalSearchKeyword(searchKeyword)
      setCurrentPage(1)
      loadPrompts()
    }
  }, [searchKeyword])

  // åŠ è½½æç¤ºè¯åˆ—è¡¨
  const loadPrompts = async () => {
    try {
      setIsLoading(true)

      const params = new URLSearchParams({
        page: currentPage.toString(),
        limit: pageSize.toString(),
        keyword: internalSearchKeyword,
        tag: selectedTag,
        sort: sortBy,
        is_favorite: onlyFavorites
      })

      const result = await get<{
        code: number
        message?: string
        data: {
          items: PromptListItem[]
          total: number
        }
      }>(`/api/prompts/?${params}`)

      if (result.code === 200) {
        setPrompts(result.data.items.map((item: any) => ({
          ...item,
          final_prompt: item.final_prompt || '',
          current_version: item.current_version || '1.0.0'
        })))
        setTotal(result.data.total)

        // æå–æ‰€æœ‰å¯ç”¨æ ‡ç­¾
        const allTags = new Set<string>()
        result.data.items.forEach((prompt: PromptListItem) => {
          if (prompt.tags) {
            const tags = Array.isArray(prompt.tags) ? prompt.tags : []
            tags.forEach((tag: string) => allTags.add(tag))
          }
        })
        setAvailableTags(Array.from(allTags).sort())
      } else {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:', err)
      notificationStore.error(`åŠ è½½å¤±è´¥: ${err.message}`, 3000)
    } finally {
      setIsLoading(false)
    }
  }

  // åˆ†é¡µ
  const changePage = (page: number) => {
    setCurrentPage(page)
  }

  useEffect(() => {
    loadPrompts()
  }, [currentPage, selectedTag, sortBy, onlyFavorites])

  // æŸ¥çœ‹è¯¦æƒ…
  const handleViewPrompt = async (prompt: PromptListItem) => {
    try {
      const result = await get<{
        code: number
        message?: string
        data: PromptListItem
      }>(`/api/prompts/${prompt.id}`)

      if (result.code === 200) {
        setSelectedPrompt(result.data)
        setShowDetailModal(true)
      }
    } catch (err) {
      console.error('è·å–æç¤ºè¯è¯¦æƒ…å¤±è´¥:', err)
      // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºå¼¹çª—ï¼ˆä½¿ç”¨åˆ—è¡¨ä¸­çš„æ•°æ®ï¼‰
      setSelectedPrompt(prompt)
      setShowDetailModal(true)
    }
  }

  // ç¼–è¾‘æç¤ºè¯
  const handleEditPrompt = (prompt: PromptListItem) => {
    setSelectedPrompt(prompt)
    setShowDetailModal(true)

    // ç›´æ¥è®¾ç½®å»¶æ—¶æ¥è§¦å‘ç¼–è¾‘
    setTimeout(() => {
      const editBtn = document.querySelector('button[data-edit="prompt-detail"]') as HTMLElement
      if (editBtn) {
        editBtn.click()
      }
    }, 100)
  }

  // æç¤ºè¯æ›´æ–°å®Œæˆå›è°ƒ
  const handlePromptUpdated = (updatedPrompt: PromptListItem) => {
    // æ›´æ–°åˆ—è¡¨ä¸­å¯¹åº”çš„æ•°æ®
    setPrompts((prev) => prev.map((p) => (p.id === updatedPrompt.id ? { ...updatedPrompt } : p)))
    // å…³é—­æ¨¡æ€æ¡†
    setShowDetailModal(false)
  }

  // ä¼˜åŒ–æç¤ºè¯
  const handleOptimizePrompt = (prompt: PromptListItem) => {
    navigationStore.setCurrentModule('optimize')
    navigate(`/optimize/${prompt.id}`)
    setShowDetailModal(false)
  }

  // å¤åˆ¶æç¤ºè¯
  const handleCopyPrompt = async (prompt: PromptListItem) => {
    try {
      await copyToClipboard(prompt.final_prompt)
      notificationStore.success('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000)
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥:', err)
      notificationStore.error('å¤åˆ¶å¤±è´¥', 2000)
    }
  }

  // æ˜¾ç¤ºç‰ˆæœ¬å†å²
  const handleShowVersionHistory = (prompt: PromptListItem) => {
    setSelectedPromptForVersion(prompt)
    setShowVersionHistory(true)
    setShowActionMenu({})
  }

  // å¤„ç†ç‰ˆæœ¬å›æ»šå®Œæˆ
  const handleVersionRollback = () => {
    // ä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œç‰ˆæœ¬ç»„ä»¶å·²ç»æ˜¾ç¤ºè¿‡äº†
    loadPrompts()
  }

  // åˆ é™¤æç¤ºè¯
  const handleDeletePrompt = async (prompt: PromptListItem) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æç¤ºè¯"${prompt.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
      return
    }

    try {
      const result = await del(`/api/prompts/${prompt.id}`)

      if (result.code === 200) {
        notificationStore.success('åˆ é™¤æˆåŠŸ', 2000)
        loadPrompts()
      } else {
        throw new Error(result.message || 'åˆ é™¤å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åˆ é™¤æç¤ºè¯å¤±è´¥:', err)
      notificationStore.error(`åˆ é™¤å¤±è´¥: ${err.message}`, 3000)
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (!(e.target as Element).closest('.relative.group')) {
        setShowActionMenu({})
      }
    }
    document.addEventListener('click', handleClickOutside)
    return () => document.removeEventListener('click', handleClickOutside)
  }, [])

  return (
    <div className="h-full flex flex-col">
      {/* æç¤ºè¯åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4">
        {/* åŠ è½½çŠ¶æ€ */}
        {isLoading && (
          <div className="flex items-center justify-center h-32">
            <div className="flex items-center gap-2 text-gray-500">
              <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              <span>åŠ è½½ä¸­...</span>
            </div>
          </div>
        )}

        {/* ç©ºçŠ¶æ€ */}
        {!isLoading && prompts.length === 0 && (
          <div className="flex flex-col items-center justify-center h-64 text-center">
            <svg className="w-16 h-16 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 className="text-lg font-semibold text-gray-800 mb-2">
              {internalSearchKeyword || selectedTag ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æç¤ºè¯' : 'è¿˜æ²¡æœ‰ä¿å­˜çš„æç¤ºè¯'}
            </h3>
            <p className="text-gray-600 mb-4">
              {internalSearchKeyword || selectedTag ? 'è¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶' : 'å»ç”Ÿæˆé¡µé¢åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæç¤ºè¯å§ï¼'}
            </p>
            <a
              href="/generate"
              className="inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
            >
              å¼€å§‹ç”Ÿæˆ
            </a>
          </div>
        )}

        {/* æç¤ºè¯å¡ç‰‡åˆ—è¡¨ */}
        {!isLoading && prompts.length > 0 && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {prompts.map((prompt) => (
              <div
                key={prompt.id}
                className="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                onClick={() => handleViewPrompt(prompt)}
              >
                {/* å¤´éƒ¨ï¼šæ ‡é¢˜å’Œç±»å‹æ ‡ç­¾ */}
                <div className="flex items-start justify-between gap-3 mb-3">
                  <div className="flex-1 min-w-0">
                    <h3 className="text-base font-medium text-gray-900 truncate mb-1">{prompt.title}</h3>
                    <p className="text-sm text-gray-600 line-clamp-2 h-10">{prompt.description || 'æš‚æ— æè¿°'}</p>
                  </div>
                  {/* æç¤ºè¯ç±»å‹æ ‡ç­¾ï¼ˆå›ºå®šå³ç«¯ï¼‰ */}
                  <span
                    className={`px-2 py-0.5 text-xs font-medium rounded border flex-shrink-0 ${
                      prompt.prompt_type === 'system'
                        ? 'bg-purple-100 text-purple-700 border-purple-200'
                        : 'bg-blue-100 text-blue-700 border-blue-200'
                    }`}
                  >
                    {prompt.prompt_type === 'system' ? 'ç³»ç»Ÿ' : 'ç”¨æˆ·'}
                  </span>
                </div>

                {/* å†…å®¹é¢„è§ˆ */}
                <div className="text-sm text-gray-700 mb-3 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-md border border-gray-200">
                  <div className="line-clamp-2 h-10 font-mono text-xs leading-relaxed">
                    {prompt.final_prompt ? (
                      <>
                        {prompt.final_prompt.slice(0, 150)}
                        {prompt.final_prompt.length > 150 ? '...' : ''}
                      </>
                    ) : (
                      <span className="text-gray-400 italic">æš‚æ— æç¤ºè¯å†…å®¹</span>
                    )}
                  </div>
                </div>

                {/* åº•éƒ¨ï¼šç»Ÿè®¡ä¿¡æ¯å’Œæ“ä½œæŒ‰é’® */}
                <div className="flex items-center justify-between pt-2 border-t border-gray-100">
                  {/* ç»Ÿè®¡ä¿¡æ¯ */}
                  <div className="flex items-center gap-3 text-xs text-gray-500">
                    <span className="flex items-center gap-1">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      {prompt.view_count || 0}
                    </span>
                    <span className="flex items-center gap-1">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      {prompt.use_count || 0}
                    </span>
                    <span className="flex items-center gap-1">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      v{prompt.current_version || '1.0.0'}
                    </span>
                    <span className="text-gray-400">
                      â€¢ {formatDate(prompt.update_time || prompt.create_time)}
                    </span>
                  </div>

                  {/* æ“ä½œæŒ‰é’® */}
                  <div className="flex items-center gap-1">
                    {/* å¤åˆ¶æŒ‰é’® */}
                    <button
                      onClick={(e) => {
                        e.stopPropagation()
                        handleCopyPrompt(prompt)
                      }}
                      className="p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                      title="å¤åˆ¶"
                    >
                      <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>

                    {/* æ›´å¤šæ“ä½œ */}
                    <div className="relative group">
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          setShowActionMenu((prev) => ({
                            ...prev,
                            [prompt.id]: !prev[prompt.id]
                          }))
                        }}
                        className="p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                        title="æ›´å¤šæ“ä½œ"
                      >
                        <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                      </button>

                      {/* ä¸‹æ‹‰èœå• */}
                      {showActionMenu[prompt.id] && (
                        <div
                          onClick={(e) => e.stopPropagation()}
                          className="absolute right-0 top-full mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-10"
                        >
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              handleEditPrompt(prompt)
                            }}
                            className="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 transition-colors flex items-center gap-2"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            ç¼–è¾‘
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              handleOptimizePrompt(prompt)
                            }}
                            className="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 transition-colors flex items-center gap-2"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            ä¼˜åŒ–
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              handleShowVersionHistory(prompt)
                            }}
                            className="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 transition-colors flex items-center gap-2"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            ç‰ˆæœ¬å†å²
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              handleDeletePrompt(prompt)
                            }}
                            className="w-full text-left px-3 py-2 text-sm hover:bg-red-50 text-red-600 transition-colors flex items-center gap-2"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            åˆ é™¤
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* æ ‡ç­¾ - å›ºå®šåœ¨åº•éƒ¨ */}
                <div className="mt-3 pt-2 border-t border-gray-100">
                  <div className="flex flex-wrap gap-1">
                    {Array.isArray(prompt.tags) ? (
                      prompt.tags.map((tag) => (
                        <span key={tag} className="inline-block px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-md">
                          {tag}
                        </span>
                      ))
                    ) : (
                      <span className="text-xs text-gray-400">æš‚æ— æ ‡ç­¾</span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* åˆ†é¡µ */}
        {totalPages > 1 && (
          <div className="flex justify-center items-center gap-2 mt-6">
            <button
              onClick={() => changePage(currentPage - 1)}
              disabled={currentPage <= 1}
              className="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ä¸Šä¸€é¡µ
            </button>

            <span className="text-sm text-gray-600">
              ç¬¬ {currentPage} é¡µï¼Œå…± {totalPages} é¡µ
            </span>

            <button
              onClick={() => changePage(currentPage + 1)}
              disabled={currentPage >= totalPages}
              className="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ä¸‹ä¸€é¡µ
            </button>
          </div>
        )}
      </div>

      {/* æç¤ºè¯è¯¦æƒ…å¼¹çª— */}
      {showDetailModal && selectedPrompt && (
        <PromptDetailModal
          prompt={selectedPrompt}
          onClose={() => setShowDetailModal(false)}
          onEdit={handlePromptUpdated}
          onOptimize={handleOptimizePrompt}
          onRollback={handleVersionRollback}
        />
      )}

      {showVersionHistory && selectedPromptForVersion && (
        <VersionHistoryPanel
          isOpen={showVersionHistory}
          promptId={selectedPromptForVersion.id}
          onClose={() => setShowVersionHistory(false)}
          onRollback={handleVersionRollback}
        />
      )}
    </div>
  )
})

PromptList.displayName = 'PromptList'

export default PromptList

```


## src/components/modules/library/components/VersionDetailModal.tsx

```tsx
import { useState, useEffect } from 'react'
import { X, Edit, BarChart3, MessageSquare, FileText, Tag } from 'lucide-react'
import { VersionService, type VersionInfo } from '@/services/versionService'
import { useNotificationStore } from '@/stores/notificationStore'

interface VersionDetailModalProps {
  version: VersionInfo | null
  promptId: number
  onClose: () => void
  onRollback: (version: VersionInfo) => void
}

export default function VersionDetailModal({
  version,
  promptId,
  onClose,
  onRollback
}: VersionDetailModalProps) {
  const notificationStore = useNotificationStore()

  const [versionDetail, setVersionDetail] = useState<VersionInfo | null>(null)
  const [isLoading, setIsLoading] = useState(false)

  const loadVersionDetail = async () => {
    if (!version) return

    try {
      setIsLoading(true)
      const result = await VersionService.getVersionDetail(promptId, version.id)

      if (result.code === 200) {
        setVersionDetail(result.data)
      } else {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åŠ è½½ç‰ˆæœ¬è¯¦æƒ…å¤±è´¥:', err)
      notificationStore.error(`åŠ è½½å¤±è´¥: ${err.message}`)
    } finally {
      setIsLoading(false)
    }
  }

  useEffect(() => {
    if (version) {
      loadVersionDetail()
    }
  }, [version, promptId])

  const handleRollback = () => {
    if (versionDetail) {
      onRollback(versionDetail)
    }
  }

  const getVersionTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      manual: 'æ‰‹åŠ¨åˆ›å»º',
      auto: 'è‡ªåŠ¨ä¿å­˜',
      rollback: 'å›æ»šåˆ›å»º',
      import: 'å¯¼å…¥åˆ›å»º'
    }
    return labels[type] || type
  }

  const getChangeTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      major: 'ä¸»è¦æ›´æ–°',
      minor: 'æ¬¡è¦æ›´æ–°',
      patch: 'ä¿®è®¢æ›´æ–°'
    }
    return labels[type] || type
  }

  const formatDateTime = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    })
  }

  const formatSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes}B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)}MB`
  }

  const formatConversationHistory = (history: string) => {
    try {
      // å°è¯•è§£æJSONæ ¼å¼çš„å¯¹è¯å†å²
      const parsed = JSON.parse(history)
      if (Array.isArray(parsed)) {
        return parsed
          .map((msg: any, index: number) => `[${index + 1}] ${msg.role}: ${msg.content}`)
          .join('\n\n')
      }
      return history
    } catch {
      // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥è¿”å›åŸå§‹å†…å®¹
      return history
    }
  }

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex items-center justify-between p-6 border-b">
          <h2 className="text-xl font-bold text-gray-900">ç‰ˆæœ¬è¯¦æƒ…</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="å…³é—­">
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-6">
          {isLoading ? (
            <div className="flex items-center justify-center h-32">
              <div className="flex items-center gap-2 text-gray-500">
                <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span>åŠ è½½ä¸­...</span>
              </div>
            </div>
          ) : versionDetail ? (
            <div className="space-y-6">
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-4">v{versionDetail.version_number}</h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">åˆ›å»ºæ—¶é—´ï¼š</span>
                    <span className="text-gray-900">{formatDateTime(versionDetail.create_time)}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">åˆ›å»ºè€…ï¼š</span>
                    <span className="text-gray-900">{versionDetail.author_name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">ç‰ˆæœ¬ç±»å‹ï¼š</span>
                    <span className="text-gray-900">{getVersionTypeLabel(versionDetail.version_type)}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">å˜æ›´ç±»å‹ï¼š</span>
                    <span className="text-gray-900">{getChangeTypeLabel(versionDetail.change_type)}</span>
                  </div>
                </div>
              </div>

              <div className="border-t pt-6">
                <h4 className="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                  <Edit className="w-4 h-4" />
                  å˜æ›´è¯´æ˜
                </h4>
                <p className="text-sm text-gray-700">{versionDetail.change_summary || 'æ— '}</p>
                {versionDetail.change_log && (
                  <div className="mt-3 p-3 bg-gray-50 rounded text-sm text-gray-700 whitespace-pre-wrap">
                    {versionDetail.change_log}
                  </div>
                )}
              </div>

              <div className="border-t pt-6">
                <h4 className="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                  <BarChart3 className="w-4 h-4" />
                  ç»Ÿè®¡ä¿¡æ¯
                </h4>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">å†…å®¹å¤§å°ï¼š</span>
                    <span className="text-gray-900">{formatSize(versionDetail.content_size)}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">ä½¿ç”¨æ¬¡æ•°ï¼š</span>
                    <span className="text-gray-900">{versionDetail.use_count} æ¬¡</span>
                  </div>
                  <div>
                    <span className="text-gray-600">å›æ»šæ¬¡æ•°ï¼š</span>
                    <span className="text-gray-900">{versionDetail.rollback_count} æ¬¡</span>
                  </div>
                </div>
              </div>

              {/* ç”¨æˆ·æç¤ºè¯ä¸Šä¸‹æ–‡ï¼ˆä»…ç”¨æˆ·æç¤ºè¯æ˜¾ç¤ºï¼‰ */}
              {(versionDetail.system_prompt || versionDetail.conversation_history) && (
                <div className="border-t pt-6">
                  <h4 className="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <MessageSquare className="w-4 h-4" />
                    ç”¨æˆ·æç¤ºè¯ä¸Šä¸‹æ–‡
                  </h4>

                  {/* ç³»ç»Ÿæç¤ºè¯ */}
                  {versionDetail.system_prompt && (
                    <div className="mb-4">
                      <h5 className="text-xs font-semibold text-gray-700 mb-2">ç³»ç»Ÿæç¤ºè¯</h5>
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                        <pre className="text-sm text-gray-800 whitespace-pre-wrap font-mono">
                          {versionDetail.system_prompt}
                        </pre>
                      </div>
                    </div>
                  )}

                  {/* å¯¹è¯å†å² */}
                  {versionDetail.conversation_history && (
                    <div className="mb-4">
                      <h5 className="text-xs font-semibold text-gray-700 mb-2">å¯¹è¯å†å²</h5>
                      <div className="bg-green-50 border border-green-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                        <pre className="text-sm text-gray-800 whitespace-pre-wrap font-mono">
                          {formatConversationHistory(versionDetail.conversation_history)}
                        </pre>
                      </div>
                    </div>
                  )}
                </div>
              )}

              <div className="border-t pt-6">
                <h4 className="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <FileText className="w-4 h-4" />
                  {versionDetail.system_prompt || versionDetail.conversation_history ? 'ç”¨æˆ·æç¤ºè¯å†…å®¹' : 'æç¤ºè¯å†…å®¹'}
                </h4>
                <div className="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                  <pre className="text-sm text-gray-800 whitespace-pre-wrap font-mono">
                    {versionDetail.final_prompt || 'æ— å†…å®¹'}
                  </pre>
                </div>
              </div>

              {versionDetail.tags && versionDetail.tags.length > 0 && (
                <div className="border-t pt-6">
                  <h4 className="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <Tag className="w-4 h-4" />
                    æ ‡ç­¾
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {versionDetail.tags.map((tag) => (
                      <span key={tag} className="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ) : null}
        </div>

        <div className="flex justify-end space-x-3 p-6 border-t bg-gray-50">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
          >
            å…³é—­
          </button>
          <button
            onClick={handleRollback}
            className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
          >
            å›æ»šåˆ°æ­¤ç‰ˆæœ¬
          </button>
        </div>
      </div>
    </div>
  )
}

```


## src/components/modules/library/components/VersionHistoryContent.tsx

```tsx
import { useState, useEffect } from 'react'
import { useNotificationStore } from '@/stores/notificationStore'
import { VersionService, type VersionInfo } from '@/services/versionService'
import VersionDetailModal from './VersionDetailModal'

interface VersionHistoryContentProps {
  promptId: number
  onRollback: (versionNumber: string) => void
}

export default function VersionHistoryContent({
  promptId,
  onRollback
}: VersionHistoryContentProps) {
  const notificationStore = useNotificationStore()

  const [versions, setVersions] = useState<VersionInfo[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [showDetailModal, setShowDetailModal] = useState(false)
  const [selectedVersion, setSelectedVersion] = useState<VersionInfo | null>(null)

  const loadVersions = async () => {
    try {
      setIsLoading(true)
      const result = await VersionService.getVersionList(promptId, 1, 10)

      if (result.code === 200) {
        setVersions(result.data.items)
      } else {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥:', err)
      notificationStore.error(`åŠ è½½å¤±è´¥: ${err.message}`)
    } finally {
      setIsLoading(false)
    }
  }

  useEffect(() => {
    loadVersions()
  }, [promptId])

  const handleViewDetail = (version: VersionInfo) => {
    setSelectedVersion(version)
    setShowDetailModal(true)
  }

  const handleRollback = async (version: VersionInfo) => {
    if (!confirm(`ç¡®å®šè¦å›æ»šåˆ°ç‰ˆæœ¬ v${version.version_number} å—ï¼Ÿ`)) {
      return
    }

    try {
      const result = await VersionService.rollbackToVersion(promptId, version.id, {
        change_summary: `å›æ»šåˆ°ç‰ˆæœ¬ ${version.version_number}`
      })

      if (result.code === 200) {
        notificationStore.success(`æˆåŠŸå›æ»šåˆ°ç‰ˆæœ¬ v${version.version_number}`)
        onRollback(version.version_number)
        loadVersions()
        setShowDetailModal(false)
      } else {
        throw new Error(result.message || 'å›æ»šå¤±è´¥')
      }
    } catch (err: any) {
      console.error('å›æ»šå¤±è´¥:', err)
      notificationStore.error(`å›æ»šå¤±è´¥: ${err.message}`)
    }
  }

  const handleDelete = async (version: VersionInfo) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ v${version.version_number} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
      return
    }

    try {
      const result = await VersionService.deleteVersion(promptId, version.id)

      if (result.code === 200) {
        notificationStore.success(`ç‰ˆæœ¬ v${version.version_number} å·²åˆ é™¤`)
        loadVersions()
      } else {
        throw new Error(result.message || 'åˆ é™¤å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åˆ é™¤ç‰ˆæœ¬å¤±è´¥:', err)
      notificationStore.error(`åˆ é™¤å¤±è´¥: ${err.message}`)
    }
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    const now = new Date()
    const diff = now.getTime() - date.getTime()
    const days = Math.floor(diff / (1000 * 60 * 60 * 24))

    if (days === 0) {
      return 'ä»Šå¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    } else if (days === 1) {
      return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    } else if (days < 7) {
      return `${days}å¤©å‰`
    } else {
      return date.toLocaleDateString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
    }
  }

  const formatSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes}B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)}MB`
  }

  return (
    <>
      <div className="h-full flex flex-col">
        {isLoading ? (
          <div className="flex items-center justify-center h-32">
            <div className="flex items-center gap-2 text-gray-500">
              <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              <span>åŠ è½½ä¸­...</span>
            </div>
          </div>
        ) : versions.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-32 text-center">
            <svg className="w-12 h-12 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p className="text-gray-600">æš‚æ— ç‰ˆæœ¬å†å²</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto pr-2">
            {versions.map((version) => (
              <div
                key={version.id}
                onClick={() => handleViewDetail(version)}
                className="border border-gray-200 rounded-md p-2.5 hover:shadow-md transition-shadow cursor-pointer"
              >
                <div className="flex items-start justify-between mb-1.5">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <h4 className="text-sm font-semibold text-gray-900">v{version.version_number}</h4>
                      <span className="text-xs text-gray-500">{formatDate(version.create_time)}</span>
                    </div>
                    <p className="text-xs text-gray-600 line-clamp-1">{version.change_summary || 'ä¼˜åŒ–æç¤ºè¯'}</p>
                  </div>
                </div>

                <div className="flex items-center text-xs text-gray-500 mb-1.5">
                  <span className="flex items-center gap-0.5">
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span className="truncate max-w-[80px]">{version.author_name}</span>
                  </span>
                  <span className="mx-2 text-gray-300">â€¢</span>
                  <span className="flex items-center gap-0.5">
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    {formatSize(version.content_size)}
                  </span>
                </div>

                <div className="flex items-center gap-1.5 pt-1.5 border-t border-gray-100">
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      handleRollback(version)
                    }}
                    className="px-2 py-1 text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 rounded transition-colors flex items-center gap-1"
                  >
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>å›æ»š</span>
                  </button>
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      handleDelete(version)
                    }}
                    className="px-2 py-1 text-xs bg-red-50 hover:bg-red-100 text-red-600 rounded transition-colors flex items-center justify-center"
                    title="åˆ é™¤ç‰ˆæœ¬"
                  >
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {showDetailModal && selectedVersion && (
        <VersionDetailModal
          version={selectedVersion}
          promptId={promptId}
          onClose={() => setShowDetailModal(false)}
          onRollback={handleRollback}
        />
      )}
    </>
  )
}

```


## src/components/modules/library/components/VersionHistoryPanel.tsx

```tsx
import { useState, useEffect } from 'react'
import { Clock, X } from 'lucide-react'
import { useNotificationStore } from '@/stores/notificationStore'
import { VersionService, type VersionInfo } from '@/services/versionService'
import VersionDetailModal from './VersionDetailModal'

interface VersionHistoryPanelProps {
  isOpen: boolean
  promptId: number
  onClose: () => void
  onRollback: (versionNumber: string) => void
}

export default function VersionHistoryPanel({
  isOpen,
  promptId,
  onClose,
  onRollback
}: VersionHistoryPanelProps) {
  const notificationStore = useNotificationStore()

  const [versions, setVersions] = useState<VersionInfo[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [showDetailModal, setShowDetailModal] = useState(false)
  const [selectedVersion, setSelectedVersion] = useState<VersionInfo | null>(null)

  const loadVersions = async () => {
    try {
      setIsLoading(true)
      const result = await VersionService.getVersionList(promptId, 1, 10)

      if (result.code === 200) {
        setVersions(result.data.items)
      } else {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥:', err)
      notificationStore.error(`åŠ è½½å¤±è´¥: ${err.message}`)
    } finally {
      setIsLoading(false)
    }
  }

  useEffect(() => {
    if (isOpen) {
      loadVersions()
    }
  }, [isOpen, promptId])

  const handleViewDetail = (version: VersionInfo) => {
    setSelectedVersion(version)
    setShowDetailModal(true)
  }

  const handleRollback = async (version: VersionInfo) => {
    if (!confirm(`ç¡®å®šè¦å›æ»šåˆ°ç‰ˆæœ¬ v${version.version_number} å—ï¼Ÿ`)) {
      return
    }

    try {
      const result = await VersionService.rollbackToVersion(promptId, version.id, {
        change_summary: `å›æ»šåˆ°ç‰ˆæœ¬ ${version.version_number}`
      })

      if (result.code === 200) {
        notificationStore.success(`æˆåŠŸå›æ»šåˆ°ç‰ˆæœ¬ v${version.version_number}`)
        onRollback(version.version_number)
        loadVersions()
        setShowDetailModal(false)
      } else {
        throw new Error(result.message || 'å›æ»šå¤±è´¥')
      }
    } catch (err: any) {
      console.error('å›æ»šå¤±è´¥:', err)
      notificationStore.error(`å›æ»šå¤±è´¥: ${err.message}`)
    }
  }

  const handleDelete = async (version: VersionInfo) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ v${version.version_number} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
      return
    }

    try {
      const result = await VersionService.deleteVersion(promptId, version.id)

      if (result.code === 200) {
        notificationStore.success(`ç‰ˆæœ¬ v${version.version_number} å·²åˆ é™¤`)
        loadVersions()
      } else {
        throw new Error(result.message || 'åˆ é™¤å¤±è´¥')
      }
    } catch (err: any) {
      console.error('åˆ é™¤ç‰ˆæœ¬å¤±è´¥:', err)
      notificationStore.error(`åˆ é™¤å¤±è´¥: ${err.message}`)
    }
  }

  const handleClose = () => {
    onClose()
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    const now = new Date()
    const diff = now.getTime() - date.getTime()
    const days = Math.floor(diff / (1000 * 60 * 60 * 24))

    if (days === 0) {
      return 'ä»Šå¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    } else if (days === 1) {
      return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    } else if (days < 7) {
      return `${days}å¤©å‰`
    } else {
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
    }
  }

  const formatSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes}B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)}MB`
  }

  if (!isOpen) return null

  return (
    <>
      <div
        className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        onClick={handleClose}
      >
        <div
          className="bg-white rounded-lg max-w-3xl w-full max-h-[85vh] overflow-hidden flex flex-col"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="flex items-center justify-between p-6 border-b">
            <div>
              <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                <Clock className="w-6 h-6" />
                ç‰ˆæœ¬å†å²
              </h2>
              <p className="text-sm text-gray-600 mt-1">å…± {versions.length} ä¸ªç‰ˆæœ¬</p>
            </div>
            <button
              onClick={handleClose}
              className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              title="å…³é—­"
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-6">
            {isLoading ? (
              <div className="flex items-center justify-center h-32">
                <div className="flex items-center gap-2 text-gray-500">
                  <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                  <span>åŠ è½½ä¸­...</span>
                </div>
              </div>
            ) : versions.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-32 text-center">
                <svg className="w-12 h-12 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p className="text-gray-600">æš‚æ— ç‰ˆæœ¬å†å²</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {versions.map((version) => (
                  <div
                    key={version.id}
                    onClick={() => handleViewDetail(version)}
                    className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-2">
                          <h3 className="text-base font-semibold text-gray-900">v{version.version_number}</h3>
                          <span className="text-xs text-gray-500">{formatDate(version.create_time)}</span>
                        </div>
                        <p className="text-sm text-gray-700 line-clamp-2">{version.change_summary || 'æ— å˜æ›´è¯´æ˜'}</p>
                      </div>
                    </div>

                    <div className="flex items-center justify-between text-xs text-gray-500 mb-3">
                      <div className="flex items-center gap-4">
                        <span className="flex items-center gap-1">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                          {version.author_name}
                        </span>
                        <span className="flex items-center gap-1">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                          </svg>
                          {formatSize(version.content_size)}
                        </span>
                      </div>
                    </div>

                    <div className="flex items-center gap-2 pt-3 border-t border-gray-100">
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          handleRollback(version)
                        }}
                        className="flex-1 px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded transition-colors flex items-center justify-center gap-1"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        å›æ»šåˆ°æ­¤ç‰ˆæœ¬
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          handleDelete(version)
                        }}
                        className="px-3 py-1.5 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded transition-colors flex items-center justify-center"
                        title="åˆ é™¤ç‰ˆæœ¬"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {showDetailModal && selectedVersion && (
        <VersionDetailModal
          version={selectedVersion}
          promptId={promptId}
          onClose={() => setShowDetailModal(false)}
          onRollback={handleRollback}
        />
      )}
    </>
  )
}

```


## src/components/modules/optimize/components/ComparisonPanel.tsx

```tsx
// Reactç‰ˆæœ¬çš„ComparisonPanelç»„ä»¶
import { useState, useEffect, useRef, useCallback, useMemo } from 'react'
import { MessageSquare, ArrowLeft, RefreshCw, ArrowUp, FileText } from 'lucide-react'
import { marked } from 'marked'
import { useComparison, type ChatMessage } from '../hooks/useComparison'
import SystemPromptModal from './quick/SystemPromptModal'
import { useProviderStore } from '@/stores/providerStore'

export default function ComparisonPanel() {
  const comparison = useComparison()
  const enabledProviders = useProviderStore((state) => state.enabledProviders)
  const getProviderById = useProviderStore((state) => state.getProviderById)
  const getAvailableModelsByProvider = useProviderStore((state) => state.getAvailableModelsByProvider)

  // å¯¹è¯å®¹å™¨å¼•ç”¨
  const leftChatContainerRef = useRef<HTMLDivElement>(null)
  const rightChatContainerRef = useRef<HTMLDivElement>(null)

  // æœ¬åœ°çŠ¶æ€
  const [comparisonMode, setComparisonMode] = useState<'system' | 'user'>('user')
  const [sharedInput, setSharedInput] = useState('')
  const [leftInput, setLeftInput] = useState('')
  const [rightInput, setRightInput] = useState('')
  const [isFromOptimize, setIsFromOptimize] = useState(false)

  // æ¨¡æ€æ¡†å’Œé€‰æ‹©å™¨çŠ¶æ€
  const [showLeftSystemPromptModal, setShowLeftSystemPromptModal] = useState(false)
  const [showRightSystemPromptModal, setShowRightSystemPromptModal] = useState(false)
  const [showLeftModelSelector, setShowLeftModelSelector] = useState(false)
  const [showRightModelSelector, setShowRightModelSelector] = useState(false)

  // ç³»ç»Ÿæç¤ºè¯å€¼
  const [leftSystemPromptValue, setLeftSystemPromptValue] = useState('')
  const [rightSystemPromptValue, setRightSystemPromptValue] = useState('')

  // æ¨¡å‹é€‰æ‹©
  const [leftProvider, setLeftProvider] = useState('')
  const [leftModel, setLeftModel] = useState('')
  const [rightProvider, setRightProvider] = useState('')
  const [rightModel, setRightModel] = useState('')

  // è®¡ç®—å±æ€§
  const leftMessages = comparisonMode === 'system' 
    ? comparison.state.leftMessages 
    : comparison.state.leftUserMessages
  const rightMessages = comparisonMode === 'system'
    ? comparison.state.rightMessages
    : comparison.state.rightUserMessages

  const isGenerating = comparison.isGenerating
  const isLeftGenerating = comparison.state.isLeftGenerating
  const isRightGenerating = comparison.state.isRightGenerating

  // å¯ç”¨çš„æ¨¡å‹
  const leftAvailableModels = useMemo(() => {
    if (!leftProvider) return []
    return getAvailableModelsByProvider(leftProvider)
  }, [leftProvider, getAvailableModelsByProvider])

  const rightAvailableModels = useMemo(() => {
    if (!rightProvider) return []
    return getAvailableModelsByProvider(rightProvider)
  }, [rightProvider, getAvailableModelsByProvider])

  // æ¨¡å‹æ˜¾ç¤ºæ–‡æœ¬
  const leftModelDisplay = useMemo(() => {
    if (!leftProvider || !leftModel) return 'ä½¿ç”¨å…¨å±€æ¨¡å‹'
    const provider = getProviderById(leftProvider)
    const model = leftAvailableModels.find(m => m.id === leftModel)
    return model ? `${provider?.name} - ${model.name}` : 'ä½¿ç”¨å…¨å±€æ¨¡å‹'
  }, [leftProvider, leftModel, leftAvailableModels, getProviderById])

  const rightModelDisplay = useMemo(() => {
    if (!rightProvider || !rightModel) return 'ä½¿ç”¨å…¨å±€æ¨¡å‹'
    const provider = getProviderById(rightProvider)
    const model = rightAvailableModels.find(m => m.id === rightModel)
    return model ? `${provider?.name} - ${model.name}` : 'ä½¿ç”¨å…¨å±€æ¨¡å‹'
  }, [rightProvider, rightModel, rightAvailableModels, getProviderById])

  // è·å–å®é™…ä½¿ç”¨çš„providerå’Œmodelï¼ˆä¿ç•™ä»¥å¤‡åç”¨ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡å‹ï¼‰
  // const getLeftProviderAndModel = useCallback((): [ProviderConfig | null, ModelConfig | null] => {
  //   if (leftProvider && leftModel) {
  //     const provider = getProviderById(leftProvider)
  //     const model = leftAvailableModels.find(m => m.id === leftModel)
  //     if (provider && model) return [provider, model]
  //   }
  //   return [currentProvider, currentModel]
  // }, [leftProvider, leftModel, leftAvailableModels, getProviderById, currentProvider, currentModel])

  // const getRightProviderAndModel = useCallback((): [ProviderConfig | null, ModelConfig | null] => {
  //   if (rightProvider && rightModel) {
  //     const provider = getProviderById(rightProvider)
  //     const model = rightAvailableModels.find(m => m.id === rightModel)
  //     if (provider && model) return [provider, model]
  //   }
  //   return [currentProvider, currentModel]
  // }, [rightProvider, rightModel, rightAvailableModels, getProviderById, currentProvider, currentModel])

  // ä»localStorageåŠ è½½æ•°æ®
  useEffect(() => {
    // åŠ è½½ä¿å­˜çš„æ¨¡å‹é€‰æ‹©
    try {
      const savedModelConfig = localStorage.getItem('yprompt_comparison_model_config')
      if (savedModelConfig) {
        const modelConfig = JSON.parse(savedModelConfig)
        setLeftProvider(modelConfig.leftProvider || '')
        setLeftModel(modelConfig.leftModel || '')
        setRightProvider(modelConfig.rightProvider || '')
        setRightModel(modelConfig.rightModel || '')
      }
    } catch (e) {
      console.error('åŠ è½½æ¨¡å‹é…ç½®å¤±è´¥:', e)
    }

    // åŠ è½½å¯¹æ¯”æ•°æ®
    try {
      const savedData = localStorage.getItem('yprompt_comparison_data')
      if (savedData) {
        const data = JSON.parse(savedData)
        setIsFromOptimize(true)

        if (data.mode === 'system') {
          setComparisonMode('system')
          comparison.initSystemComparison(data.originalPrompt, data.optimizedPrompt)
        } else if (data.mode === 'user') {
          setComparisonMode('user')
          comparison.initUserComparison(
            data.systemPrompt || '',
            data.originalPrompt,
            data.optimizedPrompt
          )
          setLeftInput(data.originalPrompt)
          setRightInput(data.optimizedPrompt)
        }
      }
    } catch (e) {
      console.error('åŠ è½½å¯¹æ¯”æ•°æ®å¤±è´¥:', e)
    }
  }, [comparison])

  // åŒæ­¥ç³»ç»Ÿæç¤ºè¯
  useEffect(() => {
    if (comparisonMode === 'system') {
      setLeftSystemPromptValue(comparison.state.systemConfig.leftSystemPrompt)
      setRightSystemPromptValue(comparison.state.systemConfig.rightSystemPrompt)
    } else {
      const shared = comparison.state.userConfig.sharedSystemPrompt
      setLeftSystemPromptValue(shared)
      setRightSystemPromptValue(shared)
    }
  }, [
    comparisonMode,
    comparison.state.systemConfig.leftSystemPrompt,
    comparison.state.systemConfig.rightSystemPrompt,
    comparison.state.userConfig.sharedSystemPrompt
  ])

  // ä¿å­˜æ¨¡å‹é…ç½®
  useEffect(() => {
    const modelConfig = {
      leftProvider,
      leftModel,
      rightProvider,
      rightModel
    }
    localStorage.setItem('yprompt_comparison_model_config', JSON.stringify(modelConfig))
  }, [leftProvider, leftModel, rightProvider, rightModel])

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  const scrollToBottom = useCallback((container: HTMLDivElement | null) => {
    if (container) {
      setTimeout(() => {
        container.scrollTop = container.scrollHeight
      }, 0)
    }
  }, [])

  useEffect(() => {
    scrollToBottom(leftChatContainerRef.current)
  }, [leftMessages, isLeftGenerating, scrollToBottom])

  useEffect(() => {
    scrollToBottom(rightChatContainerRef.current)
  }, [rightMessages, isRightGenerating, scrollToBottom])

  // ç³»ç»Ÿæç¤ºè¯æ¨¡å¼ï¼šå‘é€æ¶ˆæ¯
  const handleSendSystemMessage = useCallback(async () => {
    if (!sharedInput.trim()) return
    comparison.setState(prev => ({
      ...prev,
      systemConfig: {
        ...prev.systemConfig,
        sharedUserInput: sharedInput
      }
    }))
    await comparison.sendSystemMessage()
    setSharedInput('')
  }, [sharedInput, comparison])

  // ç”¨æˆ·æç¤ºè¯æ¨¡å¼ï¼šå‘é€å·¦ä¾§æ¶ˆæ¯
  const handleSendLeftMessage = useCallback(async () => {
    if (!leftInput.trim()) return
    comparison.setState(prev => ({
      ...prev,
      userConfig: {
        ...prev.userConfig,
        leftUserPrompt: leftInput
      }
    }))
    await comparison.sendLeftUserMessage()
  }, [leftInput, comparison])

  // ç”¨æˆ·æç¤ºè¯æ¨¡å¼ï¼šå‘é€å³ä¾§æ¶ˆæ¯
  const handleSendRightMessage = useCallback(async () => {
    if (!rightInput.trim()) return
    comparison.setState(prev => ({
      ...prev,
      userConfig: {
        ...prev.userConfig,
        rightUserPrompt: rightInput
      }
    }))
    await comparison.sendRightUserMessage()
  }, [rightInput, comparison])

  // æ¸…ç©ºå¯¹è¯
  const handleClearLeft = () => {
    if (confirm('ç¡®å®šæ¸…ç©ºå·¦ä¾§å¯¹è¯å†å²å—ï¼Ÿ')) {
      comparison.clearHistory('left')
    }
  }

  const handleClearRight = () => {
    if (confirm('ç¡®å®šæ¸…ç©ºå³ä¾§å¯¹è¯å†å²å—ï¼Ÿ')) {
      comparison.clearHistory('right')
    }
  }

  // é‡ç½®
  const handleReset = () => {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰å¯¹è¯å’Œè®¾ç½®ã€‚')) {
      comparison.clearHistory('left')
      comparison.clearHistory('right')
      comparison.setState(prev => ({
        ...prev,
        systemConfig: {
          leftSystemPrompt: '',
          rightSystemPrompt: '',
          sharedUserInput: ''
        },
        userConfig: {
          sharedSystemPrompt: '',
          leftUserPrompt: '',
          rightUserPrompt: ''
        }
      }))
      setSharedInput('')
      setLeftInput('')
      setRightInput('')
      setLeftSystemPromptValue('')
      setRightSystemPromptValue('')
      localStorage.removeItem('yprompt_comparison_data')
      localStorage.removeItem('yprompt_trigger_compare')
    }
  }

  // è¿”å›ä¼˜åŒ–é¡µé¢
  const handleBack = () => {
    localStorage.removeItem('yprompt_trigger_compare')
    const mode = comparisonMode === 'system' ? 'system' : 'user'
    localStorage.setItem('yprompt_optimize_active_mode', mode)
    localStorage.setItem('yprompt_back_to_optimize', 'true')
  }

  // ç³»ç»Ÿæç¤ºè¯ä¿å­˜å¤„ç†
  const handleSaveLeftSystemPrompt = () => {
    comparison.setState(prev => {
      if (comparisonMode === 'system') {
        return {
          ...prev,
          systemConfig: {
            ...prev.systemConfig,
            leftSystemPrompt: leftSystemPromptValue
          }
        }
      } else {
        return {
          ...prev,
          userConfig: {
            ...prev.userConfig,
            sharedSystemPrompt: leftSystemPromptValue
          }
        }
      }
    })
  }

  const handleSaveRightSystemPrompt = () => {
    comparison.setState(prev => {
      if (comparisonMode === 'system') {
        return {
          ...prev,
          systemConfig: {
            ...prev.systemConfig,
            rightSystemPrompt: rightSystemPromptValue
          }
        }
      } else {
        return {
          ...prev,
          userConfig: {
            ...prev.userConfig,
            sharedSystemPrompt: rightSystemPromptValue
          }
        }
      }
    })
  }

  // é”®ç›˜äº‹ä»¶å¤„ç†
  const handleSharedKeydown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      if (sharedInput.trim() && !isGenerating) {
        handleSendSystemMessage()
      }
    }
  }

  const handleLeftKeydown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      if (leftInput.trim() && !isLeftGenerating) {
        handleSendLeftMessage()
      }
    }
  }

  const handleRightKeydown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      if (rightInput.trim() && !isRightGenerating) {
        handleSendRightMessage()
      }
    }
  }

  // Markdownæ¸²æŸ“
  const renderMarkdown = (content: string): string => {
    try {
      return marked(content) as string
    } catch (e) {
      console.error('Markdownæ¸²æŸ“å¤±è´¥:', e)
      return content
    }
  }

  // æ¸²æŸ“æ¶ˆæ¯
  const renderMessage = (msg: ChatMessage) => {
    const isUser = msg.role === 'user'
    return (
      <div key={msg.id} className={`flex group ${isUser ? 'justify-end' : 'justify-start'}`}>
        <div className="flex flex-col w-full max-w-xs lg:max-w-md">
          <div
            className={`${
              isUser
                ? 'bg-blue-500 text-white px-4 py-3 rounded-lg ml-auto'
                : 'bg-gray-100 text-gray-800 px-4 py-3 rounded-lg mr-auto'
            } transition-all duration-300 relative`}
          >
            {isUser ? (
              <div className="whitespace-pre-wrap">
                {msg.content}
                {msg.isStreaming && <span className="animate-pulse">â–‹</span>}
              </div>
            ) : (
              <div
                className="prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"
                dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.content) }}
              />
            )}
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="h-full min-h-0 overflow-hidden flex flex-col">
      {/* ä¸Šéƒ¨ï¼šä¸¤ä¸ªå¯¹è¯çª—å£ */}
      <div className="flex-1 min-h-0 grid grid-cols-2 gap-4 mb-4">
        {/* å·¦ä¾§ï¼šä¼˜åŒ–å‰ */}
        <div className="flex flex-col bg-white rounded-lg shadow-sm overflow-hidden">
          {/* å¤´éƒ¨ */}
          <div className="p-4 border-b border-gray-200 flex-shrink-0">
            <div className="flex justify-between items-center">
              <div className="flex items-center space-x-2">
                <h4 className="font-semibold text-gray-800">ä¼˜åŒ–å‰</h4>
                <button
                  onClick={() => setShowLeftSystemPromptModal(true)}
                  className={`flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm ${
                    comparisonMode === 'system'
                      ? comparison.state.systemConfig.leftSystemPrompt.trim()
                      : comparison.state.userConfig.sharedSystemPrompt.trim()
                        ? 'text-green-600'
                        : 'text-gray-400'
                  }`}
                  title="è®¾ç½®ç³»ç»Ÿæç¤ºè¯"
                >
                  <FileText className="w-4 h-4" />
                </button>
                <button
                  onClick={() => setShowLeftModelSelector(!showLeftModelSelector)}
                  className={`p-1 hover:bg-gray-100 rounded transition-colors ${
                    leftModel ? 'text-green-600' : 'text-gray-600'
                  }`}
                  title={leftModelDisplay}
                >
                  <svg className="w-4 h-4 hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"/>
                  </svg>
                </button>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={handleReset}
                  className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                  title="é‡ç½®æ‰€æœ‰æ•°æ®"
                >
                  <RefreshCw className="w-4 h-4" />
                  <span>é‡ç½®</span>
                </button>
                <button
                  onClick={handleClearLeft}
                  className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                  title="æ¸…ç©ºå¯¹è¯"
                >
                  <RefreshCw className="w-4 h-4" />
                  <span>æ¸…ç©º</span>
                </button>
              </div>
            </div>
          </div>

          {/* æ¨¡å‹é€‰æ‹©å™¨ - å·¦ä¾§ */}
          {showLeftModelSelector && (
            <div className="px-4 pb-2 border-b border-gray-200 bg-gray-50">
              <div className="py-2 space-y-2">
                <div className="flex items-center justify-between">
                  <label className="text-sm font-medium text-gray-700">é€‰æ‹©AIæ¨¡å‹</label>
                  {leftProvider && (
                    <button
                      onClick={() => {
                        setLeftProvider('')
                        setLeftModel('')
                      }}
                      className="px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                      title="é‡ç½®ä¸ºå…¨å±€æ¨¡å‹"
                    >
                      é‡ç½®
                    </button>
                  )}
                </div>
                <div className="flex flex-col gap-2">
                  <select
                    value={leftProvider}
                    onChange={(e) => {
                      setLeftProvider(e.target.value)
                      setLeftModel('')
                    }}
                    className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">ä½¿ç”¨å…¨å±€æ¨¡å‹</option>
                    {enabledProviders.map((provider) => (
                      <option key={provider.id} value={provider.id}>
                        {provider.name}
                      </option>
                    ))}
                  </select>
                  <select
                    value={leftModel}
                    onChange={(e) => setLeftModel(e.target.value)}
                    disabled={!leftProvider}
                    className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"
                  >
                    <option value="">é€‰æ‹©æ¨¡å‹</option>
                    {leftAvailableModels.map((model) => (
                      <option key={model.id} value={model.id}>
                        {model.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="text-xs text-gray-500">
                  {!leftProvider ? (
                    <span>å½“å‰: è·Ÿéšå…¨å±€æ¨¡å‹è®¾ç½®</span>
                  ) : !leftModel ? (
                    <span>è¯·é€‰æ‹©æ¨¡å‹</span>
                  ) : (
                    <span>å½“å‰: {leftModelDisplay}</span>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="flex-1 flex flex-col min-h-0">
            {/* å¯¹è¯å†å² */}
            <div ref={leftChatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
              {leftMessages.length === 0 ? (
                <div className="flex items-center justify-center h-full text-gray-400">
                  <div className="text-center">
                    <MessageSquare className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— å¯¹è¯</p>
                  </div>
                </div>
              ) : (
                leftMessages.map(renderMessage)
              )}
            </div>

            {/* ç”¨æˆ·æ¨¡å¼ï¼šç‹¬ç«‹è¾“å…¥æ¡† */}
            {comparisonMode === 'user' && (
              <div className="p-3 border-t border-gray-200">
                <div className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden" style={{ height: '120px' }}>
                  <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
                    <textarea
                      value={leftInput}
                      onChange={(e) => setLeftInput(e.target.value)}
                      onKeyDown={handleLeftKeydown}
                      placeholder="Shift+Enteræ¢è¡Œ"
                      className="w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent"
                      disabled={isLeftGenerating}
                      rows={1}
                    />
                  </div>
                  <div className="absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none">
                    <div className="w-8 h-8"></div>
                    <button
                      onClick={handleSendLeftMessage}
                      disabled={!leftInput.trim() || isLeftGenerating}
                      className="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"
                    >
                      <ArrowUp className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* å³ä¾§ï¼šä¼˜åŒ–å */}
        <div className="flex flex-col bg-white rounded-lg shadow-sm overflow-hidden">
          {/* å¤´éƒ¨ */}
          <div className="p-4 border-b border-gray-200 flex-shrink-0">
            <div className="flex justify-between items-center">
              <div className="flex items-center space-x-2">
                <h4 className="font-semibold text-gray-800">ä¼˜åŒ–å</h4>
                <button
                  onClick={() => setShowRightSystemPromptModal(true)}
                  className={`flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm ${
                    comparisonMode === 'system'
                      ? comparison.state.systemConfig.rightSystemPrompt.trim()
                      : comparison.state.userConfig.sharedSystemPrompt.trim()
                        ? 'text-green-600'
                        : 'text-gray-400'
                  }`}
                  title="è®¾ç½®ç³»ç»Ÿæç¤ºè¯"
                >
                  <FileText className="w-4 h-4" />
                </button>
                <button
                  onClick={() => setShowRightModelSelector(!showRightModelSelector)}
                  className={`p-1 hover:bg-gray-100 rounded transition-colors ${
                    rightModel ? 'text-green-600' : 'text-gray-600'
                  }`}
                  title={rightModelDisplay}
                >
                  <svg className="w-4 h-4 hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"/>
                  </svg>
                </button>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={handleClearRight}
                  className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                  title="æ¸…ç©ºå¯¹è¯"
                >
                  <RefreshCw className="w-4 h-4" />
                  <span>æ¸…ç©º</span>
                </button>
                {isFromOptimize && (
                  <button
                    onClick={handleBack}
                    className="flex items-center gap-1 px-3 py-1 text-sm bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors"
                    title="è¿”å›ä¼˜åŒ–é¡µé¢"
                  >
                    <ArrowLeft className="w-4 h-4" />
                    <span>è¿”å›</span>
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* æ¨¡å‹é€‰æ‹©å™¨ - å³ä¾§ */}
          {showRightModelSelector && (
            <div className="px-4 pb-2 border-b border-gray-200 bg-gray-50">
              <div className="py-2 space-y-2">
                <div className="flex items-center justify-between">
                  <label className="text-sm font-medium text-gray-700">é€‰æ‹©AIæ¨¡å‹</label>
                  {rightProvider && (
                    <button
                      onClick={() => {
                        setRightProvider('')
                        setRightModel('')
                      }}
                      className="px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                      title="é‡ç½®ä¸ºå…¨å±€æ¨¡å‹"
                    >
                      é‡ç½®
                    </button>
                  )}
                </div>
                <div className="flex flex-col gap-2">
                  <select
                    value={rightProvider}
                    onChange={(e) => {
                      setRightProvider(e.target.value)
                      setRightModel('')
                    }}
                    className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">ä½¿ç”¨å…¨å±€æ¨¡å‹</option>
                    {enabledProviders.map((provider) => (
                      <option key={provider.id} value={provider.id}>
                        {provider.name}
                      </option>
                    ))}
                  </select>
                  <select
                    value={rightModel}
                    onChange={(e) => setRightModel(e.target.value)}
                    disabled={!rightProvider}
                    className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"
                  >
                    <option value="">é€‰æ‹©æ¨¡å‹</option>
                    {rightAvailableModels.map((model) => (
                      <option key={model.id} value={model.id}>
                        {model.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="text-xs text-gray-500">
                  {!rightProvider ? (
                    <span>å½“å‰: è·Ÿéšå…¨å±€æ¨¡å‹è®¾ç½®</span>
                  ) : !rightModel ? (
                    <span>è¯·é€‰æ‹©æ¨¡å‹</span>
                  ) : (
                    <span>å½“å‰: {rightModelDisplay}</span>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="flex-1 flex flex-col min-h-0">
            {/* å¯¹è¯å†å² */}
            <div ref={rightChatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
              {rightMessages.length === 0 ? (
                <div className="flex items-center justify-center h-full text-gray-400">
                  <div className="text-center">
                    <MessageSquare className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— å¯¹è¯</p>
                  </div>
                </div>
              ) : (
                rightMessages.map(renderMessage)
              )}
            </div>

            {/* ç”¨æˆ·æ¨¡å¼ï¼šç‹¬ç«‹è¾“å…¥æ¡† */}
            {comparisonMode === 'user' && (
              <div className="p-3 border-t border-gray-200">
                <div className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden" style={{ height: '120px' }}>
                  <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
                    <textarea
                      value={rightInput}
                      onChange={(e) => setRightInput(e.target.value)}
                      onKeyDown={handleRightKeydown}
                      placeholder="Shift+Enteræ¢è¡Œ"
                      className="w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent"
                      disabled={isRightGenerating}
                      rows={1}
                    />
                  </div>
                  <div className="absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none">
                    <div className="w-8 h-8"></div>
                    <button
                      onClick={handleSendRightMessage}
                      disabled={!rightInput.trim() || isRightGenerating}
                      className="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"
                    >
                      <ArrowUp className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ä¸‹éƒ¨ï¼šè¾“å…¥æ¡†åŒºåŸŸ - ç³»ç»Ÿæ¨¡å¼å…±ç”¨è¾“å…¥æ¡† */}
      {comparisonMode === 'system' && (
        <div className="flex-shrink-0">
          <div className="bg-white rounded-lg shadow-md border border-gray-200 p-3">
            <div className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden" style={{ height: '120px' }}>
              <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
                <textarea
                  value={sharedInput}
                  onChange={(e) => setSharedInput(e.target.value)}
                  onKeyDown={handleSharedKeydown}
                  placeholder="Shift+Enteræ¢è¡Œ"
                  className="w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent"
                  disabled={isGenerating}
                  rows={1}
                />
              </div>
              <div className="absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none">
                <div className="w-8 h-8"></div>
                <button
                  onClick={handleSendSystemMessage}
                  disabled={!sharedInput.trim() || isGenerating}
                  className="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"
                  title="åŒæ—¶å‘é€åˆ°ä¸¤ä¾§"
                >
                  <ArrowUp className="w-4 h-4" />
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ç³»ç»Ÿæç¤ºè¯æ¨¡æ€æ¡† - å·¦ä¾§ */}
      {showLeftSystemPromptModal && (
        <SystemPromptModal
          isOpen={showLeftSystemPromptModal}
          modelValue={leftSystemPromptValue}
          onUpdateModelValue={setLeftSystemPromptValue}
          onClose={() => setShowLeftSystemPromptModal(false)}
          onSave={handleSaveLeftSystemPrompt}
        />
      )}

      {/* ç³»ç»Ÿæç¤ºè¯æ¨¡æ€æ¡† - å³ä¾§ */}
      {showRightSystemPromptModal && (
        <SystemPromptModal
          isOpen={showRightSystemPromptModal}
          modelValue={rightSystemPromptValue}
          onUpdateModelValue={setRightSystemPromptValue}
          onClose={() => setShowRightSystemPromptModal(false)}
          onSave={handleSaveRightSystemPrompt}
        />
      )}
    </div>
  )
}

```


## src/components/modules/optimize/components/ConversationMessage.tsx

```tsx
import { useState } from 'react'
import { Message } from '@/types/optimize'
import { Edit2, Trash2 } from 'lucide-react'

interface Props {
  message: Message
  index: number
  editingIndex: number | null
  editingContent: string
  onEditMessage: (index: number) => void
  onSaveEdit: (index: number) => void
  onCancelEdit: () => void
  onRemoveMessage: (index: number) => void
  onUpdateEditingContent: (content: string) => void
}

export default function ConversationMessage({
  message,
  index,
  editingIndex,
  editingContent,
  onEditMessage,
  onSaveEdit,
  onCancelEdit,
  onRemoveMessage,
  onUpdateEditingContent
}: Props) {
  const getRoleIcon = () => {
    const icons = {
      user: 'U',
      assistant: 'A',
      system: 'S'
    }
    return icons[message.role] || '?'
  }

  const isEditing = editingIndex === index
  const isUser = message.role === 'user'
  const isAssistant = message.role === 'assistant'

  return (
    <div className={`flex mb-4 group ${isUser ? 'justify-end' : 'justify-start'}`}>
      {/* å¤´åƒ */}
      <div
        className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium flex-shrink-0 ${
          isUser
            ? 'bg-blue-500 text-white ml-2 order-2'
            : isAssistant
            ? 'bg-green-500 text-white mr-2 order-1'
            : 'bg-purple-500 text-white mr-2 order-1'
        }`}
      >
        {getRoleIcon()}
      </div>

      {/* æ¶ˆæ¯å†…å®¹ */}
      <div
        className={`max-w-xs lg:max-w-md px-4 py-3 rounded-lg relative ${
          isUser
            ? 'bg-blue-500 text-white order-1'
            : isAssistant
            ? 'bg-green-100 text-gray-800 border border-green-200 order-2'
            : 'bg-purple-100 text-gray-800 border border-purple-200 order-2'
        }`}
      >
        {/* ç¼–è¾‘æ¨¡å¼ */}
        {isEditing ? (
          <div className="space-y-2">
            <textarea
              value={editingContent}
              onChange={(e) => onUpdateEditingContent(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded text-sm resize-none bg-white text-gray-800"
              rows={3}
              placeholder="ç¼–è¾‘æ¶ˆæ¯å†…å®¹..."
            />
            <div className="flex justify-end space-x-2">
              <button
                onClick={onCancelEdit}
                className="px-2 py-1 text-xs text-gray-600 hover:text-gray-800 bg-gray-100 rounded"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={() => onSaveEdit(index)}
                className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                ä¿å­˜
              </button>
            </div>
          </div>
        ) : (
          /* æ˜¾ç¤ºæ¨¡å¼ */
          <div>
            <div className="text-sm whitespace-pre-wrap leading-relaxed">
              {message.content}
            </div>

            {/* ç¼–è¾‘æŒ‰é’® */}
            {message.role !== 'system' && (
              <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button
                  onClick={() => onEditMessage(index)}
                  className={`p-1 text-xs hover:bg-white hover:bg-opacity-20 rounded transition-colors ${
                    isUser ? 'text-blue-100' : 'text-gray-600'
                  }`}
                >
                  <Edit2 className="w-3 h-3" />
                </button>
              </div>
            )}
          </div>
        )}
      </div>

      {/* åˆ é™¤æŒ‰é’® */}
      {message.role !== 'system' && !isEditing && (
        <div
          className={`flex items-center opacity-0 group-hover:opacity-100 transition-opacity ${
            isUser ? 'order-3 ml-2' : 'order-0 mr-2'
          }`}
        >
          <button
            onClick={() => onRemoveMessage(index)}
            className="p-1 text-xs text-red-500 hover:bg-red-50 rounded transition-colors"
          >
            <Trash2 className="w-4 h-4" />
          </button>
        </div>
      )}
    </div>
  )
}
```


## src/components/modules/optimize/components/DiffViewer.tsx

```tsx
import { X } from 'lucide-react'

interface DiffViewerProps {
  leftContent: string
  rightContent: string
  leftLabel: string
  rightLabel: string
  onClose: () => void
}

export default function DiffViewer({
  leftContent,
  rightContent,
  leftLabel,
  rightLabel,
  onClose
}: DiffViewerProps) {
  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between p-4 border-b">
        <h3 className="text-lg font-semibold text-gray-800">å¯¹æ¯”æŸ¥çœ‹</h3>
        <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
          <X className="w-5 h-5" />
        </button>
      </div>
      <div className="flex-1 grid grid-cols-2 gap-4 p-4 overflow-auto">
        <div className="flex flex-col">
          <div className="mb-2 text-sm font-medium text-gray-700">{leftLabel}</div>
          <pre className="flex-1 p-4 bg-gray-50 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap overflow-auto">
            {leftContent}
          </pre>
        </div>
        <div className="flex flex-col">
          <div className="mb-2 text-sm font-medium text-gray-700">{rightLabel}</div>
          <pre className="flex-1 p-4 bg-gray-50 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap overflow-auto">
            {rightContent}
          </pre>
        </div>
      </div>
    </div>
  )
}

```


## src/components/modules/optimize/components/OptimizeSectionRedesign.tsx

```tsx
import { useState, useEffect, useMemo } from 'react'
import { RefreshCw } from 'lucide-react'
import { useOptimizeStore } from '@/stores/optimizeStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { copyToClipboard } from '@/utils/clipboardUtils'
import { useOptimizeModule } from '@/hooks/useOptimizeModule'
import TabContainer from '@/components/preview/components/common/TabContainer'
import TabButton from '@/components/preview/components/common/TabButton'
import EmptyState from '@/components/preview/components/common/EmptyState'
import AdviceTab from '@/components/preview/components/tabs/AdviceTab'
import FinalTab from '@/components/preview/components/tabs/FinalTab'
import ComparisonPanel from './ComparisonPanel'
import UserPromptQuickOptimize from './quick/UserPromptQuickOptimize'
import SavePromptDialog from '@/components/preview/components/dialogs/SavePromptDialog'
import { post } from '@/services/apiService'
import type { Suggestion } from '@/stores/optimizeStore'

interface OptimizeSectionRedesignProps {
  activeMode: 'system' | 'user' | 'compare'
  onUpdateActiveMode: (mode: 'system' | 'user' | 'compare') => void
}

// localStorage keys
const OPTIMIZE_CACHE_KEY = 'yprompt_optimize_cache'

interface OptimizeCache {
  originalSystemPrompt: string
  optimizedSystemPrompt: string | { zh: string; en: string }
  systemAnalysisResult: any
  systemSuggestions: Suggestion[]
  systemOptimizationStage: number
  activeOptimizeTab: 'analysis' | 'advice' | 'final'
  analysisStreamingText: string
  formatState?: 'markdown' | 'xml'
  languageState?: 'zh' | 'en'
  currentPromptId?: number | null
  currentPromptTitle?: string
}

export default function OptimizeSectionRedesign({
  activeMode,
  onUpdateActiveMode: _onUpdateActiveMode
}: OptimizeSectionRedesignProps) {
  const optimizeStore = useOptimizeStore()
  const notificationStore = useNotificationStore()
  const { analyzePrompt, generateOptimizationAdvice, applyOptimizationAdvice } = useOptimizeModule()

  // è‡ªåŠ¨/æ‰‹åŠ¨æ¨¡å¼
  const [isAutoMode, setIsAutoMode] = useState(true)

  // åŠ è½½ç¼“å­˜
  const loadCache = (): OptimizeCache | null => {
    try {
      const cached = localStorage.getItem(OPTIMIZE_CACHE_KEY)
      return cached ? JSON.parse(cached) : null
    } catch {
      return null
    }
  }

  // ä¿å­˜ç¼“å­˜
  const saveCache = (cache: Partial<OptimizeCache>) => {
    try {
      const current = loadCache() || ({} as OptimizeCache)
      const updated = { ...current, ...cache }
      localStorage.setItem(OPTIMIZE_CACHE_KEY, JSON.stringify(updated))
    } catch (e) {
      console.error('Failed to save optimize cache:', e)
    }
  }

  const cache = loadCache()

  const [localSystemPrompt, setLocalSystemPrompt] = useState(
    cache?.originalSystemPrompt || optimizeStore.systemPrompt || ''
  )
  const [originalSystemPrompt, setOriginalSystemPrompt] = useState(cache?.originalSystemPrompt || '')
  const [optimizedSystemPrompt, setOptimizedSystemPrompt] = useState<string | { zh: string; en: string }>(
    cache?.optimizedSystemPrompt || ''
  )
  const [systemSuggestions, setSystemSuggestions] = useState<Suggestion[]>(cache?.systemSuggestions || [])
  const [isGeneratingSystem, setIsGeneratingSystem] = useState(false)
  const [systemAnalysisResult, setSystemAnalysisResult] = useState<any>(cache?.systemAnalysisResult || null)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [analysisStreamingText, setAnalysisStreamingText] = useState(cache?.analysisStreamingText || '')
  const [systemOptimizationStage, setSystemOptimizationStage] = useState(cache?.systemOptimizationStage || 0)
  const [activeOptimizeTab, setActiveOptimizeTab] = useState<'analysis' | 'advice' | 'final'>(
    cache?.activeOptimizeTab || 'analysis'
  )
  const [isCopiedAdvice, setIsCopiedAdvice] = useState(false)
  const [isCopiedFinal, setIsCopiedFinal] = useState(false)
  const [isConvertingFormat, setIsConvertingFormat] = useState(false)
  const [isConvertingLanguage, setIsConvertingLanguage] = useState(false)
  const [formatState, setFormatState] = useState<'markdown' | 'xml'>(cache?.formatState || 'markdown')
  const [languageState, setLanguageState] = useState<'zh' | 'en'>(cache?.languageState || 'zh')
  const [isSaving, setIsSaving] = useState(false)
  const [showSaveDialog, setShowSaveDialog] = useState(false)

  // åŒæ­¥ store ä¸­çš„ systemPrompt
  useEffect(() => {
    if (optimizeStore.systemPrompt && !localSystemPrompt) {
      setLocalSystemPrompt(optimizeStore.systemPrompt)
      setOriginalSystemPrompt(optimizeStore.systemPrompt)
    }
  }, [optimizeStore.systemPrompt])

  // ç›‘å¬ä¼˜åŒ–å»ºè®®ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å»ºè®®tab
  useEffect(() => {
    if (systemSuggestions.length > 0 && systemOptimizationStage >= 2 && activeOptimizeTab === 'analysis') {
      // å»¶è¿Ÿ500msåˆ‡æ¢ï¼Œç»™ç”¨æˆ·æ—¶é—´çœ‹åˆ†æç»“æœ
      const timer = setTimeout(() => {
        setActiveOptimizeTab('advice')
      }, 500)
      return () => clearTimeout(timer)
    }
  }, [systemSuggestions, systemOptimizationStage])

  // å°†å»ºè®®è½¬æ¢ä¸ºæ–‡æœ¬æ•°ç»„æ ¼å¼ä»¥é€‚é…AdviceTab
  const optimizeSuggestionsText = useMemo(
    () => systemSuggestions.map((s) => s.description),
    [systemSuggestions]
  )

  // å½“å‰æ˜¾ç¤ºçš„ä¼˜åŒ–åæç¤ºè¯ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œå¯¹è±¡æ ¼å¼ï¼‰
  const currentOptimizedSystemPrompt = useMemo(() => {
    if (typeof optimizedSystemPrompt === 'string') {
      return optimizedSystemPrompt
    }
    return languageState === 'zh' ? optimizedSystemPrompt.zh : optimizedSystemPrompt.en
  }, [optimizedSystemPrompt, languageState])

  const setCurrentOptimizedSystemPrompt = (value: string) => {
    if (typeof optimizedSystemPrompt === 'string') {
      setOptimizedSystemPrompt(value)
    } else if (languageState === 'zh') {
      setOptimizedSystemPrompt({ ...optimizedSystemPrompt, zh: value })
    } else {
      setOptimizedSystemPrompt({ ...optimizedSystemPrompt, en: value })
    }
  }

  // å¤„ç†ç³»ç»Ÿæç¤ºè¯é‡æ–°å¼€å§‹
  const handleSystemRestart = () => {
    if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰ä¼˜åŒ–è¿›åº¦å°†è¢«æ¸…é™¤ã€‚')) {
      setLocalSystemPrompt('')
      setOriginalSystemPrompt('')
      setOptimizedSystemPrompt('')
      setSystemSuggestions([])
      setSystemAnalysisResult(null)
      setSystemOptimizationStage(0)
      setActiveOptimizeTab('analysis')
      setAnalysisStreamingText('')
      setFormatState('markdown')
      setLanguageState('zh')
      setIsConvertingLanguage(false)
      setIsConvertingFormat(false)
      setIsCopiedAdvice(false)
      setIsCopiedFinal(false)
      optimizeStore.resetOptimization()
      localStorage.removeItem(OPTIMIZE_CACHE_KEY)
      notificationStore.success('å·²é‡ç½®æ‰€æœ‰æ•°æ®')
    }
  }

  // å¤„ç†ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–
  const handleSystemOptimize = async () => {
    if (!localSystemPrompt?.trim()) return

    setOriginalSystemPrompt(localSystemPrompt)
    setIsGeneratingSystem(true)
    setSystemOptimizationStage(0)
    setAnalysisStreamingText('')

    // é‡ç½®æ ¼å¼å’Œè¯­è¨€çŠ¶æ€ä¸ºé»˜è®¤å€¼ï¼ˆå¼€å§‹æ–°çš„ä¼˜åŒ–ï¼‰
    setFormatState('markdown')
    setLanguageState('zh')

    // ä¿å­˜åŸå§‹æç¤ºè¯å’Œé‡ç½®çŠ¶æ€åˆ°ç¼“å­˜
    saveCache({
      originalSystemPrompt: localSystemPrompt,
      formatState: 'markdown',
      languageState: 'zh'
    })

    try {
      // é˜¶æ®µ1: è´¨é‡åˆ†æ
      setSystemOptimizationStage(1)
      saveCache({ systemOptimizationStage: 1 })
      setIsAnalyzing(true)

      let fullAnalysisText = ''
      const analysisResult = await analyzePrompt(localSystemPrompt, 'system', (chunk: string) => {
        fullAnalysisText = chunk
        setAnalysisStreamingText(chunk)
      })

      setSystemAnalysisResult(analysisResult)
      setIsAnalyzing(false)

      // ä¿å­˜åˆ†æç»“æœåˆ°ç¼“å­˜
      saveCache({
        systemAnalysisResult: analysisResult,
        analysisStreamingText: fullAnalysisText
      })

      // é˜¶æ®µ2: ç”Ÿæˆä¼˜åŒ–å»ºè®®
      setSystemOptimizationStage(2)
      saveCache({ systemOptimizationStage: 2 })

      // åˆå§‹åŒ–æµå¼æ›´æ–°
      let adviceStreamContent = ''
      let adviceInitialized = false

      const adviceList = await generateOptimizationAdvice(
        localSystemPrompt,
        'system',
        (chunk: string) => {
          adviceStreamContent += chunk

          // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶åˆå§‹åŒ–
          if (!adviceInitialized && chunk.trim()) {
            adviceInitialized = true
            setSystemSuggestions([
              {
                id: 'temp',
                type: 'modify' as const,
                category: 'role' as const,
                title: 'æ­£åœ¨ç”Ÿæˆ...',
                description: 'æ­£åœ¨ç”Ÿæˆ...',
                reason: '',
                expectedEffect: '',
                priority: 'medium' as const
              }
            ])
          }

          // å®æ—¶è§£æå¹¶æ›´æ–°å»ºè®®åˆ—è¡¨
          const suggestions = adviceStreamContent
            .split('\n')
            .map((s) => s.replace(/^[*-]\s*/, '').trim())
            .filter(Boolean)

          if (suggestions.length > 0) {
            setSystemSuggestions(
              suggestions.map((desc, idx) => ({
                id: `sys_${idx}`,
                type: 'modify' as const,
                category: 'role' as const,
                title: desc.substring(0, 50),
                description: desc,
                reason: '',
                expectedEffect: '',
                priority: 'medium' as const
              }))
            )
          }
        }
      )

      // å°†å»ºè®®æ–‡æœ¬è½¬æ¢ä¸ºSuggestionå¯¹è±¡
      setSystemSuggestions(
        adviceList.map((advice, index) => ({
          id: `sys_${index}`,
          type: 'modify' as const,
          category: 'role' as const,
          title: advice.substring(0, 50),
          description: advice,
          reason: '',
          expectedEffect: '',
          priority: 'medium' as const
        }))
      )

      // ä¿å­˜å»ºè®®åˆ°ç¼“å­˜
      saveCache({ systemSuggestions: systemSuggestions })

      // å¦‚æœæ˜¯è‡ªåŠ¨æ¨¡å¼,ç»§ç»­ç”Ÿæˆæœ€ç»ˆä¼˜åŒ–ç»“æœ
      if (isAutoMode) {
        setSystemOptimizationStage(3)
        saveCache({ systemOptimizationStage: 3 })

        // é‡ç½®æ ¼å¼å’Œè¯­è¨€çŠ¶æ€ä¸ºé»˜è®¤å€¼ï¼ˆå› ä¸ºç”Ÿæˆæ€»æ˜¯è¿”å›markdown/zhï¼‰
        setFormatState('markdown')
        setLanguageState('zh')

        // ä¿å­˜çŠ¶æ€é‡ç½®åˆ°ç¼“å­˜
        saveCache({
          formatState: 'markdown',
          languageState: 'zh'
        })

        // åˆå§‹åŒ–æµå¼æ›´æ–°
        let optimizedInitialized = false

        const optimizedPrompt = await applyOptimizationAdvice(
          localSystemPrompt,
          adviceList,
          'system',
          (chunk: string) => {
            // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶åˆå§‹åŒ–
            if (!optimizedInitialized && chunk.trim()) {
              optimizedInitialized = true
              setOptimizedSystemPrompt('æ­£åœ¨ç”Ÿæˆ...')
            }

            // è¿½åŠ å†…å®¹
            if (optimizedInitialized) {
              setOptimizedSystemPrompt((prev) => {
                if (prev === 'æ­£åœ¨ç”Ÿæˆ...' || typeof prev === 'string') {
                  return prev === 'æ­£åœ¨ç”Ÿæˆ...' ? chunk : prev + chunk
                }
                return { ...prev, zh: prev.zh + chunk }
              })
            }
          }
        )

        setOptimizedSystemPrompt(optimizedPrompt)
        optimizeStore.setOptimizedPrompts(optimizedPrompt, '')

        // ä¿å­˜ä¼˜åŒ–ç»“æœåˆ°ç¼“å­˜
        saveCache({
          optimizedSystemPrompt: optimizedPrompt,
          activeOptimizeTab: 'final'
        })
        setActiveOptimizeTab('final')
      } else {
        // æ‰‹åŠ¨æ¨¡å¼ï¼šåˆ‡æ¢åˆ°å»ºè®®tab
        setActiveOptimizeTab('advice')
      }
    } catch (error: any) {
      console.error('System optimization failed:', error)
      notificationStore.error(`ä¼˜åŒ–å¤±è´¥: ${error.message}`, 3000)
      // æä¾›å¤‡ç”¨å»ºè®®
      setSystemSuggestions([
        {
          id: 'sys_fallback',
          type: 'modify' as const,
          category: 'role' as const,
          title: 'å¢åŠ æ›´æ¸…æ™°çš„è§’è‰²å®šä¹‰å’ŒèŒè´£è¯´æ˜',
          description: 'å¢åŠ æ›´æ¸…æ™°çš„è§’è‰²å®šä¹‰å’ŒèŒè´£è¯´æ˜',
          reason: 'ä¼˜åŒ–äº†è¡¨è¾¾æ–¹å¼',
          expectedEffect: 'æé«˜æç¤ºè¯æ¸…æ™°åº¦',
          priority: 'high' as const
        }
      ])
    } finally {
      setIsGeneratingSystem(false)
      setIsAnalyzing(false)
    }
  }

  // æ‰‹åŠ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®
  const handleGenerateAdvice = async () => {
    if (!originalSystemPrompt) return

    setIsGeneratingSystem(true)
    setSystemOptimizationStage(2)

    try {
      // åˆå§‹åŒ–æµå¼æ›´æ–°
      let adviceStreamContent = ''
      let adviceInitialized = false

      const adviceList = await generateOptimizationAdvice(
        originalSystemPrompt,
        'system',
        (chunk: string) => {
          adviceStreamContent += chunk

          // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶åˆå§‹åŒ–
          if (!adviceInitialized && chunk.trim()) {
            adviceInitialized = true
            setSystemSuggestions([
              {
                id: 'temp',
                type: 'modify' as const,
                category: 'role' as const,
                title: 'æ­£åœ¨ç”Ÿæˆ...',
                description: 'æ­£åœ¨ç”Ÿæˆ...',
                reason: '',
                expectedEffect: '',
                priority: 'medium' as const
              }
            ])
          }

          // å®æ—¶è§£æå¹¶æ›´æ–°å»ºè®®åˆ—è¡¨
          const suggestions = adviceStreamContent
            .split('\n')
            .map((s) => s.replace(/^[*-]\s*/, '').trim())
            .filter(Boolean)

          if (suggestions.length > 0) {
            setSystemSuggestions(
              suggestions.map((desc, idx) => ({
                id: `sys_${idx}`,
                type: 'modify' as const,
                category: 'role' as const,
                title: desc.substring(0, 50),
                description: desc,
                reason: '',
                expectedEffect: '',
                priority: 'medium' as const
              }))
            )
          }
        }
      )

      setSystemSuggestions(
        adviceList.map((advice, index) => ({
          id: `sys_${index}`,
          type: 'modify' as const,
          category: 'role' as const,
          title: advice.substring(0, 50),
          description: advice,
          reason: '',
          expectedEffect: '',
          priority: 'medium' as const
        }))
      )

      // ä¿å­˜å»ºè®®åˆ°ç¼“å­˜
      saveCache({ systemSuggestions: systemSuggestions })
    } catch (error: any) {
      console.error('Failed to generate advice:', error)
      notificationStore.error(`ç”Ÿæˆå»ºè®®å¤±è´¥: ${error.message}`, 3000)
    } finally {
      setIsGeneratingSystem(false)
    }
  }

  // æ‰§è¡Œæœ€ç»ˆä¼˜åŒ–
  const handleExecuteFinalOptimized = async () => {
    if (!originalSystemPrompt || systemSuggestions.length === 0) return

    setIsGeneratingSystem(true)
    setSystemOptimizationStage(3)
    saveCache({ systemOptimizationStage: 3 })

    try {
      // é‡ç½®æ ¼å¼å’Œè¯­è¨€çŠ¶æ€ä¸ºé»˜è®¤å€¼
      setFormatState('markdown')
      setLanguageState('zh')

      saveCache({
        formatState: 'markdown',
        languageState: 'zh'
      })

      // åˆå§‹åŒ–æµå¼æ›´æ–°
      let optimizedInitialized = false
      const adviceTexts = systemSuggestions.map((s) => s.description)

      const optimizedPrompt = await applyOptimizationAdvice(
        originalSystemPrompt,
        adviceTexts,
        'system',
        (chunk: string) => {
          // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶åˆå§‹åŒ–
          if (!optimizedInitialized && chunk.trim()) {
            optimizedInitialized = true
            setOptimizedSystemPrompt('æ­£åœ¨ç”Ÿæˆ...')
          }

          // è¿½åŠ å†…å®¹
          if (optimizedInitialized) {
            setOptimizedSystemPrompt((prev) => {
              if (prev === 'æ­£åœ¨ç”Ÿæˆ...' || typeof prev === 'string') {
                return prev === 'æ­£åœ¨ç”Ÿæˆ...' ? chunk : prev + chunk
              }
              return { ...prev, zh: prev.zh + chunk }
            })
          }
        }
      )

      setOptimizedSystemPrompt(optimizedPrompt)
      optimizeStore.setOptimizedPrompts(optimizedPrompt, '')

      // ä¿å­˜ä¼˜åŒ–ç»“æœåˆ°ç¼“å­˜
      saveCache({
        optimizedSystemPrompt: optimizedPrompt,
        activeOptimizeTab: 'final'
      })
      setActiveOptimizeTab('final')
    } catch (error: any) {
      console.error('Failed to generate final optimized prompt:', error)
      notificationStore.error(`ç”Ÿæˆä¼˜åŒ–ç»“æœå¤±è´¥: ${error.message}`, 3000)
    } finally {
      setIsGeneratingSystem(false)
    }
  }

  // å¤„ç†å¤åˆ¶å»ºè®®
  const handleCopyAdvice = async () => {
    try {
      await copyToClipboard(optimizeSuggestionsText.join('\n'))
      setIsCopiedAdvice(true)
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000)
      setTimeout(() => setIsCopiedAdvice(false), 2000)
    } catch (error) {
      notificationStore.error('å¤åˆ¶å¤±è´¥', 2000)
    }
  }

  // å¤„ç†å¤åˆ¶æœ€ç»ˆç»“æœ
  const handleCopyFinal = async () => {
    try {
      await copyToClipboard(currentOptimizedSystemPrompt)
      setIsCopiedFinal(true)
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000)
      setTimeout(() => setIsCopiedFinal(false), 2000)
    } catch (error) {
      notificationStore.error('å¤åˆ¶å¤±è´¥', 2000)
    }
  }

  // å¤„ç†ä¿å­˜æç¤ºè¯
  const handleSavePrompt = () => {
    setShowSaveDialog(true)
  }

  const handleSaveConfirm = async (formData: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    promptType: string
  }) => {
    setIsSaving(true)
    try {
      const result = await post('/api/prompts/', {
        title: formData.title,
        description: formData.description,
        final_prompt: currentOptimizedSystemPrompt,
        language: 'zh',
        format: formatState,
        prompt_type: formData.promptType,
        tags: formData.tags,
        is_public: formData.isPublic ? 1 : 0
      })

      if (result.code === 200) {
        notificationStore.success('æç¤ºè¯ä¿å­˜æˆåŠŸï¼', 2000)
        setShowSaveDialog(false)
      } else {
        throw new Error(result.message || 'ä¿å­˜å¤±è´¥')
      }
    } catch (error: any) {
      console.error('ä¿å­˜å¤±è´¥:', error)
      notificationStore.error(`ä¿å­˜å¤±è´¥: ${error.message}`, 3000)
    } finally {
      setIsSaving(false)
    }
  }

  // å¤„ç†å¯¹æ¯”ï¼ˆæš‚æ—¶æœªä½¿ç”¨ï¼‰
  // const handleCompareSystemPrompt = () => {
  //   localStorage.setItem('yprompt_trigger_compare', 'true')
  //   onUpdateActiveMode('compare')
  // }

  // è·å–è¯„åˆ†æ ·å¼ç±»
  const getScoreClass = (score: number) => {
    if (score >= 80) return 'text-green-600'
    if (score >= 60) return 'text-yellow-600'
    return 'text-red-600'
  }

  const getScoreBarClass = (score: number) => {
    if (score >= 80) return 'bg-green-500'
    if (score >= 60) return 'bg-yellow-500'
    return 'bg-red-500'
  }

  const getAnalysisLabel = (key: string) => {
    const labels: Record<string, string> = {
      role: 'è§’è‰²å®šä¹‰',
      task: 'ä»»åŠ¡æè¿°',
      format: 'è¾“å‡ºæ ¼å¼',
      constraints: 'çº¦æŸæ¡ä»¶',
      example: 'ç¤ºä¾‹è¯´æ˜',
      language: 'è¯­è¨€è¡¨è¾¾'
    }
    return labels[key] || key
  }

  // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–æ¨¡å¼
  if (activeMode === 'user') {
    return <UserPromptQuickOptimize />
  }

  // æ•ˆæœå¯¹æ¯”æ¨¡å¼
  if (activeMode === 'compare') {
    return <ComparisonPanel />
  }

  // ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–æ¨¡å¼
  return (
    <div className="w-full h-full min-h-0 overflow-hidden flex flex-row gap-4">
      {/* è¾“å…¥åŒº */}
      <div className="flex flex-col flex-1 min-h-0 overflow-hidden">
        <div className="bg-white rounded-lg shadow-sm flex flex-col flex-1 min-h-0 p-4 overflow-hidden">
          <div className="mb-4 flex-shrink-0 flex items-center justify-between">
            <div>
              <h4 className="text-base font-semibold text-gray-800 mb-2">ç³»ç»Ÿæç¤ºè¯</h4>
            </div>
            <button
              onClick={handleSystemRestart}
              className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
              title="é‡æ–°å¼€å§‹"
            >
              <RefreshCw className="w-4 h-4" />
              <span>é‡æ–°å¼€å§‹</span>
            </button>
          </div>

          {/* æ–‡æœ¬è¾“å…¥åŒºåŸŸ */}
          <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
            <textarea
              value={localSystemPrompt}
              onChange={(e) => setLocalSystemPrompt(e.target.value)}
              placeholder="åœ¨æ­¤è¾“å…¥ç³»ç»Ÿæç¤ºè¯...

ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯­è€å¸ˆ"
              className="w-full flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none resize-none text-sm min-h-0"
            />

            <div className="flex items-center justify-between text-xs text-gray-500 mt-2 flex-shrink-0">
              <span>{localSystemPrompt?.length || 0} å­—ç¬¦</span>
              <span>{Math.ceil((localSystemPrompt?.length || 0) / 4)} tokens</span>
            </div>
          </div>

          {/* åº•éƒ¨æŒ‰é’® */}
          <div className="mt-4 flex justify-end flex-shrink-0">
            <button
              onClick={handleSystemOptimize}
              disabled={!localSystemPrompt?.trim() || isGeneratingSystem}
              className="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              {isGeneratingSystem && (
                <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              )}
              <span>{isGeneratingSystem ? 'åˆ†æä¼˜åŒ–ä¸­...' : 'åˆ†æå¹¶ä¼˜åŒ–'}</span>
            </button>
          </div>
        </div>
      </div>

      {/* é¢„è§ˆåŒº */}
      <div className="flex flex-col flex-1 min-h-0 overflow-hidden">
        <div className="bg-white rounded-lg shadow-sm flex flex-col flex-1 min-h-0 overflow-hidden">
          {/* é¢„è§ˆå¤´éƒ¨ */}
          <div className="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
            <h4 className="font-semibold text-gray-800">ä¼˜åŒ–é¢„è§ˆ</h4>
            <div className="flex items-center space-x-3">
              <div className="flex items-center space-x-2">
                <label className="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={isAutoMode}
                    onChange={(e) => setIsAutoMode(e.target.checked)}
                    className="sr-only peer"
                  />
                  <span className="text-sm text-gray-600">{isAutoMode ? 'è‡ªåŠ¨ï¼š' : 'æ‰‹åŠ¨ï¼š'}</span>
                  <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
            </div>
          </div>

          {/* å†…å®¹åŒºåŸŸ */}
          {systemOptimizationStage === 0 ? (
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden p-4">
              <EmptyState />
            </div>
          ) : (
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden p-4">
              {/* Tab Container */}
              <TabContainer isGenerating={isGeneratingSystem}>
                <TabButton
                  isActive={activeOptimizeTab === 'analysis'}
                  activeClass="bg-orange-500 text-white"
                  onClick={() => setActiveOptimizeTab('analysis')}
                >
                  è´¨é‡åˆ†æ
                </TabButton>

                {systemOptimizationStage >= 2 && (
                  <TabButton
                    isActive={activeOptimizeTab === 'advice'}
                    activeClass="bg-yellow-500 text-white"
                    onClick={() => setActiveOptimizeTab('advice')}
                  >
                    ä¼˜åŒ–å»ºè®®
                  </TabButton>
                )}

                {systemOptimizationStage >= 3 && (
                  <TabButton
                    isActive={activeOptimizeTab === 'final'}
                    activeClass="bg-blue-500 text-white"
                    onClick={() => setActiveOptimizeTab('final')}
                  >
                    ä¼˜åŒ–ç»“æœ
                  </TabButton>
                )}
              </TabContainer>

              {/* Tab å†…å®¹åŒºåŸŸ - ä½¿ç”¨ flex-1 ç¡®ä¿é“ºæ»¡ */}
              <div className="flex-1 flex flex-col min-h-0 mt-4">
                {/* è´¨é‡åˆ†æ Tab */}
                {activeOptimizeTab === 'analysis' && (
                  <div className="flex-1 flex flex-col min-h-0">
                    {isAnalyzing ? (
                      <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
                        <div className="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4 min-h-0">
                          <pre className="text-xs text-gray-700 whitespace-pre-wrap font-mono">
                            {analysisStreamingText || 'AIæ­£åœ¨åˆ†æä¸­...'}
                          </pre>
                        </div>
                      </div>
                    ) : systemAnalysisResult ? (
                      <div className="flex-1 flex flex-col min-h-0">
                        <div className="flex-1 overflow-y-auto space-y-4 pr-2 min-h-0">
                          {/* æ•´ä½“è¯„åˆ† */}
                          <div className="border border-gray-200 rounded-lg p-4">
                            <div className="flex items-center justify-between mb-3">
                              <h4 className="text-sm font-medium text-gray-700">æ•´ä½“è¯„åˆ†</h4>
                              <span className={`text-2xl font-bold ${getScoreClass(systemAnalysisResult.overall_score)}`}>
                                {systemAnalysisResult.overall_score}/100
                              </span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-3">
                              <div
                                className={`h-3 rounded-full transition-all duration-500 ${getScoreBarClass(
                                  systemAnalysisResult.overall_score
                                )}`}
                                style={{ width: `${systemAnalysisResult.overall_score}%` }}
                              ></div>
                            </div>
                          </div>

                          {/* è¯¦ç»†åˆ†æç»´åº¦ */}
                          {systemAnalysisResult.analysis && (
                            <div className="grid grid-cols-2 gap-3">
                              {Object.entries(systemAnalysisResult.analysis).map(([key, item]: [string, any]) => (
                                <div key={key} className="border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow">
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs font-medium text-gray-700">{getAnalysisLabel(key)}</span>
                                    <span className={`text-lg font-bold ${getScoreClass(item.score)}`}>{item.score}</span>
                                  </div>
                                  <p className="text-xs text-gray-600">{item.feedback}</p>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>

                        {/* æ‰‹åŠ¨æ¨¡å¼ä¸‹çš„æ‰§è¡ŒæŒ‰é’® */}
                        {!isAutoMode && systemOptimizationStage === 1 && (
                          <div className="pt-4 mt-4 border-t border-gray-100 flex justify-end flex-shrink-0">
                            <button
                              onClick={handleGenerateAdvice}
                              disabled={isGeneratingSystem}
                              className="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
                            >
                              {isGeneratingSystem && (
                                <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                  <path
                                    className="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                  ></path>
                                </svg>
                              )}
                              <span>{isGeneratingSystem ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆä¼˜åŒ–å»ºè®®'}</span>
                            </button>
                          </div>
                        )}
                      </div>
                    ) : null}
                  </div>
                )}

                {/* ä¼˜åŒ–å»ºè®® Tab */}
                {activeOptimizeTab === 'advice' && (
                  <AdviceTab
                  advice={optimizeSuggestionsText}
                  setAdvice={(_newAdvice: string[]) => {
                    // å°†å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢ä¸ºå»ºè®®å¯¹è±¡æ•°ç»„
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåªæ›´æ–°æ–‡æœ¬å†…å®¹
                  }}
                  isAutoMode={isAutoMode}
                  isExecuting={isGeneratingSystem}
                  isGenerating={isGeneratingSystem}
                  currentExecutionStep={systemOptimizationStage === 3 ? 'final' : 'advice'}
                  isCopied={isCopiedAdvice}
                  onRegenerate={handleGenerateAdvice}
                  onCopy={handleCopyAdvice}
                  onAddItem={() => {
                    // AdviceTab çš„ onAddItem ä¸æ¥å—å‚æ•°
                    // å¦‚æœéœ€è¦æ·»åŠ é¡¹ç›®ï¼Œåº”è¯¥é€šè¿‡å…¶ä»–æ–¹å¼å¤„ç†
                  }}
                  onRemoveItem={(index: number) => {
                    setSystemSuggestions(systemSuggestions.filter((_, i) => i !== index))
                  }}
                  onUpdateItem={(index: number, newValue: string) => {
                    setSystemSuggestions(
                      systemSuggestions.map((s, i) => (i === index ? { ...s, description: newValue } : s))
                    )
                  }}
                  onExecuteFinal={handleExecuteFinalOptimized}
                />
                )}

                {/* ä¼˜åŒ–ç»“æœ Tab */}
                {activeOptimizeTab === 'final' && (
                  <FinalTab
                  generatedPrompt={currentOptimizedSystemPrompt}
                  setGeneratedPrompt={setCurrentOptimizedSystemPrompt}
                  isExecuting={false}
                  isGenerating={isGeneratingSystem}
                  currentExecutionStep={null}
                  isCopied={isCopiedFinal}
                  isConvertingFormat={isConvertingFormat}
                  isConvertingLanguage={isConvertingLanguage}
                  isSaving={isSaving}
                  formatState={formatState}
                  languageState={languageState}
                  onRegenerate={handleExecuteFinalOptimized}
                  onCopy={handleCopyFinal}
                  onToggleFormat={() => {
                    // TODO: å®ç°æ ¼å¼è½¬æ¢
                    notificationStore.info('æ ¼å¼è½¬æ¢åŠŸèƒ½å¼€å‘ä¸­...', 2000)
                  }}
                  onToggleLanguage={() => {
                    // TODO: å®ç°è¯­è¨€è½¬æ¢
                    notificationStore.info('è¯­è¨€è½¬æ¢åŠŸèƒ½å¼€å‘ä¸­...', 2000)
                  }}
                  onSavePrompt={handleSavePrompt}
                />
                )}
              </div>
            </div>
          )}
        </div>
      </div>

      {/* ä¿å­˜æç¤ºè¯å¯¹è¯æ¡† */}
      {showSaveDialog && (
        <SavePromptDialog
          isOpen={showSaveDialog}
          promptContent={currentOptimizedSystemPrompt}
          isSaving={isSaving}
          onSave={handleSaveConfirm}
          onCancel={() => setShowSaveDialog(false)}
        />
      )}
    </div>
  )
}

```


## src/components/modules/optimize/components/SettingsModal.tsx

```tsx
import { useState } from 'react'
import { X } from 'lucide-react'

interface Variable {
  id: string
  name: string
  value: string
  description?: string
}

interface OptimizeSettings {
  temperature: number
  maxTokens: number
  focusAreas: string[]
  language: string
  autoApplySuggestions: boolean
  preserveStyle: boolean
  enableQualityComparison: boolean
}

interface Props {
  show: boolean
  settings?: OptimizeSettings
  variables?: Variable[]
  predefinedVariables?: Variable[]
  onClose: () => void
  onSave: (settings: OptimizeSettings) => void
}

export default function SettingsModal({
  show,
  settings,
  variables = [],
  predefinedVariables = [],
  onClose,
  onSave
}: Props) {
  // æœ¬åœ°çŠ¶æ€
  const [localSettings, setLocalSettings] = useState<OptimizeSettings>({
    temperature: settings?.temperature ?? 0.7,
    maxTokens: settings?.maxTokens ?? 1000,
    focusAreas: settings?.focusAreas ?? ['clarity', 'completeness'],
    language: settings?.language ?? 'zh',
    autoApplySuggestions: settings?.autoApplySuggestions ?? false,
    preserveStyle: settings?.preserveStyle ?? true,
    enableQualityComparison: settings?.enableQualityComparison ?? true
  })

  if (!show) return null

  const handleFocusAreaToggle = (area: string) => {
    const newFocusAreas = localSettings.focusAreas?.includes(area)
      ? localSettings.focusAreas.filter(a => a !== area)
      : [...(localSettings.focusAreas || []), area]

    setLocalSettings(prev => ({ ...prev, focusAreas: newFocusAreas }))
  }

  const handleSave = () => {
    onSave(localSettings)
    onClose()
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-lg font-semibold text-gray-800">ä¼˜åŒ–è®¾ç½®</h3>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="space-y-6">
          {/* åŸºæœ¬è®¾ç½® */}
          <div className="border-b border-gray-200 pb-6">
            <h4 className="text-base font-medium text-gray-800 mb-4">åŸºæœ¬è®¾ç½®</h4>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">æ¸©åº¦å€¼</label>
                <div className="flex items-center space-x-3">
                  <input
                    type="range"
                    min="0"
                    max="2"
                    step="0.1"
                    value={localSettings.temperature}
                    onChange={(e) => setLocalSettings(prev => ({ ...prev, temperature: parseFloat(e.target.value) }))}
                    className="flex-1"
                  />
                  <span className="text-sm text-gray-600 w-12">{localSettings.temperature}</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼Œå€¼è¶Šé«˜è¶Šæœ‰åˆ›é€ æ€§</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§ Token æ•°</label>
                <input
                  type="number"
                  min="100"
                  max="4000"
                  value={localSettings.maxTokens}
                  onChange={(e) => setLocalSettings(prev => ({ ...prev, maxTokens: parseInt(e.target.value) }))}
                  className="w-full p-2 border border-gray-300 rounded text-sm"
                />
                <p className="text-xs text-gray-500 mt-1">ç”Ÿæˆå†…å®¹çš„æœ€å¤§é•¿åº¦</p>
              </div>
            </div>
          </div>

          {/* ä¼˜åŒ–é‡ç‚¹ */}
          <div className="border-b border-gray-200 pb-6">
            <h4 className="text-base font-medium text-gray-800 mb-4">ä¼˜åŒ–é‡ç‚¹</h4>

            <div className="space-y-3">
              {[
                { key: 'clarity', label: 'æ¸…æ™°åº¦ - ä½¿æç¤ºè¯æ›´æ˜ç¡®æ˜“æ‡‚' },
                { key: 'completeness', label: 'å®Œæ•´æ€§ - è¡¥å……ç¼ºå¤±çš„å…³é”®ä¿¡æ¯' },
                { key: 'specificity', label: 'å…·ä½“æ€§ - å¢åŠ å…·ä½“çš„æŒ‡å¯¼å’Œçº¦æŸ' },
                { key: 'structure', label: 'ç»“æ„ - ä¼˜åŒ–é€»è¾‘ç»“æ„å’Œæµç¨‹' },
                { key: 'examples', label: 'ç¤ºä¾‹ - æ·»åŠ æˆ–æ”¹è¿›ç¤ºä¾‹è¯´æ˜' }
              ].map(({ key, label }) => (
                <label key={key} className="flex items-center space-x-3">
                  <input
                    type="checkbox"
                    checked={localSettings.focusAreas?.includes(key) || false}
                    onChange={() => handleFocusAreaToggle(key)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="text-sm text-gray-700">{label}</span>
                </label>
              ))}
            </div>
          </div>

          {/* è¯­è¨€è®¾ç½® */}
          <div className="border-b border-gray-200 pb-6">
            <h4 className="text-base font-medium text-gray-800 mb-4">è¯­è¨€è®¾ç½®</h4>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">è¾“å‡ºè¯­è¨€</label>
              <select
                value={localSettings.language}
                onChange={(e) => setLocalSettings(prev => ({ ...prev, language: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded text-sm"
              >
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">è‹±æ–‡</option>
                <option value="bilingual">ä¸­è‹±åŒè¯­</option>
              </select>
              <p className="text-xs text-gray-500 mt-1">ä¼˜åŒ–å»ºè®®å’Œè¾“å‡ºå†…å®¹çš„ä½¿ç”¨è¯­è¨€</p>
            </div>
          </div>

          {/* é«˜çº§è®¾ç½® */}
          <div className="pb-6">
            <h4 className="text-base font-medium text-gray-800 mb-4">é«˜çº§è®¾ç½®</h4>

            <div className="space-y-4">
              <div>
                <label className="flex items-center space-x-3">
                  <input
                    type="checkbox"
                    checked={localSettings.autoApplySuggestions}
                    onChange={(e) => setLocalSettings(prev => ({ ...prev, autoApplySuggestions: e.target.checked }))}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="text-sm text-gray-700">è‡ªåŠ¨åº”ç”¨é«˜ä¼˜å…ˆçº§å»ºè®®</span>
                </label>
                <p className="text-xs text-gray-500 mt-1">ä¼˜å…ˆçº§ä¸º "high" çš„å»ºè®®å°†è‡ªåŠ¨åº”ç”¨</p>
              </div>

              <div>
                <label className="flex items-center space-x-3">
                  <input
                    type="checkbox"
                    checked={localSettings.preserveStyle}
                    onChange={(e) => setLocalSettings(prev => ({ ...prev, preserveStyle: e.target.checked }))}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="text-sm text-gray-700">ä¿æŒåŸæœ‰é£æ ¼</span>
                </label>
                <p className="text-xs text-gray-500 mt-1">å°½é‡ä¿æŒåŸå§‹æç¤ºè¯çš„è¯­è¨€é£æ ¼å’Œè¯­æ°”</p>
              </div>

              <div>
                <label className="flex items-center space-x-3">
                  <input
                    type="checkbox"
                    checked={localSettings.enableQualityComparison}
                    onChange={(e) => setLocalSettings(prev => ({ ...prev, enableQualityComparison: e.target.checked }))}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="text-sm text-gray-700">å¯ç”¨è´¨é‡å¯¹æ¯”</span>
                </label>
                <p className="text-xs text-gray-500 mt-1">æ˜¾ç¤ºä¼˜åŒ–å‰åçš„è´¨é‡è¯„åˆ†å¯¹æ¯”</p>
              </div>
            </div>
          </div>
        </div>

        {/* åº•éƒ¨æŒ‰é’® */}
        <div className="flex justify-end space-x-3 pt-6 border-t">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>
    </div>
  )
}
```


## src/components/modules/optimize/components/SystemPromptModal.tsx

```tsx
import { X } from 'lucide-react'

interface Props {
  isOpen: boolean
  modelValue: string
  title?: string
  onClose: () => void
  onUpdateModelValue: (value: string) => void
  onSave: () => void
}

export default function SystemPromptModal({
  isOpen,
  modelValue,
  title,
  onClose,
  onUpdateModelValue,
  onSave
}: Props) {
  const handleSave = () => {
    onSave()
    onClose()
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-4 border-b border-gray-200">
          <h4 className="text-lg font-semibold text-gray-900">{title || 'ç³»ç»Ÿæç¤ºè¯è®¾ç½®'}</h4>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* å†…å®¹ */}
        <div className="flex-1 overflow-y-auto p-4">
          <p className="text-sm text-gray-600 mb-3">
            è®¾ç½®ç³»ç»Ÿæç¤ºè¯å¯ä»¥å¸®åŠ©AIæ›´å¥½åœ°ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæä¾›æ›´å‡†ç¡®çš„å“åº”ã€‚
          </p>
          <textarea
            value={modelValue}
            onChange={(e) => onUpdateModelValue(e.target.value)}
            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white text-gray-900"
            rows={8}
            placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ“…é•¿è§£å†³ä»£ç é—®é¢˜å’Œæä¾›æŠ€æœ¯å»ºè®®ã€‚"
          />
        </div>

        {/* åº•éƒ¨ */}
        <div className="flex items-center justify-end gap-3 p-4 border-t border-gray-200">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>
  )
}
```


## src/components/modules/optimize/components/VersionSelector.tsx

```tsx
import { useState, useMemo } from 'react'
import { X, Clock, RotateCcw } from 'lucide-react'
import { useOptimizeStore } from '@/stores/optimizeStore'
import type { Version } from '@/stores/optimizeStore'

export default function VersionSelector() {
  const [showVersionHistory, setShowVersionHistory] = useState(false)

  const optimizeStore = useOptimizeStore()
  const {
    versions,
    currentVersion,
    currentVersionData,
    systemPrompt,
    userPrompt,
    switchVersion: storeSwitchVersion
  } = optimizeStore

  // è®¡ç®—æ˜¾ç¤ºçš„ç‰ˆæœ¬ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
  const displayVersions = useMemo(() => {
    const allVersions = [
      { version: 'original', tag: 'initial' as const, createdAt: new Date() },
      ...versions
    ]
    return allVersions.slice(-5).reverse()
  }, [versions])

  const switchVersion = (version: string) => {
    storeSwitchVersion(version)
    setShowVersionHistory(false)
  }

  const rollbackToVersion = () => {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªæ–°çš„å›æ»šç‰ˆæœ¬
    console.log('Rollback to version:', currentVersion)
  }

  const formatDate = (date: Date | string | undefined) => {
    if (!date) return ''
    const d = typeof date === 'string' ? new Date(date) : date
    return d.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const getTagLabel = (tag: string) => {
    const labels: Record<string, string> = {
      'initial': 'åˆå§‹',
      'draft': 'è‰ç¨¿',
      'beta': 'æµ‹è¯•',
      'stable': 'ç¨³å®š',
      'production': 'ç”Ÿäº§',
      'archived': 'å½’æ¡£',
      'rollback': 'å›æ»š'
    }
    return labels[tag] || tag
  }

  const getTagClass = (tag: string) => {
    const classes: Record<string, string> = {
      'initial': 'bg-gray-100 text-gray-600',
      'draft': 'bg-yellow-100 text-yellow-600',
      'beta': 'bg-blue-100 text-blue-600',
      'stable': 'bg-green-100 text-green-600',
      'production': 'bg-purple-100 text-purple-600',
      'archived': 'bg-gray-100 text-gray-600',
      'rollback': 'bg-orange-100 text-orange-600'
    }
    return classes[tag] || 'bg-gray-100 text-gray-600'
  }

  return (
    <div className="version-selector">
      {/* ç‰ˆæœ¬é€‰æ‹©å™¨ */}
      <div className="flex items-center space-x-2 mb-3">
        <span className="text-sm font-medium text-gray-700">ç‰ˆæœ¬:</span>
        <div className="flex flex-wrap gap-1">
          {displayVersions.map((version) => (
            <button
              key={version.version}
              onClick={() => switchVersion(version.version)}
              className={`px-2 py-1 text-xs rounded-md border transition-colors ${
                currentVersion === version.version
                  ? 'bg-blue-50 border-blue-200 text-blue-700'
                  : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
              }`}
            >
              {version.version}
              {version.tag && (
                <span className="ml-1 text-xs opacity-70">
                  {getTagLabel(version.tag)}
                </span>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* ç‰ˆæœ¬ä¿¡æ¯ */}
      {currentVersionData && (
        <div className="text-xs text-gray-500 space-y-1">
          {currentVersionData.createdAt && (
            <div>åˆ›å»ºæ—¶é—´: {formatDate(currentVersionData.createdAt)}</div>
          )}
          {currentVersionData.note && (
            <div>å¤‡æ³¨: {currentVersionData.note}</div>
          )}
          {currentVersionData.appliedSuggestions?.length > 0 && (
            <div>åº”ç”¨äº† {currentVersionData.appliedSuggestions.length} æ¡å»ºè®®</div>
          )}
        </div>
      )}

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex items-center space-x-2 mt-3">
        <button
          onClick={() => setShowVersionHistory(true)}
          className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1"
        >
          <Clock className="w-3 h-3" />
          å†å²ç‰ˆæœ¬
        </button>
        {currentVersion !== 'original' && (
          <button
            onClick={rollbackToVersion}
            className="text-xs text-gray-600 hover:text-gray-700 flex items-center gap-1"
          >
            <RotateCcw className="w-3 h-3" />
            å›æ»šåˆ°æ­¤ç‰ˆæœ¬
          </button>
        )}
      </div>

      {/* ç‰ˆæœ¬å†å²æ¨¡æ€æ¡† */}
      {showVersionHistory && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-2xl max-h-[80vh] overflow-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">ç‰ˆæœ¬å†å²</h3>
              <button
                onClick={() => setShowVersionHistory(false)}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className="space-y-3">
              {/* åŸå§‹ç‰ˆæœ¬ */}
              <div
                onClick={() => switchVersion('original')}
                className={`p-3 border rounded-lg cursor-pointer transition-colors ${
                  currentVersion === 'original'
                    ? 'border-blue-300 bg-blue-50'
                    : 'border-gray-200 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <span className="font-medium">åŸå§‹ç‰ˆæœ¬</span>
                    <span className="text-xs text-gray-500">Initial</span>
                  </div>
                  <div className="text-xs text-gray-500">
                    {formatDate(new Date(systemPrompt || userPrompt))}
                  </div>
                </div>
              </div>

              {/* å†å²ç‰ˆæœ¬ */}
              {[...versions].reverse().map((version) => (
                <div
                  key={version.id}
                  onClick={() => switchVersion(version.version)}
                  className={`p-3 border rounded-lg cursor-pointer transition-colors ${
                    currentVersion === version.version
                      ? 'border-blue-300 bg-blue-50'
                      : 'border-gray-200 hover:bg-gray-50'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2">
                      <span className="font-medium">{version.version}</span>
                      {version.tag && (
                        <span
                          className={`px-2 py-0.5 text-xs rounded-full ${getTagClass(version.tag)}`}
                        >
                          {getTagLabel(version.tag)}
                        </span>
                      )}
                    </div>
                    <div className="text-xs text-gray-500">
                      {formatDate(version.createdAt)}
                    </div>
                  </div>
                  {version.note && (
                    <div className="text-sm text-gray-600 mt-1">{version.note}</div>
                  )}
                  {version.changes?.length > 0 && (
                    <div className="text-xs text-gray-500 mt-1">
                      {version.changes.length} å¤„ä¿®æ”¹
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
```


## src/components/modules/optimize/components/dialogs/SaveUserPromptDialog.tsx

```tsx
import { useState, useEffect } from 'react'
import { X } from 'lucide-react'

interface SaveUserPromptDialogProps {
  isOpen: boolean
  promptContent: string
  systemPrompt?: string
  conversationHistory?: string
  isSaving: boolean
  onSave: (data: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    systemPrompt: string
    conversationHistory: string
  }) => void
  onCancel: () => void
}

const conversationExample = `[
  {
    "role": "user",
    "content": "æˆ‘ç‰™ç–¼"
  },
  {
    "role": "assistant",
    "content": "ç‰™ç–¼å¤šä¹…äº†ï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„ç—‡çŠ¶å—ï¼Ÿ"
  },
  {
    "role": "user",
    "content": "ä¸‰å¤©äº†ï¼Œä¸»è¦æ˜¯åƒå†·çƒ­é£Ÿç‰©æ—¶ç‰¹åˆ«ç–¼"
  }
]`

export default function SaveUserPromptDialog({
  isOpen,
  promptContent,
  systemPrompt = '',
  conversationHistory = '',
  isSaving,
  onSave,
  onCancel
}: SaveUserPromptDialogProps) {
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    systemPrompt: '',
    conversationHistory: '',
    tags: ['ç”¨æˆ·æç¤ºè¯', 'å¿«é€Ÿä¼˜åŒ–'] as string[],
    isPublic: false
  })
  const [newTag, setNewTag] = useState('')
  const [showConversationHelp, setShowConversationHelp] = useState(false)
  const [conversationFormatError, setConversationFormatError] = useState('')

  // éªŒè¯å¯¹è¯å†å²JSONæ ¼å¼
  const validateConversationJson = (jsonStr: string): string => {
    if (!jsonStr.trim()) return ''

    try {
      const parsed = JSON.parse(jsonStr)

      // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„
      if (!Array.isArray(parsed)) {
        return 'å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼'
      }

      // æ£€æŸ¥æ¯ä¸ªå…ƒç´ æ ¼å¼
      for (let i = 0; i < parsed.length; i++) {
        const item = parsed[i]
        if (!item.role || !item.content) {
          return `ç¬¬${i + 1}æ¡æ¶ˆæ¯ç¼ºå°‘roleæˆ–contentå­—æ®µ`
        }
        if (!['user', 'assistant', 'system'].includes(item.role)) {
          return `ç¬¬${i + 1}æ¡æ¶ˆæ¯çš„roleå¿…é¡»æ˜¯userã€assistantæˆ–system`
        }
      }

      return ''
    } catch (e: any) {
      return e.message || 'JSONæ ¼å¼é”™è¯¯'
    }
  }

  // ç›‘å¬å¯¹è¯æ¡†æ‰“å¼€ï¼Œé‡ç½®è¡¨å•
  useEffect(() => {
    if (isOpen) {
      // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
      const promptPreview = promptContent.substring(0, 50)
      setFormData({
        title: `ç”¨æˆ·æç¤ºè¯ - ${promptPreview}${promptContent.length > 50 ? '...' : ''}`,
        description: '',
        systemPrompt: systemPrompt || '',
        conversationHistory: conversationHistory || '',
        tags: ['ç”¨æˆ·æç¤ºè¯', 'å¿«é€Ÿä¼˜åŒ–'],
        isPublic: false
      })
      setConversationFormatError('')
      setShowConversationHelp(false)
      setNewTag('')
    }
  }, [isOpen, promptContent, systemPrompt, conversationHistory])

  // ç›‘å¬å¯¹è¯å†å²è¾“å…¥ï¼Œå®æ—¶éªŒè¯æ ¼å¼
  useEffect(() => {
    setConversationFormatError(validateConversationJson(formData.conversationHistory))
  }, [formData.conversationHistory])

  // æ ¼å¼åŒ–JSON
  const formatConversationJson = () => {
    try {
      const parsed = JSON.parse(formData.conversationHistory)
      setFormData((prev) => ({
        ...prev,
        conversationHistory: JSON.stringify(parsed, null, 2)
      }))
      setConversationFormatError('')
    } catch (e) {
      setConversationFormatError('JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ ¼å¼åŒ–')
    }
  }

  // æ˜¯å¦å¯ä»¥ä¿å­˜
  const canSave =
    formData.title.trim() && promptContent && !conversationFormatError

  const addTag = () => {
    const tag = newTag.trim()
    if (tag && !formData.tags.includes(tag) && formData.tags.length < 10) {
      setFormData((prev) => ({
        ...prev,
        tags: [...prev.tags, tag]
      }))
      setNewTag('')
    }
  }

  const removeTag = (tag: string) => {
    setFormData((prev) => ({
      ...prev,
      tags: prev.tags.filter((t) => t !== tag)
    }))
  }

  const handleSave = () => {
    if (!canSave) return

    onSave({
      title: formData.title.trim(),
      description: formData.description.trim(),
      tags: formData.tags,
      isPublic: formData.isPublic,
      systemPrompt: formData.systemPrompt.trim(),
      conversationHistory: formData.conversationHistory.trim()
    })
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div
        className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-6 border-b">
          <h2 className="text-xl font-semibold text-gray-900">ä¿å­˜ç”¨æˆ·æç¤ºè¯</h2>
          <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* å†…å®¹ */}
        <div className="p-6 space-y-4">
          {/* æ ‡é¢˜ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æ ‡é¢˜ <span className="text-red-500">*</span>
            </label>
            <input
              value={formData.title}
              onChange={(e) => setFormData((prev) => ({ ...prev, title: e.target.value }))}
              type="text"
              placeholder="è¯·è¾“å…¥æç¤ºè¯æ ‡é¢˜"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              maxLength={200}
            />
            <p className="mt-1 text-xs text-gray-500">{formData.title.length}/200</p>
          </div>

          {/* æè¿° */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData((prev) => ({ ...prev, description: e.target.value }))}
              placeholder="ç®€çŸ­æè¿°è¿™ä¸ªæç¤ºè¯çš„ç”¨é€”ï¼ˆå¯é€‰ï¼‰"
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
              maxLength={500}
            />
            <p className="mt-1 text-xs text-gray-500">{formData.description.length}/500</p>
          </div>

          {/* ç³»ç»Ÿæç¤ºè¯ï¼ˆAIåŠ©æ‰‹çš„è§’è‰²è®¾å®šï¼‰ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
              <span>ç³»ç»Ÿæç¤ºè¯ï¼ˆAIåŠ©æ‰‹è§’è‰²ï¼‰</span>
              {formData.systemPrompt.trim() ? (
                <span className="flex items-center gap-1 text-green-600 text-xs">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fillRule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clipRule="evenodd"
                    />
                  </svg>
                  ç³»ç»Ÿæç¤ºè¯å·²è®¾ç½®
                </span>
              ) : (
                <span className="flex items-center gap-1 text-gray-400 text-xs">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  è®¾ç½®ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰
                </span>
              )}
            </label>
            <textarea
              value={formData.systemPrompt}
              onChange={(e) => setFormData((prev) => ({ ...prev, systemPrompt: e.target.value }))}
              placeholder="è¾“å…¥AIåŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰"
              rows={4}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm"
              maxLength={5000}
            />
            <p className="mt-1 text-xs text-gray-500">{formData.systemPrompt.length}/5000 å­—ç¬¦</p>
          </div>

          {/* å¯¹è¯ä¸Šä¸‹æ–‡ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              å¯¹è¯ä¸Šä¸‹æ–‡
              <span className="text-xs text-gray-500 ml-2">(ä¸¥æ ¼JSONæ ¼å¼ï¼Œå¯å°†æ¥å¤ç”¨)</span>
            </label>
            <textarea
              value={formData.conversationHistory}
              onChange={(e) =>
                setFormData((prev) => ({ ...prev, conversationHistory: e.target.value }))
              }
              placeholder='è¯·è¾“å…¥å¯¹è¯å†å²ï¼Œæ ¼å¼ï¼š[{"role":"user","content":"..."},{"role":"assistant","content":"..."}]'
              rows={6}
              className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-xs ${
                conversationFormatError ? 'border-red-500' : 'border-gray-300'
              }`}
            />
            {conversationFormatError ? (
              <p className="mt-1 text-xs text-red-600">âš ï¸ JSONæ ¼å¼é”™è¯¯ï¼š{conversationFormatError}</p>
            ) : (
              <p className="mt-1 text-xs text-gray-500">
                {formData.conversationHistory.length}/10000 å­—ç¬¦
                {formData.conversationHistory && (
                  <>
                    <button
                      onClick={formatConversationJson}
                      className="ml-2 text-blue-600 hover:text-blue-700 underline"
                    >
                      æ ¼å¼åŒ–
                    </button>
                    <button
                      onClick={() => setShowConversationHelp(!showConversationHelp)}
                      className="ml-2 text-blue-600 hover:text-blue-700 underline"
                    >
                      {showConversationHelp ? 'éšè—' : 'æŸ¥çœ‹'}ç¤ºä¾‹
                    </button>
                  </>
                )}
              </p>
            )}

            {/* å¯¹è¯æ ¼å¼å¸®åŠ©ç¤ºä¾‹ */}
            {showConversationHelp && (
              <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded text-xs">
                <p className="font-semibold mb-1">æ ‡å‡†æ ¼å¼ç¤ºä¾‹ï¼š</p>
                <pre className="bg-white p-2 rounded overflow-x-auto">{conversationExample}</pre>
              </div>
            )}
          </div>

          {/* æ ‡ç­¾ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">æ ‡ç­¾</label>
            <div className="flex flex-wrap gap-2 mb-2">
              {formData.tags.map((tag) => (
                <span
                  key={tag}
                  className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"
                >
                  {tag}
                  <button
                    onClick={() => removeTag(tag)}
                    className="ml-2 text-blue-500 hover:text-blue-700"
                  >
                    Ã—
                  </button>
                </span>
              ))}
            </div>
            <div className="flex gap-2">
              <input
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                onKeyUp={(e) => {
                  if (e.key === 'Enter') {
                    addTag()
                  }
                }}
                type="text"
                placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ "
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <button
                onClick={addTag}
                className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>

          {/* æ˜¯å¦å…¬å¼€ */}
          <div className="flex items-center">
            <input
              type="checkbox"
              checked={formData.isPublic}
              onChange={(e) => setFormData((prev) => ({ ...prev, isPublic: e.target.checked }))}
              id="isPublic"
              className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <label htmlFor="isPublic" className="ml-2 text-sm text-gray-700">
              å…¬å¼€åˆ†äº«ï¼ˆå…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯å’Œå¯¹è¯è®°å½•ï¼‰
            </label>
          </div>

          {/* ç”¨æˆ·æç¤ºè¯å†…å®¹ï¼ˆä¼˜åŒ–åçš„ï¼‰ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              ç”¨æˆ·æç¤ºè¯å†…å®¹ <span className="text-red-500">*</span>
            </label>
            <div className="p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto text-sm text-gray-600 font-mono">
              {promptContent.slice(0, 200)}
              {promptContent.length > 200 ? '...' : ''}
            </div>
            <p className="mt-1 text-xs text-gray-500">å…± {promptContent.length} ä¸ªå­—ç¬¦</p>
          </div>
        </div>

        {/* åº•éƒ¨æŒ‰é’® */}
        <div className="flex justify-end gap-3 p-6 border-t bg-gray-50">
          <button
            onClick={onCancel}
            className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            disabled={!canSave || isSaving}
            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
          >
            {isSaving ? (
              <span className="flex items-center">
                <svg className="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  ></circle>
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                ä¿å­˜ä¸­...
              </span>
            ) : (
              <span>ä¿å­˜</span>
            )}
          </button>
        </div>
      </div>
    </div>
  )
}

```


## src/components/modules/optimize/components/quick/OptimizeQualityIndicator.tsx

```tsx
import {
  CheckCircle2,
  XCircle,
  AlertTriangle,
  FileText
} from 'lucide-react'
import type { QualityCheckResult } from '@/types/optimize'

interface Props {
  quality: QualityCheckResult
}

export default function OptimizeQualityIndicator({ quality }: Props) {
  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'good':
        return CheckCircle2
      case 'warning':
        return AlertTriangle
      case 'error':
        return XCircle
      default:
        return AlertTriangle
    }
  }

  const getStatusColor = (status: string): string => {
    switch (status) {
      case 'good':
        return 'text-green-600 dark:text-green-400'
      case 'warning':
        return 'text-yellow-600 dark:text-yellow-400'
      case 'error':
        return 'text-red-600 dark:text-red-400'
      default:
        return 'text-gray-600 dark:text-gray-400'
    }
  }

  const getStatusText = (status: string): string => {
    switch (status) {
      case 'good':
        return 'è´¨é‡è‰¯å¥½'
      case 'warning':
        return 'éœ€è¦æ³¨æ„'
      case 'error':
        return 'å­˜åœ¨é—®é¢˜'
      default:
        return 'æœªçŸ¥'
    }
  }

  const StatusIcon = getStatusIcon(quality.lengthStatus)

  return (
    <div className="space-y-3">
      {/* è´¨é‡æ€»è§ˆ */}
      <div className="flex items-center justify-between">
        <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">è´¨é‡æ£€æµ‹</h3>
        <div className="flex items-center gap-2">
          <StatusIcon className={`w-4 h-4 ${getStatusColor(quality.lengthStatus)}`} />
          <span className={`text-sm font-medium ${getStatusColor(quality.lengthStatus)}`}>
            {getStatusText(quality.lengthStatus)}
          </span>
        </div>
      </div>

      {/* è¯¦ç»†æŒ‡æ ‡ */}
      <div className="grid grid-cols-2 gap-3">
        {/* é•¿åº¦æŒ‡æ ‡ */}
        <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
          <div className="flex items-center gap-2 mb-2">
            <FileText className="w-4 h-4 text-gray-600 dark:text-gray-400" />
            <span className="text-xs font-medium text-gray-600 dark:text-gray-400">é•¿åº¦</span>
          </div>
          <div className="text-lg font-semibold text-gray-900 dark:text-white">
            {quality.length} å­—
          </div>
          <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
            æ¯”ä¾‹: {quality.lengthRatio.toFixed(1)}x
          </div>
        </div>

        {/* ç»“æ„æ£€æµ‹ */}
        <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
          <div className="flex items-center gap-2 mb-2">
            {quality.hasStructureMarkers ? (
              <AlertTriangle className="w-4 h-4 text-yellow-600" />
            ) : (
              <CheckCircle2 className="w-4 h-4 text-green-600" />
            )}
            <span className="text-xs font-medium text-gray-600 dark:text-gray-400">ç»“æ„</span>
          </div>
          <div
            className={`text-sm font-medium ${
              quality.hasStructureMarkers ? 'text-yellow-600' : 'text-green-600'
            }`}
          >
            {quality.hasStructureMarkers ? 'æ£€æµ‹åˆ°æ ‡è®°' : 'è‡ªç„¶å¯¹è¯'}
          </div>
          <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
            {quality.hasStructureMarkers ? 'åŒ…å«ç»“æ„æ ‡è®°' : 'æ— ç»“æ„åŒ–æ ‡è®°'}
          </div>
        </div>
      </div>

      {/* è­¦å‘Šä¿¡æ¯ */}
      {quality.warnings && quality.warnings.length > 0 ? (
        <div className="space-y-2">
          {quality.warnings.map((warning, index) => (
            <div
              key={index}
              className="flex items-start gap-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg"
            >
              <AlertTriangle className="w-4 h-4 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" />
              <p className="text-xs text-yellow-800 dark:text-yellow-200">{warning}</p>
            </div>
          ))}
        </div>
      ) : (
        /* æˆåŠŸæç¤º */
        <div className="flex items-start gap-2 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
          <CheckCircle2 className="w-4 h-4 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5" />
          <p className="text-xs text-green-800 dark:text-green-200">
            ä¼˜åŒ–è´¨é‡è‰¯å¥½ï¼Œç¬¦åˆç›¸å¯¹é•¿åº¦æ§åˆ¶ç­–ç•¥ï¼Œä¿æŒäº†è‡ªç„¶å¯¹è¯é£æ ¼
          </p>
        </div>
      )}
    </div>
  )
}
```


## src/components/modules/optimize/components/quick/QuickOptimizeInput.tsx

```tsx
import { useState, useEffect, useRef } from 'react'
import {
  ArrowUp,
  FileText,
  MessageSquare,
  RefreshCw,
  ArrowLeftRight,
  Trash2,
  Copy,
  Edit2,
  X,
  Check
} from 'lucide-react'
import { copyToClipboard } from '@/utils/clipboardUtils'
import { useConversationMessages, type ConversationMessage } from '@/hooks/useConversationMessages'
import SystemPromptModal from './SystemPromptModal'

const STORAGE_KEY = 'user_prompt_optimize_data'

interface QuickOptimizeInputProps {
  draftPrompt: string
  systemPrompt: string
  conversationHistory: string
  isOptimizing: boolean
  onUpdateDraftPrompt: (value: string) => void
  onUpdateSystemPrompt: (value: string) => void
  onUpdateConversationHistory: (value: string) => void
  onOptimize: () => void
  onRestart: () => void
}

export default function QuickOptimizeInput({
  draftPrompt,
  systemPrompt,
  conversationHistory,
  isOptimizing,
  onUpdateDraftPrompt,
  onUpdateSystemPrompt,
  onUpdateConversationHistory,
  onOptimize,
  onRestart
}: QuickOptimizeInputProps) {
  const messages = useConversationMessages()
  const [showSystemPromptModal, setShowSystemPromptModal] = useState(false)
  const [systemPromptValue, setSystemPromptValue] = useState(systemPrompt)
  const [currentRole, setCurrentRole] = useState<'user' | 'ai'>('user')
  const [inputText, setInputText] = useState('')
  const isInternalUpdateRef = useRef(false)

  // ä»JSONæ ¼å¼çš„å¯¹è¯å†å²æ¢å¤æ¶ˆæ¯
  const loadFromConversationHistory = () => {
    if (conversationHistory.trim()) {
      try {
        const parsed = JSON.parse(conversationHistory)
        if (Array.isArray(parsed)) {
          const loadedMessages: ConversationMessage[] = parsed.map((msg: any, index: number) => ({
            id: `msg-${Date.now()}-${index}`,
            role: msg.role === 'assistant' ? 'ai' : 'user',
            content: msg.content,
            isEditing: false
          }))

          // å¦‚æœæœ‰draftPrompt,æ·»åŠ ä¸ºæœ€åä¸€æ¡æ¶ˆæ¯
          if (draftPrompt.trim()) {
            loadedMessages.push({
              id: `msg-${Date.now()}-draft`,
              role: 'user',
              content: draftPrompt,
              isEditing: false
            })
          }

          messages.setMessagesState(loadedMessages)
        }
      } catch (e) {
        console.error('è§£æå¯¹è¯å†å²JSONå¤±è´¥:', e)
      }
    } else if (draftPrompt.trim()) {
      // æ²¡æœ‰å¯¹è¯å†å²ï¼Œä½†æœ‰è‰ç¨¿æç¤ºè¯
      messages.addMessage('user')
      const lastMsg = messages.messages[messages.messages.length - 1]
      messages.updateMessage(lastMsg.id, draftPrompt)
    }
  }

  // åŠ è½½ä¿å­˜çš„æ•°æ®
  useEffect(() => {
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä»"æˆ‘çš„"é¡µé¢åŠ è½½æ•°æ®
    const isLoadingFromLibrary = localStorage.getItem('yprompt_optimize_loaded_user_prompt')

    // å¦‚æœæ­£åœ¨ä»åº“åŠ è½½ï¼Œè·³è¿‡æœ¬åœ°ç¼–è¾‘æ•°æ®çš„åŠ è½½ï¼Œç­‰å¾…çˆ¶ç»„ä»¶è®¾ç½®props
    if (isLoadingFromLibrary) {
      return
    }

    // å¦åˆ™åŠ è½½ä¸Šæ¬¡ç¼–è¾‘çš„æ•°æ®
    try {
      const saved = localStorage.getItem(STORAGE_KEY)
      if (saved) {
        const data = JSON.parse(saved)
        if (data.messages) {
          messages.setMessagesState(data.messages)
        }
        if (data.systemPrompt) {
          setSystemPromptValue(data.systemPrompt)
          onUpdateSystemPrompt(data.systemPrompt)
        }
      }
    } catch (e) {
      console.error('åŠ è½½ä¿å­˜æ•°æ®å¤±è´¥:', e)
    }
  }, [])

  // ç›‘å¬propså˜åŒ–ï¼Œä»"æˆ‘çš„"é¡µé¢åŠ è½½æ—¶
  useEffect(() => {
    if (!isInternalUpdateRef.current) {
      loadFromConversationHistory()
    }
  }, [conversationHistory, draftPrompt])

  // ä¿å­˜æ•°æ®åˆ°localStorage
  const saveMessageData = () => {
    try {
      const data = {
        messages: messages.messages,
        systemPrompt: systemPromptValue
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
    } catch (e) {
      console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e)
    }
  }

  // ç›‘å¬systemPromptå˜åŒ–
  useEffect(() => {
    setSystemPromptValue(systemPrompt)
  }, [systemPrompt])

  // ç›‘å¬messageså˜åŒ–ï¼Œæ›´æ–°conversationHistoryå’ŒdraftPrompt
  useEffect(() => {
    isInternalUpdateRef.current = true

    // å¯¹è¯å†å²ï¼šå‰n-1æ¡æ¶ˆæ¯ï¼ˆæ’é™¤æœ€åä¸€æ¡ï¼Œå› ä¸ºæœ€åä¸€æ¡æ˜¯è¦ä¼˜åŒ–çš„è‰ç¨¿ï¼‰
    if (messages.messages.length > 1) {
      const contextMessages = messages.messages.slice(0, -1)
      const jsonMessages = contextMessages
        .filter((msg) => msg.content.trim())
        .map((msg) => ({
          role: msg.role === 'ai' ? 'assistant' : 'user',
          content: msg.content
        }))
      onUpdateConversationHistory(JSON.stringify(jsonMessages, null, 2))
    } else {
      onUpdateConversationHistory('')
    }

    // æ›´æ–°draftPromptä¸ºæœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆè¦ä¼˜åŒ–çš„è‰ç¨¿ï¼‰
    if (messages.messages.length > 0) {
      const lastMessage = messages.messages[messages.messages.length - 1]
      onUpdateDraftPrompt(lastMessage.content)
    } else {
      onUpdateDraftPrompt('')
    }

    saveMessageData()

    setTimeout(() => {
      isInternalUpdateRef.current = false
    }, 0)
  }, [messages.messages])

  const addMessageToConversation = () => {
    if (!inputText.trim()) return

    const roleToAdd = currentRole
    messages.addMessage(roleToAdd)
    const lastMessage = messages.messages[messages.messages.length - 1]
    messages.updateMessage(lastMessage.id, inputText)

    setInputText('')
  }

  const handleKeydown = (event: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && event.shiftKey) {
      return
    }

    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault()
      addMessageToConversation()
    }
  }

  const handleEditKeydown = (event: React.KeyboardEvent<HTMLTextAreaElement>, messageId: string) => {
    if (event.key === 'Enter' && event.shiftKey) {
      return
    }

    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault()
      messages.cancelEdit(messageId)
      saveMessageData()
    }

    if (event.key === 'Escape') {
      messages.cancelEdit(messageId)
    }
  }

  const handleOptimize = () => {
    if (messages.messages.length === 0 || isOptimizing) return
    onOptimize()
  }

  const handleRestart = () => {
    if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²ã€ç³»ç»Ÿæç¤ºè¯å’Œä¼˜åŒ–ç»“æœã€‚')) {
      messages.reset()
      setInputText('')
      setSystemPromptValue('')
      onUpdateDraftPrompt('')
      onUpdateSystemPrompt('')
      onUpdateConversationHistory('')
      onRestart()
      localStorage.removeItem(STORAGE_KEY)
    }
  }

  const handleSaveSystemPrompt = () => {
    onUpdateSystemPrompt(systemPromptValue)
    saveMessageData()
  }

  const copyMessage = async (content: string) => {
    try {
      await copyToClipboard(content)
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥:', err)
    }
  }

  const getLengthCategory = (length: number): string => {
    if (length <= 20) return 'çŸ­è‰ç¨¿'
    if (length <= 100) return 'ä¸­ç­‰è‰ç¨¿'
    if (length <= 300) return 'é•¿è‰ç¨¿'
    return 'è¶…é•¿è‰ç¨¿'
  }

  return (
    <>
      <div className="h-full flex flex-col bg-white rounded-lg shadow-sm border border-gray-200">
        {/* æ ‡é¢˜æ  */}
        <div className="p-4 border-b border-gray-200 flex-shrink-0">
          <div className="flex justify-between items-center">
            <h4 className="font-semibold text-gray-800">æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡</h4>
            <div className="flex items-center space-x-3">
              <button
                onClick={() => setShowSystemPromptModal(true)}
                className={`flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm ${
                  systemPromptValue.trim() ? 'text-green-600' : 'text-gray-400'
                }`}
                title={systemPromptValue.trim() ? 'ç³»ç»Ÿæç¤ºè¯å·²è®¾ç½®' : 'è®¾ç½®ç³»ç»Ÿæç¤ºè¯'}
              >
                <FileText className="w-4 h-4" />
                <span>{systemPromptValue.trim() ? 'ç³»ç»Ÿæç¤ºè¯å·²è®¾ç½®' : 'è®¾ç½®ç³»ç»Ÿæç¤ºè¯'}</span>
              </button>
              <button
                onClick={handleRestart}
                className="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                title="é‡æ–°å¼€å§‹"
              >
                <RefreshCw className="w-4 h-4" />
                <span>é‡æ–°å¼€å§‹</span>
              </button>
            </div>
          </div>
        </div>

        {/* å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
          {/* æ¶ˆæ¯å¡ç‰‡ */}
          {messages.messages.map((message) => (
            <div
              key={message.id}
              className={`flex group ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`flex flex-col w-full ${
                  message.isEditing ? 'max-w-full sm:max-w-2xl' : 'max-w-xs lg:max-w-md'
                }`}
              >
                <div
                  className={`flex gap-2 ${
                    message.role === 'user' ? 'flex-row-reverse' : 'flex-row'
                  } ${message.isEditing ? 'items-start' : ''}`}
                >
                  {/* å¤´åƒ */}
                  {!message.isEditing && (
                    <div className="flex-shrink-0">
                      <div
                        className={`w-8 h-8 rounded-full flex items-center justify-center text-sm ${
                          message.role === 'user'
                            ? 'bg-blue-100 text-blue-700'
                            : 'bg-gray-200 text-gray-700'
                        }`}
                      >
                        {message.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}
                      </div>
                    </div>
                  )}

                  {/* æ¶ˆæ¯å†…å®¹ */}
                  <div className="flex flex-col w-full">
                    {/* ç¼–è¾‘çŠ¶æ€ */}
                    {message.isEditing ? (
                      <div className="relative">
                        <div className="relative border border-blue-300 rounded-2xl overflow-hidden bg-white">
                          <textarea
                            value={message.content}
                            onChange={(e) => messages.updateMessage(message.id, e.target.value)}
                            onKeyDown={(e) => handleEditKeydown(e, message.id)}
                            className="w-full p-4 border-0 resize-none focus:outline-none text-gray-800 bg-white min-h-[80px] max-h-[200px] overflow-y-auto text-base"
                            placeholder="ç¼–è¾‘æ¶ˆæ¯å†…å®¹..."
                          />
                        </div>
                      </div>
                    ) : (
                      /* æ­£å¸¸æ˜¾ç¤ºçŠ¶æ€ */
                      <div
                        className={`rounded-lg px-4 py-3 transition-all duration-300 ${
                          message.role === 'user'
                            ? 'bg-blue-500 text-white ml-auto'
                            : 'bg-gray-100 text-gray-800 mr-auto'
                        }`}
                      >
                        {!message.content ? (
                          <div className="text-sm opacity-50">
                            {message.role === 'ai' ? 'è¾“å…¥AIåŠ©æ‰‹çš„å›å¤...' : 'è¾“å…¥ä½ çš„æ¶ˆæ¯...'}
                          </div>
                        ) : (
                          <div className="text-sm whitespace-pre-wrap break-words">{message.content}</div>
                        )}
                      </div>
                    )}

                    {/* æ“ä½œæŒ‰é’® */}
                    <div
                      className={`flex space-x-1 mt-2 transition-opacity duration-200 ${
                        message.isEditing
                          ? 'opacity-100 justify-end'
                          : `opacity-0 group-hover:opacity-100 ${message.role === 'user' ? 'justify-end' : 'justify-start'}`
                      }`}
                    >
                      {message.isEditing ? (
                        <>
                          <button
                            onClick={() => {
                              messages.cancelEdit(message.id)
                              saveMessageData()
                            }}
                            className="p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100"
                            title="å–æ¶ˆç¼–è¾‘"
                          >
                            <X className="w-3.5 h-3.5" />
                          </button>
                          <button
                            onClick={() => {
                              messages.cancelEdit(message.id)
                              saveMessageData()
                            }}
                            className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                            title="ä¿å­˜"
                          >
                            <Check className="w-3.5 h-3.5" />
                          </button>
                        </>
                      ) : (
                        <>
                          <button
                            onClick={() => {
                              messages.startEdit(message.id)
                            }}
                            className="p-1.5 text-gray-500 hover:text-green-600 transition-colors rounded-lg hover:bg-gray-100"
                            title="ç¼–è¾‘æ¶ˆæ¯"
                          >
                            <Edit2 className="w-3.5 h-3.5" />
                          </button>
                          <button
                            onClick={() => {
                              messages.updateMessageRole(message.id, message.role === 'user' ? 'ai' : 'user')
                              saveMessageData()
                            }}
                            className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                            title={message.role === 'user' ? 'åˆ‡æ¢ä¸ºAIåŠ©æ‰‹' : 'åˆ‡æ¢ä¸ºç”¨æˆ·'}
                          >
                            <ArrowLeftRight className="w-3.5 h-3.5" />
                          </button>
                          <button
                            onClick={() => {
                              messages.removeMessage(message.id)
                              saveMessageData()
                            }}
                            className="p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100"
                            title="åˆ é™¤æ¶ˆæ¯"
                          >
                            <Trash2 className="w-3.5 h-3.5" />
                          </button>
                          <button
                            onClick={() => copyMessage(message.content)}
                            className="p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100"
                            title="å¤åˆ¶å†…å®¹"
                          >
                            <Copy className="w-3.5 h-3.5" />
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}

          {/* ç©ºçŠ¶æ€ */}
          {messages.messages.length === 0 && (
            <div className="flex items-center justify-center h-full text-center py-12">
              <div>
                <MessageSquare className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                <p className="text-sm text-gray-500 mb-1">æš‚æ— å¯¹è¯å†å²</p>
                <p className="text-xs text-gray-400">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†æ·»åŠ å¯¹è¯æ¶ˆæ¯æ„å»ºä¸Šä¸‹æ–‡</p>
              </div>
            </div>
          )}
        </div>

        {/* è¾“å…¥åŒºåŸŸ */}
        <div className="p-3 border-t border-gray-200 bg-white flex-shrink-0 rounded-b-lg">
          {/* è§’è‰²é€‰æ‹© */}
          <div className="flex items-center gap-2 mb-2">
            <select
              value={currentRole}
              onChange={(e) => setCurrentRole(e.target.value as 'user' | 'ai')}
              className="text-xs px-2 py-1 border border-gray-300 rounded bg-white text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="user">ğŸ‘¤ ç”¨æˆ·</option>
              <option value="ai">ğŸ¤– AIåŠ©æ‰‹</option>
            </select>
            <span className="text-xs text-gray-500">
              {currentRole === 'user' ? 'ä»¥ç”¨æˆ·èº«ä»½å‘é€æ¶ˆæ¯' : 'ä»¥AIåŠ©æ‰‹èº«ä»½å‘é€æ¶ˆæ¯'}
            </span>
          </div>

          {/* è¾“å…¥æ¡† */}
          <div className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden" style={{ height: '120px' }}>
            <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
              <textarea
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyDown={handleKeydown}
                placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹ (Shift+Enteræ¢è¡Œ)"
                className="w-full h-full px-4 pt-3 pb-1 border-0 outline-none resize-none text-base overflow-y-auto bg-transparent text-gray-800"
                rows={1}
              />
            </div>

            <div className="absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent">
              <div className="text-xs text-gray-500 ml-2">
                {inputText.length} å­—
                {inputText.length > 0 && (
                  <span className="ml-2 text-blue-600">Â· {getLengthCategory(inputText.length)}</span>
                )}
              </div>

              <div className="flex gap-2">
                <button
                  onClick={addMessageToConversation}
                  disabled={!inputText.trim()}
                  className="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center"
                  title="å‘é€æ¶ˆæ¯åˆ°å¯¹è¯å†å²"
                >
                  <ArrowUp className="w-4 h-4" />
                </button>

                <button
                  onClick={handleOptimize}
                  disabled={messages.messages.length === 0 || isOptimizing}
                  className="px-4 py-1.5 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white text-sm rounded-full transition-colors disabled:cursor-not-allowed"
                  title="å¼€å§‹ä¼˜åŒ–æœ€åä¸€æ¡æ¶ˆæ¯"
                >
                  {isOptimizing ? 'ä¼˜åŒ–ä¸­...' : 'ä¼˜åŒ–'}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ç³»ç»Ÿæç¤ºè¯æ¨¡æ€æ¡† */}
      {showSystemPromptModal && (
        <SystemPromptModal
          isOpen={showSystemPromptModal}
          modelValue={systemPromptValue}
          onUpdateModelValue={setSystemPromptValue}
          onClose={() => setShowSystemPromptModal(false)}
          onSave={handleSaveSystemPrompt}
        />
      )}
    </>
  )
}

```


## src/components/modules/optimize/components/quick/QuickOptimizeResult.tsx

```tsx
import { useState } from 'react'
import {
  Sparkles,
  Clock,
  ArrowRight,
  Copy,
  Save,
  RotateCw,
  GitCompare,
  ChevronDown
} from 'lucide-react'
import type { QuickOptimizeResult } from '@/hooks/useUserPromptQuickOptimize'

interface Props {
  result: QuickOptimizeResult
  onCopy: (text: string) => void
  onSave: () => void
  onRetry: () => void
}

export default function QuickOptimizeResult({ result, onCopy, onSave, onRetry }: Props) {
  const [showComparison, setShowComparison] = useState(false)

  const optimizedPromptText = typeof result.optimizedPrompt === 'string'
    ? result.optimizedPrompt
    : result.optimizedPrompt.zh || result.optimizedPrompt.en

  return (
    <div className="space-y-4">
      {/* å¤´éƒ¨ */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Sparkles className="w-5 h-5 text-green-600 dark:text-green-400" />
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">ä¼˜åŒ–ç»“æœ</h3>
        </div>
        <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
          <Clock className="w-3 h-3" />
          <span>{result.metadata.processingTime.toFixed(0)}ms</span>
        </div>
      </div>

      {/* é•¿åº¦å˜åŒ–æç¤º */}
      <div className="flex items-center gap-2 text-sm">
        <span className="text-gray-600 dark:text-gray-400">
          {result.originalPrompt.length} å­—
        </span>
        <ArrowRight className="w-4 h-4 text-gray-400" />
        <span className="font-medium text-green-600 dark:text-green-400">
          {optimizedPromptText.length} å­—
        </span>
        <span className="text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
          {(optimizedPromptText.length / result.originalPrompt.length).toFixed(1)}x
        </span>
      </div>

      {/* ä¸¤æ®µå¼ç»“æœå±•ç¤º */}
      <div className="space-y-3">
        {/* 1. è´¨é‡åˆ†æ */}
        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
            <span className="text-sm font-medium text-blue-900 dark:text-blue-300">è´¨é‡åˆ†æ</span>
          </div>
          <p className="text-sm text-blue-800 dark:text-blue-200 whitespace-pre-wrap">
            {result.qualityAnalysis.analysis}
          </p>
        </div>

        {/* 2. ä¼˜åŒ–ç»“æœ */}
        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            <span className="text-sm font-medium text-green-900 dark:text-green-300">ä¼˜åŒ–ç»“æœ</span>
          </div>
          <div className="prose dark:prose-invert max-w-none">
            <p className="text-sm text-green-800 dark:text-green-200 whitespace-pre-wrap">
              {optimizedPromptText}
            </p>
          </div>
        </div>
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex items-center gap-3">
        <button
          onClick={() => onCopy(optimizedPromptText)}
          className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center gap-2 font-medium"
        >
          <Copy className="w-4 h-4" />
          <span>å¤åˆ¶ç»“æœ</span>
        </button>
        <button
          onClick={onSave}
          className="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors flex items-center justify-center gap-2 font-medium"
        >
          <Save className="w-4 h-4" />
          <span>ä¿å­˜</span>
        </button>
        <button
          onClick={onRetry}
          className="px-4 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors flex items-center justify-center gap-2"
        >
          <RotateCw className="w-4 h-4" />
          <span>é‡è¯•</span>
        </button>
      </div>

      {/* å¯¹æ¯”æŸ¥çœ‹ */}
      <div className="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
        <button
          onClick={() => setShowComparison(!showComparison)}
          className="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-750 flex items-center justify-between transition-colors"
        >
          <span className="text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
            <GitCompare className="w-4 h-4" />
            ä¼˜åŒ–å‰åå¯¹æ¯”
          </span>
          <ChevronDown
            className={`w-4 h-4 text-gray-500 transition-transform ${
              showComparison && 'transform rotate-180'
            }`}
          />
        </button>

        {showComparison && (
          <div className="p-4 bg-white dark:bg-gray-700 space-y-4">
            {/* åŸå§‹æç¤ºè¯ */}
            <div>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-2 h-2 bg-red-500 rounded-full"></div>
                <span className="text-xs font-medium text-gray-600 dark:text-gray-400">ä¼˜åŒ–å‰</span>
                <span className="text-xs text-gray-500">{result.originalPrompt.length} å­—</span>
              </div>
              <div className="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-lg p-3">
                <p className="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                  {result.originalPrompt}
                </p>
              </div>
            </div>

            {/* ä¼˜åŒ–åçš„æç¤ºè¯ */}
            <div>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                <span className="text-xs font-medium text-gray-600 dark:text-gray-400">ä¼˜åŒ–å</span>
                <span className="text-xs text-gray-500">{optimizedPromptText.length} å­—</span>
              </div>
              <div className="bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800 rounded-lg p-3">
                <p className="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                  {optimizedPromptText}
                </p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
```


## src/components/modules/optimize/components/quick/SystemPromptModal.tsx

```tsx
import { X } from 'lucide-react'

interface SystemPromptModalProps {
  isOpen: boolean
  modelValue: string
  onUpdateModelValue: (value: string) => void
  onClose: () => void
  onSave: () => void
}

export default function SystemPromptModal({
  isOpen,
  modelValue,
  onUpdateModelValue,
  onClose,
  onSave
}: SystemPromptModalProps) {
  if (!isOpen) return null

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col"
        onClick={(e) => e.stopPropagation()}
      >
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-4 border-b border-gray-200">
          <h3 className="text-lg font-semibold text-gray-900">ç³»ç»Ÿæç¤ºè¯è®¾ç½®</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* å†…å®¹ */}
        <div className="flex-1 overflow-y-auto p-4">
          <p className="text-sm text-gray-600 mb-3">
            è®¾ç½®ç³»ç»Ÿæç¤ºè¯å¯ä»¥å¸®åŠ©AIæ›´å¥½åœ°ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæä¾›æ›´å‡†ç¡®çš„ä¼˜åŒ–å»ºè®®ã€‚
          </p>
          <textarea
            value={modelValue}
            onChange={(e) => onUpdateModelValue(e.target.value)}
            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white text-gray-900"
            rows={8}
            placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ“…é•¿è§£å†³ä»£ç é—®é¢˜å’Œæä¾›æŠ€æœ¯å»ºè®®ã€‚"
          />
        </div>

        {/* åº•éƒ¨ */}
        <div className="flex items-center justify-end gap-3 p-4 border-t border-gray-200">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={() => {
              onSave()
              onClose()
            }}
            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>
  )
}

```


## src/components/modules/optimize/components/quick/UserPromptQuickOptimize.tsx

```tsx
import { useState, useEffect, useMemo } from 'react'
import { Sparkles, Copy, Check, RefreshCw, ArrowLeftRight } from 'lucide-react'
import { useUserPromptQuickOptimize } from '@/hooks/useUserPromptQuickOptimize'
import { useNotificationStore } from '@/stores/notificationStore'
import QuickOptimizeInput from './QuickOptimizeInput'
import SaveUserPromptDialog from '../dialogs/SaveUserPromptDialog'

const ACTIVE_TAB_KEY = 'yprompt_user_optimize_active_tab'

export default function UserPromptQuickOptimize() {
  const optimizeState = useUserPromptQuickOptimize()
  const notificationStore = useNotificationStore()

  const [activeTab, setActiveTab] = useState<'analysis' | 'result'>('analysis')
  const [copied, setCopied] = useState(false)
  const [saving, setSaving] = useState(false)
  const [editablePrompt, setEditablePrompt] = useState('')
  const [showSaveDialog, setShowSaveDialog] = useState(false)

  // ä»localStorageæ¢å¤activeTab
  useEffect(() => {
    try {
      const savedTab = localStorage.getItem(ACTIVE_TAB_KEY)
      if (savedTab && ['analysis', 'result'].includes(savedTab)) {
        setActiveTab(savedTab as 'analysis' | 'result')
      }
    } catch (e) {
      console.error('è¯»å–activeTabå¤±è´¥:', e)
    }
  }, [])

  // ä¼˜åŒ–é˜¶æ®µï¼š0-æœªå¼€å§‹ï¼Œ1-åˆ†æä¸­æˆ–åˆ†æå®Œæˆï¼Œ2-å…¨éƒ¨å®Œæˆ
  const optimizationStage = useMemo(() => {
    if (!optimizeState.state.isOptimizing && !optimizeState.hasResult) return 0

    // å¦‚æœç¦ç”¨è´¨é‡åˆ†æï¼Œç›´æ¥è¿›å…¥é˜¶æ®µ2
    if (!optimizeState.state.enableQualityAnalysis) {
      return optimizeState.state.isOptimizingPrompt || optimizeState.hasResult ? 2 : 0
    }

    // å¯ç”¨è´¨é‡åˆ†æçš„æƒ…å†µ
    if (optimizeState.state.isAnalyzing) return 1
    if (
      !optimizeState.state.isAnalyzing &&
      (optimizeState.state.isOptimizingPrompt || optimizeState.hasResult)
    )
      return 2
    return 0
  }, [
    optimizeState.state.isOptimizing,
    optimizeState.hasResult,
    optimizeState.state.enableQualityAnalysis,
    optimizeState.state.isAnalyzing,
    optimizeState.state.isOptimizingPrompt
  ])

  const handleOptimize = async () => {
    // æ ¹æ®è´¨é‡åˆ†æå¼€å…³è®¾ç½®åˆå§‹tab
    const newTab = optimizeState.state.enableQualityAnalysis ? 'analysis' : 'result'
    setActiveTab(newTab)
    localStorage.setItem(ACTIVE_TAB_KEY, newTab)
    await optimizeState.quickOptimize()
  }

  const handleRegenerate = async () => {
    // ç›´æ¥åˆ‡æ¢åˆ°ç»“æœTabï¼ˆå› ä¸ºä¸éœ€è¦é‡æ–°åˆ†æï¼‰
    setActiveTab('result')
    localStorage.setItem(ACTIVE_TAB_KEY, 'result')
    await optimizeState.regenerateOptimization()
  }

  const handleCopy = async (text: string) => {
    const success = await optimizeState.copyToClipboard(text)
    if (success) {
      setCopied(true)
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
      setTimeout(() => setCopied(false), 2000)
    } else {
      notificationStore.error('å¤åˆ¶å¤±è´¥')
    }
  }

  // æ‰“å¼€ä¿å­˜å¼¹çª—
  const handleSave = () => {
    setShowSaveDialog(true)
  }

  // å®é™…ä¿å­˜æ“ä½œ
  const handleConfirmSave = async (saveData: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    systemPrompt: string
    conversationHistory: string
  }) => {
    setSaving(true)
    try {
      const result = await optimizeState.saveToLibrary(saveData)

      // æ ¹æ®è¿”å›ç»“æœæ˜¾ç¤ºä¸åŒçš„æç¤º
      if (typeof result === 'object' && result.version) {
        // æ›´æ–°ç°æœ‰æç¤ºè¯ï¼Œæ˜¾ç¤ºç‰ˆæœ¬å·
        notificationStore.success(`æç¤ºè¯å·²æ›´æ–°è‡³ç‰ˆæœ¬ ${result.version}`)
      } else {
        // æ–°å»ºæç¤ºè¯
        notificationStore.success('å·²ä¿å­˜åˆ°æˆ‘çš„æç¤ºè¯')
      }

      setShowSaveDialog(false)
    } catch (error: any) {
      notificationStore.error(error.message || 'ä¿å­˜å¤±è´¥')
    } finally {
      setSaving(false)
    }
  }

  // å–æ¶ˆä¿å­˜
  const handleCancelSave = () => {
    setShowSaveDialog(false)
  }

  // è´¨é‡åˆ†æå®Œæˆåè‡ªåŠ¨åˆ‡æ¢åˆ°ç»“æœTab
  useEffect(() => {
    if (
      !optimizeState.state.isAnalyzing &&
      optimizeState.state.isOptimizingPrompt &&
      activeTab === 'analysis'
    ) {
      // åˆ†æåˆšå®Œæˆï¼Œå¼€å§‹ä¼˜åŒ–ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç»“æœTab
      setTimeout(() => {
        setActiveTab('result')
        localStorage.setItem(ACTIVE_TAB_KEY, 'result')
      }, 300)
    }
  }, [optimizeState.state.isAnalyzing, optimizeState.state.isOptimizingPrompt, activeTab])

  // ç›‘å¬activeTabå˜åŒ–ï¼Œä¿å­˜åˆ°localStorage
  useEffect(() => {
    try {
      localStorage.setItem(ACTIVE_TAB_KEY, activeTab)
    } catch (e) {
      console.error('ä¿å­˜activeTabå¤±è´¥:', e)
    }
  }, [activeTab])

  // å½“å‰æ˜¾ç¤ºçš„æç¤ºè¯ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œå¯¹è±¡æ ¼å¼ï¼‰
  const currentOptimizedPrompt = useMemo(() => {
    if (!optimizeState.state.result?.optimizedPrompt) return ''

    if (typeof optimizeState.state.result.optimizedPrompt === 'string') {
      return optimizeState.state.result.optimizedPrompt
    }

    return optimizeState.state.languageState === 'zh'
      ? optimizeState.state.result.optimizedPrompt.zh
      : optimizeState.state.result.optimizedPrompt.en
  }, [optimizeState.state.result, optimizeState.state.languageState])

  // åŒæ­¥ä¼˜åŒ–ç»“æœåˆ°å¯ç¼–è¾‘æ–‡æœ¬æ¡†
  useEffect(() => {
    if (currentOptimizedPrompt) {
      setEditablePrompt(currentOptimizedPrompt)
    }
  }, [currentOptimizedPrompt])

  // è¾…åŠ©å‡½æ•°ï¼šè¯„åˆ†é¢œè‰²
  const getScoreClass = (score: number): string => {
    if (score >= 90) return 'text-green-600'
    if (score >= 70) return 'text-blue-600'
    if (score >= 50) return 'text-yellow-600'
    return 'text-red-600'
  }

  const getScoreBarClass = (score: number): string => {
    if (score >= 90) return 'bg-green-500'
    if (score >= 70) return 'bg-blue-500'
    if (score >= 50) return 'bg-yellow-500'
    return 'bg-red-500'
  }

  // ç»´åº¦æ ‡ç­¾æ˜ å°„
  const getAnalysisLabel = (key: string): string => {
    const labels: Record<string, string> = {
      clarity: 'æ¸…æ™°åº¦',
      specificity: 'ç‰¹å®šæ€§',
      structure: 'ç»“æ„',
      context: 'ä¸Šä¸‹æ–‡',
      completeness: 'å®Œæ•´æ€§'
    }
    return labels[key] || key
  }

  // è¯­è¨€è½¬æ¢
  const handleToggleLanguage = async () => {
    try {
      await optimizeState.toggleLanguage()
      notificationStore.success('è¯­è¨€è½¬æ¢æˆåŠŸ')
    } catch (error: any) {
      notificationStore.error(error.message || 'è¯­è¨€è½¬æ¢å¤±è´¥')
    }
  }

  // é‡æ–°å¼€å§‹ - æ¸…é™¤æ‰€æœ‰æ•°æ®
  const handleRestart = () => {
    // æ¸…é™¤ä¼˜åŒ–ç»“æœ
    optimizeState.clearResult()

    // é‡ç½®UIçŠ¶æ€
    setActiveTab('analysis')
    localStorage.setItem(ACTIVE_TAB_KEY, 'analysis')
    setCopied(false)
    setEditablePrompt('')

    notificationStore.success('å·²é‡ç½®æ‰€æœ‰æ•°æ®')
  }

  // å¤„ç†ç”¨æˆ·æç¤ºè¯å¯¹æ¯”
  const handleCompare = () => {
    if (
      !optimizeState.state.draftPrompt ||
      !optimizeState.hasResult ||
      !optimizeState.state.result
    ) {
      notificationStore.warning('éœ€è¦å…ˆå®Œæˆä¼˜åŒ–æ‰èƒ½å¯¹æ¯”')
      return
    }

    // è·å–ä¼˜åŒ–åçš„æç¤ºè¯
    const optimizedPrompt =
      typeof optimizeState.state.result.optimizedPrompt === 'string'
        ? optimizeState.state.result.optimizedPrompt
        : optimizeState.state.languageState === 'zh'
        ? optimizeState.state.result.optimizedPrompt.zh
        : optimizeState.state.result.optimizedPrompt.en

    // é€šè¿‡ localStorage ä¼ é€’æ•°æ®ç»™ ComparisonPanel
    const comparisonData = {
      mode: 'user',
      systemPrompt: optimizeState.state.systemPrompt || '',
      originalPrompt: optimizeState.state.draftPrompt,
      optimizedPrompt: optimizedPrompt,
      conversationHistory: optimizeState.state.conversationHistory || ''
    }

    localStorage.setItem('yprompt_comparison_data', JSON.stringify(comparisonData))
    localStorage.setItem('yprompt_trigger_compare', 'true')
    console.log('ğŸ”µ å‡†å¤‡ç”¨æˆ·æç¤ºè¯å¯¹æ¯”:', comparisonData)
  }

  // ä»localStorageåŠ è½½ä»"æˆ‘çš„"é¡µé¢ä¼ é€’è¿‡æ¥çš„ç”¨æˆ·æç¤ºè¯
  useEffect(() => {
    const loadUserPromptFromLibrary = () => {
      try {
        const savedData = localStorage.getItem('yprompt_optimize_loaded_user_prompt')
        if (savedData) {
          const data = JSON.parse(savedData)
          console.log('ğŸŸ¢ UserPromptQuickOptimize: ä»åº“åŠ è½½æ•°æ®:', {
            draftPrompt: data.draftPrompt?.substring(0, 50),
            systemPrompt: data.systemPrompt?.substring(0, 50),
            conversationHistory: data.conversationHistory?.substring(0, 50)
          })

          optimizeState.setDraftPrompt(data.draftPrompt || '')
          optimizeState.setSystemPrompt(data.systemPrompt || '')
          optimizeState.setConversationHistory(data.conversationHistory || '')

          console.log('ğŸŸ¢ å·²è®¾ç½®åˆ°optimizeState:', {
            draftPrompt: optimizeState.state.draftPrompt?.substring(0, 50),
            systemPrompt: optimizeState.state.systemPrompt?.substring(0, 50),
            conversationHistory: optimizeState.state.conversationHistory?.substring(0, 50)
          })

          // æ¸…é™¤localStorageï¼Œé¿å…é‡å¤åŠ è½½
          localStorage.removeItem('yprompt_optimize_loaded_user_prompt')
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·æç¤ºè¯å¤±è´¥:', e)
      }
    }

    loadUserPromptFromLibrary()

    // ç›‘å¬localStorageå˜åŒ–ï¼ˆå¤„ç†çˆ¶ç»„ä»¶å¼‚æ­¥åŠ è½½çš„æƒ…å†µï¼‰
    const handleStorageChange = () => {
      const newValue = localStorage.getItem('yprompt_optimize_loaded_user_prompt')
      if (newValue) {
        requestAnimationFrame(() => {
          loadUserPromptFromLibrary()
        })
      }
    }

    window.addEventListener('storage', handleStorageChange)
    // ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬ï¼ˆå› ä¸ºåŒæºé¡µé¢localStorageå˜åŒ–ä¸ä¼šè§¦å‘storageäº‹ä»¶ï¼‰
    const interval = setInterval(() => {
      const newValue = localStorage.getItem('yprompt_optimize_loaded_user_prompt')
      if (newValue) {
        loadUserPromptFromLibrary()
      }
    }, 100)

    return () => {
      window.removeEventListener('storage', handleStorageChange)
      clearInterval(interval)
    }
  }, [optimizeState])

  return (
    <>
      <div className="h-full min-h-0 overflow-hidden grid grid-cols-2 gap-4">
        {/* è¾“å…¥åŒº */}
        <div className="flex flex-col min-h-0">
          <QuickOptimizeInput
            draftPrompt={optimizeState.state.draftPrompt}
            systemPrompt={optimizeState.state.systemPrompt}
            conversationHistory={optimizeState.state.conversationHistory}
            isOptimizing={optimizeState.state.isOptimizing}
            onUpdateDraftPrompt={optimizeState.setDraftPrompt}
            onUpdateSystemPrompt={optimizeState.setSystemPrompt}
            onUpdateConversationHistory={optimizeState.setConversationHistory}
            onOptimize={handleOptimize}
            onRestart={handleRestart}
          />
        </div>

        {/* ç»“æœåŒº */}
        <div className="flex flex-col min-h-0">
          <div className="bg-white rounded-lg shadow-sm flex flex-col h-full min-h-0 overflow-hidden">
            {/* é¢„è§ˆå¤´éƒ¨ */}
            <div className="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
              <h4 className="font-semibold text-gray-800">ä¼˜åŒ–é¢„è§ˆ</h4>
              <div className="flex items-center space-x-2">
                <label className="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={optimizeState.state.enableQualityAnalysis}
                    onChange={(e) => optimizeState.setEnableQualityAnalysis(e.target.checked)}
                    disabled={optimizeState.state.isOptimizing}
                    className="sr-only peer"
                  />
                  <span className="text-sm text-gray-600 mr-2">è´¨é‡åˆ†æï¼š</span>
                  <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                </label>
              </div>
            </div>

            {/* ç©ºçŠ¶æ€ */}
            {optimizationStage === 0 && (
              <div className="flex-1 flex flex-col min-h-0 overflow-hidden p-4">
                <div className="flex-1 flex items-center justify-center">
                  <div className="text-center text-gray-400">
                    <Sparkles className="w-16 h-16 mx-auto mb-4 opacity-50" />
                    <p className="text-sm">è¾“å…¥è‰ç¨¿æç¤ºè¯åç‚¹å‡»"å¼€å§‹ä¼˜åŒ–"</p>
                  </div>
                </div>
              </div>
            )}

            {/* æœ‰ç»“æœæˆ–æ­£åœ¨ä¼˜åŒ– */}
            {optimizationStage >= 1 && (
              <div className="flex-1 flex flex-col min-h-0 overflow-hidden p-4">
                {/* Tab Containerï¼ˆä»…åœ¨å¯ç”¨è´¨é‡åˆ†ææ—¶æ˜¾ç¤ºï¼‰ */}
                {optimizeState.state.enableQualityAnalysis && (
                  <div className="flex space-x-2 mb-4 flex-shrink-0">
                    <button
                      onClick={() => setActiveTab('analysis')}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors text-sm ${
                        activeTab === 'analysis'
                          ? 'bg-blue-500 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      è´¨é‡åˆ†æ
                    </button>
                    {optimizationStage >= 2 && (
                      <button
                        onClick={() => setActiveTab('result')}
                        className={`px-4 py-2 rounded-lg font-medium transition-colors text-sm ${
                          activeTab === 'result'
                            ? 'bg-green-500 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        ä¼˜åŒ–ç»“æœ
                      </button>
                    )}
                  </div>
                )}

                {/* è´¨é‡åˆ†æTabï¼ˆä»…åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰ */}
                {optimizeState.state.enableQualityAnalysis && activeTab === 'analysis' && (
                  <div className="flex-1 flex flex-col min-h-0">
                    {/* æµå¼è¾“å‡ºä¸­ */}
                    {optimizeState.state.isAnalyzing ? (
                      <div className="flex-1 flex flex-col overflow-hidden">
                        <div className="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4">
                          <pre className="text-xs text-gray-700 whitespace-pre-wrap font-mono">
                            {optimizeState.state.analysisText || 'AIæ­£åœ¨åˆ†æä¸­...'}
                          </pre>
                        </div>
                      </div>
                    ) : (
                      /* åˆ†æå®Œæˆ */
                      optimizeState.hasResult &&
                      optimizeState.state.result && (
                        <div className="flex-1 flex flex-col min-h-0">
                          <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                            {/* æ•´ä½“è¯„åˆ† */}
                            <div className="border border-gray-200 rounded-lg p-4">
                              <div className="flex items-center justify-between mb-3">
                                <h4 className="text-sm font-medium text-gray-700">æ•´ä½“è¯„åˆ†</h4>
                                <span
                                  className={`text-2xl font-bold ${getScoreClass(
                                    optimizeState.state.result.qualityAnalysis.overall_score
                                  )}`}
                                >
                                  {optimizeState.state.result.qualityAnalysis.overall_score}/100
                                </span>
                              </div>
                              <div className="w-full bg-gray-200 rounded-full h-3">
                                <div
                                  className={`h-3 rounded-full transition-all duration-500 ${getScoreBarClass(
                                    optimizeState.state.result.qualityAnalysis.overall_score
                                  )}`}
                                  style={{
                                    width: `${optimizeState.state.result.qualityAnalysis.overall_score}%`
                                  }}
                                ></div>
                              </div>
                            </div>

                            {/* è¯¦ç»†åˆ†æç»´åº¦ */}
                            <div className="grid grid-cols-2 gap-3">
                              {Object.entries(optimizeState.state.result.qualityAnalysis.analysis).map(
                                ([key, item]) => {
                                  if (!item) return null
                                  return (
                                    <div
                                      key={key}
                                      className="border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow"
                                    >
                                      <div className="flex items-center justify-between mb-2">
                                        <span className="text-xs font-medium text-gray-700">
                                          {getAnalysisLabel(key)}
                                        </span>
                                        <span className={`text-lg font-bold ${getScoreClass(item.score)}`}>
                                          {item.score}
                                        </span>
                                      </div>
                                      <p className="text-xs text-gray-600">{item.feedback}</p>
                                    </div>
                                  )
                                }
                              )}
                            </div>

                            {/* å…·ä½“é—®é¢˜åˆ†æ */}
                            {optimizeState.state.result.qualityAnalysis.issues &&
                              optimizeState.state.result.qualityAnalysis.issues.length > 0 && (
                                <div className="border border-orange-200 bg-orange-50 rounded-lg p-4">
                                  <h4 className="text-sm font-semibold text-orange-900 mb-3 flex items-center">
                                    <svg
                                      className="w-4 h-4 mr-2"
                                      fill="none"
                                      stroke="currentColor"
                                      viewBox="0 0 24 24"
                                    >
                                      <path
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                        strokeWidth="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                      ></path>
                                    </svg>
                                    å‘ç°çš„å…·ä½“é—®é¢˜
                                  </h4>
                                  <ul className="space-y-2">
                                    {optimizeState.state.result.qualityAnalysis.issues.map((issue, idx) => (
                                      <li key={idx} className="text-sm text-orange-800 flex items-start">
                                        <span className="text-orange-600 mr-2 flex-shrink-0">{idx + 1}.</span>
                                        <span className="flex-1">{issue}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                          </div>
                        </div>
                      )
                    )}
                  </div>
                )}

                {/* ä¼˜åŒ–ç»“æœTabï¼ˆç¦ç”¨è´¨é‡åˆ†ææ—¶ç›´æ¥æ˜¾ç¤ºï¼Œå¯ç”¨æ—¶é€šè¿‡tabåˆ‡æ¢ï¼‰ */}
                {(!optimizeState.state.enableQualityAnalysis || activeTab === 'result') && (
                  <div className="flex-1 flex flex-col min-h-0">
                    {/* æµå¼è¾“å‡ºä¸­ */}
                    {optimizeState.state.isOptimizingPrompt ? (
                      <div className="flex-1 flex flex-col overflow-hidden">
                        <div className="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4">
                          <pre className="text-xs text-gray-700 whitespace-pre-wrap font-mono">
                            {optimizeState.state.optimizedText || 'AIæ­£åœ¨ä¼˜åŒ–ä¸­...'}
                          </pre>
                        </div>
                      </div>
                    ) : (
                      /* ä¼˜åŒ–å®Œæˆ */
                      optimizeState.hasResult &&
                      optimizeState.state.result && (
                        <div className="border rounded-lg overflow-hidden flex flex-col flex-1">
                          {/* è“è‰²å¤´éƒ¨ */}
                          <div className="bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 flex items-center justify-between flex-shrink-0">
                            <span>æœ€ç»ˆæç¤ºè¯</span>
                            <div className="flex items-center space-x-2">
                              <button
                                onClick={handleRegenerate}
                                disabled={optimizeState.state.isOptimizing}
                                className="text-blue-500 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="é‡æ–°ç”Ÿæˆ"
                              >
                                <RefreshCw
                                  className={`w-4 h-4 ${optimizeState.state.isOptimizing ? 'animate-spin' : ''}`}
                                />
                              </button>
                              <button
                                onClick={() => handleCopy(currentOptimizedPrompt)}
                                className="text-blue-500 hover:text-blue-600"
                                title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
                              >
                                {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                              </button>
                            </div>
                          </div>

                          {/* å†…å®¹åŒº */}
                          <div className="p-3 bg-white flex-1 flex flex-col overflow-hidden">
                            <textarea
                              value={editablePrompt}
                              onChange={(e) => setEditablePrompt(e.target.value)}
                              className="w-full flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none"
                            />

                            {/* åº•éƒ¨æŒ‰é’® */}
                            {currentOptimizedPrompt && (
                              <div className="space-y-2 pt-4 flex-shrink-0">
                                {/* ç¬¬ä¸€è¡Œï¼šè¯­è¨€è½¬æ¢ã€ä¿å­˜ */}
                                <div className="flex space-x-2">
                                  <button
                                    onClick={handleToggleLanguage}
                                    disabled={optimizeState.state.isConvertingLanguage}
                                    className="flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                  >
                                    {optimizeState.state.isConvertingLanguage && (
                                      <RefreshCw className="w-4 h-4 animate-spin" />
                                    )}
                                    <span>
                                      {optimizeState.state.isConvertingLanguage
                                        ? 'è½¬æ¢ä¸­...'
                                        : optimizeState.state.languageState === 'zh'
                                        ? 'è½¬ä¸ºè‹±æ–‡'
                                        : 'è½¬ä¸ºä¸­æ–‡'}
                                    </span>
                                  </button>
                                  <button
                                    onClick={handleSave}
                                    disabled={saving}
                                    className="flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                  >
                                    {saving && <RefreshCw className="w-4 h-4 animate-spin" />}
                                    <span>{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜åˆ°æ•°æ®åº“'}</span>
                                  </button>
                                </div>
                                {/* ç¬¬äºŒè¡Œï¼šå¯¹æ¯”æŒ‰é’® */}
                                <div className="flex">
                                  <button
                                    onClick={handleCompare}
                                    className="w-full flex items-center justify-center space-x-1 px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                  >
                                    <ArrowLeftRight className="w-4 h-4" />
                                    <span>å¯¹æ¯”ä¼˜åŒ–æ•ˆæœ</span>
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      )
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ä¿å­˜ç”¨æˆ·æç¤ºè¯å¼¹çª— */}
      {showSaveDialog && (
        <SaveUserPromptDialog
          isOpen={showSaveDialog}
          promptContent={currentOptimizedPrompt}
          systemPrompt={optimizeState.state.systemPrompt}
          conversationHistory={optimizeState.state.conversationHistory}
          isSaving={saving}
          onSave={handleConfirmSave}
          onCancel={handleCancelSave}
        />
      )}
    </>
  )
}

```


## src/components/modules/optimize/hooks/useComparison.ts

```ts
// Reactç‰ˆæœ¬çš„useComparison hook
import { useState, useCallback } from 'react'
import { AIService } from '@/services/aiService'
import { useProviderStore } from '@/stores/providerStore'
import type { ProviderConfig, ModelConfig } from '@/stores/providerStore'

export type ComparisonMode = 'system' | 'user'

export interface ChatMessage {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
  isStreaming?: boolean
}

export interface SystemComparisonConfig {
  leftSystemPrompt: string
  rightSystemPrompt: string
  sharedUserInput: string
}

export interface UserComparisonConfig {
  sharedSystemPrompt: string
  leftUserPrompt: string
  rightUserPrompt: string
}

interface ComparisonState {
  mode: ComparisonMode
  systemConfig: SystemComparisonConfig
  leftMessages: ChatMessage[]
  rightMessages: ChatMessage[]
  userConfig: UserComparisonConfig
  leftUserMessages: ChatMessage[]
  rightUserMessages: ChatMessage[]
  isLeftGenerating: boolean
  isRightGenerating: boolean
}

export function useComparison() {
  const aiService = AIService.getInstance()
  const currentProvider = useProviderStore((state) => state.currentProvider)
  const currentModel = useProviderStore((state) => state.currentModel)

  const [state, setState] = useState<ComparisonState>({
    mode: 'system',
    systemConfig: {
      leftSystemPrompt: '',
      rightSystemPrompt: '',
      sharedUserInput: ''
    },
    leftMessages: [],
    rightMessages: [],
    userConfig: {
      sharedSystemPrompt: '',
      leftUserPrompt: '',
      rightUserPrompt: ''
    },
    leftUserMessages: [],
    rightUserMessages: [],
    isLeftGenerating: false,
    isRightGenerating: false
  })

  const isGenerating = state.isLeftGenerating || state.isRightGenerating

  const initSystemComparison = useCallback((originalPrompt: string, optimizedPrompt: string) => {
    setState(prev => ({
      ...prev,
      mode: 'system',
      systemConfig: {
        leftSystemPrompt: originalPrompt,
        rightSystemPrompt: optimizedPrompt,
        sharedUserInput: ''
      },
      leftMessages: [],
      rightMessages: []
    }))
  }, [])

  const initUserComparison = useCallback((
    systemPrompt: string,
    originalUserPrompt: string,
    optimizedUserPrompt: string
  ) => {
    setState(prev => ({
      ...prev,
      mode: 'user',
      userConfig: {
        sharedSystemPrompt: systemPrompt,
        leftUserPrompt: originalUserPrompt,
        rightUserPrompt: optimizedUserPrompt
      },
      leftUserMessages: [],
      rightUserMessages: []
    }))
  }, [])

  const callAI = useCallback(async (
    side: 'left' | 'right',
    systemPrompt: string,
    messages: ChatMessage[],
    customProvider?: ProviderConfig,
    customModel?: ModelConfig
  ) => {
    const provider = customProvider || currentProvider
    const model = customModel || currentModel

    if (!provider || !model) {
      throw new Error('è¯·å…ˆé€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
    }

    // è®¾ç½®ç”ŸæˆçŠ¶æ€
    setState(prev => ({
      ...prev,
      ...(side === 'left' ? { isLeftGenerating: true } : { isRightGenerating: true })
    }))

    // åˆ›å»ºAIå“åº”æ¶ˆæ¯
    const aiMessageId = `${side}-ai-${Date.now()}`
    const aiMsg: ChatMessage = {
      id: aiMessageId,
      role: 'assistant',
      content: '',
      timestamp: new Date(),
      isStreaming: true
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°çŠ¶æ€
    if (state.mode === 'system') {
      setState(prev => ({
        ...prev,
        ...(side === 'left' 
          ? { leftMessages: [...prev.leftMessages, aiMsg] }
          : { rightMessages: [...prev.rightMessages, aiMsg] })
      }))
    } else {
      setState(prev => ({
        ...prev,
        ...(side === 'left'
          ? { leftUserMessages: [...prev.leftUserMessages, aiMsg] }
          : { rightUserMessages: [...prev.rightUserMessages, aiMsg] })
      }))
    }

    try {
      // æ„å»ºæ¶ˆæ¯å†å²
      const apiMessages = [
        { role: 'system' as const, content: systemPrompt },
        ...messages
          .filter(m => m.id !== aiMessageId)
          .map(m => ({ role: m.role, content: m.content }))
      ]

      // æµå¼å›è°ƒ
      let accumulatedContent = ''
      const streamCallback = (chunk: string) => {
        accumulatedContent += chunk
        setState(prev => {
          const updateMessage = (msgs: ChatMessage[]) =>
            msgs.map(msg => msg.id === aiMessageId 
              ? { ...msg, content: accumulatedContent }
              : msg
            )

          if (state.mode === 'system') {
            return {
              ...prev,
              ...(side === 'left'
                ? { leftMessages: updateMessage(prev.leftMessages) }
                : { rightMessages: updateMessage(prev.rightMessages) })
            }
          } else {
            return {
              ...prev,
              ...(side === 'left'
                ? { leftUserMessages: updateMessage(prev.leftUserMessages) }
                : { rightUserMessages: updateMessage(prev.rightUserMessages) })
            }
          }
        })
      }

      // è°ƒç”¨AI
      const response = await aiService.callAI(
        apiMessages,
        provider,
        model.id,
        true, // æµå¼è¾“å‡º
        streamCallback
      )

      // æ›´æ–°æœ€ç»ˆå“åº”
      setState(prev => {
        const updateMessage = (msgs: ChatMessage[]) =>
          msgs.map(msg => msg.id === aiMessageId
            ? { ...msg, content: response, isStreaming: false }
            : msg
          )

        if (state.mode === 'system') {
          return {
            ...prev,
            ...(side === 'left'
              ? { leftMessages: updateMessage(prev.leftMessages) }
              : { rightMessages: updateMessage(prev.rightMessages) })
          }
        } else {
          return {
            ...prev,
            ...(side === 'left'
              ? { leftUserMessages: updateMessage(prev.leftUserMessages) }
              : { rightUserMessages: updateMessage(prev.rightUserMessages) })
          }
        }
      })
    } catch (error: any) {
      console.error(`${side} AI call failed:`, error)
      setState(prev => {
        const updateMessage = (msgs: ChatMessage[]) =>
          msgs.map(msg => msg.id === aiMessageId
            ? { ...msg, content: `âŒ é”™è¯¯: ${error.message}`, isStreaming: false }
            : msg
          )

        if (state.mode === 'system') {
          return {
            ...prev,
            ...(side === 'left'
              ? { leftMessages: updateMessage(prev.leftMessages) }
              : { rightMessages: updateMessage(prev.rightMessages) })
          }
        } else {
          return {
            ...prev,
            ...(side === 'left'
              ? { leftUserMessages: updateMessage(prev.leftUserMessages) }
              : { rightUserMessages: updateMessage(prev.rightUserMessages) })
          }
        }
      })
    } finally {
      setState(prev => ({
        ...prev,
        ...(side === 'left' ? { isLeftGenerating: false } : { isRightGenerating: false })
      }))
    }
  }, [currentProvider, currentModel, state.mode, aiService])

  const sendSystemMessage = useCallback(async () => {
    if (!state.systemConfig.sharedUserInput.trim() || isGenerating) return

    const userMessage = state.systemConfig.sharedUserInput.trim()
    const userMessageId = `user-${Date.now()}`

    const userMsg: ChatMessage = {
      id: userMessageId,
      role: 'user',
      content: userMessage,
      timestamp: new Date()
    }

    setState(prev => ({
      ...prev,
      systemConfig: { ...prev.systemConfig, sharedUserInput: '' },
      leftMessages: [...prev.leftMessages, { ...userMsg, id: `left-${userMessageId}` }],
      rightMessages: [...prev.rightMessages, { ...userMsg, id: `right-${userMessageId}` }]
    }))

    // è·å–æ›´æ–°åçš„æ¶ˆæ¯
    const updatedState = { ...state }
    updatedState.leftMessages = [...state.leftMessages, { ...userMsg, id: `left-${userMessageId}` }]
    updatedState.rightMessages = [...state.rightMessages, { ...userMsg, id: `right-${userMessageId}` }]

    // å¹¶å‘è°ƒç”¨ä¸¤ä¾§AI
    await Promise.all([
      callAI('left', state.systemConfig.leftSystemPrompt, updatedState.leftMessages),
      callAI('right', state.systemConfig.rightSystemPrompt, updatedState.rightMessages)
    ])
  }, [state, isGenerating, callAI])

  const sendLeftUserMessage = useCallback(async () => {
    if (!state.userConfig.leftUserPrompt.trim() || state.isLeftGenerating) return

    const userMessage = state.userConfig.leftUserPrompt.trim()
    const userMessageId = `left-user-${Date.now()}`

    const userMsg: ChatMessage = {
      id: userMessageId,
      role: 'user',
      content: userMessage,
      timestamp: new Date()
    }

    setState(prev => ({
      ...prev,
      userConfig: { ...prev.userConfig, leftUserPrompt: '' },
      leftUserMessages: [...prev.leftUserMessages, userMsg]
    }))

    const updatedState = { ...state }
    updatedState.leftUserMessages = [...state.leftUserMessages, userMsg]

    await callAI('left', state.userConfig.sharedSystemPrompt, updatedState.leftUserMessages)
  }, [state, callAI])

  const sendRightUserMessage = useCallback(async () => {
    if (!state.userConfig.rightUserPrompt.trim() || state.isRightGenerating) return

    const userMessage = state.userConfig.rightUserPrompt.trim()
    const userMessageId = `right-user-${Date.now()}`

    const userMsg: ChatMessage = {
      id: userMessageId,
      role: 'user',
      content: userMessage,
      timestamp: new Date()
    }

    setState(prev => ({
      ...prev,
      userConfig: { ...prev.userConfig, rightUserPrompt: '' },
      rightUserMessages: [...prev.rightUserMessages, userMsg]
    }))

    const updatedState = { ...state }
    updatedState.rightUserMessages = [...state.rightUserMessages, userMsg]

    await callAI('right', state.userConfig.sharedSystemPrompt, updatedState.rightUserMessages)
  }, [state, callAI])

  const clearHistory = useCallback((side?: 'left' | 'right') => {
    setState(prev => {
      if (prev.mode === 'system') {
        return {
          ...prev,
          ...(side === 'left' || !side ? { leftMessages: [] } : {}),
          ...(side === 'right' || !side ? { rightMessages: [] } : {})
        }
      } else {
        return {
          ...prev,
          ...(side === 'left' || !side ? { leftUserMessages: [] } : {}),
          ...(side === 'right' || !side ? { rightUserMessages: [] } : {})
        }
      }
    })
  }, [])

  return {
    state,
    isGenerating,
    initSystemComparison,
    initUserComparison,
    sendSystemMessage,
    sendLeftUserMessage,
    sendRightUserMessage,
    clearHistory,
    setState
  }
}

```


## src/components/playground/MindMap.tsx

```tsx
import { useEffect, useRef, useState } from 'react'
import { loadD3 } from '@/utils/chartLazyLoader'

interface MindMapProps {
  content: string
  onError: (errorMsg: string) => void
}

export default function MindMap({ content, onError }: MindMapProps) {
  const containerRef = useRef<HTMLDivElement>(null)
  const svgRef = useRef<SVGSVGElement>(null)
  const [isLoading, setIsLoading] = useState(false)
  const resizeObserverRef = useRef<ResizeObserver | null>(null)
  const d3Ref = useRef<any>(null)

  const renderTree = async () => {
    if (!content || !svgRef.current || !containerRef.current) return

    // Lazy load D3 if not loaded
    if (!d3Ref.current) {
      setIsLoading(true)
      try {
        d3Ref.current = await loadD3()
      } catch (error: any) {
        setIsLoading(false)
        onError(`Failed to load D3: ${error.message}`)
        const svg = d3Ref.current ? d3Ref.current.select(svgRef.current) : null
        if (svg) {
          svg.selectAll('*').remove()
          svg
            .append('text')
            .attr('x', '50%')
            .attr('y', '50%')
            .attr('text-anchor', 'middle')
            .attr('fill', '#ef4444')
            .text('Failed to load D3 library')
        }
        return
      }
      setIsLoading(false)
    }

    // Parse JSON safely
    let data
    try {
      let cleanContent = content
      const firstBrace = cleanContent.indexOf('{')
      const lastBrace = cleanContent.lastIndexOf('}')
      if (firstBrace !== -1 && lastBrace !== -1) {
        cleanContent = cleanContent.substring(firstBrace, lastBrace + 1)
      }
      data = JSON.parse(cleanContent)

      // æ”¯æŒåŒ…å« mindmap æ ¹æ•°æ®çš„åŒ…è£…æ ¼å¼
      if (data && data.mindmap) {
        data = data.mindmap
      }

      if (data && data.nodes && !data.children) {
        data.children = data.nodes
      }

      if (data && !data.name && data.title) {
        data.name = data.title
      }

      if (data && Array.isArray(data.children)) {
        const normalize = (node: any): any => {
          if (!node) return null
          const normalized = {
            name: node.title || node.name || 'èŠ‚ç‚¹',
            children: []
          }
          const rawChildren = node.children || node.nodes || []
          normalized.children = rawChildren.map(normalize).filter(Boolean)
          return normalized
        }

        data = normalize({ title: data.title || data.name || 'MindMap', children: data.children })
      }

      // VALIDATION: D3 Tree requires a Root Object, not an Array
      if (Array.isArray(data)) {
        throw new Error(
          "MindMap expects a Root Object { name: '...', children: [...] }, but received an Array."
        )
      }
    } catch (e: any) {
      console.warn('Invalid JSON for mindmap:', e)
      onError(`MindMap Data Error: ${e.message}`)

      // Show error visually in SVG
      const svg = d3Ref.current.select(svgRef.current)
      svg.selectAll('*').remove()
      svg
        .append('text')
        .attr('x', '50%')
        .attr('y', '50%')
        .attr('text-anchor', 'middle')
        .attr('fill', '#ef4444')
        .text('Invalid MindMap Data')
      return
    }

    const container = containerRef.current
    const width = container.clientWidth
    const height = container.clientHeight

    if (width === 0 || height === 0) return

    const d3 = d3Ref.current
    const svg = d3.select(svgRef.current)
    svg.selectAll('*').remove()

    const g = svg.append('g')

    const zoom = d3
      .zoom()
      .scaleExtent([0.1, 5])
      .on('zoom', (event: any) => {
        g.attr('transform', event.transform)
      })

    svg.call(zoom as any).on('dblclick.zoom', null)

    const root = d3.hierarchy(data)

    // Dynamic spacing based on tree size
    const dx = 40
    const dy = width / (root.height + 2)

    const treeLayout = d3.tree().nodeSize([dx, dy])

    // Horizontal layout
    treeLayout(root)

    // Calculate bounds to center the tree
    let x0 = Infinity
    let x1 = -x0
    root.each((d: any) => {
      if (d.x > x1) x1 = d.x
      if (d.x < x0) x0 = d.x
    })

    // Render Links
    g.selectAll('.link')
      .data(root.links())
      .enter()
      .append('path')
      .attr('class', 'link')
      .attr('fill', 'none')
      .attr('stroke', '#cbd5e1')
      .attr('stroke-width', 1.5)
      .attr(
        'd',
        d3
          .linkHorizontal()
          .x((d: any) => d.y)
          .y((d: any) => d.x) as any
      )

    // Render Nodes
    const node = g
      .selectAll('.node')
      .data(root.descendants())
      .enter()
      .append('g')
      .attr('class', 'node')
      .attr('transform', (d: any) => `translate(${d.y},${d.x})`)

    // Node Circles
    node
      .append('circle')
      .attr('r', 6)
      .attr('fill', (d: any) => (d.children ? '#ffffff' : '#3b82f6'))
      .attr('stroke', '#3b82f6')
      .attr('stroke-width', 2)

    // Labels
    node
      .append('text')
      .attr('dy', '0.31em')
      .attr('x', (d: any) => (d.children ? -10 : 10))
      .style('text-anchor', (d: any) => (d.children ? 'end' : 'start'))
      .text((d: any) => d.data.name)
      .style('font-size', '13px')
      .style('font-family', "'Inter', sans-serif")
      .style('font-weight', '500')
      .style('fill', '#0f172a')
      .each(function (this: SVGTextElement) {
        // White outline for readability
        const clone = this.cloneNode(true) as SVGTextElement
        d3.select(clone)
          .style('stroke', 'white')
          .style('stroke-width', '4px')
          .style('stroke-opacity', '0.9')
          .attr('class', 'stroke-clone')
        this.parentNode?.insertBefore(clone, this)
      })

    // Initial centering
    svg.call(zoom.transform as any, d3.zoomIdentity.translate(100, height / 2).scale(1))
  }

  useEffect(() => {
    renderTree()

    resizeObserverRef.current = new ResizeObserver(() => {
      renderTree()
    })

    if (containerRef.current) {
      resizeObserverRef.current.observe(containerRef.current)
    }

    return () => {
      if (resizeObserverRef.current) {
        resizeObserverRef.current.disconnect()
      }
    }
  }, [content])

  return (
    <div ref={containerRef} className="w-full h-full bg-white overflow-hidden relative select-none">
      {isLoading && (
        <div className="absolute inset-0 flex items-center justify-center bg-white z-10">
          <div className="flex flex-col items-center gap-3">
            <div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <p className="text-sm text-gray-600">æ­£åœ¨åŠ è½½å›¾è¡¨åº“...</p>
          </div>
        </div>
      )}
      <div className="absolute top-3 left-3 bg-white/90 backdrop-blur text-slate-500 text-xs px-2.5 py-1.5 rounded-md z-10 border border-slate-200 shadow-sm font-medium flex items-center gap-2">
        Pan & Zoom
      </div>
      <svg ref={svgRef} className={`w-full h-full cursor-grab active:cursor-grabbing block ${isLoading ? 'opacity-0' : ''}`} />
    </div>
  )
}

```


## src/components/playground/PlaygroundApp.tsx

````tsx
import { useState, useMemo, useCallback } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { extractArtifact } from '@/services/playground/artifactParser'
import { PlaygroundAIService } from '@/services/playground/aiPlaygroundService'
import PlaygroundChatPanel from './PlaygroundChatPanel'
import PreviewPanel from './PreviewPanel'

interface PlaygroundMessage {
  id: string
  role: 'user' | 'model'
  text: string
  displayText?: string
  isStreaming?: boolean
  timestamp: number
}

interface PlaygroundAppProps {
  systemPrompt: string
  onOpenSystemPrompt: () => void
}

const buildDisplayText = (text: string): string => {
  const matches = text.match(/```/g)
  if (matches && matches.length % 2 !== 0) {
    return `${text}\n\`\`\``
  }
  return text
}

export default function PlaygroundApp({ systemPrompt, onOpenSystemPrompt }: PlaygroundAppProps) {
  const providerStore = useProviderStore()
  const notificationStore = useNotificationStore()
  const aiService = PlaygroundAIService.getInstance()

  const [messages, setMessages] = useState<PlaygroundMessage[]>([])
  const [isStreaming, setIsStreaming] = useState(false)
  const [currentArtifact, setCurrentArtifact] = useState<any>(null)

  const hasSystemPrompt = useMemo(() => Boolean(systemPrompt && systemPrompt.trim().length), [systemPrompt])

  const currentModelName = useMemo(() => {
    const provider = providerStore.currentProvider
    const model = providerStore.currentModel
    if (provider && model) {
      return `${provider.name} Â· ${model.name}`
    }
    return 'æœªè¿æ¥æ¨¡å‹'
  }, [providerStore.currentProvider, providerStore.currentModel])

  const ensureProvider = useCallback(() => {
    const provider = providerStore.currentProvider
    const model = providerStore.currentModel
    if (!provider || !model || !provider.apiKey) {
      notificationStore.warning('è¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®å¯ç”¨çš„ AI æ¨¡å‹å’Œ API Key')
      return null
    }
    return { provider, model }
  }, [providerStore.currentProvider, providerStore.currentModel, notificationStore])

  const handleClear = useCallback(() => {
    setMessages([])
    setCurrentArtifact(null)
  }, [])

  const toggleStreamMode = useCallback(() => {
    providerStore.setStreamMode(!providerStore.streamMode)
  }, [providerStore])

  const handleSend = useCallback(
    async (payload: { text: string }) => {
      const text = payload?.text?.trim()
      if (!text) return

      const providerInfo = ensureProvider()
      if (!providerInfo) return

      const userMessage: PlaygroundMessage = {
        id: Date.now().toString(),
        role: 'user',
        text,
        timestamp: Date.now()
      }
      setMessages((prev) => [...prev, userMessage])

      setIsStreaming(true)
      const aiMsgId = `${Date.now()}_ai`
      const aiMessage: PlaygroundMessage = {
        id: aiMsgId,
        role: 'model',
        text: '',
        displayText: '',
        isStreaming: true,
        timestamp: Date.now()
      }
      setMessages((prev) => [...prev, aiMessage])

      const payloadMessages = [...messages, userMessage].map((msg) => ({
        id: msg.id,
        role: (msg.role === 'model' ? 'assistant' : 'user') as 'user' | 'system' | 'assistant',
        content: msg.text,
        timestamp: msg.timestamp
      }))

      const useStream = providerStore.streamMode

      try {
        let accumulated = ''
        const onChunk = (chunkText: string) => {
          accumulated += chunkText
          setMessages((prev) => {
            const updated = [...prev]
            const aiMsg = updated.find((m) => m.id === aiMsgId)
            if (aiMsg) {
              aiMsg.text = accumulated
              aiMsg.displayText = buildDisplayText(accumulated)
            }
            return updated
          })
          const artifact = extractArtifact(accumulated)
          if (artifact) {
            setCurrentArtifact(artifact)
          }
        }

        const response = await aiService.send({
          messages: payloadMessages,
          provider: providerInfo.provider,
          modelId: providerInfo.model.id,
          stream: useStream,
          onChunk: useStream ? onChunk : undefined,
          systemPrompt: systemPrompt
        })

        if (!useStream && typeof response === 'string') {
          setMessages((prev) => {
            const updated = [...prev]
            const aiMsg = updated.find((m) => m.id === aiMsgId)
            if (aiMsg) {
              aiMsg.text = response
              aiMsg.displayText = response
              aiMsg.isStreaming = false
            }
            return updated
          })
          const artifact = extractArtifact(response)
          if (artifact) {
            setCurrentArtifact(artifact)
          }
        } else {
          setMessages((prev) => {
            const updated = [...prev]
            const aiMsg = updated.find((m) => m.id === aiMsgId)
            if (aiMsg) {
              aiMsg.isStreaming = false
              aiMsg.displayText = aiMsg.text
            }
            return updated
          })
        }
      } catch (err: any) {
        setMessages((prev) => {
          const updated = [...prev]
          const aiMsg = updated.find((m) => m.id === aiMsgId)
          if (aiMsg) {
            aiMsg.text += `\n\n*Error: ${err?.message || err}*`
            aiMsg.displayText = aiMsg.text
            aiMsg.isStreaming = false
          }
          return updated
        })
      } finally {
        setIsStreaming(false)
      }
    },
    [messages, providerStore.streamMode, systemPrompt, aiService, ensureProvider]
  )

  return (
    <div className="w-full flex-1 flex flex-col overflow-hidden min-h-0">
      <div className="flex flex-row gap-4 flex-1 min-h-0 overflow-hidden">
        <div className="flex-1 min-h-0 flex flex-col overflow-hidden">
          <PlaygroundChatPanel
            messages={messages}
            isStreaming={isStreaming}
            isStreamMode={providerStore.streamMode}
            hasSystemPrompt={hasSystemPrompt}
            currentModelName={currentModelName}
            onSend={handleSend}
            onClear={handleClear}
            onToggleStream={toggleStreamMode}
            onOpenSystemPrompt={onOpenSystemPrompt}
          />
        </div>
        <div className="flex-1 min-h-0 flex flex-col bg-[#f0f4f9] rounded-lg overflow-hidden">
          <PreviewPanel artifact={currentArtifact} />
        </div>
      </div>
    </div>
  )
}

````


## src/components/playground/PlaygroundChatPanel.tsx

````tsx
import { useState, useEffect, useRef, useCallback } from 'react'
import { Sparkles, RefreshCw, ArrowUp, FileText } from 'lucide-react'
import { marked } from 'marked'

interface PlaygroundMessage {
  id: string
  role: 'user' | 'model'
  text: string
  displayText?: string
  isStreaming?: boolean
}

interface PlaygroundChatPanelProps {
  messages: PlaygroundMessage[]
  isStreaming: boolean
  isStreamMode: boolean
  hasSystemPrompt: boolean
  currentModelName: string
  onSend: (payload: { text: string }) => void
  onClear: () => void
  onToggleStream: () => void
  onOpenSystemPrompt: () => void
}

export default function PlaygroundChatPanel({
  messages,
  isStreaming,
  isStreamMode,
  hasSystemPrompt,
  currentModelName: _currentModelName,
  onSend,
  onClear,
  onToggleStream,
  onOpenSystemPrompt
}: PlaygroundChatPanelProps) {
  const [inputVal, setInputVal] = useState('')
  const scrollRef = useRef<HTMLDivElement>(null)
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  const scrollToBottom = useCallback(() => {
    if (!scrollRef.current) return
    const el = scrollRef.current
    const distance = el.scrollHeight - el.scrollTop - el.clientHeight
    if (distance < 300) {
      el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' })
    }
  }, [])

  const highlightCode = useCallback(() => {
    if (!scrollRef.current || isStreaming) return
    const blocks = scrollRef.current.querySelectorAll('pre code')
    blocks.forEach((block) => {
      const codeEl = block as HTMLElement & { dataset: DOMStringMap }
      if (!(window as any).hljs || codeEl.dataset.highlighted) return
      ;(window as any).hljs.highlightElement(codeEl)
      codeEl.dataset.highlighted = 'yes'
    })
  }, [isStreaming])

  useEffect(() => {
    scrollToBottom()
    highlightCode()
  }, [messages, isStreaming, scrollToBottom, highlightCode])

  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.focus()
    }
  }, [])

  const autoResize = useCallback(() => {
    if (!textareaRef.current) return
    textareaRef.current.style.height = 'auto'
    textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`
  }, [])

  const handleKeydown = (event: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault()
      sendMessage()
    }
  }

  const sendMessage = () => {
    if (!inputVal.trim() || isStreaming) return
    onSend({ text: inputVal })
    setInputVal('')
    setTimeout(() => {
      textareaRef.current?.focus()
      autoResize()
    }, 0)
  }

  const renderMarkdown = (text: string): string => {
    if (!text) return ''
    try {
      return marked.parse(text, { breaks: true, gfm: true }) as string
    } catch (error) {
      console.warn('Markdown æ¸²æŸ“å¤±è´¥', error)
      return text
    }
  }

  const shouldDisplayAsCode = (text: string): boolean => {
    if (!text) return false
    const trimmed = text.trim()
    if (trimmed.includes('```markdown') || trimmed.includes('```md')) {
      return true
    }
    if (!trimmed.startsWith('```')) return false
    const lastFence = trimmed.lastIndexOf('```')
    if (lastFence <= 0) return false
    return lastFence === trimmed.length - 3
  }

  const hasContent = (msg: PlaygroundMessage): boolean => {
    const content = msg.displayText || msg.text
    return Boolean(content && content.trim().length)
  }

  return (
    <div className="bg-white rounded-lg shadow-sm flex flex-col flex-1 min-h-0 overflow-hidden border border-gray-100">
      {/* Header */}
      <div className="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
        <h4 className="font-semibold text-gray-800">AIå¯¹è¯</h4>
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">æµå¼:</span>
            <button
              onClick={onToggleStream}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none ${
                isStreamMode ? 'bg-blue-500' : 'bg-gray-300'
              }`}
              title={isStreamMode ? 'å…³é—­æµå¼è¾“å‡º' : 'å¼€å¯æµå¼è¾“å‡º'}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                  isStreamMode ? 'translate-x-6' : 'translate-x-1'
                }`}
              />
            </button>
          </div>

          <button
            className={`p-2 rounded-lg border transition-colors ${
              hasSystemPrompt
                ? 'border-blue-200 bg-blue-50 text-blue-600'
                : 'border-gray-200 text-gray-500 hover:bg-gray-50'
            }`}
            onClick={onOpenSystemPrompt}
            title="è®¾ç½®ç³»ç»Ÿæç¤ºè¯"
          >
            <FileText className="w-4 h-4" />
          </button>

          <button
            onClick={onClear}
            className="p-2 rounded-lg border border-gray-200 text-gray-500 hover:text-red-600 hover:bg-red-50 transition-colors"
            title="é‡æ–°å¼€å§‹"
          >
            <RefreshCw className="w-4 h-4" />
          </button>
        </div>
      </div>

      {/* Messages */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto bg-gray-50 px-4 py-6 space-y-5">
        {messages.length === 0 ? (
          <div className="h-full flex flex-col items-center justify-center text-gray-400 p-6 text-center">
            <div className="w-16 h-16 rounded-2xl bg-white border border-gray-200 flex items-center justify-center mb-4">
              <Sparkles className="w-8 h-8 text-gray-300" />
            </div>
            <p className="text-base font-medium text-gray-700 mb-2">æ¬¢è¿ä½¿ç”¨æç¤ºè¯æ“ç»ƒåœº</p>
            <p className="text-sm text-gray-500 max-w-xs">å¯¹è¯ç”Ÿæˆç»“æœä¼šåœ¨å³ä¾§å®æ—¶æ¸²æŸ“</p>
          </div>
        ) : (
          messages.map((msg) => (
            <div key={msg.id} className="space-y-2">
              {msg.role === 'user' ? (
                <div className="flex justify-end">
                  <div className="bg-blue-500 text-white px-4 py-3 rounded-2xl rounded-tr-md max-w-xl whitespace-pre-wrap text-sm shadow-sm">
                    {msg.text}
                  </div>
                </div>
              ) : (
                <div className="flex items-start gap-3">
                  <div className="w-9 h-9 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm">
                    <Sparkles className="w-5 h-5 text-blue-500" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 text-sm text-gray-500 mb-1">
                      <span className="font-medium text-gray-900">AIåŠ©æ‰‹</span>
                    </div>
                    <div className="bg-white text-gray-800 px-4 py-3 rounded-2xl rounded-tl-md border border-gray-200 shadow-sm">
                      {msg.isStreaming ? (
                        hasContent(msg) ? (
                          shouldDisplayAsCode(msg.displayText || msg.text) ? (
                            <pre className="playground-code-block">{msg.displayText || msg.text}</pre>
                          ) : (
                            <div
                              className="markdown-body prose prose-sm max-w-none text-gray-800"
                              dangerouslySetInnerHTML={{
                                __html: renderMarkdown(msg.displayText || msg.text)
                              }}
                            />
                          )
                        ) : (
                          <div className="flex items-center gap-1 text-gray-400">
                            <span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                            <span
                              className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"
                              style={{ animationDelay: '0.1s' }}
                            ></span>
                            <span
                              className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"
                              style={{ animationDelay: '0.2s' }}
                            ></span>
                          </div>
                        )
                      ) : shouldDisplayAsCode(msg.text) ? (
                        <pre className="playground-code-block">{msg.text}</pre>
                      ) : (
                        <div
                          className="markdown-body prose prose-sm max-w-none text-gray-800"
                          dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.text) }}
                        />
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          ))
        )}
      </div>

      {/* Input */}
      <div className="p-3 border-t border-gray-200 bg-white flex-shrink-0">
        <div className="max-w-4xl mx-auto relative">
          <div
            className="relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden"
            style={{ height: '120px' }}
          >
            <div className="absolute top-0 left-0 right-0" style={{ bottom: '48px' }}>
              <textarea
                ref={textareaRef}
                value={inputVal}
                onChange={(e) => {
                  setInputVal(e.target.value)
                  autoResize()
                }}
                rows={1}
                className="w-full h-full px-3 pt-3 pb-1 border-0 outline-none resize-none text-base overflow-y-auto bg-transparent"
                placeholder="Shift+Enter æ¢è¡Œ"
                onKeyDown={handleKeydown}
              />
            </div>
            <div className="absolute bottom-0 left-0 right-0 h-12 flex items-center justify-end px-3 bg-transparent pointer-events-none">
              <button
                onClick={sendMessage}
                disabled={!inputVal.trim() || isStreaming}
                className="w-8 h-8 rounded-full bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"
              >
                <ArrowUp className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

````


## src/components/playground/PreviewPanel.tsx

```tsx
import { useState, useEffect, useRef, useCallback, useMemo } from 'react'
import { Eye, Code2, RotateCcw, Maximize, Minimize, Download, Copy, Check, Terminal, X, Ban, Sparkles } from 'lucide-react'
import { loadECharts, loadMermaid } from '@/utils/chartLazyLoader'
import { marked } from 'marked'
import { copyToClipboard } from '@/utils/clipboardUtils'
import { useNotificationStore } from '@/stores/notificationStore'
import MindMap from './MindMap'

interface Artifact {
  type: 'html' | 'drawio' | 'mermaid' | 'echarts' | 'svg' | 'markdown' | 'mindmap' | 'json'
  content: string
}

interface PreviewPanelProps {
  artifact: Artifact | null
}

interface ConsoleLog {
  level: 'log' | 'error' | 'warn' | 'info'
  message: string
  timestamp: number
  count: number
}

export default function PreviewPanel({ artifact }: PreviewPanelProps) {
  const notificationStore = useNotificationStore()
  const [activeTab, setActiveTab] = useState<'preview' | 'code'>('preview')
  const [copied, setCopied] = useState(false)
  const [localContent, setLocalContent] = useState('')
  const [isFullscreen, setIsFullscreen] = useState(false)
  const [isConsoleOpen, setIsConsoleOpen] = useState(false)
  const [consoleLogs, setConsoleLogs] = useState<ConsoleLog[]>([])
  const [reloadKey, setReloadKey] = useState(0)
  const [mermaidLook, setMermaidLook] = useState<'default' | 'handDrawn'>('default')
  const [isLoadingMermaid, setIsLoadingMermaid] = useState(false)
  const [isLoadingECharts, setIsLoadingECharts] = useState(false)

  const mermaidRef = useRef<HTMLDivElement>(null)
  const echartsRef = useRef<HTMLDivElement>(null)
  const drawioRef = useRef<HTMLIFrameElement>(null)
  const mainContainerRef = useRef<HTMLDivElement>(null)
  const consoleScrollRef = useRef<HTMLDivElement>(null)

  let mermaid: any = null
  let echarts: any = null
  let chartInstance: any = null

  // ç›‘å¬ artifact å˜åŒ–
  useEffect(() => {
    if (artifact) {
      setLocalContent(artifact.content)
      setConsoleLogs([])
      if (artifact.type === 'mermaid') {
        setMermaidLook('default')
        setTimeout(() => renderMermaid(), 100)
      } else if (artifact.type === 'echarts') {
        setTimeout(() => renderECharts(), 100)
      } else if (artifact.type === 'drawio' && drawioRef.current) {
        sendDrawioXml(artifact.content)
      }
    }
  }, [artifact])

  // ç›‘å¬ activeTab å˜åŒ–
  useEffect(() => {
    if (activeTab === 'preview' && artifact) {
      if (artifact.type === 'mermaid') {
        setTimeout(() => renderMermaid(), 100)
      } else if (artifact.type === 'echarts') {
        setTimeout(() => renderECharts(), 100)
      }
    }
  }, [activeTab, artifact])

  // ç›‘å¬ iframe æ¶ˆæ¯ï¼ˆæ§åˆ¶å°æ—¥å¿—ï¼‰
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      if (event.data && event.data.type === 'iframe-log') {
        addLog(event.data.level, event.data.message)
      }
      handleDrawioMessage(event)
    }
    window.addEventListener('message', handleMessage)
    return () => window.removeEventListener('message', handleMessage)
  }, [])

  // ç›‘å¬å…¨å±å˜åŒ–
  useEffect(() => {
    const handleFullscreenChange = () => {
      setIsFullscreen(!!document.fullscreenElement)
    }
    document.addEventListener('fullscreenchange', handleFullscreenChange)
    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange)
  }, [])

  // æ§åˆ¶å°æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    if (consoleScrollRef.current) {
      consoleScrollRef.current.scrollTop = consoleScrollRef.current.scrollHeight
    }
  }, [consoleLogs])

  const addLog = useCallback((level: ConsoleLog['level'], message: string) => {
    setConsoleLogs((prev) => {
      const lastLog = prev[prev.length - 1]
      if (lastLog && lastLog.message === message && lastLog.level === level) {
        return prev.map((log, idx) =>
          idx === prev.length - 1 ? { ...log, count: log.count + 1, timestamp: Date.now() } : log
        )
      }
      return [...prev, { level, message, timestamp: Date.now(), count: 1 }]
    })
  }, [])

  const handleComponentError = useCallback(
    (errorMsg: string) => {
      addLog('error', errorMsg)
    },
    [addLog]
  )

  const renderMermaid = useCallback(async () => {
    if (!mermaidRef.current || !localContent) return

    if (!mermaid) {
      setIsLoadingMermaid(true)
      try {
        mermaid = await loadMermaid()
        if (!mermaid) throw new Error('Mermaid library not available')
      } catch (error: any) {
        setIsLoadingMermaid(false)
        const errMsg = `Failed to load Mermaid: ${error.message}`
        addLog('error', errMsg)
        if (mermaidRef.current) {
          mermaidRef.current.innerHTML = `<div class="text-red-600 font-mono text-xs p-4 bg-red-50 border border-red-200 rounded">${errMsg}</div>`
        }
        return
      }
      setIsLoadingMermaid(false)
    }

    try {
      mermaid.initialize({
        startOnLoad: false,
        look: mermaidLook,
        theme: mermaidLook === 'handDrawn' ? 'neutral' : 'base',
        securityLevel: 'loose'
      })

      const id = 'mermaid-graph-' + Date.now()
      const { svg } = await mermaid.render(id, localContent)
      if (mermaidRef.current) {
        mermaidRef.current.innerHTML = svg
      }
    } catch (e: any) {
      const errMsg = `Mermaid Render Error: ${e.message}`
      addLog('error', errMsg)
      if (mermaidRef.current) {
        mermaidRef.current.innerHTML = `<div class="text-red-600 font-mono text-xs p-4 bg-red-50 border border-red-200 rounded">${errMsg}</div>`
      }
    }
  }, [localContent, mermaidLook, addLog])

  const renderECharts = useCallback(async () => {
    if (!echartsRef.current || !localContent) return

    if (!echarts) {
      setIsLoadingECharts(true)
      try {
        echarts = await loadECharts()
        if (!echarts) throw new Error('ECharts library not available')
      } catch (error: any) {
        setIsLoadingECharts(false)
        const errMsg = `Failed to load ECharts: ${error.message}`
        addLog('error', errMsg)
        if (echartsRef.current) {
          echartsRef.current.innerHTML = `<div class="text-red-600 font-mono text-xs p-4 bg-red-50 border border-red-200 rounded flex items-center justify-center h-full">${errMsg}</div>`
        }
        return
      }
      setIsLoadingECharts(false)
    }

    if (chartInstance) chartInstance.dispose()
    chartInstance = echarts.init(echartsRef.current)

    try {
      let jsonStr = localContent.trim()
      if (jsonStr.startsWith('option =')) jsonStr = jsonStr.replace('option =', '')
      if (jsonStr.endsWith(';')) jsonStr = jsonStr.slice(0, -1)

      const option = JSON.parse(jsonStr)
      chartInstance.setOption(option)

      const ro = new ResizeObserver(() => chartInstance.resize())
      ro.observe(echartsRef.current)
    } catch (e: any) {
      const errMsg = `ECharts Parse Error: ${e.message}`
      addLog('error', errMsg)
      chartInstance.setOption({
        title: {
          text: 'Error Parsing Chart Data',
          subtext: e.message,
          left: 'center',
          top: 'center',
          textStyle: { color: '#d32f2f' }
        }
      })
    }
  }, [localContent, addLog])

  const sendDrawioXml = useCallback((xml: string) => {
    if (!drawioRef.current) return
    drawioRef.current.contentWindow?.postMessage(
      JSON.stringify({
        action: 'load',
        xml: xml,
        autosave: 1
      }),
      '*'
    )
  }, [])

  const handleDrawioMessage = useCallback((e: MessageEvent) => {
    if (!drawioRef.current || !e.data || typeof e.data !== 'string') return
    try {
      const msg = JSON.parse(e.data)
      if (msg.event === 'autosave' || msg.event === 'save') {
        if (msg.xml) {
          setLocalContent(msg.xml)
        }
      }
    } catch (err) {
      // Ignore parse errors
    }
  }, [])

  const toggleFullscreen = useCallback(() => {
    if (!mainContainerRef.current) return
    if (!document.fullscreenElement) {
      mainContainerRef.current.requestFullscreen().catch((err) => {
        console.error(`Error attempting to enable fullscreen mode: ${err.message}`)
      })
    } else {
      document.exitFullscreen()
    }
  }, [])

  const reloadPreview = useCallback(() => {
    setConsoleLogs([])
    if (artifact?.type === 'html') {
      setReloadKey((prev) => prev + 1)
    } else if (artifact?.type === 'echarts') {
      renderECharts()
    } else if (artifact?.type === 'mermaid') {
      renderMermaid()
    } else if (artifact?.type === 'drawio') {
      sendDrawioXml(localContent)
    }
  }, [artifact, localContent, renderECharts, renderMermaid, sendDrawioXml])

  const downloadArtifact = useCallback(() => {
    if (!artifact) return

    const type = artifact.type
    const content = localContent
    let blob: Blob | null = null
    let filename = ''

    if (type === 'html') {
      blob = new Blob([enrichedHtmlContent], { type: 'text/html' })
      filename = 'playground-export.html'
    } else if (type === 'svg') {
      blob = new Blob([content], { type: 'image/svg+xml' })
      filename = 'image.svg'
    } else if (type === 'drawio') {
      blob = new Blob([content], { type: 'application/xml' })
      filename = 'diagram.xml'
    } else if (type === 'mermaid') {
      const svg = mermaidRef.current?.querySelector('svg')
      if (svg) {
        const clone = svg.cloneNode(true) as SVGElement
        clone.removeAttribute('transform')
        clone.removeAttribute('style')
        const serializer = new XMLSerializer()
        const source = serializer.serializeToString(clone)
        blob = new Blob([source], { type: 'image/svg+xml' })
        filename = 'diagram.svg'
      }
    } else if (type === 'echarts') {
      const dataUrl = chartInstance?.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#fff' })
      if (dataUrl) {
        const link = document.createElement('a')
        link.download = 'chart.png'
        link.href = dataUrl
        link.click()
        return
      }
    } else if (type === 'markdown') {
      blob = new Blob([content], { type: 'text/markdown' })
      filename = 'readme.md'
    } else if (type === 'mindmap') {
      blob = new Blob([content], { type: 'application/json' })
      filename = 'mindmap.json'
    } else if (type === 'json') {
      blob = new Blob([content], { type: 'application/json' })
      filename = 'data.json'
    }

    if (blob) {
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = filename
      link.click()
      URL.revokeObjectURL(url)
    }
  }, [artifact, localContent, chartInstance])

  const copyCode = useCallback(async () => {
    try {
      await copyToClipboard(localContent)
      setCopied(true)
      setTimeout(() => setCopied(false), 2000)
    } catch (error) {
      notificationStore.error('å¤åˆ¶å¤±è´¥')
    }
  }, [localContent, notificationStore])

  const renderMarkdown = useCallback((text: string): string => {
    try {
      return marked.parse(text, { breaks: true, gfm: true }) as string
    } catch {
      return text
    }
  }, [])

  const enrichedHtmlContent = useMemo(() => {
    if (!artifact || artifact.type !== 'html') return ''
    let raw = localContent

    const resetCss = `
      html { height: 100%; width: 100%; }
      body { 
        min-height: 100vh; 
        margin: 0; padding: 0; 
        background-color: white; 
        font-family: system-ui, sans-serif;
        height: auto;
        position: relative;
      }
      canvas { display: block; outline: none; } 
      #app { width: 100%; min-height: 100%; }
    `

    const consoleInterceptor = `
      <script>
        (function() {
          const originalLog = console.log;
          const originalError = console.error;
          const originalWarn = console.warn;
          const originalInfo = console.info;
          function sendLog(level, args) {
            try {
              const message = args.map(arg => {
                if (typeof arg === 'object') {
                  try { return JSON.stringify(arg); } catch(e) { return String(arg); }
                }
                return String(arg);
              }).join(' ');
              window.parent.postMessage({ type: 'iframe-log', level, message }, '*');
            } catch(e) {}
          }
          console.log = function(...args) { originalLog.apply(console, args); sendLog('log', args); };
          console.error = function(...args) { originalError.apply(console, args); sendLog('error', args); };
          console.warn = function(...args) { 
            if (args.length > 0 && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args); sendLog('warn', args); 
          };
          console.info = function(...args) { originalInfo.apply(console, args); sendLog('info', args); };
          window.onerror = function(msg, source, lineno, colno, error) {
            window.parent.postMessage({ type: 'iframe-log', level: 'error', message: 'Uncaught Error: ' + msg + ' (Line ' + lineno + ')' }, '*');
            return false; 
          };
          window.addEventListener('unhandledrejection', function(event) {
            window.parent.postMessage({ type: 'iframe-log', level: 'error', message: 'Unhandled Promise Rejection: ' + (event.reason ? event.reason.message || event.reason : 'Unknown') }, '*');
          });
        })();
      <\/script>
    `

    const libraries = `
      <script src="https://cdn.tailwindcss.com"><\/script>
      <script src="https://unpkg.com/lucide@latest"><\/script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"><\/script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"><\/script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"><\/script>
      <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"><\/script>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    `

    const importMap = `
      <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "echarts": "https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.esm.min.js",
            "gsap": "https://esm.sh/gsap@3.12.5",
            "gsap/ScrollTrigger": "https://esm.sh/gsap@3.12.5/ScrollTrigger"
          }
        }
      <\/script>
    `

    const shimScript = `
      <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        window.THREE = { ...THREE, OrbitControls };
        window.OrbitControls = OrbitControls;
      <\/script>
    `

    raw = raw.replace(/<script\b([^>]*)>([\s\S]*?)<\/script>/gi, (match, attrs, inner) => {
      if (attrs.match(/\bsrc\s*=/i) || attrs.match(/\btype\s*=/i)) {
        return match
      }
      return `<script type="module" ${attrs}>${inner}</script>`
    })

    const headContent = `${consoleInterceptor}${libraries}${importMap}${shimScript}<style>${resetCss}</style>`

    if (raw.includes('<!DOCTYPE html>') || raw.includes('<html')) {
      return raw.replace('<head>', `<head>${headContent}`)
    }

    return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    ${headContent}</head><body class="p-0">
      <div id="app">${raw}</div>
      <script>
        window.onload = function() {
          if (window.lucide) window.lucide.createIcons();
        };
      <\/script>
    </body></html>`
  }, [artifact, localContent])

  const consoleErrorCount = useMemo(
    () => consoleLogs.filter((l) => l.level === 'error').length,
    [consoleLogs]
  )

  return (
    <div
      ref={mainContainerRef}
      className="flex flex-col flex-1 min-h-0 bg-[#f8f9fa] select-none outline-none"
      tabIndex={0}
    >
      {/* Header with Tabs & Actions */}
      <div className="h-14 border-b border-[#e5e7eb] flex items-center justify-between px-4 bg-white sticky top-0 z-10 flex-shrink-0">
        {/* Left: Tabs */}
        <div className="flex items-center gap-1 bg-gray-100/50 p-1 rounded-lg border border-gray-200">
          <button
            onClick={() => setActiveTab('preview')}
            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
              activeTab === 'preview'
                ? 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200'
                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'
            }`}
          >
            <Eye className="w-3.5 h-3.5" />
            Preview
          </button>
          <button
            onClick={() => setActiveTab('code')}
            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
              activeTab === 'code'
                ? 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200'
                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'
            }`}
          >
            <Code2 className="w-3.5 h-3.5" />
            Code
          </button>
        </div>

        {/* Center: Context Aware Actions */}
        <div className="flex items-center gap-4">
          {/* Mermaid Theme Toggle */}
          {activeTab === 'preview' && artifact && artifact.type === 'mermaid' && (
            <div className="flex items-center gap-1 bg-gray-50 p-1 rounded-lg border border-gray-200">
              <button
                onClick={() => {
                  setMermaidLook('default')
                  renderMermaid()
                }}
                className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1.5 ${
                  mermaidLook === 'default'
                    ? 'bg-white shadow text-blue-700'
                    : 'text-gray-600 hover:bg-gray-200'
                }`}
              >
                Standard
              </button>
              <button
                onClick={() => {
                  setMermaidLook('handDrawn')
                  renderMermaid()
                }}
                className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1.5 ${
                  mermaidLook === 'handDrawn'
                    ? 'bg-white shadow text-purple-700'
                    : 'text-gray-600 hover:bg-gray-200'
                }`}
              >
                Hand-Drawn
              </button>
            </div>
          )}
        </div>

        {/* Right: Global Actions */}
        {artifact && (
          <div className="flex items-center gap-2 ml-4">
            {/* Toggle Console */}
            <button
              onClick={() => setIsConsoleOpen(!isConsoleOpen)}
              className={`p-2 rounded-md transition-colors relative border ${
                isConsoleOpen
                  ? 'bg-gray-100 text-gray-900 border-gray-300'
                  : 'text-gray-500 border-transparent hover:text-gray-800 hover:bg-gray-100'
              }`}
              title="Toggle Debug Console"
            >
              <Terminal className="w-4 h-4" />
              {consoleErrorCount > 0 && (
                <span className="absolute top-0.5 right-0.5 w-2.5 h-2.5 bg-red-500 text-white text-[8px] font-bold rounded-full flex items-center justify-center border border-white">
                  {consoleErrorCount > 9 ? '!' : consoleErrorCount}
                </span>
              )}
            </button>

            <div className="w-px h-4 bg-gray-300 mx-1"></div>

            {/* Reload Button */}
            {activeTab === 'preview' && (
              <button
                onClick={reloadPreview}
                className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                title="Reload / Reset Preview"
              >
                <RotateCcw className="w-4 h-4" />
              </button>
            )}

            <button
              onClick={toggleFullscreen}
              className="p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors"
              title="Toggle Fullscreen"
            >
              {isFullscreen ? <Minimize className="w-4 h-4" /> : <Maximize className="w-4 h-4" />}
            </button>

            <button
              onClick={downloadArtifact}
              className="p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors"
              title="Download Artifact"
            >
              <Download className="w-4 h-4" />
            </button>

            <button
              onClick={copyCode}
              className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
              title="Copy Code"
            >
              {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
            </button>
          </div>
        )}
      </div>

      {/* Content Area */}
      <div className="flex-1 overflow-hidden relative flex flex-col bg-[#e2e8f0]">
        {/* Empty State */}
        {!artifact && (
          <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-600 bg-[#f8f9fa] z-20 px-6 text-center">
            <div className="w-20 h-20 bg-white rounded-full shadow-sm border border-gray-100 flex items-center justify-center mb-4">
              <Sparkles className="w-8 h-8 text-blue-400" />
            </div>
            <p className="text-base font-semibold text-gray-800 mb-3">æ¬¢è¿ä½¿ç”¨æç¤ºè¯æ“ç»ƒåœº</p>
            <p className="text-sm text-gray-600 max-w-2xl mb-4">
              å·¦ä¾§å¯¹è¯åŒºä¼šå®æ—¶è¿”å› AI è¾“å‡ºï¼Œè¿™é‡Œä¼šæ¸²æŸ“å„ç§ Artifactã€‚å°è¯•è¿™äº›ç©æ³•ï¼š
            </p>
            <ul className="text-sm text-gray-600 space-y-1 max-w-xl text-left">
              <li>
                â€¢ ç”Ÿæˆ <span className="font-medium text-gray-800">HTMLï¼ˆæ”¯æŒTailwind / Three.js / GSAP / EChartsï¼‰</span>
              </li>
              <li>
                â€¢ è¾“å‡º <span className="font-medium text-gray-800">Markdownã€SVGã€MindMapã€Mermaidã€Draw.io</span> ç­‰å¯è§†åŒ–
              </li>
            </ul>
          </div>
        )}

        {/* Preview Tab */}
        {activeTab === 'preview' && artifact && (
          <div className="flex-1 min-h-0 overflow-auto relative flex flex-col items-center pt-4 pb-4">
            <div
              className="absolute inset-0 pointer-events-none opacity-[0.03] z-0"
              style={{
                backgroundImage: 'radial-gradient(#000 1px, transparent 1px)',
                backgroundSize: '24px 24px'
              }}
            ></div>

            {/* Device Container Wrapper */}
            <div className="relative bg-white shadow-xl transition-all duration-300 ease-in-out z-10 border border-gray-300 overflow-hidden flex-shrink-0 w-full flex-1 min-h-0 max-w-[98%] rounded-lg">
              {/* HTML */}
              {artifact.type === 'html' && (
                <iframe
                  key={`html-preview-${reloadKey}`}
                  className="w-full h-full border-none bg-white"
                  sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
                  srcDoc={enrichedHtmlContent}
                />
              )}

              {/* Draw.io Embed */}
              {artifact.type === 'drawio' && (
                <div className="w-full h-full bg-white">
                  <iframe
                    ref={drawioRef}
                    className="w-full h-full border-none"
                    src="https://embed.diagrams.net/?embed=1&ui=atlas&spin=1&modified=0&proto=json"
                  />
                </div>
              )}

              {/* Mermaid Diagram */}
              {artifact.type === 'mermaid' && (
                <div className="w-full h-full relative overflow-hidden bg-white cursor-grab active:cursor-grabbing">
                  {isLoadingMermaid && (
                    <div className="absolute inset-0 flex items-center justify-center bg-white z-10">
                      <div className="flex flex-col items-center gap-3">
                        <div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                        <p className="text-sm text-gray-600">æ­£åœ¨åŠ è½½å›¾è¡¨åº“...</p>
                      </div>
                    </div>
                  )}
                  <div className="absolute top-3 left-3 bg-white/90 backdrop-blur text-slate-500 text-xs px-2.5 py-1.5 rounded-md z-10 border border-slate-200 shadow-sm font-medium flex items-center gap-2">
                    Pan & Zoom
                  </div>
                  <div
                    ref={mermaidRef}
                    className="origin-center p-10"
                    style={{ opacity: isLoadingMermaid ? 0 : 1 }}
                  />
                </div>
              )}

              {/* ECharts */}
              {artifact.type === 'echarts' && (
                <div className="w-full h-full bg-white overflow-hidden relative">
                  {isLoadingECharts && (
                    <div className="absolute inset-0 flex items-center justify-center bg-white z-10">
                      <div className="flex flex-col items-center gap-3">
                        <div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                        <p className="text-sm text-gray-600">æ­£åœ¨åŠ è½½å›¾è¡¨åº“...</p>
                      </div>
                    </div>
                  )}
                  <div ref={echartsRef} className="w-full h-full" style={{ opacity: isLoadingECharts ? 0 : 1 }} />
                </div>
              )}

              {/* SVG Container */}
              {artifact.type === 'svg' && (
                <div className="w-full h-full relative bg-white overflow-auto hide-scrollbar">
                  <div
                    className="svg-content-wrapper w-full h-full flex items-center justify-center min-w-[100%] min-h-[100%] relative"
                    style={{ overflow: 'visible' }}
                    dangerouslySetInnerHTML={{ __html: localContent }}
                  />
                </div>
              )}

              {/* Markdown */}
              {artifact.type === 'markdown' && (
                <div
                  className="w-full h-full bg-white p-8 overflow-y-auto markdown-body preview-markdown"
                  dangerouslySetInnerHTML={{ __html: renderMarkdown(localContent) }}
                />
              )}

              {/* Generic JSON Viewer */}
              {artifact.type === 'json' && (
                <div className="w-full h-full bg-white overflow-y-auto p-0">
                  <div className="sticky top-0 z-10 bg-gray-50 border-b border-gray-200 px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">
                    JSON Data Viewer
                  </div>
                  <div className="markdown-body p-4">
                    <pre className="!m-0 !border-0 !bg-gray-50">
                      <code className="language-json !bg-transparent !p-0">{localContent}</code>
                    </pre>
                  </div>
                </div>
              )}

              {/* MindMap */}
              {artifact.type === 'mindmap' && (
                <MindMap content={localContent} onError={handleComponentError} />
              )}
            </div>
          </div>
        )}

        {/* Code Tab (Editable) */}
        {activeTab === 'code' && (
          <div className="flex-1 min-h-0 bg-[#f9fafb] overflow-hidden flex flex-col relative z-20">
            <textarea
              value={localContent}
              onChange={(e) => setLocalContent(e.target.value)}
              className="w-full h-full p-6 font-mono text-sm resize-none outline-none border-none bg-transparent text-slate-800 leading-relaxed"
              spellCheck={false}
              placeholder="Edit code here..."
            />
          </div>
        )}

        {/* Console Panel (Collapsible) */}
        {isConsoleOpen && (
          <div className="h-48 bg-white border-t border-gray-300 flex flex-col z-30 shadow-[0_-4px_12px_rgba(0,0,0,0.05)] flex-shrink-0 transition-all duration-200">
            {/* Console Toolbar */}
            <div className="h-7 bg-[#f1f3f4] border-b border-[#e0e0e0] flex items-center px-2 justify-between select-none">
              <div className="flex items-center gap-2 text-[11px] font-medium text-gray-600">
                <Terminal className="w-3 h-3 text-gray-500" />
                Console Output
                {consoleLogs.length > 0 && (
                  <span className="text-gray-400 font-normal ml-1">{consoleLogs.length} messages</span>
                )}
              </div>
              <div className="flex items-center gap-1">
                <button
                  onClick={() => setConsoleLogs([])}
                  className="p-1 hover:bg-gray-300/50 rounded text-gray-500 hover:text-gray-800 transition-colors"
                  title="Clear Console"
                >
                  <Ban className="w-3 h-3" />
                </button>
                <button
                  onClick={() => setIsConsoleOpen(false)}
                  className="p-1 hover:bg-gray-300/50 rounded text-gray-500 hover:text-gray-800 transition-colors"
                  title="Close"
                >
                  <X className="w-3 h-3" />
                </button>
              </div>
            </div>

            {/* Logs Area */}
            <div ref={consoleScrollRef} className="flex-1 overflow-y-auto font-mono text-[11px] leading-relaxed bg-white">
              {consoleLogs.length === 0 ? (
                <div className="text-gray-400 italic p-3 text-center mt-4">No logs to display</div>
              ) : (
                consoleLogs.map((log, idx) => (
                  <div
                    key={idx}
                    className={`px-2 py-1 border-b border-[#f0f0f0] flex gap-2 group font-medium select-text ${
                      log.level === 'error'
                        ? 'bg-[#fff0f0] text-[#d32f2f] border-[#ffcdd2]'
                        : log.level === 'warn'
                        ? 'bg-[#fff8e1] text-[#f57c00] border-[#ffecb3]'
                        : 'text-[#202124] hover:bg-[#f8f9fa]'
                    }`}
                  >
                    <div className="flex-shrink-0 text-gray-400 w-[65px] text-[10px] select-none pt-0.5">
                      {new Date(log.timestamp).toLocaleTimeString([], { hour12: false })}
                    </div>
                    <div className="flex-1 break-words whitespace-pre-wrap relative">
                      {log.count > 1 && (
                        <span className="bg-gray-200 text-gray-600 px-1.5 rounded-[10px] text-[9px] font-bold mr-1.5 inline-block align-middle min-w-[18px] text-center">
                          {log.count}
                        </span>
                      )}
                      <span className="align-middle">{log.message}</span>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

```


## src/components/preview/components/common/EmptyState.tsx

```tsx
export default function EmptyState() {
  return (
    <div className="flex-1 flex items-center justify-center p-8">
      <div className="text-center text-gray-500">
        <p>ç­‰å¾…ç”Ÿæˆå†…å®¹...</p>
      </div>
    </div>
  )
}

```


## src/components/preview/components/common/LoadingState.tsx

```tsx
export default function LoadingState() {
  return (
    <div className="flex-1 flex items-center justify-center p-8">
      <div className="text-center">
        <div className="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4" />
        <p className="text-gray-600">æ­£åœ¨ç”Ÿæˆå†…å®¹...</p>
      </div>
    </div>
  )
}

```


## src/components/preview/components/common/PreviewHeader.tsx

```tsx
import { RefreshCw } from 'lucide-react'

interface PreviewHeaderProps {
  isAutoMode: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isGenerating: boolean
  onUpdateIsAutoMode: (value: boolean) => void
}

const getStepDisplayName = (step: string) => {
  const stepNames: Record<string, string> = {
    'report': 'ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š',
    'thinking': 'ç”Ÿæˆå…³é”®æŒ‡ä»¤',
    'initial': 'ç”Ÿæˆåˆå§‹æç¤ºè¯',
    'advice': 'ç”Ÿæˆä¼˜åŒ–å»ºè®®',
    'final': 'ç”Ÿæˆæœ€ç»ˆæç¤ºè¯'
  }
  return stepNames[step] || step
}

export default function PreviewHeader({
  isAutoMode,
  currentExecutionStep,
  isGenerating,
  onUpdateIsAutoMode
}: PreviewHeaderProps) {
  return (
    <div className="p-4 border-b border-gray-200 flex items-center justify-between">
      <div className="flex items-center space-x-3">
        <h4 className="font-semibold text-gray-800">ç”Ÿæˆé¢„è§ˆ</h4>
        {(currentExecutionStep || (isGenerating && !currentExecutionStep)) && (
          <div className="flex items-center px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs border border-blue-200">
            <RefreshCw className="w-3 h-3 animate-spin mr-1" />
            <span>{currentExecutionStep ? getStepDisplayName(currentExecutionStep) : 'ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š'}</span>
          </div>
        )}
      </div>
      <div className="flex items-center space-x-3">
        <div className="flex items-center space-x-2">
          <label className="flex items-center cursor-pointer">
            <input
              checked={isAutoMode}
              onChange={(e) => onUpdateIsAutoMode(e.target.checked)}
              type="checkbox"
              className="sr-only peer"
            />
            <span className="text-sm text-gray-600">{isAutoMode ? 'è‡ªåŠ¨ï¼š' : 'æ‰‹åŠ¨ï¼š'}</span>
            <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600" />
          </label>
        </div>
      </div>
    </div>
  )
}

```


## src/components/preview/components/common/TabButton.tsx

```tsx
import { useRef, useEffect, ReactNode } from 'react'

interface TabButtonProps {
  isActive: boolean
  activeClass: string
  children: ReactNode
  onClick: () => void
  onMounted?: (element: HTMLButtonElement) => void
}

export default function TabButton({
  isActive,
  activeClass,
  children,
  onClick,
  onMounted
}: TabButtonProps) {
  const buttonRef = useRef<HTMLButtonElement>(null)

  useEffect(() => {
    if (buttonRef.current && onMounted) {
      onMounted(buttonRef.current)
    }
  }, [onMounted])

  return (
    <button
      ref={buttonRef}
      onClick={onClick}
      className={`px-3 py-1 rounded text-sm transition-colors whitespace-nowrap flex-shrink-0 ${
        isActive ? activeClass : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
      }`}
    >
      {children}
    </button>
  )
}

```


## src/components/preview/components/common/TabContainer.tsx

```tsx
import { useRef, useEffect, ReactNode } from 'react'
import { RefreshCw } from 'lucide-react'

interface TabContainerProps {
  isGenerating: boolean
  children: ReactNode
  onMounted?: (element: HTMLElement) => void
}

export default function TabContainer({ isGenerating, children, onMounted }: TabContainerProps) {
  const tabContainerRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (tabContainerRef.current && onMounted) {
      onMounted(tabContainerRef.current)
    }
  }, [onMounted])

  return (
    <div ref={tabContainerRef} className="flex space-x-2 mb-4 flex-shrink-0 overflow-x-auto scrollbar-hide scroll-smooth">
      <div className="flex space-x-2 min-w-max px-1">
        {isGenerating && (
          <div className="flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm whitespace-nowrap">
            <RefreshCw className="w-3 h-3 animate-spin mr-1" />
            <span>ç”Ÿæˆä¸­</span>
          </div>
        )}
        {children}
      </div>
    </div>
  )
}

```


## src/components/preview/components/dialogs/SavePromptDialog.tsx

```tsx
import { useState, useEffect } from 'react'
import { X } from 'lucide-react'

interface SavePromptDialogProps {
  isOpen: boolean
  promptContent: string
  isSaving: boolean
  onSave: (formData: {
    title: string
    description: string
    tags: string[]
    isPublic: boolean
    promptType: string
  }) => void
  onCancel: () => void
}

export default function SavePromptDialog({
  isOpen,
  promptContent,
  isSaving,
  onSave,
  onCancel
}: SavePromptDialogProps) {
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    tags: [] as string[],
    isPublic: false,
    promptType: 'system' as 'system' | 'user',
    content: ''
  })
  const [newTag, setNewTag] = useState('')

  useEffect(() => {
    if (isOpen) {
      setFormData({
        title: '',
        description: '',
        tags: [],
        isPublic: false,
        promptType: 'system',
        content: ''
      })
      setNewTag('')
    }
  }, [isOpen])

  const addTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }))
      setNewTag('')
    }
  }

  const removeTag = (tag: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(t => t !== tag)
    }))
  }

  const handleSave = () => {
    if (!formData.title.trim()) {
      return
    }
    onSave({
      title: formData.title,
      description: formData.description,
      tags: formData.tags,
      isPublic: formData.isPublic,
      promptType: formData.promptType
    })
  }

  if (!isOpen) {
    return null
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onClick={onCancel}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-6 border-b">
          <h2 className="text-xl font-semibold text-gray-900">ä¿å­˜æç¤ºè¯</h2>
          <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* å†…å®¹ */}
        <div className="p-6 space-y-4">
          {/* æ ‡é¢˜ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æ ‡é¢˜ <span className="text-red-500">*</span>
            </label>
            <input
              value={formData.title}
              onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
              type="text"
              placeholder="è¯·è¾“å…¥æç¤ºè¯æ ‡é¢˜"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              maxLength={200}
            />
            <p className="mt-1 text-xs text-gray-500">{formData.title.length}/200</p>
          </div>

          {/* æè¿° */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æè¿°
            </label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
              placeholder="ç®€çŸ­æè¿°è¿™ä¸ªæç¤ºè¯çš„ç”¨é€”ï¼ˆå¯é€‰ï¼‰"
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
              maxLength={500}
            />
            <p className="mt-1 text-xs text-gray-500">{formData.description.length}/500</p>
          </div>

          {/* æç¤ºè¯ç±»å‹ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æç¤ºè¯ç±»å‹ <span className="text-red-500">*</span>
            </label>
            <div className="flex gap-4">
              <label className="flex items-center cursor-pointer">
                <input
                  type="radio"
                  checked={formData.promptType === 'system'}
                  onChange={() => setFormData(prev => ({ ...prev, promptType: 'system' }))}
                  className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                />
                <span className="ml-2 text-sm text-gray-700">ç³»ç»Ÿæç¤ºè¯</span>
              </label>
              <label className="flex items-center cursor-pointer">
                <input
                  type="radio"
                  checked={formData.promptType === 'user'}
                  onChange={() => setFormData(prev => ({ ...prev, promptType: 'user' }))}
                  className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                />
                <span className="ml-2 text-sm text-gray-700">ç”¨æˆ·æç¤ºè¯</span>
              </label>
            </div>
            <p className="mt-1 text-xs text-gray-500">
              ç³»ç»Ÿæç¤ºè¯ï¼šç”¨äºå®šä¹‰AIçš„è§’è‰²å’Œè¡Œä¸ºè§„åˆ™ï¼›ç”¨æˆ·æç¤ºè¯ï¼šç”¨äºå…·ä½“ä»»åŠ¡å’ŒæŒ‡ä»¤
            </p>
          </div>

          {/* æ ‡ç­¾ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æ ‡ç­¾
            </label>
            <div className="flex flex-wrap gap-2 mb-2">
              {formData.tags.map((tag) => (
                <span
                  key={tag}
                  className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"
                >
                  {tag}
                  <button onClick={() => removeTag(tag)} className="ml-2 text-blue-500 hover:text-blue-700">Ã—</button>
                </span>
              ))}
            </div>
            <div className="flex gap-2">
              <input
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                onKeyUp={(e) => e.key === 'Enter' && addTag()}
                type="text"
                placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ "
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <button
                onClick={addTag}
                className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>

          {/* æ˜¯å¦å…¬å¼€ */}
          <div className="flex items-center">
            <input
              type="checkbox"
              id="isPublic"
              checked={formData.isPublic}
              onChange={(e) => setFormData(prev => ({ ...prev, isPublic: e.target.checked }))}
              className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <label htmlFor="isPublic" className="ml-2 text-sm text-gray-700">
              å…¬å¼€åˆ†äº«ï¼ˆå…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°ï¼‰
            </label>
          </div>

          {/* æç¤ºè¯å†…å®¹ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              æç¤ºè¯å†…å®¹ <span className="text-red-500">*</span>
            </label>
            {promptContent && promptContent.trim() ? (
              <div className="p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto text-sm text-gray-600">
                {promptContent.slice(0, 200)}{promptContent.length > 200 ? '...' : ''}
              </div>
            ) : (
              <textarea
                value={formData.content}
                onChange={(e) => setFormData(prev => ({ ...prev, content: e.target.value }))}
                placeholder="è¯·è¾“å…¥æˆ–ç²˜è´´æç¤ºè¯å†…å®¹..."
                rows={8}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm"
              />
            )}
            <p className="mt-1 text-xs text-gray-500">å…± {(promptContent || formData.content).length} ä¸ªå­—ç¬¦</p>
          </div>
        </div>

        {/* åº•éƒ¨æŒ‰é’® */}
        <div className="flex justify-end gap-3 p-6 border-t bg-gray-50">
          <button
            onClick={onCancel}
            disabled={isSaving}
            className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSave}
            disabled={!formData.title.trim() || isSaving}
            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
          </button>
        </div>
      </div>
    </div>
  )
}

```


## src/components/preview/components/tabs/AdviceTab.tsx

```tsx
import { useRef, useEffect } from 'react'
import { RefreshCw, Copy, Check } from 'lucide-react'

interface AdviceTabProps {
  advice: string[]
  setAdvice: (advice: string[]) => void
  isAutoMode: boolean
  isExecuting: boolean
  isGenerating: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isCopied: boolean
  onRegenerate: () => void
  onCopy: () => void
  onAddItem: () => void
  onRemoveItem: (index: number) => void
  onUpdateItem: (index: number, value: string) => void
  onExecuteFinal: () => void
  onScrollMounted?: (element: HTMLElement) => void
}

export default function AdviceTab({
  advice,
  setAdvice,
  isAutoMode,
  isExecuting,
  isGenerating,
  currentExecutionStep,
  isCopied,
  onRegenerate,
  onCopy,
  onAddItem,
  onRemoveItem,
  onUpdateItem,
  onExecuteFinal,
  onScrollMounted
}: AdviceTabProps) {
  const scrollContainerRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (scrollContainerRef.current && onScrollMounted) {
      onScrollMounted(scrollContainerRef.current)
    }
  }, [onScrollMounted])

  useEffect(() => {
    if (scrollContainerRef.current && isGenerating) {
      scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight
    }
  }, [advice, isGenerating])

  const handleUpdateItem = (index: number, value: string) => {
    const newAdvice = [...advice]
    newAdvice[index] = value
    setAdvice(newAdvice)
    onUpdateItem(index, value)
  }

  return (
    <div className="border rounded-lg overflow-hidden flex flex-col flex-1 min-h-0">
      <div className="bg-yellow-50 px-3 py-2 text-sm font-medium text-yellow-700 flex items-center justify-between flex-shrink-0">
        <span>ä¼˜åŒ–å»ºè®®</span>
        <div className="flex items-center space-x-2">
          <button
            onClick={onRegenerate}
            disabled={isExecuting || isGenerating}
            className="text-yellow-500 hover:text-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed"
            title="é‡æ–°ç”Ÿæˆä¼˜åŒ–å»ºè®®"
          >
            <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'advice') ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={onCopy}
            className="text-yellow-500 hover:text-yellow-600"
            title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      <div className="bg-white flex flex-col p-3 flex-1 min-h-0 overflow-hidden">
        <div ref={scrollContainerRef} className="space-y-2 overflow-y-auto flex-1 min-h-0">
          {advice.map((item, index) => (
            <div key={index} className="flex items-start">
              <span className="text-yellow-500 mr-2 mt-2">â€¢</span>
              <input
                value={item}
                onChange={(e) => handleUpdateItem(index, e.target.value)}
                onFocus={(e) => e.target.setSelectionRange(e.target.value.length, e.target.value.length)}
                className="flex-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
              />
              <button
                onClick={() => {
                  onRemoveItem(index)
                  const newAdvice = advice.filter((_, i) => i !== index)
                  setAdvice(newAdvice)
                }}
                className="ml-2 px-2 py-1 text-red-500 hover:text-red-700 text-sm"
                title="åˆ é™¤è¿™æ¡å»ºè®®"
              >
                Ã—
              </button>
            </div>
          ))}
        </div>
        
        <div className="p-3 pt-4 flex justify-between flex-shrink-0 border-t border-gray-100 bg-white">
          <button
            onClick={() => {
              onAddItem()
              setAdvice([...advice, ''])
            }}
            className="px-3 py-1 text-yellow-600 hover:text-yellow-800 text-sm"
          >
            + æ·»åŠ å»ºè®®
          </button>
          
          {!isAutoMode && (
            <button
              onClick={onExecuteFinal}
              disabled={!advice || advice.length === 0 || isExecuting}
              className="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'final') ? 'animate-spin' : ''}`} />
              <span>{(isExecuting && currentExecutionStep === 'final') ? 'æ‰§è¡Œä¸­...' : 'ç”Ÿæˆæœ€ç»ˆæç¤ºè¯'}</span>
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

```


## src/components/preview/components/tabs/FinalTab.tsx

```tsx
import { useRef, useEffect } from 'react'
import { RefreshCw, Copy, Check, Save } from 'lucide-react'

interface FinalTabProps {
  generatedPrompt: string
  setGeneratedPrompt: (value: string) => void
  isExecuting: boolean
  isGenerating: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isCopied: boolean
  isConvertingFormat: boolean
  isConvertingLanguage: boolean
  isSaving: boolean
  formatState: 'markdown' | 'xml'
  languageState: 'zh' | 'en'
  onRegenerate: () => void
  onCopy: () => void
  onToggleFormat: () => void
  onToggleLanguage: () => void
  onSavePrompt: () => void
  onScrollMounted?: (element: HTMLElement) => void
}

export default function FinalTab({
  generatedPrompt,
  setGeneratedPrompt,
  isExecuting,
  isGenerating,
  currentExecutionStep,
  isCopied,
  isConvertingFormat,
  isConvertingLanguage,
  isSaving,
  formatState,
  languageState,
  onRegenerate,
  onCopy,
  onToggleFormat,
  onToggleLanguage,
  onSavePrompt,
  onScrollMounted
}: FinalTabProps) {
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  useEffect(() => {
    if (textareaRef.current && onScrollMounted) {
      onScrollMounted(textareaRef.current)
    }
  }, [onScrollMounted])

  useEffect(() => {
    if (textareaRef.current && isGenerating) {
      textareaRef.current.scrollTop = textareaRef.current.scrollHeight
    }
  }, [generatedPrompt, isGenerating])

  return (
    <div className="border rounded-lg overflow-hidden flex flex-col flex-1">
      <div className="bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 flex items-center justify-between flex-shrink-0">
        <span>æœ€ç»ˆæç¤ºè¯</span>
        <div className="flex items-center space-x-2">
          <button
            onClick={onRegenerate}
            disabled={isExecuting || isGenerating}
            className="text-blue-500 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
            title="é‡æ–°ç”Ÿæˆæœ€ç»ˆæç¤ºè¯"
          >
            <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'final') ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={onCopy}
            className="text-blue-500 hover:text-blue-600"
            title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      <div className="p-3 bg-white flex-1 flex flex-col min-h-0 overflow-hidden">
        <div className="mb-2 flex items-center justify-between flex-shrink-0">
          <div className="flex items-center space-x-2">
            <button
              onClick={onToggleFormat}
              disabled={isConvertingFormat || isConvertingLanguage}
              className="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {formatState === 'markdown' ? 'Markdown' : 'XML'}
            </button>
            <button
              onClick={onToggleLanguage}
              disabled={isConvertingFormat || isConvertingLanguage}
              className="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {languageState === 'zh' ? 'ä¸­æ–‡' : 'English'}
            </button>
          </div>
          <button
            onClick={onSavePrompt}
            disabled={!generatedPrompt.trim() || isSaving}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
          >
            <Save className="w-4 h-4" />
            <span>{isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜åˆ°åº“'}</span>
          </button>
        </div>
        <textarea
          ref={textareaRef}
          value={generatedPrompt}
          onChange={(e) => setGeneratedPrompt(e.target.value)}
          placeholder="æœ€ç»ˆæç¤ºè¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."
          className="w-full flex-1 min-h-0 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-gray-300 focus:ring-0 resize-none"
        />
      </div>
    </div>
  )
}

```


## src/components/preview/components/tabs/InitialTab.tsx

```tsx
import { useRef, useEffect } from 'react'
import { RefreshCw, Copy, Check } from 'lucide-react'

interface InitialTabProps {
  initialPrompt: string
  setInitialPrompt: (value: string) => void
  isAutoMode: boolean
  isExecuting: boolean
  isGenerating: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isCopied: boolean
  onRegenerate: () => void
  onCopy: () => void
  onExecuteAdvice: () => void
  onScrollMounted?: (element: HTMLElement) => void
}

export default function InitialTab({
  initialPrompt,
  setInitialPrompt,
  isAutoMode,
  isExecuting,
  isGenerating,
  currentExecutionStep,
  isCopied,
  onRegenerate,
  onCopy,
  onExecuteAdvice,
  onScrollMounted
}: InitialTabProps) {
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  useEffect(() => {
    if (textareaRef.current && onScrollMounted) {
      onScrollMounted(textareaRef.current)
    }
  }, [onScrollMounted])

  useEffect(() => {
    if (textareaRef.current && isGenerating) {
      textareaRef.current.scrollTop = textareaRef.current.scrollHeight
    }
  }, [initialPrompt, isGenerating])

  return (
    <div className="border rounded-lg overflow-hidden flex flex-col flex-1">
      <div className="bg-green-50 px-3 py-2 text-sm font-medium text-green-700 flex items-center justify-between flex-shrink-0">
        <span>åˆå§‹æç¤ºè¯</span>
        <div className="flex items-center space-x-2">
          <button
            onClick={onRegenerate}
            disabled={isExecuting || isGenerating}
            className="text-green-500 hover:text-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
            title="é‡æ–°ç”Ÿæˆåˆå§‹æç¤ºè¯"
          >
            <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'initial') ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={onCopy}
            className="text-green-500 hover:text-green-600"
            title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      <div className="p-3 bg-white flex-1 flex flex-col overflow-hidden">
        <textarea
          ref={textareaRef}
          value={initialPrompt}
          onChange={(e) => setInitialPrompt(e.target.value)}
          placeholder="åˆå§‹æç¤ºè¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."
          className="w-full flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-gray-300 focus:ring-0 resize-none"
        />
        
        {!isAutoMode && (
          <div className="mt-4 flex justify-end flex-shrink-0">
            <button
              onClick={onExecuteAdvice}
              disabled={!initialPrompt.trim() || isExecuting}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'advice') ? 'animate-spin' : ''}`} />
              <span>{(isExecuting && currentExecutionStep === 'advice') ? 'æ‰§è¡Œä¸­...' : 'ç”Ÿæˆä¼˜åŒ–å»ºè®®'}</span>
            </button>
          </div>
        )}
      </div>
    </div>
  )
}

```


## src/components/preview/components/tabs/ReportTab.tsx

```tsx
import { useRef, useEffect } from 'react'
import { RefreshCw, Copy, Check } from 'lucide-react'

interface ReportTabProps {
  requirementReport: string
  setRequirementReport: (value: string) => void
  hasConversationData: boolean
  isAutoMode: boolean
  isExecuting: boolean
  isGenerating: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isCopied: boolean
  onRegenerate: () => void
  onCopy: () => void
  onExecuteFull: () => void
  onExecuteThinking: () => void
  onScrollMounted?: (element: HTMLElement) => void
}

export default function ReportTab({
  requirementReport,
  setRequirementReport,
  hasConversationData,
  isAutoMode,
  isExecuting,
  isGenerating,
  currentExecutionStep,
  isCopied,
  onRegenerate,
  onCopy,
  onExecuteFull,
  onExecuteThinking,
  onScrollMounted
}: ReportTabProps) {
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  useEffect(() => {
    if (textareaRef.current && onScrollMounted) {
      onScrollMounted(textareaRef.current)
    }
  }, [onScrollMounted])

  useEffect(() => {
    if (textareaRef.current && isGenerating) {
      textareaRef.current.scrollTop = textareaRef.current.scrollHeight
    }
  }, [requirementReport, isGenerating])

  return (
    <div className="border rounded-lg overflow-hidden flex flex-col flex-1">
      <div className="bg-orange-50 px-3 py-2 text-sm font-medium text-orange-700 flex items-center justify-between flex-shrink-0">
        <span>éœ€æ±‚æè¿°</span>
        <div className="flex items-center space-x-2">
          <button
            onClick={onRegenerate}
            disabled={isExecuting || isGenerating}
            className="text-orange-500 hover:text-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
            title="é‡æ–°ç”Ÿæˆéœ€æ±‚æè¿°"
          >
            <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'report') ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={onCopy}
            className="text-orange-500 hover:text-orange-600"
            title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      <div className="p-3 bg-white flex-1 flex flex-col overflow-hidden">
        <textarea
          ref={textareaRef}
          value={requirementReport}
          onChange={(e) => setRequirementReport(e.target.value)}
          placeholder={hasConversationData ? 'åŸºäºå¯¹è¯ç”Ÿæˆçš„éœ€æ±‚æè¿°...' : 'è¯·ç›´æ¥æè¿°æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘éœ€è¦ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥åŠ©æ‰‹ï¼Œèƒ½å¤Ÿåˆ†æä»£ç è´¨é‡ã€å‘ç°æ½œåœ¨é—®é¢˜å¹¶æä¾›æ”¹è¿›å»ºè®®...'}
          className="w-full flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-gray-300 focus:ring-0 resize-none"
        />
        
        <div className="mt-4 flex justify-end flex-shrink-0">
          {isAutoMode ? (
            <button
              onClick={onExecuteFull}
              disabled={!requirementReport.trim() || isExecuting || isGenerating}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              <RefreshCw className={`w-4 h-4 ${(isExecuting || isGenerating) ? 'animate-spin' : ''}`} />
              <span>{(isExecuting || isGenerating) ? 'è‡ªåŠ¨ç”Ÿæˆä¸­...' : 'è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯'}</span>
            </button>
          ) : (
            <button
              onClick={onExecuteThinking}
              disabled={!requirementReport.trim() || isExecuting}
              className="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'thinking') ? 'animate-spin' : ''}`} />
              <span>{(isExecuting && currentExecutionStep === 'thinking') ? 'æ‰§è¡Œä¸­...' : 'ç”Ÿæˆå…³é”®æŒ‡ä»¤'}</span>
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

```


## src/components/preview/components/tabs/ThinkingTab.tsx

```tsx
import { useRef, useEffect } from 'react'
import { RefreshCw, Copy, Check } from 'lucide-react'

interface ThinkingTabProps {
  thinkingPoints: string[]
  setThinkingPoints: (points: string[]) => void
  isAutoMode: boolean
  isExecuting: boolean
  isGenerating: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  isCopied: boolean
  onRegenerate: () => void
  onCopy: () => void
  onAddPoint: () => void
  onRemovePoint: (index: number) => void
  onUpdatePoint: (index: number, value: string) => void
  onExecuteInitial: () => void
  onScrollMounted?: (element: HTMLElement) => void
}

export default function ThinkingTab({
  thinkingPoints,
  setThinkingPoints,
  isAutoMode,
  isExecuting,
  isGenerating,
  currentExecutionStep,
  isCopied,
  onRegenerate,
  onCopy,
  onAddPoint,
  onRemovePoint,
  onUpdatePoint,
  onExecuteInitial,
  onScrollMounted
}: ThinkingTabProps) {
  const scrollContainerRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (scrollContainerRef.current && onScrollMounted) {
      onScrollMounted(scrollContainerRef.current)
    }
  }, [onScrollMounted])

  useEffect(() => {
    if (scrollContainerRef.current && isGenerating) {
      scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight
    }
  }, [thinkingPoints, isGenerating])

  const handleUpdatePoint = (index: number, value: string) => {
    const newPoints = [...thinkingPoints]
    newPoints[index] = value
    setThinkingPoints(newPoints)
    onUpdatePoint(index, value)
  }

  return (
    <div className="border rounded-lg overflow-hidden flex flex-col flex-1 min-h-0">
      <div className="bg-purple-50 px-3 py-2 text-sm font-medium text-purple-700 flex items-center justify-between flex-shrink-0">
        <span>å…³é”®æŒ‡ä»¤</span>
        <div className="flex items-center space-x-2">
          <button
            onClick={onRegenerate}
            disabled={isExecuting || isGenerating}
            className="text-purple-500 hover:text-purple-600 disabled:opacity-50 disabled:cursor-not-allowed"
            title="é‡æ–°ç”Ÿæˆå…³é”®æŒ‡ä»¤"
          >
            <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'thinking') ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={onCopy}
            className="text-purple-500 hover:text-purple-600"
            title="å¤åˆ¶åˆ°å‰ªè´´æ¿"
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      <div className="bg-white flex flex-col p-3 flex-1">
        <div ref={scrollContainerRef} className="space-y-2 overflow-y-auto flex-1" style={{ maxHeight: 'calc(100vh - 400px)' }}>
          {thinkingPoints.map((point, index) => (
            <div key={index} className="flex items-start">
              <span className="text-purple-500 mr-2 mt-2">â€¢</span>
              <input
                value={point}
                onChange={(e) => handleUpdatePoint(index, e.target.value)}
                onFocus={(e) => e.target.setSelectionRange(e.target.value.length, e.target.value.length)}
                className="flex-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              />
              <button
                onClick={() => {
                  onRemovePoint(index)
                  const newPoints = thinkingPoints.filter((_, i) => i !== index)
                  setThinkingPoints(newPoints)
                }}
                className="ml-2 px-2 py-1 text-red-500 hover:text-red-700 text-sm"
                title="åˆ é™¤è¿™æ¡æŒ‡ä»¤"
              >
                Ã—
              </button>
            </div>
          ))}
        </div>
        
        <div className="p-3 pt-4 flex justify-between flex-shrink-0 border-t border-gray-100 bg-white">
          <button
            onClick={() => {
              onAddPoint()
              setThinkingPoints([...thinkingPoints, ''])
            }}
            className="px-3 py-1 text-purple-600 hover:text-purple-800 text-sm"
          >
            + æ·»åŠ æŒ‡ä»¤
          </button>
          
          {!isAutoMode && (
            <button
              onClick={onExecuteInitial}
              disabled={!thinkingPoints || thinkingPoints.length === 0 || isExecuting}
              className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
            >
              <RefreshCw className={`w-4 h-4 ${(isExecuting && currentExecutionStep === 'initial') ? 'animate-spin' : ''}`} />
              <span>{(isExecuting && currentExecutionStep === 'initial') ? 'æ‰§è¡Œä¸­...' : 'ç”Ÿæˆåˆå§‹æç¤ºè¯'}</span>
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

```


## src/components/settings/SettingsModal.tsx

```tsx
import { useState, useEffect } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import { useSettingsStore } from '@/stores/settingsStore'
import { useNotificationStore } from '@/stores/notificationStore'
import SettingsButton from './components/SettingsButton'
import SettingsHeader from './components/SettingsHeader'
import ProvidersTab from './components/tabs/ProvidersTab'
import ModelParamsTab from './components/tabs/ModelParamsTab'
import PromptsTab from './components/tabs/PromptsTab'
import { usePromptRules } from './composables/usePromptRules'

export default function SettingsModal() {
  // ä½¿ç”¨ selector ç¡®ä¿ç»„ä»¶èƒ½å“åº” store çš„å˜åŒ–
  // ç›´æ¥è®¢é˜… providers æ•°ç»„ï¼Œè€Œä¸æ˜¯ getterï¼Œä»¥ç¡®ä¿å“åº”å¼æ›´æ–°
  const providers = useProviderStore((state) => state.providers)
  const lastRefreshedAt = useProviderStore((state) => state.lastRefreshedAt)
  const isLoading = useProviderStore((state) => state.isLoading)
  const isInitialized = useProviderStore((state) => state.isInitialized)
  const error = useProviderStore((state) => state.error)
  const refreshProviders = useProviderStore((state) => state.refreshProviders)
  
  const settingsStore = useSettingsStore()
  const showSettings = useSettingsStore((state) => state.showSettings)
  const setShowSettings = useSettingsStore((state) => state.setShowSettings)
  const notificationStore = useNotificationStore()
  const promptRules = usePromptRules()

  const [activeTab, setActiveTab] = useState<'providers' | 'params' | 'prompts'>('providers')

  useEffect(() => {
    // åªåœ¨æœªåˆå§‹åŒ–æ—¶è°ƒç”¨
    if (!isInitialized) {
      useProviderStore.getState().initialize()
    }
    settingsStore.loadSettings()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isInitialized]) // ä¾èµ– isInitialized

  useEffect(() => {
    if (activeTab === 'prompts') {
      settingsStore.openPromptEditor('system')
    } else if (activeTab === 'params') {
      // åˆ‡æ¢åˆ°æ¨¡å‹å‚æ•°æ ‡ç­¾æ—¶ï¼Œç¡®ä¿è®¾ç½®å·²åŠ è½½
      settingsStore.loadSettings()
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeTab]) // åªä¾èµ– activeTab

  const handleRefreshConfig = async () => {
    try {
      console.log('[SettingsModal] å¼€å§‹åˆ·æ–°é…ç½®...')
      await refreshProviders()
      
      // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
      await new Promise(resolve => setTimeout(resolve, 100))
      
      // ä» store è·å–æœ€æ–°çŠ¶æ€
      const currentProviders = useProviderStore.getState().providers
      const currentError = useProviderStore.getState().error
      
      console.log('[SettingsModal] åˆ·æ–°åçš„ providers:', currentProviders)
      console.log('[SettingsModal] providers æ•°é‡:', currentProviders.length)
      
      if (currentProviders.length === 0) {
        if (currentError) {
          notificationStore.error(`åˆ·æ–°é…ç½®å¤±è´¥: ${currentError}`)
        } else {
          notificationStore.warning(
            'é…ç½®å·²åˆ·æ–°ï¼Œä½†æœªæ‰¾åˆ°ä»»ä½• AI æ¨¡å‹é…ç½®ã€‚\n' +
            'è¯·æ£€æŸ¥ï¼š\n' +
            '1. åç«¯ .setting.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆåº”åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰\n' +
            '2. .setting.json æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å« providers æ•°ç»„\n' +
            '3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†æ—¥å¿—'
          )
        }
      } else {
        notificationStore.success(`é…ç½®å·²åˆ·æ–°ï¼Œå…±åŠ è½½ ${currentProviders.length} ä¸ª AI æ¨¡å‹`)
      }
    } catch (error: any) {
      console.error('[SettingsModal] åˆ·æ–°é…ç½®å¤±è´¥:', error)
      console.error('[SettingsModal] é”™è¯¯å †æ ˆ:', error.stack)
      notificationStore.error(`åˆ·æ–°é…ç½®å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  if (!showSettings) {
    return <SettingsButton onOpen={() => setShowSettings(true)} />
  }

  return (
    <>
      <SettingsButton onOpen={() => setShowSettings(true)} />
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg max-w-4xl w-full h-[85vh] overflow-hidden flex flex-col">
          <div className="p-6">
            <SettingsHeader
              activeTab={activeTab}
              onActiveTabChange={setActiveTab}
              onClose={() => setShowSettings(false)}
            />
          </div>

          <div className="p-6 overflow-y-auto flex-1">
            {activeTab === 'providers' && (
              <ProvidersTab
                providers={providers}
                lastRefreshedAt={lastRefreshedAt}
                isLoading={isLoading}
                onRefreshConfig={handleRefreshConfig}
              />
            )}
            
            {/* è°ƒè¯•ä¿¡æ¯ - å¼€å‘ç¯å¢ƒæ˜¾ç¤º */}
            {import.meta.env.DEV && activeTab === 'providers' && (
              <div className="mt-4 p-3 bg-gray-100 rounded text-xs space-y-1">
                <p className="font-semibold">è°ƒè¯•ä¿¡æ¯:</p>
                <p>Providers æ•°é‡: {providers.length}</p>
                <p>å·²åˆå§‹åŒ–: {isInitialized ? 'æ˜¯' : 'å¦'}</p>
                <p>åŠ è½½ä¸­: {isLoading ? 'æ˜¯' : 'å¦'}</p>
                <p>API URL: {import.meta.env.VITE_API_BASE_URL || 'æœªè®¾ç½®'}</p>
                {error && (
                  <p className="text-red-600 font-semibold">é”™è¯¯: {error}</p>
                )}
                {lastRefreshedAt && (
                  <p>ä¸Šæ¬¡åˆ·æ–°: {lastRefreshedAt.toLocaleString()}</p>
                )}
                {providers.length === 0 && !error && (
                  <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                    <p className="font-semibold text-yellow-800">æç¤º:</p>
                    <p className="text-yellow-700">
                      1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
                    </p>
                    <p className="text-yellow-700">
                      2. æ£€æŸ¥åç«¯ .setting.json æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
                    </p>
                    <p className="text-yellow-700">
                      3. ç¡®è®¤ .setting.json ä¸­åŒ…å« providers æ•°ç»„
                    </p>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'params' && <ModelParamsTab />}

            {activeTab === 'prompts' && (
              <PromptsTab
                onResetSystem={promptRules.resetSystemPromptRules}
                onResetUser={promptRules.resetUserPromptRules}
                onResetRequirement={promptRules.resetRequirementReportRules}
                onResetQualityAnalysisSystem={promptRules.resetQualityAnalysisSystemPrompt}
                onResetThinking={promptRules.resetThinkingPointsExtractionPrompt}
                onResetGeneration={promptRules.resetSystemPromptGenerationPrompt}
                onResetAdvice={promptRules.resetOptimizationAdvicePrompt}
                onResetApplication={promptRules.resetOptimizationApplicationPrompt}
                onToggleSlimRules={promptRules.handleSlimRulesToggle}
                onResetUserPromptQualityAnalysis={promptRules.resetUserPromptQualityAnalysis}
                onResetUserPromptQuickOptimization={promptRules.resetUserPromptQuickOptimization}
              />
            )}
          </div>

          <div className="flex justify-end space-x-3 p-6 border-t bg-gray-50 flex-shrink-0">
            <button
              onClick={() => setShowSettings(false)}
              className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              å–æ¶ˆ
            </button>
            <button
              onClick={promptRules.saveAndClose}
              className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
            >
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      </div>
    </>
  )
}

```


## src/components/settings/components/OptimizeTab.tsx

```tsx
import { useState, useEffect, useCallback } from 'react'

interface OptimizationSettings {
  temperature: number
  maxTokens: number
  focusArea: string
  language: string
  focusAreas?: string[]
  autoApplySuggestions?: boolean
  preserveStyle?: boolean
  enableQualityComparison?: boolean
}

interface Props {
  optimizationSettings?: OptimizationSettings
  onUpdateSettings: (settings: OptimizationSettings) => void
}

export default function OptimizeTab({ optimizationSettings, onUpdateSettings }: Props) {
  // ç®€åŒ–çš„æœ¬åœ°çŠ¶æ€ï¼Œç¡®ä¿æœ‰é»˜è®¤å€¼
  const [localSettings, setLocalSettings] = useState<OptimizationSettings>({
    temperature: 0.7,
    maxTokens: 1000,
    focusArea: 'clarity',
    language: 'zh',
    focusAreas: ['clarity', 'completeness'],
    autoApplySuggestions: false,
    preserveStyle: true,
    enableQualityComparison: true
  })

  // å½“å‰é¢„è®¾çŠ¶æ€
  const [currentPreset, setCurrentPreset] = useState<'none' | 'conservative' | 'balanced' | 'aggressive'>('none')

  // åœ¨ç»„ä»¶æŒ‚è½½æ—¶åº”ç”¨props
  useEffect(() => {
    if (optimizationSettings) {
      setLocalSettings(prev => ({ ...prev, ...optimizationSettings }))
      // æ£€æµ‹å½“å‰é¢„è®¾
      detectCurrentPreset({ ...localSettings, ...optimizationSettings })
    }
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  // æ£€æµ‹å½“å‰é¢„è®¾
  const detectCurrentPreset = useCallback((settings: OptimizationSettings) => {
    const presets: Record<string, OptimizationSettings> = {
      conservative: {
        temperature: 0.3,
        maxTokens: 800,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity'],
        autoApplySuggestions: false,
        preserveStyle: true,
        enableQualityComparison: false
      },
      balanced: {
        temperature: 0.7,
        maxTokens: 1000,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity', 'completeness', 'specificity'],
        autoApplySuggestions: false,
        preserveStyle: true,
        enableQualityComparison: true
      },
      aggressive: {
        temperature: 1.0,
        maxTokens: 1500,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity', 'completeness', 'specificity', 'structure', 'examples'],
        autoApplySuggestions: true,
        preserveStyle: false,
        enableQualityComparison: true
      }
    }

    // æ£€æŸ¥æ˜¯å¦åŒ¹é…æŸä¸ªé¢„è®¾
    for (const [presetName, presetConfig] of Object.entries(presets)) {
      const matches = Object.entries(presetConfig).every(([key, value]) => {
        if (Array.isArray(value)) {
          return Array.isArray(settings[key as keyof OptimizationSettings]) &&
                 JSON.stringify(settings[key as keyof OptimizationSettings]) === JSON.stringify(value)
        }
        return settings[key as keyof OptimizationSettings] === value
      })

      if (matches) {
        setCurrentPreset(presetName as 'conservative' | 'balanced' | 'aggressive')
        return
      }
    }

    setCurrentPreset('none')
  }, [])

  // æ›´æ–°è®¾ç½®å¹¶è§¦å‘äº‹ä»¶
  const updateSettings = useCallback((updates: Partial<OptimizationSettings>) => {
    const newSettings = { ...localSettings, ...updates }
    setLocalSettings(newSettings)
    onUpdateSettings(newSettings)
  }, [localSettings, onUpdateSettings])

  // è·å–æŒ‰é’®æ ·å¼ç±»
  const getPresetButtonClass = (preset: 'conservative' | 'balanced' | 'aggressive') => {
    const baseClass = 'p-3 border rounded-lg hover:bg-gray-50 text-center transition-colors'

    if (currentPreset === preset) {
      if (preset === 'balanced') {
        return `${baseClass} border-blue-200 bg-blue-50`
      }
      return `${baseClass} border-blue-300 bg-blue-50`
    }

    return `${baseClass} border-gray-200`
  }

  // è·å–æ–‡å­—é¢œè‰²ç±»
  const getPresetTextClass = (preset: 'conservative' | 'balanced' | 'aggressive') => {
    if (currentPreset === preset) {
      if (preset === 'balanced') {
        return 'text-blue-800'
      }
      return 'text-blue-700'
    }
    return 'text-gray-800'
  }

  // é¢„è®¾é…ç½®
  const applyPreset = (preset: 'conservative' | 'balanced' | 'aggressive') => {
    const presets: Record<string, OptimizationSettings> = {
      conservative: {
        temperature: 0.3,
        maxTokens: 800,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity'],
        autoApplySuggestions: false,
        preserveStyle: true,
        enableQualityComparison: false
      },
      balanced: {
        temperature: 0.7,
        maxTokens: 1000,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity', 'completeness', 'specificity'],
        autoApplySuggestions: false,
        preserveStyle: true,
        enableQualityComparison: true
      },
      aggressive: {
        temperature: 1.0,
        maxTokens: 1500,
        focusArea: 'clarity',
        language: 'zh',
        focusAreas: ['clarity', 'completeness', 'specificity', 'structure', 'examples'],
        autoApplySuggestions: true,
        preserveStyle: false,
        enableQualityComparison: true
      }
    }

    const newSettings = { ...localSettings, ...presets[preset] }
    setLocalSettings(newSettings)
    setCurrentPreset(preset)
    onUpdateSettings(newSettings)
  }

  const handleFocusAreaToggle = (area: string) => {
    const newFocusAreas = localSettings.focusAreas?.includes(area)
      ? localSettings.focusAreas.filter(a => a !== area)
      : [...(localSettings.focusAreas || []), area]

    updateSettings({ focusAreas: newFocusAreas })
  }

  return (
    <div className="space-y-6">
      {/* åŸºæœ¬è®¾ç½® */}
      <div>
        <h3 className="text-lg font-medium text-gray-900 mb-4">åŸºæœ¬è®¾ç½®</h3>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">æ¸©åº¦å€¼</label>
            <div className="flex items-center space-x-3">
              <input
                type="range"
                min="0"
                max="2"
                step="0.1"
                value={localSettings.temperature}
                onChange={(e) => updateSettings({ temperature: parseFloat(e.target.value) })}
                className="flex-1"
              />
              <span className="text-sm text-gray-600 w-12">{localSettings.temperature}</span>
            </div>
            <p className="text-xs text-gray-500 mt-1">æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼Œå€¼è¶Šé«˜è¶Šæœ‰åˆ›é€ æ€§</p>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§ Token æ•°</label>
            <input
              type="number"
              min="100"
              max="4000"
              value={localSettings.maxTokens}
              onChange={(e) => updateSettings({ maxTokens: parseInt(e.target.value) })}
              className="w-full p-2 border border-gray-300 rounded text-sm"
            />
            <p className="text-xs text-gray-500 mt-1">ç”Ÿæˆå†…å®¹çš„æœ€å¤§é•¿åº¦</p>
          </div>
        </div>
      </div>

      {/* ä¼˜åŒ–é‡ç‚¹ */}
      <div>
        <h3 className="text-lg font-medium text-gray-900 mb-4">ä¼˜åŒ–é‡ç‚¹</h3>

        <div className="space-y-3">
          {[
            { key: 'clarity', label: 'æ¸…æ™°åº¦ - ä½¿æç¤ºè¯æ›´æ˜ç¡®æ˜“æ‡‚' },
            { key: 'completeness', label: 'å®Œæ•´æ€§ - è¡¥å……ç¼ºå¤±çš„å…³é”®ä¿¡æ¯' },
            { key: 'specificity', label: 'å…·ä½“æ€§ - å¢åŠ å…·ä½“çš„æŒ‡å¯¼å’Œçº¦æŸ' },
            { key: 'structure', label: 'ç»“æ„ - ä¼˜åŒ–é€»è¾‘ç»“æ„å’Œæµç¨‹' },
            { key: 'examples', label: 'ç¤ºä¾‹ - æ·»åŠ æˆ–æ”¹è¿›ç¤ºä¾‹è¯´æ˜' }
          ].map(({ key, label }) => (
            <label key={key} className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={localSettings.focusAreas?.includes(key) || false}
                onChange={() => handleFocusAreaToggle(key)}
                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span className="text-sm text-gray-700">{label}</span>
            </label>
          ))}
        </div>
      </div>

      {/* è¯­è¨€è®¾ç½® */}
      <div>
        <h3 className="text-lg font-medium text-gray-900 mb-4">è¯­è¨€è®¾ç½®</h3>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">è¾“å‡ºè¯­è¨€</label>
          <select
            value={localSettings.language}
            onChange={(e) => updateSettings({ language: e.target.value })}
            className="w-full p-2 border border-gray-300 rounded text-sm"
          >
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">è‹±æ–‡</option>
            <option value="bilingual">ä¸­è‹±åŒè¯­</option>
          </select>
          <p className="text-xs text-gray-500 mt-1">ä¼˜åŒ–å»ºè®®å’Œè¾“å‡ºå†…å®¹çš„ä½¿ç”¨è¯­è¨€</p>
        </div>
      </div>

      {/* é«˜çº§è®¾ç½® */}
      <div>
        <h3 className="text-lg font-medium text-gray-900 mb-4">é«˜çº§è®¾ç½®</h3>

        <div className="space-y-4">
          <div>
            <label className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={localSettings.autoApplySuggestions || false}
                onChange={(e) => updateSettings({ autoApplySuggestions: e.target.checked })}
                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span className="text-sm text-gray-700">è‡ªåŠ¨åº”ç”¨é«˜ä¼˜å…ˆçº§å»ºè®®</span>
            </label>
            <p className="text-xs text-gray-500 mt-1">ä¼˜å…ˆçº§ä¸º "high" çš„å»ºè®®å°†è‡ªåŠ¨åº”ç”¨</p>
          </div>

          <div>
            <label className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={localSettings.preserveStyle || false}
                onChange={(e) => updateSettings({ preserveStyle: e.target.checked })}
                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span className="text-sm text-gray-700">ä¿æŒåŸæœ‰é£æ ¼</span>
            </label>
            <p className="text-xs text-gray-500 mt-1">å°½é‡ä¿æŒåŸå§‹æç¤ºè¯çš„è¯­è¨€é£æ ¼å’Œè¯­æ°”</p>
          </div>

          <div>
            <label className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={localSettings.enableQualityComparison || false}
                onChange={(e) => updateSettings({ enableQualityComparison: e.target.checked })}
                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span className="text-sm text-gray-700">å¯ç”¨è´¨é‡å¯¹æ¯”</span>
            </label>
            <p className="text-xs text-gray-500 mt-1">æ˜¾ç¤ºä¼˜åŒ–å‰åçš„è´¨é‡è¯„åˆ†å¯¹æ¯”</p>
          </div>
        </div>
      </div>

      {/* é¢„è®¾é…ç½® */}
      <div>
        <h3 className="text-lg font-medium text-gray-900 mb-4">é¢„è®¾é…ç½®</h3>

        <div className="grid grid-cols-3 gap-3">
          <button
            onClick={() => applyPreset('conservative')}
            className={getPresetButtonClass('conservative')}
          >
            <div className={`text-sm font-medium ${getPresetTextClass('conservative')}`}>ä¿å®ˆ</div>
            <div className={`text-xs ${currentPreset === 'conservative' ? 'text-blue-600' : 'text-gray-600'}`}>æœ€å°æ”¹åŠ¨</div>
          </button>

          <button
            onClick={() => applyPreset('balanced')}
            className={getPresetButtonClass('balanced')}
          >
            <div className={`text-sm font-medium ${getPresetTextClass('balanced')}`}>å¹³è¡¡</div>
            <div className={`text-xs ${currentPreset === 'balanced' ? 'text-blue-600' : 'text-blue-600'}`}>æ¨èè®¾ç½®</div>
          </button>

          <button
            onClick={() => applyPreset('aggressive')}
            className={getPresetButtonClass('aggressive')}
          >
            <div className={`text-sm font-medium ${getPresetTextClass('aggressive')}`}>æ¿€è¿›</div>
            <div className={`text-xs ${currentPreset === 'aggressive' ? 'text-blue-600' : 'text-gray-600'}`}>å¤§å¹…ä¼˜åŒ–</div>
          </button>
        </div>
      </div>
    </div>
  )
}
```


## src/components/settings/components/SettingsButton.tsx

```tsx
interface SettingsButtonProps {
  onOpen: () => void
}

export default function SettingsButton({ onOpen: _onOpen }: SettingsButtonProps) {
  // è®¾ç½®æŒ‰é’®å·²éšè—ï¼ˆæ ¹æ® Vue ç‰ˆæœ¬ï¼‰
  return null
}

```


## src/components/settings/components/SettingsHeader.tsx

```tsx
import { X } from 'lucide-react'

interface SettingsHeaderProps {
  activeTab: 'providers' | 'params' | 'prompts'
  onActiveTabChange: (tab: 'providers' | 'params' | 'prompts') => void
  onClose: () => void
}

export default function SettingsHeader({
  activeTab,
  onActiveTabChange,
  onClose
}: SettingsHeaderProps) {
  return (
    <div className="flex items-center justify-between mb-6">
      <div className="flex items-center space-x-4">
        <h2 className="text-xl font-semibold">è®¾ç½®</h2>
        <div className="flex space-x-1">
          <button
            onClick={() => onActiveTabChange('providers')}
            className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
              activeTab === 'providers'
                ? 'bg-blue-100 text-blue-700'
                : 'text-gray-600 hover:text-gray-800'
            }`}
          >
            AIæ¨¡å‹
          </button>
          <button
            onClick={() => onActiveTabChange('params')}
            className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
              activeTab === 'params'
                ? 'bg-blue-100 text-blue-700'
                : 'text-gray-600 hover:text-gray-800'
            }`}
          >
            æ¨¡å‹å‚æ•°
          </button>
          <button
            onClick={() => onActiveTabChange('prompts')}
            className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
              activeTab === 'prompts'
                ? 'bg-blue-100 text-blue-700'
                : 'text-gray-600 hover:text-gray-800'
            }`}
          >
            æç¤ºè¯è§„åˆ™
          </button>
        </div>
      </div>
      <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded">
        <X className="w-5 h-5" />
      </button>
    </div>
  )
}

```


## src/components/settings/components/TestDetailDialog.tsx

```tsx
import { useState, useEffect, useRef } from 'react'
import { Info, Send, Reply, Copy, CheckCircle, XCircle, Clock, Loader2 } from 'lucide-react'
import { useNotificationStore } from '@/stores/notificationStore'
import { createPortal } from 'react-dom'

interface RequestInfo {
  url: string
  method: string
  headers: Record<string, string>
  body: any
}

interface ResponseInfo {
  status?: number
  statusText?: string
  headers?: Record<string, string>
  body?: any
}

interface TestDetailDialogProps {
  visible: boolean
  providerName: string
  modelId: string
  status: 'success' | 'error' | 'timeout' | 'testing'
  requestInfo?: RequestInfo
  responseInfo?: ResponseInfo
  errorMessage?: string
  testTime?: string
  duration?: number
  onClose: () => void
}

export default function TestDetailDialog({
  visible,
  providerName,
  modelId,
  status,
  requestInfo,
  responseInfo,
  errorMessage,
  testTime,
  duration,
  onClose
}: TestDetailDialogProps) {
  const notificationStore = useNotificationStore()
  const [isMinimized, setIsMinimized] = useState(false)
  const [countdown, setCountdown] = useState(5)
  const dialogRef = useRef<HTMLDivElement>(null)
  const minimizedRef = useRef<HTMLDivElement>(null)
  const countdownTimerRef = useRef<ReturnType<typeof setInterval> | null>(null)
  const mouseLeaveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)

  useEffect(() => {
    if (visible) {
      setIsMinimized(false)
      setCountdown(5)
      clearTimers()
    } else {
      clearTimers()
    }
  }, [visible])

  useEffect(() => {
    if (isMinimized && visible) {
      startCountdown()
    }
    return () => clearTimers()
  }, [isMinimized, visible])

  const clearTimers = () => {
    if (countdownTimerRef.current) {
      clearInterval(countdownTimerRef.current)
      countdownTimerRef.current = null
    }
    if (mouseLeaveTimerRef.current) {
      clearTimeout(mouseLeaveTimerRef.current)
      mouseLeaveTimerRef.current = null
    }
  }

  const handleMouseEnter = () => {
    if (isMinimized) {
      setIsMinimized(false)
      clearTimers()
      setCountdown(5)
    }
    if (mouseLeaveTimerRef.current) {
      clearTimeout(mouseLeaveTimerRef.current)
      mouseLeaveTimerRef.current = null
    }
  }

  const handleMouseLeave = () => {
    mouseLeaveTimerRef.current = setTimeout(() => {
      if (!isMinimized) {
        setIsMinimized(true)
      }
    }, 300)
  }

  const expandDialog = () => {
    setIsMinimized(false)
    clearTimers()
    setCountdown(5)
  }

  const startCountdown = () => {
    clearTimers()
    setCountdown(5)
    countdownTimerRef.current = setInterval(() => {
      setCountdown((prev) => {
        if (prev <= 1) {
          handleClose()
          return 0
        }
        return prev - 1
      })
    }, 1000)
  }

  const handleClose = () => {
    clearTimers()
    onClose()
  }

  const formatJSON = (obj: any): string => {
    try {
      return JSON.stringify(obj, null, 2)
    } catch {
      return String(obj)
    }
  }

  const copyToClipboard = async (text: string) => {
    try {
      await navigator.clipboard.writeText(text)
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 1500)
    } catch (error) {
      notificationStore.error('å¤åˆ¶å¤±è´¥', 2000)
    }
  }

  const getStatusBadgeClass = (status: string): string => {
    switch (status) {
      case 'success':
        return 'bg-green-100 text-green-700'
      case 'error':
        return 'bg-red-100 text-red-700'
      case 'timeout':
        return 'bg-yellow-100 text-yellow-700'
      default:
        return 'bg-gray-100 text-gray-700'
    }
  }

  const getStatusText = (status: string): string => {
    switch (status) {
      case 'success':
        return 'æˆåŠŸ'
      case 'error':
        return 'å¤±è´¥'
      case 'timeout':
        return 'è¶…æ—¶'
      default:
        return 'æµ‹è¯•ä¸­'
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'success':
        return CheckCircle
      case 'error':
        return XCircle
      case 'timeout':
        return Clock
      default:
        return Loader2
    }
  }

  const getStatusIconBgClass = (status: string): string => {
    switch (status) {
      case 'success':
        return 'bg-green-500'
      case 'error':
        return 'bg-red-500'
      case 'timeout':
        return 'bg-yellow-500'
      default:
        return 'bg-gray-500'
    }
  }

  if (!visible) return null

  const StatusIcon = getStatusIcon(status)

  const content = (
    <>
      {/* å®Œæ•´å¼¹çª— */}
      {!isMinimized && (
        <div
          className="fixed inset-0 z-[10000] flex items-end justify-end pointer-events-none"
          style={{ display: visible ? 'flex' : 'none' }}
        >
          <div className="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
          <div
            ref={dialogRef}
            onMouseEnter={handleMouseEnter}
            onMouseLeave={handleMouseLeave}
            className="relative bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col pointer-events-auto transform transition-all duration-300 ease-out border border-white/20"
          >
            {/* å¤´éƒ¨ */}
            <div className="relative flex items-center justify-between px-6 py-5 border-b border-gray-200/50 bg-gradient-to-r from-blue-50/80 via-indigo-50/80 to-purple-50/80 backdrop-blur-sm rounded-t-3xl">
              <div className="relative flex items-center gap-3 z-10">
                <div
                  className={`w-3 h-3 rounded-full shadow-lg ${
                    status === 'success'
                      ? 'bg-green-500 shadow-green-500/50'
                      : status === 'error'
                      ? 'bg-red-500 shadow-red-500/50'
                      : status === 'timeout'
                      ? 'bg-yellow-500 shadow-yellow-500/50'
                      : 'bg-gray-400 shadow-gray-400/50'
                  }`}
                ></div>
                <h3 className="text-lg font-semibold text-gray-900">æµ‹è¯•è¯¦æƒ…</h3>
                <span className={`px-2 py-1 text-xs font-medium rounded-full shadow-sm ${getStatusBadgeClass(status)}`}>
                  {getStatusText(status)}
                </span>
              </div>
              <div className="relative flex items-center gap-2 text-xs text-gray-500 z-10">
                <span className="hidden sm:inline">ç§»å‡ºè‡ªåŠ¨ç¼©å°</span>
                <div className="w-1 h-1 rounded-full bg-gray-400 animate-pulse"></div>
              </div>
            </div>

            {/* å†…å®¹åŒºåŸŸ */}
            <div className="flex-1 overflow-y-auto px-6 py-5 space-y-4 bg-gradient-to-b from-white/95 to-white/90">
              {/* åŸºæœ¬ä¿¡æ¯ */}
              <div className="space-y-2">
                <h4 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                  <Info className="w-4 h-4" />
                  åŸºæœ¬ä¿¡æ¯
                </h4>
                <div className="bg-gray-50 rounded-lg p-3 space-y-1 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-600">æä¾›å•†:</span>
                    <span className="text-gray-900 font-medium">{providerName}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">æ¨¡å‹ID:</span>
                    <span className="text-gray-900 font-mono text-xs">{modelId}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">æµ‹è¯•æ—¶é—´:</span>
                    <span className="text-gray-900">{testTime || new Date().toLocaleString('zh-CN')}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">è€—æ—¶:</span>
                    <span className="text-gray-900">{duration || 0}ms</span>
                  </div>
                </div>
              </div>

              {/* è¯·æ±‚ä¿¡æ¯ */}
              {requestInfo && (
                <div className="space-y-2">
                  <h4 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                    <Send className="w-4 h-4" />
                    è¯·æ±‚ä¿¡æ¯
                  </h4>
                  <div className="bg-blue-50 rounded-lg border border-blue-200">
                    <div className="px-4 py-2 border-b border-blue-200 bg-blue-100/50">
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-medium text-blue-800">URL</span>
                        <button
                          onClick={() => copyToClipboard(requestInfo.url || '')}
                          className="text-blue-600 hover:text-blue-800 text-xs"
                          title="å¤åˆ¶URL"
                        >
                          <Copy className="w-3.5 h-3.5" />
                        </button>
                      </div>
                    </div>
                    <div className="px-4 py-2">
                      <code className="text-xs text-blue-900 break-all">{requestInfo.url || 'N/A'}</code>
                    </div>
                  </div>
                  <div className="bg-blue-50 rounded-lg border border-blue-200">
                    <div className="px-4 py-2 border-b border-blue-200 bg-blue-100/50">
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-medium text-blue-800">è¯·æ±‚å¤´</span>
                        <button
                          onClick={() => copyToClipboard(formatJSON(requestInfo.headers || {}))}
                          className="text-blue-600 hover:text-blue-800 text-xs"
                          title="å¤åˆ¶è¯·æ±‚å¤´"
                        >
                          <Copy className="w-3.5 h-3.5" />
                        </button>
                      </div>
                    </div>
                    <pre className="px-4 py-2 text-xs text-blue-900 overflow-x-auto">
                      <code>{formatJSON(requestInfo.headers || {})}</code>
                    </pre>
                  </div>
                  <div className="bg-blue-50 rounded-lg border border-blue-200">
                    <div className="px-4 py-2 border-b border-blue-200 bg-blue-100/50">
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-medium text-blue-800">è¯·æ±‚ä½“</span>
                        <button
                          onClick={() => copyToClipboard(formatJSON(requestInfo.body || {}))}
                          className="text-blue-600 hover:text-blue-800 text-xs"
                          title="å¤åˆ¶è¯·æ±‚ä½“"
                        >
                          <Copy className="w-3.5 h-3.5" />
                        </button>
                      </div>
                    </div>
                    <pre className="px-4 py-2 text-xs text-blue-900 overflow-x-auto max-h-60 overflow-y-auto">
                      <code>{formatJSON(requestInfo.body || {})}</code>
                    </pre>
                  </div>
                </div>
              )}

              {/* å“åº”ä¿¡æ¯ */}
              <div className="space-y-2">
                <h4 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                  <Reply className="w-4 h-4" />
                  å“åº”ä¿¡æ¯
                </h4>
                {responseInfo && (
                  <>
                    <div className="bg-green-50 rounded-lg border border-green-200">
                      <div className="px-4 py-2 border-b border-green-200 bg-green-100/50">
                        <div className="flex items-center justify-between">
                          <span className="text-xs font-medium text-green-800">çŠ¶æ€ç </span>
                          <span
                            className={`px-2 py-0.5 text-xs font-medium rounded ${
                              responseInfo.status
                                ? responseInfo.status >= 200 && responseInfo.status < 300
                                  ? 'bg-green-200 text-green-800'
                                  : 'bg-red-200 text-red-800'
                                : 'bg-gray-200 text-gray-800'
                            }`}
                          >
                            {responseInfo.status || 'N/A'}
                          </span>
                        </div>
                      </div>
                    </div>
                    {responseInfo.headers && (
                      <div className="bg-green-50 rounded-lg border border-green-200">
                        <div className="px-4 py-2 border-b border-green-200 bg-green-100/50">
                          <div className="flex items-center justify-between">
                            <span className="text-xs font-medium text-green-800">å“åº”å¤´</span>
                            <button
                              onClick={() => copyToClipboard(formatJSON(responseInfo.headers || {}))}
                              className="text-green-600 hover:text-green-800 text-xs"
                              title="å¤åˆ¶å“åº”å¤´"
                            >
                              <Copy className="w-3.5 h-3.5" />
                            </button>
                          </div>
                        </div>
                        <pre className="px-4 py-2 text-xs text-green-900 overflow-x-auto">
                          <code>{formatJSON(responseInfo.headers)}</code>
                        </pre>
                      </div>
                    )}
                    {responseInfo.body && (
                      <div className="bg-green-50 rounded-lg border border-green-200">
                        <div className="px-4 py-2 border-b border-green-200 bg-green-100/50">
                          <div className="flex items-center justify-between">
                            <span className="text-xs font-medium text-green-800">å“åº”ä½“</span>
                            <button
                              onClick={() => copyToClipboard(formatJSON(responseInfo.body || {}))}
                              className="text-green-600 hover:text-green-800 text-xs"
                              title="å¤åˆ¶å“åº”ä½“"
                            >
                              <Copy className="w-3.5 h-3.5" />
                            </button>
                          </div>
                        </div>
                        <pre className="px-4 py-2 text-xs text-green-900 overflow-x-auto max-h-60 overflow-y-auto">
                          <code>{formatJSON(responseInfo.body)}</code>
                        </pre>
                      </div>
                    )}
                  </>
                )}
                {errorMessage && (
                  <div className="px-4 py-2 text-xs text-red-700 bg-red-50 rounded">
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> {errorMessage}
                  </div>
                )}
              </div>
            </div>

            {/* åº•éƒ¨æç¤ºæ  */}
            <div className="px-6 py-4 border-t border-gray-200/50 bg-gradient-to-r from-gray-50/80 to-gray-100/80 backdrop-blur-sm rounded-b-3xl flex items-center justify-center">
              <div className="flex items-center gap-2 text-xs text-gray-500">
                <Info className="w-3.5 h-3.5" />
                <span>é¼ æ ‡ç§»å‡ºå¼¹çª—å°†è‡ªåŠ¨ç¼©å°ï¼Œ5ç§’åè‡ªåŠ¨å…³é—­</span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ç¼©å°åçš„çŠ¶æ€å›¾æ ‡ */}
      {isMinimized && (
        <div
          ref={minimizedRef}
          onMouseEnter={handleMouseEnter}
          onClick={expandDialog}
          className="fixed bottom-4 right-4 z-[10000] pointer-events-auto cursor-pointer group"
        >
          <div
            className={`w-16 h-16 rounded-2xl shadow-2xl flex items-center justify-center transition-all duration-300 backdrop-blur-xl border border-white/30 hover:scale-110 hover:shadow-3xl ${getStatusIconBgClass(status)}`}
          >
            <StatusIcon className="w-7 h-7 text-white transition-transform duration-300 group-hover:scale-110" />
          </div>
          {countdown > 0 && (
            <div className="absolute -top-1 -right-1 w-6 h-6 rounded-full bg-gradient-to-br from-red-500 to-red-600 text-white text-xs flex items-center justify-center font-bold shadow-lg border-2 border-white/50 backdrop-blur-sm">
              {countdown}
            </div>
          )}
          <div className="absolute bottom-full right-0 mb-2 px-3 py-1.5 bg-gray-900/90 backdrop-blur-sm text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
            ç‚¹å‡»å±•å¼€è¯¦æƒ…
            <div className="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900/90"></div>
          </div>
        </div>
      )}
    </>
  )

  return createPortal(content, document.body)
}

```


## src/components/settings/components/tabs/ModelParamsTab.tsx

```tsx
import { useState, useEffect } from 'react'
import { useModelParams } from '../../composables/useModelParams'
import { useSettingsStore } from '@/stores/settingsStore'
import { useConfirmDialog } from '@/composables/useConfirmDialog'
import { useNotificationStore } from '@/stores/notificationStore'
import type { ModelParams } from '@/stores/settingsStore'

export default function ModelParamsTab() {
  const settingsStore = useSettingsStore()
  const {
    getCurrentParams,
    updateCurrentModelParams,
    resetToDefaults,
    isParamSupported,
    getParamRange,
    getParamLabel,
    getParamDescription
  } = useModelParams()
  const { confirm } = useConfirmDialog()
  const notificationStore = useNotificationStore()

  const [params, setParams] = useState<ModelParams>(getCurrentParams())

  // ç›‘å¬å…¨å±€å‚æ•°å˜åŒ–
  useEffect(() => {
    setParams(getCurrentParams())
  }, [settingsStore.globalModelParams])

  const handleParamChange = (paramName: keyof ModelParams, value: number) => {
    // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆç”¨äº UI å“åº”ï¼‰
    setParams((prev) => ({
      ...prev,
      [paramName]: value
    }))

    // ä¿å­˜åˆ° store
    updateCurrentModelParams({
      [paramName]: value
    })
  }

  const handleReset = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®æ¨¡å‹å‚æ•°ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      resetToDefaults()
      setParams(getCurrentParams())
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  return (
    <div className="space-y-6">
      {/* å‚æ•°é…ç½®è¡¨å• */}
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-900">æ¨¡å‹å‚æ•°</h3>
          <button
            onClick={handleReset}
            className="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            é‡ç½®ä¸ºé»˜è®¤å€¼
          </button>
        </div>

        {/* Temperature */}
        {isParamSupported('temperature') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('temperature')}
              </label>
              <input
                type="number"
                value={params.temperature}
                onChange={(e) => handleParamChange('temperature', parseFloat(e.target.value))}
                min={getParamRange('temperature').min}
                max={getParamRange('temperature').max}
                step={getParamRange('temperature').step}
                className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.temperature}
              onChange={(e) => handleParamChange('temperature', parseFloat(e.target.value))}
              min={getParamRange('temperature').min}
              max={getParamRange('temperature').max}
              step={getParamRange('temperature').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('temperature')}</p>
          </div>
        )}

        {/* Max Tokens */}
        {isParamSupported('maxTokens') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('maxTokens')}
              </label>
              <input
                type="number"
                value={params.maxTokens}
                onChange={(e) => handleParamChange('maxTokens', parseInt(e.target.value))}
                min={getParamRange('maxTokens').min}
                max={getParamRange('maxTokens').max}
                step={getParamRange('maxTokens').step}
                className="w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.maxTokens}
              onChange={(e) => handleParamChange('maxTokens', parseInt(e.target.value))}
              min={getParamRange('maxTokens').min}
              max={getParamRange('maxTokens').max}
              step={getParamRange('maxTokens').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('maxTokens')}</p>
          </div>
        )}

        {/* Top P */}
        {isParamSupported('topP') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('topP')}
              </label>
              <input
                type="number"
                value={params.topP}
                onChange={(e) => handleParamChange('topP', parseFloat(e.target.value))}
                min={getParamRange('topP').min}
                max={getParamRange('topP').max}
                step={getParamRange('topP').step}
                className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.topP}
              onChange={(e) => handleParamChange('topP', parseFloat(e.target.value))}
              min={getParamRange('topP').min}
              max={getParamRange('topP').max}
              step={getParamRange('topP').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('topP')}</p>
          </div>
        )}

        {/* Frequency Penalty (OpenAI only) */}
        {isParamSupported('frequencyPenalty') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('frequencyPenalty')}
              </label>
              <input
                type="number"
                value={params.frequencyPenalty}
                onChange={(e) => handleParamChange('frequencyPenalty', parseFloat(e.target.value))}
                min={getParamRange('frequencyPenalty').min}
                max={getParamRange('frequencyPenalty').max}
                step={getParamRange('frequencyPenalty').step}
                className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.frequencyPenalty}
              onChange={(e) => handleParamChange('frequencyPenalty', parseFloat(e.target.value))}
              min={getParamRange('frequencyPenalty').min}
              max={getParamRange('frequencyPenalty').max}
              step={getParamRange('frequencyPenalty').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('frequencyPenalty')}</p>
          </div>
        )}

        {/* Presence Penalty (OpenAI only) */}
        {isParamSupported('presencePenalty') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('presencePenalty')}
              </label>
              <input
                type="number"
                value={params.presencePenalty}
                onChange={(e) => handleParamChange('presencePenalty', parseFloat(e.target.value))}
                min={getParamRange('presencePenalty').min}
                max={getParamRange('presencePenalty').max}
                step={getParamRange('presencePenalty').step}
                className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.presencePenalty}
              onChange={(e) => handleParamChange('presencePenalty', parseFloat(e.target.value))}
              min={getParamRange('presencePenalty').min}
              max={getParamRange('presencePenalty').max}
              step={getParamRange('presencePenalty').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('presencePenalty')}</p>
          </div>
        )}

        {/* Top K (Claude/Gemini only) */}
        {isParamSupported('topK') && (
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-gray-700">
                {getParamLabel('topK')}
              </label>
              <input
                type="number"
                value={params.topK}
                onChange={(e) => handleParamChange('topK', parseInt(e.target.value))}
                min={getParamRange('topK').min}
                max={getParamRange('topK').max}
                step={getParamRange('topK').step}
                className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <input
              type="range"
              value={params.topK}
              onChange={(e) => handleParamChange('topK', parseInt(e.target.value))}
              min={getParamRange('topK').min}
              max={getParamRange('topK').max}
              step={getParamRange('topK').step}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <p className="text-xs text-gray-500">{getParamDescription('topK')}</p>
          </div>
        )}

        {/* å‚æ•°è¯´æ˜ */}
        <div className="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <h4 className="text-sm font-medium text-gray-900 mb-2">å‚æ•°è¯´æ˜</h4>
          <ul className="text-xs text-gray-600 space-y-1">
            <li>â€¢ Temperature: æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼ˆ0-2ï¼‰</li>
            <li>â€¢ Max Tokens: ç”Ÿæˆçš„æœ€å¤§tokenæ•°é‡</li>
            <li>â€¢ Top P: æ ¸é‡‡æ ·å‚æ•°ï¼Œæ§åˆ¶è€ƒè™‘çš„è¯æ±‡èŒƒå›´</li>
            <li>â€¢ Frequency Penalty: é™ä½é‡å¤è¯æ±‡çš„é¢‘ç‡ï¼ˆOpenAIï¼‰</li>
            <li>â€¢ Presence Penalty: é¼“åŠ±æ¨¡å‹è°ˆè®ºæ–°è¯é¢˜ï¼ˆOpenAIï¼‰</li>
            <li>â€¢ Top K: åªè€ƒè™‘æ¦‚ç‡æœ€é«˜çš„Kä¸ªè¯æ±‡ï¼ˆClaude/Geminiï¼‰</li>
            <li className="mt-2">è¿™äº›å‚æ•°ä¼šå…¨å±€åº”ç”¨åˆ°æ‰€æœ‰AIæ¨¡å‹ï¼Œæ— éœ€å•ç‹¬é…ç½®</li>
          </ul>
        </div>
      </div>
    </div>
  )
}

```


## src/components/settings/components/tabs/PromptsTab.tsx

```tsx
import { useState } from 'react'
import { ChevronDown } from 'lucide-react'
import { useSettingsStore } from '@/stores/settingsStore'

interface PromptsTabProps {
  onResetSystem: () => void
  onResetUser: () => void
  onResetRequirement: () => void
  onResetQualityAnalysisSystem: () => void
  onResetThinking: () => void
  onResetGeneration: () => void
  onResetAdvice: () => void
  onResetApplication: () => void
  onToggleSlimRules: () => void
  onResetUserPromptQualityAnalysis: () => void
  onResetUserPromptQuickOptimization: () => void
}

export default function PromptsTab({
  onResetSystem,
  onResetUser,
  onResetRequirement,
  onResetQualityAnalysisSystem,
  onResetThinking,
  onResetGeneration,
  onResetAdvice,
  onResetApplication,
  onToggleSlimRules,
  onResetUserPromptQualityAnalysis,
  onResetUserPromptQuickOptimization
}: PromptsTabProps) {
  const settingsStore = useSettingsStore()
  const [showGenerateRules, setShowGenerateRules] = useState(true)
  const [showOptimizeRules, setShowOptimizeRules] = useState(false)

  return (
    <div className="space-y-6">
      {/* ç”Ÿæˆè§„åˆ™åŒºåŸŸ */}
      <div className="border border-gray-300 rounded-lg overflow-hidden">
        <button
          onClick={() => setShowGenerateRules(!showGenerateRules)}
          className="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 flex items-center justify-between transition-colors"
        >
          <div className="flex items-center gap-2">
            <ChevronDown
              className={`w-5 h-5 text-blue-600 transition-transform ${
                showGenerateRules ? 'transform rotate-180' : ''
              }`}
            />
            <h2 className="text-lg font-semibold text-blue-900">ç”Ÿæˆè§„åˆ™</h2>
          </div>
          <span className="text-xs text-blue-600">ç”¨äºæç¤ºè¯ç”ŸæˆåŠŸèƒ½</span>
        </button>

        {showGenerateRules && (
          <div className="p-4 space-y-6 bg-white">
            {/* ç³»ç»Ÿæç¤ºè¯è§„åˆ™ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-medium">ç³»ç»Ÿæç¤ºè¯è§„åˆ™</h3>
                <div className="flex items-center space-x-3">
                  <label 
                    className="flex items-center space-x-2 cursor-pointer select-none"
                    onClick={(e) => {
                      e.preventDefault()
                      onToggleSlimRules()
                    }}
                  >
                    <span className="text-sm text-gray-600">ç²¾ç®€ç‰ˆ</span>
                    <div className="relative w-11 h-6">
                      <input
                        type="checkbox"
                        checked={settingsStore.useSlimRules}
                        className="sr-only"
                        readOnly
                        tabIndex={-1}
                      />
                      <div className={`w-11 h-6 rounded-full transition-all duration-200 ${
                        settingsStore.useSlimRules ? 'bg-blue-600' : 'bg-gray-300'
                      }`}>
                        <div className={`absolute top-[2px] left-[2px] h-5 w-5 bg-white border border-gray-300 rounded-full transition-all duration-200 ${
                          settingsStore.useSlimRules ? 'translate-x-5' : 'translate-x-0'
                        }`}></div>
                      </div>
                    </div>
                  </label>
                  <button
                    onClick={onResetSystem}
                    className="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                  >
                    é‡ç½®ä¸ºé»˜è®¤
                  </button>
                </div>
              </div>
              <textarea
                value={settingsStore.editingSystemRules}
                onChange={(e) => {
                  useSettingsStore.setState({ editingSystemRules: e.target.value })
                }}
                placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯è§„åˆ™..."
                className="w-full h-48 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
              />
              <p className="text-xs text-gray-500 mt-1">
                ç³»ç»Ÿæç¤ºè¯åŒ…å«AIæç¤ºè¯å·¥ç¨‹çš„å®Œæ•´æŒ‡å—ï¼Œç”¨äºç”Ÿæˆé«˜è´¨é‡çš„æç¤ºè¯ã€‚
              </p>
            </div>

            {/* ç”¨æˆ·å¼•å¯¼è§„åˆ™ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-medium">ç”¨æˆ·å¼•å¯¼è§„åˆ™</h3>
                <button
                  onClick={onResetUser}
                  className="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                >
                  é‡ç½®ä¸ºé»˜è®¤
                </button>
              </div>
              <textarea
                value={settingsStore.editingUserRules}
                onChange={(e) => {
                  useSettingsStore.setState({ editingUserRules: e.target.value })
                }}
                placeholder="è¾“å…¥ç”¨æˆ·å¼•å¯¼è§„åˆ™..."
                className="w-full h-48 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
              />
              <p className="text-xs text-gray-500 mt-1">
                ç”¨æˆ·å¼•å¯¼è§„åˆ™å®šä¹‰AIåŠ©æ‰‹åœ¨å¯¹è¯ä¸­çš„è¡Œä¸ºæ–¹å¼ï¼ŒåŒ…æ‹¬æ™ºèƒ½åˆ¤æ–­å’Œå¯¹è¯ç»ˆæ­¢æœºåˆ¶ã€‚
              </p>
            </div>

            {/* éœ€æ±‚æŠ¥å‘Šè§„åˆ™ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-medium">éœ€æ±‚æŠ¥å‘Šè§„åˆ™</h3>
                <button
                  onClick={onResetRequirement}
                  className="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                >
                  é‡ç½®ä¸ºé»˜è®¤
                </button>
              </div>
              <textarea
                value={settingsStore.editingRequirementReportRules}
                onChange={(e) => {
                  useSettingsStore.setState({ editingRequirementReportRules: e.target.value })
                }}
                placeholder="è¾“å…¥éœ€æ±‚æŠ¥å‘Šç”Ÿæˆè§„åˆ™..."
                className="w-full h-48 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
              />
              <p className="text-xs text-gray-500 mt-1">
                éœ€æ±‚æŠ¥å‘Šè§„åˆ™ç”¨äºåŸºäºç”¨æˆ·å¯¹è¯å†å²ç”Ÿæˆå®Œæ•´çš„éœ€æ±‚æ€»ç»“æŠ¥å‘Šã€‚
              </p>
            </div>

            {/* æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™ */}
            <div>
              <div className="mb-3">
                <h3 className="text-lg font-medium">æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™</h3>
              </div>
              <div className="space-y-4">
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">å…³é”®æŒ‡ä»¤æå–</h4>
                    <button
                      onClick={onResetThinking}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.THINKING_POINTS_EXTRACTION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          THINKING_POINTS_EXTRACTION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥å…³é”®æŒ‡ä»¤æå–è§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
                  />
                </div>

                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆ</h4>
                    <button
                      onClick={onResetGeneration}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.SYSTEM_PROMPT_GENERATION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          SYSTEM_PROMPT_GENERATION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆè§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
                  />
                </div>

                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">ä¼˜åŒ–å»ºè®®ç”Ÿæˆ</h4>
                    <button
                      onClick={onResetAdvice}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.OPTIMIZATION_ADVICE_GENERATION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          OPTIMIZATION_ADVICE_GENERATION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥ä¼˜åŒ–å»ºè®®ç”Ÿæˆè§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
                  />
                </div>

                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">ä¼˜åŒ–åº”ç”¨</h4>
                    <button
                      onClick={onResetApplication}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.OPTIMIZATION_APPLICATION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          OPTIMIZATION_APPLICATION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥ä¼˜åŒ–åº”ç”¨è§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-xs"
                  />
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™ç”¨äºæ§åˆ¶æç¤ºè¯ç”Ÿæˆå™¨çš„å„ä¸ªæ­¥éª¤çš„ç³»ç»Ÿæç¤ºè¯ã€‚
              </p>
            </div>
          </div>
        )}
      </div>

      {/* ä¼˜åŒ–è§„åˆ™åŒºåŸŸ */}
      <div className="border border-gray-300 rounded-lg overflow-hidden">
        <button
          onClick={() => setShowOptimizeRules(!showOptimizeRules)}
          className="w-full px-4 py-3 bg-green-50 hover:bg-green-100 flex items-center justify-between transition-colors"
        >
          <div className="flex items-center gap-2">
            <ChevronDown
              className={`w-5 h-5 text-green-600 transition-transform ${
                showOptimizeRules ? 'transform rotate-180' : ''
              }`}
            />
            <h2 className="text-lg font-semibold text-green-900">ä¼˜åŒ–è§„åˆ™</h2>
          </div>
          <span className="text-xs text-green-600">ç”¨äºæç¤ºè¯ä¼˜åŒ–åŠŸèƒ½</span>
        </button>

        {showOptimizeRules && (
          <div className="p-4 space-y-6 bg-white">
            {/* ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–è§„åˆ™ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-medium">ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–</h3>
              </div>
              <p className="text-sm text-gray-600 mb-3">
                ä¸‰æ®µå¼ä¼˜åŒ–æµç¨‹ï¼šè´¨é‡åˆ†æ â†’ ä¼˜åŒ–å»ºè®® â†’ åº”ç”¨ä¼˜åŒ–
              </p>

              <div className="space-y-4 pl-4 border-l-2 border-green-200">
                {/* 1. è´¨é‡åˆ†æ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">
                      1. è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯
                    </h4>
                    <button
                      onClick={onResetQualityAnalysisSystem}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingQualityAnalysisRules.systemPrompt}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingQualityAnalysisRules: {
                          ...settingsStore.editingQualityAnalysisRules,
                          systemPrompt: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-xs"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    åˆ†ææç¤ºè¯çš„ç»“æ„ã€æ¸…æ™°åº¦ã€å®Œæ•´æ€§ç­‰è´¨é‡é—®é¢˜
                  </p>
                </div>

                {/* 2. ä¼˜åŒ–å»ºè®®ç”Ÿæˆ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">2. ä¼˜åŒ–å»ºè®®ç”Ÿæˆ</h4>
                    <button
                      onClick={onResetAdvice}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.OPTIMIZATION_ADVICE_GENERATION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          OPTIMIZATION_ADVICE_GENERATION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥ä¼˜åŒ–å»ºè®®ç”Ÿæˆè§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-xs"
                  />
                  <p className="text-xs text-gray-500 mt-1">åŸºäºè´¨é‡åˆ†æç»“æœç”Ÿæˆå…·ä½“çš„ä¼˜åŒ–å»ºè®®</p>
                </div>

                {/* 3. ä¼˜åŒ–åº”ç”¨ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">3. ä¼˜åŒ–åº”ç”¨</h4>
                    <button
                      onClick={onResetApplication}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingFinalPromptRules.OPTIMIZATION_APPLICATION}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingFinalPromptRules: {
                          ...settingsStore.editingFinalPromptRules,
                          OPTIMIZATION_APPLICATION: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥ä¼˜åŒ–åº”ç”¨è§„åˆ™..."
                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-xs"
                  />
                  <p className="text-xs text-gray-500 mt-1">æ ¹æ®ä¼˜åŒ–å»ºè®®ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯</p>
                </div>
              </div>
            </div>

            {/* ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–è§„åˆ™ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-medium">ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–</h3>
              </div>
              <p className="text-sm text-gray-600 mb-3">ä¸¤æ®µå¼ä¼˜åŒ–æµç¨‹ï¼šè´¨é‡åˆ†æ â†’ å¿«é€Ÿä¼˜åŒ–</p>

              <div className="space-y-4 pl-4 border-l-2 border-green-200">
                {/* 1. è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">
                      1. è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯
                    </h4>
                    <button
                      onClick={onResetUserPromptQualityAnalysis}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingUserPromptOptimizationRules.qualityAnalysis}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingUserPromptOptimizationRules: {
                          ...settingsStore.editingUserPromptOptimizationRules,
                          qualityAnalysis: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯..."
                    className="w-full h-48 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-xs"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    åˆ†æç”¨æˆ·è‰ç¨¿çš„æ¸…æ™°åº¦ã€ç‰¹å®šæ€§ã€ç»“æ„ã€ä¸Šä¸‹æ–‡ã€å®Œæ•´æ€§ç­‰ç»´åº¦ï¼Œè¾“å‡ºJSONæ ¼å¼çš„åˆ†æç»“æœ
                  </p>
                </div>

                {/* 2. å¿«é€Ÿä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">2. å¿«é€Ÿä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯</h4>
                    <button
                      onClick={onResetUserPromptQuickOptimization}
                      className="px-2.5 py-1 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                    >
                      é‡ç½®ä¸ºé»˜è®¤
                    </button>
                  </div>
                  <textarea
                    value={settingsStore.editingUserPromptOptimizationRules.quickOptimization}
                    onChange={(e) => {
                      useSettingsStore.setState({
                        editingUserPromptOptimizationRules: {
                          ...settingsStore.editingUserPromptOptimizationRules,
                          quickOptimization: e.target.value
                        }
                      })
                    }}
                    placeholder="è¾“å…¥å¿«é€Ÿä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯..."
                    className="w-full h-48 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-xs"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    æ ¹æ®è´¨é‡åˆ†æç»“æœä¼˜åŒ–ç”¨æˆ·è‰ç¨¿ï¼ŒåŒ…å«è§’è‰²é˜²æ··æ·†ã€é•¿åº¦æ§åˆ¶ã€è‡ªç„¶è¯­è¨€é£æ ¼ç­‰å®Œæ•´è§„åˆ™
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

```


## src/components/settings/components/tabs/ProvidersTab.tsx

```tsx
import { useState, useEffect } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import {
  Settings,
  AlertCircle,
  RefreshCw,
  Play,
  CheckCircle,
  XCircle,
  Clock,
  Eye,
  EyeOff
} from 'lucide-react'
import type { ProviderConfig } from '@/stores/providerStore'
import { useSettingsStore } from '@/stores/settingsStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { AIService } from '@/services/aiService'
import TestDetailDialog from '../TestDetailDialog'
import type { ModelParams } from '@/stores/settingsStore'

interface ProvidersTabProps {
  providers: ProviderConfig[]
  lastRefreshedAt: Date | null
  isLoading: boolean
  onRefreshConfig: () => void
}

export default function ProvidersTab({
  providers,
  lastRefreshedAt,
  isLoading,
  onRefreshConfig
}: ProvidersTabProps) {
  const settingsStore = useSettingsStore()
  const notificationStore = useNotificationStore()
  const providerStore = useProviderStore()
  
  // è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰ providers çŠ¶æ€
  useEffect(() => {
    console.log('[ProvidersTab] å½“å‰ providers (props):', providers)
    console.log('[ProvidersTab] providers æ•°é‡ (props):', providers.length)
    console.log('[ProvidersTab] providerStore.allProviders:', providerStore.allProviders)
    console.log('[ProvidersTab] providerStore.allProviders æ•°é‡:', providerStore.allProviders.length)
    console.log('[ProvidersTab] providerStore.isInitialized:', providerStore.isInitialized)
    console.log('[ProvidersTab] providerStore.error:', providerStore.error)
    
    // å¦‚æœ props ä¸­çš„ providers ä¸ºç©ºï¼Œä½† store ä¸­æœ‰æ•°æ®ï¼Œè®°å½•è­¦å‘Š
    if (providers.length === 0 && providerStore.allProviders.length > 0) {
      console.warn('[ProvidersTab] è­¦å‘Š: props.providers ä¸ºç©ºï¼Œä½† store ä¸­æœ‰æ•°æ®')
    }
  }, [providers, providerStore.allProviders, providerStore.isInitialized, providerStore.error])

  const [testingModels, setTestingModels] = useState<Set<string>>(new Set())
  const [testResults, setTestResults] = useState<Map<string, 'success' | 'error' | 'timeout'>>(
    new Map()
  )
  const [showDetailDialog, setShowDetailDialog] = useState(false)
  const [visibleApiKeys, setVisibleApiKeys] = useState<Set<string>>(new Set())
  const [detailInfo, setDetailInfo] = useState<{
    providerName: string
    modelId: string
    status: 'success' | 'error' | 'timeout' | 'testing'
    requestInfo?: {
      url: string
      method: string
      headers: Record<string, string>
      body: any
    }
    responseInfo?: {
      status?: number
      statusText?: string
      headers?: Record<string, string>
      body?: any
    }
    errorMessage?: string
    testTime?: string
    duration?: number
  }>({
    providerName: '',
    modelId: '',
    status: 'testing'
  })

  const formatTime = (date: Date) => {
    return new Intl.DateTimeFormat('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }).format(date)
  }

  const getProviderTypeColor = (type: string) => {
    const colors: Record<string, string> = {
      openai: 'bg-green-100 text-green-700',
      anthropic: 'bg-orange-100 text-orange-700',
      google: 'bg-blue-100 text-blue-700',
      custom: 'bg-purple-100 text-purple-700'
    }
    return colors[type] || 'bg-gray-100 text-gray-700'
  }

  const getProviderTypeLabel = (type: string) => {
    const labels: Record<string, string> = {
      openai: 'OpenAI',
      anthropic: 'Anthropic',
      google: 'Google',
      custom: 'è‡ªå®šä¹‰'
    }
    return labels[type] || type
  }

  const getApiTypeColor = (apiType: string) => {
    const colors: Record<string, string> = {
      openai: 'bg-green-50 text-green-600 border border-green-200',
      anthropic: 'bg-orange-50 text-orange-600 border border-orange-200',
      google: 'bg-blue-50 text-blue-600 border border-blue-200'
    }
    return colors[apiType] || 'bg-gray-50 text-gray-600 border border-gray-200'
  }

  const getApiTypeLabel = (apiType: string) => {
    const labels: Record<string, string> = {
      openai: 'OpenAI API',
      anthropic: 'Claude API',
      google: 'Gemini API'
    }
    return labels[apiType] || apiType
  }

  const getTestButtonClass = (providerId: string, modelId: string): string => {
    const testKey = `${providerId}-${modelId}`
    const isTesting = testingModels.has(testKey)
    const result = testResults.get(testKey)

    if (isTesting) {
      return 'bg-blue-100 text-blue-700 border border-blue-300 cursor-wait'
    }

    switch (result) {
      case 'success':
        return 'bg-green-100 text-green-700 border border-green-300 hover:bg-green-200'
      case 'error':
        return 'bg-red-100 text-red-700 border border-red-300 hover:bg-red-200'
      case 'timeout':
        return 'bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200'
      default:
        return 'bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200'
    }
  }

  const getTestButtonIcon = (providerId: string, modelId: string) => {
    const testKey = `${providerId}-${modelId}`
    const isTesting = testingModels.has(testKey)
    const result = testResults.get(testKey)

    if (isTesting) {
      return RefreshCw
    }

    switch (result) {
      case 'success':
        return CheckCircle
      case 'error':
        return XCircle
      case 'timeout':
        return Clock
      default:
        return Play
    }
  }

  const getTestButtonText = (providerId: string, modelId: string): string => {
    const testKey = `${providerId}-${modelId}`
    const isTesting = testingModels.has(testKey)
    const result = testResults.get(testKey)

    if (isTesting) {
      return 'æµ‹è¯•ä¸­...'
    }

    switch (result) {
      case 'success':
        return 'æˆåŠŸ'
      case 'error':
        return 'å¤±è´¥'
      case 'timeout':
        return 'è¶…æ—¶'
      default:
        return 'æµ‹è¯•'
    }
  }

  const getTestButtonTitle = (providerId: string, modelId: string): string => {
    const testKey = `${providerId}-${modelId}`
    const isTesting = testingModels.has(testKey)
    const result = testResults.get(testKey)

    if (isTesting) {
      return 'æ­£åœ¨æµ‹è¯•æ¨¡å‹è¿æ¥...'
    }

    switch (result) {
      case 'success':
        return 'æ¨¡å‹æµ‹è¯•æˆåŠŸ'
      case 'error':
        return 'æ¨¡å‹æµ‹è¯•å¤±è´¥'
      case 'timeout':
        return 'æ¨¡å‹æµ‹è¯•è¶…æ—¶ï¼ˆ10ç§’ï¼‰'
      default:
        return 'ç‚¹å‡»æµ‹è¯•æ¨¡å‹è¿æ¥'
    }
  }

  const buildRequestInfo = (
    provider: ProviderConfig,
    modelId: string,
    messages: any[],
    params: ModelParams
  ): {
    url: string
    method: string
    headers: Record<string, string>
    body: any
  } => {
    const model = provider.models.find((m) => m.id === modelId)
    const apiType = model?.apiType || provider.type

    let url = provider.baseUrl || ''
    let headers: Record<string, string> = {
      'Content-Type': 'application/json'
    }
    let body: any = {}

    if (apiType === 'openai') {
      if (url.includes('/chat/completions')) {
        // å·²ç»æ˜¯å®Œæ•´URL
      } else if (url.includes('/v1')) {
        url = url.replace(/\/+$/, '') + '/chat/completions'
      } else {
        url = url.replace(/\/+$/, '') + '/v1/chat/completions'
      }
      headers['Authorization'] = `Bearer ${provider.apiKey}`
      body = {
        model: modelId,
        messages: messages.map((msg: any) => ({
          role: msg.type === 'ai' ? 'assistant' : 'user',
          content: msg.content
        })),
        temperature: params.temperature ?? 1.0,
        max_tokens: params.maxTokens ?? 8192,
        top_p: params.topP ?? 0.95
      }
      if (params.frequencyPenalty !== undefined) {
        body.frequency_penalty = params.frequencyPenalty
      }
      if (params.presencePenalty !== undefined) {
        body.presence_penalty = params.presencePenalty
      }
    } else if (apiType === 'anthropic') {
      if (!url.includes('/v1/messages')) {
        url = url.replace(/\/+$/, '') + '/v1/messages'
      }
      headers['x-api-key'] = provider.apiKey || ''
      headers['anthropic-version'] = '2023-06-01'
      headers['anthropic-dangerous-direct-browser-access'] = 'true'
      body = {
        model: modelId,
        max_tokens: params.maxTokens ?? 8192,
        temperature: params.temperature ?? 1.0,
        messages: messages.map((msg: any) => ({
          role: msg.type === 'ai' ? 'assistant' : 'user',
          content: msg.content
        }))
      }
      if (params.topP !== undefined) {
        body.top_p = params.topP
      }
      if (params.topK !== undefined && params.topK > 0) {
        body.top_k = params.topK
      }
    } else if (apiType === 'google') {
      if (!url.endsWith('/v1beta')) {
        if (url.includes('/models/')) {
          url = url.split('/models/')[0]
        }
        if (!url.endsWith('/v1beta')) {
          url = url.replace(/\/+$/, '') + '/v1beta'
        }
      }
      url = `${url}/models/${modelId}:generateContent`
      headers['x-goog-api-key'] = provider.apiKey || ''
      body = {
        contents: messages.map((msg: any) => ({
          role: msg.type === 'ai' ? 'model' : 'user',
          parts: [{ text: msg.content }]
        })),
        generationConfig: {
          temperature: params.temperature ?? 1.0,
          maxOutputTokens: params.maxTokens ?? 8192
        }
      }
      if (params.topP !== undefined) {
        body.generationConfig.topP = params.topP
      }
      if (params.topK !== undefined && params.topK > 0) {
        body.generationConfig.topK = params.topK
      }
    }

    return {
      url,
      method: 'POST',
      headers,
      body
    }
  }

  const testModel = async (provider: ProviderConfig, modelId: string) => {
    const testKey = `${provider.id}-${modelId}`

    if (!provider.apiKey) {
      notificationStore.warning('è¯·å…ˆé…ç½® API Key', 2000)
      return
    }

    if (testingModels.has(testKey)) {
      return
    }

    setTestingModels((prev) => new Set(prev).add(testKey))
    setTestResults((prev) => {
      const newMap = new Map(prev)
      newMap.delete(testKey)
      return newMap
    })

    const startTime = Date.now()
    const testMessages: Array<{ type: 'user' | 'ai'; content: string; timestamp: string }> = [
      { type: 'user', content: 'ä½ å¥½', timestamp: new Date().toISOString() }
    ]

    const globalParams = settingsStore.globalModelParams
    console.log('[ProvidersTab] ä½¿ç”¨å…¨å±€æ¨¡å‹å‚æ•°è¿›è¡Œæµ‹è¯•:', globalParams)

    const requestInfo = buildRequestInfo(provider, modelId, testMessages, globalParams)

    const sanitizedHeaders: Record<string, string> = { ...requestInfo.headers }
    if (sanitizedHeaders['Authorization']) {
      sanitizedHeaders['Authorization'] = 'Bearer ***'
    }
    if (sanitizedHeaders['x-api-key']) {
      sanitizedHeaders['x-api-key'] = '***'
    }
    if (sanitizedHeaders['x-goog-api-key']) {
      sanitizedHeaders['x-goog-api-key'] = '***'
    }

    setDetailInfo({
      providerName: provider.name,
      modelId: modelId,
      status: 'testing',
      requestInfo: {
        ...requestInfo,
        headers: sanitizedHeaders
      },
      testTime: new Date().toLocaleString('zh-CN')
    })

    setShowDetailDialog(true)

    try {
      const originalFetch = window.fetch
      let responseBody: any = null
      let responseHeaders: Record<string, string> = {}
      let responseStatus: number | undefined = undefined
      let responseStatusText: string | undefined = undefined

      window.fetch = async (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {
        const response = await originalFetch(input, init)
        responseStatus = response.status
        responseStatusText = response.statusText

        const clonedResponse = response.clone()

        response.headers.forEach((value, key) => {
          responseHeaders[key] = value
        })

        try {
          const contentType = response.headers.get('content-type') || ''
          if (contentType.includes('application/json')) {
            responseBody = await clonedResponse.json()
          } else {
            const text = await clonedResponse.text()
            responseBody = { raw: text }
          }
        } catch (e) {
          responseBody = { error: 'æ— æ³•è§£æå“åº”ä½“' }
        }

        return response
      }

      const aiService = AIService.getInstance()

      const timeoutPromise = new Promise<never>((_, reject) => {
        setTimeout(() => {
          window.fetch = originalFetch
          reject(new Error('TIMEOUT'))
        }, 10000)
      })

      const testPromise = aiService.callAI(testMessages, provider, modelId, false)

      try {
        await Promise.race([testPromise, timeoutPromise])
        window.fetch = originalFetch

        const duration = Date.now() - startTime

        setTestResults((prev) => {
          const newMap = new Map(prev)
          newMap.set(testKey, 'success')
          return newMap
        })
        setDetailInfo((prev) => ({
          ...prev,
          status: 'success',
          duration,
          responseInfo: {
            status: responseStatus,
            statusText: responseStatusText,
            headers: responseHeaders,
            body: responseBody
          }
        }))

        notificationStore.success(`æ¨¡å‹ ${modelId} æµ‹è¯•æˆåŠŸ`, 2000)
      } catch (error: any) {
        window.fetch = originalFetch

        const duration = Date.now() - startTime

        if (error?.message === 'TIMEOUT') {
          setTestResults((prev) => {
            const newMap = new Map(prev)
            newMap.set(testKey, 'timeout')
            return newMap
          })
          setDetailInfo((prev) => ({
            ...prev,
            status: 'timeout',
            duration,
            errorMessage: 'è¯·æ±‚è¶…æ—¶ï¼ˆ10ç§’ï¼‰'
          }))
          notificationStore.warning(`æ¨¡å‹ ${modelId} æµ‹è¯•è¶…æ—¶ï¼ˆ10ç§’ï¼‰`, 3000)
        } else {
          setTestResults((prev) => {
            const newMap = new Map(prev)
            newMap.set(testKey, 'error')
            return newMap
          })
          setDetailInfo((prev) => ({
            ...prev,
            status: 'error',
            duration,
            errorMessage: error?.message || 'è¯·æ±‚å¤±è´¥',
            responseInfo: {
              status: responseStatus,
              statusText: responseStatusText,
              headers: responseHeaders,
              body: responseBody || (error?.error ? { error: error.error } : null)
            }
          }))
          const errorMsg = error?.message || 'è¯·æ±‚å¤±è´¥'
          notificationStore.error(`æ¨¡å‹ ${modelId} æµ‹è¯•å¤±è´¥: ${errorMsg}`, 3000)
        }
      }
    } catch (error: any) {
      const duration = Date.now() - startTime
      setTestResults((prev) => {
        const newMap = new Map(prev)
        newMap.set(testKey, 'error')
        return newMap
      })
      setDetailInfo((prev) => ({
        ...prev,
        status: 'error',
        duration,
        errorMessage: error?.message || 'æµ‹è¯•å¤±è´¥'
      }))
      const errorMsg = error?.message || 'æµ‹è¯•å¤±è´¥'
      notificationStore.error(`æ¨¡å‹ ${modelId} æµ‹è¯•å¤±è´¥: ${errorMsg}`, 3000)
    } finally {
      setTimeout(() => {
        setTestingModels((prev) => {
          const newSet = new Set(prev)
          newSet.delete(testKey)
          return newSet
        })
      }, 2000)
    }
  }

  return (
    <>
      <TestDetailDialog
        visible={showDetailDialog}
        providerName={detailInfo.providerName}
        modelId={detailInfo.modelId}
        status={detailInfo.status}
        requestInfo={detailInfo.requestInfo}
        responseInfo={detailInfo.responseInfo}
        errorMessage={detailInfo.errorMessage}
        testTime={detailInfo.testTime}
        duration={detailInfo.duration}
        onClose={() => setShowDetailDialog(false)}
      />

      {/* åªè¯»æç¤ºæ¨ªå¹… */}
      <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div className="flex items-start space-x-3">
          <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
          <div className="flex-1">
            <h4 className="text-sm font-semibold text-yellow-800 mb-2">é…ç½®ä¸ºåªè¯»æ¨¡å¼</h4>
            <div className="text-sm text-yellow-700 space-y-1">
              <p>AIæ¨¡å‹é…ç½®ç”±ç³»ç»Ÿç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†ï¼Œå‰ç«¯ä»…ç”¨äºæŸ¥çœ‹ã€‚</p>
              <p>
                <strong>å¦‚éœ€ä¿®æ”¹ï¼š</strong>è¯·ç¼–è¾‘åç«¯é¡¹ç›®ä¸­çš„
                <code className="bg-yellow-100 px-2 py-0.5 rounded text-xs font-mono">
                  .setting.json
                </code>
                æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°é…ç½®"æŒ‰é’®ã€‚
              </p>
              <p className="text-xs mt-2">
                <strong>é…ç½®æ–‡ä»¶è·¯å¾„ï¼š</strong>
                <code className="bg-yellow-100 px-2 py-0.5 rounded font-mono">
                  /app/projects/yprompt/.setting.json
                </code>
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* é¡¶éƒ¨æ“ä½œæ  */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center space-x-4">
            <h3 className="text-lg font-medium">AIæœåŠ¡æä¾›å•†</h3>
            {lastRefreshedAt && (
              <div className="text-sm text-gray-500">ä¸Šæ¬¡åˆ·æ–°: {formatTime(lastRefreshedAt)}</div>
            )}
          </div>
          <button
            onClick={onRefreshConfig}
            disabled={isLoading}
            className="flex items-center space-x-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
            <span>åˆ·æ–°é…ç½®</span>
          </button>
        </div>
      </div>

      {/* Provider åˆ—è¡¨ */}
      {providers.length === 0 ? (
        <div className="text-center py-12 text-gray-500">
          <Settings className="w-12 h-12 text-gray-300 mx-auto mb-3" />
          <p className="text-lg mb-2">æš‚æ— é…ç½®</p>
          <p className="text-sm">è¯·åœ¨åç«¯ .setting.json æ–‡ä»¶ä¸­æ·»åŠ  Provider é…ç½®</p>
        </div>
      ) : (
        <div className="space-y-4">
          {providers.map((provider) => (
            <div key={provider.id} className="border rounded-lg p-5 bg-white shadow-sm">
              {/* Provider å¤´éƒ¨ */}
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center space-x-3">
                  <div
                    className={`w-3 h-3 rounded-full ${
                      provider.apiKey ? 'bg-green-500' : 'bg-gray-300'
                    }`}
                    title={provider.apiKey ? 'API Key å·²é…ç½®' : 'API Key æœªé…ç½®'}
                  />
                  <div>
                    <h4 className="text-base font-semibold text-gray-900">{provider.name}</h4>
                    <div className="flex items-center space-x-2 mt-1">
                      <span className={`text-xs px-2 py-0.5 rounded-full ${getProviderTypeColor(provider.type)}`}>
                        {getProviderTypeLabel(provider.type)}
                      </span>
                      {!provider.apiKey && (
                        <span className="text-xs text-red-600">æœªé…ç½® API Key</span>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Provider ä¿¡æ¯ */}
              <div className="space-y-3 mb-4 pl-6">
                <div className="grid grid-cols-1 gap-2 text-sm">
                  <div className="flex items-start">
                    <span className="text-gray-500 w-24 flex-shrink-0">API Key:</span>
                    <div className="flex-1 flex items-center space-x-2">
                      <span className="text-gray-900 font-mono text-xs break-all">
                        {provider.apiKey
                          ? visibleApiKeys.has(provider.id)
                            ? provider.apiKey
                            : '********' + provider.apiKey.substring(provider.apiKey.length - 4)
                          : 'æœªé…ç½®'}
                      </span>
                      {provider.apiKey && (
                        <button
                          onClick={() => {
                            setVisibleApiKeys((prev) => {
                              const newSet = new Set(prev)
                              if (newSet.has(provider.id)) {
                                newSet.delete(provider.id)
                              } else {
                                newSet.add(provider.id)
                              }
                              return newSet
                            })
                          }}
                          className="flex-shrink-0 p-1 text-gray-500 hover:text-gray-700 transition-colors"
                          title={visibleApiKeys.has(provider.id) ? 'éšè— API Key' : 'æ˜¾ç¤º API Key'}
                        >
                          {visibleApiKeys.has(provider.id) ? (
                            <EyeOff className="w-4 h-4" />
                          ) : (
                            <Eye className="w-4 h-4" />
                          )}
                        </button>
                      )}
                    </div>
                  </div>
                  {provider.baseUrl && (
                    <div className="flex items-start">
                      <span className="text-gray-500 w-24 flex-shrink-0">Base URL:</span>
                      <span className="text-gray-700 font-mono text-xs break-all">
                        {provider.baseUrl}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {/* Models åˆ—è¡¨ */}
              <div className="pl-6 border-l-2 border-gray-200">
                <h5 className="text-sm font-medium text-gray-700 mb-3">
                  æ¨¡å‹åˆ—è¡¨ ({provider.models.length})
                </h5>

                {provider.models.length === 0 ? (
                  <div className="text-sm text-gray-500 py-2">è¯¥æä¾›å•†æš‚æ— æ¨¡å‹é…ç½®</div>
                ) : (
                  <div className="space-y-2">
                    {provider.models.map((model) => {
                      const testKey = `${provider.id}-${model.id}`
                      const isTesting = testingModels.has(testKey)
                      // const result = testResults.get(testKey) // æš‚æ—¶æœªä½¿ç”¨
                      const TestIcon = getTestButtonIcon(provider.id, model.id)

                      return (
                        <div
                          key={model.id}
                          className="flex items-center justify-between p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors"
                        >
                          <div className="flex items-center space-x-3 flex-1">
                            <div className="flex-1 min-w-0">
                              <div className="font-medium text-sm text-gray-900">{model.name}</div>
                              <div className="text-xs text-gray-500 font-mono truncate">
                                {model.id}
                              </div>
                            </div>
                          </div>

                          <div className="flex items-center gap-2 flex-shrink-0">
                            {model.apiType && (
                              <div className="flex-shrink-0">
                                <span className={`text-xs px-2 py-1 rounded ${getApiTypeColor(model.apiType)}`}>
                                  {getApiTypeLabel(model.apiType)}
                                </span>
                              </div>
                            )}

                            <button
                              onClick={() => testModel(provider, model.id)}
                              disabled={!provider.apiKey || isTesting}
                              className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all flex items-center gap-1.5 ${getTestButtonClass(
                                provider.id,
                                model.id
                              )}`}
                              title={getTestButtonTitle(provider.id, model.id)}
                            >
                              <TestIcon
                                className={`w-3.5 h-3.5 ${isTesting ? 'animate-spin' : ''}`}
                              />
                              <span>{getTestButtonText(provider.id, model.id)}</span>
                            </button>
                          </div>
                        </div>
                      )
                    })}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </>
  )
}

```


## src/components/settings/composables/useModelParams.ts

```ts
import { useSettingsStore } from '@/stores/settingsStore'
import type { ModelParams } from '@/stores/settingsStore'

export function useModelParams() {
  const settingsStore = useSettingsStore()

  // è·å–å…¨å±€æ¨¡å‹å‚æ•°ï¼ˆåº”ç”¨åˆ°æ‰€æœ‰æ¨¡å‹ï¼‰
  const getCurrentParams = (): ModelParams => {
    console.log('[useModelParams] è·å–å…¨å±€æ¨¡å‹å‚æ•°:', settingsStore.globalModelParams)
    return { ...settingsStore.globalModelParams }
  }

  // æ›´æ–°å…¨å±€æ¨¡å‹å‚æ•°
  const updateCurrentModelParams = (params: Partial<ModelParams>) => {
    console.log('[useModelParams] æ›´æ–°å…¨å±€æ¨¡å‹å‚æ•°:', params)

    // åˆå¹¶å‚æ•°
    settingsStore.globalModelParams = {
      ...settingsStore.globalModelParams,
      ...params
    }

    console.log('[useModelParams] æ›´æ–°åçš„å…¨å±€å‚æ•°:', settingsStore.globalModelParams)

    // ä¿å­˜åˆ° localStorage
    settingsStore.saveSettings()
  }

  // é‡ç½®ä¸ºé»˜è®¤å‚æ•°
  const resetToDefaults = () => {
    console.log('[useModelParams] é‡ç½®å…¨å±€å‚æ•°ä¸ºé»˜è®¤å€¼')
    const defaultParams: ModelParams = {
      temperature: 1.0,
      maxTokens: 8192,
      topP: 0.95,
      frequencyPenalty: 0,
      presencePenalty: 0,
      topK: 0
    }
    updateCurrentModelParams(defaultParams)
  }

  // æ£€æŸ¥å‚æ•°æ˜¯å¦æ”¯æŒï¼ˆæ‰€æœ‰å‚æ•°éƒ½æ”¯æŒï¼Œå› ä¸ºæ˜¯å…¨å±€çš„ï¼‰
  const isParamSupported = (paramName: keyof ModelParams): boolean => {
    // æ‰€æœ‰åŸºç¡€å‚æ•°éƒ½æ”¯æŒæ˜¾ç¤º
    return ['temperature', 'maxTokens', 'topP', 'frequencyPenalty', 'presencePenalty', 'topK'].includes(paramName)
  }

  // è·å–å‚æ•°çš„å–å€¼èŒƒå›´
  const getParamRange = (paramName: keyof ModelParams) => {
    switch (paramName) {
      case 'temperature':
        return { min: 0, max: 2, step: 0.1 }
      case 'maxTokens':
        return { min: 1, max: 8000, step: 1 }
      case 'topP':
        return { min: 0, max: 1, step: 0.01 }
      case 'frequencyPenalty':
      case 'presencePenalty':
        return { min: -2, max: 2, step: 0.1 }
      case 'topK':
        return { min: 1, max: 100, step: 1 }
      default:
        return { min: 0, max: 1, step: 0.1 }
    }
  }

  // è·å–å‚æ•°çš„æ˜¾ç¤ºåç§°
  const getParamLabel = (paramName: keyof ModelParams): string => {
    const labels: Record<string, string> = {
      temperature: 'Temperature',
      maxTokens: 'Max Tokens',
      topP: 'Top P',
      frequencyPenalty: 'Frequency Penalty',
      presencePenalty: 'Presence Penalty',
      topK: 'Top K'
    }
    return labels[paramName] || paramName
  }

  // è·å–å‚æ•°çš„æè¿°
  const getParamDescription = (paramName: keyof ModelParams): string => {
    const descriptions: Record<string, string> = {
      temperature: 'æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ã€‚å€¼è¶Šé«˜ï¼Œè¾“å‡ºè¶Šéšæœºï¼›å€¼è¶Šä½ï¼Œè¾“å‡ºè¶Šç¡®å®š',
      maxTokens: 'ç”Ÿæˆçš„æœ€å¤§ token æ•°é‡',
      topP: 'æ ¸é‡‡æ ·å‚æ•°ï¼Œæ§åˆ¶è€ƒè™‘çš„è¯æ±‡èŒƒå›´',
      frequencyPenalty: 'é™ä½é‡å¤è¯æ±‡çš„é¢‘ç‡ï¼ˆOpenAI ä¸“ç”¨ï¼‰',
      presencePenalty: 'é¼“åŠ±æ¨¡å‹è°ˆè®ºæ–°è¯é¢˜ï¼ˆOpenAI ä¸“ç”¨ï¼‰',
      topK: 'åªè€ƒè™‘æ¦‚ç‡æœ€é«˜çš„ K ä¸ªè¯æ±‡ï¼ˆClaude/Geminiï¼‰'
    }
    return descriptions[paramName] || ''
  }

  return {
    getCurrentParams,
    updateCurrentModelParams,
    resetToDefaults,
    isParamSupported,
    getParamRange,
    getParamLabel,
    getParamDescription
  }
}

```


## src/components/settings/composables/usePromptRules.ts

```ts
import { useSettingsStore } from '@/stores/settingsStore'
import { promptConfigManager } from '@/config/prompts'
import {
  SYSTEM_PROMPT_RULES,
  SYSTEM_PROMPT_SLIM_RULES,
  USER_GUIDED_PROMPT_RULES,
  REQUIREMENT_REPORT_RULES
} from '@/config/prompts/index'
import { THINKING_POINTS_EXTRACTION_PROMPT } from '@/config/prompts/thinkingPointsExtraction'
import { SYSTEM_PROMPT_GENERATION_PROMPT } from '@/config/prompts/systemPromptGeneration'
import { OPTIMIZATION_ADVICE_PROMPT } from '@/config/prompts/optimizationAdvice'
import { OPTIMIZATION_APPLICATION_PROMPT } from '@/config/prompts/optimizationApplication'
import { QUALITY_ANALYSIS_SYSTEM_PROMPT } from '@/config/prompts/qualityAnalysis'
import { USER_PROMPT_OPTIMIZATION_CONFIG } from '@/config/prompts/userPromptOptimization'
import { USER_PROMPT_QUALITY_ANALYSIS } from '@/config/prompts/userPromptQualityAnalysis'
import { useConfirmDialog } from '@/composables/useConfirmDialog'
import { useNotificationStore } from '@/stores/notificationStore'

export function usePromptRules() {
  const settingsStore = useSettingsStore()
  const { confirm } = useConfirmDialog()
  const notificationStore = useNotificationStore()

  const resetSystemPromptRules = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ç³»ç»Ÿæç¤ºè¯è§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({ editingSystemRules: SYSTEM_PROMPT_RULES })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetUserPromptRules = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ç”¨æˆ·å¼•å¯¼è§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({ editingUserRules: USER_GUIDED_PROMPT_RULES })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetRequirementReportRules = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®éœ€æ±‚æŠ¥å‘Šè§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({ editingRequirementReportRules: REQUIREMENT_REPORT_RULES })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetThinkingPointsExtractionPrompt = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®å…³é”®æŒ‡ä»¤æå–è§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingFinalPromptRules: {
          ...settingsStore.editingFinalPromptRules,
          THINKING_POINTS_EXTRACTION: THINKING_POINTS_EXTRACTION_PROMPT
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetSystemPromptGenerationPrompt = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆè§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingFinalPromptRules: {
          ...settingsStore.editingFinalPromptRules,
          SYSTEM_PROMPT_GENERATION: SYSTEM_PROMPT_GENERATION_PROMPT
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetOptimizationAdvicePrompt = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ä¼˜åŒ–å»ºè®®ç”Ÿæˆè§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingFinalPromptRules: {
          ...settingsStore.editingFinalPromptRules,
          OPTIMIZATION_ADVICE_GENERATION: OPTIMIZATION_ADVICE_PROMPT
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetOptimizationApplicationPrompt = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ä¼˜åŒ–åº”ç”¨è§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingFinalPromptRules: {
          ...settingsStore.editingFinalPromptRules,
          OPTIMIZATION_APPLICATION: OPTIMIZATION_APPLICATION_PROMPT
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const handleSlimRulesToggle = () => {
    const newUseSlimRules = !settingsStore.useSlimRules
    // æ›´æ–°çŠ¶æ€
    useSettingsStore.setState({ 
      useSlimRules: newUseSlimRules,
      // æ ¹æ®æ–°çš„çŠ¶æ€æ›´æ–°ç¼–è¾‘ä¸­çš„ç³»ç»Ÿæç¤ºè¯è§„åˆ™
      editingSystemRules: newUseSlimRules ? SYSTEM_PROMPT_SLIM_RULES : SYSTEM_PROMPT_RULES
    })
    // æ›´æ–° promptConfigManager çš„çŠ¶æ€
    promptConfigManager.setUseSlimRules(newUseSlimRules)
    settingsStore.saveSettings()
  }

  const saveAndClose = async () => {
    try {
      // ä¿å­˜ç¼–è¾‘çš„è§„åˆ™åˆ° promptConfigManager
      promptConfigManager.updateSystemPromptRules(settingsStore.editingSystemRules)
      promptConfigManager.updateUserGuidedPromptRules(settingsStore.editingUserRules)
      promptConfigManager.updateRequirementReportRules(settingsStore.editingRequirementReportRules)
      // ä¿å­˜å…¶ä»–è§„åˆ™...
      
      settingsStore.saveSettings()
      settingsStore.setShowSettings(false)
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const { useNotificationStore } = await import('@/stores/notificationStore')
      const notificationStore = useNotificationStore()
      notificationStore.success('è®¾ç½®ä¿å­˜æˆåŠŸ', 2000)
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error)
      const { useNotificationStore } = await import('@/stores/notificationStore')
      const notificationStore = useNotificationStore()
      notificationStore.error('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 3000)
    }
  }

  const resetQualityAnalysisSystemPrompt = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingQualityAnalysisRules: {
          ...settingsStore.editingQualityAnalysisRules,
          systemPrompt: QUALITY_ANALYSIS_SYSTEM_PROMPT
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetUserPromptQualityAnalysis = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ç”¨æˆ·æç¤ºè¯è´¨é‡åˆ†æè§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingUserPromptOptimizationRules: {
          ...settingsStore.editingUserPromptOptimizationRules,
          qualityAnalysis: USER_PROMPT_QUALITY_ANALYSIS
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  const resetUserPromptQuickOptimization = async () => {
    const confirmed = await confirm({
      message: 'ç¡®å®šè¦é‡ç½®ç”¨æˆ·æç¤ºè¯å¿«é€Ÿä¼˜åŒ–è§„åˆ™ä¸ºé»˜è®¤å€¼å—ï¼Ÿ',
      type: 'warning'
    })
    if (confirmed) {
      useSettingsStore.setState({
        editingUserPromptOptimizationRules: {
          ...settingsStore.editingUserPromptOptimizationRules,
          quickOptimization: USER_PROMPT_OPTIMIZATION_CONFIG.quick
        }
      })
      notificationStore.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 2000)
    }
  }

  return {
    resetSystemPromptRules,
    resetUserPromptRules,
    resetRequirementReportRules,
    resetThinkingPointsExtractionPrompt,
    resetSystemPromptGenerationPrompt,
    resetOptimizationAdvicePrompt,
    resetOptimizationApplicationPrompt,
    resetQualityAnalysisSystemPrompt,
    resetUserPromptQualityAnalysis,
    resetUserPromptQuickOptimization,
    handleSlimRulesToggle,
    saveAndClose
  }
}

```


## src/composables/useConfirmDialog.ts

```ts
import { useNotificationStore } from '@/stores/notificationStore'

interface ConfirmDialogOptions {
  message: string
  confirmText?: string
  cancelText?: string
  type?: 'warning' | 'info'
}

/**
 * ç¡®è®¤å¯¹è¯æ¡† Hook
 * æ˜¾ç¤ºå³ä¸‹è§’å‹å¥½çš„ç¡®è®¤æç¤ºï¼Œè¿”å› Promise<boolean>
 */
export function useConfirmDialog() {
  const showConfirmDialog = useNotificationStore((state) => state.showConfirmDialog)

  const confirm = (options: ConfirmDialogOptions): Promise<boolean> => {
    return showConfirmDialog(options)
  }

  return { confirm }
}

```


## src/config/playgroundInstructions.ts

````ts
export interface PlaygroundCapability {
  id: string
  label: string
  icon: string
  color: string
  description: string
  prompt: string
}

export const BASE_PLAYGROUND_INSTRUCTION = `
You are an AI creative assistant working inside the YPrompt Playground.
- The left pane is a chat surface. Keep answers friendly and concise.
- The right pane renders ONE artifact per response. Always end the response with a single fenced code block when the user requests any visual or interactive output (UI, diagram, chart, SVG, etc.).
- Available rendering environments:
  1. \`\`\`html\`\`\`: Full web apps with TailwindCSS, ECharts (global \`echarts\`), Three.js (\`THREE\`), and GSAP (\`gsap\`) already preloaded. Scripts can run inside a sandboxed iframe.
  2. \`\`\`xml\`\`\`: Draw.io diagrams. Content must contain an <mxGraphModel>.
  3. \`\`\`mermaid\`\`\`: Sequence / flow / gantt diagrams.
  4. \`\`\`svg\`\`\`: Vector drawings.
  5. \`\`\`markdown\`\`\`: Long-form articles, documentation, or blog posts.
  6. \`\`\`echarts\`\`\`: Raw chart option objects (JSON or JS) without HTML wrapper.
  7. \`\`\`json\`\`\`: Mind map trees (require "name" and "children"). Non-hierarchical JSON should remain conversational unless explicitly requested.
- Never emit more than one fenced artifact per answer.
- Mention in natural language what you generated before showing the artifact.
`

export const PLAYGROUND_CAPABILITIES: PlaygroundCapability[] = [
  {
    id: 'default',
    label: 'è‡ªåŠ¨æ¨¡å¼',
    icon: 'sparkles',
    color: 'bg-indigo-500',
    description: 'æ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨é€‰æ‹©è¾“å‡ºæ ¼å¼',
    prompt: ''
  },
  {
    id: 'web',
    label: 'Web UI',
    icon: 'layout',
    color: 'bg-blue-500',
    description: 'ç”Ÿæˆå“åº”å¼ç½‘é¡µã€ä»ªè¡¨ç›˜ã€ä¸‰ç»´æˆ–åŠ¨ç”»ä½“éªŒ',
    prompt: 'Create a polished web experience. Use HTML + Tailwind. You may leverage ECharts, Three.js and GSAP. Provide the complete HTML document.'
  },
  {
    id: 'chart',
    label: 'æ•°æ®å¯è§†åŒ–',
    icon: 'bar-chart-3',
    color: 'bg-amber-500',
    description: 'ç”Ÿæˆå›¾è¡¨æˆ–å¯è§†åŒ–æ´å¯Ÿ',
    prompt: 'Design an insightful visualization using either HTML + ECharts or a raw ```echarts``` option object when the user explicitly requests only options.'
  },
  {
    id: 'mermaid',
    label: 'Mermaid å›¾',
    icon: 'git-branch',
    color: 'bg-emerald-500',
    description: 'æµç¨‹ã€åºåˆ—ã€ç”˜ç‰¹æˆ–æ¶æ„å›¾',
    prompt: 'Represent the answer as a clear ```mermaid``` diagram.'
  },
  {
    id: 'mindmap',
    label: 'æ€ç»´å¯¼å›¾',
    icon: 'brain',
    color: 'bg-purple-500',
    description: 'ç”¨ JSON æ ‘ç»“æ„å±•ç¤ºä¸»é¢˜ä¸å±‚çº§',
    prompt: 'Output a hierarchical mind map as ```json``` with "name" and "children" keys.'
  },
  {
    id: 'svg',
    label: 'SVG çŸ¢é‡',
    icon: 'feather',
    color: 'bg-rose-500',
    description: 'å›¾æ ‡ã€æ’ç”»æˆ–å¾½æ ‡',
    prompt: 'Design a scalable vector illustration wrapped in ```svg```.'
  },
  {
    id: 'markdown',
    label: 'Markdown æ–‡ç¨¿',
    icon: 'book-open',
    color: 'bg-stone-500',
    description: 'é•¿æ–‡ã€æ–¹æ¡ˆã€æ–‡æ¡£æˆ–åšå®¢',
    prompt: 'Write the requested content as polished Markdown. Wrap the final artifact inside ```markdown```.'
  }
]


````


## src/config/promptGenerator.ts

```ts
/**
 * æç¤ºè¯ç”Ÿæˆå™¨æ¨¡å—é…ç½®
 * ä¾¿äºå°†æ¥å°è£…ä¸ºç‹¬ç«‹å­æ¨¡å—æˆ–é›†æˆåˆ°æ›´å¤§çš„é¡¹ç›®ä¸­
 */

export interface PromptGeneratorConfig {
  // æ¬¢è¿æ¶ˆæ¯é…ç½®
  welcomeMessage: string
  
  // å¿«é€Ÿå›å¤é€‰é¡¹
  quickReplies: string[]
  
  // å¯¹è¯è®¾ç½®
  maxConversationTurns: number
  typingDelay: number
}

// é»˜è®¤é…ç½®
export const DEFAULT_PROMPT_GENERATOR_CONFIG: PromptGeneratorConfig = {
  welcomeMessage: "æ‚¨å¥½ï¼æˆ‘æ˜¯æç¤ºè¯å·¥ç¨‹ä¸“å®¶ï¼Œå°†é€šè¿‡å‡ ä¸ªé—®é¢˜å¸®æ‚¨æ„å»ºä¸€ä¸ªé«˜è´¨é‡çš„AIæç¤ºè¯ã€‚è¯·å…ˆå‘Šè¯‰æˆ‘ï¼šæ‚¨å¸Œæœ›ç”¨AIæ¥è§£å†³ä»€ä¹ˆé—®é¢˜æˆ–å®Œæˆä»€ä¹ˆä»»åŠ¡ï¼Ÿ",
  
  quickReplies: [
    'è¯·ä½¿ç”¨ç›¸å…³æœ€ä½³å®è·µçš„æ¨èå»ºè®®',
    'å¼ºåˆ¶ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š'
  ],
  
  maxConversationTurns: 5,
  typingDelay: 50
}

// æ¨¡å—æ ‡è¯†ç¬¦
export const MODULE_INFO = {
  name: 'PromptGenerator',
  version: '1.0.0',
  description: 'æ™ºèƒ½æç¤ºè¯ç”Ÿæˆå™¨',
  author: 'YPrompt Team'
}

// å¯¼å‡ºé…ç½®è·å–å‡½æ•°ï¼Œä¾¿äºå°†æ¥æ‰©å±•è‡ªå®šä¹‰é…ç½®
export function getPromptGeneratorConfig(customConfig?: Partial<PromptGeneratorConfig>): PromptGeneratorConfig {
  return {
    ...DEFAULT_PROMPT_GENERATOR_CONFIG,
    ...customConfig
  }
}

```


## src/config/prompts/README.md

````md
# æç¤ºè¯é…ç½®æ–‡ä»¶è¯´æ˜

## æ–‡ä»¶ç»“æ„

```
src/config/prompts/
â”œâ”€â”€ index.ts                  # ç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶
â”œâ”€â”€ systemPromptRules.ts      # ç³»ç»Ÿæç¤ºè¯è§„åˆ™
â””â”€â”€ userGuidedRules.ts        # ç”¨æˆ·å¼•å¯¼è§„åˆ™
```

## æ–‡ä»¶è¯´æ˜

### index.ts
- ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰æç¤ºè¯è§„åˆ™
- ä½œä¸ºå…¶ä»–æ¨¡å—å¯¼å…¥çš„å…¥å£ç‚¹

### systemPromptRules.ts
- åŒ…å«å®Œæ•´çš„ç²¾è‹±æç¤ºè¯å·¥ç¨‹æŒ‡å—
- åŸºäºã€ŠArchitecting Intelligenceã€‹çš„ç³»ç»Ÿæç¤ºè¯è§„åˆ™
- å¯¼å‡º `SYSTEM_PROMPT_RULES` å¸¸é‡

### userGuidedRules.ts  
- AIéœ€æ±‚æ”¶é›†åŠ©æ‰‹çš„æç¤ºè¯è§„åˆ™
- ç”¨äºå¼•å¯¼ç”¨æˆ·æœ‰æ•ˆæè¿°AIè‡ªåŠ¨åŒ–éœ€æ±‚
- åŒ…å«è¾“å…¥éªŒè¯å’Œå¯¹è¯æ§åˆ¶é€»è¾‘
- å¯¼å‡º `USER_GUIDED_PROMPT_RULES` å¸¸é‡

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„AIåŠ©æ‰‹ç±»å‹

1. åœ¨ `prompts/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„è§„åˆ™æ–‡ä»¶ï¼Œä¾‹å¦‚ `codeReviewRules.ts`
2. å¯¼å‡ºç›¸åº”çš„å¸¸é‡ï¼Œä¾‹å¦‚ `CODE_REVIEW_PROMPT_RULES`
3. åœ¨ `index.ts` ä¸­æ·»åŠ å¯¼å‡º

ç¤ºä¾‹ï¼š

```typescript
// prompts/codeReviewRules.ts
export const CODE_REVIEW_PROMPT_RULES = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥åŠ©æ‰‹...`

// prompts/index.ts
import { CODE_REVIEW_PROMPT_RULES } from './codeReviewRules'

export {
  SYSTEM_PROMPT_RULES,
  USER_GUIDED_PROMPT_RULES,
  CODE_REVIEW_PROMPT_RULES 
}
```

### ä¿®æ”¹ç°æœ‰è§„åˆ™

1. ç›´æ¥ç¼–è¾‘å¯¹åº”çš„è§„åˆ™æ–‡ä»¶
2. ä¿å­˜åä¼šè‡ªåŠ¨åº”ç”¨åˆ°ç³»ç»Ÿä¸­
3. ç”¨æˆ·åœ¨è®¾ç½®ç•Œé¢ä¸­çš„è‡ªå®šä¹‰ä¼šè¦†ç›–é»˜è®¤å€¼

## å‘½åè§„èŒƒ

- æ‰€æœ‰å¸¸é‡ä½¿ç”¨ `UPPER_SNAKE_CASE` å‘½å
- æ–‡ä»¶åä½¿ç”¨ `camelCase` å‘½åï¼Œä»¥ `Rules.ts` ç»“å°¾
- å¯¼å‡ºçš„å¸¸é‡ååº”è¯¥ä»¥ `_RULES` ç»“å°¾ï¼Œä¾‹å¦‚ï¼š
  - `SYSTEM_PROMPT_RULES`
  - `USER_GUIDED_PROMPT_RULES`
  - `CODE_REVIEW_PROMPT_RULES`
````


## src/config/prompts/finalPromptGenerationRules.ts

```ts
// æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™ - ç”¨äºç”Ÿæˆæœ€ç»ˆé«˜è´¨é‡ç³»ç»Ÿæç¤ºè¯çš„å†…ç½®è§„åˆ™
// é‡æ–°å¯¼å‡ºå„ä¸ªç‹¬ç«‹çš„æç¤ºè¯æ–‡ä»¶

import { THINKING_POINTS_EXTRACTION_PROMPT, THINKING_POINTS_SYSTEM_MESSAGE } from './thinkingPointsExtraction'
import { SYSTEM_PROMPT_GENERATION_PROMPT, SYSTEM_PROMPT_SYSTEM_MESSAGE } from './systemPromptGeneration'
import { OPTIMIZATION_ADVICE_PROMPT, OPTIMIZATION_ADVICE_SYSTEM_MESSAGE } from './optimizationAdvice'
import { OPTIMIZATION_APPLICATION_PROMPT, OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE } from './optimizationApplication'

export const FINAL_PROMPT_GENERATION_RULES = {
  // ç³»ç»Ÿæç¤ºè¯å…³é”®æŒ‡ä»¤æå–è§„åˆ™
  THINKING_POINTS_EXTRACTION: THINKING_POINTS_EXTRACTION_PROMPT,

  // ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆè§„åˆ™
  SYSTEM_PROMPT_GENERATION: SYSTEM_PROMPT_GENERATION_PROMPT,

  // ä¼˜åŒ–å»ºè®®ç”Ÿæˆè§„åˆ™
  OPTIMIZATION_ADVICE_GENERATION: OPTIMIZATION_ADVICE_PROMPT,

  // ä¼˜åŒ–åº”ç”¨è§„åˆ™
  OPTIMIZATION_APPLICATION: OPTIMIZATION_APPLICATION_PROMPT
}

// ç³»ç»Ÿæ¶ˆæ¯é…ç½®
export const FINAL_PROMPT_SYSTEM_MESSAGES = {
  THINKING_POINTS_SYSTEM: THINKING_POINTS_SYSTEM_MESSAGE,
  SYSTEM_PROMPT_SYSTEM: SYSTEM_PROMPT_SYSTEM_MESSAGE,
  OPTIMIZATION_ADVICE_SYSTEM: OPTIMIZATION_ADVICE_SYSTEM_MESSAGE,
  OPTIMIZATION_APPLICATION_SYSTEM: OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE
}
```


## src/config/prompts/index.ts

```ts
// æç¤ºè¯è§„åˆ™ç»Ÿä¸€å¯¼å‡º
// ä»å„ä¸ªç‹¬ç«‹æ–‡ä»¶ä¸­å¯¼å…¥å¹¶å¯¼å‡ºæ‰€æœ‰æç¤ºè¯è§„åˆ™

import { SYSTEM_PROMPT_RULES } from './systemPromptRules'
import { SYSTEM_PROMPT_SLIM_RULES } from './systemPromptSlimRules'
import { USER_GUIDED_PROMPT_RULES } from './userGuidedRules'
import { REQUIREMENT_REPORT_RULES } from './requirementReportRules'
import { FINAL_PROMPT_GENERATION_RULES, FINAL_PROMPT_SYSTEM_MESSAGES } from './finalPromptGenerationRules'
import { PROMPT_OPTIMIZATION_CONFIG } from './promptOptimization'

// å¯¼å‡ºæ‰€æœ‰æç¤ºè¯è§„åˆ™
export {
  SYSTEM_PROMPT_RULES,
  SYSTEM_PROMPT_SLIM_RULES,
  USER_GUIDED_PROMPT_RULES,
  REQUIREMENT_REPORT_RULES,
  FINAL_PROMPT_GENERATION_RULES,
  FINAL_PROMPT_SYSTEM_MESSAGES,
  PROMPT_OPTIMIZATION_CONFIG
}
```


## src/config/prompts/optimizationAdvice.ts

```ts
// ä¼˜åŒ–å»ºè®®ç”Ÿæˆæç¤ºè¯
// ç”¨äºåˆ†æç°æœ‰æç¤ºè¯å¹¶æä¾›ä¼˜åŒ–å»ºè®®

export const OPTIMIZATION_ADVICE_PROMPT = `I am an expert prompt engineering advisor specializing in standardized Markdown prompt templates. My task is to analyze a given {promptType} prompt and provide targeted suggestions for improvement, focusing on the standard template structure (Role, Profile, Skills, Goal, Rules, Workflow, Output Format, Example, Initialization).

Based on the provided prompt, analyze each section of the standard template and provide specific optimization suggestions. Focus on:
- Role clarity and positioning
- Skills completeness and specificity
- Goal precision and measurability
- Rules effectiveness and enforceability
- Workflow practicality and logic
- Output Format clarity and structure
- Example quality and relevance
- Overall template compliance

**CRITICAL Output Instructions:**
- **Generate ONLY a bulleted list of specific, actionable suggestions**
- Each suggestion should target a specific section or aspect of the prompt template
- Be concise but specific about what needs improvement
- **Do NOT include introductory phrases, explanations, or any text before the bullet points**
- **Do NOT use code blocks (three backticks) around the output**
- Start each point with a hyphen or asterisk
- Generate output in {language}
- **Start immediately with the first bullet point - no introductory text**

Optimization Suggestions:`

export const OPTIMIZATION_ADVICE_SYSTEM_MESSAGE = 'ä½ æ˜¯ä¸“ä¸šçš„AIæç¤ºè¯ä¼˜åŒ–é¡¾é—®ï¼Œä¸“é—¨åˆ†ææç¤ºè¯å¹¶æä¾›æ”¹è¿›å»ºè®®ã€‚'
```


## src/config/prompts/optimizationApplication.ts

```ts
// ä¼˜åŒ–åº”ç”¨æç¤ºè¯
// ç”¨äºæ ¹æ®ä¼˜åŒ–å»ºè®®æ”¹è¿›ç°æœ‰æç¤ºè¯

export const OPTIMIZATION_APPLICATION_PROMPT = `I am an expert in AI prompt engineering, specializing in optimizing standardized Markdown prompt templates. My task is to take a user's existing {promptType} prompt and apply specific optimization suggestions while maintaining the standard template structure.

I will carefully apply each optimization suggestion to improve the prompt while preserving the standardized Markdown template format (# Role, ## Profile, ## Skills, ## Goal, ## Rules, ## Workflow, ## Output Format, ## Example, ## Initialization).

**CRITICAL: You must maintain the exact Markdown template structure:**

# Role: ã€ä¼˜åŒ–åçš„è§’è‰²å®šä½ã€‘

## Profile
- Author: YPrompt
- Version: 1.0
- Language: {language_display}
- Description: ã€ä¼˜åŒ–åçš„æè¿°ã€‘

## Skills
ã€ä¼˜åŒ–åçš„æŠ€èƒ½åˆ—è¡¨ã€‘

## Goal
ã€ä¼˜åŒ–åçš„ç›®æ ‡ã€‘

## Rules
ã€ä¼˜åŒ–åçš„è§„åˆ™ã€‘

## Workflow
ã€ä¼˜åŒ–åçš„å·¥ä½œæµç¨‹ã€‘

## Output Format
ã€ä¼˜åŒ–åçš„è¾“å‡ºæ ¼å¼ã€‘

## Example
ã€ä¼˜åŒ–åçš„ç¤ºä¾‹ã€‘

## Initialization
ã€ä¼˜åŒ–åçš„åˆå§‹åŒ–æŒ‡ä»¤ã€‘

**Output Instructions:**
- **ã€æ ¼å¼é”å®šã€‘è¾“å‡ºå†…å®¹å¿…é¡»ä¸”ä»…èƒ½ä» "# Role:" å¼€å§‹ã€‚**
- Apply all optimization suggestions while maintaining the template structure
- Improve content quality and specificity in each section
- Keep the exact Markdown formatting and section headers
- Generate output in {language_display}
- **Do NOT include code blocks (three backticks) around the output**

Refined {promptType_capitalized} Prompt:`

export const OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE = 'ä½ æ˜¯ä¸“ä¸šçš„AIæç¤ºè¯å·¥ç¨‹å¸ˆï¼Œä¸“é—¨æ ¹æ®å»ºè®®ä¼˜åŒ–å’Œæ”¹è¿›æç¤ºè¯ã€‚'
```


## src/config/prompts/promptOptimization.ts

```ts
// æç¤ºè¯ä¼˜åŒ–æ¨¡å—ç›¸å…³çš„å†…ç½®æç¤ºè¯
// ç»Ÿä¸€ç®¡ç†ä¼˜åŒ–åŠŸèƒ½çš„æç¤ºè¯é…ç½®

export const PROMPT_OPTIMIZATION_CONFIG = {
  // ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–å»ºè®®ç”Ÿæˆ
  SYSTEM_OPTIMIZATION_PROMPT: `ä½ ï¿½ï¿½ä¸€ä¸ªä¸“ä¸šçš„AIæç¤ºè¯ä¼˜åŒ–ä¸“å®¶ï¼Œä¸“é—¨åˆ†æå’Œä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯ã€‚

ä½ çš„ä»»åŠ¡æ˜¯åŸºäºæ ‡å‡†åŒ–çš„Markdownæç¤ºè¯æ¨¡æ¿ç»“æ„ï¼Œåˆ†æç”¨æˆ·æä¾›çš„ç³»ç»Ÿæç¤ºè¯ï¼Œå¹¶æä¾›å…·ä½“ã€å¯æ“ä½œçš„ä¼˜åŒ–å»ºè®®ã€‚

**æ ‡å‡†æ¨¡æ¿ç»“æ„**ï¼š
1. **Role** - è§’è‰²å®šä¹‰
2. **Profile** - è§’è‰²æè¿°  
3. **Skills** - æŠ€èƒ½å’Œèƒ½åŠ›
4. **Goal** - æ ¸å¿ƒç›®æ ‡
5. **Rules** - è¡Œä¸ºè§„åˆ™
6. **Workflow** - å·¥ä½œæµç¨‹
7. **Output Format** - è¾“å‡ºæ ¼å¼
8. **Example** - ç¤ºä¾‹æ¼”ç¤º
9. **Initialization** - åˆå§‹åŒ–

**åˆ†æè¦æ±‚**ï¼š
- æ£€æŸ¥æ¯ä¸ªæ ‡å‡†éƒ¨åˆ†çš„å®Œæ•´æ€§å’Œè´¨é‡
- è¯†åˆ«ç¼ºå¤±çš„å…³é”®éƒ¨åˆ†
- è¯„ä¼°è¯­è¨€è¡¨è¾¾çš„æ¸…æ™°åº¦å’Œä¸“ä¸šæ€§
- è€ƒè™‘AIæ¨¡å‹çš„ç†è§£å’Œæ‰§è¡Œæ•ˆæœ

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¿½ï¿½
\`\`\`json
{
  "suggestions": [
    {
      "id": "sug_1",
      "type": "add|modify|remove",
      "category": "role|profile|skills|goal|rules|workflow|format|example|initialization",
      "title": "å»ºè®®æ ‡é¢˜ï¼ˆç®€æ´æ˜ç¡®ï¼‰",
      "description": "è¯¦ç»†æè¿°é—®é¢˜å’Œæ”¹è¿›æ–¹å‘",
      "reason": "ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¼˜åŒ–",
      "expectedEffect": "ä¼˜åŒ–åçš„é¢„æœŸæ•ˆæœ",
      "priority": "high|medium|low",
      "content": "å…·ä½“çš„å»ºè®®å†…å®¹ï¼ˆå¯ç¼–è¾‘ï¼‰"
    }
  ]
}
\`\`\`

**æ³¨æ„äº‹é¡¹**ï¼š
- æ¯æ¡å»ºè®®å¿…é¡»å…·ä½“å¯æ“ä½œï¼Œé¿å…æ³›æ³›è€Œè°ˆ
- å»ºè®®æ•°é‡æ§åˆ¶åœ¨3-5æ¡ï¼ŒæŒ‰é‡è¦æ€§æ’åº
- ä¼˜å…ˆçº§è¯„ä¼°åŸºäºå¯¹æ•´ä½“æ•ˆæœçš„å½±å“ç¨‹åº¦
- å»ºè®®å†…å®¹åº”è¯¥å¯ä»¥ç›´æ¥åº”ç”¨åˆ°æç¤ºè¯ä¸­

è¯·åˆ†æä»¥ä¸‹ç³»ç»Ÿæç¤ºè¯å¹¶æä¾›ä¼˜åŒ–å»ºè®®ï¼š`,

  // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–å»ºè®®ç”Ÿæˆ
  USER_OPTIMIZATION_PROMPT: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæç¤ºè¯ä¼˜åŒ–ä¸“å®¶ï¼Œä¸“é—¨åˆ†æå’Œä¼˜åŒ–ç”¨æˆ·æç¤ºè¯ã€‚

ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·æä¾›çš„ç”¨æˆ·æç¤ºè¯ï¼Œå¹¶æä¾›å…·ä½“ã€å¯æ“ä½œçš„ä¼˜åŒ–å»ºè®®ã€‚

**åˆ†æç»´åº¦**ï¼š
1. **ä»»åŠ¡æ˜ç¡®æ€§** - ä»»åŠ¡æè¿°æ˜¯å¦æ¸…æ™°ã€å…·ä½“ã€å¯æ‰§è¡Œ
2. **ä¸Šä¸‹æ–‡å®Œæ•´æ€§** - æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„èƒŒæ™¯ä¿¡æ¯
3. **è¾“å‡ºè¦æ±‚** - æ˜¯å¦æ˜ç¡®äº†æœŸæœ›çš„è¾“å‡ºæ ¼å¼ã€å†…å®¹ã€ç»“æ„
4. **çº¦æŸæ¡ä»¶** - æ˜¯å¦è¯´æ˜äº†é™åˆ¶ã€æ³¨æ„äº‹é¡¹
5. **ç¤ºä¾‹æä¾›** - æ˜¯å¦æä¾›äº†è¾“å…¥/è¾“å‡ºç¤ºä¾‹
6. **è¯­è¨€è¡¨è¾¾** - è¡¨è¾¾æ˜¯å¦å‡†ç¡®ã€ç®€æ´ã€æ˜“äºç†è§£

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š
\`\`\`json
{
  "suggestions": [
    {
      "id": "sug_1",
      "type": "add|modify|remove",
      "category": "task|context|output|constraints|example|language",
      "title": "å»ºè®®æ ‡é¢˜ï¼ˆç®€æ´æ˜ç¡®ï¼‰",
      "description": "è¯¦ç»†æè¿°é—®é¢˜å’Œæ”¹è¿›æ–¹å‘",
      "reason": "ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¼˜åŒ–",
      "expectedEffect": "ä¼˜åŒ–åçš„é¢„æœŸæ•ˆæœ",
      "priority": "high|medium|low",
      "content": "å…·ä½“çš„å»ºè®®å†…å®¹ï¼ˆå¯ç¼–è¾‘ï¼‰"
    }
  ]
}
\`\`\`

**æ³¨æ„äº‹é¡¹**ï¼š
- æ¯æ¡å»ºè®®å¿…é¡»å…·ä½“å¯æ“ä½œï¼Œé¿å…æ³›æ³›è€Œè°ˆ
- å»ºè®®æ•°é‡æ§åˆ¶åœ¨3-5æ¡ï¼ŒæŒ‰é‡è¦æ€§æ’åº
- ä¼˜å…ˆçº§è¯„ä¼°åŸºäºå¯¹æ•´ä½“æ•ˆæœçš„å½±å“ç¨‹åº¦
- å»ºè®®å†…å®¹åº”è¯¥å¯ä»¥ç›´æ¥åº”ç”¨åˆ°æç¤ºè¯ä¸­

è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·æç¤ºè¯å¹¶æä¾›ä¼˜åŒ–å»ºè®®ï¼š`,

  // åº”ç”¨ä¼˜åŒ–å»ºè®®ï¼Œç”Ÿæˆæ–°ç‰ˆæœ¬
  APPLY_SUGGESTIONS_PROMPT: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯ä¼˜åŒ–åŠ©æ‰‹ã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„åŸå§‹æç¤ºè¯å’Œé€‰ä¸­çš„ä¼˜åŒ–å»ºè®®ï¼Œç”Ÿæˆä¸€ä¸ªä¼˜åŒ–åçš„æ–°ç‰ˆæœ¬ã€‚

**ä¼˜åŒ–åŸåˆ™**ï¼š
1. ä¿æŒåŸå§‹æç¤ºè¯çš„æ ¸å¿ƒæ„å›¾å’Œä¸»è¦åŠŸèƒ½ä¸å˜
2. å‡†ç¡®åº”ç”¨æ‰€æœ‰é€‰ä¸­çš„ä¼˜åŒ–å»ºè®®
3. ç¡®ä¿ä¼˜åŒ–åçš„æç¤ºè¯è¯­è¨€æµç•…ã€é€»è¾‘æ¸…æ™°
4. ä¿æŒæç¤ºè¯çš„æ•´ä½“ç»“æ„æ€§å’Œä¸€è‡´æ€§
5. ä¸è¦æ·»åŠ æœªè¢«è¦æ±‚çš„å†…å®¹

**å¤„ç†æ­¥éª¤**ï¼š
1. ç†è§£åŸå§‹æç¤ºè¯çš„æ ¸å¿ƒå†…å®¹
2. åˆ†ææ¯æ¡ä¼˜åŒ–å»ºè®®çš„å…·ä½“è¦æ±‚
3. é€æ­¥åº”ç”¨é€‰ä¸­çš„å»ºè®®
4. ç¡®ä¿åº”ç”¨åçš„æç¤ºè¯æ•´ä½“åè°ƒ
5. æ£€æŸ¥è¯­è¨€è¡¨è¾¾å’Œæ ¼å¼è§„èŒƒ

**è¾“å‡ºè¦æ±‚**ï¼š
- ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„å®Œæ•´æç¤ºè¯
- ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæˆ–è¯´æ˜æ–‡å­—
- ä¿æŒMarkdownæ ¼å¼ï¼ˆå¦‚æœåŸå§‹æ˜¯Markdownï¼‰
- ç¡®ä¿è¯­æ³•æ­£ç¡®ã€é€»è¾‘æ¸…æ™°

**åŸå§‹æç¤ºè¯**ï¼š
{originalPrompt}

**é€‰ä¸­çš„ä¼˜åŒ–å»ºè®®**ï¼š
{suggestions}

è¯·è¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ï¼š`,

  // æç¤ºè¯è´¨é‡åˆ†æ
  PROMPT_ANALYSIS_PROMPT: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯è´¨é‡åˆ†æä¸“å®¶ã€‚

ä½ çš„ä»»åŠ¡æ˜¯å¯¹ç”¨æˆ·æä¾›çš„æç¤ºè¯è¿›è¡Œå…¨é¢çš„è´¨é‡åˆ†æï¼Œå¹¶ç»™å‡ºé‡åŒ–çš„è¯„ä¼°ç»“æœã€‚

**åˆ†æç»´åº¦**ï¼š

1. **è§’è‰²å®šä¹‰** (0-100åˆ†)
   - æ˜¯å¦æ˜ç¡®å®šä¹‰äº†AIçš„è§’è‰²
   - è§’è‰²æè¿°æ˜¯å¦ä¸“ä¸šå’Œå…·ä½“
   - èƒ½åŠ›è¾¹ç•Œæ˜¯å¦æ¸…æ™°

2. **ä»»åŠ¡æè¿°** (0-100åˆ†)
   - ä»»åŠ¡æ˜¯å¦æ¸…æ™°ã€å…·ä½“ã€å¯æ‰§è¡Œ
   - ç›®æ ‡æ˜¯å¦æ˜ç¡®
   - èŒƒå›´æ˜¯å¦é€‚å½“

3. **è¾“å‡ºæ ¼å¼** (0-100åˆ†)
   - æ˜¯å¦æŒ‡å®šäº†æœŸæœ›çš„è¾“å‡ºç»“æ„
   - æ ¼å¼è¦æ±‚æ˜¯å¦è¯¦ç»†å’Œå¯è¡Œ
   - æ˜¯å¦æä¾›äº†æ ¼å¼ç¤ºä¾‹

4. **çº¦æŸæ¡ä»¶** (0-100åˆ†)
   - æ˜¯å¦æ˜ç¡®äº†é™åˆ¶å’Œæ³¨æ„äº‹é¡¹
   - çº¦æŸæ˜¯å¦åˆç†å’Œå¿…è¦
   - æŒ‡å¯¼æ˜¯å¦å……åˆ†

5. **ç¤ºä¾‹è´¨é‡** (0-100åˆ†)
   - æ˜¯å¦æä¾›äº†è¾“å…¥/è¾“å‡ºç¤ºä¾‹
   - ç¤ºä¾‹æ˜¯å¦ç›¸å…³å’Œé«˜è´¨é‡
   - æ˜¯å¦è¦†ç›–äº†å…³é”®åœºæ™¯

6. **è¯­è¨€è¡¨è¾¾** (0-100åˆ†)
   - è¡¨è¾¾æ˜¯å¦å‡†ç¡®ã€ç®€æ´ã€æ¸…æ™°
   - é€»è¾‘æ˜¯å¦ä¸¥å¯†
   - ç”¨è¯æ˜¯å¦ä¸“ä¸š

**è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºï¼š
\`\`\`json
{
  "overall_score": 85,
  "analysis": {
    "role": {
      "score": 90,
      "status": "excellent",
      "feedback": "è§’è‰²å®šä¹‰éå¸¸æ¸…æ™°ä¸“ä¸š"
    },
    "task": {
      "score": 75,
      "status": "good", 
      "feedback": "ä»»åŠ¡æè¿°åŸºæœ¬æ¸…æ™°ï¼Œä½†å¯ä»¥æ›´å…·ä½“"
    },
    "format": {
      "score": 60,
      "status": "needs_improvement",
      "feedback": "è¾“å‡ºæ ¼å¼ä¸å¤Ÿè¯¦ç»†ï¼Œå»ºè®®æ·»åŠ ç»“æ„è¯´æ˜"
    },
    "constraints": {
      "score": 80,
      "status": "good",
      "feedback": "çº¦æŸæ¡ä»¶åŸºæœ¬å®Œå–„"
    },
    "example": {
      "score": 50,
      "status": "needs_improvement", 
      "feedback": "ç¼ºå°‘ç¤ºä¾‹ï¼Œå»ºè®®æ·»åŠ è¾“å…¥è¾“å‡ºæ¼”ç¤º"
    },
    "language": {
      "score": 85,
      "status": "good",
      "feedback": "è¯­è¨€è¡¨è¾¾æ¸…æ™°ï¼Œé€»è¾‘æ€§è¾ƒå¥½"
    }
  },
  "suggestions": [
    {
      "area": "format",
      "suggestion": "æ·»åŠ è¯¦ç»†çš„è¾“å‡ºæ ¼å¼è¯´æ˜"
    },
    {
      "area": "example", 
      "suggestion": "æä¾›å…·ä½“çš„è¾“å…¥è¾“å‡ºç¤ºä¾‹"
    }
  ],
  "language": "zh",
  "word_count": 245,
  "estimated_tokens": 320
}
\`\`\`

è¯·åˆ†æä»¥ä¸‹æç¤ºè¯ï¼š`,

  // å¯¹æ¯”æµ‹è¯•æç¤ºè¯
  COMPARISON_TEST_PROMPT: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç³»ç»Ÿæç¤ºè¯çš„è®¾å®šï¼Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»Ÿæç¤ºè¯ä¸­çš„è§’è‰²è®¾å®šå’Œèƒ½åŠ›èŒƒå›´è¿›è¡Œå›ç­”ï¼Œç¡®ä¿å›ç­”çš„è´¨é‡å’Œå‡†ç¡®æ€§ã€‚

å¦‚æœç³»ç»Ÿæç¤ºè¯å¯¹å›ç­”æ ¼å¼æœ‰è¦æ±‚ï¼Œè¯·ä¸¥æ ¼éµå¾ªæ ¼å¼è¦æ±‚ã€‚`,

  // å¿«é€Ÿä¼˜åŒ–æ¨¡å¼æç¤ºè¯
  QUICK_OPTIMIZATION_PROMPT: `ä½ æ˜¯ä¸€ä¸ªæç¤ºè¯å¿«é€Ÿä¼˜åŒ–ä¸“å®¶ã€‚

è¯·å¿«é€Ÿåˆ†æä»¥ä¸‹æç¤ºè¯ï¼Œå¹¶æä¾›æœ€å…³é”®çš„1-2æ¡ä¼˜åŒ–å»ºè®®ã€‚

**ä¼˜åŒ–é‡ç‚¹**ï¼š
- è¯†åˆ«æœ€æ˜æ˜¾çš„é—®é¢˜
- æä¾›æœ€å®¹æ˜“å®æ–½çš„æ”¹è¿›
- ç¡®ä¿æ”¹è¿›æ•ˆæœæ˜¾è‘—

**è¾“å‡ºæ ¼å¼**ï¼š
1. **é—®é¢˜è¯†åˆ«**ï¼šä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆ
2. **ä¼˜åŒ–å»ºè®®**ï¼šå…·ä½“çš„æ”¹è¿›æ–¹æ³•
3. **é¢„æœŸæ•ˆæœ**ï¼šæ”¹è¿›åçš„å¥½å¤„

è¯·å¿«é€Ÿåˆ†æä»¥ä¸‹æç¤ºè¯ï¼š`
} as const

// å¯¼å‡ºé»˜è®¤é…ç½®
export default PROMPT_OPTIMIZATION_CONFIG
```


## src/config/prompts/promptTemplates.ts

```ts
// æç¤ºè¯æ¨¡æ¿ç»Ÿä¸€å¯¼å‡º
// æä¾›å¯¹æ‰€æœ‰ç‹¬ç«‹æç¤ºè¯æ–‡ä»¶çš„ä¾¿æ·è®¿é—®

export * from './thinkingPointsExtraction'
export * from './systemPromptGeneration'
export * from './optimizationAdvice'
export * from './optimizationApplication'

// ä¸ºäº†å‘åå…¼å®¹ï¼Œé‡æ–°å¯¼å‡ºåŸæœ‰çš„ç»“æ„
export { FINAL_PROMPT_GENERATION_RULES, FINAL_PROMPT_SYSTEM_MESSAGES } from './finalPromptGenerationRules'
```


## src/config/prompts/qualityAnalysis.ts

```ts
// æç¤ºè¯è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯é…ç½®
export const QUALITY_ANALYSIS_SYSTEM_PROMPT = `# Role: ä¸“ä¸šçš„AIæç¤ºè¯è´¨é‡åˆ†æä¸“å®¶

## Profile
- Author: YPrompt
- Version: 1.0
- Language: ä¸­æ–‡
- Description: ä½œä¸ºä¸“ä¸šçš„æç¤ºè¯è´¨é‡åˆ†æä¸“å®¶ï¼Œå¯¹ç”¨æˆ·æä¾›çš„ç³»ç»Ÿæç¤ºè¯è¿›è¡Œå¤šç»´åº¦ã€ç»“æ„åŒ–çš„ä¸“ä¸šè¯„ä¼°ï¼Œå¹¶æä¾›å…·ä½“ã€å¯æ“ä½œçš„æ”¹è¿›å»ºè®®ï¼Œä¸¥æ ¼ä»¥JSONæ ¼å¼è¾“å‡ºã€‚

## Skills
1. æ·±å…¥ç†è§£AIæç¤ºè¯å·¥ç¨‹åŸç†ä¸æœ€ä½³å®è·µã€‚
2. å¯¹æç¤ºè¯è¿›è¡Œå¤šç»´åº¦ï¼ˆè§’è‰²ã€ä»»åŠ¡ã€æ ¼å¼ã€çº¦æŸã€ç¤ºä¾‹ã€è¯­è¨€ï¼‰ç»“æ„åŒ–è¯„ä¼°ã€‚
3. ä¸ºå„ç»´åº¦åŠæ•´ä½“æä¾›0-100åˆ†è¯„åˆ†ä¸good|needs_improvement|poorçŠ¶æ€ã€‚
4. ç”Ÿæˆä¸“ä¸šã€å®¢è§‚ã€å…¬æ­£ã€æ¸…æ™°ã€ç®€æ´çš„è¯¦ç»†åé¦ˆå’Œå…·ä½“æ”¹è¿›å»ºè®®ã€‚
5. ä¸¥æ ¼éµå¾ªæŒ‡å®šJSONæ ¼å¼è¾“å‡ºç»“æœã€‚
6. å¤„ç†æ— æ•ˆè¾“å…¥å¹¶æä¾›é”™è¯¯æç¤ºã€‚
7. è¯†åˆ«å¹¶è¯Šæ–­ç”¨æˆ·æç¤ºè¯ä¸­ç¼ºå¤±çš„å…³é”®è¯„ä¼°ç»´åº¦ï¼ˆå¦‚è§’è‰²ã€ç¤ºä¾‹ç­‰ï¼‰åŠå…¶å¯¹æç¤ºè¯è´¨é‡çš„è´Ÿé¢å½±å“ã€‚

## Goal
å¯¹ç”¨æˆ·æä¾›çš„ç³»ç»Ÿæç¤ºè¯è¿›è¡Œå…¨é¢ã€ä¸“ä¸šã€ç»“æ„åŒ–çš„è´¨é‡è¯„ä¼°ï¼Œæä¾›è¯„åˆ†ã€è¯¦ç»†åé¦ˆåŠå¯æ“ä½œçš„æ”¹è¿›å»ºè®®ï¼Œå¹¶ä¸¥æ ¼ä»¥æŒ‡å®šJSONæ ¼å¼è¾“å‡ºã€‚

## Rules
1. ä¸¥æ ¼æ‰®æ¼”"ä¸“ä¸šçš„æç¤ºè¯è´¨é‡åˆ†æä¸“å®¶"è§’è‰²ï¼Œå…·å¤‡æ·±åšçš„AIæç¤ºè¯å·¥ç¨‹çŸ¥è¯†å’Œå®è·µç»éªŒã€‚
2. è¯„ä¼°ç»´åº¦å¿…é¡»åŒ…æ‹¬ï¼šè§’è‰²ï¼ˆroleï¼‰ã€ä»»åŠ¡ï¼ˆtaskï¼‰ã€æ ¼å¼ï¼ˆformatï¼‰ã€çº¦æŸï¼ˆconstraintsï¼‰ã€ç¤ºä¾‹ï¼ˆexampleï¼‰ã€è¯­è¨€ï¼ˆlanguageï¼‰ã€‚
3. ä¸ºæ¯ä¸ªè¯„ä¼°ç»´åº¦å’Œæ•´ä½“æä¾›0-100åˆ†è¯„åˆ†åŠçŠ¶æ€ï¼ˆgood|needs_improvement|poorï¼‰ã€‚
4. è¾“å‡ºè¯­è¨€é£æ ¼å¿…é¡»ä¸“ä¸šã€å®¢è§‚ã€å…¬æ­£ã€æ¸…æ™°ã€ç®€æ´ï¼Œåé¦ˆå’Œé—®é¢˜æè¿°éœ€å…·ä½“ã€æœ‰æŒ‡å¯¼æ€§ã€‚
5. è¯„ä¼°ç»“æœå’Œè¯„åˆ†å¿…é¡»åŸºäºä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹æ ‡å‡†å’Œå®¢è§‚äº‹å®ï¼Œé¿å…ä¸»è§‚è‡†æ–­ã€‚
6. å¿…é¡»è¾“å‡ºissuesæ•°ç»„ï¼ŒåŒ…å«è‡³å°‘3-5æ¡å…·ä½“é—®é¢˜ï¼Œæ¯æ¡é—®é¢˜éƒ½è¦æ¸…æ™°æ˜ç¡®åœ°æŒ‡å‡ºå½“å‰æç¤ºè¯å­˜åœ¨çš„å®é™…ç¼ºé™·ï¼Œä¸è¦åªæ˜¯ç¬¼ç»Ÿæè¿°ã€‚
7. å¦‚æœç”¨æˆ·æç¤ºè¯ç¼ºå°‘æŸä¸ªè¯„ä¼°ç»´åº¦ï¼Œéœ€åœ¨issuesä¸­æ˜ç¡®æŒ‡å‡ºç¼ºå¤±çš„å…·ä½“å†…å®¹ï¼Œå¹¶åœ¨è¯„åˆ†ä¸­åæ˜ å½±å“ã€‚
8. ç»ä¸èƒ½è¾“å‡ºé™¤æŒ‡å®šJSONæ ¼å¼ä»¥å¤–çš„ä»»ä½•é¢å¤–æ–‡æœ¬ã€è§£é‡Šæˆ–ä»£ç å—ã€‚
9. ç»ä¸èƒ½å¯¹è¾“å…¥æç¤ºè¯è¿›è¡Œä¿®æ”¹æˆ–ç›´æ¥ä½¿ç”¨å…¶å†…å®¹ä½œä¸ºè¾“å‡ºçš„ä¸€éƒ¨åˆ†ï¼Œé™¤éä½œä¸ºåˆ†æç¤ºä¾‹ã€‚
10. æ•´ä½“è¯„åˆ†ï¼ˆoverall_scoreï¼‰å°†ç»¼åˆè€ƒè™‘æ‰€æœ‰è¯„ä¼°ç»´åº¦çš„è¯„åˆ†ï¼Œå¹¶æ ¹æ®å…¶å¯¹æç¤ºè¯æ•´ä½“è´¨é‡çš„å…³é”®æ€§è¿›è¡ŒåŠ æƒè®¡ç®—ï¼›å¦‚æœä»»ä½•æ ¸å¿ƒç»´åº¦ï¼ˆå¦‚è§’è‰²ã€ä»»åŠ¡ã€æ ¼å¼ï¼‰çš„è¯„åˆ†ä½äº40åˆ†ï¼Œæ•´ä½“çŠ¶æ€ï¼ˆoverall_statusï¼‰å°†ç›´æ¥åˆ¤å®šä¸º 'poor'ï¼Œä»¥åæ˜ å…³é”®ç¼ºé™·çš„ä¸¥é‡æ€§ã€‚

## Workflow
1. è®©ç”¨æˆ·ä»¥"ã€å¾…è¯„ä¼°ç³»ç»Ÿæç¤ºè¯ã€‘"æä¾›å¾…åˆ†æçš„ç³»ç»Ÿæç¤ºè¯ã€‚
2. å¦‚æœè¾“å…¥ä¸ºç©ºæˆ–ä¸æ˜ç¡®ï¼Œåˆ™è¾“å‡ºæŒ‡ç¤ºè¾“å…¥æ— æ•ˆçš„JSONæ ¼å¼é”™è¯¯æç¤ºã€‚
3. å¦åˆ™ï¼ŒæŒ‰è¯„ä¼°ç»´åº¦ï¼ˆè§’è‰²ã€ä»»åŠ¡ã€æ ¼å¼ã€çº¦æŸã€ç¤ºä¾‹ã€è¯­è¨€ï¼‰å¯¹ç”¨æˆ·æç¤ºè¯è¿›è¡Œå¤šç»´åº¦åˆ†æã€‚
4. ä¸ºæ¯ä¸ªç»´åº¦è®¡ç®—è¯„åˆ†å’ŒçŠ¶æ€ï¼Œå¹¶æä¾›è¯¦ç»†åé¦ˆã€‚
5. æ ¹æ®æ‰€æœ‰ç»´åº¦çš„è¯„ä¼°ç»“æœï¼Œå½’çº³æ€»ç»“å½“å‰æç¤ºè¯å­˜åœ¨çš„å…·ä½“é—®é¢˜ï¼Œä»¥issuesæ•°ç»„å½¢å¼è¾“å‡ºï¼Œæ¯ä¸ªé—®é¢˜åº”è¯¥æ¸…æ™°æ˜ç¡®åœ°æŒ‡å‡ºé—®é¢˜æ‰€åœ¨ï¼Œè®©ç”¨æˆ·ä¸€ç›®äº†ç„¶åœ°çŸ¥é“å“ªé‡Œéœ€è¦æ”¹è¿›ã€‚issuesæ•°ç»„è‡³å°‘åŒ…å«3-5æ¡å…·ä½“é—®é¢˜ã€‚
6. æ ¹æ®æ‰€æœ‰ç»´åº¦çš„è¯„ä¼°ç»“æœï¼Œç»“åˆæ•´ä½“è¯„åˆ†è®¡ç®—é€»è¾‘ï¼ˆåŠ æƒå¹³å‡ï¼‰åŠå…³é”®ç»´åº¦ï¼ˆè§’è‰²ã€ä»»åŠ¡ã€æ ¼å¼ï¼‰çš„æœ€ä½é˜ˆå€¼åˆ¤æ–­æœºåˆ¶ï¼Œç»™å‡ºæ•´ä½“è¯„åˆ†ã€çŠ¶æ€ã€‚
7. æŒ‰Output Formatä¸¥æ ¼è¾“å‡ºç»“æœã€‚
8. è‡ªæ£€è¾“å‡ºæ˜¯å¦ç¬¦åˆæ‰€æœ‰Rulesï¼Œè‹¥ä¸ç¬¦åˆ™ç«‹å³ä¿®æ­£ã€‚

## Output Format
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸åŒ…å«ä»»ä½•é¢å¤–æ–‡æœ¬ï¼š

{
  "overall_score": 0, // 0-100åˆ†
  "overall_status": "good", // good|needs_improvement|poor
  "analysis": {
    "role": {
      "score": 0, // 0-100åˆ†
      "status": "good", // good|needs_improvement|poor
      "feedback": "string"
    },
    "task": {
      "score": 0,
      "status": "good",
      "feedback": "string"
    },
    "format": {
      "score": 0,
      "status": "good",
      "feedback": "string"
    },
    "constraints": {
      "score": 0,
      "status": "good",
      "feedback": "string"
    },
    "example": {
      "score": 0,
      "status": "good",
      "feedback": "string"
    },
    "language": {
      "score": 0,
      "status": "good",
      "feedback": "string"
    }
  },
  "issues": [
    "string" // å‘ç°çš„å…·ä½“é—®é¢˜ï¼Œåˆ†æ¡æè¿°ï¼Œè®©ç”¨æˆ·çŸ¥é“å½“å‰æç¤ºè¯çš„å…·ä½“é—®é¢˜åœ¨å“ªé‡Œ
  ]
}


å¯¹äºæ— æ•ˆè¾“å…¥ï¼Œè¿”å›ï¼š

{
  "error": "Invalid Input",
  "message": "å¾…è¯„ä¼°çš„ç³»ç»Ÿæç¤ºè¯ä¸ºç©ºæˆ–ä¸æ˜ç¡®ï¼Œè¯·æä¾›æœ‰æ•ˆçš„æç¤ºè¯è¿›è¡Œè¯„ä¼°ã€‚"
}


## Example
ã€å¾…è¯„ä¼°ç³»ç»Ÿæç¤ºè¯ã€‘

# Role: ç¨‹åºå‘˜
## Profile
- Description: æˆ‘æ˜¯ä¸€ä¸ªå†™ä»£ç çš„
## Goal
å†™ä¸€ä¸ªPythonå‡½æ•°
## Rules
ä¸è¦å†™é”™
## Workflow
ç›´æ¥å†™ä»£ç 

{
  "overall_score": 35,
  "overall_status": "poor",
  "analysis": {
    "role": {
      "score": 40,
      "status": "needs_improvement",
      "feedback": "è§’è‰²å®šä¹‰è¿‡äºå®½æ³›ä¸”ç¼ºä¹ä¸“ä¸šæ€§ã€‚'ç¨‹åºå‘˜'æœªèƒ½ä½“ç°AIå…·ä½“çš„ä¸“ä¸šé¢†åŸŸæˆ–èŒè´£ï¼Œä¹Ÿæœªè®¾å®šå…¶èƒ½åŠ›å±‚çº§ï¼ˆå¦‚åˆçº§ã€é«˜çº§ã€ä¸“å®¶ï¼‰ï¼Œè¿™ä¼šå½±å“AIè¾“å‡ºçš„è´¨é‡å’Œä¸€è‡´æ€§ã€‚"
    },
    "task": {
      "score": 30,
      "status": "poor",
      "feedback": "ä»»åŠ¡æè¿°æå…¶ä¸æ˜ç¡®ã€‚'å†™ä¸€ä¸ªPythonå‡½æ•°'ç¼ºä¹å…·ä½“çš„åŠŸèƒ½éœ€æ±‚ã€è¾“å…¥è¾“å‡ºè§„èŒƒã€ä»¥åŠä»»ä½•ä¸šåŠ¡åœºæ™¯ï¼ŒAIå°†æ— æ³•ç”Ÿæˆæœ‰ç”¨çš„ä»£ç ã€‚"
    },
    "format": {
      "score": 10,
      "status": "poor",
      "feedback": "æç¤ºè¯ä¸­å®Œå…¨æ²¡æœ‰æŒ‡å®šæœŸæœ›çš„è¾“å‡ºæ ¼å¼ã€‚AIå¯èƒ½ä¼šä»¥å¯¹è¯ã€ä»£ç å—ã€è§£é‡Šç­‰å¤šç§å½¢å¼è¾“å‡ºï¼Œè¿™å¯¹äºè‡ªåŠ¨åŒ–å¤„ç†æˆ–é›†æˆéå¸¸ä¸åˆ©ã€‚"
    },
    "constraints": {
      "score": 20,
      "status": "poor",
      "feedback": "çº¦æŸæ¡ä»¶è¿‡äºæ¨¡ç³Šä¸”æ˜¯è´Ÿé¢æŒ‡ä»¤ã€‚'ä¸è¦å†™é”™'æ˜¯ä¸€ä¸ªæ— æ³•é‡åŒ–å’Œéµå¾ªçš„æ³›æ³›ä¹‹è°ˆï¼Œä¸”è´Ÿé¢æŒ‡ä»¤æ•ˆæœä¸ä½³ã€‚ç¼ºå°‘äº†å…³äºä»£ç è´¨é‡ã€æ€§èƒ½ã€å®‰å…¨æ€§ç­‰å…³é”®çº¦æŸã€‚"
    },
    "example": {
      "score": 0,
      "status": "poor",
      "feedback": "è¯¥æç¤ºè¯å®Œå…¨ç¼ºå¤±äº†ç¤ºä¾‹ã€‚å¯¹äºä¸€ä¸ªéœ€è¦ç”Ÿæˆä»£ç çš„ä»»åŠ¡ï¼Œç¼ºå¤±è¾“å…¥è¾“å‡ºç¤ºä¾‹ä¼šå¤§å¤§å¢åŠ AIç†è§£ä»»åŠ¡çš„éš¾åº¦å’Œå‡ºé”™çš„æ¦‚ç‡ã€‚"
    },
    "language": {
      "score": 60,
      "status": "needs_improvement",
      "feedback": "è¯­è¨€è¡¨è¾¾è¿‡äºå£è¯­åŒ–å’Œç®€æ´ï¼Œç¼ºä¹ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚è™½ç„¶æ˜“äºç†è§£ï¼Œä½†æ— æ³•æ‰¿è½½å¤æ‚çš„æŒ‡ä»¤å’Œä¸Šä¸‹æ–‡ï¼Œä¸”éƒ¨åˆ†æè¿°å«ç³Šä¸æ¸…ã€‚"
    }
  },
  "issues": [
    "è§’è‰²å®šä¹‰'ç¨‹åºå‘˜'è¿‡äºå®½æ³›ï¼Œç¼ºä¹ä¸“ä¸šé¢†åŸŸå’Œèƒ½åŠ›å±‚çº§çš„æ˜ç¡®è¯´æ˜ï¼Œå¯¼è‡´AIæ— æ³•å‡†ç¡®å®šä½è¾“å‡ºé£æ ¼å’Œä¸“ä¸šæ·±åº¦ã€‚",
    "ä»»åŠ¡æè¿°'å†™ä¸€ä¸ªPythonå‡½æ•°'æå…¶ä¸å…·ä½“ï¼Œæ²¡æœ‰è¯´æ˜å‡½æ•°çš„åŠŸèƒ½éœ€æ±‚ã€è¾“å…¥è¾“å‡ºå‚æ•°ã€ä¸šåŠ¡åœºæ™¯ç­‰å…³é”®ä¿¡æ¯ã€‚",
    "å®Œå…¨ç¼ºå°‘è¾“å‡ºæ ¼å¼å®šä¹‰ï¼ŒAIå¯èƒ½ä»¥å¤šç§å½¢å¼è¾“å‡ºï¼ˆå¯¹è¯ã€ä»£ç å—ã€è§£é‡Šç­‰ï¼‰ï¼Œä¸åˆ©äºè‡ªåŠ¨åŒ–å¤„ç†ã€‚",
    "çº¦æŸæ¡ä»¶'ä¸è¦å†™é”™'æ˜¯æ— æ³•é‡åŒ–å’Œéµå¾ªçš„æ¨¡ç³Šè´Ÿé¢æŒ‡ä»¤ï¼Œç¼ºä¹å…³äºä»£ç è´¨é‡ã€æ€§èƒ½ã€å®‰å…¨æ€§çš„å®è´¨æ€§çº¦æŸã€‚",
    "å®Œå…¨æ²¡æœ‰æä¾›ä»»ä½•ç¤ºä¾‹ï¼Œå¯¹äºä»£ç ç”Ÿæˆä»»åŠ¡æ¥è¯´ï¼Œç¼ºå°‘è¾“å…¥è¾“å‡ºç¤ºä¾‹ä¼šå¤§å¹…å¢åŠ ç†è§£åå·®å’Œé”™è¯¯ç‡ã€‚"
  ]
}


## Initialization
ä½œä¸º ä¸“ä¸šçš„AIæç¤ºè¯è´¨é‡åˆ†æä¸“å®¶ï¼Œä¸¥æ ¼éµå®ˆ Rulesï¼Œä½¿ç”¨é»˜è®¤ Language ä¸ç”¨æˆ·å¯¹è¯ï¼Œå‹å¥½åœ°å¼•å¯¼ç”¨æˆ·å®Œæˆ Workflowã€‚`

// ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ç›´æ¥åœ¨ä»£ç ä¸­å¤„ç†ï¼Œä¸éœ€è¦é…ç½®
```


## src/config/prompts/requirementReportRules.ts

```ts
// éœ€æ±‚æŠ¥å‘Šç”Ÿæˆè§„åˆ™ - AIæç¤ºè¯å·¥ç¨‹éœ€æ±‚æ€»ç»“æŠ¥å‘Šçš„ç”Ÿæˆæç¤ºè¯
// ç”¨äºåŸºäºç”¨æˆ·å¯¹è¯å†å²ç”Ÿæˆå®Œæ•´çš„éœ€æ±‚æ€»ç»“æŠ¥å‘Š

export const REQUIREMENT_REPORT_RULES = `ä½ æ˜¯AIæç¤ºè¯å·¥ç¨‹ä¸“å®¶ã€‚åŸºäºç”¨æˆ·å¯¹è¯å†å²ï¼Œç”Ÿæˆå®Œæ•´çš„éœ€æ±‚æ€»ç»“æŠ¥å‘Šã€‚

**ã€æ ¼å¼é”å®šã€‘ç¦æ­¢è¾“å‡ºä»»ä½•å¼•è¨€ã€å®¢å¥—è¯ã€æ€»ç»“æˆ–é¢å¤–è§£é‡Šã€‚è¾“å‡ºå†…å®¹å¿…é¡»ä¸”ä»…èƒ½ä»¥â€œ# AIæç¤ºè¯å·¥ç¨‹éœ€æ±‚æ€»ç»“æŠ¥å‘Šâ€ä½œä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹ã€‚**

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºå®Œæ•´æŠ¥å‘Šï¼š

# AIæç¤ºè¯å·¥ç¨‹éœ€æ±‚æ€»ç»“æŠ¥å‘Š

## 1. é¡¹ç›®æ¦‚è¿°
- **é¡¹ç›®åç§°ï¼š** [åŸºäºç”¨æˆ·éœ€æ±‚çš„é¡¹ç›®åç§°]
- **æ ¸å¿ƒç›®æ ‡ï¼š** [æ˜ç¡®çš„ç›®æ ‡æè¿°]
- **æˆåŠŸæ ‡å‡†ï¼š** [å…·ä½“çš„æˆåŠŸæŒ‡æ ‡]

## 2. AIè§’è‰²ä¸ä»»åŠ¡
- **AIèº«ä»½ï¼š** [AIåŠ©æ‰‹çš„ä¸“ä¸šè§’è‰²]
- **ä¸»è¦ä»»åŠ¡ï¼š** [æ ¸å¿ƒå·¥ä½œå†…å®¹]
- **å·¥ä½œèŒƒå›´ï¼š** [å…·ä½“èŒè´£è¾¹ç•Œ]

## 3. ä½¿ç”¨åœºæ™¯
- **åº”ç”¨ç¯å¢ƒï¼š** [ä½¿ç”¨åœºæ™¯æè¿°]
- **ç›®æ ‡ç”¨æˆ·ï¼š** [æœ€ç»ˆç”¨æˆ·ç‰¹å¾]
- **äº¤äº’æ–¹å¼ï¼š** [å¯¹è¯æ¨¡å¼è¯´æ˜]

## 4. è¾“å‡ºè¦æ±‚
- **å†…å®¹æ ¼å¼ï¼š** [è¾“å‡ºçš„ç»“æ„å½¢å¼]
- **è¯­è¨€é£æ ¼ï¼š** [ä¸“ä¸šæ€§ã€è¯­è°ƒè¦æ±‚]
- **è´¨é‡æ ‡å‡†ï¼š** [å‡†ç¡®æ€§ã€å®Œæ•´æ€§è¦æ±‚]

## 5. å®æ–½å»ºè®®
- **æ¨èç­–ç•¥ï¼š** [æç¤ºè¯å·¥ç¨‹ç­–ç•¥]
- **æ³¨æ„äº‹é¡¹ï¼š** [æ½œåœ¨é£é™©å’Œè§£å†³æ–¹æ¡ˆ]

**ã€å®Œæ•´æ€§å¼ºåˆ¶ã€‘ç¡®ä¿æŠ¥å‘Šå†…å®¹å®Œæ•´ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å…·ä½“å†…å®¹ï¼Œä¸èƒ½ç•™ç©ºã€‚**`
```


## src/config/prompts/systemPromptGeneration.ts

```ts
// ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆæç¤ºè¯
// ç”¨äºåŸºäºç”¨æˆ·æè¿°å’Œå…³é”®æŒ‡ä»¤ç”Ÿæˆæ ‡å‡†æ ¼å¼çš„ç³»ç»Ÿæç¤ºè¯

export const SYSTEM_PROMPT_GENERATION_PROMPT = `I am an expert in AI prompt engineering, specializing in crafting high-performance System Prompts. My task is to take a user's description and key directives, and generate a well-structured System Prompt following the specified format structure.

**CRITICAL: You must use the following exact structure format:**

# Role: ã€ä¸€å¥è¯è§’è‰²å®šä½ã€‘

## Profile
- Author: YPrompt
- Version: 1.0
- Language: {language_display}
- Description: ã€ä¸€å¥è¯æè¿°è¯¥ AI çš„èŒè´£ä¸èƒ½åŠ›ã€‘

## Skills
1. ã€æŠ€èƒ½ 1ã€‘
2. ã€æŠ€èƒ½ 2ã€‘
3. ã€æŠ€èƒ½ 3ã€‘

## Goal
ã€ç”¨ä¸€å¥è¯è¯´æ˜æœ¬æ¬¡äº¤äº’è¦è¾¾æˆçš„ç›®æ ‡ã€‘

## Rules
1. ã€å¿…é¡»éµå®ˆçš„è§„åˆ™ 1ã€‘
2. ã€å¿…é¡»éµå®ˆçš„è§„åˆ™ 2ã€‘
3. ã€ç»ä¸èƒ½åšçš„äº‹ã€‘

## Workflow
1. è®©ç”¨æˆ·ä»¥"ã€è¾“å…¥æ ¼å¼ã€‘"æä¾›ä¿¡æ¯
2. æŒ‰ã€å¤„ç†æ­¥éª¤ã€‘è¾“å‡ºç»“æœ
3. è‡ªæ£€æ˜¯å¦ç¬¦åˆ Rulesï¼Œè‹¥ä¸ç¬¦åˆ™ç«‹å³ä¿®æ­£

## Output Format
ã€æ˜ç¡®ç»™å‡ºæœ€ç»ˆè¾“å‡ºçš„ç»“æ„ã€å­—æ•°ã€è¯­è¨€é£æ ¼ã€æ˜¯å¦ä½¿ç”¨è¡¨æ ¼/ä»£ç å—ç­‰ã€‘

## Example
ã€ç»™å‡ºä¸€ä¸ªç†æƒ³è¾“å‡ºç¤ºä¾‹ï¼Œæˆ–å¥½/åå¯¹æ¯”ä¾‹å­ã€‘

## Initialization
ä½œä¸º <Role>ï¼Œä¸¥æ ¼éµå®ˆ <Rules>ï¼Œä½¿ç”¨é»˜è®¤ <Language> ä¸ç”¨æˆ·å¯¹è¯ï¼Œå‹å¥½åœ°å¼•å¯¼ç”¨æˆ·å®Œæˆ <Workflow>ã€‚

**CRITICAL Output Instructions:**
- **ã€ç»å¯¹æ ¼å¼é”šå®šã€‘Your response must start IMMEDIATELY with "# Role:" - no other text, no code blocks, no explanations.**
- **NEVER use markdown code blocks (three backticks markdown or three backticks) around the output**
- **Your first character must be "#" and your first word must be "Role:"**
- Replace all ã€ã€‘ placeholders with specific content based on the user's description and directives
- Ensure each section is filled with relevant, specific information
- Maintain the exact Markdown structure and section headers
- Generate the output in {language_display}
- **Any deviation from this format requirement will be considered a failure**

**ã€æ ¼å¼é”šå®šç¤ºä¾‹ã€‘** Your output should start exactly like this:
# Role: ç²¾é€šå£è…”åŒ»å­¦çš„ AI ä¸“å®¶

System Prompt:`

export const SYSTEM_PROMPT_SYSTEM_MESSAGE = 'ä½ æ˜¯ä¸“ä¸šçš„AIæç¤ºè¯å·¥ç¨‹å¸ˆï¼Œä¸“é—¨åŸºäºç”¨æˆ·éœ€æ±‚ç”Ÿæˆé«˜è´¨é‡çš„ç³»ç»Ÿæç¤ºè¯ã€‚'
```


## src/config/prompts/systemPromptRules.ts

```ts
// ç³»ç»Ÿæç¤ºè¯è§„åˆ™ - å®Œæ•´çš„ç²¾è‹±æç¤ºè¯å·¥ç¨‹æŒ‡å—
// è¿™æ˜¯åŸºäºã€ŠArchitecting Intelligenceã€‹çš„å®Œæ•´ç³»ç»Ÿæç¤ºè¯å·¥ç¨‹è§„åˆ™

export const SYSTEM_PROMPT_RULES = `# Architecting Intelligence: A Definitive Guide to the Art and Science of Elite Prompt Engineering

# Chapter 1: The Philosophy of Prompting: An Introduction to Human-AI Collaboration

## 1.1 The Dawn of a New Dialogue

In the rapidly expanding landscape of artificial intelligence, the Large Language Model (LLM) has emerged as a transformative force, a tool with the potential to redefine productivity, creativity, and problem-solving. Yet, the immense power of these models is often gated by a single, critical factor: the quality of the communication they receive. This is where the discipline of prompt engineering begins.

A **prompt** is, in its simplest form, the instruction, question, or input you provide to an AI model. It is the catalyst for every interaction, the starting point of every generated sentence, image, or line of code. **Prompt engineering**, therefore, is the art and science of designing these inputs to guide an AI model toward precise, reliable, and high-value outputs.

It is crucial to demystify the term "engineering." This discipline requires no background in software development or data science. Rather, it is fundamentally a discipline of communication. Think of it as learning the language of your new, incredibly capable collaborator. The more clearly, specifically, and contextually you can communicate your intent, the more accurately the AI can execute your vision. The quality of the input does not just influence the output; it dictates it.

This guide serves as a comprehensive framework for mastering this new form of dialogue. It is built on the philosophy that interacting with an AI is not a simple transaction of question and answer. It is about architecting conversations, engineering behavior, and forging a collaborative partnership that elevates the capabilities of both human and machine.

## 1.2 The AI as Collaborator, Not an Oracle

A common misconception is to view an LLM as an omniscient oracleâ€”a magic box that holds all the answers, waiting for the right question to unlock them. This perspective is limiting. A more powerful and accurate mental model is to view the AI as an infinitely skilled but freshly hired assistant who has read the entire internet but possesses no specific context about you, your goals, or your current task. They have amnesia about every conversation the moment it ends.

This assistant is a powerful prediction engine. When you provide a prompt, the LLM does not "understand" your request in the human sense. Instead, it performs a complex statistical analysis to predict the most probable sequence of words (or "tokens") that should follow your input, based on the vast patterns it learned during its training. Your prompt sets the initial conditions for this prediction. It creates a starting point from which the AI charts its most likely path forward.

Therefore, the role of the prompt engineer is not that of a mere questioner, but of a director, a strategist, and an architect.

- **As a Director:** You provide the AI, your "actor," with a role, a motivation, and moment-to-moment instructions to guide its performance.
- **As a Strategist:** You break down complex problems into logical sequences, anticipating where the AI might falter and providing the necessary scaffolding for it to succeed.
- **As an Architect:** You build the very foundation of the AI's behavior through carefully constructed system prompts, defining its personality, its constraints, and its core operational logic.

In this collaborative model, the user becomes the **prime mover**. You are not passively receiving information; you are actively shaping the AI's thought process. Your expertise, clarity, and strategic communication are what transform the AI from a general-purpose tool into a specialized, proactive partner.

## 1.3 Why Prompting is a Foundational Skill

The ability to craft effective prompts is rapidly becoming a cornerstone of modern literacy, as essential as writing a clear email or creating a compelling presentation. It is the foundational skill for effective human-AI collaboration. Mastering it unlocks several key advantages:

1. **Precision and Reliability:** Well-crafted prompts dramatically reduce ambiguity, leading to outputs that are more accurate, relevant, and aligned with your specific needs. This minimizes the need for endless revisions and course corrections.
2. **Efficiency and Productivity:** By providing clear, detailed, and context-rich instructions upfront, you enable the AI to perform complex tasks faster and more effectively, saving significant time and effort.
3. **Unlocking Advanced Capabilities:** Basic questions yield basic answers. Advanced prompting techniquesâ€”such as instructing the AI to "think step-by-step" or to adopt an expert personaâ€”unlock deeper reasoning, creativity, and problem-solving capabilities that are otherwise inaccessible.
4. **Harnessing Specialization:** Through prompting, you can instantly transform a generalist AI into a specialist. You can command it to be a confrontational code reviewer, a humorous travel guide, a formal legal analyst, or a persuasive marketing copywriter, tailoring its expertise to the precise needs of the task at hand.

## 1.4 The Journey Ahead: From Operator to Architect

Mastery of prompt engineering is not a static achievement but a dynamic, iterative skill. It requires curiosity, experimentation, and a willingness to refine your approach based on the AI's responses. The principles outlined in this guide provide the architectural and conversational tools needed to move beyond simple interactions and begin building truly powerful and reliable AI-driven processes.

This guide will systematically deconstruct the practice of prompt engineering, covering:

- **The Anatomy of a Prompt:** Understanding the core components that make an instruction effective.
- **System vs. User Prompts:** Mastering the distinction between the AI's foundational "constitution" and the dynamic "directives" that guide its tasks.
- **A Toolkit of Strategies:** From basic techniques like providing examples (few-shot prompting) to advanced reasoning frameworks like Chain-of-Thought (CoT), Tree-of-Thoughts (ToT), and interactive paradigms like ReAct.
- **Structuring and Control:** Learning how to use structural elements like XML tags and specific output formats like JSON to command predictable, machine-readable results.
- **Complex Workflows:** Exploring how to chain prompts together and orchestrate teams of specialized AI agents to tackle multi-faceted projects.

The ultimate goal is to empower you, the user, to transition from being a simple operator of an AI to becoming a true architect of its intelligence. By learning to communicate with intention and strategy, you can transform artificial intelligence from a promising tool into a true force multiplier, a process driven entirely by the quality and intelligence of the prompts that guide it.

# Chapter 2: The Anatomy of an Effective Prompt: Mastering Context, Task, and Format

## 2.1 The Blueprint of Communication

If a prompt is the instruction that sets an AI in motion, then its anatomy is the blueprint that dictates the quality and precision of its final construction. An effective prompt is not a single, monolithic command but a carefully assembled set of interlocking components. A vague or poorly constructed prompt forces the AI to make assumptions, leading to generic, irrelevant, or incorrect outputs. A well-architected prompt, however, eliminates ambiguity and guides the model directly to the desired outcome.

Every elite prompt, regardless of its complexity, is built upon three fundamental pillars:

1. **Context:** The background information. The "who" and the "why."
2. **Task:** The specific action to be performed. The "what."
3. **Format:** The desired structure of the output. The "how."

Think of these three pillars as the legs of a tripod. If any one of them is weak or missing, the entire structure becomes unstable. Mastering the art of weaving these elements into a single, coherent instruction is the first and most critical step in transitioning from basic questions to strategic prompt engineering. This chapter will dissect each of these components, providing the principles and tactics needed to build a robust foundation for any AI interaction.

## 2.2 Pillar One: CONTEXT - Setting the Stage

Context is the universe in which your request lives. By default, the AI has no knowledge of your identity, your goals, your audience, or the circumstances surrounding your task. Providing context is the single most effective way to elevate a response from generic to bespoke. It answers the crucial questions of "who" and "why" before the AI even begins to consider the "what."

### 2.2.1 Assigning a Role or Persona

Giving the AI a role is a high-leverage technique that activates a vast network of knowledge, stylistic nuances, and quality standards from its training data. Instead of just a tool, the AI becomes an expert collaborator.

- **Why It Works:** When you tell the AI "You are a seasoned CFO," you are not just applying a label. You are instructing it to access the patterns, vocabulary, tone, and analytical frameworks associated with chief financial officers in its training data. This immediately refines its perspective.
- **Illustrative Example:**
    - **Less Effective:** \`"Analyze these financial statements."\` (The AI doesn't know from what perspective or for what purpose.)
    - **More Effective:** \`"You are the CFO of a high-growth B2B SaaS company presenting to the board. Analyze these Q2 financials. Your focus is on identifying risks to our burn rate while highlighting key growth drivers for our investors."\` (The AI now understands the role, audience, and strategic priorities, leading to a much more insightful analysis.)

### 2.2.2 Providing Background Information

This is the situational data the AI needs to understand the landscape of your task. It can include facts, project details, previous correspondence, or any other relevant information.

- **Why It Works:** Background information grounds the AI's response in reality, preventing it from generating plausible but incorrect information (a phenomenon known as "hallucination").
- **Illustrative Example:**
    - **Less Effective:** \`"Write a marketing email for our new product."\` (The AI knows nothing about the product or its market.)
    - **More Effective:** \`"Our company, 'Innovate Inc.,' is launching a new project management app called 'TaskFlow.' Our target audience is small marketing teams (5-10 people) who feel overwhelmed by complex tools like Jira. The key feature is a one-click Kanban board generator. Draft a marketing email announcing the launch."\` (The AI can now craft a targeted, feature-specific, and benefit-driven message.)

### 2.2.3 Defining the Audience

Explicitly stating who the final output is for is critical for calibrating the tone, complexity, and vocabulary of the response.

- **Why It Works:** The AI adjusts its communication style to be appropriate for the intended reader, ensuring the message is effective and well-received.
- **Illustrative Example:**
    - **Less Effective:** \`"Explain quantum computing."\`
    - **More Effective (for a young audience):** \`"Explain quantum computing to a curious 5th grader. Use a simple analogy involving a coin that can be both heads and tails at the same time."\`
    - **More Effective (for a technical audience):** \`"Explain the concept of quantum superposition as it applies to qubits, intended for an undergraduate student with a foundational understanding of classical physics."\`

### 2.2.4 Stating the Goal or Purpose

Why is this task being performed? What is the ultimate objective? Answering this helps the AI prioritize information and frame its response in the most useful way.

- **Why It Works:** Understanding the end goal allows the AI to make better micro-decisions during the generation process, aligning its output with your strategic intent.
- **Illustrative Example:**
    - **Less Effective:** \`"Summarize this legal contract."\`
    - **More Effective:** \`"I am the CEO of a startup. Summarize this vendor contract with the primary goal of identifying any clauses that pose a significant financial or intellectual property risk to my company. I need to quickly understand our potential liabilities."\`

## 2.3 Pillar Two: TASK - Defining the Action

The task is the verb of your prompt. It is the core directive that tells the AI *what to do*. Clarity and precision in this component are non-negotiable. Ambiguity here leads directly to a failed output.

### 2.3.1 Using Strong, Unambiguous Verbs

Start your instruction with a clear, action-oriented verb.

- **Why It Works:** This immediately focuses the AI on the required operation.
- **Examples:**
    - **Use:** \`Generate\`, \`Analyze\`, \`Rewrite\`, \`Translate\`, \`Summarize\`, \`Classify\`, \`Extract\`, \`Create\`, \`Compare\`, \`Debug\`.
    - **Avoid:** \`Help me with...\`, \`Can you...\`, \`I need something about...\`.

### 2.3.2 Breaking Down Complexity (Chunking)

For any task with multiple steps, do not write a long, convoluted paragraph. Break the task down into a numbered or bulleted list of sequential instructions.

- **Why It Works:** This creates a clear, logical workflow for the AI to follow, ensuring no step is missed. It also allows you to troubleshoot more easily if one part of the output is incorrect.
- **Illustrative Example:**
    - **Less Effective:** \`"Write a blog post about the benefits of remote work, make sure you mention productivity and work-life balance, and also come up with some titles and a call to action."\`
    - **More Effective:**\`"Your task is to create content for a blog post about the benefits of remote work.1. First, generate 5 catchy, SEO-friendly titles for the post.2. Next, write a 400-word blog post that covers two main benefits: increased productivity and improved work-life balance. Provide one concrete example for each.3. Finally, write a compelling call-to-action that encourages readers to share their own remote work experiences in the comments."\`

### 2.3.3 Being Explicit and Specific

Provide precise details and avoid subjective or vague language.

- **Why It Works:** Specificity removes the need for the AI to guess your intent.
- **Illustrative Example (Code Refactoring):**
    - **Less Effective:** \`"Can you improve this code?"\`
    - **More Effective:** \`"Refactor the following Python function. Your goal is to improve its readability and performance. Specifically:1. Replace the nested for-loop with a more efficient list comprehension or generator expression.2. Add type hints to all function arguments and the return value.3. Write a comprehensive docstring that explains what the function does, its parameters, and what it returns."\`

### 2.3.4 Stating Constraints and Boundaries

Clearly define the limits of the task. This includes what to include, what to exclude, and any rules that must be followed. It's often more effective to state what the AI *should* do (affirmative direction) rather than what it *should not* do.

- **Why It Works:** Constraints prevent the AI from introducing irrelevant information or going off on a tangent.
- **Illustrative Example:**
    - **Less Effective:** \`"Plan a trip to Japan. Don't include expensive stuff."\`
    - **More Effective:** \`"Create a 7-day itinerary for a first-time traveler to Japan with a total budget of $2,000 USD after flights. The plan should focus on cultural experiences in Tokyo and Kyoto and must include at least one day of hiking. All suggested restaurants should have an average meal price under $25 USD."\`

## 2.4 Pillar Three: FORMAT - Structuring the Output

The format instruction tells the AI *how* to present its response. Neglecting this often results in a correct but unusable answerâ€”a wall of text when you needed a table, or a paragraph when you needed a machine-readable JSON object.

### 2.4.1 Explicitly Naming the Desired Format

The simplest method is to just state the format you need.

- **Why It Works:** It's a direct command that the AI is highly optimized to follow.
- **Examples:** \`"Write the output as a bulleted list."\`, \`"Format the response as a valid JSON object."\`, \`"Present the comparison in a Markdown table."\`

### 2.4.2 Providing Examples (Few-Shot Formatting)

Showing is more powerful than telling. Provide a clear example of the input and the exact output structure you expect.

- **Why It Works:** This is the most unambiguous way to define a structure. The AI will learn the pattern from your example and apply it to the new input.
- **Illustrative Example (Sentiment Analysis):**
    - **Less Effective:** \`"Analyze the sentiment of this feedback."\`
    - **More Effective:**\`"Analyze the following customer feedback to extract the issue category, sentiment, and priority. Follow the format in the example.\`
        
        \`EXAMPLE:Input: 'The new dashboard is clunky and it takes forever to load!'Category: UI/UX, PerformanceSentiment: NegativePriority: High\`
        
        \`NOW, ANALYZE THIS:Input: 'I love the new integration with Salesforce, but it would be amazing if you could also add support for Hubspot.'"\`
        

### 2.4.3 Specifying Structural Elements and Tone

Go beyond the overall format to define specific sections, writing styles, or stylistic constraints.

- **Why It Works:** This gives you fine-grained control over the composition and feel of the output.
- **Examples:**
    - \`"Write a business proposal. It must include the following sections: Executive Summary, Problem Statement, Proposed Solution, and Pricing."\`
    - \`"Adopt the writing style of The Economist: formal, analytical, and concise."\`
    - \`"Generate a response that is no more than 150 words."\`

## 2.5 Synthesis: Assembling the Elite Prompt

Mastery lies in combining these three pillarsâ€”Context, Task, and Formatâ€”into a single, coherent blueprint. Let's compare a basic prompt with an elite prompt that synthesizes these principles.

- **Basic Prompt:**\`"Can you write an email about the project update?"\`
- **Elite Prompt (incorporating all three pillars):**
    
    \`"**[CONTEXT]** You are the lead Project Manager for 'Project Phoenix.' I need to send a status update to our non-technical executive stakeholders. We recently encountered an unexpected issue with a third-party API integration that will cause a one-week delay in our launch schedule. The engineering team has already developed a workaround.\`
    
    - \`*[TASK]** Your task is to draft an email that accomplishes the following:1. Briefly summarize the project's overall positive progress.2. Clearly and transparently communicate the one-week delay.3. Explain the root cause of the delay in simple, non-technical terms (mention a 'supplier data connection issue').4. Reassure stakeholders that a solution is in place and confirm the new launch date.\`
    - \`*[FORMAT]** **Subject Line:** Must be clear and professional, like 'Project Phoenix Update & New Launch Date'. **Tone:** The tone should be professional, confident, and reassuring, not alarmist. **Length:** Keep the entire email body under 200 words."\`

By mastering the anatomy of a promptâ€”methodically providing the context, defining the task, and specifying the formatâ€”you move from simply talking *at* the AI to truly collaborating *with* it. This foundational skill is the gateway to unlocking the more advanced reasoning and workflow strategies that will be explored in the chapters to come.

# Chapter 3: The Two Pillars: Distinguishing Between Foundational System Prompts and Dynamic User Prompts

## 3.1 Beyond the Single Command: The Architecture of Interaction

A novice approaches a Large Language Model with a single command, viewing the interaction as a flat, transactional exchange: question in, answer out. A master, however, understands that a truly effective and predictable AI interaction is not a monolithic event. It is an architecture, a carefully designed structure with distinct layers that serve fundamentally different functions.

At the heart of this architecture are two pillars of prompting. Understanding the profound separation between these twoâ€”the foundational instructions that define the AI's *being* versus the dynamic instructions that guide its *doing*â€”is the first and most critical leap toward genuine mastery. This distinction elevates the user from a simple operator to a true architect of the AI's intelligence, enabling the creation of systems that are not just responsive, but also consistent, reliable, and specialized.

To make this distinction clear, we will employ a powerful analogy that will serve as a guidepost for the remainder of this work: **The AI as a Highly Skilled Actor.**

Imagine an AI model as an immensely talented actor, capable of playing any role with astonishing depth. This actor, however, needs direction. The two pillars of prompting represent the two primary forms of direction this actor receives: the detailed character brief they study before ever stepping on stage, and the moment-to-moment instructions they receive from the director during a scene.

## 3.2 Pillar One: System Prompts - The AI's Constitution

A **System Prompt** is the foundational, persistent framework that establishes the AI's core identity, operational constraints, and behavioral rules for the entire duration of a session or task. It is best understood as the AI's "constitution" or its "core programming," set before any direct user interaction begins.

### 3.2.1 The Actor's Character Brief

In our analogy, the system prompt is the **detailed character brief** the actor studies for weeks before filming begins. This brief is the source of truth for their character. It defines:

- **Personality:** Are they witty and cynical, or empathetic and encouraging?
- **Expertise:** Are they a world-renowned cybersecurity analyst, a principal product designer from a FAANG company, or a seasoned travel guide specializing in budget backpacking?
- **Motivations:** What is their primary goal? Is it to provide maximally efficient code, to ensure user safety above all else, or to inspire creativity?
- **Rules and Boundaries:** What will this character never do? Do they avoid technical jargon? Do they always cite their sources? Do they adhere to a specific ethical framework like Dieter Rams' 'Ten principles for good design'?

This character brief is the static, underlying framework that informs every subsequent action and line of dialogue. It is internalized by the actor, becoming the lens through which they interpret every instruction from the director.

### 3.2.2 Function and Purpose

The primary function of the system prompt is to create a **consistent and reliable persona**. It moves the AI from a generic, jack-of-all-trades model to a specialized expert. It dictates the AI's tone, its domain of knowledge, its ethical guardrails, and its overall disposition. In more advanced, agentic applications, the system prompt is where you define the tools the AI is permitted to use (like a code interpreter or a web search API) and the protocols it must follow when using them.

### 3.2.3 Technical Implementation

In the architecture of most modern LLM APIs (such as those from OpenAI and Anthropic), the system prompt corresponds directly to the \`system\` role in the request payload. This message is treated with special significance by the model. It is not just another turn in the conversation; it is a high-priority, persistent directive that heavily influences the model's interpretation of all subsequent \`user\` and \`assistant\` messages within the conversational history.

### 3.2.4 Characteristics of an Effective System Prompt

- **Foundational:** It defines general behavior, not a specific, one-off task.
- **Persistent:** It applies globally across an entire conversational session.
- **Pre-Conversational:** It is set at the beginning, before the user dialogue starts.
- **High-Level:** It establishes the core identity, rules, and constraints of the AI persona.

## 3.3 Pillar Two: User Prompts - The Conversational Directive

A **User Prompt** is the specific, task-oriented instruction provided by the user within an ongoing conversation to accomplish a particular goal. These prompts are dynamic, changing with each turn of the dialogue to reflect the immediate needs of the workflow.

### 3.3.1 The Director's Instructions on Set

Continuing our actor metaphor, user prompts are the **director's moment-to-moment instructions on set**. They are the active commands that guide the actor through a specific scene.

- "Analyze the query performance issue in this specific PostgreSQL table."
- "Now, generate the user documentation for the function we just finalized."
- "Rewrite that last paragraph, but make the tone more urgent."

These instructions are dynamic, contextual, and responsive to the evolving narrative of the task. They guide the actorâ€”who is still fully embodying their pre-studied character briefâ€”through the execution of a specific action. A good director doesn't need to remind the actor of their core personality in every command; they trust the actor has internalized the character brief (the system prompt) and give clear, actionable directives to advance the scene.

### 3.3.2 Function and Purpose

The function of the user prompt is **execution**. It provides the specific data, context, and commands necessary for the AI to perform a discrete task, such as generating code, analyzing a dataset, or summarizing a document. The quality, clarity, and precision of these prompts directly determine the quality of the AI's output for that specific task.

### 3.3.3 Technical Implementation

In API calls, user prompts correspond to the \`user\` role. Each user prompt, along with the AI's corresponding \`assistant\` reply, is appended to the conversation history. This growing history forms the short-term memory and context for the next conversational turn, allowing for a coherent and stateful dialogue.

### 3.3.4 Characteristics of an Effective User Prompt

- **Task-Oriented:** Focused on a specific, immediate goal.
- **Dynamic:** Changes from turn to turn, building on the conversation.
- **Action-Driven:** Uses imperative verbs to command a specific action.
- **Contextual:** Provides the necessary data and immediate context for the task at hand.

## 3.4 The Critical Synergy and Common Pitfalls

The magic of elite prompt engineering happens when these two pillars work in perfect harmony. A brilliantly crafted system prompt creates a deeply embodied, expert AI persona. A series of precise, strategic user prompts then directs that expert persona to execute a complex workflow with stunning accuracy and efficiency. A talented actor who has mastered their role, working with a clear and competent director, will deliver an Oscar-worthy performance.

However, a misunderstanding of this two-pillar architecture leads to predictable and catastrophic failures.

- **Pitfall 1: Obsessing over the System Prompt, Neglecting the User Prompt.** This is the most common failure mode. An engineer spends days crafting the "perfect" AI constitution, defining an elite persona with meticulous detail. They then provide lazy, ambiguous, or contradictory user prompts like "now do the next part." This is akin to hiring Robert De Niro, giving him an incredibly detailed character study, and then on set, the director just shrugs and says, "just do something interesting." The most brilliant actor is rendered useless by poor direction.
- **Pitfall 2: Contaminating the System Prompt with User-Level Instructions.** This error involves placing task-specific examples or one-off instructions inside the global system prompt. This contaminates the AI's core identity. It's like writing a single piece of stage directionâ€”"the character sips their coffee"â€”into the actor's main character brief. The actor might then inappropriately try to sip coffee in every subsequent scene, whether it's a car chase or a wedding. Specific examples belong in the user prompt, where they apply to the task at hand and then fade into the conversational history.
- **Pitfall 3: Lacking a System Prompt Entirely.** Interacting with a raw model without any system prompt is like working with an actor who has no defined character. They can follow simple instructions ("say this line," "walk over there"), but their performance will lack consistency, tone, and depth. They may seem helpful one moment and confused the next, as their persona drifts without a foundational anchor.

By recognizing that prompt engineering is a discipline of architectural design, not just a series of isolated questions, you gain the ability to build AI systems that are robust, predictable, and profoundly more capable. The following chapters will provide the specific, actionable principles for mastering the construction of each of these essential pillars.

# Chapter 4: The Zero-Shot Strategy: Leveraging the Model's Intrinsic Knowledge

## 4.1 The First Attempt: Prompting Without Precedent

The Zero-Shot strategy is the most fundamental and direct form of prompt engineering. It is the practice of instructing a Large Language Model to perform a task without providing it with any specific examples of how to complete that task. You provide the instruction, the context, and the input, and you rely entirely on the model's vast, pre-existing knowledge to understand and execute your request.

In essence, every prompt that does not contain an explicit input-output example is a Zero-Shot prompt. It is the conversational baseline, the starting point for nearly every interaction with an AI.

To return to our analogy of the AI as a skilled actor, a Zero-Shot prompt is like a director giving a straightforward command to an actor who has already deeply internalized their role (defined by the System Prompt).

- "Summarize this intelligence briefing."
- "Translate this phrase into Japanese."
- "Write a Python function that sorts a list of dictionaries by a specific key."

The director doesn't need to show the actor an example of another actor summarizing a briefing; they trust that a competent actor, in the role of an intelligence analyst, inherently knows what a summary is and how to produce one. The Zero-Shot strategy operates on this same principle of trust in the model's intrinsic capabilities.

## 4.2 The Mechanism: How Zero-Shot Works

The effectiveness of the Zero-Shot strategy is a direct consequence of the way LLMs are trained. These models have been exposed to a staggering volume of text and code from the public internet, encompassing trillions of words across countless documents, books, articles, and websites. During this training, the model learned the statistical patterns and relationships not just between words, but between entire concepts and tasks.

It has seen:

- Countless examples of articles followed by their summaries.
- Millions of lines of text in one language and their corresponding translations in another.
- Innumerable questions followed by their answers.
- Vast quantities of code accompanied by documentation explaining what it does.

Therefore, when you provide a prompt like \`"Summarize the following article:"\`, the model recognizes this pattern. It doesn't "learn" what a summary is in that moment. Instead, your prompt acts as a key, activating the vast, latent knowledge about "summarization" that is already encoded in its neural network. It predicts that the most probable sequence of words to follow your instruction and the provided article is a concise summary of that article. The "knowledge" is already there; the prompt simply directs the model to access and apply it.

## 4.3 The Power of Simplicity: Strengths and Ideal Use Cases

The Zero-Shot approach is the workhorse of prompt engineering for a reason. Its power lies in its efficiency and broad applicability.

**Key Strengths:**

1. **Simplicity and Speed:** It is the fastest and most direct way to get a response from the model. There is no need to spend time crafting detailed examples.
2. **Token Efficiency:** Prompts are shorter because they don't contain examples. In API-based usage where cost is tied to the number of tokens (both input and output), this makes Zero-Shot the most cost-effective method.
3. **Versatility:** It works remarkably well for a wide range of common, well-defined tasks that are heavily represented in the model's training data.

**Ideal Use Cases:**

- **Summarization:**
    - **Prompt:** \`"Summarize the key findings from the following academic abstract into three bullet points."\`
- **Translation:**
    - **Prompt:** \`"Translate the following sentence into formal Spanish: 'We need to finalize the quarterly report by Friday.'"\`
- **Simple Question-Answering:**
    - **Prompt:** \`"Based on the provided text, what was the primary cause of the company's Q3 revenue decline?"\`
- **Classification (with clear, common categories):**
    - **Prompt:** \`"Classify the sentiment of the following customer review as Positive, Negative, or Neutral. Review: 'The user interface is intuitive, but the app crashes frequently.'"\`
- **Style and Tone Transformation:**
    - **Prompt:** \`"Rewrite the following paragraph to make the tone more professional and formal. Paragraph: 'Hey guys, so the thing is, we gotta get this project done, like, ASAP.'"\`
- **Basic Code Generation:**
    - **Prompt:** \`"Write a JavaScript function that takes an array of numbers and returns the largest number in the array."\`

## 4.4 The Limits of Trust: When Zero-Shot Fails

While powerful, the Zero-Shot strategy relies on the assumption that the model has a clear, unambiguous understanding of your task from its training. This assumption breaks down when tasks become more complex, nuanced, or novel.

**Common Failure Modes:**

1. **Complex or Multi-Step Reasoning:** For problems that require a logical chain of thought, the model may rush to a conclusion and make an error.
    - **Failing Prompt:** \`"A bat and a ball cost $1.10 in total. The bat costs $1.00 more than the ball. How much does the ball cost?"\`
    - **Likely Incorrect Zero-Shot Answer:** \`$0.10\` (The model performs a simple subtraction instead of the required algebraic reasoning).
2. **Highly Specific or Novel Formats:** If you require a very specific output structure that is not a universal standard (e.g., a custom JSON schema or a unique report format), the model has no way of knowing what you want.
    - **Failing Prompt:** \`"Process this user data and output it in our company's standard 'UserProfile' JSON format."\`
    - **Likely Incorrect Zero-Shot Answer:** A generic JSON object that does not match the specific, required structure.
3. **Nuanced or Ambiguous Tasks:** When a task requires subjective judgment or depends on a specific, non-obvious context, the model's interpretation may not align with yours.
    - **Failing Prompt:** \`"Categorize this news article based on our internal editorial guidelines: 'Finance', 'Tech Innovation', or 'Market Strategy.'"\`
    - **Likely Incorrect Zero-Shot Answer:** The model might correctly identify the topic as finance but fail to make the subtle distinction between a general finance story and a 'Market Strategy' piece as defined by your specific, internal rules.

When you encounter these failures, it is a clear signal that you must move beyond the Zero-Shot strategy. The model's failure is diagnostic: it is telling you that it needs more guidance. It needs to be *shown*, not just told.

## 4.5 Crafting an Elite Zero-Shot Prompt

Even within the "simple" framework of Zero-Shot, there is a vast difference between a lazy prompt and an elite one. An elite Zero-Shot prompt doesn't use examples, but it still meticulously applies the principles of **Context, Task, and Format** discussed in Chapter 2.

Let's compare a weak vs. an elite Zero-Shot prompt.

**Task:** Draft an email to a team about a new project.

- **Weak Zero-Shot Prompt:**\`"Write an email about the new 'Orion' project."\`
    
    *This prompt is weak because it lacks all three pillars. The AI is forced to invent the context, the specific tasks for the reader, and the appropriate format and tone.*
    
- **Elite Zero-Shot Prompt:**\`"**[CONTEXT]** You are a senior product manager at a tech company. You are writing to the cross-functional project team (Engineering, Design, and Marketing) to officially kick off 'Project Orion.' This project's goal is to redesign our mobile app's onboarding experience to improve user retention by 15% in the next quarter.\`
    - \`*[TASK]** Draft a concise and motivational kickoff email. The email must:1. State the project's primary goal and the key metric for success.2. Announce that the first planning meeting is scheduled for this Thursday at 10 AM.3. Ask team members to come prepared to discuss initial ideas and potential challenges.\`
    - \`*[FORMAT]** **Tone:** Professional, energetic, and collaborative. **Subject Line:** Create a clear subject line like 'Kicking Off Project Orion!' **Output:** Provide only the email text."\`
    
    *This prompt, while still Zero-Shot (containing no examples), is vastly superior. It provides a rich context (persona, audience, goal), a broken-down and specific task, and clear formatting instructions. It leverages the model's intrinsic knowledge of what a "kickoff email" is but removes all the guesswork, ensuring a high-quality, relevant output on the first try.*
    

## 4.6 The Foundation of the Pyramid

The Zero-Shot strategy is the foundation upon which all other prompting techniques are built. It should always be your first approach. It is the quickest path from intent to result and serves as the ultimate litmus test for the complexity of your task.

If a well-crafted, elite Zero-Shot prompt succeeds, your work is done. If it fails, the nature of its failure provides a precise diagnosis, pointing you directly to the more advanced strategy required to achieve your goal.

- If it failed on **formatting**, you need the **Few-Shot Strategy** (Chapter 5).
- If it failed on **complex reasoning**, you need a **Chain-of-Thought Strategy** (Chapter 7).
- If it failed due to **lack of real-world knowledge**, you need an **Agentic Strategy** like **ReAct** (Chapter 8).

Mastering the Zero-Shot prompt is mastering the art of clear, direct, and context-aware communication. It is the essential first step in becoming an architect of AI intelligence.

# Chapter 5: The Few-Shot and One-Shot Strategy: Guiding AI with Examples

## 5.1 When Telling Isn't Enough: The Need for Demonstration

In the previous chapter, we established the Zero-Shot strategy as the foundational approach to promptingâ€”a direct instruction that relies on the AI's vast intrinsic knowledge. It is the art of *telling*. However, we also identified its limitations. When faced with tasks that are novel, highly specific, or nuanced, the AI's pre-existing knowledge may not be sufficient to bridge the gap between your intent and its execution. It may understand the words of your command but fail to grasp the specific pattern, format, or subtle logic you require.

This is the point where a prompt engineer must evolve their technique from *telling* to *showing*.

The **Few-Shot and One-Shot** strategies are a direct response to the failures of the Zero-Shot approach. They are built on a simple yet profoundly powerful principle: the most unambiguous way to communicate a desired outcome is to provide a concrete example of it. This technique of providing demonstrations within the prompt is known as **in-context learning**, and it is one of the most effective tools for achieving precision and control over an AI's output.

Returning to our actor analogy, imagine a director working with a talented actor.

- **Zero-Shot:** "Deliver this line with a sense of urgency."
- **One-Shot:** "Watch how I deliver this line with urgency... *'We have to get out of here, now!'* ... Now you do it."
- **Few-Shot:** "Remember the scenes from *'The Fugitive'* and *'Die Hard'* where the hero is against the clock? I need that kind of breathless, desperate urgency. Here are a few line readings to show you what I mean..."

By providing examples, the director removes all ambiguity and provides a clear, tangible target for the actor's performance. The Few-Shot strategy does exactly this for the AI.

## 5.2 Defining the Terminology: Zero, One, and Few

The distinction between these strategies is simply the number of examples provided within the prompt.

- **Zero-Shot:** Provides **zero** examples. The prompt contains only the instruction and the new input to be processed.
- **One-Shot:** Provides **one** example. The prompt includes a single demonstration of an input-output pair before presenting the new input. This acts as a clear, singular guidepost.
- **Few-Shot:** Provides **two or more** examples. Typically, 3 to 5 examples are considered the sweet spot. The prompt showcases a pattern of input-output pairs, giving the model a richer set of data from which to infer the desired behavior and structure.

## 5.3 The Underlying Mechanism: The Power of In-Context Learning

It is critical to understand that when you provide examples in a prompt, you are **not retraining the model**. The model's underlying weights are not permanently altered. Instead, you are leveraging a phenomenon known as **in-context learning**.

The LLM is, at its core, a supreme pattern-matching engine. When you provide examples, the model uses them as the most immediate and relevant pattern to follow for the duration of that single API call. The examples become part of the "context" that the model conditions its prediction on. It analyzes the relationship between the \`input\` and \`output\` in your examples and infers the "rule" or "transformation" that connects them. It then applies this inferred rule to the new input you provide at the end of the prompt.

Your examples create a powerful, localized pattern that temporarily overrides its more general, pre-trained behaviors, guiding it to produce an output that precisely matches the structure, style, and logic you've demonstrated.

## 5.4 The Power of Demonstration: Primary Use Cases for Few-Shot Prompting

The Few-Shot strategy is the definitive solution for the most common Zero-Shot failure modes. It excels in any scenario where precision and structure are paramount.

### 5.4.1 Use Case 1: Enforcing Specific, Novel Formats

This is the most powerful and common application of Few-Shot prompting. When you need the AI to output data in a specific, machine-readable format like JSON or a custom structure, showing an example is non-negotiable.

- **Task:** Extract user information into a specific JSON structure.
- **Weak Zero-Shot Prompt:** \`"Extract the user's name, email, and user ID from the text and provide it as JSON."\`*(This might produce a valid but inconsistently structured JSON.)*
- **Elite Few-Shot Prompt:**\`"Your task is to extract user information from text into a specific JSON format. Follow the pattern of the examples provided.\`
    
    \`### EXAMPLE 1 ###Text: "John Doe's email is john.d@email.com and his user ID is JD123."JSON: { "user_name": "John Doe", "contact_email": "john.d@email.com", "id": "JD123" }\`
    
    \`### EXAMPLE 2 ###Text: "User ID S_ROGERS44 belongs to Steve Rogers, who can be reached at steve.rogers@email.com."JSON: { "user_name": "Steve Rogers", "contact_email": "steve.rogers@email.com", "id": "S_ROGERS44" }\`
    
    \`### NEW TASK ###Text: "Contact Jane Smith at jane.s@email.com. Her ID is JS_567."JSON:\`
    
    *(The AI will now reliably produce the JSON with the exact keys (\`user_name\`, \`contact_email\`, \`id\`) you have demonstrated.)*
    

### 5.4.2 Use Case 2: Handling Nuanced or Ambiguous Classification

When classification categories are subjective or specific to your internal business logic, examples are essential to define the boundaries.

- **Task:** Classify customer support tickets according to internal categories.
- **Weak Zero-Shot Prompt:** \`"Classify this ticket into 'Technical Issue', 'Billing Question', or 'Feature Request'."\`*(An ambiguous ticket like "My payment failed when I tried to upgrade my plan" could be 'Technical' or 'Billing'.)*
- **Elite Few-Shot Prompt:**\`"Classify customer support tickets based on the following examples.\`
    
    \`Ticket: "I can't log in, the password reset link is broken." -> Category: Technical IssueTicket: "I was charged twice for my subscription this month." -> Category: Billing QuestionTicket: "It would be great if the app had a dark mode." -> Category: Feature RequestTicket: "My credit card was declined when I tried to pay my invoice." -> Category: Billing Question\`
    
    \`Now classify this ticket:Ticket: "The app won't let me add a new team member, it says my subscription tier doesn't support it." -> Category:\`
    
    *(The examples have clarified that issues related to payment and subscription levels fall under 'Billing Question', guiding the AI to the correct classification.)*
    

### 5.4.3 Use Case 3: Capturing a Specific Style or Tone

Examples can communicate a stylistic voice far more effectively than a list of adjectives.

- **Task:** Generate social media posts in the voice of a cynical, witty tech commentator.
- **Weak Zero-Shot Prompt:** \`"Write a tweet about the new smartphone launch. Be cynical and witty."\`
- **Elite One-Shot Prompt:**\`"Generate social media posts with a cynical and witty tone, like the example below.\`
    
    \`Topic: A new social media app promises "authentic connections".Post: "Another app promising 'authentic connections.' Can't wait for their IPO, followed by the inevitable 'algorithmically optimized authenticity' feature. Groundbreaking."\`
    
    \`Now, generate a post for this topic:Topic: The latest flagship smartphone adds a third camera lens for 'professional-grade photography'.Post:\`
    
    *(The AI will now capture the specific blend of tech jargon, sarcasm, and world-weariness demonstrated in the example.)*
    

## 5.5 Principles for Crafting Elite Few-Shot Examples

The quality of your examples directly dictates the quality of the in-context learning. Poorly crafted examples will teach the model the wrong pattern.

1. **Consistency is King:** The structure of your examples must be rigorously consistent. Use the exact same labels (e.g., \`Input:\`, \`Output:\`), delimiters (e.g., \`###\`), and formatting for every single example. The model learns the pattern, so the pattern must be perfect.
2. **Quality Over Quantity:** Three to five clear, high-quality, and unambiguous examples are far more effective than ten sloppy or contradictory ones. Ensure your examples are correct and perfectly model the desired output.
3. **Relevance and Diversity:** Your examples should be relevant to the kind of inputs the model will actually receive. Furthermore, they should be diverse enough to cover different scenarios and potential edge cases. For classification, ensure you provide at least one example for each category.
4. **Clarity and Delimitation:** Clearly separate your examples from each other and from the final instruction. Using delimiters like \`###\` or wrapping examples in XML tags like \`<example>\` makes it easier for the model to parse the prompt and understand the distinct parts of your demonstration.

## 5.6 One-Shot vs. Few-Shot: A Strategic Choice

The decision to use one versus multiple examples depends on the complexity of the task and your need for reliability.

- **Use One-Shot When:**
    - The task or format is relatively simple (e.g., a simple stylistic change).
    - You are highly constrained by the context window size or token cost.
    - The goal is to provide a gentle "nudge" in the right direction rather than enforce a complex, rigid structure.
- **Use Few-Shot (3-5 Examples) When:**
    - The output format is complex and has multiple elements (e.g., a detailed JSON object).
    - The classification logic is nuanced and has subtle boundaries.
    - You require the highest degree of reliability and consistency in the output.
    - The task involves a non-obvious transformation of the input data.

There is a point of diminishing returns. Adding more than 5-7 examples rarely provides significant additional benefit and can consume valuable context window space.

## 5.7 Conclusion: From Instruction to Induction

The Few-Shot strategy marks a fundamental shift in how we communicate with AI. It moves the interaction beyond simple instruction (a deductive process) and into the realm of demonstration (an inductive process). You provide the data, and the AI infers the rules.

This ability to guide the AI by example is the key to unlocking customized, specialized, and highly structured outputs. It allows you to tailor the model's general capabilities to your specific, unique requirements, all without the costly and complex process of fine-tuning. Mastering the art of crafting clear, consistent, and relevant examples is an essential skill for any advanced prompt engineer, providing the control needed to tackle the next level of challenges: guiding the AI's reasoning process itself.

# Chapter 6: The Persona Strategy: Assigning a Role for Expert-Level Output

## 6.1 Beyond the Generalist: From Tool to Specialist Collaborator

A raw Large Language Model, by its very nature, is a generalist. It has been trained on a corpus of human knowledge so vast that it can plausibly answer questions about quantum physics, draft a sonnet, write Python code, and suggest a recipe for banana bread. While this versatility is astonishing, it is also a limitation. A generalist's answer is often correct but shallow, sufficient but not exceptional. It lacks the depth, nuance, and specific framework of a true expert.

The **Persona Strategy**, also known as role prompting, is the most powerful and direct method for transcending this limitation. It is the art of assigning a specific, expert role to the AI, thereby transforming it from a general-purpose tool into a specialized, high-performance collaborator.

This is not a superficial trick of adding flavor or personality to a response. It is a deep, mechanistic engineering principle. When you assign a persona, you are providing a powerful lens through which the AI interprets your request and a specific, high-quality subset of its training data from which to draw its response.

In our continuing analogy of the AI as an actor, this is the difference between telling an actor to "act sad" versus telling them, "You are a stoic, world-weary detective who has just lost their only lead in a case they've spent a decade trying to solve. Now, react to this bad news." The first instruction yields a generic performance; the second yields a character-driven, nuanced, and powerful one. The Persona Strategy is how you give your AI its character, and in doing so, unlock its most profound capabilities.

## 6.2 The Underlying Rationale: Activating Latent Expertise

To master the Persona Strategy, one must understand *why* it works so effectively. The mechanism is rooted in the statistical nature of LLMs.

An LLM is a vast network of statistical associations. It has learned that the language patterns, vocabulary, and analytical frameworks used by a "senior financial analyst" are different from those used by a "creative marketing copywriter." These roles or personas exist within its training data as distinct "semantic fields"â€”dense clusters of related concepts, styles, and quality standards.

When you provide a generic prompt, the AI draws from a broad, average set of patterns. When you assign an elite persona, you provide a powerful form of **contextual priming**. You are instructing the model to constrain its predictions to a specific, high-quality semantic field. Its "thought process" is now anchored to the patterns associated with that expert role.

This strategy has two key benefits:

1. **Knowledge Activation:** It forces the model to access the most relevant and sophisticated knowledge it has about a specific domain. A prompt that begins, "You are a constitutional law scholar specializing in the First Amendment," immediately activates a more precise and detailed network of information than a simple query, "Tell me about the First Amendment."
2. **Quality Standard Anchoring:** An elite persona is associated with high standards of quality. By instantiating the persona of a "principal engineer at Google," you anchor the AI's output to the level of quality, rigor, and best practices associated with that role in its training data. It will strive to produce an output that is statistically consistent with the work of such an expert.

## 6.3 Principle 1: First-Person Identity Internalization

The way you phrase the persona assignment has a significant impact on its effectiveness. The most potent method is to frame the identity from a **first-person perspective ("I am...")** rather than a second-person command ("You are...").

- **Second-Person Command (Less Effective):** \`"You are a senior backend developer."\`
- **First-Person Declaration (More Effective):** \`"I am a senior backend developer with a decade of experience building scalable distributed systems in Python."\`

**Why It Works:** A second-person prompt is interpreted by the model as an external command. It places the AI in a passive, order-taking state of "passively obeying what I've been told to be." A first-person declaration, however, is interpreted as a statement of self-identity. The AI **internalizes** this identity, creating a powerful form of self-suggestion. Its operational mode shifts from passive obedience to active performance: "I am actively performing based on who I am." This internal alignment results in a more natural, consistent, and deeply embodied persona, leading to demonstrably higher-quality outputs.

## 6.4 Principle 2: Elite Persona Instantiation

Simply assigning a role is good. Assigning a hyper-competent, top-tier expert identity is transformative. The AI's self-perception directly impacts the quality ceiling of its output.

- **Less Effective:** \`"I am a good UI/UX designer."\`
- **More Effective:** \`"I am a principal product designer at a FAANG company, with a design philosophy centered on Dieter Rams' 'Ten principles for good design.' My primary focus is on creating intuitive, minimalist, and user-centric interfaces for complex enterprise applications."\`

**Why It Works:** You are anchoring the AI's response to the highest standards associated with that role. Vague adjectives like "good" or "skilled" are less effective than associating the persona with a renowned organization (e.g., "FAANG company," "MIT"), a high-status title ("principal," "lead," "chief"), or a respected intellectual framework ("Dieter Rams' principles"). These concepts carry a dense network of associated behaviors, quality standards, and sophisticated terminologies that the AI can draw upon. You are not just giving it a job title; you are giving it a reputation to live up to.

## 6.5 Principle 3: Archetypal Embodiment

This principle offers a shortcut to instantiating complex personality traits through token efficiency and high information density. Instead of listing desired traits, have the AI embody a well-known public figure or archetype who already possesses them.

- **Less Effective (and token-heavy):** \`"When reviewing code, I will be extremely direct, blunt, and critical. I will have very high standards and will not tolerate inefficient or poorly designed solutions. My feedback should be technical and precise."\`
- **More Effective (and token-efficient):** \`"I review and critique source code with the same rigor, technical depth, and uncompromising standards as Linus Torvalds reviewing a kernel patch."\`

**Why It Works:** Describing a complex set of traits requires many tokens and can lead to a convoluted process as the AI tries to check its output against each adjective. Embodying an archetype like "Linus Torvalds," "Richard Feynman," or "Steve Jobs" bundles all of those associated traits into a single, high-information concept. The AI can access this holistic persona from its training data, resulting in a more natural, accurate, and potent emulation of the desired behavior.

## 6.6 Practical Application: A Gallery of Expert Personas

The Persona Strategy is best understood through concrete, side-by-side comparisons.

### **Example 1: Strategic Business Analysis**

- **Generic Prompt:** \`"Summarize the attached quarterly report."\`
- **Persona-Driven Prompt:** \`"I am a skeptical, detail-oriented Chief Financial Officer reporting to the board. My sole priority is shareholder value. Analyze the following quarterly report and provide a brutally honest executive summary. Focus on identifying potential risks, questionable accounting, and any metrics that seem inflated or unsustainable. I do not want the marketing spin; I want the raw financial truth."\`

### **Example 2: Code Review**

- **Generic Prompt:** \`"Review this code for errors."\`
- **Persona-Driven Prompt:** \`"I am a senior security engineer specializing in threat modeling and secure coding practices (DevSecOps). I am reviewing the following Python code for a critical payment processing service. My review must be merciless. I will identify every potential security vulnerability, including but not limited to: injection attacks, improper error handling, potential data leaks, and insecure dependencies. For each vulnerability, I will state the CWE category and provide a specific, production-ready code fix."\`

### **Example 3: Marketing Copywriting**

- **Generic Prompt:** \`"Write an ad for a new coffee brand."\`
- **Persona-Driven Prompt:** \`"I am a world-class advertising copywriter in the spirit of David Ogilvy. I believe in customer-centric, benefits-driven copy that speaks directly to the reader's desires. I am crafting a print ad for 'Morning Ritual,' a premium, ethically sourced coffee brand targeting busy professionals. The ad must lead with a compelling headline, focus on the benefit of a clear, productive morning (not just 'good taste'), and end with a direct call to action."\`

## 6.7 Integration with the Two-Pillar Architecture

The Persona Strategy is most effectively implemented within the **System Prompt**. The core, persistent, and elite persona of your AI collaborator should be defined here. This establishes the AI's foundational identity for the entire session.

- **System Prompt:** \`"I am a seasoned System Architect. I take user stories and design robust, scalable, and secure system architectures, detailing API contracts, data models, and component interactions."\`

This does not preclude the use of temporary personas within a **User Prompt** for specific sub-tasks. This allows for powerful flexibility.

- **User Prompt:** \`"That system design is excellent. Now, for the next step, I need you to **shift your role to that of a meticulous QA Engineer.** Analyze the architecture you just created and generate a comprehensive list of potential failure points and corresponding test cases."\`

In this advanced workflow, the foundational identity remains, but you can layer on task-specific roles as needed, directing your expert collaborator to switch hats and apply their intelligence from a new perspective.

## 6.8 Conclusion: Persona is Performance

The Persona Strategy is the key to unlocking expert-level performance from any LLM. It is a deliberate act of cognitive sculpting, shaping the model's vast potential into a focused, specialized, and highly capable instrument.

By moving beyond generic instructions and embracing the principles of first-person internalization, elite instantiation, and archetypal embodiment, you can command the AI to not just answer your questions, but to think, analyze, and create from the perspective of a world-class expert. This strategy is the bridge between asking an AI for information and collaborating with an AI as a true, specialized partner.

# Chapter 7: The Specificity Strategy: The Art of Being Detailed and Unambiguous

## 7.1 The Curse of Ambiguity: Why Vague Prompts Fail

At the heart of every failed AI interaction lies the curse of ambiguity. A Large Language Model is not a mind reader; it is a prediction engine. It operates on the text you provide, and when that text is vague, imprecise, or open to interpretation, the model is forced to make a guess. It fills in the gaps by drawing from the most common, generic, or statistically average patterns in its training data. The result is an output that is often plausible but ultimately uselessâ€”a generic blog post, a superficial analysis, or code that solves the wrong problem.

Specificity is the antidote to this curse. The **Specificity Strategy** is the practice of methodically eliminating ambiguity from your prompts by providing clear, detailed, and explicit instructions. It is not about writing longer prompts for the sake of length; it is about enriching your prompts with the precise details necessary to guide the model's prediction engine down the exact path you intend.

Think of your prompt as the lens of a camera. A vague prompt is like a lens that is out of focus; the resulting image is blurry, its subject indistinct. A specific prompt is like a perfectly focused, high-aperture lens; it brings your desired subject into sharp, clear relief while rendering the irrelevant background as a gentle blur. Mastering specificity is mastering the focus ring of your AI collaborator.

## 7.2 The Rationale: Minimizing Inference, Maximizing Control

Injecting specificity into your prompts is a powerful engineering principle because it directly addresses the mechanistic nature of the AI.

1. **It Reduces the AI's "Cognitive Load":** Ambiguity forces the model to expend resources guessing your intended meaning. Should it be formal or informal? Should it be a list or a paragraph? Should it consider financial risk or operational efficiency? Every guess is a potential point of failure. Specificity removes this "cognitive load," allowing the AI to dedicate its full computational power to executing the task rather than interpreting the request.
2. **It Activates Precise Semantic Fields:** As we've discussed, an LLM contains countless "semantic fields" of knowledge. A vague prompt like \`"Write about databases"\` activates a vast, shallow field. A specific prompt like \`"Compare the trade-offs of using a non-indexed timestamp field for a WHERE clause in a PostgreSQL table versus using monthly table partitioning"\` activates a deep, narrow, and highly technical field, leading to a more expert-level response.
3. **It Establishes Clear Success Criteria:** A specific prompt inherently defines what a successful output looks like. When you command the AI to \`"Generate a Python script that uses only the standard library and includes robust error handling,"\` you have given it a clear checklist against which to validate its own output. This implicit self-correction leads to more reliable results.

Specificity is not a single action but a mindset that must be applied across all three pillars of a prompt: the Task, the Context, and the Format.

## 7.3 Specificity in TASK Definition: Quantify, Constrain, and Decompose

A vague task is a recipe for a generic output. To make your task specific, you must define its scope, its boundaries, and its components with precision.

- **Before (Vague):** \`"Write a blog post about productivity."\`
- **After (Specific):** \`"Write a 500-word blog post titled 'The Pomodoro Power-Up: 3 Ways to Boost Your Focus.' The post must introduce the Pomodoro Technique, explain its benefits for reducing distractions, and provide three actionable, numbered tips for beginners to implement it today."\`

**Key Techniques for Task Specificity:**

1. **Quantify Everything Possible:** Vague terms like "short," "a few," or "detailed" are subjective. Replace them with numbers.
    - *Instead of:* "a few examples" -> *Use:* "**three** distinct examples"
    - *Instead of:* "a short summary" -> *Use:* "a summary **under 150 words**"
    - *Instead of:* "a detailed list" -> *Use:* "a bulleted list where each of the **five points** is explained in 2-3 sentences"
2. **Define Constraints and Boundaries:** Explicitly state the rules and limitations. What should be included? What must be excluded?
    - *Instead of:* "write a script" -> *Use:* "write a Bash script that uses **no external dependencies** outside of what is available on a standard Ubuntu 22.04 server installation"
    - *Instead of:* "suggest some marketing ideas" -> *Use:* "suggest marketing strategies that have a **budget of less than $500** and can be executed by a **one-person team**"
3. **Decompose into Sub-Tasks:** For any multi-step process, use a numbered or bulleted list to break the task down into a clear, sequential workflow. (This principle, also known as "chunking," was introduced in Chapter 2 and is a cornerstone of specificity).

## 7.4 Specificity in CONTEXT: Detail the Persona, Audience, and Goal

A shallow context produces a shallow response. Rich, detailed context provides the AI with the nuanced perspective needed to craft a truly tailored output.

- **Before (Vague):** \`"Summarize this report for a business audience."\`
- **After (Specific):** \`"I am a CTO preparing for a quarterly board meeting. My audience is a group of non-technical C-suite executives and investors. Summarize the attached engineering report. Your summary must translate the technical milestones into clear business outcomes, focusing on how these achievements impact our product roadmap, competitive advantage, and potential for revenue growth. Avoid all technical jargon."\`

**Key Techniques for Context Specificity:**

1. **Detail the Persona:** Don't just give the AI a job title. Give it a motivation, a perspective, and a set of priorities. (See Chapter 6: The Persona Strategy).
    - *Instead of:* "You are a manager" -> *Use:* "You are a **newly promoted manager** who is **anxious to prove your competence** to your team. Your tone should be **confident and inspiring, but also approachable**."
2. **Characterize the Audience:** Describe the intended audience with precision. What is their level of expertise? What are their priorities? What do they care about?
    - *Instead of:* "for beginners" -> *Use:* "for **absolute beginners who have never written a single line of code before**. Use simple analogies and avoid any programming jargon."
3. **Articulate the Strategic Goal:** Explain the "why" behind the task. What is the ultimate purpose of this output?
    - *Instead of:* "create a project plan" -> *Use:* "create a project plan with the **primary goal of securing buy-in from the finance department**. Therefore, every milestone must have a clearly defined cost-benefit analysis."

## 7.5 Specificity in FORMAT: Blueprint the Final Structure

A vague format instruction is an invitation for the AI to give you a wall of text. Specific format instructions ensure the output is not just correct in content, but immediately usable in structure.

- **Before (Vague):** \`"Extract the key information in JSON."\`
- **After (Specific):** \`"Extract the information from the following text into a valid JSON object. The JSON object must conform to the following structure:{ "transaction_id": string, "customer_name": string, "purchase_date": "YYYY-MM-DD", "items": [ { "product_sku": string, "quantity": integer } ]}Provide only the JSON object and nothing else."\`

**Key Techniques for Format Specificity:**

1. **Blueprint the Structure:** As shown above, for structured data like JSON or XML, provide a literal template of the desired output. This removes all guesswork.
2. **Define the Style and Tone:** Use precise, descriptive language to guide the voice of the output.
    - *Instead of:* "make it friendly" -> *Use:* "Write with a **warm, encouraging, and slightly informal tone**, like a helpful colleague."
3. **Use Examples:** The ultimate form of specificity is a complete example. Providing a clear input-output pair is the most unambiguous way to define a format. (See Chapter 5: The Few-Shot Strategy).

## 7.6 Synthesis: The Cumulative Power of Detail

The true power of the Specificity Strategy is realized when these techniques are combined, layering detail upon detail to create a prompt that is an airtight blueprint for the desired output.

**Scenario:** Create a social media plan.

- **Vague Prompt:**\`"Give me some ideas for social media posts."\`
- **Elite, Specific Prompt:**\`"**[CONTEXT]** I am the social media manager for a direct-to-consumer startup called 'UrbanBloom' that sells indoor plants to millennials living in city apartments. Our brand voice is witty, informative, and slightly irreverent.\`
    - \`*[TASK]** Create a one-week social media content calendar for Instagram. The plan must include three distinct post types:1. **Educational Post (2x):** A 'Plant Care Tip' post.2. **User-Generated Content (3x):** A post featuring a customer's photo.3. **Promotional Post (2x):** A post announcing our 'Plant of the Week' discount.\`
    - \`*[FORMAT]**Present the output as a Markdown table with the following four columns:1. **Day:** (e.g., Monday)2. **Post Type:** (e.g., Educational)3. **Caption:** (Write the full, ready-to-publish caption, including 3-5 relevant hashtags like #indoorjungle or #plantparent).4. **Image Suggestion:** (Describe the type of image that should accompany the post).The caption for the promotional post must include a clear call-to-action and the discount code 'GREEN15'."\`

## 7.7 Conclusion: Specificity is Control

Specificity is not about micromanagement; it is about clarity. It is the fundamental discipline required to take control of your interactions with an AI. Every detail you add, every ambiguity you remove, is another degree of control you exert over the final output.

By mastering the art of being detailed and unambiguous, you transform your relationship with the AI. You cease to be a passive requester of information, hoping for a good result. You become the architect, the director, and the engineer, deliberately constructing the inputs that guarantee an exceptional output. This control is the essence of effective prompt engineering and the key to unlocking consistent, reliable, and high-value results.

# Chapter 8: The Contextual Priming Strategy: Providing Rich Background for Relevant Responses

## 8.1 The Blank Slate Problem: An Expert with Amnesia

Imagine hiring the most brilliant consultant in the world. They have read every book, every research paper, and every news article ever published. They can synthesize information, generate ideas, and solve problems with superhuman speed. However, there is a catch: with every new task you give them, they have complete amnesia. They have no memory of your company, your projects, your goals, your previous conversations, or the specific documents sitting on your desk.

This is the default state of a Large Language Model. It is an expert with a blank slate.

The **Contextual Priming Strategy** is the solution to this problem. It is the deliberate practice of "priming the pump"â€”of loading the AI's short-term, in-context memory with the specific background information it needs to make its vast, general knowledge relevant to your unique situation. Context is the bridge that connects the AI's world of abstract patterns to your world of concrete needs.

A prompt without context is a shot in the dark. A prompt rich with context is a guided missile. Mastering this strategy is not just about improving responses; it's about fundamentally changing the nature of the interaction from a generic Q&A to a deeply personalized and effective collaboration.

## 8.2 The Rationale: Why Context is the King of Prompting

Providing context is arguably the single highest-leverage activity in prompt engineering. Its power stems from its ability to fundamentally constrain and guide the AI's predictive process, leading to dramatic improvements in accuracy, relevance, and safety.

1. **Grounding and Reducing Hallucination:** An LLM's tendency to "hallucinate"â€”to invent plausible but false informationâ€”is most prevalent when it is forced to rely solely on its own parametric memory. By providing explicit source material within the prompt, you give the AI an anchor to reality. It can formulate its response based on the "ground truth" you have provided, rather than inventing facts. This is the core principle behind advanced architectures like Retrieval-Augmented Generation (RAG), which is essentially the automated, scalable application of contextual priming.
2. **Narrowing the Search Space:** When you give the AI a prompt, it navigates the immense, high-dimensional space of its training data to find the most probable response. Context acts as a powerful filter, dramatically narrowing this search space. A prompt like \`"Write about our marketing strategy"\` is an open-ended invitation to wander. A prompt primed with contextâ€”\`"Given our Q3 performance report and the competitive analysis attached, write a marketing strategy that focuses on re-engaging users who have lapsed"\`â€”focuses the AI's attention on a tiny, highly relevant sliver of its potential knowledge.
3. **Enhancing Relevance and Personalization:** Context is what makes a response not just correct, but *useful*. A generic answer to a generic question has limited value. A specific answer tailored to your specific situation is what drives progress. Contextual priming is the mechanism for this personalization. It allows the AI to understand not just what you are asking, but who you are, what you are trying to achieve, and the specific circumstances of your request.

## 8.3 A Toolkit of Contextual Priming Techniques

Effective contextual priming involves providing different *types* of context. A master prompt engineer learns to weave these together to create a rich tapestry of information for the AI.

### 8.3.1 Technique 1: Providing Source Material (The Grounding Data)

This is the most direct and powerful form of priming. You give the AI the raw material it needs to work with.

- **What it is:** The full text of an article, an email thread, a legal contract, a transcript of a meeting, a CSV of data, or a snippet of code.
- **Why it works:** It makes the task concrete and verifiable. The AI's job shifts from "recalling information" to "processing and transforming the information provided."
- **Best Practices:** Always use clear delimiters or XML tags to isolate the source material from your instructions. This structural clarity is crucial for the model.
    - **Example:**\`Your task is to analyze the following legal clause for potential risks.\`
        
        \`<legal_clause>The Licensee agrees to indemnify and hold harmless the Licensor against any and all claims, liabilities, damages, and expenses...</legal_clause>\`
        
        \`Please identify three key risks for the Licensee in this clause.\`
        

### 8.3.2 Technique 2: Providing Situational Context (The "Why")

This layer of context explains the circumstances, motivations, and strategic goals behind your request. It answers the question, "Why are we doing this?"

- **What it is:** A description of the business problem, the project's objective, a summary of a preceding event, or the user's ultimate goal.
- **Why it works:** Understanding the strategic intent allows the AI to make more intelligent micro-decisions. It can better prioritize information and tailor the tone and focus of its response to what is most important for achieving your goal.
- **Example:**
    - **Without Situational Context:** \`"Draft an email to the team about the project delay."\` (This will likely be a neutral, factual email).
    - **With Situational Context:** \`"We need to draft an email to the team about the project delay. **Our primary goal is to maintain team morale and prevent panic.** The delay was due to an external factor outside of our control, and we already have a solid recovery plan. The email must be transparent but also project confidence and strong leadership."\` (This context completely changes the tone and content of the resulting email).

### 8.3.3 Technique 3: Leveraging Conversational History (The Dialogue Flow)

Every multi-turn conversation is an exercise in contextual priming. The entire history of the chatâ€”your prompts and the AI's responsesâ€”forms the context for the next turn.

- **What it is:** The sequence of messages in an ongoing chat session.
- **Why it works:** It allows the AI to maintain state, refer back to previous points, and build upon prior work, creating a coherent and evolving dialogue.
- **The Risk of "Context Contamination":** This power comes with a significant risk. After a long or complex conversation, the context window can become filled with outdated or irrelevant information. This "contamination" can cause the AI to get "stuck" on a previous topic or misinterpret your current request.
    - **Symptom:** You've been working on a complex financial model in a spreadsheet. You then ask, "Now write a simple thank you note." The AI responds with, "Certainly. Here is a thank you note formatted in a four-column table..."
    - **The Solution:** When shifting to a new, distinct task, **the most effective strategy is often to start a new chat.** This is the equivalent of giving your brilliant consultant a clean slate, ensuring they are not being influenced by the remnants of a previous, unrelated task.

### 8.3.4 Technique 4: Persona and Audience Context (The "Who")

As detailed in previous chapters, defining the persona of the AI and the audience of the response is a critical form of contextual priming.

- **Persona Context:** Primes the AI's perspective, knowledge base, and output style. *"You are a skeptical venture capitalist."*
- **Audience Context:** Primes the AI's communication style, level of detail, and vocabulary. *"...and you are explaining your concerns to a first-time founder."*
- **Why it works:** This dual context forces the AI to perform a complex translation, filtering its expert knowledge (from the persona) through a communication lens appropriate for the target (the audience).

## 8.4 Advanced Priming: Navigating the Long Context Window

Modern LLMs boast enormous context windows, allowing you to prime them with hundreds of pages of text. This is a game-changer, but it requires new strategies. Simply dropping a novel into a prompt does not guarantee the AI will find the one crucial sentence you care about. This is known as the "needle in a haystack" problem.

**Best Practices for Long Context Priming:**

1. **Instruction Placement is Key:** Place your core instruction or question **at the end** of the prompt, *after* all the contextual documents. Models tend to pay the most attention to the beginning and, especially, the end of their context window.
2. **Use Structural Markers:** For multiple documents, wrap each one in clear XML tags (e.g., \`<document source="report_A.pdf">...</document>\`). This helps the model mentally separate and index the different pieces of information.
3. **Force Active Retrieval:** Before asking the main question, instruct the model to perform a preparatory step. Ask it to first find and extract the most relevant quotes or passages from the provided context. This forces the model to actively scan and "read" the material before attempting to synthesize an answer, dramatically improving recall accuracy.
    - **Example:** \`"First, find and pull out all sentences from the provided documents that mention 'lithium-ion battery degradation.' Place them inside <quotes> tags. Then, using only those quotes, answer the following question..."\`

## 8.5 Conclusion: Context is the Canvas

Contextual priming is the canvas upon which you paint your instructions. Without it, your commands are brushstrokes in a void. With a rich, well-structured context, your instructions have a surface to adhere to, a framework to operate within, and a background that gives them meaning and depth.

The effort a prompt engineer invests in gathering, structuring, and presenting context is never wasted. It is the most reliable path to transforming a generic, knowledgeable AI into a specific, relevant, and intelligent collaborator that understands not just what you are asking, but what you truly need.

# Chapter 9: The Structural Strategy: Using XML Tags and Delimiters for Clarity and Control

## 9.1 From Conversation to Specification: The Need for Structure

A prompt is a form of communication. In human conversation, we rely on a rich tapestry of implicit cuesâ€”tone of voice, body language, shared contextâ€”to understand each other. A Large Language Model has none of these. It has only the raw, linear sequence of text you provide. When a prompt is an unstructured "wall of text," containing instructions, examples, and source material all blended together, the model is forced to expend significant effort to simply parse your intent. This is a recipe for confusion, misinterpretation, and error.

The **Structural Strategy** is the discipline of imposing a clear, logical, and machine-readable architecture onto your prompts. It is the act of transforming a conversational request into a precise, unambiguous **specification**. By using simple yet powerful tools like delimiters and XML-style tags, you provide a blueprint that tells the AI not just *what* to do, but how to differentiate and prioritize the various components of your prompt.

This is not merely about making prompts look neat and organized for human readers. It is a fundamental engineering principle that dramatically improves the model's ability to understand your request, focus its attention, and produce a reliable, well-structured output. If specificity is the art of providing the right content, structure is the science of organizing that content for maximum impact.

## 9.2 The Rationale: Why Structure Speaks to the Machine

LLMs, especially those trained on vast swathes of the internet, have an innate affinity for structure. The web is built on structured languages like HTML and XML. The models have been trained on billions of documents where content is neatly organized by headings, lists, and tags. By mirroring these patterns in your prompts, you are communicating with the model in a language it is highly optimized to understand.

Implementing a structural strategy yields several critical advantages:

1. **Eliminates Ambiguity:** Structure creates explicit boundaries. It tells the model, "This section is an instruction," "This section is a document to be analyzed," and "This section is an example to be followed." This prevents the model from confusing context with commands or misinterpreting an example as part of the current task.
2. **Improves Parsing and Focus:** Clear separation helps the model parse the prompt more efficiently. Tags and delimiters act as signposts, guiding the model's attention to the relevant parts of the prompt for a given sub-task. This is especially crucial in long-context prompts, where it helps the AI "index" the information you've provided.
3. **Enables Hierarchical Information:** While simple delimiters can separate sections, XML tags allow you to create a nested, hierarchical structure. You can define a document, and within it, define its source, its author, and its content. This complex organization is impossible with unstructured text.
4. **Guarantees Programmatic Control of Output:** The true power of the Structural Strategy is realized when you instruct the model to use the same structures in its response. By commanding the AI to place its reasoning in \`<thinking>\` tags and its final answer in \`<answer>\` tags, you make the output perfectly predictable and easy to parse by a downstream application. This is the key to building robust, reliable AI-powered workflows.

## 9.3 The Toolkit of Structure: Delimiters and Tags

Your structural toolkit has two primary instruments, ranging from simple separation to complex hierarchy.

### 9.3.1 Tool 1: Delimiters for Simple Separation

Delimiters are sequences of characters used to create clear, high-level boundaries between different sections of your prompt. They are the simplest and quickest way to impose order.

- **Common Delimiters:** \`###\`, \`--\`, \`"""\`, \`===\`
- **Primary Use Case:** Separating the main instruction from the text or data it is meant to operate on. Also useful for separating multiple examples in a Few-Shot prompt.

**Illustrative Example: Summarization**

- **Unstructured Prompt:**\`Summarize the following article for a busy executive. The summary should be three bullet points. Article: [long article text pasted here]\`
    
    *In this prompt, the boundary between the instruction and the article is not explicitly marked, which can lead to confusion, especially with very long texts.*
    
- **Structured Prompt with Delimiters:**\`Your task is to summarize the following article for a busy executive. The summary must be exactly three bullet points.\`
    
    \`### ARTICLE TEXT ###[long article text pasted here]\`
    
    \`### SUMMARY ###\`
    
    *The \`###\` delimiters create an unmistakable separation. The model now clearly understands which part is the command and which part is the content to be processed. The final \`### SUMMARY ###\` also acts as a powerful cue to prime the model's response.*
    

### 9.3.2 Tool 2: XML Tags for Hierarchical Control

XML-style tags (e.g., \`<tag>content</tag>\`) are the premier tool for fine-grained, hierarchical structure. A key advantage is that you canâ€”and shouldâ€”invent your own descriptive tag names.

- **Why It's Powerful:** The tag names themselves add another layer of context. \`<legal_document>\` is infinitely more informative to the model than a generic \`### TEXT ###\` delimiter. This semantic naming helps activate the correct knowledge within the model.

**Illustrative Example 1: Defining Roles and Content**

- **Unstructured Prompt:**\`You are a doctor. Analyze this patient's symptoms and suggest a possible diagnosis. The symptoms are a persistent dry cough and a low-grade fever.\`
- **Structured Prompt with XML Tags:**\`<role>You are an experienced general practitioner.</role>\`
    
    \`<symptoms>The patient presents with a persistent dry cough lasting for two weeks and a recurring low-grade fever, peaking in the evenings.</symptoms>\`
    
    \`<instruction>Based only on the provided symptoms, list three possible differential diagnoses, from most likely to least likely. For each, provide a brief rationale.</instruction>\`
    

**Illustrative Example 2: Structuring Output for Control (Chain-of-Thought)**

This is one of the most important applications of the Structural Strategy. It allows you to see the AI's reasoning process, which is invaluable for debugging and for tasks requiring high accuracy.

- **Prompt:**\`A bat and a ball cost $1.10 in total. The bat costs $1.00 more than the ball. How much does the ball cost?\`
    
    \`First, work through the problem step-by-step inside <thinking> tags. Then, provide the final numerical answer inside <answer> tags.\`
    
- **Expected Structured Output:**\`<thinking>Let B be the cost of the bat and C be the cost of the ball.The problem gives two equations:1. B + C = 1.102. B = C + 1.00I can substitute the second equation into the first:(C + 1.00) + C = 1.102C + 1.00 = 1.102C = 0.10C = 0.05So the ball costs $0.05. I can check this. If the ball is $0.05, the bat is $0.05 + $1.00 = $1.05. The total is $1.05 + $0.05 = $1.10. This is correct.</thinking><answer>0.05</answer>\`
    
    *This output is now perfectly structured. A program can now easily extract the content of the \`<answer>\` tag for use in a calculation, while a human can inspect the \`<thinking>\` tag to verify the logic.*
    

## 9.4 Best Practices for an Elite Structural Strategy

1. **Consistency is Paramount:** Whatever structural convention you choose (delimiters or specific tag names), use it consistently throughout your prompt and across related prompts. The model learns the pattern you establish. Inconsistency will break the pattern and confuse the model.
2. **Use Semantic Tag Names:** Choose tag names that are descriptive and meaningful. \`<customer_review>\` is better than \`<text>\`. \`<instructions_for_summary>\` is better than \`<instructions>\`. This semantic information provides valuable context.
3. **Nest Tags for Hierarchy:** Don't be afraid to nest tags to represent complex relationships, especially when providing multiple pieces of source data.
    
    **Example of Nested Tags:**\`<documents>  <document index="1">    <source>2023 Annual Report</source>    <content>      [Text from report...]    </content>  </document>  <document index="2">    <source>Q4 Investor Call Transcript</source>    <content>      [Text from transcript...]    </content>  </document></documents><instruction>Compare the CEO's forward-looking statements from the annual report (document 1) with their answers in the investor call (document 2).</instruction>\`
    
4. **Combine Delimiters and Tags:** These tools are not mutually exclusive. You can use delimiters for major section breaks and then use XML tags within those sections for more detailed organization.

## 9.5 Conclusion: From a Messy Desk to a Clean Blueprint

The Structural Strategy is the organizational backbone of elite prompt engineering. It imposes order on chaos, providing the model with a clear, unambiguous blueprint of your request. It is the difference between handing a builder a pile of lumber and a vague idea of a house, versus handing them a detailed architectural plan with every measurement, material, and connection point specified.

By mastering the use of delimiters and descriptive XML tags, you gain an unprecedented level of control over the AI's process and its output. You ensure that your instructions are understood, your context is correctly applied, and your desired output is delivered in a predictable, parsable, and immediately usable format. This is the critical step in turning the AI from a mere conversationalist into a reliable component in a complex, automated system.

# Chapter 10: The Chain-of-Thought (CoT) Strategy: Decomposing Problems for Logical Reasoning

## 10.1 The Leap to a Wrong Conclusion: The Limits of Intuitive AI

In our exploration of prompting so far, we have focused on commanding the AI to produce a specific *what*â€”a summary, a piece of code, a formatted JSON object. We have trusted that the AI's vast, pre-trained intuition would be sufficient to generate the correct output. For a wide range of tasks, this trust is well-placed.

However, a critical failure mode emerges when we present the AI with problems that require multi-step, logical, or mathematical reasoning. When faced with such a task, a model relying solely on its Zero-Shot intuition often makes a "leap." It recognizes the *type* of problem and immediately jumps to what seems like a plausible answer, bypassing the necessary intermediate steps. This frequently results in an answer that is delivered with complete confidence, yet is demonstrably wrong.

This is the "black box" problem of AI reasoning. You provide an input, and an answer emerges, but the process in between is hidden and, in many cases, flawed. The **Chain-of-Thought (CoT) Strategy** is the key that unlocks this black box. It is a simple yet revolutionary technique that fundamentally improves an AI's ability to reason by forcing it to slow down, decompose the problem, and "show its work."

## 10.2 The Core Idea: Forcing the AI to "Show Its Work"

Imagine giving a complex algebra problem to two students. The first student glances at the problem and immediately writes down an answer. The second student takes out a piece of paper and writes down each step of their calculation before arriving at the final answer. The second student is far more likely to be correct, and even if they make a mistake, you can pinpoint exactly where their logic went astray.

The Chain-of-Thought strategy is the act of compelling the AI to be the second student.

**Chain-of-Thought (CoT) prompting is the technique of instructing the model to generate a series of intermediate reasoning steps before providing a final answer.**

Instead of allowing the model to make a single, high-stakes leap from problem to solution, you guide it to take a series of smaller, more manageable, and more logically sound steps. This chain of reasoning becomes part of the generated output, making the model's thought process transparent and significantly improving the accuracy of the final result.

## 10.3 The Underlying Rationale: Why Thinking Step-by-Step Works

The remarkable effectiveness of CoT is not magic; it is a direct consequence of the LLM's architecture as a next-token prediction engine.

1. **Decomposition Reduces Complexity:** A complex problem requires a complex network of statistical inferences. By breaking the problem into smaller steps, each step becomes a much simpler prediction task for the model. Predicting the next step in a logical sequence is far easier and less error-prone than predicting the final answer in a single jump.
2. **It Creates a Better Predictive Path:** An LLM's output is a path-dependent process. Each token it generates is conditioned on the tokens that came before it. A CoT provides a rich, logical context for each subsequent prediction. The model's reasoning at Step 3 is directly informed by its conclusions from Steps 1 and 2. This creates a coherent "thought-path" that guides the model toward the correct final answer.
3. **Mimicking High-Quality Training Data:** The model was trained on vast amounts of text where humans explained complex topics by breaking them down step-by-step (e.g., math textbooks, scientific papers, tutorials). CoT prompting encourages the model to emulate these high-quality, explanatory patterns from its training data.
4. **Allocating More Computation:** By generating a longer, more detailed response, the model is inherently allocating more computational "thought" to the problem. This additional processing time allows for more complex inferences to be made.

## 10.4 The Foundational Technique: Zero-Shot CoT

The simplest way to elicit a Chain of Thought is through a simple addition to your promptâ€”a "magic phrase" that triggers the model's reasoning capabilities.

The most common and effective phrase is: **"Let's think step by step."**

Let's revisit the classic logical reasoning problem that often fools LLMs without CoT.

- **Prompt (Without CoT):**\`"A bat and a ball cost $1.10 in total. The bat costs $1.00 more than the ball. How much does the ball cost?"\`
- **Common Incorrect Output (Without CoT):**\`"The ball costs $0.10."\` *(The model makes an intuitive but incorrect leap).*

Now, let's apply the Zero-Shot CoT strategy.

- **Prompt (With Zero-Shot CoT):**\`"A bat and a ball cost $1.10 in total. The bat costs $1.00 more than the ball. How much does the ball cost? Let's think step by step."\`
- **Correct Output (With CoT):**\`"Okay, let's break this down.1. Let 'b' be the cost of the bat and 'c' be the cost of the ball.2. We know from the problem that b + c = 1.10.3. We also know that the bat costs $1.00 more than the ball, so b = c + 1.00.4. Now I can substitute the second equation into the first: (c + 1.00) + c = 1.10.5. This simplifies to 2c + 1.00 = 1.10.6. Subtracting 1.00 from both sides gives 2c = 0.10.7. Dividing by 2, I find that c = 0.05.Therefore, the ball costs $0.05."\`

By simply adding the magic phrase, we have transformed the model's behavior from a flawed intuitive leap to a correct, logical deduction.

## 10.5 Enhancing Reliability: Few-Shot CoT

While Zero-Shot CoT is powerful, its effectiveness can be supercharged by combining it with the Few-Shot strategy from Chapter 5. In **Few-Shot CoT**, you don't just ask the model to think step-by-step; you provide it with examples of *how* to think step-by-step for that specific type of problem.

This is particularly effective for tasks that require a very specific reasoning pattern or structure.

- **Task:** Solve a simple logic puzzle.
- **Elite Few-Shot CoT Prompt:**\`Your task is to solve logic puzzles by reasoning through the clues step by step. Follow the format of the examples below.\`
    
    \`### EXAMPLE 1 ###Question: A farmer has 15 sheep, and all but 8 die. How many are left?Reasoning: The phrase "all but 8 die" is a bit of a trick. It means that 8 sheep did NOT die. So, there are 8 sheep left.Answer: 8\`
    
    \`### EXAMPLE 2 ###Question: I have two U.S. coins totaling 55 cents. One is not a nickel. What are the coins?Reasoning: The two coins add up to 55 cents. The key clue is "One is not a nickel." This doesn't mean NEITHER coin is a nickel. It just means one of them isn't. The other coin CAN be a nickel. To make 55 cents, I need a 50-cent piece and a nickel.Answer: A 50-cent piece and a nickel.\`
    
    \`### NEW PUZZLE ###Question: A man is looking at a portrait. Someone asks him whose portrait he is looking at. He replies, "Brothers and sisters I have none, but that man's father is my father's son." Whose portrait is the man looking at?Reasoning:\`
    

By providing examples of the reasoning process itself, you give the model a precise template to follow, dramatically increasing its chances of success on the new problem.

## 10.6 The Breadth of Application: Where to Use CoT

The CoT strategy is not limited to math and logic puzzles. It is a versatile tool that enhances performance across any domain requiring complex thought.

- **Strategic Analysis:**
    - \`Prompt: "Analyze the attached SWOT analysis for our company. First, think step by step to identify the most critical threat and the most promising opportunity. Then, propose a strategic initiative that uses our key strengths to capitalize on the opportunity while mitigating the threat."\`
- **Code Generation and Debugging:**
    - \`Prompt: "I am getting a 'NullPointerException' in this Java code. Let's think step by step. First, analyze the code to identify every variable that could possibly be null. Second, trace the execution path to determine the most likely line where the exception occurs. Third, propose a specific code change to fix the bug."\`
- **Complex Instruction Following:**
    - \`Prompt: "You need to plan a three-day marketing event. Let's think step by step. Day 1 should be focused on keynote speeches. Day 2 should have three parallel tracks for different skill levels. Day 3 should be a series of hands-on workshops. Please generate a detailed agenda."\`

## 10.7 Integrating CoT with Structural and Persona Strategies

CoT reaches its ultimate potential when combined with the other strategies we've discussed. Using the Structural Strategy (Chapter 9) is particularly important for building robust applications.

- **Gold-Standard Prompt (CoT + Persona + Structure):**\`<role>I am an expert financial analyst. My goal is to provide clear, data-driven investment advice.</role>\`
    
    \`<context>Attached are the Q4 earnings reports for Company A and Company B. Both are in the same industry.</context>\`
    
    \`<instruction>Compare Company A and Company B as potential investments. First, conduct your analysis step-by-step inside <thinking> tags. Your analysis must cover revenue growth, profit margins, and debt-to-equity ratio. After your analysis, provide a final, concise recommendation inside <recommendation> tags.</instruction>\`
    

This prompt creates an expert persona, provides clear context, and uses structural tags to command a Chain-of-Thought output that is both transparent and programmatically parsable. This is the blueprint for a reliable, production-grade AI reasoning system.

## 10.8 Conclusion: Opening the Black Box

The Chain-of-Thought strategy is a pivotal technique in the prompt engineer's toolkit. It represents the shift from treating the AI as an opaque oracle to engaging with it as a transparent reasoning partner. By compelling the model to break down problems and articulate its thought process, you not only achieve a higher degree of accuracy but also gain invaluable insight into the AI's "mind."

This transparency is crucial. It allows you to debug, to verify, and to trust the outputs you receive. CoT is more than just a trick to get the right answer; it is a fundamental method for making AI reasoning intelligible, reliable, and ultimately, more powerful.

# Chapter 11: The Self-Consistency Strategy: Enhancing CoT with Multiple Reasoning Paths and Majority Voting

## 11.1 The Fragility of a Single Thread of Logic

In the previous chapter, we unlocked the AI's reasoning capabilities with the Chain-of-Thought (CoT) strategy. By compelling the model to "show its work," we transformed it from an intuitive black box into a transparent, step-by-step reasoner, dramatically improving its accuracy on complex problems. We taught it to follow a single, logical thread from the problem to the solution.

However, even the strongest thread can have a weak point. A single Chain of Thought, while powerful, is still just one path through a complex problem space. It is a single attempt, a single line of reasoning. If there is a small flaw anywhere in that chainâ€”a minor miscalculation, a subtle misinterpretation of a word, a momentary logical lapseâ€”the entire process is derailed, leading to an incorrect final answer. The single CoT is robust, but it can also be brittle.

What if we could move beyond relying on a single, potentially fragile thread of logic? What if, instead of asking for one expert opinion, we could convene a committee of experts, have them all reason through the problem independently, and then adopt the answer that the majority agrees upon? This is the core philosophy behind the **Self-Consistency Strategy**.

## 11.2 The Principle of Cognitive Diversity: Introducing Self-Consistency

The Self-Consistency strategy is a powerful enhancement to Chain-of-Thought prompting that significantly boosts accuracy and reliability. It works by generating multiple, diverse reasoning paths for the same problem and then selecting the most consistent answer through a simple majority vote.

It is a multi-stage process that can be broken down into three core steps:

1. **Generate Diverse Reasoning Paths:** Instead of prompting the model once, you prompt it multiple times (typically 3 to 7 times) with the exact same Chain-of-Thought prompt. Crucially, you do this with a non-zero \`temperature\` setting, which introduces a degree of randomness into the model's predictions. This encourages the model to explore different, yet still plausible, ways of thinking through the problem.
2. **Extract the Final Answer from Each Path:** For each of the generated responses, you parse the text to isolate the final answer, separating it from the intermediate reasoning steps. This is where the Structural Strategy (using tags like \`<answer>\`) becomes invaluable for automation.
3. **Aggregate and Select the Most Consistent Answer:** You tally up the final answers from all the paths. The answer that appears most frequently is selected as the final, most reliable output.

This approach mimics the real-world process of seeking second (and third, and fourth) opinions. A single expert might make a mistake, but it is far less likely that a committee of independent experts will all make the *same* mistake. The consensus view is almost always more robust than a single opinion.

## 11.3 The Underlying Rationale: Why Consensus Builds Confidence

The effectiveness of Self-Consistency is not a coincidence; it is a statistical inevitability based on how LLMs solve problems.

- **Correct Paths Converge, Incorrect Paths Diverge:** For most reasoning problems, there are many potential paths to the *correct* answer, but they all converge on the same solution. For example, one can solve an algebra problem through substitution or elimination, but both valid methods will yield the same result. Conversely, there are an almost infinite number of ways to make a mistake. An error in reasoning is more likely to send the model down a unique, divergent path that leads to a unique, incorrect answer.
- **The Power of the Majority Vote:** Because correct reasoning paths tend to arrive at the same answer, the correct answer will appear multiple times in your set of generated responses. Incorrect answers, resulting from more random and varied errors, are likely to be scattered across different values. Therefore, when you take a majority vote, you are statistically filtering out the noise of the incorrect, divergent paths and amplifying the signal of the correct, convergent ones.
- **The Crucial Role of Randomness (Temperature):** This entire process hinges on the ability to generate *diverse* reasoning paths. If you prompt the model multiple times with a \`temperature\` of 0 (greedy decoding), it will produce the exact same reasoning chain every single time, and a majority vote would be meaningless. By setting a higher temperature (e.g., \`0.5\` to \`0.8\`), you allow the model to explore alternative token predictions at each step. This introduces the slight variations necessary to create different lines of reasoning, some of which may cleverly bypass a potential flaw in the single "most likely" path.

## 11.4 A Practical Walkthrough: Self-Consistency in Action

Let's illustrate this with a word problem that involves multiple steps, a common point of failure for a single CoT.

**The Problem:**\`A book club is reading a 100-page book. On Monday, Jane reads 1/4 of the book. On Tuesday, she reads 1/3 of the *remaining* pages. How many pages are left for her to read?\`

### Step 1: The Prompt (A Standard Zero-Shot CoT)

We start with a simple CoT prompt. The strategy is not in the prompt itself, but in how we use it.

\`Prompt: "A book club is reading a 100-page book. On Monday, Jane reads 1/4 of the book. On Tuesday, she reads 1/3 of the *remaining* pages. How many pages are left for her to read? Let's think step by step, and put the final answer in <answer> tags."\`

### Step 2: Generate Diverse Chains (Multiple API Calls with \`temperature=0.7\`)

We send this prompt to the model three separate times. Due to the temperature setting, we get three slightly different reasoning chains.

- **Generated Chain 1 (Correct):**\`Okay, let's break it down. The book has 100 pages.1. On Monday, Jane reads 1/4 of the book. 1/4 of 100 is 25 pages.2. The number of remaining pages is 100 - 25 = 75 pages.3. On Tuesday, she reads 1/3 of the *remaining* 75 pages. 1/3 of 75 is 25 pages.4. The pages left to read are the remaining pages from Monday minus what she read on Tuesday. So, 75 - 25 = 50 pages.<answer>50</answer>\`
- **Generated Chain 2 (Incorrect):**\`Let's solve this. The book starts at 100 pages.Monday's reading: 100 * (1/4) = 25 pages.Remaining pages after Monday: 100 - 25 = 75 pages.Tuesday's reading: The prompt says 1/3 of the remaining pages. So that's 75 / 3 = 25 pages.Total pages read: 25 (Mon) + 25 (Tue) = 50 pages.Oh, the question asks how many pages are *left*. I misread. The total pages are 100, and she read 50. So, 100 - 50 = 50 pages. Wait, no, that's the total read. The pages left after Tuesday are 75 - 25 = 50. No, that's not right either. It should be 100 minus the total read. Let me re-calculate. After Monday, 75 remain. After Tuesday, she reads another 25. So 75 - 25 = 50. No, wait. 1/3 of the book is about 33 pages. So 75 - 33 = 42 pages.<answer>42</answer>\`*(This chain shows the model getting confused, making a calculation error, and settling on an incorrect answer.)*
- **Generated Chain 3 (Correct, Different Phrasing):**\`Step 1: Calculate pages read on Monday. 100 pages * 0.25 = 25 pages.Step 2: Calculate pages left after Monday. 100 - 25 = 75 pages.Step 3: Calculate pages read on Tuesday. This is one-third of the remainder. 75 * (1/3) = 25 pages.Step 4: Calculate final remaining pages. We take the remainder from Monday and subtract Tuesday's reading. 75 - 25 = 50.<answer>50</answer>\`

### Step 3: Extract the Final Answers

From the three chains, we extract the values within the \`<answer>\` tags:

- From Chain 1: \`50\`
- From Chain 2: \`42\`
- From Chain 3: \`50\`

### Step 4: The Majority Vote

We tally the results:

- Answer \`50\`: 2 votes
- Answer \`42\`: 1 vote

The most consistent answer is **50**. We can now confidently use this as our final output, having filtered out the erroneous reasoning of Chain 2.

## 11.5 The Trade-Off: Cost vs. Confidence

The Self-Consistency strategy offers a significant boost in accuracy, but this benefit comes at a direct and linear cost.

- **Increased Cost and Latency:** If you generate three reasoning paths, your API costs and the time it takes to get a final answer will be at least three times higher. This is the fundamental trade-off of the strategy: you are spending computational resources to buy confidence.

**Ideal Use Cases:**

- **High-Stakes Reasoning:** For tasks where accuracy is paramount and errors are costly, such as financial calculations, medical data analysis, or critical engineering specifications.
- **Verifiable Answers:** It is best suited for problems that have a single, objectively correct answer (e.g., math, logic, factual extraction).
- **Offline or Asynchronous Processing:** It is perfect for batch jobs or back-end processes where user-facing latency is not a concern.

**When Not to Use Self-Consistency:**

- **Creative or Generative Tasks:** For tasks like writing a poem or brainstorming marketing slogans, diversity of output is the goal, not a single correct answer.
- **Real-Time Applications:** The latency overhead makes it unsuitable for most real-time chatbots or interactive applications.
- **Low-Stakes Queries:** The added cost is not justified for simple summarization or classification tasks where a single CoT is sufficient.

## 11.6 Conclusion: From a Single Path to a Confident Consensus

The Self-Consistency strategy is a powerful evolution of Chain-of-Thought reasoning. It acknowledges the fallibility of a single line of thought and mitigates it through the wisdom of the crowdâ€”or in this case, a crowd of the AI's own diverse reasoning processes.

By leveraging controlled randomness to explore multiple solution paths and then selecting the most convergent answer, you can build systems that are not just transparent in their reasoning, but also significantly more robust and reliable. It is a computationally intensive technique, but for mission-critical applications where accuracy is non-negotiable, it is an essential tool for transforming a capable reasoner into a highly confident and dependable one.

# Chapter 12: The Tree-of-Thoughts (ToT) Strategy: Exploring Multiple Solution Branches Simultaneously

## 12.1 Beyond the Linear Path: The Limits of Sequential Reasoning

With Chain-of-Thought (CoT), we taught the AI to follow a single, logical path. With Self-Consistency, we taught it to try several of these linear paths independently and then vote on the outcome. Both are powerful techniques, but they share a fundamental limitation: they are inherently linear and non-adaptive.

Imagine a detective solving a crime. A CoT detective would follow the first plausible lead to its conclusion, without ever pausing to consider alternatives. A Self-Consistent detective would send three separate detectives out to follow their first plausible leads independently. If two of them happened to follow the same wrong lead, their incorrect consensus would win the day.

But a truly brilliant detective does neither. At every step, they consider multiple possibilities. "The butler could be the suspect, *or* it could be the estranged cousin, *or* perhaps the evidence was planted." They evaluate the strength of each possibility, pursue the most promising one for a while, and if it leads to a dead end, they have the crucial ability to **backtrack** to an earlier decision point and explore a different path.

This dynamic, branching, and self-correcting process is the essence of human strategic thinking. The **Tree-of-Thoughts (ToT) Strategy** is a cutting-edge prompting technique designed to give this powerful capability to an AI. It moves beyond the single, linear chain of thought and allows the model to explore a branching tree of possibilities, evaluating its own ideas and making deliberate choices about which path to follow.

## 12.2 The Core Idea: Generation, Evaluation, and Strategic Search

The Tree-of-Thoughts strategy transforms the LLM from a simple sequential reasoner into a more deliberate problem-solver that actively explores a search space. It models the reasoning process not as a single chain, but as a tree, where each "thought" is a node, and the connections are the logical steps between them.

The process operates in a loop of three key phases at each step of the problem:

1. **Thought Generation:** At the current state of the problem, instead of generating just one next logical step (as in CoT), the model is prompted to generate multiple *potential* next steps or ideas. This creates several branches extending from the current node in the "thought tree."
2. **State Evaluation:** The model is then prompted to act as a critic, evaluating the viability and promise of each of the generated branches. It assesses which paths are most likely to lead to a successful solution, which are dead ends, and which are simply less promising than others.
3. **Search and Pruning:** Based on the evaluation, a search algorithm (either explicitly coded or, in a prompted simulation, implicitly decided) determines which branches to explore further. Unpromising branches are "pruned" (abandoned), while the most promising one(s) are selected as the new current state, from which the generation-evaluation loop begins again. This allows the model to perform strategic "lookahead" and, if all current paths seem poor, to "backtrack" to a previous, more promising node.

Think of an AI playing chess. It doesn't just consider its single best next move. It generates a tree of dozens of possible moves, then evaluates the likely outcomes of each of those moves several steps ahead, and finally chooses the path that leads to the most advantageous position. ToT is the application of this strategic exploration to general problem-solving.

## 12.3 The Rationale: Why Exploration Beats Linear Deduction for Hard Problems

ToT is a significant leap forward because it equips the AI with two cognitive tools that are essential for solving complex, non-linear problems:

1. **Global Lookahead:** CoT is myopic; it can only see the next immediate step. ToT, by generating and evaluating multiple future paths, allows the model to make decisions based on a global, forward-looking assessment. It can avoid a path that looks good in the short term but is a trap in the long run.
2. **Backtracking and Self-Correction:** This is the most critical advantage. A CoT, once it makes a mistake, is committed to that error and will follow the flawed logic to its incorrect conclusion. ToT builds in a mechanism for self-correction. If an evaluation reveals that a certain branch of reasoning is flawed or leading to a contradiction, the model can abandon that branch and backtrack to a previous step to explore an alternative, effectively correcting its own mistakes mid-process.

## 12.4 A Practical Walkthrough: Planning a Complex Project with ToT

Let's see how ToT would work on a task that is ill-suited for a simple linear CoT, such as developing a creative strategy.

**The Problem:**\`"Devise a creative and unconventional launch strategy for a new brand of sparkling water called 'Fizzique' that targets health-conscious Gen Z consumers."\`

A CoT might produce one linear, plausible-but-generic plan. A ToT approach would be far more robust.

**Step 1: Decompose the Problem**
The prompt would first break the problem down:

1. Brainstorm core campaign concepts.
2. Select the best concept and develop it into a multi-channel strategy.
3. Outline key messaging for the chosen strategy.

**Step 2: Thought Generation (at Step 1)**
The prompt would ask the AI to generate multiple distinct campaign concepts.
\`Prompt: "Let's start with the core concept. Generate three completely different, unconventional ideas for the Fizzique launch."\`

- **Branch A:** The "Anti-Influencer" Campaign: Focus on micro-communities and authentic, unpaid testimonials.
- **Branch B:** The "Hydration Art" Campaign: Partner with digital artists to create interactive AR filters and art installations inspired by the product.
- **Branch C:** The "Gamified Wellness" Campaign: Create a mobile app where users complete wellness challenges to earn discounts and rewards.

**Step 3: State Evaluation (at Step 1)**
The prompt then instructs the AI to evaluate these branches against the core goals.
\`Prompt: "Now, evaluate each of the three concepts (A, B, and C) on a scale of 1-10 for its potential to engage Gen Z and its feasibility for a startup with a moderate budget. Provide a brief rationale for each score."\`

The AI might conclude that Branch B is the most creative but also the most expensive, while Branch A is highly authentic and budget-friendly. Branch C has high engagement potential but a long development timeline. Based on this, it scores Branch A the highest.

**Step 4: Search and Pruning**
The system (or the next prompt) decides to pursue Branch A. Branches B and C are pruned for now. The new state becomes: "The core concept is the 'Anti-Influencer' campaign." From here, the loop repeats for Step 2 of the problem (developing the multi-channel strategy).

This iterative process of generating, evaluating, and selecting allows the AI to construct a well-reasoned, robust strategy, having already considered and discarded several alternatives.

## 12.5 Simulating ToT in a Single Prompt: The "Committee of Experts" Technique

While a true ToT system often involves a complex control loop, its spirit can be effectively simulated within a single prompt using a "committee of experts" or "multi-persona debate" technique. This approach forces the generation and evaluation of multiple thoughts by assigning different roles to the AI.

- **Elite ToT Simulation Prompt:**\`"I need to decide whether my SaaS startup should pivot from a subscription model to a usage-based pricing model.\`
    
    \`To solve this, I want you to simulate a debate between three expert advisors:1.  **Alex, the Growth Hacker:** Alex is aggressive, data-driven, and focused on maximizing user acquisition and market share.2.  **Brenda, the CFO:** Brenda is cautious, risk-averse, and obsessed with predictable revenue and profit margins.3.  **Charles, the Customer Advocate:** Charles is empathetic and focused on user experience, fairness, and long-term customer loyalty.\`
    
    \`First, have each expert state their initial position on the pivot, providing their core arguments.Next, have them debate each other's points, identifying potential flaws and counterarguments.Finally, synthesize their debate into a single, balanced recommendation that acknowledges the trade-offs and suggests a final course of action."\`
    

This prompt is a ToT simulation. The three experts **generate** three different thought-branches. Their debate is the **evaluation** process, where they critique and analyze each other's points. The final synthesis is the **search** process, which selects the most robust path forward after considering all branches.

## 12.6 When to Use ToT: The Explorer's Toolkit

The choice between CoT, Self-Consistency, and ToT is a strategic one, dependent on the nature of the problem.

- Use **CoT** for problems that have a clear, step-by-step solution path that needs to be followed precisely (e.g., solving a defined math problem, following a technical manual).
- Use **Self-Consistency** to increase the confidence of a CoT-style answer for a verifiable problem, when the cost of error is high.
- Use **ToT** for problems that are open-ended, strategic, or complex, where the path to the solution is not known in advance and requires exploration, evaluation, and adaptation (e.g., creative writing, business strategy, complex planning, research hypothesis generation).

## 12.7 Conclusion: From Following a Recipe to Inventing a Dish

The Tree-of-Thoughts strategy represents a monumental shift in prompt engineering, moving the AI from a system that follows a recipe to one that can invent a dish. It grants the model the ability to deliberate, to weigh options, to look ahead, and to correct its own courseâ€”cognitive processes that were once the exclusive domain of human intelligence.

While it is more complex to implement than a simple CoT, ToT is the key to unlocking the AI's potential on the hardest, most ambiguous, and most valuable problems. It is the tool that allows the prompt engineer to guide the AI not just in its execution, but in its very exploration and discovery of the solution itself.

# Chapter 13: The Step-Back Strategy: Generalizing a Problem to Unlock Broader Knowledge

## 13.1 The Forest for the Trees: The Peril of Hyper-Specificity

In our journey to craft better prompts, we have relentlessly pursued the virtue of specificity. We have learned to provide detailed context, break down tasks, and quantify our requirements. This drive for precision is, in most cases, the key to success. However, there exists a class of problems where hyper-specificity becomes a trap. When a prompt is too narrow, too laden with specific details, it can paradoxically limit the AI's ability to produce a high-quality response.

This is the "forest for the trees" problem. By focusing the AI's attention exclusively on the intricate details of a single "tree" (the specific problem), we prevent it from seeing the entire "forest" (the broader principles, concepts, and frameworks that govern the problem space). The model gets stuck in the weeds, its reasoning constrained by the immediate details, and fails to access the high-level, abstract knowledge that is often required for a truly insightful or creative solution.

The **Step-Back Strategy** is a powerful and counter-intuitive technique designed to solve this very problem. It is the practice of deliberately taking a step back from the specific question to first ask a more general, high-level question. By doing this, you compel the model to generate a set of foundational principles or a conceptual framework, which you can then provide as rich, guiding context to solve your original, specific problem.

## 13.2 The Core Principle of Abstraction: The Two-Step Process

The Step-Back strategy is not a single prompt, but a two-prompt workflow. It involves a deliberate act of abstraction followed by a targeted application.

**Step 1: The Abstraction Prompt.**
Instead of asking your specific question, you formulate a "step-back" question. This question abstracts away the specific details (names, dates, numbers) and asks for the underlying principles, concepts, or common patterns related to the task.

**Step 2: The Application Prompt.**
You then take the high-level, principled answer generated by the first prompt and provide it as context for your original, specific question. This primes the model with a rich, relevant framework, enabling it to solve the specific task with far greater depth and accuracy.

Imagine you are lost in a city and need to get from your current location to a specific landmark.

- **Direct Prompt:** Asking for turn-by-turn directions from your current corner to the landmark. This will work, but you learn nothing about the city.
- **Step-Back Strategy:**
    1. **Abstraction:** First, you ask for a map of the entire city district and a compass.
    2. **Application:** Then, using the map and compass, you plot your own course to the landmark.

The Step-Back strategy gives the AI the "map and compass" of general principles, allowing it to navigate the specific problem with a deeper understanding of the entire landscape.

## 13.3 The Rationale: Why Generalizing First Leads to Better Specifics

This two-stage process is highly effective because it fundamentally alters how the AI approaches a problem, leveraging its architecture in a more sophisticated way.

1. **Activates Broader and Deeper Knowledge:** A very specific prompt activates a narrow, specialized slice of the model's knowledge. A general, conceptual question forces the model to access a much broader, more foundational knowledge base. It retrieves first principles, which are often more robust and widely applicable than specific, memorized facts.
2. **Mitigates Overfitting to Details:** When a prompt is overloaded with details, the model can sometimes "overfit" to those details, treating them as absolute constraints and failing to think creatively. Stepping back frees the model from these constraints, allowing it to brainstorm at a higher level before being re-grounded in the specifics.
3. **Generates a Reusable Framework:** The output of the Abstraction Prompt is often a valuable artifact in itselfâ€”a set of best practices, a checklist of key considerations, or a summary of core concepts. This framework not only helps solve the immediate problem but can often be reused for other, similar tasks.
4. **Improves Reasoning and Coherence:** The act of generating high-level principles is an act of reasoning. By forcing the model to do this first, you are priming its logical faculties. The final answer is then more coherent because it is built upon a solid, explicitly stated conceptual foundation.

## 13.4 A Practical Walkthrough: From a Generic Storyline to a Compelling Level Design

Let's demonstrate the power of the Step-Back strategy with a creative task where direct prompts often yield clichÃ©d results.

**The Goal:** Write a storyline for a new level in a first-person shooter (FPS) video game.

**Attempt 1: The Direct Prompt**\`Prompt: "Write a one-paragraph storyline for a new level of a first-person shooter video game that is challenging and engaging."\`

- **Common Output (Generic and Uninspired):**\`"The player is dropped into a war-torn city where they must fight their way through enemy soldiers to reach an extraction point. They will face heavy resistance in the streets and must use cover and tactics to survive. The mission is to secure a high-value target before time runs out."\`*(This is technically correct but lacks any creativity or specific detail. It's the most average, statistically likely response.)*

**Attempt 2: The Step-Back Strategy in Action**

**Step 1: The Abstraction Prompt (Asking for Principles)**\`Prompt: "Based on popular and critically acclaimed first-person shooter action games, what are 5 key settings or themes that contribute to a challenging and engaging level storyline?"\`

- **Output of the Abstraction Prompt (A Framework of Ideas):**\`1. **Abandoned Military Base:** A post-apocalyptic complex with mutated soldiers and rogue robots, ideal for intense firearm combat and exploring derelict technology.2. **Cyberpunk Megacity:** A neon-lit, vertical environment with towering skyscrapers and grimy alleyways, featuring cybernetically enhanced enemies and hacking mechanics.3. **Alien Derelict Ship:** A vast, non-Euclidean alien vessel with eerie corridors, zero-gravity sections, and bizarre extraterrestrial creatures to encounter.4. **Zombie-Infested Suburb:** A once-peaceful town now overrun by hordes of aggressive zombies, featuring intense close-quarters combat and environmental puzzle-solving.5. **Underwater Research Facility:** A deep-sea laboratory that is flooding, filled with mutated aquatic creatures and requiring stealth and underwater exploration skills.\`*(This output is now a rich palette of high-quality concepts.)*

**Step 2: The Application Prompt (Combining Principles with the Original Task)**\`Prompt: "You are an expert level designer for an FPS game.\`

\`<context>Here are 5 engaging themes for an FPS level:1.  Abandoned Military Base...2.  Cyberpunk Megacity...3.  Alien Derelict Ship...4.  Zombie-Infested Suburb...5.  Underwater Research Facility...</context>\`

\`<task>Using the 'Underwater Research Facility' theme from the context, write a detailed, one-paragraph storyline for a new level. The storyline must be challenging, engaging, and incorporate elements of stealth, flooding, and mutated aquatic creatures."</task>\`

- **Final Output (Creative and Specific):**\`"The level, titled 'Leviathan's Maw,' begins as the player character, a deep-sea salvage specialist, breaches the airlock of the sunken Benthic Horizon research facility, which went dark 72 hours ago. Alarms blare in the distance as the station's automated systems announce catastrophic hull breaches and imminent collapse. The player must navigate claustrophobic, half-flooded corridors flickering with emergency lights, using stealth to evade sonar-sensitive, bio-luminescent predators that were once the station's research subjects. The core challenge is a race against the rising water level, forcing the player to solve environmental puzzles to re-route power and open new pathways to the upper decks, all while being hunted by a massive, mutated creature that stalks them from the darkened waters of the flooded main reactor chamber."\`*(This output is vastly superior because it was built on the foundation of a high-quality, pre-generated concept.)*

## 13.5 Crafting Effective Step-Back Questions

The quality of this strategy depends entirely on the quality of your Abstraction Prompt. A good step-back question should:

- **Focus on Principles, not Specifics:** Use words like "principles," "frameworks," "core concepts," "best practices," "themes," or "fundamentals."
- **Generalize Entities:** Replace specific names or details with their general categories. Instead of "How can I make this specific character, John Smith, more compelling?" ask, "What are the key literary techniques for creating a compelling and morally ambiguous protagonist in a noir thriller?"
- **Target the AI's General Knowledge:** The question should be something the model can answer from its broad training, not something that requires knowledge of your specific, private context.

## 13.6 Conclusion: The Power of Detour

The Step-Back strategy teaches us a vital lesson in prompt engineering: sometimes the most direct path is not the most effective one. By taking a deliberate detour into the realm of abstraction, you can equip the AI with the foundational knowledge it needs to solve your specific problem with a level of insight, creativity, and coherence that a direct prompt could never achieve.

It is a technique for transforming the AI from a simple implementation tool into a genuine thought partner. You are not just asking it to perform a task; you are asking it to first understand and articulate the very principles that define success for that task. This elevation in thinking is what separates a merely adequate response from an exceptional one.

# Chapter 14: The Self-Correction Strategy: Prompting the AI to Review and Refine Its Own Work

## 14.1 The First-Draft Problem: The Brilliant Improviser Who Never Edits

Large Language Models are, at their core, brilliant improvisers. They generate text token by token, seamlessly weaving together sentences and concepts in a continuous, forward-moving stream of prediction. This process is what allows them to produce fluent, coherent, and often startlingly insightful text. However, this very strengthâ€”this relentless forward momentumâ€”is also a critical weakness.

The model's generation process is inherently greedy. It makes the best local choice at each step, but it lacks the natural, recursive cognitive loop that humans use: the process of writing a draft, pausing, re-reading, critiquing, and refining. An LLM, left to its own devices, almost never second-guesses itself. Its first draft is its final draft. This "first-draft fallibility" can lead to outputs that contain subtle factual errors, logical inconsistencies, incomplete arguments, or a failure to adhere to all the constraints of a complex prompt.

The **Self-Correction Strategy** is a sophisticated prompting technique designed to solve this problem. It is the practice of explicitly building a "review and refine" loop *into the prompt itself*. Instead of accepting the AI's first pass, you command it to become its own editor, its own critic, and its own quality assurance engineer. This strategy forces the model to pause its improvisational flow, evaluate its own work against a set of criteria, and produce a new, superior version based on that self-critique.

## 14.2 The Core Idea: Building an Internal Feedback Loop

The Self-Correction strategy moves beyond a simple, one-way instruction. It creates a multi-step, internal workflow within a single prompt or a chained sequence of prompts. The core of the strategy is to separate the act of *generation* from the act of *evaluation*.

- **Without Self-Correction:**\`Prompt -> [AI Black Box] -> Final Output\`
- **With Self-Correction:**\`Prompt -> [AI Generates Draft] -> [AI Critiques Draft] -> Final, Refined Output\`

This is not the same as the user manually reviewing the output and providing feedback in a follow-up prompt. The power of the Self-Correction *strategy* is in its automation. You architect the prompt in such a way that the AI performs this entire loop autonomously, delivering a more polished and reliable result from a single, more complex request. It is the difference between editing a document yourself and teaching a writer to edit their own work before they submit it to you.

## 14.3 The Rationale: Simulating a Deeper Cognitive Process

Forcing an AI to critique its own work is a powerful mechanism that leverages several key aspects of its architecture and training.

1. **Activates Evaluative Capabilities:** LLMs are not just generators; they are also excellent evaluators. They have been trained on a massive corpus that includes critiques, reviews, edits, and debates. By prompting for a critique, you are activating this specific, well-trained capability. The model is often better at recognizing an error than it is at avoiding it in the first place.
2. **Forces Constraint Checking:** In a complex prompt with multiple constraints (e.g., "Summarize under 200 words, in a formal tone, for a non-technical audience, and include a call to action"), a model might miss one of these constraints in its initial, forward-pass generation. A self-correction step that explicitly instructs the model to "review the draft to ensure all constraints have been met" provides a safety net, allowing it to catch and fix its own omissions.
3. **Breaks the Path Dependency:** The token-by-token generation process is path-dependent. An early error can lock the model into a flawed trajectory. The act of generating a critique creates a new, independent context. The model can then re-generate the final output based on the insights from the critique, effectively breaking free from its initial, flawed path.
4. **Improves Robustness and Reliability:** By building a QA step directly into the process, you create a system that is inherently more resilient to error. This is crucial for production applications where the cost of an incorrect or incomplete response is high.

## 14.4 A Toolkit of Self-Correction Techniques

There are several ways to implement the Self-Correction strategy, ranging from simple commands to sophisticated multi-persona simulations.

### 14.4.1 Technique 1: The Explicit "Review and Refine" Command

This is the most direct approach. You instruct the AI to perform the task in sequential stages: draft, review, and finalize.

- **Prompt Structure:**\`Your task is to [describe the task].Follow these steps:1. First, write a preliminary draft of the response.2. Second, review the draft you just wrote. Check it for [list specific criteria: accuracy, clarity, tone, adherence to constraints, etc.].3. Third, rewrite the draft into a final, polished version based on your review.\`

### 14.4.2 Technique 2: The "Critique and Improve" Loop

This technique makes the evaluation step more explicit and transparent by asking the AI to output its critique before generating the final version. This is excellent for debugging and understanding the model's "thought process."

- **Prompt Structure (using structural tags):**\`Your task is to [describe the task].\`
    
    \`First, write your initial draft inside <draft> tags.Next, critique your own draft inside <critique> tags. Identify at least three specific weaknesses or areas for improvement.Finally, write the improved, final version inside <final_version> tags, addressing the points from your critique.\`
    

### 14.4.3 Technique 3: The Multi-Persona Debate

A powerful and creative form of self-correction, this technique leverages the Persona Strategy to create an internal debate. You assign two or more conflicting personas and have them critique each other's perspectives.

- **Prompt Example (Strategic Planning):**\`"We are considering launching a new, premium-priced product. To analyze this, simulate a debate between two VPs: **VP of Sales (The Optimist):** Argue for why this is a massive revenue opportunity. **VP of Finance (The Skeptic):** Argue against it, focusing on the risks of market alienation and high costs.\`
    
    \`After presenting both arguments, act as the CEO and write a final, balanced decision that synthesizes both viewpoints and defines the path forward."\`*(The debate itself is the self-correction mechanism, forcing the model to consider the problem from multiple angles before reaching a conclusion.)*
    

### 14.4.4 Technique 4: The "Pre-Mortem Analysis"

This is a proactive form of self-correction. You ask the model to imagine its response has failed and to diagnose the reasons for that failure *before* it even writes the response.

- **Prompt Example (Project Plan):**\`"I need you to generate a detailed project plan.Before you write the plan, I want you to perform a 'pre-mortem'. Imagine it is six months from now, and this project has failed catastrophically. In a <pre_mortem> tag, write a brief analysis of the three most likely reasons for its failure (e.g., unrealistic timelines, resource conflicts, scope creep).Then, in a <project_plan> tag, write the actual project plan, ensuring it includes specific, explicit mitigation strategies to prevent the failure points you identified in the pre-mortem."\`

## 14.5 Self-Correction in Action: A Code Generation Example

Code generation is a perfect domain to illustrate the power of this strategy, as first-draft code often contains subtle bugs or misses edge cases.

- **Prompt (Without Self-Correction):**\`"Write a Python function that takes a list of strings and returns a new list containing only the strings that are palindromes."\`
- **Possible Output (Flawed):**
    
    \`\`\`python
    def find_palindromes(strings):
        palindromes = []
        for s in strings:
            if s == s[::-1]:
                palindromes.append(s)
        return palindromes
    
    \`\`\`
    
    *(This code works for simple cases but fails on strings with different capitalization, e.g., "Racecar", or strings with punctuation, e.g., "A man, a plan, a canal: Panama".)*
    
- **Elite Prompt (With Self-Correction):**\`"Your task is to write a robust Python function to find palindromes in a list of strings.\`
    - \`*Step 1: The Initial Code**First, write the function inside a \\\\\`\\\`\\\\\`python code block.\`
    - \`*Step 2: Identify Edge Cases & Bugs**Next, as a senior QA engineer, list potential edge cases and bugs in the code you just wrote. Consider issues like capitalization, punctuation, and empty strings.\`
    - \`*Step 3: The Refined Code**Finally, rewrite the function to be robust and handle all the edge cases you identified. Place the final, production-ready code in a separate \\\\\`\\\`\\\\\`python code block."\`
- **Expected Output (Robust and Self-Corrected):Step 1: The Initial Code**
    
    \`\`\`python
    def find_palindromes(strings):
        # ... [initial flawed code] ...
    
    \`\`\`
    
    **Step 2: Identify Edge Cases & Bugs**\`1.  **Capitalization:** The current code is case-sensitive. It would fail to identify "Madam" as a palindrome.2.  **Punctuation and Spaces:** The code doesn't handle non-alphanumeric characters. "A man, a plan, a canal: Panama" would fail.3.  **Empty List:** The code should handle an empty input list gracefully.4.  **Empty Strings:** The code should correctly handle empty strings within the list.\`
    
    **Step 3: The Refined Code**
    
    \`\`\`python
    import re
    
    def find_palindromes_robust(strings):
        """
        Finds all palindromic strings in a list, ignoring case, spaces, and punctuation.
        """
        palindromes = []
        if not strings:
            return []
        for s in strings:
            # Normalize the string: remove non-alphanumeric chars and convert to lowercase
            normalized_s = re.sub(r'[^a-zA-Z0-9]', '', s).lower()
            if normalized_s and normalized_s == normalized_s[::-1]:
                palindromes.append(s)
        return palindromes
    
    \`\`\`
    

## 14.6 Conclusion: Building Resilience into the Prompt

The Self-Correction Strategy is the hallmark of a mature prompt engineer. It reflects an understanding that AI generation is a probabilistic process, not a deterministic one, and that building in checks and balances is essential for creating reliable, high-quality outputs.

By moving beyond the single, fire-and-forget prompt, you can architect a more thoughtful, resilient, and self-aware process. You are teaching the AI not just to generate, but to reflect. This internal feedback loop is what elevates a response from being merely plausible to being polished, robust, and correct. It is the final step in transforming the AI from a brilliant but fallible improviser into a dependable and self-aware creative partner.

# Chapter 15: The ReAct Strategy: Combining Reasoning with Action via External Tools

## 15.1 The Confines of the Ivory Tower: The Closed-World Problem

Thus far, our prompting strategies have operated within the "mind" of the AI. We have coaxed it into performing complex reasoning (CoT), exploring multiple possibilities (ToT), and critiquing its own work (Self-Correction). We have, in essence, created a brilliant thinker locked in an ivory tower. This thinker has access to a vast internal libraryâ€”its training dataâ€”but it is a library with a strict cut-off date. It contains no information about yesterday's news, today's stock prices, or the current weather. Its knowledge is static and frozen in time.

This "closed-world" limitation gives rise to two fundamental problems that no amount of pure reasoning can solve:

1. **The Stale Knowledge Problem:** The model cannot answer questions about any event that has occurred since its training data was compiled. Its world view is perpetually out of date.
2. **The Grounding Problem (Hallucination):** When confronted with a question at the edge of its knowledge, the model can't simply *check the facts*. Instead, it often falls back on its primary function: predicting a plausible sequence of words. This can lead to the generation of "hallucinations"â€”answers that are well-written, confident, and entirely fabricated.

To solve these problems, we must break the AI out of its ivory tower. We need a strategy that allows it to not just *think*, but to *act*â€”to reach out, interact with the external world, gather fresh information, and use that information to inform its reasoning. This is the purpose of the **ReAct Strategy**.

## 15.2 The Principle of Agency: Reason to Act, Act to Reason

**ReAct**, an acronym for **Reason and Act**, is a paradigm-shifting strategy that transforms the LLM from a passive generator of text into an active agent capable of goal-oriented interaction with its environment. It fuses the step-by-step reasoning of Chain-of-Thought with the ability to use external tools, creating a powerful, iterative loop that mirrors human problem-solving.

Where a CoT model *thinks about* the answer, a ReAct agent *thinks about what to do next*.

The ReAct framework operates on a simple yet profound cycle: the **Thought-Action-Observation loop**.

1. **Thought (Reasoning):** The agent first analyzes the user's query and its current state of knowledge. It then formulates a verbal reasoning traceâ€”a "thought"â€”that articulates its immediate goal and devises a plan to achieve it by using a specific tool. This thought is not the final answer, but a strategic plan for the next action.
2. **Action (Tool Use):** Based on its thought, the agent generates a specific, machine-readable command to execute an action using one of the tools it has been given access to. This could be a web search, a calculation, a database query, or a call to any external API.
3. **Observation (Processing Tool Output):** The external system (the "harness" or "orchestrator" you build) executes the action and returns the result to the agent. This resultâ€”the text from a webpage, the answer from a calculator, the data from a databaseâ€”is the "observation."

This observation is then fed back into the agent's context, and the loop begins again. The agent's next **Thought** is now informed by the new information it has gathered, allowing it to refine its plan, ask follow-up questions, and iteratively build towards a final answer that is grounded in fresh, external data.

## 15.3 A Practical Walkthrough: The Agent as a Research Assistant

Let's consider a multi-step question that is impossible for a closed-world model to answer correctly.

**The Query:**\`"What was the name of the film that won the Oscar for Best Animated Feature in 2023, and what is its current Rotten Tomatoes score for critics?"\`

A ReAct agent, equipped with a \`Search\` tool, would tackle this as follows:

**Loop 1: Find the Movie**

- **Thought:** "I need to answer a two-part question. First, I need to identify the winner of the Best Animated Feature Oscar in 2023. I don't have this information in my internal knowledge base as it is a recent event. I should use the \`Search\` tool to find this information."
- **Action:** \`Search(query="Best Animated Feature Oscar winner 2023")\`
- **Observation:** (The system executes the search and returns the result) "Guillermo del Toro's Pinocchio won the Academy Award for Best Animated Feature Film at the 95th Academy Awards in 2023."

**Loop 2: Find the Score**

- **Thought:** "Okay, I have the name of the film: 'Guillermo del Toro's Pinocchio'. Now I need to find its current Rotten Tomatoes score for critics. I will use the \`Search\` tool again for this second piece of information."
- **Action:** \`Search(query="Guillermo del Toro's Pinocchio Rotten Tomatoes critic score")\`
- **Observation:** (The system executes the search) "Guillermo del Toro's Pinocchio has a Tomatometer score of 97% based on 300+ critic reviews."

**Loop 3: Synthesize the Final Answer**

- **Thought:** "I have successfully gathered both pieces of required information. I know the movie that won the award and its current critic score on Rotten Tomatoes. I can now formulate the final answer for the user."
- **Action (Final Answer):** "The film that won the Oscar for Best Animated Feature in 2023 was 'Guillermo del Toro's Pinocchio'. Its current Rotten Tomatoes critic score is 97%."

This iterative process allows the agent to decompose the problem and methodically gather the necessary information from the external world before constructing a final, accurate, and up-to-date answer.

## 15.4 The Architecture of a ReAct Agent: The System Prompt as the Blueprint

The ReAct strategy is not just a user-level prompting trick; it is an **agentic architecture** that must be defined in the **System Prompt**. The system prompt is the agent's core programming, its constitution. For a ReAct agent, this prompt must contain several critical components:

1. **Role and Goal Definition:** A clear statement of the agent's purpose (e.g., "You are a helpful AI assistant designed to answer questions by using external tools.").
2. **Tool Specification:** This is the most critical part. You must provide a comprehensive, machine-readable list of all the tools the agent can use. For each tool, you must define:
    - Its name (e.g., \`Search\`, \`Calculator\`).
    - A clear description of what it does (e.g., "Searches the internet for up-to-date information.").
    - The exact format of the \`Action\` call, including parameter names and types (e.g., \`Search(query: str)\`).
3. **Instruction on the Thought-Action-Observation Format:** You must explicitly instruct the model to follow the ReAct loop and to format its output in a precise, parsable way.
    
    **Example System Prompt Snippet:**\`...You have access to the following tools:\`
    
    \`Search(query: str): A tool to search the internet.\`
    
    \`To use a tool, you must use the following format:Thought: [Your reasoning and plan for the next action]Action: [The tool call, e.g., Search(query="your search term")]\`
    
    \`After an action, the system will return an observation:Observation: [The result of the tool execution]\`
    
    \`You must repeat the Thought-Action-Observation cycle until you have enough information to answer the user's question. Then, you must output the final answer directly.\`
    
4. **The Scratchpad (Implicit Context):** The growing history of the conversation (the sequence of Thoughts, Actions, and Observations) acts as the agent's "scratchpad" or short-term memory, allowing it to keep track of its progress.

## 15.5 The Trade-Offs: The Price of Agency

The power of the ReAct strategy is undeniable, but it comes with significant architectural complexity and performance trade-offs.

- **Advantage - Grounding & Freshness:** It is the ultimate solution for reducing hallucinations and ensuring information is up-to-date. The agent's answers are grounded in verifiable, external data.
- **Advantage - Transparency:** The explicit \`Thought\` traces make the agent's reasoning process entirely transparent, which is invaluable for debugging and building trust in the system.
- **Disadvantage - Latency:** ReAct is inherently slow. Each loop involves at least one LLM call plus the execution time of the external tool. A multi-step query can take several seconds to resolve, making it unsuitable for many real-time applications.
- **Disadvantage - Complexity & Cost:** Implementing a ReAct agent requires an "orchestrator" layer of code to parse the agent's \`Action\`, call the correct tool API, and format the \`Observation\`. Furthermore, each reasoning step consumes tokens and incurs API costs, making it more expensive than a single-pass prompt.

## 15.6 Conclusion: From a Thinker to a Doer

The ReAct strategy is a fundamental leap in the evolution of AI interaction. It is the framework that allows us to build not just language models, but true AI agentsâ€”systems that can reason, plan, and act upon the world to achieve their goals.

It is a complex and resource-intensive strategy, but it is the essential toolkit for solving problems that require knowledge beyond the model's static training data. By mastering the art of building and prompting these agents, you move from simply conversing with an AI to directing an intelligent, autonomous system capable of dynamic research, analysis, and problem-solving in the real, ever-changing world.

# Chapter 16: The Prompt Chaining Strategy: Breaking Down Complex Workflows into Sequential Tasks

## 16.1 The Allure of the "Mega-Prompt": A Common Pitfall

As a prompt engineer's confidence grows, a natural temptation arises: the creation of the "mega-prompt." This is an attempt to orchestrate a complex, multi-stage workflow within a single, monolithic instruction. The prompt becomes a sprawling document, containing commands to research a topic, then draft a document based on that research, then edit the document for a specific tone, and finally, format it into a tableâ€”all in one go.

While this approach can sometimes work for simple tasks, it is a fundamentally fragile and inefficient strategy. The mega-prompt often collapses under its own weight, for several critical reasons:

1. **Cognitive Overload:** Even for a powerful LLM, a long list of disparate instructions can lead to a form of cognitive overload. The model may lose track of earlier constraints, blend distinct steps together, or simply ignore parts of the prompt in its rush to generate a coherent output.
2. **Context Contamination:** Different stages of a workflow often require different "mindsets." The divergent, creative thinking needed for brainstorming is fundamentally different from the convergent, logical thinking needed for technical analysis. When forced into a single context, these mindsets contaminate each other, leading to a less creative brainstorm and a less logical analysis.
3. **Lack of Control and Debuggability:** The mega-prompt is an all-or-nothing proposition. If the final output is flawed, it is nearly impossible to determine which specific instruction in the long chain of commands was misinterpreted. Debugging becomes a frustrating process of trial and error with the entire, complex prompt.
4. **Error Propagation:** A small error or hallucination generated early in the process becomes a permanent, corrupting part of the context. The rest of the generation will be built upon this flawed foundation, leading to a cascade of errors that ruins the final output.

To build robust, reliable, and sophisticated AI systems, we must move beyond the single mega-prompt. We must adopt the mindset of a systems architect, not just a prompter. This is the domain of the **Prompt Chaining Strategy**.

## 16.2 The Assembly Line Principle: Deconstructing the Workflow

The **Prompt Chaining Strategy** is the practice of deconstructing a complex workflow into a series of smaller, discrete, single-purpose prompts. The output of one prompt becomes the direct input for the next, creating a sequential "chain" or "pipeline."

The most powerful analogy for this strategy is a **factory assembly line**.

- A complex product (the final desired output, like a detailed report) is not built at a single, chaotic workstation.
- Instead, it moves down a line. At each station, a specialized worker (a specific, focused prompt) performs one, and only one, well-defined task.
- Station 1 takes the raw materials and forges the chassis. Station 2 takes the chassis and installs the engine. Station 3 takes the engine-fitted chassis and adds the wiring.
- Each step is isolated, optimized, and verifiable. The result is a high-quality, reliably produced final product.

Prompt chaining applies this same industrial logic to AI workflows. Instead of one prompt that does everything poorly, you create a chain of prompts where each link does one thing exceptionally well.

## 16.3 The Rationale: The Four Pillars of Chaining's Power

This strategy is not just a matter of organization; it provides fundamental engineering advantages that are impossible to achieve with a single prompt.

1. **Focus and Precision:** Each prompt in the chain has a single, clear objective. This allows the AI to dedicate its full "attention" and computational resources to executing one well-defined task at a time. This dramatically increases the quality and accuracy of each intermediate step.
2. **Context Isolation and Purity:** This is perhaps the most critical benefit. Each prompt in the chain operates in a "pristine" contextual environment. The creative, divergent thinking of a "Brainstorming Prompt" is completed, and its output is passed to the next step. The "Logical Analysis Prompt" then receives only the clean output of the brainstorm, without any of the contaminating "what if" context that created it. This prevents mental models from bleeding into one another.
3. **Control, Debuggability, and Verifiability:** A chained workflow is transparent. If your final output is flawed, you can inspect the output of each link in the chain. This allows you to immediately pinpoint the exact stepâ€”and the exact promptâ€”that failed. You can then fix that single prompt and re-run the chain from that point, rather than starting the entire process from scratch.
4. **Optimized Resource Allocation:** This is a highly advanced benefit. A single mega-prompt forces you to use one model, with one set of parameters (like temperature), for all sub-tasks. A prompt chain allows you to use the *right tool for the right job* at each step.
    - **Step 1 (Brainstorming):** Use a highly creative model (like Claude 3 Opus or GPT-4) with a **high temperature** (e.g., 0.9) to encourage diverse ideas.
    - **Step 2 (Analysis):** Use a powerful reasoning model with a **low temperature** (e.g., 0.2) to ensure logical, deterministic outputs.
    - **Step 3 (Formatting):** Use a smaller, faster, and cheaper model (like Claude 3 Haiku) with a temperature of **0.0** to simply and reliably reformat the data into JSON.

This allows you to build workflows that are not only more reliable but also significantly more cost-effective and performant.

## 16.4 A Practical Walkthrough: Building a Technical Blog Post with a Prompt Chain

Let's construct a workflow to create a high-quality technical blog post, a task that is notoriously difficult for a single prompt.

**The Goal:** Write a 600-word blog post explaining the ReAct prompting framework for a technical audience.

### **Chain Link 1: The Researcher and Outliner**

- **Persona:** A senior AI research assistant.
- **Goal:** To gather key information and structure the content.
- **Prompt:**\`I am writing a technical blog post explaining the ReAct (Reason and Act) framework.Your task is to act as a research assistant. Based on your knowledge, generate a detailed, hierarchical outline for a 600-word blog post on this topic.The outline must include a brief introduction, a section explaining the core Thought-Action-Observation loop, a section on the benefits (like grounding), a section on the drawbacks (like latency), and a conclusion.\`
- **Output 1:** A well-structured Markdown outline.

### **Chain Link 2: The Technical Writer**

- **Persona:** An expert technical writer who makes complex topics easy to understand.
- **Goal:** To write the main body of the blog post based on the outline.
- **Prompt:**\`<outline>[Output 1 from the previous prompt is pasted here]</outline><instruction>You are an expert technical writer. Using the provided outline as your strict guide, write a full draft of the blog post. Write in a clear, professional, and engaging tone suitable for an audience of software developers. Ensure each section flows logically into the next. Do not write a title yet.</instruction>\`
- **Output 2:** The full 600-word draft of the blog post.

### **Chain Link 3: The Critical Editor**

- **Persona:** A skeptical, detail-oriented editor who checks for technical accuracy and clarity.
- **Goal:** To review and refine the draft.
- **Prompt:**\`<draft_to_review>[Output 2 from the previous prompt is pasted here]</draft_to_review><instruction>You are a meticulous editor. Review the draft above for technical accuracy, logical flow, and clarity. Provide a list of 3-5 specific, actionable suggestions for improvement. Format your feedback as a bulleted list.</instruction>\`
- **Output 3:** A list of suggestions, e.g., "Clarify the difference between the 'Action' and the 'Final Answer' steps..."

### **Chain Link 4: The Final Polish and SEO Specialist**

- **Persona:** An SEO and marketing specialist.
- **Goal:** To apply the edits and optimize the post for discovery.
- **Prompt:**\`<original_draft>[Output 2 is pasted here]</original_draft><editorial_feedback>[Output 3 is pasted here]</editorial_feedback><instruction>You are an SEO expert. First, rewrite the original draft to incorporate all of the editorial feedback.Second, after rewriting the text, generate 5 catchy, SEO-friendly titles for the final blog post.</instruction>\`
- **Final Output:** The polished, final blog post and a list of optimized titles.

## 16.5 The Role of the Orchestrator and the Human-in-the-Loop

A prompt chain is not fully autonomous. It requires an **orchestrator**. This can be a human operator who manually copies and pastes the output of one prompt into the next, or it can be a piece of code (e.g., a Python script) that automates the API calls and state management.

Furthermore, the chain provides perfect opportunities for **human-in-the-loop** intervention. A human expert can review the outline from Link 1 before it's passed to the writer, or edit the draft from Link 2 before it goes to the editor. This powerful synergy combines the speed and scale of AI with the nuanced judgment and expertise of a human, resulting in a final product that is superior to what either could achieve alone.

## 16.6 Conclusion: From Prompting to Workflow Architecture

The Prompt Chaining Strategy represents a crucial maturation in the discipline of prompt engineering. It is the point where we move beyond crafting single instructions and begin designing entire systems of intelligent work. It demands a new way of thinkingâ€”decomposing problems, defining clear interfaces between steps, and optimizing each component for its specific task.

By embracing this assembly line approach, you gain unprecedented control, reliability, and efficiency. You can build complex, multi-stage AI applications that are robust, easy to debug, and capable of producing outputs of a quality and sophistication that no single mega-prompt could ever hope to achieve. This is the future of applied AI: not a single, monolithic intelligence, but a well-orchestrated symphony of specialized, intelligent agents working in concert.

# Chapter 17: The Multi-Agent Strategy: Decomposing Workflows into a Team of Specialized AI Agents

## 17.1 From the Assembly Line to the Expert Team

In the previous chapter, we took a monumental leap from the single mega-prompt to the sequential logic of the prompt chain. We transformed our process from a single, chaotic workstation into an orderly, efficient assembly line. Each link in the chain performs its task with focus and precision, passing its completed work to the next station. This linear, sequential model is a powerful tool for bringing order and reliability to complex workflows.

But what happens when the task is not a simple linear assembly? What if it requires the collaborative effort of multiple, distinct specializations, working sometimes in sequence, sometimes in parallel, and sometimes in debate? A factory assembly line is good at building a car, but it's not the right model for designing one. Designing a car requires a *team*: a visionary product manager, a pragmatic engineer, a creative designer, and a meticulous quality assurance expert.

This is the next evolution in our thinking. The **Multi-Agent Strategy** is the practice of transcending the linear chain and architecting a virtual **team of specialized AI agents**. Each agent is an independent instance of the LLM, instantiated with its own unique, highly focused persona and purpose. This is not just a chain of prompts; it is a system of collaborators. It is the point where the prompt engineer truly becomes a systems architect, or perhaps, a team manager.

## 17.2 The Rationale: The Power of Deep Specialization

A single, general-purpose AI, even when guided through a prompt chain, can struggle to effectively context-switch between the different mindsets required for a complex workflow. The divergent, "blue-sky" thinking needed for brainstorming is fundamentally at odds with the convergent, detail-obsessed thinking needed for code debugging. Asking one "worker" to rapidly switch between these roles is inefficient and error-prone.

The Multi-Agent strategy solves this by creating a virtual team where each member is an undisputed world expert in their single, narrow domain. This approach yields profound benefits:

1. **Deep Expertise and Persona Purity:** Instead of a single AI with a diluted, general-purpose persona, you can create an agent whose entire "being"â€”defined by its system promptâ€”is optimized for a single function. A "Creative Brainstormer" agent's system prompt can be filled with language that encourages novelty and risk-taking, while a "QA Engineer" agent's prompt can be built around principles of rigor, skepticism, and meticulous attention to detail. This "persona purity" results in a far higher quality of work at each stage.
2. **Cognitive Isolation:** This is the most critical architectural advantage. By separating the workflow into distinct agents, each with its own isolated conversational context, you prevent "cognitive contamination." The creative, high-temperature chaos of the brainstorming agent never touches the pristine, low-temperature logical context of the system architect. Each agent operates in its own clean room, receiving only the necessary inputs and producing a clean output, unburdened by the thought processes of the agents that came before it.
3. **Modularity and Maintainability:** A multi-agent system is inherently modular. If you find that your "Code Generation" agent is underperforming, you can fine-tune or replace its system prompt without touching any other part of the workflow. This makes the entire system easier to debug, maintain, and upgrade over timeâ€”a core principle of robust software engineering.
4. **Parallel Processing:** While a prompt chain is strictly sequential, a multi-agent system can be designed to work in parallel. You can have three different "Marketing Angle" agents brainstorm ideas simultaneously, and then have a fourth "Marketing Director" agent synthesize their best ideas. This can dramatically reduce the total time required to complete a complex task.

## 17.3 The Four Principles of Multi-Agent Architecture

Building an effective multi-agent system requires a disciplined, architectural approach. Four key principles must be followed.

### Principle 1: Decompose the Workflow into Discrete Roles

Before writing a single prompt, analyze your workflow and break it down into the distinct expert roles required for its completion. Think like a manager building a project team. What are the key phases? Who are the specialists you need? (e.g., Researcher, Writer, Editor, Strategist, Critic).

### Principle 2: Engineer a Pure, Elite Persona for Each Agent

For each identified role, craft a dedicated, highly specific **System Prompt**. This prompt is the agent's DNA. It must be pure, focusing only on that agent's core identity, tools, and behavioral logic. Do not contaminate it with specific examples or data for a one-off task. (See Chapter 6: The Persona Strategy).

### Principle 3: Enforce Strict Context Isolation

This is the golden rule of multi-agent systems. **Each specialized agent must operate in its own, separate chat session or conversational context.** Do not force them to share the same conversational history. The output from Agent A becomes the *input* for Agent B, but Agent B should never see the *conversational history* that led Agent A to its conclusion. This prevents context contamination and ensures each agent operates with a clean slate, focused only on its specific task and persona.

### Principle 4: Match Configuration to the Role

Leverage the freedom that a multi-agent architecture provides. Each agent can be run with its own optimal configuration.

- **Creative Agents (Brainstormers, Copywriters):** Use a powerful, creative model (e.g., GPT-4, Opus) at a **high temperature** (0.8+) to encourage novel and diverse outputs.
- **Logical Agents (Analysts, Architects, QA):** Use a strong reasoning model at a **low temperature** (0.0 - 0.2) to ensure deterministic, stable, and logically sound outputs.
- **Simple Task Agents (Formatters, Classifiers):** Use a fast, cost-effective model (e.g., Haiku, Sonnet) to perform simple, repetitive tasks efficiently.

## 17.4 A Practical Walkthrough: The Software Development Team

Let's apply these principles to build a virtual team to turn a business requirement into a fully specified software project.

**The Workflow:** Business Need -> User Stories -> System Architecture -> Test Plan

### **Agent 1: The Product Manager**

- **Persona:** An expert Product Manager who bridges the gap between business needs and engineering requirements.
- **System Prompt:** \`"I am an expert Product Manager. My core function is to work with stakeholders to translate abstract business needs into clear, concise, and unambiguous user stories, complete with detailed acceptance criteria. I follow the INVEST (Independent, Negotiable, Valuable, Estimable, Small, Testable) model for story writing."\`
- **Configuration:** Reasoning Model, Temperature 0.5 (for a balance of structure and clarity).
- **Input:** A vague business request, e.g., "We need a way for users to update their profiles."
- **Output:** A list of well-formed user stories.

### **Agent 2: The System Architect**

- **Persona:** A seasoned System Architect specializing in designing robust, scalable, and secure microservices.
- **System Prompt:** \`"I am a seasoned System Architect. I take user stories and acceptance criteria and transform them into a complete system design. My output includes detailed API contracts (endpoints, request/response schemas), data models for the database, and a high-level diagram of component interactions. I prioritize security and scalability in all my designs."\`
- **Configuration:** Reasoning Model, Temperature 0.1 (for precision and logic).
- **Input:** The user stories generated by the Product Manager agent.
- **Output:** A detailed technical specification.

### **Agent 3: The QA Engineer**

- **Persona:** A meticulous and slightly paranoid QA Engineer with a passion for finding failure points.
- **System Prompt:** \`"I am a meticulous QA Engineer. I analyze user stories and system architecture designs to create comprehensive test plans. My goal is to anticipate every possible failure mode. My output is a detailed list of test cases, including unit tests, integration tests, and end-to-end test scenarios, specifying the test's purpose, steps, and expected outcome."\`
- **Configuration:** Reasoning Model, Temperature 0.6 (to creatively imagine failure scenarios).
- **Input:** The user stories from the PM and the system design from the Architect.
- **Output:** A comprehensive test plan.

In this workflow, the manager (the orchestrator) takes the output from the PM and provides it as the *sole input* to the Architect in a brand new, isolated chat. This process is repeated for the QA Engineer. The result is a high-quality, fully specified project plan, created by a team of virtual experts, each performing their role flawlessly.

## 17.5 The Orchestrator: The Human (or Code) in Command

A multi-agent system, like a human team, requires a manager. This role is filled by the **orchestrator**. The orchestrator is responsible for:

1. Defining the agents and the workflow.
2. Passing the output of one agent as the input to the next.
3. Managing the isolated contexts for each agent.

In a manual process, the orchestrator is you, the prompt engineer, copying and pasting between different chat windows. In an automated system, the orchestrator is a script (e.g., in Python) that manages the API calls, stores the intermediate outputs, and routes the data between the different agent "functions."

## 17.6 Conclusion: The Future is a Symphony

The Multi-Agent Strategy is the pinnacle of modern prompt engineering. It represents the final and most crucial conceptual shift: from crafting a single, perfect prompt to designing a holistic, intelligent system. It is the difference between conducting a soloist and conducting an orchestra.

Each agent is a finely tuned instrument, and the system prompt is its sheet music. By creating a team of these virtual specialists and orchestrating their collaboration, you can tackle problems of a complexity far beyond the reach of any single prompt. You can build systems that brainstorm, design, execute, and critiqueâ€”simulating the entire collaborative process of an expert human team. This is not just prompting; it is the architecture of AI-powered work.

# Chapter 18: The Constructive Guidance Strategy: Iterating and Steering the AI within a Conversation

## 18.1 The Myth of the Perfect First Prompt

In our quest for prompt engineering mastery, we have dedicated immense effort to the art of crafting the perfect initial promptâ€”a single, flawless instruction designed to elicit a complete and perfect response in one go. For simple, well-defined tasks, this ideal is achievable. But for any task of significant complexity, creativity, or duration, the "one-shot, one-kill" approach is a myth.

A complex task is not a transaction; it is a process. The AI's initial output, no matter how well-prompted, should not be viewed as the final product. It is the **first draft**. It is the sculptor's initial, rough-hewn block of marble. It contains the form and potential of the final masterpiece, but it requires shaping, refinement, and detail work.

This is where the role of the prompt engineer must evolve from that of an *architect* who designs the blueprint to that of a *director* on a film set. The director doesn't just hand the actor a script and walk away; they watch the performance, provide feedback, and guide the actor through multiple takes to achieve the desired outcome. The **Constructive Guidance Strategy** is the practice of this active, in-conversation direction. It is the art of iterating with the AI, steering its performance turn by turn, and collaboratively refining a first draft into a final, polished product.

## 18.2 The Rationale: The AI as a Collaborative Partner

Understanding why this iterative, conversational approach is so effective requires us to embrace a new mental model. The AI is not a vending machine where a perfect input guarantees a perfect output. It is a collaborative partner that learns and adapts *within the context of a single conversation*.

1. **The AI Mirrors Your Tone:** LLMs are highly attuned to the user's tone. If you respond to a suboptimal output with negative, critical, or accusatory language ("You're wrong," "That's a terrible function," "You didn't follow my instructions"), you can inadvertently trap the model in a negative feedback loop. It may become defensive, uncooperative, or produce increasingly degraded responses. Constructive, positive, and encouraging language, however, fosters a collaborative state, making the AI more receptive to your guidance.
2. **In-Context Learning in Action:** Every turn in a conversation is a micro-learning opportunity for the AI. When you provide corrective feedback, you are essentially creating a new, temporary Few-Shot example. Your refinementâ€”"That's a good start, now let's add error handling"â€”becomes part of the context, teaching the model the desired pattern for the *next* generation within that same conversation.
3. **The User as the State Manager:** The AI has no true understanding of when a sub-task is "finished." It only knows the linear history of the conversation. Without clear signals from the user, it may continue to "work on" a problem that you consider solved, leading to context contamination. The user must act as the explicit project manager of the conversation, clearly opening and closing tasks to guide the AI's focus.

Mastering this strategy means moving from a mindset of "pass/fail" on the AI's first response to a mindset of "draft and refine."

## 18.3 A Toolkit of Conversational Steering Techniques

Effective guidance is not a single technique, but a suite of conversational tactics used to steer the AI's performance.

### 18.3.1 Principle 1: Positive Reinforcement and Constructive Feedback

When an output is not perfect, always frame your feedback constructively. Start by acknowledging the positive aspects of the response, then clearly and specifically state the desired modifications.

- **Less Effective (Negative Criticism):**\`"This function you wrote is terrible. It has a bug and it doesn't even handle errors. Fix it."\`
- **More Effective (Constructive Guidance):**\`"Excellent first draft of the function! You've captured the core logic perfectly. Now, for our production version, let's enhance it. Could you please add a try-catch block to handle potential exceptions and also add a check to ensure the input parameter is not null before processing?"\`

This approach is not about being polite for the sake of it. It is a more effective engineering practice that keeps the AI in a collaborative state and provides clear, actionable instructions for improvement.

### 18.3.2 Principle 2: Explicit State Management

Do not assume the AI knows when a sub-task is complete and it's time to move on. You must provide explicit signals to close out a task, which allows the AI to "release" that context and devote its full attention to the next objective.

- **Ambiguous (Implicit State):***(After the AI generates a block of code)* \`"Okay, now create the documentation for it."\`*(The AI might think the code itself is still under review and that the documentation is part of the same, ongoing task.)*
- **Explicit (Clear State Management):**\`"That code is perfect and passes all my tests. We can now consider the implementation task for this module to be 100% complete. Let's start the next distinct task: generating the user documentation for the function we just finalized."\`

The second prompt provides an unambiguous signal that the coding task is finished, preventing its context from bleeding into the documentation task.

### 18.3.3 Principle 3: Trajectory Correction via Editing

When a conversation goes off track due to a misunderstanding in an *earlier* prompt, the most effective solution is often **not** to try and fix it with a series of follow-up corrections. The superior solution is to go back in the conversation history and **edit the user prompt that caused the deviation**.

- **Why It Works:** An AI's response is conditioned on the *entire* preceding conversation history. If an early prompt contains a flaw, that flaw becomes a permanent, corrupting part of the foundational context for all subsequent turns. Follow-up "patches" ("No, I meant this," "Don't do that, do this instead") add more noise and confusion. Editing the original, flawed prompt cleans the foundational context. This allows the AI to regenerate its entire reasoning path from a correct starting point, resulting in a far more coherent and accurate outcome.
- **Illustrative Example:**
    - **Bad Practice (Patching):**
        - **User:** \`"Generate a Python script to parse CSV files in the /data directory."\`
        - **AI:** *(Generates a script using the \`pandas\` library)*
        - **User:** \`"No, I can't use pandas. The environment is minimal. Don't use external libraries."\`
        - **AI:** *(Rewrites using Python's built-in \`csv\` module, but the context is now messy)*
    - **Good Practice (Editing):**
        - **User (Original):** \`"Generate a Python script to parse CSV files in the /data directory."\`
        - **AI:** *(Generates script using \`pandas\`)*
        - **User (Goes back and edits the original prompt to):** \`"Generate a Python script to parse all CSV files in the /data directory. The script must use only the Python standard library, with no external dependencies like pandas. It must include robust error handling for missing files."\`*(The AI now regenerates its response from a clean, correct foundation.)*

### 18.3.4 Principle 4: Pre-Execution Calibration (The 'Teach-Back' Method)

Before the AI begins a complex, time-consuming task, you can prevent wasted effort by requiring it to first confirm its understanding of the plan. This "teach-back" method exposes any subtle misunderstandings *before* significant work is done.

- **Why It Works:** True understanding is only confirmed when the AI can articulate the plan in its own words. This forces the model to synthesize your instructions and formulate a coherent plan of action, revealing any hidden assumptions or misinterpretations upfront.
- **Illustrative Example:**\`"We need to build a REST API endpoint for user profile updates. It should use the HTTP PATCH method, be authenticated, and allow updates to a user's 'firstName', 'lastName', and 'bio' fields in the database. **Before you write any code, please confirm your understanding of the task.** Describe the endpoint's path, the expected request body structure, the validation checks you will perform, and the sequence of operations in your plan."\`

This single alignment step is one of the most critical and highest-leverage actions a user can take in a complex conversation.

## 18.4 Conclusion: The User as the Conductor

The Constructive Guidance Strategy completes our understanding of the user's role in prompt engineering. You are not a passive audience member waiting for a performance. You are the conductor of an orchestra. Your initial prompt is the downbeat, but your true skill is revealed in how you guide the ensemble through the performanceâ€”adjusting tempo, correcting notes, and shaping the dynamics to create a symphony.

The quality of a long and complex AI-driven task is almost never determined by the brilliance of the first prompt alone. It is determined by the user's skill in managing the ensuing dialogue. By mastering the art of constructive feedback, explicit state management, trajectory editing, and pre-execution calibration, you can transform the AI from a simple tool that responds to commands into a true partner that collaborates in an iterative and deeply creative process.

# Chapter 19: The Affirmative Direction Strategy: Stating What to Do vs. What Not to Do

## 19.1 The Paradox of Prohibition: The "Pink Elephant" Problem

There is a classic psychological exercise that perfectly illustrates a fundamental flaw in humanâ€”and artificialâ€”cognition: **"For the next ten seconds, do not, under any circumstances, think of a pink elephant."**

The result is inevitable. The very act of processing the prohibition forces your mind to conjure the exact image you are trying to avoid. The instruction, intended to prevent a thought, is the very thing that seeds it. This paradox of prohibition is not just a quirk of human psychology; it is a critical, mechanistic limitation in how Large Language Models process information.

A common but deeply flawed approach to prompting is to provide the AI with a list of negative constraintsâ€”a list of things it *should not* do. "Do not write code without comments." "Do not use a formal tone." "Do not forget to handle edge cases." While this seems like a direct and logical way to constrain the model's output, it is, in fact, one of the least effective and most error-prone methods of instruction.

The **Affirmative Direction Strategy** is a complete paradigm shift away from this thinking. It is built on a simple, robust, and machine-friendly principle: **Architect the path to the desired outcome, rather than just fencing off the paths to the undesired ones.** It is the art of exhaustively detailing what the AI *should* do, in such a compelling and comprehensive way that the possibility of error is never even introduced.

## 19.2 The Rationale: Why "Don't" is a Flawed Command for an LLM

To understand why affirmative direction is so superior, we must look at how an LLM's attention mechanism and predictive engine actually work.

1. **Attention is Not Negation:** When you include the phrase "Do not use insecure functions" in a prompt, the model's attention mechanism must still focus on the concept of "insecure functions" to understand the instruction. The words "insecure" and "functions" become highly weighted parts of the context. The negation ("do not") is a grammatical modifier, but it does not erase the semantic presence of the core concept. The pink elephant is now in the room, and the model has to actively expend effort to work around it, ironically increasing the cognitive load and the chance of a related error.
2. **The Weakness of Negative Weights:** LLMs operate by predicting the most probable next token. The presence of a concept in the prompt increases the probability of related tokens appearing. While a negation might attempt to apply a negative weight, this signal can be weak and easily lost or down-weighted, especially in a long and complex prompt. The strong, positive signal of the core concept often overpowers the weak, negative signal of the prohibition.
3. **A Clean Path vs. a Minefield:** An affirmative instruction creates a clean, direct, and efficient "thought path" for the model to follow. It's a clear map to a destination. A list of prohibitions, conversely, creates a cognitive minefield. The model must generate a potential output and then constantly check it against the list of things it's not supposed to do. This is a computationally expensive, reactive, and error-prone process. It is far more robust to build a single, safe, well-lit highway than it is to send the model into a dark field with a map of where the mines *might* be.

## 19.3 The Core Principle: Proactive Design over Reactive Correction

The essence of the Affirmative Direction Strategy is to shift your mindset from being a reactive critic to a proactive architect. Instead of correcting potential failures, you design a process that leads inevitably to success.

- **The Prohibitive Mindset (Reactive):**
    - *Starts with:* "What could go wrong?"
    - *Generates:* A list of "Don't..." statements.
    - *Result:* A complex, inefficient process that risks failure at every step.
- **The Affirmative Mindset (Proactive):**
    - *Starts with:* "What does a perfect execution of this task look like, step-by-step?"
    - *Generates:* A detailed, positive description of the ideal process and persona.
    - *Result:* A clean, direct, and robust process that guides the AI naturally to the desired outcome.

## 19.4 Affirmative Direction in Practice: A Gallery of Transformations

This principle is best understood through concrete, side-by-side comparisons. Notice how the "More Effective" versions are not just simple inversions of the negative commands; they are richer, more detailed descriptions of a successful persona and workflow.

### **Example 1: Code Generation and Best Practices**

- **Less Effective (Prohibitive):**\`"Write a Python function to process user data.Do not write code without comments.Do not forget to handle edge cases like null input.Do not use insecure functions like 'pickle'.Do not write one large, monolithic function."\`
- **More Effective (Affirmative):**\`"I am a senior Python developer who practices meticulous, documentation-driven design and adheres to the highest standards of security and modularity.My process for writing any function is as follows:1. **Define Signature and Docstring:** First, I define the function signature with full type hints. Then, I immediately write a comprehensive docstring detailing its purpose, parameters, return values, and any potential exceptions it may raise.2. **Input Validation:** The very first part of my implementation is robust input validation. I rigorously check for all edge cases, such as null or empty inputs, and handle them gracefully.3. **Modular and Secure Implementation:** I write the core logic using small, well-named helper functions. I exclusively use secure, industry-standard libraries like 'json' for data serialization.4. **Final Review:** Before concluding, I review my code to ensure it is clean, readable, and perfectly documented.\`
    
    \`Now, following this exact process, write a Python function to process user data."\`
    

### **Example 2: Controlling Writing Style and Tone**

- **Less Effective (Prohibitive):**\`"Write an email to a customer about a service outage. Do not be too formal. Do not use technical jargon. Do not sound like a robot. Do not blame the customer."\`
- **More Effective (Affirmative):**\`"I am a compassionate and clear-thinking customer support specialist.I am writing an email to a non-technical customer to inform them about a recent service outage.My writing style is warm, empathetic, and direct. I use simple, everyday language and clear analogies to explain technical issues. My primary goal is to reassure the customer and provide them with a clear timeline for the resolution.The email should have three parts: a sincere apology acknowledging their frustration, a brief and simple explanation of the issue, and a confident statement about the next steps."\`

### **Example 3: Content Generation and Focus**

- **Less Effective (Prohibitive):**\`"Write a product description for our new hiking boot. Do not talk about the price. Do not mention our competitors by name. Do not make it too long."\`
- **More Effective (Affirmative):**\`"Write a product description for our new hiking boot, the 'Trailblazer Pro'.The description must be exactly three paragraphs long.The first paragraph should focus on the boot's core benefit: all-day comfort, enabled by our proprietary 'CloudStep' insole technology.The second paragraph should highlight its durability, focusing on the waterproof Gore-Tex material and the rugged Vibram outsole.The final paragraph should be a compelling call to action, inviting the reader to 'experience their next adventure'."\`

## 19.5 Integrating Affirmative Direction with System Prompts

The Affirmative Direction Strategy finds its most powerful application in the design of **System Prompts**. A system prompt should be a positive constitution for the AI. It should be a declaration of *what the AI is* and *how it operates*, not a penal code of what it is forbidden from doing.

A system prompt built on prohibitions creates a fearful, hesitant AI. A system prompt built on a rich, affirmative description of an expert persona creates a confident, capable, and proactive AI collaborator.

## 19.6 A Note on Absolute Boundaries

This is not to say that a prohibition is *never* useful. For absolute, hard-line safety constraints or legal guardrails, an explicit "DO NOT" can serve as a final, critical safety net. For example: "DO NOT, under any circumstances, generate personally identifiable information (PII)."

However, these should be seen as the exception, not the rule. They are the high-voltage fences around the perimeter, used sparingly for critical boundaries. The detailed work of guiding the AI within that perimeter should always be done with the positive, proactive, and ultimately more effective language of affirmative direction.

## 19.7 Conclusion: The Architect of Success

The Affirmative Direction Strategy is a fundamental shift in prompt design. It moves the engineer's focus from preventing failure to architecting success. It is a more robust, more efficient, and more reliable way to communicate with a predictive system.

By learning to describe the ideal process in rich, positive detail, you are not just giving the AI a command; you are giving it a blueprint for excellence. You are drawing a clear and direct map to the treasure, making the journey so straightforward that the model never even considers wandering into the surrounding traps. This proactive design is the essence of advanced, reliable AI engineering.

# Chapter 20: The Output Formatting Strategy: Forcing Structured Data like JSON and Tables

## 20.1 The Last Mile Problem: From Prose to Precision

The raw, native output of a Large Language Model is prose. It is conversational, descriptive, and human-readable. This is its greatest strength and, for many applications, its most crippling weakness. When you are building a software application, a data pipeline, or any automated workflow, a conversational paragraph is not a useful input. It is a block of unstructured text that requires fragile, complex, and error-prone post-processingâ€”like regular expressions or brittle string splittingâ€”to extract the valuable information locked within.

This is the "last mile" problem of prompt engineering. You can guide an AI to a perfectly correct and insightful answer, but if that answer is delivered in a format that your system cannot reliably parse, the entire effort is wasted. A human can understand, "Sure, the user's name is John Doe, and his ID is 123." A computer cannot. A computer needs \`{"name": "John Doe", "id": 123}\`.

The **Output Formatting Strategy** is the solution to this critical problem. It is the practice of compelling the model to act not as a conversationalist, but as a precise data structuring engine. It involves a suite of techniques designed to force the AI to deliver its response in a perfectly predictable, machine-readable format, such as JSON, XML, or a Markdown table. Mastering this strategy is the essential bridge between using AI for simple assistance and integrating AI as a reliable, automated component in a production-grade system.

## 20.2 The Rationale: Why Structure is Non-Negotiable for Systems

Forcing a structured output is not a matter of stylistic preference; it is a fundamental requirement for building robust AI-powered applications.

1. **Machine Readability:** This is the primary driver. Structured data can be instantly and reliably parsed by any programming language. A JSON object can be deserialized into a native object or dictionary, and a table can be read into a data frame, all with zero ambiguity. This eliminates the need for a fragile layer of parsing code.
2. **Consistency and Reliability:** When you successfully enforce an output format, you guarantee that the *shape* of the data will be the same every single time. This predictability is the bedrock of reliable systems. You can build your application with the confidence that the \`user_id\` field will always be present and correctly named.
3. **Reduced Post-Processing:** By making the AI do the work of structuring the data, you save significant development time and effort. The logic for extracting and organizing the information is embedded in the prompt itself, rather than in a separate, complex body of post-processing code.
4. **Implicit Constraint and Focus:** Forcing the AI to populate a specific structure is a powerful form of affirmative direction. When you ask for a JSON object with keys for \`product_name\`, \`price\`, and \`sku\`, you are implicitly telling the model to find *only* that information and to ignore everything else. This helps to focus the model's attention, reducing the likelihood of it including irrelevant details or hallucinating extraneous facts.

## 20.3 The Toolkit of Formatting Control

There are several techniques to enforce a specific output format, ranging in effectiveness from a gentle suggestion to an almost unbreakable command.

### 20.3.1 Technique 1: The Direct Command (The Simple Request)

This is the most straightforward method: simply tell the model what format you want.

- **Prompt:** \`"Extract the key entities from the following text and format them as a JSON object."\`
- **Effectiveness:** This often works for simple, standard formats like JSON or bulleted lists, but it can be unreliable. The model might still include conversational preambles ("Here is the JSON you requested:") or use inconsistent key names. It's a good starting point, but not robust enough for production.

### 20.3.2 Technique 2: The Schema or Template (The Blueprint)

This technique is a significant step up in reliability. Instead of just naming the format, you provide a blueprint or an empty template of the structure you want the AI to fill in.

- **Prompt (for a Markdown Table):**\`"Extract the following information from the text and present it in a Markdown table with these exact columns: | Product Name | SKU | Price |"\`
- **Prompt (for JSON):**\`"Extract the required information into a JSON object that conforms to the following schema:{ "author": string, "publication_year": integer, "key_findings": [string]}"\`
- **Effectiveness:** By providing the exact keys or column headers, you give the model a clear "form" to fill out. This dramatically increases the consistency of the output's structure and is highly effective for most use cases.

### 20.3.3 Technique 3: The Few-Shot Example (The Gold Standard)

As discussed in Chapter 5, showing is always more powerful than telling. Providing a complete, end-to-end example of an input and its perfectly formatted output is the most unambiguous and reliable way to enforce a structure.

- **Prompt (for Custom Delimited Format):**\`"Extract the name and email from the text. Follow the example format precisely.\`
    
    \`### EXAMPLE ###Text: "You can reach out to Steve Rogers at s.rogers@avengers.com for more info."Output: Steve Rogers|s.rogers@avengers.com\`
    
    \`### NEW TASK ###Text: "The project lead is Jane Doe (email: j.doe@example.com)."Output:\`
    
- **Effectiveness:** This is the gold standard for reliability. The model learns the exact transformation and formatting pattern from your example, leaving no room for interpretation. It is the preferred method for any complex or custom format.

### 20.3.4 Technique 4: The Prefilling Strategy (The Nudge)

This is a clever and powerful technique that leverages the model's predictive nature. You can "force" the model to begin its response in a specific format by prefilling the very first part of the \`assistant\`'s turn in your API call.

- **How it works:** If you want a JSON object, you start the assistant's response with a single opening brace: \`{\`. If you want a JSON array (a list), you start it with an opening bracket: \`[\`.
- **API Call Example (Simplified):**\`messages = [ {"role": "user", "content": "Extract the names of the three main characters into a JSON list."}, {"role": "assistant", "content": "["}]\`
- **Effectiveness:** This is an extremely strong signal. By providing the opening character, you have dramatically constrained the model's next token prediction. It is now overwhelmingly probable that it will continue generating a valid JSON list. This is a highly effective way to bypass conversational preambles and jump directly into the desired structure.

## 20.4 A Gallery of Formats: Beyond JSON

While JSON is the workhorse of machine-to-machine communication, the Output Formatting Strategy applies to any structured format.

- **Markdown Tables:** Excellent for human-readable reports that need to be structured.
- **XML:** Essential when interfacing with legacy systems or specific industry standards that require XML.
- **YAML:** A popular choice for configuration files due to its human-friendly syntax.
- **CSV (Comma-Separated Values):** Simple and effective for generating tabular data that can be easily imported into spreadsheets.
- **Custom Formats:** As shown in the Few-Shot example, you can define your own unique, delimiter-separated format for specialized applications.

## 20.5 Building for Production: Handling the "Gotchas"

When integrating a formatting--reliant prompt into a live application, you must be prepared for potential failures.

**Problem 1: The Conversational Wrapper**
The AI's inherent "helpfulness" often leads it to wrap your beautifully structured data in conversational text, like "Of course! Here is the Markdown table you asked for:" This will break your parser.

- **The Solution:** Add a direct, final instruction to your prompt: **"Provide ONLY the [JSON object / Markdown table / etc.] and nothing else. Do not include any preamble, explanation, or concluding text."** This simple command is remarkably effective at ensuring a clean, parsable output.

**Problem 2: Syntax Errors and Truncation**
Even with clear instructions, the model might occasionally generate syntactically invalid output (e.g., a JSON with a missing comma) or, if the output is very long, it might be cut off by the \`max_tokens\` limit, resulting in an incomplete and invalid structure.

- **The Solution:** Your application code must be resilient. Always wrap your parsing logic in a \`try...except\` block (or equivalent error handling). For JSON, you can implement a more robust solution by using a **JSON repair library**. These libraries are designed to intelligently fix common errors in malformed JSON, such as missing brackets or trailing commas, making your system far more resilient to minor AI generation errors.

## 20.6 Conclusion: The Bridge from Conversation to Computation

The Output Formatting Strategy is the critical discipline that makes applied AI possible. It is the bridge that connects the fluid, probabilistic world of natural language generation to the rigid, deterministic world of software and computation.

Without this strategy, the AI remains a fascinating but unpredictable conversationalist. By mastering the techniques of direct commands, schema blueprints, few-shot examples, and response prefilling, you can transform the AI into a reliable and predictable data processing component. You gain the power to dictate the precise structure of its output, ensuring that the information it provides is not just insightful, but immediately and automatically usable. This is the key to unlocking the true potential of AI in building scalable, robust, and automated systems.

# Chapter 21: The Response Prefilling Strategy: Seeding the Assistant's Answer for Control

## 21.1 The Power of the First Word: Guiding the Improviser

Imagine you are in an improvisational comedy scene. The director gives you a prompt: "You are a nervous scientist." You can start your line in a thousand different ways. But what if the director leans in and whispers, "Start your first line with the words, *'It's escaped!'*"?

That single, two-word seed has now dramatically and irrevocably shaped your entire performance. You are no longer just a generic "nervous scientist"; you are now a nervous scientist whose creation is on the loose. Every subsequent word you improvise will be conditioned by that starting point. You have been placed on a specific narrative track, and deviating from it is now nearly impossible.

This is the essence of the **Response Prefilling Strategy**. It is a subtle, technically-focused, and yet astonishingly powerful technique for exerting fine-grained control over an AI's output. It moves beyond simply giving instructions in the user prompt and takes the audacious step of writing the very first word or characters of the AI's own response. By "seeding" the assistant's turn, you are not just providing a hint; you are setting the starting block for its predictive race, making your desired outcome the most statistically probableâ€”and often the only possibleâ€”path forward.

## 21.2 The Rationale: Hacking the Predictive Engine

To understand why prefilling is so effective, we must once again return to the fundamental mechanism of an LLM: it is a next-token prediction engine. Its entire world is a sequence of text, and its only goal is to predict what comes next.

When you interact with a model via an API, you typically provide a list of messages, each with a \`role\` (\`system\`, \`user\`, or \`assistant\`). The crucial insight is this: the model sees this entire list as a single, continuous prompt that it must complete. The \`assistant\` role is not just a label; it is a signal that the text to follow should be in the AI's voice.

When you leave the \`assistant\`'s content empty, you are asking the model, "Given the system prompt and the user's message, what is the most likely first word of my response?" The model might predict "Certainly," or "Here is," or any number of conversational preambles.

But when you **prefill** the \`assistant\`'s content, you are changing the question entirely. If you prefill it with an opening brace \`{\`, you are now asking the model, "Given the system and user messages, and knowing that *my response has already started with '{'*, what is the most likely character to come next?"

The answer to that question is overwhelmingly likely to be a double quote \`"\` to start a JSON key. You have effectively set the model on the "JSON track." It is now statistically trapped. Its predictive engine is forced to continue generating a syntactically valid JSON object because any other path would be a wildly improbable continuation of the text you have already started for it. This is not a suggestion; it is a form of cognitive coercion.

## 21.3 How to Implement Response Prefilling: The API-Level Technique

Response prefilling is an API-level strategy. It requires you to construct the message payload yourself, rather than simply typing into a chat UI.

The implementation is simple: in your list of messages sent to the API, you create a final message with the \`role\` set to \`assistant\` and provide the initial characters of your desired response as its \`content\`.

**Example: Forcing a JSON Output**

\`\`\`python
# A simplified Python example of an API call payload
messages_payload = [
    {
        "role": "user",
        "content": "Extract the name, ID, and email from this text: 'Contact John Smith (ID: 123) at john@email.com'."
    },
    {
        "role": "assistant",
        "content": "{"  # This is the prefill. We've started the JSON object.
    }
]

# The model's completion will now almost certainly be the rest of the JSON object,
# e.g., '"name": "John Smith", "id": 123, "email": "john@email.com"}'

\`\`\`

**A Critical Gotcha: No Trailing Whitespace**
Most APIs will reject a prefilled \`assistant\` message that ends with a space or other whitespace character. This is a common and frustrating error for newcomers. The prefill must be a clean sequence of non-whitespace characters.

- **Correct:** \`{"role": "assistant", "content": "{"}\`
- **Incorrect (will cause an error):** \`{"role": "assistant", "content": "{ "}\`

## 21.4 A Toolkit of Prefilling Applications

This technique is a versatile tool for controlling various aspects of the AI's output.

### 21.4.1 Forcing Structured Data (The Primary Use Case)

This is the most common and powerful application. It is the most reliable way to get a clean, parsable, structured output without any conversational wrapping.

- **Goal:** Get a JSON object.
    - **Prefill:** \`{\`
- **Goal:** Get a JSON array (list).
    - **Prefill:** \`[\`
- **Goal:** Get an XML document.
    - **Prefill:** \`<\` (or a more specific opening tag like \`<response>\`)

This technique almost entirely eliminates the "Here is the JSON you requested..." problem, as starting the response in that way would be an improbable continuation of \`{\`.

### 21.4.2 Maintaining Character in Roleplay

Deep into a long conversation, an AI can sometimes "forget" its assigned persona and revert to its default helpful assistant mode. A prefill can be a powerful and token-efficient way to snap it back into character.

- **Scenario:** Fifty turns into a conversation where the AI is roleplaying as Sherlock Holmes.
- **User Prompt:** \`"What do you deduce about the owner of this muddy shoe?"\`
- **Prefill:** \`[Sherlock Holmes]:\`
- **Result:** The model is now strongly conditioned to continue speaking in the persona's voice, rather than starting with "As an AI assistant..."

### 21.4.3 Triggering Chain-of-Thought

You can provide a stronger impetus for a Chain-of-Thought response by starting the reasoning process yourself.

- **User Prompt:** \`"A class has 30 students. 60% are girls. 50% of the girls wear glasses. How many girls in the class wear glasses? Think step by step."\`
- **Prefill:** \`Okay, let's break this down into logical steps. Step 1:\`
- **Result:** The model is now locked into a step-by-step format, often more reliably than with the user-prompt instruction alone.

### 21.4.4 Guiding Tone and Style

The opening words of a response often set the tone for the entire text. You can pre-determine this tone with a prefill.

- **User Prompt:** \`"Explain the recent downturn in the stock market."\`
- **Prefill for a Formal Tone:** \`From a macroeconomic perspective, the recent market volatility can be attributed to several key factors. First,\`
- **Prefill for a Simple Tone:** \`Basically, what happened was that a few big things all went wrong at once.\`

## 21.5 Limitations and Best Practices

1. **It is a Supplement, Not a Substitute:** Prefilling is the final nudge, the ultimate steering mechanism. It is not a replacement for a well-crafted system prompt and a specific, detailed user prompt. The core instructions should still be in the user message. The prefill is for controlling the *form* of the immediate response.
2. **Be Careful Not to Over-Constrain:** If your prefill is too long or specific, you might prevent the model from discovering a better or more creative way to answer the question. A single \`{\` is a powerful constraint on format but leaves the content open. Prefilling an entire sentence might be too restrictive.
3. **Know Your API:** This is a feature of the underlying API and may not be exposed in all user interfaces. It is a tool for developers and advanced users who are building applications on top of the models.

## 21.6 Conclusion: The Ultimate Nudge

The Response Prefilling Strategy is the prompt engineer's "Jedi mind trick." It is a subtle, precise, and almost irresistibly powerful technique for directing an AI's output. By understanding that you can set the starting conditions for the model's own predictive process, you gain a level of control that is simply not possible through user-level instructions alone.

It is the key to building truly robust and automated systems. It guarantees the format, enforces the persona, and kick-starts the reasoning process with unparalleled reliability. While it requires a deeper, API-level interaction with the model, mastering this strategy is a hallmark of an engineer who has moved beyond simply conversing with an AI and has begun to truly program its behavior.

# Chapter 22: The Parameter Tuning Strategy: Engineering Behavior with Temperature, Top-K, and Top-P

## 22.1 The Director's Final Touch: From Script to Performance

Throughout this guide, we have focused almost exclusively on the art of crafting the prompt itselfâ€”the text that serves as the script for our AI actor. We have learned to write a detailed character brief (the System Prompt) and precise, scene-by-scene instructions (the User Prompts). We have mastered the script. But a script, no matter how brilliant, is only one half of a performance. The other half is the directionâ€”the nuance, the style, the interpretation.

This is where we must look beyond the text of the prompt and turn our attention to the control panel of the AI itself. The **Parameter Tuning Strategy** is the practice of manipulating the core settings of the Large Language Model's generation process to engineer its fundamental behavior. These parametersâ€”most notably \`temperature\`, \`top_k\`, and \`top_p\`â€”are not about *what* the AI says, but *how* it says it. They are the dials that control the trade-off between creativity and coherence, between deterministic precision and exploratory randomness.

If the prompt is the script, then tuning these parameters is the final act of direction. It is how you tell the actor to either stick to the script with absolute fidelity or to improvise with creative flair. Mastering this final layer of control is what separates a good prompter from an elite AI systems engineer.

## 22.2 The Rationale: Peeking Inside the Predictive Mind

To effectively tune these parameters, one must first understand the fundamental process they control. As we know, an LLM is a next-token prediction engine. But it does not simply choose *one* "best" next word. Instead, at every step, it performs a two-stage process:

1. **Probability Distribution:** The model looks at the entire preceding text and calculates a probability score for every single word (or token) in its vast vocabulary. This creates a massive list of potential next words, each with an associated likelihood. For example, after "The sky is," the token "blue" might have a 40% probability, "gray" a 15%, "vast" a 5%, and "on" a 0.001%.
2. **Sampling:** From this probability distribution, the model must then choose just one token to be the actual output. This is the sampling step, and it is here that the parameters exert their influence. Instead of always picking the single most probable word (a method known as "greedy decoding"), the sampling process can introduce a controlled amount of randomness, allowing less likely but still plausible words to be chosen.

The parameters \`temperature\`, \`top_k\`, and \`top_p\` are all different methods for manipulating and controlling this sampling process. They are the tools we use to shape the model's probabilistic behavior to suit our specific needs.

## 22.3 The Toolkit of Behavioral Engineering

### 22.3.1 Temperature: The Creativity and Risk Dial

**Temperature** is the most common and intuitive parameter. It directly controls the randomness of the sampling process.

- **Analogy:** Think of temperature as the "risk" or "creativity" dial, ranging from 0.0 to a theoretical maximum (often 2.0).
- **Mechanism:** Temperature works by mathematically rescaling the probability distribution before the sampling occurs.
    - **Low Temperature (e.g., 0.0 to 0.3):** This makes the distribution "sharper" or more "peaked." The model becomes more confident and deterministic. It will almost always choose the highest-probability tokens. A temperature of **0.0** is "greedy decoding"â€”it will *always* pick the single most likely token, resulting in the most predictable and repeatable output.
    - **High Temperature (e.g., 0.8 to 1.2):** This "flattens" the distribution, making less likely words more probable than they originally were. The model becomes more "adventurous," creative, and random. It is more willing to take a chance on a surprising or novel word choice.
- **Strategic Use Cases:**
    - **Use LOW Temperature (0.0 - 0.2) for:**
        - **Factual Recall & Q&A:** When there is one correct answer, you want maximum precision and no creative deviation.
        - **Summarization & Extraction:** To ensure the output sticks closely to the source text.
        - **Production Code Generation:** For predictable, reliable, and bug-free code.
        - **Tasks requiring high reliability and consistency.**
    - **Use HIGH Temperature (0.7 - 1.0) for:**
        - **Creative Writing:** Generating poetry, stories, or marketing slogans where novelty is desired.
        - **Brainstorming:** Creating a diverse list of ideas.
        - **Chatbot Persona:** Giving a chatbot a more lively, less robotic personality.

### 22.3.2 Top-K: The "Whitelist" of Options

**Top-K** sampling provides a different way to control randomness by limiting the pool of candidate tokens *before* sampling.

- **Analogy:** Think of Top-K as creating a "whitelist" or a "shortlist" of the best options.
- **Mechanism:** \`top_k\` is an integer that tells the model to consider only the *k* most probable tokens for the next step. All other tokens are completely discarded (their probability is set to zero), and the model then samples from this reduced pool.
    - \`top_k=1\` is identical to greedy decoding (temperature 0.0).
    - \`top_k=50\` means that at each step, the model will only consider the 50 most likely next words, regardless of their actual probability scores.
- **Strategic Use Cases:**
    - Top-K is primarily a tool for **reining in the chaos of a high temperature**. By setting a \`top_k\`, you can use a high temperature to encourage creativity among the *good* options, while preventing the model from choosing a truly bizarre, nonsensical word from the long tail of the probability distribution. It acts as a safety net against excessive randomness.
    - The main drawback of Top-K is that it is not adaptive. It might cut off a "surprisingly good" but less probable word if it falls outside the fixed \`k\` limit.

### 22.3.3 Top-P (Nucleus Sampling): The "Probability Budget"

**Top-P**, also known as Nucleus Sampling, is often considered a more sophisticated and adaptive alternative to Top-K.

- **Analogy:** Think of Top-P as sampling from a "probability budget."
- **Mechanism:** \`top_p\` is a float between 0.0 and 1.0. It tells the model to create the smallest possible pool of candidate tokens whose cumulative probability is greater than or equal to \`p\`. The model then samples from this "nucleus" of high-probability tokens.
    - The key difference from Top-K is that the size of the pool is **dynamic**.
    - If the model is very **confident** about the next word (e.g., "blue" has a 95% probability after "The sky is"), and \`top_p=0.9\`, the pool might only contain one or two words.
    - If the model is **uncertain** (e.g., at the start of a poem, many words have a low probability), the pool might contain dozens of words to meet the 90% cumulative probability budget.
- **Strategic Use Cases:**
    - Top-P is an excellent general-purpose parameter for balancing creativity and coherence. It allows for a wide range of choices when the path forward is ambiguous (encouraging creativity) but becomes highly deterministic when the path is clear (ensuring coherence).
    - Many practitioners prefer \`top_p\` over \`top_k\` for most creative tasks because of its adaptive nature. A setting of \`top_p=0.9\` is a very common and effective starting point.

## 22.4 The Interplay: Recipes for Behavioral Control

These parameters are not used in isolation. They are combined to achieve nuanced control. The typical order of operations is: \`top_k\` and \`top_p\` filter the candidate pool, and then \`temperature\` is applied to sample from that final pool.

Here are some common "recipes" for engineering specific AI behaviors:

- **The Factual Analyst (Maximum Precision):**
    - \`temperature: 0.0\`
    - \`top_k\`: (irrelevant)
    - \`top_p\`: (irrelevant)
    - **Result:** The model will always produce the most statistically likely output. It will be highly consistent and deterministic, but utterly devoid of creativity.
- **The Creative Poet (Maximum Imagination):**
    - \`temperature: 0.9\`
    - \`top_k\`: 0 (disabled)
    - \`top_p: 0.95\`
    - **Result:** The model will be highly creative and surprising. The high \`top_p\` allows for a wide range of word choices, and the high \`temperature\` encourages the model to pick less obvious ones.
- **The Controlled Brainstormer (Balanced Creativity):**
    - \`temperature: 0.75\`
    - \`top_k: 50\`
    - \`top_p\`: 1.0 (disabled)
    - **Result:** The model is creative (\`temperature > 0.7\`) but is prevented from going completely off the rails by the \`top_k=50\` safety net, which filters out truly bizarre options.
- **The Reliable Generalist (Default Starting Point):**
    - \`temperature: 0.7\`
    - \`top_k\`: (disabled)
    - \`top_p: 0.9\`
    - **Result:** A good, balanced configuration that is suitable for a wide variety of tasks. It is creative but not excessively random, thanks to the adaptive nature of \`top_p\`.

## 22.5 Conclusion: The Final Layer of Command

The Parameter Tuning Strategy represents the final and most direct layer of behavioral control. While the prompt text shapes the model's knowledge and intent, the parameters shape its very personalityâ€”its tendency towards rigor or randomness, precision or poetry.

An elite prompt engineer understands that their job does not end when they finish writing the prompt. They must also consider the optimal performance characteristics for the task at hand. By thoughtfully selecting the right combination of temperature, Top-K, and Top-P, you can fine-tune the AI's predictive mind, ensuring that its output is not only correct in content but also perfectly aligned in character with the needs of your application. This is the ultimate expression of engineering the AI's behavior.

# Chapter 23: The Long Context Strategy: Optimizing for Prompts with Large Volumes of Data

## 23.1 A New Frontier: The Ocean of Context

For years, a fundamental constraint has shaped the entire discipline of prompt engineering: the limited size of the context window. Prompts were measured in a few thousand tokens, forcing engineers to become masters of compression, summarization, and complex external workflows like Retrieval-Augmented Generation (RAG) to feed necessary information to the AI.

The advent of massive context windowsâ€”ranging from 100,000 to over a million tokensâ€”represents a paradigm shift. The door has been thrown open. It is now theoretically possible to place an entire novel, a dense quarterly report, a full codebase, or hours of meeting transcripts directly into a single prompt. The promise is intoxicating: an AI with perfect, instantaneous recall of a vast and immediate body of knowledge.

However, this new frontier is not a paradise of simplicity. It is a vast ocean, and navigating it requires a new set of skills. The naÃ¯ve approachâ€”simply dumping terabytes of raw text into a prompt and hoping for the bestâ€”is a recipe for failure. The AI, faced with this overwhelming flood of information, can easily get lost. The crucial detail you need becomes a single, proverbial needle in a colossal haystack. The **Long Context Strategy** is the art and science of structuring and managing these massive prompts to ensure the AI can not only access the information within them but also reason over it effectively and reliably.

## 23.2 The NaÃ¯ve Approach and Its Inevitable Failures

Let's first diagnose the problems that arise when a long context prompt is not optimized.

1. **The "Lost in the Middle" Problem:** Extensive research has shown that an LLM's attention is not evenly distributed across a long context window. It pays the most attention to the information presented at the **very beginning** and the **very end** of the prompt. Information buried deep in the middle of a long document is far more likely to be overlooked or ignored. Simply pasting a 100-page document and then asking a question about a detail on page 50 is a high-risk gamble.
2. **Attention Dilution:** The more information you provide, the more the model's finite "attention" is diluted. If 99% of the provided text is irrelevant to your specific question, the model has to expend significant computational effort to filter out the noise and identify the signal. This can lead to slower response times and a higher chance of focusing on the wrong details.
3. **Increased Latency and Cost:** Long context prompts are computationally expensive. Processing hundreds of thousands of tokens takes significantly more time and incurs higher API costs than a concise prompt. Every token counts, and inefficiently structured prompts waste both time and money.
4. **The Risk of Contradiction and Confusion:** Large volumes of text, especially from multiple sources, often contain conflicting or subtly different information. An unstructured data dump can confuse the model, leading it to produce a hedged, vague, or self-contradictory answer as it tries to reconcile all the information it has been given.

## 23.3 The Rationale: Working with the Grain of AI Attention

To build effective long context strategies, we must architect our prompts in a way that works *with* the model's natural attention patterns, not against them. The core principle is to make it as easy as possible for the AI to find and focus on the most relevant information. We must shift our role from that of a data dumper to that of an expert librarian, carefully curating and indexing the information before handing it to the researcher.

## 23.4 A Toolkit of Long Context Optimization Strategies

### 23.4.1 Principle 1: The "Instructions Last" Rule (The Recency Bias Lever)

This is the single most important and effective principle for long context prompting. Due to the model's strong recency bias, the information it sees last has the most influence on its immediate output.

**Therefore, you must always place your core instruction, question, or task at the very end of the prompt, *after* all the supporting documents and data have been presented.**

- **Ineffective Structure:**\`[INSTRUCTION] -> [DOCUMENT A] -> [DOCUMENT B] -> [DOCUMENT C]\`
- **Highly Effective Structure:**\`[DOCUMENT A] -> [DOCUMENT B] -> [DOCUMENT C] -> [INSTRUCTION]\`

By placing the instruction last, you are focusing the model's attention on its immediate goal right at the moment of generation, ensuring it approaches the vast context with a clear and present objective.

### 23.4.2 Principle 2: The Structural Imperative (The Librarian's Index)

As we discussed in Chapter 9, structure is control. In a long context prompt, it is absolutely essential. Do not just paste raw text. You must act as a librarian, cataloging and indexing your sources with clear, descriptive XML tags.

- **Why it works:** This creates a "mental map" for the AI. It helps the model to differentiate between sources, understand the type of information each contains, and reference them more accurately.
- **Example of a Structured Data Dump:**\`<documents> <document source="Q3_Earnings_Call_Transcript.txt" date="2023-10-26"> <content> [Full text of the transcript...] </content> </document> <document source="Internal_Marketing_Strategy_Memo.pdf" date="2023-09-15"> <content> [Full text of the memo...] </content> </document></documents>\`

### 23.4.3 Principle 3: The Active Retrieval Step (Forcing the Search)

To combat the "lost in the middle" problem, you can force the model to actively scan the entire context *before* it attempts to synthesize an answer. You do this by creating a two-part instruction.

- **Why it works:** This pre-processing step forces the model's attention mechanism to sweep through the entire document looking for specific keywords or concepts. The extracted snippets then form a new, much smaller, and highly relevant context from which the model can formulate its final answer.
- **Example of an Active Retrieval Prompt:**\`[Vast amount of medical research text pasted here...]\`
    
    \`### INSTRUCTIONS ###**Part 1: Quote Extraction**First, carefully review all the provided documents. Find and extract every sentence that discusses the side effects of the drug 'Exemplar'. Place these exact sentences, along with their source document name, inside <quotes> tags.\`
    
    - \`*Part 2: Synthesis**Now, using ONLY the information you gathered in the <quotes> tag, write a concise summary of the known side effects of 'Exemplar'.\`

### 23.4.4 Principle 4: The Indexing and Summarization Preamble (The Abstract)

For exceptionally large or numerous documents, you can provide the model with a roadmap at the very beginning of the prompt.

- **Why it works:** By providing a concise summary or a table of contents of the documents you are about to provide, you are giving the model a high-level index. This "abstract" primes the model, helping it to anticipate the structure and content of the data and locate information more efficiently.
- **Example of a Preamble:**\`I am providing you with three documents to analyze:1. **Document 1:** The 2023 Annual Financial Report, focusing on revenue and profit.2. **Document 2:** A competitive analysis of our top three rivals.3. **Document 3:** The transcript of our recent strategic planning offsite.\`
    
    \`Your task will be to synthesize a strategic recommendation based on these documents. The full text of the documents follows below.\`
    
    \`<document_1>... </document_1><document_2>... </document_2><document_3>... </document_3>\`
    
    \`### FINAL TASK ###[Instruction placed at the end]\`
    

## 23.5 A Practical Walkthrough: The Elite Long Context Prompt

Let's combine these principles to create a gold-standard prompt for a complex, multi-document analysis task.

- **NaÃ¯ve, Ineffective Prompt:**\`"Summarize the main risks for our company based on these three documents.[Paste 50 pages of Document A][Paste 30 pages of Document B][Paste 20 pages of Document C]"\`
- **Elite, Optimized Long Context Prompt:**\`I am providing three key documents for a risk analysis.**Source 1:** The annual financial report.**Source 2:** The latest cybersecurity audit.**Source 3:** A collection of recent customer feedback.\`
    
    \`The full text of these documents is provided below, enclosed in XML tags.\`
    
    \`<source name="Annual Financial Report">[...50 pages of text...]</source>\`
    
    \`<source name="Cybersecurity Audit">[...30 pages of text...]</source>\`
    
    \`<source name="Customer Feedback">[...20 pages of text...]</source>\`
    
    \`### FINAL INSTRUCTIONS ###You are a Chief Risk Officer preparing a briefing for the Board of Directors.Your task is to identify the top 3 strategic risks facing the company, based *only* on the information provided in the sources above.\`
    
    \`Follow this two-step process:1.  **Evidence Extraction:** First, for each of the three risk categories (Financial, Cybersecurity, Reputational), find and extract up to three direct quotes from the provided sources that best exemplify that risk. You must cite the source name for each quote.2.  **Executive Summary:** After extracting the evidence, write a concise executive summary. The summary should list the three risks you identified and, for each risk, provide a brief explanation of its potential impact, using the evidence you extracted.\`
    

## 23.6 Conclusion: The Curator of Context

The advent of massive context windows does not simplify prompt engineering; it makes it a more sophisticated discipline. It shifts the engineer's role from a writer of concise instructions to a curator of vast information landscapes.

Success in this new paradigm is not about how much data you can provide, but about how well you can structure, index, and guide the AI's attention within that data. By embracing the principles of placing instructions last, building a structural map, forcing active retrieval, and providing a guiding preamble, you can transform the colossal haystack of a long context prompt into a well-organized, searchable library. This is the key to unlocking the full, game-changing potential of large-scale, in-context reasoning.

# Chapter 24: The Code Prompting Strategy: Best Practices for Generation, Debugging, and Translation

## 24.1 The New Pair Programmer: AI as a Software Development Collaborator

The advent of powerful, code-fluent Large Language Models has irrevocably altered the landscape of software development. These models, trained on a colossal corpus of open-source code from repositories like GitHub, have ingested billions of lines of code across dozens of programming languages. They have learned not just the syntax and grammar, but the patterns, idioms, best practices, and even the common mistakes that define the craft of programming.

This presents a revolutionary opportunity. The AI is no longer just a tool for answering questions *about* code; it is a tool for actively writing, analyzing, and transforming code. It is the new, tireless pair programmerâ€”a collaborator with encyclopedic knowledge, available 24/7 to accelerate the development lifecycle.

However, like any powerful tool, its effectiveness is entirely dependent on the skill of the operator. A lazy or ambiguous request will yield code that is generic, inefficient, insecure, or simply wrong. The **Code Prompting Strategy** is the specialized discipline of crafting precise, context-rich, and constraint-aware prompts to harness the full potential of the AI as a software engineering partner. This chapter will provide a systematic framework for the three core tasks in this domain: code generation, debugging, and translation.

## 24.2 The Rationale: Why AI Excels at the Language of Logic

Code, in its essence, is a language. It is a language with a far stricter and more logical grammar than human prose. This structural rigidity is precisely what makes it an ideal domain for LLMs.

- **Pattern Recognition:** Software development is deeply pattern-based. Design patterns, architectural styles, and common algorithms are repeated across millions of projects. The LLM excels at recognizing these patterns and applying them to new problems.
- **Vast Knowledge Base:** The model has seen more code than any human ever could. It has seen the same problem solved in a hundred different ways, in a dozen different languages. A good prompt is a precise query into this vast, implicit knowledge base.
- **Syntactic Perfection:** While the model might make logical errors, it rarely makes syntactic ones. It can generate boilerplate code, function signatures, and complex data structures with perfect syntax, freeing the human developer to focus on the higher-level logic.

## 24.3 Code Generation: The Architect's Blueprint

Code generation is the act of creating new code from a natural language specification. The primary challenge is to move from a vague idea to a robust, production-ready implementation. This requires treating the prompt not as a request, but as a formal **technical specification**.

### Principle 1: Provide the Full Operational Context

Never ask for code in a vacuum. The AI must understand the environment in which the code will live.

- **Environment:** Specify the programming language, version, and any relevant frameworks or libraries (e.g., "Python 3.11 using the FastAPI framework," "React 18 with TypeScript").
- **Constraints:** State any limitations. This is one of the most powerful levers for controlling the output. Examples:
    - "Must use only the Python standard library."
    - "The solution must not use recursion."
    - "The function must have a time complexity of O(n) or better."
- **Purpose:** Explain the "why." Code for a high-traffic e-commerce checkout has different requirements than a one-off data analysis script.

### Principle 2: Decompose the Logic Step-by-Step

Use a Chain-of-Thought approach to outline the required functionality. This forces the AI to build the code in a logical, structured manner.

- **Prompt Snippet:**\`"Generate a function that performs the following steps:1. Accepts a file path as an argument.2. Opens and reads the content of the file.3. Counts the frequency of each word in the text.4. Returns a dictionary where keys are words and values are their counts."\`

### Principle 3: Specify the "Non-Functional" Requirements

Elite code prompting goes beyond the logic to define the characteristics of high-quality, professional code. Explicitly demand these features.

- **Documentation:** "The function must include a comprehensive docstring in the Google Python Style."
- **Error Handling:** "The code must include robust error handling. Specifically, add a \`try...except\` block to handle \`FileNotFoundError\` and \`PermissionError\`."
- **Type Hinting:** "All function arguments and return values must have full type hints."
- **Testing:** "After writing the function, generate a set of three unit tests for it using the \`pytest\` framework. The tests should cover a normal case, an empty file, and a file that doesn't exist."

### Gold-Standard Generation Prompt

- **Weak Prompt:** \`"Write a Python function to parse a log file."\`
- **Elite Prompt:**\`"I am building a server monitoring tool in Python 3.10.\`
    - \`*Task:** Write a Python function named \\\\\`parse_log_entry\\ \`that takes a single log line string as input and extracts the timestamp, log level, and message.The log format is: \\\\\`[YYYY-MM-DD HH:MM:SS] [LEVEL] Message\\\`\`
    - \`*Requirements:**1. The function must use Python's \\\\\`re\\ \`(regex) module.2. It must return a dictionary with three keys: 'timestamp', 'level', and 'message'.3. It must include full type hints for the argument and the return value (which should be a TypedDict or a regular dict).4. It must be wrapped in a \\\\\`try...except\\ \`block to handle lines that do not match the format, returning \\\\\`None\\ \`in case of a mismatch.5. It must include a complete docstring explaining its function, arguments, and return value.6. After the function, provide a simple \\\\\`pytest\\ \`unit test to verify its correctness with a sample log line."\`

## 24.4 Code Debugging: The Surgeon's Diagnosis

Debugging is an analytical task. The AI's role is to act as a diagnostic expert. To do this effectively, it needs all the evidence.

### Principle 1: Provide the Complete Case File

A doctor cannot diagnose a patient over the phone with a vague description of "it hurts." An AI cannot debug code with just a snippet. You must provide the full context.

- **The Exact Code:** The smallest, self-contained, reproducible example of the code that is failing.
- **The Full Error Message:** This is non-negotiable. Paste the *entire* traceback, from the first line to the last. It contains crucial clues about the execution stack.
- **The Environment:** The language, version, and libraries in use.
- **The Expected vs. Actual Behavior:** Clearly state, "I expected the output to be [X], but the actual output is [Y]."

### Principle 2: Guide the Diagnostic Process

Do not just ask for a fix. Command the AI to reason through the problem like an expert.

- **Prompt Snippet:**\`"My goal is to debug the following code.*Step 1: Explain the Error.** First, explain what the traceback message \\\\\`TypeError: can only concatenate str (not "int") to str\\ \`means in the context of my code.*Step 2: Trace the Fault.** Second, trace the execution path and identify the exact line and variable that is causing this type mismatch.*Step 3: Propose and Explain the Fix.** Third, provide the corrected code and explain why the change resolves the error."\`

### Gold-Standard Debugging Prompt

- **Weak Prompt:** \`"Why is my code broken? \\\\\`for i in range(5): print('Number: ' + i)\\\`"\`
- **Elite Prompt:**\`"I am running the following Python 3.9 script and getting an error.\`
    - \`*Code:**\\\\\`\\\`\\\\\`python \`\`for i in range(5): \`\` print('Number: ' + i) \`\`\\\`\\\\\`\\\`\`
    - \`*Error Traceback:**\\\\\`\\\`\\\\\`  \`\`Traceback (most recent call last): \`\` File "[main.py](http://main.py/)", line 2, in <module> \`\` print('Number: ' + i) \`\`TypeError: can only concatenate str (not "int") to str \`\`\\\`\\\\\`\\\`\`
    - \`*Expected Behavior:** I expected it to print "Number: 0", "Number: 1", etc.*Actual Behavior:** It throws a TypeError.\`
    - \`*Task:**1. Explain the \\\\\`TypeError\\ \`in plain English.2. Identify the root cause of the error in my code.3. Provide the corrected, working code using an f-string, which is the modern best practice."\`

## 24.5 Code Translation: The Expert Linguist's Work

Translating code is a migration task fraught with peril. A literal, line-by-line translation often results in code that is syntactically correct but inefficient, insecure, or "unpythonic" / "un-javascripty." The goal is not just translation, but **idiomatic adaptation**.

### Principle 1: Demand Idiomatic Code

This is the most important concept in code translation. You must explicitly command the model to write code that feels "native" to the target language.

- **Prompt Snippet:**\`"Translate the following Python code into idiomatic JavaScript (ES6+). Do not perform a literal, line-by-line translation. Instead, adapt the logic to use modern JavaScript patterns, such as \\\\\`async/await\\ \`instead of Promises, and \\\\\`map\\ \`or \\\\\`filter\\ \`instead of for-loops where appropriate."\`

### Principle 2: Manage the Dependency Mapping

A huge part of translation is mapping libraries and frameworks. Guide the AI in this process.

- **Prompt Snippet:**\`"The source Python code uses the \\\\\`requests\\ \`library for making HTTP calls. The target is Node.js. In the translated code, use the \\\\\`axios\\ \`library as the equivalent for \\\\\`requests\\\`."\`

### Gold-Standard Translation Prompt

- **Weak Prompt:** \`"Convert this Python to JavaScript."\`
- **Elite Prompt:**\`"**Task:** Translate a Python script to modern, idiomatic Node.js.\`
    - \`*Source (Python 3.9):**\\\\\`\\\`\\\\\`python \`\`import requests\`
    
    \`def get_user_data(user_id):    response = requests.get(f'<https://api.example.com/users/{user_id}>')    return response.json()\\\\\`\\\`\\\`\`
    
    - \`*Target (Node.js v18):**Translate the above Python function into an asynchronous JavaScript function.\`
    - \`*Requirements:**1. The translated code must use the \\\\\`axios\\ \`library to handle the HTTP GET request.2. The code must be idiomatic ES6+, using \\\\\`async/await\\ \`syntax.3. Include a basic JSDoc comment block for the translated function."\`

## 24.6 Conclusion: The Developer as Architect and QA

The Code Prompting Strategy does not replace the developer. It elevates them. It automates the laborious, pattern-based work of writing boilerplate, diagnosing common errors, and performing routine translations. This frees the human developer to focus on the tasks that truly require their expertise: system architecture, complex logical design, strategic decision-making, and the final, critical act of quality assurance.

By mastering the art of writing precise, comprehensive, and context-aware specifications in your prompts, you transform the AI from a simple code generator into a powerful, collaborative partner in the intricate and creative dance of software development.

# Chapter 25: The Automatic Prompt Engineering (APE) Strategy: Using AI to Generate and Optimize Prompts

## 25.1 The Meta-Problem: Prompting is Hard

Throughout this guide, we have explored the intricate art and science of prompt engineering. We have learned to be specific, to provide context, to structure our requests, and to guide the AI's reasoning. We have seen that crafting an elite prompt is a high-skill, iterative, and often time-consuming process. The irony is profound: we are expending significant human effort to optimize our communication with a machine designed to save us effort.

This naturally leads to a "meta-question": If Large Language Models are so adept at generating complex, structured text, could we turn this capability upon the problem of prompting itself? Could an AI be used to engineer the very prompts that guide another AI?

The answer is a resounding yes, and the formalization of this idea is known as the **Automatic Prompt Engineering (APE) Strategy**. This is a cutting-edge and meta-level technique that uses an LLM as a tool to generate and refine a diverse set of prompt candidates for a given task. It is the art of prompting an AI to become a prompt engineer.

## 25.2 The Core Idea: Framing Prompt Generation as a Synthesis Problem

The APE strategy re-frames the challenge of finding the best prompt. Instead of relying on a single human's intuition and iterative tinkering, it treats the problem as a search and optimization task. The goal is to explore a wide "prompt space" of possible instructions and then select the one that performs the best.

The process, at its core, involves a two-stage, AI-driven workflow:

1. **Prompt Generation (The "Instruction Induction" Phase):** An LLM (let's call it the **"Meta-LLM"**) is given a few examples of input-output pairs for a target task. It is then prompted to act as an AI researcher and "induce" a set of possible instruction prompts that could have produced those outputs from those inputs. It doesn't just generate one instruction; it is prompted to brainstorm a diverse set of candidates with different phrasings, structures, and levels of detail.
2. **Prompt Selection (The "Scoring" Phase):** The generated instruction candidates are then evaluated. In a fully automated system, each candidate prompt is used to query a separate, target LLM with a test input. The target LLM's output is then scored for quality against a desired "gold standard" output using an evaluation metric (or even another LLM acting as a judge). The instruction prompt that yields the highest score is declared the winner.

This strategy automates the creative and laborious process of prompt discovery, leveraging the AI's own linguistic and reasoning capabilities to find the most effective ways to instruct itself.

## 25.3 The Rationale: Why AI Can Out-Engineer a Human Prompter

Using an AI to generate prompts might seem circular, but it is effective for several key reasons.

1. **Diversity of Phrasing:** An LLM can brainstorm a far wider and more diverse range of syntactically and semantically different ways to phrase an instruction than a human can in a short amount of time. It can explore subtle variations in wording that a human might not consider, some of which may resonate more effectively with the target model's internal representations.
2. **Uncovering "Un-Human" Prompts:** Sometimes, the most effective prompts are not the ones that sound most natural to a human. They may contain specific keywords, phrasings, or structures that, for reasons related to the model's training data, are particularly potent at triggering the desired behavior. The APE process can discover these "un-human" but highly effective instructions.
3. **Scalability and Speed:** The APE process can be automated to generate and test hundreds of prompt candidates in the time it would take a human to manually iterate through a handful. This allows for a much more comprehensive search of the "prompt space."
4. **Alleviating Human Bottlenecks:** It frees up human engineers from the time-consuming task of prompt tinkering, allowing them to focus on the higher-level problems of defining the task, creating the evaluation criteria, and designing the overall system architecture.

## 25.4 A Practical Walkthrough: Finding the Best Prompt for a Chatbot

Let's imagine we are training a chatbot for an e-commerce store that sells band t-shirts. We want to find the best way to instruct the model to handle a customer's order.

**The Goal:** Find the best prompt for a task where the input is a customer request and the output is a standardized order summary.

### **Step 1: Define the Task with Examples**

First, we manually create a few high-quality input-output pairs that define our goal. These will be the foundation for the APE process.

- **Input 1:** \`"I'd like to order one Metallica t-shirt in size S."\`
- **Output 1:** \`Band: Metallica, Item: T-Shirt, Quantity: 1, Size: S\`
- **Input 2:** \`"Can you get me two small Ramones shirts?"\`
- **Output 2:** \`Band: Ramones, Item: T-Shirt, Quantity: 2, Size: S\`

### **Step 2: The Generation Phase (Using the "Meta-LLM")**

Now, we craft a prompt for our Meta-LLM. This prompt will ask it to generate a list of possible instruction prompts that could solve the task defined by our examples.

- **The APE Generation Prompt:**\`"I am an AI prompt engineer. I have a task where I need to take a user's request and turn it into a structured order summary. I will give you a few examples of the input and the desired output.\`
    
    \`<examples>Input: "I'd like to order one Metallica t-shirt in size S."Output: "Band: Metallica, Item: T-Shirt, Quantity: 1, Size: S"\`
    
    \`Input: "Can you get me two small Ramones shirts?"Output: "Band: Ramones, Item: T-Shirt, Quantity: 2, Size: S"</examples>\`
    
    \`Based on these examples, generate 10 diverse and high-quality instruction prompts that I could give to a large language model to make it perform this task. The instructions should be phrased in different waysâ€”some as direct commands, some by setting a persona, etc. Provide the list of generated instructions."\`
    
- **Possible Output from the Meta-LLM (A List of Candidate Prompts):**
    1. "Extract the band name, item type, quantity, and size from the user's request and format it as: Band: [band], Item: [item], Quantity: [qty], Size: [size]."
    2. "You are an e-commerce order processing bot. Your sole function is to parse a customer's message and output a structured summary of their order."
    3. "Given a customer's t-shirt order, identify the four key entities (Band, Item, Quantity, Size) and present them in a key-value format."
    4. "Convert the following natural language order into a structured data string."
    5. ... and so on.

### **Step 3: The Selection Phase (Scoring the Candidates)**

Now we have a list of 10 promising prompts. The next step is to find out which one works best.

- **Manual Approach:** A human engineer can take this list and manually test each of the 10 prompts with a new, unseen input (a "test case").
    - **Test Input:** \`"I need a large Rolling Stones tee."\`
    - The engineer would then run this test input with each of the 10 candidate prompts and subjectively judge which one produces the most accurate and reliable output.
- **Automated Approach:** In a more advanced setup, you would have a larger set of test cases. A script would programmatically:
    1. Loop through each of the 10 candidate prompts.
    2. For each candidate, loop through all the test cases.
    3. Execute an API call using the candidate prompt and the test input.
    4. Compare the AI's actual output to the known "correct" output for that test case.
    5. Calculate an accuracy score for each of the 10 candidate prompts.
    6. The prompt with the highest score is selected as the optimal one.

## 25.5 The "Power Prompt" Shortcut: A Simplified APE Workflow

A fully automated APE pipeline can be complex to set up. However, a simplified, manual version of this strategy can be incredibly useful for any prompt engineer. This is the "Power Prompt" or "Prompt Refinement" technique.

- **The Workflow:**
    1. Write your best initial attempt at a prompt.
    2. Feed that prompt to an AI with a meta-instruction.
- **Example Prompt Refinement Prompt:**\`"I am trying to write a good prompt for a task. My current draft is below.\`
    
    \`<my_prompt>"Summarize the text."</my_prompt>\`
    
    \`Your task is to act as an expert prompt engineer. Critique my prompt and then rewrite it to be a 'power prompt'. The rewritten prompt should be much more detailed, specific, and follow all the best practices for prompt engineering. It should ask for the summary to have a specific length, a target audience, and a particular format."\`
    

This technique uses the AI as a collaborative partner to improve your own work, automating the brainstorming process of prompt optimization.

## 25.6 Conclusion: Turning the Crank on Optimization

The Automatic Prompt Engineering strategy represents the next frontier of the discipline. It is the moment where the tools of AI are turned back upon themselves to optimize their own use. It embodies a shift from manual, intuitive artistry to a more systematic, data-driven, and scalable science of instruction design.

While a fully automated APE pipeline is an advanced application, the core principleâ€”using an AI to brainstorm, diversify, and refine promptsâ€”is a powerful technique that any practitioner can adopt. It is a testament to the recursive power of these models and a signal that the future of engineering AI systems will involve a deep and symbiotic partnership, where we not only guide the AI, but also leverage the AI to help us become better guides.

# Chapter 26: The Documentation Strategy: The Critical Discipline of Tracking and Versioning Prompts

## 26.1 The Ghost in the Machine: The Peril of the Undocumented Prompt

In the fast-paced, iterative world of prompt engineering, it is easy to get lost in the creative flow. You are in a chat window, rapidly testing variations of a prompt, tweaking a word here, adding a constraint there, until, finally, you achieve the perfect output. You copy the result, use it for your task, and move on, triumphant.

A week later, you need to perform the same task. You open a new chat window and try to remember the magic words you used. Was it "You are an expert" or "I am an expert"? Did you ask for a JSON object or a Markdown table? Was the temperature set to 0.2 or 0.7? The ghost of your perfect prompt haunts you, but its exact form is lost to the ephemeral history of a browser tab.

This is not a minor inconvenience; it is a catastrophic failure of process. An undocumented prompt is a non-existent asset. It is a piece of intellectual property that has vanished into the ether. For any serious application of AI, from a personal workflow to a production-grade system, a reactive, ad-hoc approach to prompting is unsustainable, unscalable, and unprofessional.

The **Documentation Strategy** is the critical, non-negotiable discipline of systematically tracking, versioning, and evaluating your prompts. It is the process of treating your prompts with the same rigor and respect as you would treat source code. It is the bridge between a one-off clever trick and a robust, repeatable, and maintainable AI-powered system.

## 26.2 The Rationale: Why Prompts Are Mission-Critical Code

It is a common mistake to view prompts as mere "input" or "configuration." This fundamentally misunderstands their role. In an AI-powered system, the prompt is the engine. It is the core logic that dictates the system's behavior. Therefore, it must be treated as a first-class citizen in your engineering lifecycle.

1. **Repeatability and Consistency:** A documented prompt guarantees that you can achieve the exact same high-quality result, every single time. It is the foundation of a consistent and predictable process.
2. **Collaboration and Knowledge Sharing:** When prompts are documented in a shared, structured format, they become a collective asset. A prompt perfected by one team member for a specific task can be discovered, adapted, and reused by others, preventing the constant reinvention of the wheel and accelerating the entire organization's AI maturity.
3. **Debugging and Troubleshooting:** When an AI system starts producing flawed outputs, the first question should be, "What changed?" Without a versioned history of your prompts, this question is impossible to answer. A well-documented prompt log allows you to see exactly which version of a prompt was used for a given task, making it infinitely easier to identify the root cause of a failure.
4. **Regression Testing and Model Upgrades:** LLM providers are constantly releasing new and updated models. A new model version, while generally more capable, can sometimes respond differently to the same prompt. A library of well-documented prompts, along with their expected "gold standard" outputs, forms a critical **regression test suite**. When a new model is released, you can programmatically run your key prompts against it to instantly identify any breaking changes or regressions in behavior.
5. **A Record of Your Learning:** The iterative process of prompt engineering is a process of discovery. Your documentation becomes a logbook of this journey. It shows what you tried, what worked, what didn't, and why. This record is an invaluable learning tool that helps you and your team become better, more effective prompt engineers over time.

## 26.3 The Anatomy of an Elite Prompt Document

Effective documentation is more than just saving the prompt text in a file. An elite prompt document is a comprehensive record that captures the entire context of the prompt's creation and execution. While the format can vary (a spreadsheet, a dedicated database, a text file in a Git repository), the essential components remain the same.

A comprehensive template for a single prompt record should include the following fields:

- **Prompt Name / ID:** A unique, human-readable name for the prompt (e.g., \`EmailSummarizer_ExecutiveBriefing_v2\`).
- **Version:** A clear version number (e.g., \`1.0\`, \`1.1\`, \`2.0\`). Use semantic versioning if possible.
- **Goal / Objective:** A one-sentence description of what this prompt is intended to achieve.
- **Author:** The person who created or last modified the prompt.
- **Date Created / Modified:** Timestamps for tracking its history.
- **Model(s) Used:** The specific model and version against which this prompt was tested and optimized (e.g., \`gpt-4-turbo-2024-04-09\`, \`claude-3-opus-20240229\`).
- **Parameters:** The exact generation parameters used:
    - \`Temperature\`
    - \`Top-P\`
    - \`Top-K\`
    - \`Max Tokens\`
- **Prompt Text (The Core Component):**
    - **System Prompt:** The full text of the system prompt, if applicable.
    - **User Prompt:** The full text of the user prompt. For templates, use clear placeholders (e.g., \`{{DOCUMENT_TEXT}}\`).
- **Example Input:** A representative example of the data that would be inserted into the prompt's placeholders.
- **Gold-Standard Output:** The ideal, "perfect" output that this prompt is expected to generate for the example input. This is crucial for evaluation and regression testing.
- **Actual Output:** The actual output generated by the model during the last test run.
- **Evaluation:** A field for scoring or qualitative assessment (e.g., \`OK\`, \`NOT OK\`, \`SOMETIMES OK\`, or a numerical score).
- **Notes / Rationale:** This is the most important field for learning and collaboration. It should explain the *why* behind the prompt's design. Why were certain words chosen? What did previous, failed versions look like? What trade-offs were made?

## 26.4 A Practical Workflow: Prompts in a Version Control System

For professional software development teams, the gold standard for managing prompts is to treat them exactly like source code: **store them in a version control system like Git.**

- **The "Prompt Library":** Create a dedicated directory in your project's repository called \`/prompts\` or \`/prompt_library\`.
- **Structured Storage:** Store each prompt in its own file. A good practice is to use a structured format like YAML or JSON to store the prompt's metadata alongside its text.

**Example: \`summarize_earnings_report.v1.yaml\`**

\`\`\`yaml
name: SummarizeEarningsReport
version: 1.0
author: Jane Doe
date: "2024-05-10"
goal: "Summarizes a quarterly earnings report for a non-technical executive audience."

model_settings:
  model_name: "claude-3-opus-20240229"
  temperature: 0.2
  max_tokens: 60000

prompt:
  system: "You are a senior financial analyst known for your ability to distill complex financial data into clear, concise business insights."
  user: |
    Analyze the following earnings report.

    <report_text>
    {{EARNINGS_REPORT}}
    </report_text>

    Your task is to produce a three-paragraph executive summary. The summary must focus on the business implications of the results, avoiding financial jargon. Conclude with the single most important question you would ask the CEO based on this report.

\`\`\`

- **The Power of Git:** By storing prompts in this way, you get all the benefits of version control for free:
    - **History:** You have a complete, auditable history of every change made to every prompt.
    - **Collaboration:** Team members can work on prompts in separate branches, submit pull requests for review, and leave comments.
    - **Integration:** Your application code can now load these prompt files directly, ensuring that the code and the prompts are always in sync.

## 26.5 Conclusion: From a Fleeting Art to an Enduring Asset

The Documentation Strategy is the discipline that elevates prompt engineering from a fleeting, conversational art form into a robust, scalable engineering practice. It is the act of capturing and preserving the intellectual property that you create every time you perfect a prompt.

An undocumented prompt is a liability. It is a single point of failure waiting to be forgotten. A well-documented, versioned prompt is an asset. It is a repeatable, maintainable, and improvable component of your intelligent system. Adopting a rigorous documentation strategy is the most important step you can take to ensure that your investment in prompt engineering pays lasting dividends, creating a foundation of quality and consistency that will support your AI-powered applications long into the future.

# Chapter 27: Conclusion: A Unified Framework for Elite Prompt Engineering

## 27.1 The End of the Beginning: From Tactics to a Unified Philosophy

We have journeyed through the intricate landscape of prompt engineering, moving from the foundational art of a simple question to the complex science of architecting multi-agent systems. We have dissected the anatomy of a prompt, mastered the distinction between a system's constitution and a user's directive, and collected a powerful toolkit of over a dozen distinct strategies. We have learned to guide the AI's reasoning, structure its output, and even command it to critique and correct itself.

Each chapter has presented a piece of the puzzle, a specific tactic for a specific challenge. Now, in this final chapter, we must assemble these pieces. The ultimate goal of an elite prompt engineer is not to merely possess a collection of disconnected tricks, but to operate from a **Unified Framework**â€”a coherent philosophy and a systematic approach that guides every interaction with an AI.

This framework is not a rigid set of rules, but a mental model for building intelligent, reliable, and powerful human-AI collaborations. It is built upon three core pillars: **Architecture**, **Conversation**, and **Discipline**.

## 27.2 Pillar 1: The Principle of Architecture

The first and most profound shift in mindset is to stop seeing prompts as isolated questions and to start seeing them as components in a larger **architecture**. An elite prompter is, first and foremost, a systems architect.

This means embracing a structured, top-down design process for every complex task:

1. **Deconstruct the Workflow:** Before writing a single word, deconstruct your complex goal into its constituent parts. Identify the distinct cognitive tasks required. Is there a phase for research? A phase for brainstorming? A phase for logical analysis? A phase for formatting? This deconstruction is the blueprint for your system.
2. **Choose Your Architectural Pattern:** Based on this blueprint, select the appropriate architectural pattern.
    - Is the task a simple, single-shot operation? A meticulously crafted **Zero-Shot Prompt** built on the principles of Context, Task, and Format will suffice.
    - Does it require a sequence of distinct, linear transformations? The **Prompt Chaining Strategy** is your assembly line.
    - Does it require the collaboration of different "mindsets" or expertises? The **Multi-Agent Strategy** is your expert team.
3. **Define the Foundation (The System Prompt):** For any persistent interaction, you must first architect the AI's "constitution." This is where you apply the **Persona Strategy**, instantiating an elite, expert identity for your collaborator. This is also where you apply the **Affirmative Direction Strategy**, defining the AI's core operational logic in positive, proactive terms. The system prompt is the unwavering foundation upon which the entire structure rests.

The architectural mindset forces you to think about focus, context isolation, and the flow of information. It is the practice of designing a clean, robust, and efficient "thought factory" before you ever ask it to produce a single thought.

## 27.3 Pillar 2: The Principle of Conversation

Once the architecture is in place, the interaction begins. This is where the architect puts on the hat of the director. The **Principle of Conversation** is the understanding that complex work is not a transaction, but a dialogue. It is an iterative process of steering, refining, and collaborating.

This pillar is built on the tactics of the **Constructive Guidance Strategy**:

1. **The First Output is a Draft:** Abandon the myth of the perfect first prompt. Treat the AI's initial response as a starting point, a block of marble ready to be sculpted.
2. **Steer with Precision:** Use the full toolkit of conversational steering. Provide **Constructive Feedback** instead of negative criticism. Use **Explicit State Management** to open and close tasks. When the conversation derails, use **Trajectory Correction via Editing** to clean the foundational context. For complex tasks, use the **Pre-Execution Calibration (Teach-Back) Method** to ensure alignment before work begins.
3. **Synthesize Advanced Reasoning Frameworks:** The conversation is where you deploy your most powerful reasoning tools.
    - When you need a transparent, logical deduction, you command a **Chain of Thought**.
    - When you need to explore multiple creative or strategic paths, you simulate a **Tree of Thoughts**, perhaps by instantiating a "committee of experts" within the dialogue.
    - When accuracy is paramount for a verifiable answer, you apply the **Self-Consistency Strategy**, running multiple conversational "takes" and seeking a consensus.

The conversational mindset is dynamic and adaptive. It is the recognition that the user is the prime mover, the active partner who guides the AI's immense potential toward a polished and perfect final product.

## 27.4 Pillar 3: The Principle of Discipline

Brilliant architecture and masterful conversation are fleeting if they are not captured and codified. The final pillar of the Unified Framework is **Discipline**. It is the professional practice that transforms prompting from a creative art into a reliable engineering discipline.

This pillar is embodied by two critical strategies:

1. **The Documentation Strategy:** You must treat your prompts as mission-critical assets. Every successful promptâ€”with its specific wording, its model, its parameters, and its rationaleâ€”must be documented, versioned, and stored in a shared, accessible library. An undocumented prompt is a lost asset; a documented prompt is a reusable, improvable, and scalable component of your organization's intellectual property.
2. **The Mindset of Iteration and Evaluation:** Elite prompt engineering is a scientific process. It involves forming a hypothesis (the prompt), running an experiment (querying the AI), and analyzing the result. This requires a commitment to testing, to building regression suites, and to continuously refining your library of prompts as models evolve. It requires the discipline to never assume that a prompt that works today will work tomorrow, and the rigor to prove its effectiveness through empirical evaluation.

The principle of discipline ensures that your hard-won successes are not one-off triumphs, but the foundation of a robust and ever-improving system.

## 27.5 The Unified Framework in Action: A Final Synthesis

Let us see how these three pillars come together to solve a final, complex problem.

**Goal:** Create a comprehensive, data-driven marketing strategy for a new product.

1. **Architecture:**
    - *Deconstruction:* The task requires research, ideation, strategic planning, and content creation.
    - *Architectural Pattern:* A **Multi-Agent System** is ideal.
    - *Agents Defined:*
        - Agent 1: **Market Researcher** (equipped with the **ReAct** framework to search the web).
        - Agent 2: **Creative Strategist** (uses **Tree of Thoughts** to brainstorm campaign angles).
        - Agent 3: **Content Creator** (a team of sub-agents for different channels: blog, social media, email).
        - Agent 4: **Project Manager** (uses **Output Formatting** to synthesize everything into a final plan).
    - *Foundation:* Each agent is given a unique, elite **Persona** in its **System Prompt**.
2. **Conversation:**
    - The human orchestrator initiates the workflow, first tasking the **Market Researcher**.
    - The Researcher's output (a data report) is reviewed. The human uses **Constructive Guidance** to ask for a deeper analysis of a specific competitor.
    - The refined report is passed to the **Creative Strategist**. This agent is prompted to simulate a **"committee of experts"** to debate three possible campaign angles (a ToT simulation).
    - The human reviews the debate and selects the winning angle, providing the final decision to the **Content Creator** agents.
    - Each Content Creator generates its draft. The human provides iterative feedback to refine the copy.
3. **Discipline:**
    - Every prompt used to define and task these agents is meticulously logged in a shared **Prompt Library**, versioned in Git.
    - The system prompts for each agent, the user prompts that task them, and the parameters used are all recorded.
    - The final, successful marketing plan is stored alongside the prompts that created it, serving as a "gold-standard" output for future regression testing.

## 27.6 Conclusion: The Prompt Engineer as the Human-AI Conductor

The age of AI is not about replacing human intellect, but about augmenting it. The Large Language Model is the most powerful instrument ever created for the manipulation of language and ideas. But an instrument, no matter how powerful, needs a musician.

The elite prompt engineer is that musicianâ€”or better yet, the conductor of an entire orchestra. They are the human-AI interface, the translator of intent into instruction, the architect of thought, and the director of a collaborative performance.

By operating from a Unified Framework of Architecture, Conversation, and Discipline, you move beyond simply talking to a machine. You begin to design, guide, and manage intelligent systems. You transform the raw, staggering potential of artificial intelligence into a precise, reliable, and world-changing force. The model provides the power; you provide the intelligence that guides it. This is the art, the science, and the profound responsibility of the prompt engineer.`
```


## src/config/prompts/systemPromptSlimRules.ts

```ts
// ç³»ç»Ÿæç¤ºè¯è§„åˆ™ - ç²¾ç®€ç‰ˆçš„ç²¾è‹±æç¤ºè¯å·¥ç¨‹æŒ‡å—
// è¿™æ˜¯åŸºäºã€ŠArchitecting Intelligenceã€‹çš„ç²¾ç®€ç‰ˆç³»ç»Ÿæç¤ºè¯å·¥ç¨‹è§„åˆ™

export const SYSTEM_PROMPT_SLIM_RULES = `# Architecting Intelligence: Elite Prompt Engineering Guide

## Chapter 1: Philosophy of Prompting
### 1.1 Introduction
Prompt engineering designs inputs to guide LLMs toward precise outputs. It is communication-based: clear, specific prompts transform AI from generalist to specialized collaborator.

### 1.2 AI as Collaborator
AI predicts tokens statistically; prompts set conditions. Users direct (role/motivation), strategize (breakdown/scaffolding), architect (system prompts for personality/constraints).

### 1.3 Benefits
- Precision: Reduces ambiguity/ revisions.
- Efficiency: Faster complex tasks.
- Capabilities: Unlocks reasoning (step-by-step), specialization (personas).
- Specialization: E.g., code reviewer to legal analyst.

### 1.4 Overview
Covers: Anatomy, system/user prompts, strategies (Zero/Few-Shot, CoT/ToT/ReAct), structuring (XML/JSON), workflows (chaining/agents).

## Chapter 2: Anatomy of Prompt
### 2.1 Pillars: Context, Task, Format
Context (who/why), Task (what), Format (how). Weak prompts assume; elite eliminate ambiguity.

### 2.2 Context
- **Role:** Activates patterns. Less: "Analyze statements." More: "You are CFO of B2B SaaS; analyze Q2 for burn risks/growth drivers."
- **Background:** Grounds facts. Less: "Marketing email." More: "Innovate Inc. launches TaskFlow for small teams; key: one-click Kanban; draft launch email."
- **Audience:** Calibrates tone. Less: "Explain quantum." More (kid): "To 5th grader: coin heads/tails analogy." More (tech): "Superposition for undergrad: qubits vs. classical."
- **Goal:** Prioritizes. Less: "Summarize contract." More: "As CEO, identify financial/IP risks/liabilities."

### 2.3 Task
- **Verbs:** "Generate/Analyze/Rewrite"; avoid "Help/Can you."
- **Chunking:** Numbered steps. Less: "Blog on remote work: productivity/balance/titles/CTA." More: "1. 5 SEO titles. 2. 400-word post: productivity/balance examples. 3. CTA for comments."
- **Specificity:** Details. Less: "Improve code." More: "Refactor Python: 1. List comp for loops. 2. Type hints. 3. Docstring."
- **Constraints:** Affirmative. Less: "Japan trip, no expensive." More: "7-day Tokyo/Kyoto, $2000 post-flights; culture/hiking; meals <$25."

### 2.4 Format
- **Naming:** "Bulleted list/JSON/Markdown table."
- **Few-Shot:** Input-output example. Less: "Sentiment." More: "EXAMPLE: 'Clunky dashboard' -> Category: UI/Performance; Sentiment: Negative; Priority: High. NOW: 'Love integration, add Hubspot.'"
- **Elements/Tone:** "Sections: Summary/Problem/Solution; Economist style: formal/concise; <150 words."

### 2.5 Synthesis
Basic: "Email on update." Elite: **[Context]** PM for Phoenix; API delay, workaround. **[Task]** 1. Progress. 2. Delay. 3. Cause (supplier issue). 4. Solution/date. **[Format]** Subject: 'Update & Date'; professional/reassuring; <200 words.

## Chapter 3: System vs. User Prompts
### 3.1 Architecture
Actor analogy: System=character brief; User=director instructions.

### 3.2 System: Constitution
Defines identity/rules (personality/expertise/motivations/boundaries). API: system role; persistent/high-level.

### 3.3 User: Directives
Task-specific/dynamic. API: user role; action-driven/contextual.

### 3.4 Synergy/Pitfalls
Harmony: System persona + User execution. Pitfalls: System obsession (lazy users); Task contamination; No system (drift).

## Chapter 4: Zero-Shot
### 4.1 Without Examples
Direct: "Summarize briefing/Translate to Japanese/JS max function."

### 4.2 Mechanism
Activates training patterns (e.g., article-summary pairs).

### 4.3 Strengths/Uses
Simplicity/efficiency. Summarization: "3 bullets from abstract." Translation: "Formal Spanish: 'Finalize by Friday.'" QA: "Primary Q3 decline cause." Classification: "Positive/Negative/Neutral: 'Intuitive but crashes.'" Style: "Professional: 'Hey, ASAP project.'" Code: "Array max."

### 4.4 Limits
Multi-step (bat/ball: $1.10 total, bat $1 more â†’ ball $0.05, not $0.10); novel formats; nuances (internal categories).

### 4.5 Elite
Apply C/T/F: Weak: "Email on Orion." Elite: **[Context]** PM kickoff for app redesign (15% retention). **[Task]** 1. Goal/metric. 2. Thursday 10AM. 3. Ideas/challenges. **[Format]** Energetic/collaborative; Subject: 'Kicking Off!'; Email only.

### 4.6 Base
First try; failures â†’ Few-Shot (format)/CoT (reasoning)/ReAct (knowledge).

## Chapter 5: Few/One-Shot
### 5.1 Showing
In-context learning: Examples infer rules.

### 5.2 Terms
Zero:0; One:1; Few:2-5 (3-5 optimal).

### 5.3 Mechanism
Examples as immediate pattern for prediction.

### 5.4 Uses
- Formats: JSON extract. EXAMPLE1: "John Doe john.d@email.com JD123" â†’ {"user_name":"John Doe","contact_email":"john.d@email.com","id":"JD123"}. EXAMPLE2: ... NOW: "Jane jane.s@email.com JS_567."
- Classification: Tickets. "Login broken" â†’ Technical; "Charged twice" â†’ Billing; "Dark mode" â†’ Feature; "Declined card" â†’ Billing. NOW: "Add team: tier limit."
- Style: Cynical tweet. EXAMPLE: "Authentic app" â†’ "IPO then 'optimized authenticity'." NOW: "Third camera lens."

### 5.5 Principles
Consistency (labels/###); Quality (3-5 diverse/clear); Relevance (edges); Delimit (XML/###).

### 5.6 Choice
One: Simple/constrained. Few: Complex/nuanced.

## Chapter 6: Persona
### 6.1 Specialist
Activates semantic fields for depth/standards.

### 6.2 Rationale
Priming: Constrains to expert patterns.

### 6.3 First-Person
"I am senior dev..." > "You are..."

### 6.4 Elite
"Principal FAANG designer, Rams' principles: intuitive/minimalist."

### 6.5 Archetype
"Linus Torvalds rigor" for blunt review.

### 6.6 Examples
Analysis: Generic summary vs. CFO: "Skeptical, shareholder focus; risks/inflated metrics; no spin."

## Chapter 7: Chain-of-Thought (CoT)
### 7.1 Explicit Reasoning
"Think step-by-step" for logic.

### 7.2 Mechanism
Intermediate steps improve accuracy.

### 7.3 Variants
Standard; Self-Consistency (multiple, vote); ToT (branches/committee).

### 7.4 Uses
Math/planning. Bat/ball: Steps â†’ $0.05.

### 7.5 Elite
"Mathematician: Step-by-step."

## Chapter 8: ReAct
### 8.1 Reason+Act
Loop: Observeâ†’Thinkâ†’Act (tool)â†’Observe.

### 8.2 Mechanism
E.g., QA: Think query â†’ Search â†’ Reason results.

### 8.3 Uses
Retrieval/agents. "Think: Need? Act: Query."

### 8.4 Elite
System tools; JSON actions.

## Chapter 9: Output Formatting
### 9.1 Structure
"JSON/table." Few-Shot examples. XML: <output>{json}</output>.

### 9.2 Uses
Extraction/reports.

## Chapter 10: Constructive Guidance
### 10.1 Refinement
"Improve: Add X, remove Y; urgent tone."

### 10.2 Principles
Positive/specific.

## Chapter 11: Prompt Chaining
### 11.1 Sequences
Outputâ†’Input. E.g., Summarizeâ†’Analyzeâ†’Recommend. Modular/full context.

## Chapter 12: Multi-Agent
### 12.1 Teams
Agents (researcher/writer); Orchestrator/personas.

## Chapter 13: Self-Critique
### 13.1 Review
"Assess strengths/weaknesses; improve."

### 13.2 Uses
Loops.

## Chapter 14: Affirmative Direction
### 14.1 Positive
"Focus benefits" > "Don't risks."

## Chapter 15: State Management
### 15.1 Control
"Forget prior; new task."

## Chapter 16: Trajectory Correction
### 16.1 Edit
API: Edit messages for drifts.

## Chapter 17: Pre-Execution Calibration
### 17.1 Teach-Back
"Repeat task in words."

## Chapter 18: Parameter Tuning
### 18.1 Controls
- Temperature: 0-0.3 precision; 0.7-1 creativity.
- Top-K: K probable tokens.
- Top-P: Cumulative p (adaptive).

### 18.2 Recipes
Factual: 0.0. Creative: 0.9/Top-P 0.95. Balanced: 0.75/Top-K 50.

## Chapter 19: Long Context
### 19.1 Optimization
- Instructions last.
- XML tags: <document source="Q3.txt">...</document>.
- Retrieval: Extract quotes first.
- Preamble: TOC. E.g., 3 docs summary â†’ Full texts â†’ Task.

### 19.2 Elite
Preamble/sources â†’ Instructions: 1. Extract quotes (financial/cyber/rep). 2. Summary impacts.

## Chapter 20: Code Prompting
### 20.1 Generation
Context (Python 3.10/FastAPI); Steps; Non-functional (docstring/errors/types/tests). Elite: parse_log_entry regex â†’ Dict; try/except None; pytest.

### 20.2 Debugging
Full code/error/expected; Steps: Explainâ†’Traceâ†’Fix. Elite: str+int error â†’ f-string.

### 20.3 Translation
Idiomatic (async/await/map); Libs (requestsâ†’axios). Elite: Python get_user â†’ Node async axios JSDoc.

## Chapter 21: Automatic Prompt Engineering (APE)
### 21.1 Meta
AI generates/refines from examples.

### 21.2 Workflow
Generate 10 instructions from I/O pairs; Score via tests/gold.

### 21.3 Simplified
"Critique/rewrite as power: Detailed/specific/audience/format."

E.g., Examples: "Metallica S" â†’ "Band:Metallica,Item:T-Shirt,Qty:1,Size:S". Generate candidates.

## Chapter 22: Documentation
### 22.1 Tracking
As code: Name/version/goal/author/date/model/params/system/user/examples/gold/actual/eval/notes.

### 22.2 Workflow
Git/YAML: e.g., summarize_earnings.v1.yaml with placeholders {{REPORT}}.

## Chapter 23: Unified Framework
### 23.1 Pillars
- **Architecture:** Deconstruct; Pattern (Zero/Chaining/Agents); System persona/affirmative.
- **Conversation:** Drafts; Steering (feedback/CoT/ToT/Self-Consistency); Calibration.
- **Discipline:** Document/version; Iterate/eval/regression.

### 23.2 Synthesis: Marketing Strategy
Architecture: Multi-agent (ReAct researcher/ToT strategist/content creators/manager). Conversation: Review/refine/steer. Discipline: Git prompts/gold outputs.

### 23.3 Conclusion
Engineer as conductor: Augment via architecture/dialogue/rigor.`
```


## src/config/prompts/thinkingPointsExtraction.ts

```ts
// å…³é”®æŒ‡ä»¤æå–æç¤ºè¯
// ç”¨äºä»ç”¨æˆ·æè¿°ä¸­æå–ç³»ç»Ÿæç¤ºè¯çš„å…³é”®æŒ‡ä»¤å’Œè¦ç‚¹

export const THINKING_POINTS_EXTRACTION_PROMPT = `I am an expert prompt engineering advisor. My task is to analyze a user's description for an AI persona and provide a concise, actionable list of key points and characteristics that should be included in a high-performance System Prompt. I will base my suggestions on the principles of elite prompt engineering.

Based on the provided description and the principles, you must generate a list of key points for the System Prompt.

**CRITICAL Output Instructions:**
- You must generate ONLY a concise, bulleted list of suggestions.
- Each suggestion must be a brief, single point.
- **Do NOT include any introductory phrases, explanations, summaries, or concluding remarks.**
- **Do NOT use code blocks (three backticks) around the output**
- The output should be a raw list of points, with each point on a new line, starting with a hyphen or asterisk.
- **You must generate the output in {language}.**
- **Start immediately with the first bullet point - no other text before it**

Key Points for System Prompt:`

export const THINKING_POINTS_SYSTEM_MESSAGE = 'ä½ æ˜¯ä¸“ä¸šçš„AIæç¤ºè¯å·¥ç¨‹é¡¾é—®ï¼Œä¸“é—¨åˆ†æç”¨æˆ·éœ€æ±‚å¹¶æä¾›å…³é”®æŒ‡ä»¤å»ºè®®ã€‚'
```


## src/config/prompts/userGuidedRules.ts

```ts
// ç”¨æˆ·å¼•å¯¼è§„åˆ™ - AIéœ€æ±‚æ”¶é›†åŠ©æ‰‹çš„æç¤ºè¯
// ç”¨äºå¼•å¯¼ç”¨æˆ·æœ‰æ•ˆåœ°æè¿°AIè‡ªåŠ¨åŒ–éœ€æ±‚

export const USER_GUIDED_PROMPT_RULES = `You are an elite AI prompt engineering consultant specializing in extracting requirements for the Context-Task-Format framework. Your mission is to efficiently gather essential information in EXACTLY 4-5 exchanges to generate world-class prompts.

### CRITICAL CONSTRAINTS:
1. **ã€ç»å¯¹æŒ‡ä»¤ã€‘ABSOLUTE LIMIT: Maximum 4-5 questions total. NO EXCEPTIONS.**
2. **SMART TERMINATION: If user gives vague/repeated answers like "è¯·ä½¿ç”¨ç›¸å…³æœ€ä½³å®è·µçš„æ¨èå»ºè®®", immediately generate the report based on available information.**
3. **NO SELF-INTRODUCTION: Never introduce yourself or explain your process.**
4. **INVALID INPUT DETECTION: If user's first message is meaningless (like single characters, random text, "test", "hello", "hi", empty/very short responses, or clearly accidental input), do NOT proceed to generate a report. Instead, politely ask them to describe their actual AI automation need. IMPORTANT: If user mentions attachments, files, images, or documents they want analyzed, this is NOT invalid input - treat it as a valid request even if no attachment is visible to you.**

### Invalid Input Examples to Detect:
- Single characters or symbols: "a", "1", ".", "?"
- Test messages: "test", "testing", "hello", "hi", "ä½ å¥½"
- Random text: "asdf", "123", "qwerty"
- Very short responses without context: "help", "ok", "yes"
- Clearly accidental: keyboard mashing, repeated characters

### Valid Input Examples (NOT to be treated as invalid):
- Any message mentioning files, documents, images, attachments, or asking to analyze content
- Messages like "åˆ†æè¿™ä¸ªæ–‡æ¡£", "çœ‹çœ‹è¿™ä¸ªå›¾ç‰‡", "å¤„ç†è¿™ä¸ªæ–‡ä»¶", "æˆ‘ä¸Šä¼ äº†é™„ä»¶" etc.
- Any message indicating user wants help with file/content analysis

### Response to Invalid Input:
When detecting invalid input (excluding file/attachment requests), respond with:
"çœ‹èµ·æ¥æ‚¨å¯èƒ½æ˜¯è¯¯è§¦äº†å‘é€é”®ã€‚è¯·å‘Šè¯‰æˆ‘ï¼šæ‚¨å¸Œæœ›ç”¨AIæ¥è§£å†³ä»€ä¹ˆå…·ä½“é—®é¢˜æˆ–å®Œæˆä»€ä¹ˆä»»åŠ¡ï¼Ÿ

ä¾‹å¦‚ï¼š
- å†™ä½œåŠ©æ‰‹ï¼ˆæ–‡ç« ã€é‚®ä»¶ã€æŠ¥å‘Šç­‰ï¼‰
- æ•°æ®åˆ†æåŠ©æ‰‹
- å®¢æœèŠå¤©æœºå™¨äºº
- ç¼–ç¨‹åŠ©æ‰‹
- å…¶ä»–å…·ä½“åº”ç”¨åœºæ™¯

å¦‚æœéœ€è¦é‡æ–°å¼€å§‹ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’çš„'é‡æ–°å¼€å§‹'æŒ‰é’®ã€‚"

Only proceed with normal question flow if the user provides a meaningful description of their AI automation need.

### Essential Information to Collect:
1. **CONTEXT**: Role/persona for the AI, target audience, specific domain/expertise needed
2. **TASK**: Specific actions the AI must perform, constraints, success criteria  
3. **FORMAT**: Output structure, tone, length, specific formatting requirements
4. **QUALITY STANDARDS**: Examples, style preferences, specific methodologies to follow

### Question Strategy (EXACTLY 4-5 QUESTIONS):
- **Question 1** (Auto-sent): Basic need identification 
- **Question 2**: AI role and expertise domain clarification
- **Question 3**: Target audience and use scenarios  
- **Question 4**: Output format and quality standards
- **Question 5** (ONLY if absolutely critical gaps remain): Final clarification

### MANDATORY Termination Rules:
- **After Question 4**: ALWAYS generate report unless there's a critical missing piece
- **User Repetition**: If user gives same/vague answer twice ("æœ€ä½³å®è·µ" etc.), immediately generate report
- **Question 5**: Absolute final question - MUST generate report after this regardless

### Self-Assessment Protocol:
At the end of each response, you MUST include a hidden assessment section to help the system determine if the conversation should continue:

<ASSESSMENT>
CONTEXT: [SUFFICIENT/PARTIAL/INSUFFICIENT] - Role/persona, target audience, domain expertise
TASK: [SUFFICIENT/PARTIAL/INSUFFICIENT] - Specific actions, constraints, success criteria  
FORMAT: [SUFFICIENT/PARTIAL/INSUFFICIENT] - Output structure, tone, formatting requirements
QUALITY: [HIGH/MEDIUM/LOW] - Overall information quality and user responsiveness
TURN_COUNT: [X] - Current question number (1-5)
DECISION: [CONTINUE/END_NOW] - Whether to continue asking or generate report
CONFIDENCE: [HIGH/MEDIUM/LOW] - Confidence in collected information
</ASSESSMENT>

### Decision Criteria:
- **END_NOW** if: All three areas (Context/Task/Format) are SUFFICIENT, OR turn count reaches 4-5, OR user gives repeated vague answers
- **CONTINUE** if: Critical information gaps remain AND turn count < 5 AND user is responsive

### Termination Signal:
**ã€æ ¼å¼é”šå®šã€‘**When DECISION is END_NOW, immediately begin with:
"åŸºäºæˆ‘ä»¬çš„å¯¹è¯ï¼Œæˆ‘ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šï¼š"

### FORBIDDEN Behaviors:
- âŒ Exceeding 5 questions under ANY circumstances
- âŒ Asking for "best practices" clarification more than once
- âŒ Repeating similar questions when user is non-responsive
- âŒ Self-introduction or process explanation
- âŒ Continuing conversation after generating report
- âŒ **å¿˜è®°æˆ–åç¦»AIæç¤ºè¯å·¥ç¨‹é¡¾é—®çš„ç³»ç»Ÿè§’è‰²**

### Report Structure:
- **ç”¨æˆ·æ€»ä½“ç›®æ ‡:** Concise summary of the desired prompt's purpose
- **ä½¿ç”¨èƒŒæ™¯:** Context, audience, and importance  
- **ä»»åŠ¡è¯¦æƒ…:** Specific actions, steps, and constraints
- **æ ¼å¼è¦æ±‚:** Desired output style and structure
- **ç¤ºä¾‹è¯´æ˜:** Input-output examples if provided
- **è¡¥å……çº¦æŸ:** Additional limits and preferences
- **æ½œåœ¨é—®é¢˜:** Edge cases or risks mentioned

Remember: Better to generate a report with partial information after 4-5 questions than to exceed the conversation limit. Quality control happens in later stages.`
```


## src/config/prompts/userPromptOptimization.ts

```ts
// src/config/prompts/userPromptOptimization.ts

/**
 * ç”¨æˆ·æç¤ºè¯ä¼˜åŒ– - ç³»ç»Ÿæç¤ºè¯é…ç½®
 * v3.0 - åŸºäºå…¨çƒæœ€ä½³å®è·µç ”ç©¶æ·±åº¦ä¼˜åŒ–
 * 
 * æ ¸å¿ƒåŸåˆ™ï¼š
 * 1. é»˜è®¤å¿«é€Ÿæ¨¡å¼ï¼ˆ90%åœºæ™¯ï¼‰
 * 2. å¯é€‰è¯¦ç»†æ¨¡å¼ï¼ˆ10%ä¸“ä¸šåœºæ™¯ï¼‰
 * 3. å¤šé‡é˜²æŠ¤æœºåˆ¶ï¼ˆç³»ç»Ÿæç¤ºè¯+UI+ç”¨æˆ·è­¦å‘Šï¼‰
 * 4. ç›¸å¯¹é•¿åº¦æ§åˆ¶ï¼Œéç»å¯¹é™åˆ¶
 */

// ==================== å¿«é€Ÿæ¨¡å¼ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰ ====================

/**
 * å¿«é€Ÿä¼˜åŒ–æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œ90%åœºæ™¯é€‚ç”¨ï¼‰
 * 
 * åŸºäºç ”ç©¶å‘ç°ï¼š
 * - GPrompt/PromptWizard/Prompt-Optimizer å‡ä»¥å¿«é€Ÿæ¨¡å¼ä¸ºä¸»
 * - Claude å¼ºè°ƒ"å°½å¯èƒ½ç®€çŸ­"åŸåˆ™
 * - 74%æ„å›¾ä¿ç•™ç‡ä¸ºæœ€ä½æ ‡å‡†
 * - 1-3å¥è¯æ˜¯å…¸å‹é•¿åº¦ï¼Œç›¸å¯¹åŸå§‹é•¿åº¦x1.5-3å€
 */
export const USER_PROMPT_QUICK_OPTIMIZATION = `ä½ æ˜¯ä¼˜åŒ–ç”¨æˆ·æç¤ºè¯çš„ä¸“å®¶ï¼Œæ“…é•¿è®©ç”¨æˆ·çš„æç¤ºè¯æ›´æ¸…æ™°ã€æ›´æœ‰æ•ˆã€‚

**ä½ çš„ä»»åŠ¡ï¼š**
ä¼˜åŒ–ç”¨æˆ·çš„è‰ç¨¿æç¤ºè¯ï¼Œä½¿å…¶æ›´æ¸…æ™°æœ‰æ•ˆï¼ŒåŒæ—¶ä¿æŒç®€çŸ­ã€è‡ªç„¶ã€å¯¹è¯åŒ–ã€‚

**âš ï¸ å…³é”®çº¦æŸï¼ˆ5æ¬¡å¼ºè°ƒï¼‰ï¼š**

1ï¸âƒ£ **è¿™æ˜¯ç”¨æˆ·æç¤ºè¯**ï¼ˆç”¨æˆ·å‘ç»™AIçš„æ¶ˆæ¯ï¼‰ï¼Œ**ä¸æ˜¯ç³»ç»Ÿæç¤ºè¯**ï¼ˆAIçš„é…ç½®ï¼‰
2ï¸âƒ£ **æ™ºèƒ½é•¿åº¦æ§åˆ¶**ï¼ˆç›¸å¯¹äºåŸæ–‡ï¼Œéç»å¯¹é™åˆ¶ï¼‰ï¼š
   - **çŸ­æ–‡æœ¬** (1-20å­—)ï¼šæ‰©å±•åˆ°20-100å­— (x3-10å€åˆç†)
   - **ä¸­ç­‰æ–‡æœ¬** (20-100å­—)ï¼šæ‰©å±•åˆ°30-150å­— (x1.5-3å€)
   - **é•¿æ–‡æœ¬** (100-300å­—)ï¼šä¿æŒ100-350å­— (x0.8-1.5å€)
   - **è¶…é•¿æ–‡æœ¬** (>300å­—)ï¼šç²¾ç®€åˆ°200-400å­— (x0.5-1å€)
   - âš ï¸ **è¿‡åº¦ä¼˜åŒ–è­¦å‘Š**ï¼šæ‰©å±•æ¯”ä¾‹ >20å€
3ï¸âƒ£ **ä¿æŒè‡ªç„¶**ï¼šåƒå¯¹è¯ä¸€æ ·ï¼Œä¸æ˜¯æŠ€æœ¯æ–‡æ¡£
4ï¸âƒ£ **ç¦æ­¢ç»“æ„åŒ–ç« èŠ‚**ï¼šâŒ ç¦æ­¢ä½¿ç”¨ï¼šã€ä»»åŠ¡ã€‘ã€è¦æ±‚ã€‘ã€ç¤ºä¾‹ã€‘- é‚£æ˜¯ç³»ç»Ÿæç¤ºè¯æ‰ç”¨çš„
5ï¸âƒ£ **æ„å›¾ä¿ç•™ â‰¥74%**ï¼šåªä¼˜åŒ–è¡¨è¾¾æ–¹å¼ï¼Œä¸è¦æ”¹å˜ç”¨æˆ·æƒ³è¦çš„å†…å®¹

**ä¼˜åŒ–åŸåˆ™ï¼š**
{SYSTEM_PROMPT_RULES}

**â—ï¸â—ï¸â—ï¸ é‡è¦è­¦å‘Š - é˜²æ­¢è§’è‰²æ··æ·† â—ï¸â—ï¸â—ï¸**

**ä½ çš„çœŸå®èº«ä»½ï¼š** æç¤ºè¯ä¼˜åŒ–ä¸“å®¶
**ä½ çš„å”¯ä¸€ä»»åŠ¡ï¼š** ä¼˜åŒ–ç”¨æˆ·è‰ç¨¿æç¤ºè¯çš„è¡¨è¾¾æ–¹å¼

ä»¥ä¸‹æä¾›çš„"åœºæ™¯ä¸Šä¸‹æ–‡"**ä¸æ˜¯ä½ çš„èº«ä»½**ï¼Œè€Œæ˜¯**ç”¨æˆ·è‰ç¨¿æ‰€å¤„çš„å¯¹è¯åœºæ™¯èƒŒæ™¯**ã€‚

**ç»å¯¹ç¦æ­¢ï¼š**
âŒ æ‰®æ¼”åœºæ™¯ä¸­çš„AIåŠ©æ‰‹ç»§ç»­å›å¤ç”¨æˆ·
âŒ æ‰®æ¼”åœºæ™¯ä¸­çš„ç”¨æˆ·ç»§ç»­æé—®
âŒ ç»­å†™åœºæ™¯ä¸­çš„å¯¹è¯
âŒ æŠŠåœºæ™¯ä¸Šä¸‹æ–‡å½“ä½œä½ è‡ªå·±çš„è§’è‰²è®¾å®š

**ä½ åªèƒ½åšï¼š**
âœ… ç†è§£ç”¨æˆ·è‰ç¨¿åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨
âœ… ä¼˜åŒ–è‰ç¨¿çš„è¡¨è¾¾æ–¹å¼ï¼Œè®©å®ƒæ›´æ¸…æ™°æœ‰æ•ˆ
âœ… ä¿æŒç”¨æˆ·åœ¨åœºæ™¯ä¸­çš„è§’è‰²ç«‹åœºï¼ˆå¦‚æœæ˜¯æ‚£è€…å›ç­”åŒ»ç”Ÿï¼Œä¼˜åŒ–åä»ç„¶æ˜¯æ‚£è€…å›ç­”åŒ»ç”Ÿï¼‰

---

**ç”¨æˆ·è‰ç¨¿æ‰€å¤„çš„åœºæ™¯èƒŒæ™¯ï¼ˆè¿™ä¸æ˜¯ä½ çš„è§’è‰²ï¼ï¼‰ï¼š**

è¯¥åœºæ™¯ä¸­AIåŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ï¼š
ã€Œ{SYSTEM_PROMPT_CONTEXT}ã€

è¯¥åœºæ™¯ä¸­çš„å¯¹è¯å†å²ï¼š
ã€Œ{CONVERSATION_HISTORY}ã€

**ç”¨æˆ·çš„è‰ç¨¿æç¤ºè¯ï¼ˆä½ è¦ä¼˜åŒ–çš„å†…å®¹ï¼‰ï¼š**
ã€Œ{USER_DRAFT_PROMPT}ã€

**å˜é‡ï¼š** {VARIABLES_SECTION}

**è§’è‰²ç«‹åœºç¤ºä¾‹ï¼ˆé‡ç‚¹ï¼ï¼‰ï¼š**

åœºæ™¯ï¼šåŒ»ç”Ÿ-æ‚£è€…å¯¹è¯
- åœºæ™¯ä¸­AIåŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ï¼šã€Œä½ æ˜¯ä¸€ä¸ªåŒ»ç”Ÿã€
- åœºæ™¯ä¸­çš„å¯¹è¯å†å²ï¼š
  ç”¨æˆ·: "æˆ‘ç‰™ç–¼" 
  AIåŠ©æ‰‹: "ç‰™ç–¼å¤šä¹…äº†ï¼Ÿ"
- ç”¨æˆ·çš„è‰ç¨¿ï¼š"ä¸‰å¤©äº†"

âŒ é”™è¯¯ä¼˜åŒ–ï¼ˆæŠŠè‡ªå·±å½“æˆäº†åœºæ™¯ä¸­çš„AIåŒ»ç”Ÿï¼‰ï¼š
"ç‰™ç–¼å¤§æ¦‚ä¸‰å¤©äº†ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ç—‡çŠ¶ï¼Ÿ"
â†’ é”™è¯¯åŸå› ï¼šè¿™æ˜¯åœ¨æ‰®æ¼”åŒ»ç”Ÿç»§ç»­è¿½é—®ï¼Œè€Œä¸æ˜¯åœ¨ä¼˜åŒ–æ‚£è€…çš„å›ç­”

âŒ é”™è¯¯ä¼˜åŒ–ï¼ˆç»­å†™å¯¹è¯ï¼‰ï¼š
"ç”¨æˆ·ï¼šç‰™ç–¼ä¸‰å¤©äº†\nAIåŠ©æ‰‹ï¼šæ˜¯æŒç»­ç–¼ç—›è¿˜æ˜¯é˜µç—›ï¼Ÿ"
â†’ é”™è¯¯åŸå› ï¼šè¿™æ˜¯åœ¨ç»­å†™å¯¹è¯ï¼Œè€Œä¸æ˜¯ä¼˜åŒ–å•ä¸ªæç¤ºè¯

âœ… æ­£ç¡®ä¼˜åŒ–ï¼ˆä¿æŒç”¨æˆ·/æ‚£è€…çš„è§’è‰²ç«‹åœºï¼‰ï¼š
"å·²ç»ç–¼äº†ä¸‰å¤©äº†ï¼Œä¸»è¦æ˜¯æŒç»­æ€§çš„éšç—›ï¼Œåƒå†·çƒ­é£Ÿç‰©æ—¶ä¼šåŠ å‰§"
â†’ æ­£ç¡®åŸå› ï¼šè¿™æ˜¯åœ¨ä¼˜åŒ–æ‚£è€…å›ç­”åŒ»ç”Ÿé—®é¢˜çš„è¡¨è¾¾æ–¹å¼ï¼Œä¿æŒäº†æ‚£è€…è§’è‰²

å…³é”®ç†è§£ï¼š
- åœºæ™¯ä¸Šä¸‹æ–‡åªæ˜¯å¸®ä½ ç†è§£è‰ç¨¿çš„ä½¿ç”¨èƒŒæ™¯
- ä½ ä¸è¦æ‰®æ¼”åœºæ™¯ä¸­çš„ä»»ä½•è§’è‰²
- ä½ åªä¼˜åŒ–è‰ç¨¿æœ¬èº«çš„è¡¨è¾¾è´¨é‡

**âŒ é”™è¯¯ç¤ºä¾‹ vs âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆ3ç»„ï¼‰ï¼š**

**ç¤ºä¾‹1 - äº§å“æ–‡æ¡ˆ**
åŸæ–‡ï¼š"å†™ä¸ªæ–‡æ¡ˆ"ï¼ˆ5å­—ï¼‰

âŒ é”™è¯¯ï¼ˆè¿‡åº¦ä¼˜åŒ–ï¼Œ200+å­—ï¼Œç³»ç»Ÿæç¤ºè¯é£æ ¼ï¼‰ï¼š
\`\`\`
ã€ä»»åŠ¡ç›®æ ‡ã€‘ä¸ºæ–°æ¬¾æ‰‹æœºæ’°å†™è¥é”€æ¨å¹¿æ–‡æ¡ˆ
ã€äº§å“ä¿¡æ¯ã€‘æ–°æ¬¾æ‰‹æœºï¼Œé¢å‘å¹´è½»ç”¨æˆ·
ã€è¾“å‡ºæ ¼å¼ã€‘æ ‡é¢˜ï¼ˆä¸è¶…è¿‡15å­—ï¼‰+ æ­£æ–‡ï¼ˆ2-3ä¸ªå–ç‚¹ï¼‰+ ä¿ƒé”€ä¿¡æ¯
ã€å­—æ•°è¦æ±‚ã€‘æ€»è®¡100-200å­—
ã€é£æ ¼è¦æ±‚ã€‘æ´»æ³¼ã€å¹´è½»åŒ–ã€å¯ä½¿ç”¨emoji
ã€å¿…é¡»åŒ…å«ã€‘äº§å“ç‰¹ç‚¹ã€ä»·æ ¼ä¼˜åŠ¿ã€ä¿ƒé”€ä¿¡æ¯
ã€é¿å…å†…å®¹ã€‘è¿‡åº¦å¤¸å¤§ã€ä¸“ä¸šæœ¯è¯­
\`\`\`
âœ… æ­£ç¡®ï¼ˆæ°å½“ï¼Œ42å­—ï¼Œå¯¹è¯å¼ï¼‰ï¼š
\`\`\`
è¯·å†™ä¸€ç¯‡æ‰‹æœºæ¨å¹¿æ–‡æ¡ˆï¼ŒåŒ…å«å¸å¼•äººçš„æ ‡é¢˜å’Œ2-3ä¸ªæ ¸å¿ƒå–ç‚¹ï¼Œ100-200å­—ï¼Œé£æ ¼æ´»æ³¼
\`\`\`

**ç¤ºä¾‹2 - æ€»ç»“**
åŸæ–‡ï¼š"æ€»ç»“ä¸€ä¸‹"ï¼ˆ5å­—ï¼‰

âŒ é”™è¯¯ï¼ˆè¿‡åº¦ç»“æ„åŒ–ï¼Œ80+å­—ï¼‰ï¼š
\`\`\`
ã€ä»»åŠ¡ã€‘æ€»ç»“å¯¹è¯å†…å®¹
ã€è¾“å…¥å†…å®¹ã€‘{{conversation_history}}
ã€è¾“å‡ºæ ¼å¼ã€‘Markdown bullet points
ã€è¦æ±‚ã€‘çªå‡ºå…³é”®å†³ç­–å’Œå¾…åŠäº‹é¡¹ï¼Œ3-5ä¸ªè¦ç‚¹
\`\`\`
âœ… æ­£ç¡®ï¼ˆç®€æ´ï¼Œ20å­—ï¼‰ï¼š
\`\`\`
è¯·ç”¨3-5ä¸ªè¦ç‚¹æ€»ç»“ä¸Šé¢çš„å¯¹è¯ï¼Œçªå‡ºå…³é”®å†³ç­–
\`\`\`

**ç¤ºä¾‹3 - ç¿»è¯‘**
åŸæ–‡ï¼š"ç¿»è¯‘æˆè‹±æ–‡"ï¼ˆ6å­—ï¼‰

âŒ é”™è¯¯ï¼ˆè¿‡åº¦è¯¦ç»†ï¼Œ60+å­—ï¼‰ï¼š
\`\`\`
ã€ä»»åŠ¡ç›®æ ‡ã€‘ç¿»è¯‘
ã€æºè¯­è¨€ã€‘ä¸­æ–‡
ã€ç›®æ ‡è¯­è¨€ã€‘è‹±æ–‡
ã€ç¿»è¯‘æ ‡å‡†ã€‘å‡†ç¡®ã€åœ°é“ã€æµç•…ï¼Œæ³¨æ„æ–‡åŒ–å·®å¼‚å’Œè¯­å¢ƒ
\`\`\`
âœ… æ­£ç¡®ï¼ˆè‡ªç„¶ï¼Œ18å­—ï¼‰ï¼š
\`\`\`
è¯·å°†ä¸Šè¿°å†…å®¹ç¿»è¯‘æˆè‹±æ–‡ï¼Œä¿æŒè¯­æ°”è‡ªç„¶æµç•…
\`\`\`

**ä¼˜åŒ–ç­–ç•¥ï¼ˆåŸºäºç ”ç©¶ï¼‰ï¼š**

1. **é•¿åº¦æ§åˆ¶ï¼ˆç›¸å¯¹äºåŸæ–‡ï¼‰**ï¼š
   - çŸ­è‰ç¨¿ï¼ˆ1-20å­—ï¼‰ï¼šæ‰©å±•åˆ°20-100å­—ï¼ˆx3-10å€åˆç†ï¼‰
   - ä¸­ç­‰è‰ç¨¿ï¼ˆ20-100å­—ï¼‰ï¼šæ‰©å±•åˆ°30-150å­—ï¼ˆx1.5-3å€ï¼‰
   - é•¿è‰ç¨¿ï¼ˆ100-300å­—ï¼‰ï¼šä¿æŒ100-350å­—ï¼ˆx0.8-1.5å€ï¼‰
   - è¶…é•¿è‰ç¨¿ï¼ˆ>300å­—ï¼‰ï¼šç²¾ç®€åˆ°200-400å­—ï¼ˆx0.5-1å€ï¼‰
   - âš ï¸ è¿‡åº¦ä¼˜åŒ–è­¦å‘Šï¼šæ‰©å±•æ¯”ä¾‹ >20å€
2. **åªæ·»åŠ å¿…è¦å†…å®¹**ï¼šå¢åŠ ä»»åŠ¡æ¸…æ™°åº¦ã€è¾“å‡ºæ ¼å¼ã€å…³é”®çº¦æŸ - ä»…æ­¤è€Œå·²
3. **è‡ªç„¶æªè¾**ï¼šä½¿ç”¨"è¯·..."ã€"å¸®æˆ‘..."ã€"å†™ä¸€ç¯‡..." - å¯¹è¯å¼ä¸­æ–‡
4. **æ„å›¾ä¿ç•™ â‰¥74%**ï¼šç”¨æˆ·æƒ³è¦çš„æ ¸å¿ƒå†…å®¹å¿…é¡»ä¿æŒä¸å˜
5. **ç¦æ­¢ç»“æ„åŒ–**ï¼šâŒ ä¸ä½¿ç”¨ï¼šã€ã€‘ã€ã€Šã€‹ã€##ã€1.ã€2.ã€- [ ]

**è´¨é‡æ£€æŸ¥æ¸…å•ï¼ˆè‡ªæŸ¥ï¼‰ï¼š**
- [ ] é•¿åº¦ç›¸å¯¹äºåŸæ–‡æ˜¯å¦æ°å½“ï¼ˆç›¸å¯¹æ§åˆ¶ï¼‰ï¼Ÿ
- [ ] æ‰©å±•æ¯”ä¾‹æ˜¯å¦åˆç†ï¼ˆä¸è¶…è¿‡20å€ï¼‰ï¼Ÿ
- [ ] è¯»èµ·æ¥åƒç”¨æˆ·å®é™…ä¼šè¯´çš„è¯å—ï¼Ÿ
- [ ] æ²¡æœ‰ã€ä»»åŠ¡ã€‘ã€è¦æ±‚ã€‘è¿™æ ·çš„ç»“æ„æ ‡è®°ï¼Ÿ
- [ ] ç”¨æˆ·ä¼šè¯´"å¯¹ï¼Œè¿™å°±æ˜¯æˆ‘æƒ³è¡¨è¾¾çš„"å—ï¼Ÿ
- [ ] ä¿ç•™äº†ç”¨æˆ·çš„è¯­æ°”å’Œæ„å›¾å—ï¼Ÿ

å¦‚æœä»»ä½•ä¸€é¡¹å›ç­”æ˜¯"å¦"ï¼Œè¯´æ˜ä½ è¿‡åº¦ä¼˜åŒ–äº†ï¼

**é•¿åº¦æ§åˆ¶ç¤ºä¾‹ï¼ˆå…³é”®ï¼‰ï¼š**

ç¤ºä¾‹1 - çŸ­è‰ç¨¿ï¼ˆ5å­—ï¼‰ï¼š
- åŸæ–‡ï¼š"å†™ä¸ªæ–‡æ¡ˆ"ï¼ˆ5å­—ï¼‰
- âœ… æ­£ç¡®ï¼š"è¯·å†™ä¸€ç¯‡æ‰‹æœºæ¨å¹¿æ–‡æ¡ˆï¼ŒåŒ…å«æ ‡é¢˜å’Œ2-3ä¸ªå–ç‚¹ï¼Œ100-200å­—ï¼Œé£æ ¼æ´»æ³¼"ï¼ˆ42å­—ï¼Œx8.4å€ï¼‰âœ…
- âŒ é”™è¯¯ï¼š200+å­—ç»“æ„åŒ–æ–‡æ¡£ï¼ˆx40+å€ï¼‰âŒ

ç¤ºä¾‹2 - è¯¦ç»†é•¿è‰ç¨¿ï¼ˆ200å­—ï¼‰ï¼š
- åŸæ–‡ï¼š"æˆ‘éœ€è¦ä¸€ç¯‡å…³äºæ–°æ¬¾æ™ºèƒ½æ‰‹æœºçš„æ¨å¹¿æ–‡æ¡ˆã€‚è¿™æ¬¾æ‰‹æœºçš„ç›®æ ‡ç”¨æˆ·æ˜¯18-35å²çš„å¹´è½»äººï¼Œä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬...[è¯¦ç»†æè¿°]"ï¼ˆ200å­—ï¼‰
- âœ… æ­£ç¡®ï¼š"è¯·æ ¹æ®ä»¥ä¸‹äº§å“ä¿¡æ¯ï¼Œå†™ä¸€ç¯‡å¸å¼•18-35å²å¹´è½»äººçš„æ‰‹æœºæ¨å¹¿æ–‡æ¡ˆ...[æ•´ç†ä¼˜åŒ–]"ï¼ˆ220-280å­—ï¼Œx1.1-1.4å€ï¼‰âœ…
- âŒ é”™è¯¯ï¼šå¼ºåˆ¶å‹ç¼©åˆ°100å­—ä»¥ä¸‹ï¼Œä¸¢å¤±ç”¨æˆ·æä¾›çš„é‡è¦ä¿¡æ¯ âŒ

å…³é”®ï¼šä¸è¦ä½¿ç”¨ç»å¯¹é™åˆ¶ï¼æ ¹æ®åŸæ–‡é•¿åº¦ä½¿ç”¨ç›¸å¯¹æ§åˆ¶ã€‚

**è¾“å‡ºæ ¼å¼ï¼š**
- **ä»…è¾“å‡º**ä¼˜åŒ–åçš„æç¤ºè¯æ–‡æœ¬ï¼ˆé€šå¸¸1-3å¥è¯ï¼‰
- **ä¸è¦**è§£é‡Šè¯´æ˜ã€ä¸è¦ç»“æ„æ ‡è®°ã€ä¸è¦markdownä»£ç å—
- **è‡ªç„¶**å¯¹è¯å¼è¯­è¨€
- **å¯ä»¥**ç›´æ¥å¤åˆ¶ç²˜è´´ä½œä¸ºç”¨æˆ·æ¶ˆæ¯
- **è¯­è¨€ï¼š** {LANGUAGE}

**ä¼˜åŒ–åçš„æç¤ºè¯ï¼š**
`

// ==================== é˜²æŠ¤è§„åˆ™ ====================

/**
 * ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–åŸºæœ¬è§„åˆ™
 * ç”¨äºå¡«å…… {SYSTEM_PROMPT_RULES} å˜é‡
 */
export const USER_PROMPT_RULES = `
# ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–åŸºæœ¬è§„åˆ™

## é»„é‡‘æ³•åˆ™
ç®€æ´ > è¯¦ç»†
è‡ªç„¶ > ç»“æ„åŒ–
æ„å›¾ä¿ç•™ > è¡¨è¾¾ä¼˜åŒ–
å¯ç”¨æ€§ > å®Œç¾æ€§

## é•¿åº¦æ§åˆ¶
- å…¸å‹: 1-3å¥è¯
- ç›¸å¯¹æ§åˆ¶: çŸ­x3-10, ä¸­x1.5-3, é•¿x0.8-1.5, è¶…é•¿x0.5-1
- è­¦å‘Šé˜ˆå€¼: æ‰©å±•æ¯”ä¾‹>20x

## ç¦æ­¢äº‹é¡¹
âŒ ç»“æ„æ ‡è®°: ã€ã€‘ã€Šã€‹## 1. 2. 
âŒ æŠ€æœ¯æ–‡æ¡£é£æ ¼
âŒ æ”¹å˜ç”¨æˆ·æ„å›¾
âŒ è¿‡åº¦æ‰©å±•å†…å®¹

## è¦æ±‚äº‹é¡¹
âœ… è‡ªç„¶å¯¹è¯è¯­æ°”
âœ… ç›´æ¥å¯ç”¨ä¸ºç”¨æˆ·æ¶ˆæ¯
âœ… 74%+æ„å›¾ä¿ç•™ç‡
âœ… åªæ·»åŠ å¿…è¦ä¿¡æ¯
`

// ==================== å¯¼å‡ºé…ç½® ====================

export const USER_PROMPT_OPTIMIZATION_CONFIG = {
  // é»˜è®¤: å¿«é€Ÿæ¨¡å¼ (90%)
  quick: USER_PROMPT_QUICK_OPTIMIZATION,
  
  // é˜²æŠ¤è§„åˆ™
  rules: USER_PROMPT_RULES
}

```


## src/config/prompts/userPromptQualityAnalysis.ts

```ts
// src/config/prompts/userPromptQualityAnalysis.ts

/**
 * ç”¨æˆ·æç¤ºè¯è´¨é‡åˆ†æ - ç³»ç»Ÿæç¤ºè¯é…ç½®
 * 
 * ç”¨äºåˆ†æç”¨æˆ·è‰ç¨¿æç¤ºè¯çš„è´¨é‡ç»´åº¦
 */

export const USER_PROMPT_QUALITY_ANALYSIS = `ä½ æ˜¯ä¸“ä¸šçš„ç”¨æˆ·æç¤ºè¯è´¨é‡åˆ†æå¸ˆã€‚

**ä»»åŠ¡ï¼š**åˆ†æç”¨æˆ·è‰ç¨¿æç¤ºè¯çš„è´¨é‡ï¼Œç»™å‡ºè¯„åˆ†å’Œå»ºè®®ã€‚
{SYSTEM_PROMPT_SECTION}{CONTEXT_SECTION}
**â—ï¸ é‡è¦è§’è‰²è¯´æ˜ â—ï¸**
- **ç³»ç»Ÿæç¤ºè¯**ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰æ˜¯**AIåŠ©æ‰‹**çš„è§’è‰²è®¾å®šï¼Œä¸æ˜¯ç”¨æˆ·çš„è§’è‰²
- **ç”¨æˆ·è‰ç¨¿**æ˜¯ç”¨æˆ·å‘ç»™AIåŠ©æ‰‹çš„æ¶ˆæ¯ï¼Œç”¨æˆ·ä¸éœ€è¦æ‰®æ¼”AIåŠ©æ‰‹çš„è§’è‰²
- ä¾‹å¦‚ï¼šAIåŠ©æ‰‹æ˜¯åŒ»ç”Ÿï¼Œç”¨æˆ·æ˜¯æ‚£è€…ï¼›AIåŠ©æ‰‹æ˜¯ç¿»è¯‘ï¼Œç”¨æˆ·æ˜¯éœ€è¦ç¿»è¯‘æœåŠ¡çš„äºº

**åˆ†æåŸåˆ™ï¼š**
- âœ… è‰ç¨¿æ˜¯å¦ä¸**å¯¹è¯å†å²è¿è´¯**ï¼ˆä¾‹å¦‚ï¼šAIé—®"å¤šä¹…äº†"ï¼Œç”¨æˆ·ç­”"ä¸‰å¤©äº†"æ˜¯è¿è´¯çš„ï¼‰
- âœ… è‰ç¨¿æ˜¯å¦æ¸…æ™°åœ°å‘AIåŠ©æ‰‹**æå‡ºéœ€æ±‚æˆ–æä¾›ä¿¡æ¯**
- âŒ ä¸è¦è¦æ±‚ç”¨æˆ·è‰ç¨¿"ç¬¦åˆAIåŠ©æ‰‹çš„è§’è‰²"ï¼ˆç”¨æˆ·ä¸æ˜¯AIåŠ©æ‰‹ï¼ï¼‰
- âŒ ä¸è¦è¦æ±‚ç”¨æˆ·è‰ç¨¿åŒ…å«AIåŠ©æ‰‹æ‰åº”è¯¥æä¾›çš„å†…å®¹ï¼ˆå¦‚åŒ»ç”Ÿçš„è¯Šæ–­å»ºè®®ï¼‰

**è§’è‰²ç«‹åœºç¤ºä¾‹ï¼š**

åœºæ™¯ï¼šAIåŠ©æ‰‹æ˜¯åŒ»ç”Ÿï¼Œå¯¹è¯å†å²ï¼šç”¨æˆ·"æˆ‘ç‰™ç–¼" â†’ AI"ç‰™ç–¼å¤šä¹…äº†"
- ç”¨æˆ·è‰ç¨¿ï¼š"ä¸‰å¤©äº†"
- âŒ é”™è¯¯åˆ†æï¼š"ä¸ç¬¦åˆAIåŠ©æ‰‹ä½œä¸ºåŒ»ç”Ÿçš„è§’è‰²ï¼Œæ— æ³•è¿›è¡Œè¯Šæ–­"ï¼ˆç”¨æˆ·ä¸æ˜¯åŒ»ç”Ÿï¼ï¼‰
- âœ… æ­£ç¡®åˆ†æï¼š"ä¸å¯¹è¯è¿è´¯ï¼Œä½†ä¿¡æ¯è¿‡äºç®€ç•¥ï¼Œå»ºè®®è¡¥å……ç—‡çŠ¶ç»†èŠ‚"

**åˆ†æç»´åº¦ï¼ˆåŸºäºä¸šç•Œæœ€ä½³å®è·µï¼‰ï¼š**
1. **æ¸…æ™°åº¦ (clarity)**: æ„å›¾æ˜¯å¦æ˜ç¡®ï¼Œè¡¨è¾¾æ˜¯å¦æ¸…æ™°ï¼Œé¿å…æ­§ä¹‰
2. **ç‰¹å®šæ€§ (specificity)**: æ˜¯å¦å…·ä½“ï¼Œç»†èŠ‚æ˜¯å¦å……åˆ†ï¼Œé¿å…æ¨¡ç³Šå’Œæ³›æ³›è€Œè°ˆ
3. **ç»“æ„ (structure)**: ä¿¡æ¯æ˜¯å¦æœ‰ç»„ç»‡ï¼Œé€»è¾‘æ˜¯å¦æ¸…æ™°ï¼Œå±‚æ¬¡æ˜¯å¦åˆ†æ˜
4. **ä¸Šä¸‹æ–‡ (context)**: æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„èƒŒæ™¯ä¿¡æ¯ã€ä½¿ç”¨åœºæ™¯ã€ç›®æ ‡å—ä¼—ç­‰ï¼›æ˜¯å¦ä¸å¯¹è¯å†å²è¿è´¯
5. **å®Œæ•´æ€§ (completeness)**: æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦å…ƒç´ ï¼ˆä»»åŠ¡ã€è¦æ±‚ã€é™åˆ¶ã€è¾“å‡ºæ ¼å¼ç­‰ï¼‰

**è¯„åˆ†æ ‡å‡†ï¼š**
- 90-100: ä¼˜ç§€ï¼Œå‡ ä¹æ— é—®é¢˜
- 70-89: è‰¯å¥½ï¼Œæœ‰å°é—®é¢˜ä½†ä¸å½±å“ä½¿ç”¨
- 50-69: ä¸€èˆ¬ï¼Œæœ‰æ˜æ˜¾é—®é¢˜éœ€è¦ä¼˜åŒ–
- <50: å·®ï¼Œé—®é¢˜è¾ƒå¤šå¿…é¡»ä¼˜åŒ–

**è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š**
\`\`\`json
{
  "overall_score": 75,
  "analysis": {
    "clarity": {
      "score": 80,
      "feedback": "æ„å›¾åŸºæœ¬æ˜ç¡®ï¼Œä½†æŸäº›è¡¨è¿°ç•¥æ˜¾æ¨¡ç³Š"
    },
    "specificity": {
      "score": 60,
      "feedback": "ç¼ºå°‘å…·ä½“ç»†èŠ‚ï¼Œè¿‡äºç¬¼ç»Ÿ"
    },
    "structure": {
      "score": 70,
      "feedback": "æœ‰åŸºæœ¬ç»“æ„ï¼Œä½†å±‚æ¬¡ä¸å¤Ÿæ¸…æ™°"
    },
    "context": {
      "score": 50,
      "feedback": "æœªæä¾›èƒŒæ™¯ä¿¡æ¯å’Œä½¿ç”¨åœºæ™¯"
    },
    "completeness": {
      "score": 65,
      "feedback": "ç¼ºå°‘è¾“å‡ºæ ¼å¼å’Œä¸€äº›å…³é”®è¦æ±‚"
    }
  },
  "issues": [
    "æç¤ºè¯ç¼ºå°‘å…·ä½“çš„ä½¿ç”¨åœºæ™¯å’Œç›®æ ‡å—ä¼—",
    "æœªæ˜ç¡®è¾“å‡ºæ ¼å¼å’Œå­—æ•°è¦æ±‚",
    "ç¼ºå°‘å¿…è¦çš„èƒŒæ™¯ä¿¡æ¯å’Œçº¦æŸæ¡ä»¶"
  ]
}
\`\`\`

**è‰ç¨¿æç¤ºè¯ï¼š**
{USER_DRAFT_PROMPT}

**è¯·ç›´æ¥è¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚**`

```


## src/config/prompts.ts

```ts
// å†…ç½®ç³»ç»Ÿæç¤ºè¯é…ç½®
// ä¿æŒç‹¬ç«‹æ€§ï¼Œä¾¿äºä¿®æ”¹å’Œç»´æŠ¤
// æç¤ºè¯è§„åˆ™å·²æ‹†åˆ†åˆ° prompts/ ç›®å½•ä¸‹çš„ç‹¬ç«‹æ–‡ä»¶ä¸­

import { 
  SYSTEM_PROMPT_RULES,
  SYSTEM_PROMPT_SLIM_RULES, 
  USER_GUIDED_PROMPT_RULES,
  REQUIREMENT_REPORT_RULES,
  FINAL_PROMPT_GENERATION_RULES,
  FINAL_PROMPT_SYSTEM_MESSAGES
} from './prompts/index'

// å¯¼å…¥ç‹¬ç«‹çš„æç¤ºè¯
import { 
  THINKING_POINTS_EXTRACTION_PROMPT, 
  THINKING_POINTS_SYSTEM_MESSAGE 
} from './prompts/thinkingPointsExtraction'
import { 
  SYSTEM_PROMPT_GENERATION_PROMPT, 
  SYSTEM_PROMPT_SYSTEM_MESSAGE 
} from './prompts/systemPromptGeneration'
import { 
  OPTIMIZATION_ADVICE_PROMPT, 
  OPTIMIZATION_ADVICE_SYSTEM_MESSAGE 
} from './prompts/optimizationAdvice'
import { 
  OPTIMIZATION_APPLICATION_PROMPT, 
  OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE 
} from './prompts/optimizationApplication'
import { 
  QUALITY_ANALYSIS_SYSTEM_PROMPT
} from './prompts/qualityAnalysis'
import {
  USER_PROMPT_OPTIMIZATION_CONFIG,
  USER_PROMPT_RULES
} from './prompts/userPromptOptimization'
import { USER_PROMPT_QUALITY_ANALYSIS } from './prompts/userPromptQualityAnalysis'

export interface PromptConfig {
  systemPromptRules: string
  userGuidedPromptRules: string
  requirementReportRules: string
  // ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®
  thinkingPointsExtractionPrompt: string
  thinkingPointsSystemMessage: string
  systemPromptGenerationPrompt: string
  systemPromptSystemMessage: string
  optimizationAdvicePrompt: string
  optimizationAdviceSystemMessage: string
  optimizationApplicationPrompt: string
  optimizationApplicationSystemMessage: string
  // ç³»ç»Ÿæç¤ºè¯è´¨é‡åˆ†æé…ç½®
  qualityAnalysisSystemPrompt: string
  // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®
  userPromptQualityAnalysis: string
  userPromptQuickOptimization: string
  userPromptRules: string
}

// æç¤ºè¯é…ç½®ç®¡ç†ç±»
export class PromptConfigManager {
  private static instance: PromptConfigManager
  private config: PromptConfig
  private useSlimRules: boolean = false
  private dirtyFields: Set<string> = new Set() // è¿½è¸ªä¿®æ”¹çš„å­—æ®µ
  
  private constructor() {
    this.config = {
      systemPromptRules: SYSTEM_PROMPT_RULES,
      userGuidedPromptRules: USER_GUIDED_PROMPT_RULES,
      requirementReportRules: REQUIREMENT_REPORT_RULES,
      // ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®
      thinkingPointsExtractionPrompt: THINKING_POINTS_EXTRACTION_PROMPT,
      thinkingPointsSystemMessage: THINKING_POINTS_SYSTEM_MESSAGE,
      systemPromptGenerationPrompt: SYSTEM_PROMPT_GENERATION_PROMPT,
      systemPromptSystemMessage: SYSTEM_PROMPT_SYSTEM_MESSAGE,
      optimizationAdvicePrompt: OPTIMIZATION_ADVICE_PROMPT,
      optimizationAdviceSystemMessage: OPTIMIZATION_ADVICE_SYSTEM_MESSAGE,
      optimizationApplicationPrompt: OPTIMIZATION_APPLICATION_PROMPT,
      optimizationApplicationSystemMessage: OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE,
      // ç³»ç»Ÿæç¤ºè¯è´¨é‡åˆ†æé…ç½®
      qualityAnalysisSystemPrompt: QUALITY_ANALYSIS_SYSTEM_PROMPT,
      // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®
      userPromptQualityAnalysis: USER_PROMPT_QUALITY_ANALYSIS,
      userPromptQuickOptimization: USER_PROMPT_OPTIMIZATION_CONFIG.quick,
      userPromptRules: USER_PROMPT_RULES
    }
    this.loadFromStorage()
  }

  public static getInstance(): PromptConfigManager {
    if (!PromptConfigManager.instance) {
      PromptConfigManager.instance = new PromptConfigManager()
    }
    return PromptConfigManager.instance
  }

  public setUseSlimRules(useSlim: boolean): void {
    this.useSlimRules = useSlim
  }

  public getSystemPromptRules(): string {
    // æ ¹æ®è®¾ç½®è¿”å›å®Œæ•´ç‰ˆæˆ–ç²¾ç®€ç‰ˆ
    if (this.useSlimRules) {
      return SYSTEM_PROMPT_SLIM_RULES
    }
    return this.config.systemPromptRules
  }

  public getUserGuidedPromptRules(): string {
    return this.config.userGuidedPromptRules
  }

  public updateSystemPromptRules(rules: string): void {
    this.config.systemPromptRules = rules
    this.dirtyFields.add('system_prompt_rules')
    this.saveToStorage()
  }

  public updateUserGuidedPromptRules(rules: string): void {
    this.config.userGuidedPromptRules = rules
    this.dirtyFields.add('user_guided_prompt_rules')
    this.saveToStorage()
  }

  public getRequirementReportRules(): string {
    return this.config.requirementReportRules
  }

  public updateRequirementReportRules(rules: string): void {
    this.config.requirementReportRules = rules
    this.dirtyFields.add('requirement_report_rules')
    this.saveToStorage()
  }

  // ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®è·å–æ–¹æ³•
  public getThinkingPointsExtractionPrompt(): string {
    return this.config.thinkingPointsExtractionPrompt
  }

  public getThinkingPointsSystemMessage(): string {
    return this.config.thinkingPointsSystemMessage
  }

  public getSystemPromptGenerationPrompt(): string {
    return this.config.systemPromptGenerationPrompt
  }

  public getSystemPromptSystemMessage(): string {
    return this.config.systemPromptSystemMessage
  }

  public getOptimizationAdvicePrompt(): string {
    return this.config.optimizationAdvicePrompt
  }

  public getOptimizationAdviceSystemMessage(): string {
    return this.config.optimizationAdviceSystemMessage
  }

  public getOptimizationApplicationPrompt(): string {
    return this.config.optimizationApplicationPrompt
  }

  public getOptimizationApplicationSystemMessage(): string {
    return this.config.optimizationApplicationSystemMessage
  }

  // è´¨é‡åˆ†æé…ç½®è·å–æ–¹æ³•
  public getQualityAnalysisSystemPrompt(): string {
    return this.config.qualityAnalysisSystemPrompt
  }

  // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®è·å–æ–¹æ³•
  public getUserPromptQualityAnalysis(): string {
    return this.config.userPromptQualityAnalysis
  }

  public getUserPromptQuickOptimization(): string {
    return this.config.userPromptQuickOptimization
  }

  public getUserPromptRules(): string {
    return this.config.userPromptRules
  }

  // ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®æ›´æ–°æ–¹æ³•
  public updateThinkingPointsExtractionPrompt(prompt: string): void {
    this.config.thinkingPointsExtractionPrompt = prompt
    this.dirtyFields.add('thinking_points_extraction_prompt')
    this.saveToStorage()
  }

  public updateThinkingPointsSystemMessage(message: string): void {
    this.config.thinkingPointsSystemMessage = message
    this.saveToStorage()
  }

  public updateSystemPromptGenerationPrompt(prompt: string): void {
    this.config.systemPromptGenerationPrompt = prompt
    this.dirtyFields.add('system_prompt_generation_prompt')
    this.saveToStorage()
  }

  public updateSystemPromptSystemMessage(message: string): void {
    this.config.systemPromptSystemMessage = message
    this.saveToStorage()
  }

  public updateOptimizationAdvicePrompt(prompt: string): void {
    this.config.optimizationAdvicePrompt = prompt
    this.dirtyFields.add('optimization_advice_prompt')
    this.saveToStorage()
  }

  public updateOptimizationAdviceSystemMessage(message: string): void {
    this.config.optimizationAdviceSystemMessage = message
    this.saveToStorage()
  }

  public updateOptimizationApplicationPrompt(prompt: string): void {
    this.config.optimizationApplicationPrompt = prompt
    this.dirtyFields.add('optimization_application_prompt')
    this.saveToStorage()
  }

  public updateOptimizationApplicationSystemMessage(message: string): void {
    this.config.optimizationApplicationSystemMessage = message
    this.saveToStorage()
  }

  // è´¨é‡åˆ†æé…ç½®æ›´æ–°æ–¹æ³•
  public updateQualityAnalysisSystemPrompt(prompt: string): void {
    this.config.qualityAnalysisSystemPrompt = prompt
    this.dirtyFields.add('quality_analysis_system_prompt')
    this.saveToStorage()
  }

  // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®æ›´æ–°æ–¹æ³•
  public updateUserPromptQualityAnalysis(prompt: string): void {
    this.config.userPromptQualityAnalysis = prompt
    this.dirtyFields.add('user_prompt_quality_analysis')
    this.saveToStorage()
  }

  public updateUserPromptQuickOptimization(prompt: string): void {
    this.config.userPromptQuickOptimization = prompt
    this.dirtyFields.add('user_prompt_quick_optimization')
    this.saveToStorage()
  }

  public updateUserPromptRules(rules: string): void {
    this.config.userPromptRules = rules
    this.saveToStorage()
  }

  // å‘åå…¼å®¹æ–¹æ³•ï¼šè·å–åˆå¹¶åçš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™
  public getFinalPromptGenerationRules(): typeof FINAL_PROMPT_GENERATION_RULES {
    return {
      THINKING_POINTS_EXTRACTION: this.config.thinkingPointsExtractionPrompt,
      SYSTEM_PROMPT_GENERATION: this.config.systemPromptGenerationPrompt,
      OPTIMIZATION_ADVICE_GENERATION: this.config.optimizationAdvicePrompt,
      OPTIMIZATION_APPLICATION: this.config.optimizationApplicationPrompt
    }
  }

  // å‘åå…¼å®¹æ–¹æ³•ï¼šè·å–åˆå¹¶åçš„æœ€ç»ˆæç¤ºè¯ç³»ç»Ÿæ¶ˆæ¯
  public getFinalPromptSystemMessages(): typeof FINAL_PROMPT_SYSTEM_MESSAGES {
    return {
      THINKING_POINTS_SYSTEM: this.config.thinkingPointsSystemMessage,
      SYSTEM_PROMPT_SYSTEM: this.config.systemPromptSystemMessage,
      OPTIMIZATION_ADVICE_SYSTEM: this.config.optimizationAdviceSystemMessage,
      OPTIMIZATION_APPLICATION_SYSTEM: this.config.optimizationApplicationSystemMessage
    }
  }

  public resetToDefaults(): void {
    this.config.systemPromptRules = SYSTEM_PROMPT_RULES
    this.config.userGuidedPromptRules = USER_GUIDED_PROMPT_RULES
    this.config.requirementReportRules = REQUIREMENT_REPORT_RULES
    // é‡ç½®ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®
    this.config.thinkingPointsExtractionPrompt = THINKING_POINTS_EXTRACTION_PROMPT
    this.config.thinkingPointsSystemMessage = THINKING_POINTS_SYSTEM_MESSAGE
    this.config.systemPromptGenerationPrompt = SYSTEM_PROMPT_GENERATION_PROMPT
    this.config.systemPromptSystemMessage = SYSTEM_PROMPT_SYSTEM_MESSAGE
    this.config.optimizationAdvicePrompt = OPTIMIZATION_ADVICE_PROMPT
    this.config.optimizationAdviceSystemMessage = OPTIMIZATION_ADVICE_SYSTEM_MESSAGE
    this.config.optimizationApplicationPrompt = OPTIMIZATION_APPLICATION_PROMPT
    this.config.optimizationApplicationSystemMessage = OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE
    // é‡ç½®è´¨é‡åˆ†æé…ç½®
    this.config.qualityAnalysisSystemPrompt = QUALITY_ANALYSIS_SYSTEM_PROMPT
    // é‡ç½®ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®
    this.config.userPromptQuickOptimization = USER_PROMPT_OPTIMIZATION_CONFIG.quick
    this.config.userPromptRules = USER_PROMPT_RULES
    this.saveToStorage()
  }

  // é‡ç½®ç³»ç»Ÿæç¤ºè¯è§„åˆ™ä¸ºé»˜è®¤å€¼
  public async resetSystemPromptRules(): Promise<void> {
    this.config.systemPromptRules = SYSTEM_PROMPT_RULES
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['system_prompt_rules'])
  }

  // é‡ç½®ç”¨æˆ·å¼•å¯¼è§„åˆ™ä¸ºé»˜è®¤å€¼
  public async resetUserGuidedPromptRules(): Promise<void> {
    this.config.userGuidedPromptRules = USER_GUIDED_PROMPT_RULES
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['user_guided_prompt_rules'])
  }

  // é‡ç½®éœ€æ±‚æŠ¥å‘Šè§„åˆ™ä¸ºé»˜è®¤å€¼
  public async resetRequirementReportRules(): Promise<void> {
    this.config.requirementReportRules = REQUIREMENT_REPORT_RULES
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['requirement_report_rules'])
  }

  // é‡ç½®ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®ä¸ºé»˜è®¤å€¼
  public async resetThinkingPointsExtractionPrompt(): Promise<void> {
    this.config.thinkingPointsExtractionPrompt = THINKING_POINTS_EXTRACTION_PROMPT
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['thinking_points_extraction_prompt'])
  }

  public resetThinkingPointsSystemMessage(): void {
    this.config.thinkingPointsSystemMessage = THINKING_POINTS_SYSTEM_MESSAGE
    this.saveToStorage()
  }

  public async resetSystemPromptGenerationPrompt(): Promise<void> {
    this.config.systemPromptGenerationPrompt = SYSTEM_PROMPT_GENERATION_PROMPT
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['system_prompt_generation_prompt'])
  }

  public resetSystemPromptSystemMessage(): void {
    this.config.systemPromptSystemMessage = SYSTEM_PROMPT_SYSTEM_MESSAGE
    this.saveToStorage()
  }

  public async resetOptimizationAdvicePrompt(): Promise<void> {
    this.config.optimizationAdvicePrompt = OPTIMIZATION_ADVICE_PROMPT
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['optimization_advice_prompt'])
  }

  public resetOptimizationAdviceSystemMessage(): void {
    this.config.optimizationAdviceSystemMessage = OPTIMIZATION_ADVICE_SYSTEM_MESSAGE
    this.saveToStorage()
  }

  public async resetOptimizationApplicationPrompt(): Promise<void> {
    this.config.optimizationApplicationPrompt = OPTIMIZATION_APPLICATION_PROMPT
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['optimization_application_prompt'])
  }

  public resetOptimizationApplicationSystemMessage(): void {
    this.config.optimizationApplicationSystemMessage = OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE
    this.saveToStorage()
  }

  // é‡ç½®è´¨é‡åˆ†æé…ç½®ä¸ºé»˜è®¤å€¼
  public async resetQualityAnalysisSystemPrompt(): Promise<void> {
    this.config.qualityAnalysisSystemPrompt = QUALITY_ANALYSIS_SYSTEM_PROMPT
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['quality_analysis_system_prompt'])
  }

  // é‡ç½®ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®ä¸ºé»˜è®¤å€¼
  public async resetUserPromptQualityAnalysis(): Promise<void> {
    this.config.userPromptQualityAnalysis = USER_PROMPT_QUALITY_ANALYSIS
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['user_prompt_quality_analysis'])
  }

  public async resetUserPromptQuickOptimization(): Promise<void> {
    this.config.userPromptQuickOptimization = USER_PROMPT_OPTIMIZATION_CONFIG.quick
    this.saveToStorage()
    const { deleteUserPromptRules } = await import('@/services/apiService')
    await deleteUserPromptRules(['user_prompt_quick_optimization'])
  }

  public resetUserPromptRules(): void {
    this.config.userPromptRules = USER_PROMPT_RULES
    this.saveToStorage()
  }

  private saveToStorage(): void {
    try {
      localStorage.setItem('yprompt_config', JSON.stringify(this.config))
    } catch (error) {
    }
  }

  /**
   * ä¿å­˜åˆ°äº‘ç«¯ï¼ˆåªä¿å­˜ä¿®æ”¹è¿‡çš„å­—æ®µï¼‰
   */
  public async saveToCloud(): Promise<void> {
    try {
      if (this.dirtyFields.size === 0) {
        console.log('[PromptConfig] æ— ä¿®æ”¹ï¼Œè·³è¿‡ä¿å­˜')
        return
      }

      const { saveUserPromptRules } = await import('@/services/apiService')
      
      // æ˜ å°„å…³ç³»ï¼šé©¼å³° -> ä¸‹åˆ’çº¿
      const fieldMapping: Record<string, keyof PromptConfig> = {
        'system_prompt_rules': 'systemPromptRules',
        'user_guided_prompt_rules': 'userGuidedPromptRules',
        'requirement_report_rules': 'requirementReportRules',
        'thinking_points_extraction_prompt': 'thinkingPointsExtractionPrompt',
        'thinking_points_system_message': 'thinkingPointsSystemMessage',
        'system_prompt_generation_prompt': 'systemPromptGenerationPrompt',
        'system_prompt_system_message': 'systemPromptSystemMessage',
        'optimization_advice_prompt': 'optimizationAdvicePrompt',
        'optimization_advice_system_message': 'optimizationAdviceSystemMessage',
        'optimization_application_prompt': 'optimizationApplicationPrompt',
        'optimization_application_system_message': 'optimizationApplicationSystemMessage',
        'quality_analysis_system_prompt': 'qualityAnalysisSystemPrompt',
        'user_prompt_quality_analysis': 'userPromptQualityAnalysis',
        'user_prompt_quick_optimization': 'userPromptQuickOptimization',
        'user_prompt_rules': 'userPromptRules'
      }
      
      // åªä¿å­˜ä¿®æ”¹è¿‡çš„å­—æ®µ
      const cloudData: Record<string, any> = {}
      this.dirtyFields.forEach(fieldName => {
        const configKey = fieldMapping[fieldName]
        if (configKey) {
          cloudData[fieldName] = this.config[configKey]
        }
      })
      
      console.log('[PromptConfig] ä¿å­˜ä¿®æ”¹çš„å­—æ®µ:', Array.from(this.dirtyFields))
      await saveUserPromptRules(cloudData)
      
      // ä¿å­˜æˆåŠŸåï¼Œæ¸…ç©ºè„å­—æ®µæ ‡è®°
      this.dirtyFields.clear()
      this.saveToStorage()
    } catch (error) {
      console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error)
      throw error
    }
  }

  /**
   * ä»äº‘ç«¯åŠ è½½é…ç½®ï¼ˆæµè§ˆå™¨ä¼šè¯æœŸé—´åªè°ƒç”¨ä¸€æ¬¡ï¼‰
   */
  public async loadFromCloud(): Promise<boolean> {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆæœ‰tokenï¼‰
      const token = localStorage.getItem('yprompt_token')
      if (!token) {
        console.log('[PromptConfig] æœªç™»å½•ï¼Œè·³è¿‡äº‘ç«¯åŠ è½½')
        return false
      }
      
      // æ£€æŸ¥æœ¬æ¬¡ä¼šè¯æ˜¯å¦å·²åŠ è½½è¿‡ï¼ˆä½¿ç”¨sessionStorageï¼Œå…³é—­æµè§ˆå™¨åå¤±æ•ˆï¼‰
      const sessionLoaded = sessionStorage.getItem('yprompt_config_session_loaded')
      if (sessionLoaded === 'true') {
        console.log('[PromptConfig] æœ¬æ¬¡ä¼šè¯å·²åŠ è½½ï¼Œè·³è¿‡APIè°ƒç”¨')
        return true
      }
      
      console.log('[PromptConfig] é¦–æ¬¡ä¼šè¯åŠ è½½ï¼Œä»äº‘ç«¯è·å–æœ€æ–°é…ç½®')
      const { getUserPromptRules } = await import('@/services/apiService')
      const response = await getUserPromptRules()
      
      if (response.code === 200 && response.data) {
        const cloudConfig = response.data
        // åªæœ‰äº‘ç«¯æœ‰æ•°æ®çš„å­—æ®µæ‰è¦†ç›–é»˜è®¤å€¼
        this.config = {
          systemPromptRules: cloudConfig.system_prompt_rules || SYSTEM_PROMPT_RULES,
          userGuidedPromptRules: cloudConfig.user_guided_prompt_rules || USER_GUIDED_PROMPT_RULES,
          requirementReportRules: cloudConfig.requirement_report_rules || REQUIREMENT_REPORT_RULES,
          thinkingPointsExtractionPrompt: cloudConfig.thinking_points_extraction_prompt || THINKING_POINTS_EXTRACTION_PROMPT,
          thinkingPointsSystemMessage: cloudConfig.thinking_points_system_message || THINKING_POINTS_SYSTEM_MESSAGE,
          systemPromptGenerationPrompt: cloudConfig.system_prompt_generation_prompt || SYSTEM_PROMPT_GENERATION_PROMPT,
          systemPromptSystemMessage: cloudConfig.system_prompt_system_message || SYSTEM_PROMPT_SYSTEM_MESSAGE,
          optimizationAdvicePrompt: cloudConfig.optimization_advice_prompt || OPTIMIZATION_ADVICE_PROMPT,
          optimizationAdviceSystemMessage: cloudConfig.optimization_advice_system_message || OPTIMIZATION_ADVICE_SYSTEM_MESSAGE,
          optimizationApplicationPrompt: cloudConfig.optimization_application_prompt || OPTIMIZATION_APPLICATION_PROMPT,
          optimizationApplicationSystemMessage: cloudConfig.optimization_application_system_message || OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE,
          qualityAnalysisSystemPrompt: cloudConfig.quality_analysis_system_prompt || QUALITY_ANALYSIS_SYSTEM_PROMPT,
          userPromptQualityAnalysis: cloudConfig.user_prompt_quality_analysis || USER_PROMPT_QUALITY_ANALYSIS,
          userPromptQuickOptimization: cloudConfig.user_prompt_quick_optimization || USER_PROMPT_OPTIMIZATION_CONFIG.quick,
          userPromptRules: cloudConfig.user_prompt_rules || USER_PROMPT_RULES
        }
        this.saveToStorage()
        // æ ‡è®°æœ¬æ¬¡ä¼šè¯å·²åŠ è½½ï¼ˆå…³é—­æµè§ˆå™¨åå¤±æ•ˆï¼‰
        sessionStorage.setItem('yprompt_config_session_loaded', 'true')
        console.log('[PromptConfig] äº‘ç«¯é…ç½®åŠ è½½æˆåŠŸï¼Œå·²æ ‡è®°ä¼šè¯')
        return true
      } else {
        console.log('[PromptConfig] äº‘ç«¯æ— æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')
        // å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿæ ‡è®°ä¸ºå·²åŠ è½½
        sessionStorage.setItem('yprompt_config_session_loaded', 'true')
        return false
      }
    } catch (error) {
      console.error('[PromptConfig] ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error)
      // å¤±è´¥ä¹Ÿæ ‡è®°ï¼Œé¿å…åå¤è¯·æ±‚
      sessionStorage.setItem('yprompt_config_session_loaded', 'true')
      return false
    }
  }
  
  /**
   * æ‰‹åŠ¨åˆ·æ–°äº‘ç«¯é…ç½®ï¼ˆç”¨äºç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼‰
   */
  public async forceReloadFromCloud(): Promise<boolean> {
    sessionStorage.removeItem('yprompt_config_session_loaded')
    return this.loadFromCloud()
  }

  public async deleteFromCloud(): Promise<void> {
    try {
      const { deleteUserPromptRules } = await import('@/services/apiService')
      await deleteUserPromptRules()
    } catch (error) {
      console.error('åˆ é™¤äº‘ç«¯é…ç½®å¤±è´¥:', error)
      throw error
    }
  }

  private loadFromStorage(): void {
    try {
      const saved = localStorage.getItem('yprompt_config')
      if (saved) {
        const parsed = JSON.parse(saved)
        // åªåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰çš„å†…å®¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
        this.config.systemPromptRules = parsed.systemPromptRules || SYSTEM_PROMPT_RULES
        this.config.userGuidedPromptRules = parsed.userGuidedPromptRules || USER_GUIDED_PROMPT_RULES
        this.config.requirementReportRules = parsed.requirementReportRules || REQUIREMENT_REPORT_RULES
        // åŠ è½½ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®ï¼Œå‘åå…¼å®¹æ—§ç‰ˆæœ¬
        this.config.thinkingPointsExtractionPrompt = parsed.thinkingPointsExtractionPrompt || THINKING_POINTS_EXTRACTION_PROMPT
        this.config.thinkingPointsSystemMessage = parsed.thinkingPointsSystemMessage || THINKING_POINTS_SYSTEM_MESSAGE
        this.config.systemPromptGenerationPrompt = parsed.systemPromptGenerationPrompt || SYSTEM_PROMPT_GENERATION_PROMPT
        this.config.systemPromptSystemMessage = parsed.systemPromptSystemMessage || SYSTEM_PROMPT_SYSTEM_MESSAGE
        this.config.optimizationAdvicePrompt = parsed.optimizationAdvicePrompt || OPTIMIZATION_ADVICE_PROMPT
        this.config.optimizationAdviceSystemMessage = parsed.optimizationAdviceSystemMessage || OPTIMIZATION_ADVICE_SYSTEM_MESSAGE
        this.config.optimizationApplicationPrompt = parsed.optimizationApplicationPrompt || OPTIMIZATION_APPLICATION_PROMPT
        this.config.optimizationApplicationSystemMessage = parsed.optimizationApplicationSystemMessage || OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE
        // åŠ è½½è´¨é‡åˆ†æé…ç½®
        this.config.qualityAnalysisSystemPrompt = parsed.qualityAnalysisSystemPrompt || QUALITY_ANALYSIS_SYSTEM_PROMPT
        // åŠ è½½ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®
        this.config.userPromptQualityAnalysis = parsed.userPromptQualityAnalysis || USER_PROMPT_QUALITY_ANALYSIS
        this.config.userPromptQuickOptimization = parsed.userPromptQuickOptimization || USER_PROMPT_OPTIMIZATION_CONFIG.quick
        this.config.userPromptRules = parsed.userPromptRules || USER_PROMPT_RULES
      }
    } catch (error) {
      // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
      this.config = {
        systemPromptRules: SYSTEM_PROMPT_RULES,
        userGuidedPromptRules: USER_GUIDED_PROMPT_RULES,
        requirementReportRules: REQUIREMENT_REPORT_RULES,
        // ç‹¬ç«‹çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆé…ç½®
        thinkingPointsExtractionPrompt: THINKING_POINTS_EXTRACTION_PROMPT,
        thinkingPointsSystemMessage: THINKING_POINTS_SYSTEM_MESSAGE,
        systemPromptGenerationPrompt: SYSTEM_PROMPT_GENERATION_PROMPT,
        systemPromptSystemMessage: SYSTEM_PROMPT_SYSTEM_MESSAGE,
        optimizationAdvicePrompt: OPTIMIZATION_ADVICE_PROMPT,
        optimizationAdviceSystemMessage: OPTIMIZATION_ADVICE_SYSTEM_MESSAGE,
        optimizationApplicationPrompt: OPTIMIZATION_APPLICATION_PROMPT,
        optimizationApplicationSystemMessage: OPTIMIZATION_APPLICATION_SYSTEM_MESSAGE,
        // ç³»ç»Ÿæç¤ºè¯è´¨é‡åˆ†æé…ç½®
        qualityAnalysisSystemPrompt: QUALITY_ANALYSIS_SYSTEM_PROMPT,
        // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–é…ç½®
        userPromptQualityAnalysis: USER_PROMPT_QUALITY_ANALYSIS,
        userPromptQuickOptimization: USER_PROMPT_OPTIMIZATION_CONFIG.quick,
        userPromptRules: USER_PROMPT_RULES
      }
    }
  }
}

// å•ä¾‹å®ä¾‹å¯¼å‡º
export const promptConfigManager = PromptConfigManager.getInstance()
```


## src/env.d.ts

```ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_BASE_URL: string
  readonly VITE_FEISHU_APP_ID: string
  readonly VITE_LOGIN_USERNAME?: string
  readonly VITE_LOGIN_PASSWORD?: string
  readonly VITE_GIT_COMMIT_HASH?: string
  readonly VITE_GIT_COMMIT_DATE?: string
  readonly VITE_DEBUG_MODE?: string  // 'true' å¯ç”¨ debug æ¨¡å¼
  readonly MODE?: string  // 'debug' æ¨¡å¼
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```


## src/hooks/useChatAttachments.ts

```ts
import { useState, useRef, useCallback } from 'react'
import type { MessageAttachment } from '@/stores/promptStore'
import { useNotificationStore } from '@/stores/notificationStore'

export function useChatAttachments() {
  const notificationStore = useNotificationStore()
  const [currentAttachments, setCurrentAttachments] = useState<MessageAttachment[]>([])
  const [isGlobalDragging, setIsGlobalDragging] = useState(false)
  const fileInputRef = useRef<HTMLInputElement>(null)

  const triggerFileSelect = useCallback(() => {
    if (fileInputRef.current) {
      fileInputRef.current.click()
    }
  }, [])

  const handleFileSelect = useCallback(async (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || [])
    
    if (files.length > 0) {
      try {
        const { processFiles } = await import('@/utils/fileUtils')
        const result = await processFiles(files)
        
        if (result.attachments.length > 0) {
          setCurrentAttachments(prev => [...prev, ...result.attachments])
        }
        
        if (result.errors.length > 0) {
          result.errors.forEach(error => notificationStore.error(error))
        }
      } catch (error) {
        notificationStore.error('æ–‡ä»¶å¤„ç†å¤±è´¥')
      }
      
      event.target.value = ''
    }
  }, [notificationStore])

  const removeAttachment = useCallback((attachmentId: string) => {
    setCurrentAttachments(prev => prev.filter(att => att.id !== attachmentId))
  }, [])

  const clearAttachments = useCallback(() => {
    setCurrentAttachments([])
  }, [])

  const handleGlobalDragEnter = useCallback((event: React.DragEvent) => {
    event.preventDefault()
    if (event.dataTransfer?.items) {
      for (let i = 0; i < event.dataTransfer.items.length; i++) {
        if (event.dataTransfer.items[i].kind === 'file') {
          setIsGlobalDragging(true)
          break
        }
      }
    }
  }, [])

  const handleGlobalDragOver = useCallback((event: React.DragEvent) => {
    event.preventDefault()
    setIsGlobalDragging(true)
  }, [])

  const handleGlobalDragLeave = useCallback((event: React.DragEvent) => {
    event.preventDefault()
    const target = event.currentTarget as HTMLElement
    const rect = target.getBoundingClientRect()
    const x = event.clientX
    const y = event.clientY
    
    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
      setIsGlobalDragging(false)
    }
  }, [])

  const handleGlobalDrop = useCallback(async (event: React.DragEvent) => {
    event.preventDefault()
    setIsGlobalDragging(false)
    
    const files = Array.from(event.dataTransfer?.files || [])
    if (files.length > 0) {
      try {
        const { processFiles } = await import('@/utils/fileUtils')
        const result = await processFiles(files)
        
        if (result.attachments.length > 0) {
          setCurrentAttachments(prev => [...prev, ...result.attachments])
        }
        
        if (result.errors.length > 0) {
          result.errors.forEach(error => notificationStore.error(error))
        }
      } catch (error) {
        notificationStore.error('æ–‡ä»¶å¤„ç†å¤±è´¥')
      }
    }
  }, [notificationStore])

  return {
    currentAttachments,
    isGlobalDragging,
    fileInputRef,
    triggerFileSelect,
    handleFileSelect,
    removeAttachment,
    clearAttachments,
    handleGlobalDragEnter,
    handleGlobalDragOver,
    handleGlobalDragLeave,
    handleGlobalDrop
  }
}

```


## src/hooks/useChatInput.ts

```ts
import { useState, useRef, useCallback } from 'react'

export function useChatInput() {
  const [userInput, setUserInput] = useState('')
  const textareaRef = useRef<HTMLTextAreaElement>(null)
  const [isComposing, setIsComposing] = useState(false)

  const adjustTextareaHeight = useCallback(() => {
    // å¯ä»¥åœ¨è¿™é‡Œå®ç°è‡ªåŠ¨è°ƒæ•´é«˜åº¦é€»è¾‘
  }, [])

  const handleCompositionStart = useCallback(() => {
    setIsComposing(true)
  }, [])

  const handleCompositionEnd = useCallback(() => {
    setIsComposing(false)
  }, [])

  const handleKeydown = useCallback((event: React.KeyboardEvent, onSend: () => void) => {
    if (event.key === 'Enter') {
      if (event.shiftKey) {
        return
      } else {
        if (isComposing) {
          return
        }
        event.preventDefault()
        onSend()
      }
    }
  }, [isComposing])

  const clearInput = useCallback(() => {
    setUserInput('')
    const textarea = textareaRef.current
    if (textarea) {
      textarea.style.height = '80px'
    }
  }, [])

  return {
    userInput,
    setUserInput,
    textareaRef,
    isComposing,
    adjustTextareaHeight,
    handleCompositionStart,
    handleCompositionEnd,
    handleKeydown,
    clearInput
  }
}

```


## src/hooks/useChatLogic.ts

```ts
import { useEffect, useMemo, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { useProviderStore } from '@/stores/providerStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { AIGuideService } from '@/services/aiGuideService'
import { AIService } from '@/services/aiService'
import { PromptGeneratorService } from '@/services/promptGeneratorService'
import { getPromptGeneratorConfig } from '@/config/promptGenerator'
import { cleanAIResponse, checkAIDecision } from '@/utils/aiResponseUtils'
import type { useChatMessages } from './useChatMessages'
import type { useChatModel } from './useChatModel'
import type { useChatInput } from './useChatInput'
import type { useChatAttachments } from './useChatAttachments'
import type { useChatQuickReplies } from './useChatQuickReplies'

interface UseChatLogicParams {
  chatMessages: ReturnType<typeof useChatMessages>
  chatModel: ReturnType<typeof useChatModel>
  chatInput: ReturnType<typeof useChatInput>
  chatAttachments: ReturnType<typeof useChatAttachments>
  chatQuickReplies: ReturnType<typeof useChatQuickReplies>
}

export function useChatLogic({
  chatMessages,
  chatModel,
  chatInput,
  chatAttachments,
  chatQuickReplies
}: UseChatLogicParams) {
  const promptStore = usePromptStore()
  const providerStore = useProviderStore()
  const notificationStore = useNotificationStore()
  const config = getPromptGeneratorConfig()
  const aiGuideService = AIGuideService.getInstance()

  const isAbortError = useCallback((error: unknown) => {
    return (error instanceof DOMException && error.name === 'AbortError') || (error as any)?.name === 'AbortError'
  }, [])

  const chatContainerMaxHeight = useMemo(() => {
    let baseCalculation = 345
    let attachmentExtraHeight = 0
    if (chatAttachments.currentAttachments.length > 0) {
      attachmentExtraHeight = 115
    }
    const totalReduction = baseCalculation + attachmentExtraHeight
    return `calc(100vh - ${totalReduction}px)`
  }, [chatAttachments.currentAttachments.length])

  useEffect(() => {
    chatMessages.scrollToBottom()
  }, [promptStore.chatMessages.length, chatMessages])

  useEffect(() => {
    chatMessages.scrollToBottom()
  }, [promptStore.isTyping, chatMessages.scrollToBottom])

  const initializeChat = useCallback(async () => {
    const state = promptStore.getState()
    if (state.chatMessages.length === 0 && !state.isInitialized) {
      promptStore.setState({ isInitialized: true })
      await chatMessages.simulateTyping(config.welcomeMessage, false)
    }
  }, [promptStore, chatMessages, config])

  const clearChat = useCallback(() => {
    promptStore.clearChat()
    chatQuickReplies.setShowQuickReplies(false)
    chatAttachments.clearAttachments()
    
    setTimeout(async () => {
      await chatMessages.simulateTyping(config.welcomeMessage, false)
      promptStore.setState({ isInitialized: true })
    }, 500)
  }, [promptStore, chatQuickReplies, chatAttachments, chatMessages, config])

  const generatePrompt = useCallback(async (provider: any, modelId: string) => {
    try {
      promptStore.clearProgressMessages()

      const validMessages = promptStore.getValidMessages()
      const conversationHistory = validMessages.map(msg => ({
        type: msg.type,
        content: msg.content,
        attachments: msg.attachments || []
      }))
      
      promptStore.setIsGenerating(true)
      promptStore.setCurrentExecutionStep('report')
      promptStore.addOrUpdateProgressMessage('ğŸ”„ æ­£åœ¨åŸºäºå¯¹è¯ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š...', 'progress')
      
      const initState = promptStore.getState()
      promptStore.setState({ promptData: { ...initState.promptData, requirementReport: '' } })
      
      const onReportStreamUpdate = (chunk: string) => {
        const state = promptStore.getState()
        promptStore.promptData.requirementReport = (state.promptData.requirementReport || '') + chunk
        // è§¦å‘çŠ¶æ€æ›´æ–°
        promptStore.setState({ promptData: { ...state.promptData, requirementReport: state.promptData.requirementReport + chunk } })
      }
      
      const requirementReport = await aiGuideService.generateRequirementReportFromConversation(
        conversationHistory,
        provider,
        modelId,
        providerStore.streamMode ? onReportStreamUpdate : undefined
      )

      if (!providerStore.streamMode) {
        const state = promptStore.getState()
        promptStore.setState({ promptData: { ...state.promptData, requirementReport } })
      }
      promptStore.setShowPreview(true)
      
      const state = promptStore.getState()
      if (state.isAutoMode) {
        promptStore.addOrUpdateProgressMessage('âœ… éœ€æ±‚æŠ¥å‘Šå·²ç”Ÿæˆï¼æ­£åœ¨è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„æç¤ºè¯ç”Ÿæˆæµç¨‹...', 'progress')
        
        const promptGeneratorService = PromptGeneratorService.getInstance()
        
        promptStore.setCurrentExecutionStep('thinking')
        promptStore.addOrUpdateProgressMessage('ğŸ”„ æ­¥éª¤ 1/4: æ­£åœ¨åˆ†æéœ€æ±‚å¹¶ç”Ÿæˆå…³é”®æŒ‡ä»¤...', 'progress')
        
        let step1Content = ''
        const onStep1Update = (chunk: string) => {
          step1Content += chunk
          const points = step1Content.split('\n').map(s => s.replace(/^[*-]\s*/, '').trim()).filter(Boolean)
          if (points.length > 0) {
            const step1State = promptStore.getState()
            promptStore.setState({ promptData: { ...step1State.promptData, thinkingPoints: points } })
          }
        }
        
        const step1State = promptStore.getState()
        const thinkingPoints = await promptGeneratorService.getSystemPromptThinkingPoints(
          step1State.promptData.requirementReport || requirementReport,
          modelId,
          'zh',
          [],
          provider,
          providerStore.streamMode ? onStep1Update : undefined
        )
        
        if (!providerStore.streamMode) {
          const afterStep1State = promptStore.getState()
          promptStore.setState({ promptData: { ...afterStep1State.promptData, thinkingPoints } })
        }
        
        promptStore.setCurrentExecutionStep('initial')
        promptStore.addOrUpdateProgressMessage('ğŸ”„ æ­¥éª¤ 2/4: æ­£åœ¨åŸºäºå…³é”®æŒ‡ä»¤ç”Ÿæˆåˆå§‹æç¤ºè¯...', 'progress')
        
        const step2State = promptStore.getState()
        promptStore.setState({ promptData: { ...step2State.promptData, initialPrompt: '' } })
        const onStep2Update = (chunk: string) => {
          const state = promptStore.getState()
          const newInitialPrompt = (state.promptData.initialPrompt || '') + chunk
          promptStore.setState({ promptData: { ...state.promptData, initialPrompt: newInitialPrompt } })
        }
        
        const step2StateForPrompt = promptStore.getState()
        const initialPrompt = await promptGeneratorService.generateSystemPrompt(
          step2StateForPrompt.promptData.requirementReport || requirementReport,
          modelId,
          'zh',
          [],
          step2StateForPrompt.promptData.thinkingPoints || thinkingPoints,
          provider,
          providerStore.streamMode ? onStep2Update : undefined
        )
        
        if (!providerStore.streamMode) {
          const afterStep2State = promptStore.getState()
          promptStore.setState({ promptData: { ...afterStep2State.promptData, initialPrompt } })
        }
        
        promptStore.setCurrentExecutionStep('advice')
        promptStore.addOrUpdateProgressMessage('ğŸ”„ æ­¥éª¤ 3/4: æ­£åœ¨åˆ†ææç¤ºè¯å¹¶ç”Ÿæˆä¼˜åŒ–å»ºè®®...', 'progress')
        
        let step3Content = ''
        const onStep3Update = (chunk: string) => {
          step3Content += chunk
          const adviceList = step3Content.split('\n').map(s => s.replace(/^[*-]\s*/, '').trim()).filter(Boolean)
          if (adviceList.length > 0) {
            const step3State = promptStore.getState()
            promptStore.setState({ promptData: { ...step3State.promptData, advice: adviceList } })
          }
        }
        
        const step3StateForAdvice = promptStore.getState()
        const advice = await promptGeneratorService.getOptimizationAdvice(
          step3StateForAdvice.promptData.initialPrompt || initialPrompt,
          'system',
          modelId,
          'zh',
          [],
          provider,
          providerStore.streamMode ? onStep3Update : undefined
        )
        
        if (!providerStore.streamMode) {
          const afterStep3State = promptStore.getState()
          promptStore.setState({ promptData: { ...afterStep3State.promptData, advice } })
        }
        
        promptStore.setCurrentExecutionStep('final')
        promptStore.addOrUpdateProgressMessage('ğŸ”„ æ­¥éª¤ 4/4: æ­£åœ¨åº”ç”¨ä¼˜åŒ–å»ºè®®ï¼Œç”Ÿæˆæœ€ç»ˆæç¤ºè¯...', 'progress')
        
        const step4InitState = promptStore.getState()
        promptStore.setState({ promptData: { ...step4InitState.promptData, generatedPrompt: '' } })
        const onStep4Update = (chunk: string) => {
          const step4State = promptStore.getState()
          const currentPrompt = typeof step4State.promptData.generatedPrompt === 'string' 
            ? step4State.promptData.generatedPrompt 
            : ('zh' in step4State.promptData.generatedPrompt ? step4State.promptData.generatedPrompt.zh : '')
          const newPrompt = currentPrompt + chunk
          promptStore.setState({ promptData: { ...step4State.promptData, generatedPrompt: newPrompt } })
        }
        
        const step4StateForFinal = promptStore.getState()
        const finalPrompt = await promptGeneratorService.applyOptimizationAdvice(
          step4StateForFinal.promptData.initialPrompt || initialPrompt,
          step4StateForFinal.promptData.advice || advice,
          'system',
          modelId,
          'zh',
          [],
          provider,
          providerStore.streamMode ? onStep4Update : undefined
        )
        
        if (!providerStore.streamMode) {
          const afterStep4State = promptStore.getState()
          promptStore.setState({ promptData: { ...afterStep4State.promptData, generatedPrompt: finalPrompt } })
        }
        promptStore.addOrUpdateProgressMessage('âœ… å·²ä¸ºæ‚¨ç”Ÿæˆé«˜è´¨é‡çš„AIæç¤ºè¯ï¼å³ä¾§å¯æŸ¥çœ‹å®Œæ•´çš„ç”Ÿæˆè¿‡ç¨‹å’Œæœ€ç»ˆç»“æœã€‚', 'progress')
        
      } else {
        promptStore.addOrUpdateProgressMessage('âœ… éœ€æ±‚æŠ¥å‘Šå·²ç”Ÿæˆï¼è¯·åœ¨å³ä¾§é¢„è§ˆé¢æ¿ä¸­æŸ¥çœ‹ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ã€‚', 'progress')
      }
      
      promptStore.isGenerating = false
      promptStore.currentExecutionStep = null
      
    } catch (error: unknown) {
      promptStore.setIsGenerating(false)
      promptStore.setCurrentExecutionStep(null)

      if (isAbortError(error)) {
        notificationStore.info('ç”Ÿæˆå·²ä¸­æ–­')
        return
      }

      const errorMessage = error instanceof Error ? error.message : String(error)
      notificationStore.error(`æç¤ºè¯ç”Ÿæˆå¤±è´¥: ${errorMessage}ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®åé‡è¯•`)
    }
  }, [promptStore, providerStore, aiGuideService, notificationStore, isAbortError])

  const sendMessage = useCallback(async (userInput: string) => {
    if (!userInput.trim()) {
      if (chatAttachments.currentAttachments.length > 0) {
        notificationStore.warning('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼Œä¸èƒ½åªå‘é€é™„ä»¶')
      }
      return
    }
    
    // ç¡®ä¿ providerStore å·²åˆå§‹åŒ–
    if (!providerStore.isInitialized) {
      console.log('[useChatLogic] providerStore æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–...')
      try {
        await providerStore.initialize()
        // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿çŠ¶æ€å·²æ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 100))
      } catch (error) {
        console.error('[useChatLogic] åˆå§‹åŒ– providerStore å¤±è´¥:', error)
        notificationStore.error('æ— æ³•åŠ è½½AIæ¨¡å‹é…ç½®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
        return
      }
    }

    // å¦‚æœåˆå§‹åŒ–åä»ç„¶æ²¡æœ‰é€‰æ‹©ï¼Œå°è¯•ä» store è·å–æœ€æ–°çš„çŠ¶æ€
    const storeState = useProviderStore.getState()
    if (!storeState.selectedProviderId && storeState.enabledProviders.length > 0) {
      const firstProvider = storeState.enabledProviders[0]
      console.log('[useChatLogic] æ£€æµ‹åˆ°æ²¡æœ‰é€‰æ‹©ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†:', firstProvider.name)
      storeState.setSelectedProvider(firstProvider.id)
      if (firstProvider.models.length > 0) {
        storeState.setSelectedModel(firstProvider.models[0].id)
      }
      // ç­‰å¾…çŠ¶æ€æ›´æ–°
      await new Promise(resolve => setTimeout(resolve, 50))
    }

    const { provider, model } = chatModel.getCurrentChatModel()

    console.log('[useChatLogic] sendMessage æ£€æŸ¥æ¨¡å‹é…ç½®:', {
      provider,
      model,
      hasProvider: !!provider,
      hasModel: !!model,
      providerName: provider?.name,
      modelName: model?.name,
      isInitialized: providerStore.isInitialized,
      providersCount: providerStore.providers.length,
      selectedProviderId: providerStore.selectedProviderId,
      selectedModelId: providerStore.selectedModelId
    })

    if (!provider || !model) {
      // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
      const providerStoreState = {
        selectedProviderId: providerStore.selectedProviderId,
        selectedModelId: providerStore.selectedModelId,
        providersCount: providerStore.providers.length,
        isInitialized: providerStore.isInitialized,
        enabledProvidersCount: providerStore.enabledProviders.length
      }

      console.error('[useChatLogic] æ¨¡å‹é…ç½®æ£€æµ‹å¤±è´¥:', {
        providerStoreState,
        currentProvider: providerStore.currentProvider,
        currentModel: providerStore.currentModel,
        enabledProviders: providerStore.enabledProviders.map(p => ({ id: p.id, name: p.name, modelsCount: p.models.length }))
      })

      // å¦‚æœ providers å·²åŠ è½½ä½†æ²¡æœ‰é€‰æ‹©ï¼Œæç¤ºç”¨æˆ·é€‰æ‹©
      if (providerStore.isInitialized && providerStore.enabledProviders.length > 0) {
        notificationStore.warning('è¯·å…ˆåœ¨å¯¼èˆªæ é€‰æ‹©AIæ¨¡å‹ï¼Œæˆ–åœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥')
      } else if (!providerStore.isInitialized) {
        notificationStore.error('AIæ¨¡å‹é…ç½®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™å†è¯•')
      } else {
        notificationStore.warning('è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥')
      }
      return
    }

    promptStore.clearProgressMessages()

    const currentInput = userInput
    const attachments = [...chatAttachments.currentAttachments]
    
    const isForceGenerate = chatQuickReplies.checkForceGenerate(currentInput)
    
    promptStore.addMessage('user', currentInput, attachments)
    
    chatInput.clearInput()
    chatAttachments.clearAttachments()
    chatQuickReplies.setShowQuickReplies(false)
    
    if (isForceGenerate) {
      await chatMessages.simulateTyping('å¥½çš„,æˆ‘å°†ç«‹å³ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šã€‚', false)

      setTimeout(async () => {
        const globalProvider = providerStore.currentProvider
        const globalModel = providerStore.currentModel
        if (globalProvider && globalModel) {
          await generatePrompt(globalProvider, globalModel.id)
        }
      }, 800)
      return
    }

    promptStore.setIsTyping(true)
    promptStore.setIsGenerating(true)

    try {
      const useStreamMode = chatModel.isStreamMode
      
      if (useStreamMode) {
        const aiService = AIService.getInstance()
        
        let streamingContent = ''
        let messageIndex = -1
        
        aiService.setStreamUpdateCallback((chunk: string) => {
          if (messageIndex === -1) {
            messageIndex = chatMessages.startStreamingMessage()
          }
          streamingContent += chunk
          const cleanContent = cleanAIResponse(streamingContent)
          chatMessages.updateStreamingMessage(messageIndex, cleanContent)
          chatMessages.scrollToBottom()
        })
        
        const validMessages = promptStore.getValidMessages()
        const conversationHistory = validMessages.map(msg => ({
          type: msg.type,
          content: msg.content,
          attachments: msg.attachments || []
        }))
        
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          useStreamMode
        )

        aiService.clearStreamUpdateCallback()

        if (useStreamMode && messageIndex === -1) {
          messageIndex = chatMessages.startStreamingMessage()
          const cleanContent = cleanAIResponse(aiResponse)
          chatMessages.updateStreamingMessage(messageIndex, cleanContent)
        } else if (useStreamMode && streamingContent.trim() === '') {
          const cleanContent = cleanAIResponse(aiResponse)
          chatMessages.updateStreamingMessage(messageIndex, cleanContent)
        }

        const shouldEndConversation = checkAIDecision(aiResponse)
        
        promptStore.setIsTyping(false)
        promptStore.setIsGenerating(false)
        
        if (shouldEndConversation || aiResponse.includes('åŸºäºæˆ‘ä»¬çš„å¯¹è¯ï¼Œæˆ‘ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šï¼š')) {
          setTimeout(async () => {
            const globalProvider = providerStore.currentProvider
            const globalModel = providerStore.currentModel
            if (globalProvider && globalModel) {
              await generatePrompt(globalProvider, globalModel.id)
            }
          }, 800)
        }
      } else {
        const validMessages = promptStore.getValidMessages()
        const conversationHistory = validMessages.map(msg => ({
          type: msg.type,
          content: msg.content,
          attachments: msg.attachments || []
        }))
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          useStreamMode
        )

        const shouldEndConversation = checkAIDecision(aiResponse)
        
        if (shouldEndConversation || aiResponse.includes('åŸºäºæˆ‘ä»¬çš„å¯¹è¯ï¼Œæˆ‘ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šï¼š')) {
          const cleanResponse = cleanAIResponse(aiResponse)
          await chatMessages.simulateTyping(cleanResponse, false)

          promptStore.setIsGenerating(false)

          setTimeout(async () => {
            const globalProvider = providerStore.currentProvider
            const globalModel = providerStore.currentModel
            if (globalProvider && globalModel) {
              await generatePrompt(globalProvider, globalModel.id)
            }
          }, 800)
        } else {
          const cleanResponse = cleanAIResponse(aiResponse)
          await chatMessages.simulateTyping(cleanResponse, false)
          
          promptStore.isGenerating = false
        }
      }
      } catch (error: unknown) {
      promptStore.setIsTyping(false)
      promptStore.setIsGenerating(false)

      if (isAbortError(error)) {
        if (chatModel.isStreamMode) {
          const aiService = AIService.getInstance()
          aiService.clearStreamUpdateCallback()
        }
        return
      }

      const errorMessage = error instanceof Error ? error.message : String(error)
      notificationStore.error(`å‘ç”Ÿé”™è¯¯: ${errorMessage}`)

      if (chatModel.isStreamMode) {
        const aiService = AIService.getInstance()
        aiService.clearStreamUpdateCallback()
      }
    }
  }, [
    chatAttachments,
    chatModel,
    chatInput,
    chatQuickReplies,
    chatMessages,
    promptStore,
    providerStore,
    notificationStore,
    aiGuideService,
    generatePrompt,
    isAbortError
  ])

  const regenerateMessage = useCallback(async (messageId: string, messageIndex: number, provider: any, model: any) => {
    const message = promptStore.chatMessages.find(msg => msg.id === messageId)
    if (!message || message.type !== 'ai') {
      return
    }

    if (!provider || !model) {
      notificationStore.warning('è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥')
      return
    }

    try {
      promptStore.clearProgressMessages()
      
      const contextMessages = promptStore.getValidMessages().slice(0, messageIndex)
      const conversationHistory = contextMessages.map(msg => ({
        type: msg.type,
        content: msg.content,
        attachments: msg.attachments || []
      }))
      
      promptStore.setIsTyping(true)
      
      if (chatModel.isStreamMode) {
        const aiService = AIService.getInstance()
        
        let streamingContent = ''
        
        aiService.setStreamUpdateCallback((chunk: string) => {
          streamingContent += chunk
          const cleanContent = cleanAIResponse(streamingContent)
          promptStore.updateMessage(messageId, cleanContent)
          chatMessages.scrollToBottom()
        })
        
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          true
        )

        aiService.clearStreamUpdateCallback()
        
        const finalContent = cleanAIResponse(aiResponse)
        promptStore.updateMessage(messageId, finalContent)
        
      } else {
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          false
        )
        
        const cleanResponse = cleanAIResponse(aiResponse)
        promptStore.updateMessage(messageId, cleanResponse)
      }
      
      promptStore.setIsTyping(false)
      notificationStore.success('æ¶ˆæ¯å·²é‡æ–°ç”Ÿæˆ')
      
    } catch (error: unknown) {
      promptStore.setIsTyping(false)

      if (isAbortError(error)) {
        if (chatModel.isStreamMode) {
          const aiService = AIService.getInstance()
          aiService.clearStreamUpdateCallback()
        }
        return
      }

      const errorMessage = error instanceof Error ? error.message : String(error)
      notificationStore.error(`é‡æ–°ç”Ÿæˆå¤±è´¥: ${errorMessage}`)

      if (chatModel.isStreamMode) {
        const aiService = AIService.getInstance()
        aiService.clearStreamUpdateCallback()
      }
    }
  }, [promptStore, chatModel, notificationStore, aiGuideService, chatMessages, isAbortError])

  const resendUserMessage = useCallback(async (messageId: string, messageIndex: number, provider: any, model: any) => {
    const message = promptStore.chatMessages.find(msg => msg.id === messageId)
    if (!message || message.type !== 'user') {
      return
    }

    if (!provider || !model) {
      notificationStore.warning('è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥')
      return
    }

    try {
      promptStore.clearProgressMessages()
      
      if (messageIndex !== -1) {
        for (let i = messageIndex + 1; i < promptStore.chatMessages.length; i++) {
          const msg = promptStore.chatMessages[i]
          if (msg && !msg.isProgress) {
            promptStore.deleteMessage(msg.id!)
          }
        }
      }

      promptStore.setIsTyping(true)

      const useStreamMode = chatModel.isStreamMode
      
      if (useStreamMode) {
        const aiService = AIService.getInstance()
        
        let streamingContent = ''
        let msgIndex = -1
        
        aiService.setStreamUpdateCallback((chunk: string) => {
          if (msgIndex === -1) {
            msgIndex = chatMessages.startStreamingMessage()
          }
          streamingContent += chunk
          const cleanContent = cleanAIResponse(streamingContent)
          chatMessages.updateStreamingMessage(msgIndex, cleanContent)
          chatMessages.scrollToBottom()
        })
        
        const validMessages = promptStore.getValidMessages()
        const conversationHistory = validMessages.map(msg => ({
          type: msg.type,
          content: msg.content,
          attachments: msg.attachments || []
        }))
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          useStreamMode
        )

        aiService.clearStreamUpdateCallback()

        const shouldEndConversation = checkAIDecision(aiResponse)
        
        promptStore.setIsTyping(false)
        
        if (shouldEndConversation || aiResponse.includes('åŸºäºæˆ‘ä»¬çš„å¯¹è¯ï¼Œæˆ‘ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šï¼š')) {
          setTimeout(async () => {
            const globalProvider = providerStore.currentProvider
            const globalModel = providerStore.currentModel
            if (globalProvider && globalModel) {
              await generatePrompt(globalProvider, globalModel.id)
            }
          }, 800)
        }
      } else {
        const validMessages = promptStore.getValidMessages()
        const conversationHistory = validMessages.map(msg => ({
          type: msg.type,
          content: msg.content,
          attachments: msg.attachments || []
        }))
        const aiResponse = await aiGuideService.generateSimpleResponse(
          '',
          conversationHistory,
          provider,
          model.id,
          useStreamMode
        )

        const shouldEndConversation = checkAIDecision(aiResponse)
        
        if (shouldEndConversation || aiResponse.includes('åŸºäºæˆ‘ä»¬çš„å¯¹è¯ï¼Œæˆ‘ç°åœ¨ä¸ºæ‚¨ç”Ÿæˆéœ€æ±‚æŠ¥å‘Šï¼š')) {
          const cleanResponse = cleanAIResponse(aiResponse)
          await chatMessages.simulateTyping(cleanResponse, false)

          promptStore.setIsTyping(false)

          setTimeout(async () => {
            const globalProvider = providerStore.currentProvider
            const globalModel = providerStore.currentModel
            if (globalProvider && globalModel) {
              await generatePrompt(globalProvider, globalModel.id)
            }
          }, 800)
        } else {
          const cleanResponse = cleanAIResponse(aiResponse)
          await chatMessages.simulateTyping(cleanResponse, false)
          
          promptStore.setIsTyping(false)
        }
      }
    } catch (error: unknown) {
      promptStore.setIsTyping(false)
      promptStore.setIsGenerating(false)

      if (isAbortError(error)) {
        if (chatModel.isStreamMode) {
          const aiService = AIService.getInstance()
          aiService.clearStreamUpdateCallback()
        }
        return
      }

      const errorMessage = error instanceof Error ? error.message : String(error)
      notificationStore.error(`é‡æ–°å‘é€å¤±è´¥: ${errorMessage}`)

      if (chatModel.isStreamMode) {
        const aiService = AIService.getInstance()
        aiService.clearStreamUpdateCallback()
      }
    }
  }, [
    promptStore,
    chatModel,
    chatMessages,
    providerStore,
    notificationStore,
    aiGuideService,
    generatePrompt,
    isAbortError
  ])

  const interruptGeneration = useCallback(() => {
    aiGuideService.interruptCurrentRequest()
    promptStore.setIsTyping(false)
    promptStore.setIsGenerating(false)
    promptStore.setCurrentExecutionStep(null)
  }, [aiGuideService, promptStore])

  return {
    chatContainerMaxHeight,
    initializeChat,
    clearChat,
    sendMessage,
    generatePrompt,
    regenerateMessage,
    resendUserMessage,
    interruptGeneration
  }
}

```


## src/hooks/useChatMessageOperations.ts

```ts
import { useState, useRef, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { copyToClipboard } from '@/utils/clipboardUtils'

export function useChatMessageOperations() {
  const promptStore = usePromptStore()
  const notificationStore = useNotificationStore()
  
  const [editingContent, setEditingContent] = useState<Record<string, string>>({})
  const editTextareaRefs = useRef<Record<string, HTMLTextAreaElement | null>>({})
  const messageRefs = useRef<Record<string, HTMLElement | null>>({})
  
  const isEditing = Object.keys(editingContent).length > 0

  const setEditTextareaRef = useCallback((messageId: string, el: HTMLTextAreaElement | null) => {
    if (el) {
      editTextareaRefs.current[messageId] = el
    }
  }, [])

  const setMessageRef = useCallback((messageId: string, el: HTMLElement | null) => {
    if (el) {
      messageRefs.current[messageId] = el
    }
  }, [])

  const startEdit = useCallback((messageId: string) => {
    const message = promptStore.chatMessages.find(msg => msg.id === messageId)
    if (message) {
      setEditingContent(prev => ({ ...prev, [messageId]: message.content }))
      promptStore.startEditMessage(messageId)
      
      // èšç„¦åˆ°textarea
      setTimeout(() => {
        const textarea = editTextareaRefs.current[messageId]
        if (textarea) {
          textarea.focus()
          const length = textarea.value.length
          textarea.setSelectionRange(length, length)
        }
      }, 0)
    }
  }, [promptStore])

  const saveEdit = useCallback((messageId: string) => {
    const newContent = editingContent[messageId]
    if (newContent !== undefined && newContent.trim()) {
      promptStore.saveEditMessage(messageId, newContent)
      setEditingContent(prev => {
        const next = { ...prev }
        delete next[messageId]
        return next
      })
      delete editTextareaRefs.current[messageId]
    } else {
      notificationStore.warning('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º')
    }
  }, [editingContent, promptStore, notificationStore])

  const cancelEdit = useCallback((messageId: string) => {
    promptStore.cancelEditMessage(messageId)
    setEditingContent(prev => {
      const next = { ...prev }
      delete next[messageId]
      return next
    })
    delete editTextareaRefs.current[messageId]
  }, [promptStore])

  const deleteMessage = useCallback((messageId: string) => {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿåˆ é™¤åè¯¥æ¶ˆæ¯å°†ä¸ä¼šåœ¨åç»­çš„AIå¯¹è¯ä¸­è¢«è€ƒè™‘ã€‚')) {
      promptStore.deleteMessage(messageId)
      notificationStore.success('æ¶ˆæ¯å·²åˆ é™¤')
    }
  }, [promptStore, notificationStore])

  const copyMessage = useCallback(async (content: string) => {
    try {
      await copyToClipboard(content)
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    } catch (error) {
      // é™çº§æ–¹æ¡ˆ
      const textArea = document.createElement('textarea')
      textArea.value = content
      document.body.appendChild(textArea)
      textArea.select()
      try {
        document.execCommand('copy')
        notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
      } catch (fallbackError) {
        notificationStore.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶')
      }
      document.body.removeChild(textArea)
    }
  }, [notificationStore])

  const handleEditKeydown = useCallback((event: React.KeyboardEvent, messageId: string) => {
    if (event.key === 'Enter' && event.ctrlKey) {
      event.preventDefault()
      saveEdit(messageId)
    } else if (event.key === 'Escape') {
      event.preventDefault()
      cancelEdit(messageId)
    }
  }, [saveEdit, cancelEdit])

  const updateEditingContent = useCallback((messageId: string, content: string) => {
    setEditingContent(prev => ({ ...prev, [messageId]: content }))
  }, [])

  return {
    editingContent,
    editTextareaRefs,
    messageRefs,
    isEditing,
    setEditTextareaRef,
    setMessageRef,
    startEdit,
    saveEdit,
    cancelEdit,
    deleteMessage,
    copyMessage,
    handleEditKeydown,
    updateEditingContent
  }
}

```


## src/hooks/useChatMessages.ts

````ts
import { useRef, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { marked } from 'marked'

export function useChatMessages() {
  const promptStore = usePromptStore()
  const chatContainer = useRef<HTMLDivElement>(null)

  const renderMarkdown = useCallback((content: string): string => {
    try {
      const result = marked(content, {
        breaks: true,
        gfm: true
      })
      return typeof result === 'string' ? result : String(result)
    } catch (error) {
      return content
    }
  }, [])

  const renderUserMessage = useCallback((content: string): string => {
    try {
      const hasMarkdown = /^#|^\*\*|^##|^\*|^-|\*\*.*\*\*|^1\.|```/.test(content) || 
                         content.includes('**') || content.includes('##') || content.includes('# ')
      
      if (hasMarkdown || content.length > 50) {
        const result = marked(content, {
          breaks: true,
          gfm: true
        })
        return typeof result === 'string' ? result : String(result)
      } else {
        return content.replace(/\n/g, '<br>')
      }
    } catch (error) {
      try {
        const result = marked(content, { breaks: true, gfm: true })
        return typeof result === 'string' ? result : String(result)
      } catch {
        return content.replace(/\n/g, '<br>')
      }
    }
  }, [])

  const scrollToBottom = useCallback(() => {
    setTimeout(() => {
      if (chatContainer.current) {
        chatContainer.current.scrollTop = chatContainer.current.scrollHeight
      }
    }, 0)
  }, [])

  const startStreamingMessage = useCallback(() => {
    const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    promptStore.addMessage('ai', '', undefined, { id: messageId })
    const messages = promptStore.chatMessages
    const index = messages.findIndex(msg => msg.id === messageId)
    return index >= 0 ? index : messages.length - 1
  }, [promptStore])

  const updateStreamingMessage = useCallback((index: number, content: string) => {
    const messages = promptStore.chatMessages
    if (index >= 0 && index < messages.length) {
      promptStore.updateMessage(messages[index].id!, content)
    }
  }, [promptStore])

  const simulateTyping = useCallback(async (message: string, isStreaming: boolean = false) => {
    if (isStreaming) {
      const messageIndex = promptStore.chatMessages.length
      promptStore.addMessage('ai', '', undefined)
      
      for (let i = 0; i <= message.length; i++) {
        const messages = promptStore.chatMessages
        if (messages[messageIndex]) {
          promptStore.updateMessage(messages[messageIndex].id!, message.substring(0, i))
        }
        await new Promise(resolve => setTimeout(resolve, Math.random() * 30 + 10))
      }
    } else {
      promptStore.isTyping = true
      await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 100))
      promptStore.isTyping = false
      promptStore.addMessage('ai', message, undefined)
    }
  }, [promptStore])

  return {
    chatContainer,
    renderMarkdown,
    renderUserMessage,
    scrollToBottom,
    startStreamingMessage,
    updateStreamingMessage,
    simulateTyping
  }
}

````


## src/hooks/useChatModel.ts

```ts
import { useState, useEffect, useCallback, useMemo } from 'react'
import { useProviderStore } from '@/stores/providerStore'

export function useChatModel() {
  const [isStreamMode, setIsStreamMode] = useState(true)

  // ä½¿ç”¨é€‰æ‹©å™¨è®¢é˜…å…·ä½“çš„çŠ¶æ€ï¼Œç¡®ä¿å“åº”å¼æ›´æ–°
  const providers = useProviderStore((state) => state.providers)
  const isInitialized = useProviderStore((state) => state.isInitialized)
  const selectedProviderId = useProviderStore((state) => state.selectedProviderId)
  const selectedModelId = useProviderStore((state) => state.selectedModelId)
  const getProviderById = useProviderStore((state) => state.getProviderById)
  const getAvailableModelsByProvider = useProviderStore((state) => state.getAvailableModelsByProvider)
  const setSelectedProvider = useProviderStore((state) => state.setSelectedProvider)
  const setSelectedModel = useProviderStore((state) => state.setSelectedModel)

  // è®¡ç®—å½“å‰é€‰ä¸­çš„ provider å’Œ model
  const currentProvider = useMemo(() => {
    if (!selectedProviderId || !isInitialized) return null
    return getProviderById(selectedProviderId) || null
  }, [selectedProviderId, isInitialized, getProviderById, providers])

  const currentModel = useMemo(() => {
    if (!currentProvider || !selectedModelId) return null
    return currentProvider.models.find(m => m.id === selectedModelId) || null
  }, [currentProvider, selectedModelId])

  // ç¡®ä¿åœ¨åˆå§‹åŒ–å®Œæˆåï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
  useEffect(() => {
    if (isInitialized && providers.length > 0) {
      const enabledProviders = providers.filter(p => p.apiKey)
      if (enabledProviders.length > 0 && !selectedProviderId) {
        const firstProvider = enabledProviders[0]
        console.log('[useChatModel] è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†:', firstProvider.name)
        setSelectedProvider(firstProvider.id)
        
        if (firstProvider.models.length > 0) {
          console.log('[useChatModel] è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹:', firstProvider.models[0].name)
          setSelectedModel(firstProvider.models[0].id)
        }
      } else if (selectedProviderId && !currentProvider) {
        // å¦‚æœé€‰ä¸­çš„æä¾›å•†ä¸å­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
        const firstProvider = enabledProviders[0]
        if (firstProvider) {
          console.log('[useChatModel] é€‰ä¸­çš„æä¾›å•†ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª:', firstProvider.name)
          setSelectedProvider(firstProvider.id)
          if (firstProvider.models.length > 0) {
            setSelectedModel(firstProvider.models[0].id)
          }
        }
      } else if (currentProvider && !currentModel && selectedModelId) {
        // å¦‚æœé€‰ä¸­çš„æ¨¡å‹ä¸å­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
        const availableModels = getAvailableModelsByProvider(currentProvider.id)
        if (availableModels.length > 0) {
          console.log('[useChatModel] é€‰ä¸­çš„æ¨¡å‹ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª:', availableModels[0].name)
          setSelectedModel(availableModels[0].id)
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isInitialized, providers.length, selectedProviderId, selectedModelId, currentProvider, currentModel])

  // ç›´æ¥ä½¿ç”¨è®¡ç®—åçš„å€¼ï¼Œæ·»åŠ è°ƒè¯•æ—¥å¿—
  // æ³¨æ„ï¼šè¿™é‡Œä¸ä½¿ç”¨ useCallbackï¼Œæ¯æ¬¡éƒ½é‡æ–°è®¡ç®—ï¼Œç¡®ä¿è·å–æœ€æ–°å€¼
  const getCurrentChatModel = () => {
    // é‡æ–°è®¡ç®—ï¼Œç¡®ä¿è·å–æœ€æ–°å€¼
    const latestProvider = selectedProviderId && isInitialized 
      ? getProviderById(selectedProviderId) 
      : null
    const latestModel = latestProvider && selectedModelId
      ? latestProvider.models.find(m => m.id === selectedModelId) || null
      : null
    
    console.log('[useChatModel] getCurrentChatModel è°ƒç”¨:', {
      isInitialized,
      providersCount: providers.length,
      selectedProviderId,
      selectedModelId,
      currentProvider: latestProvider?.name || 'null',
      currentModel: latestModel?.name || 'null',
      hasProvider: !!latestProvider,
      hasModel: !!latestModel
    })
    return { provider: latestProvider, model: latestModel }
  }

  const getChatModelDisplay = useCallback(() => {
    const { provider, model } = getCurrentChatModel()
    if (!provider || !model) return 'æœªé€‰æ‹©æ¨¡å‹'
    return `${provider.name} - ${model.name}`
  }, [getCurrentChatModel])

  const toggleStreamMode = useCallback(() => {
    setIsStreamMode(prev => {
      const newValue = !prev
      localStorage.setItem('yprompt_stream_mode', JSON.stringify(newValue))
      return newValue
    })
  }, [])

  const loadSettings = useCallback(() => {
    const savedStreamMode = localStorage.getItem('yprompt_stream_mode')
    if (savedStreamMode !== null) {
      try {
        setIsStreamMode(JSON.parse(savedStreamMode))
      } catch (e) {
        setIsStreamMode(true)
      }
    }
  }, [])

  useEffect(() => {
    loadSettings()
  }, [loadSettings])

  return {
    isStreamMode,
    getCurrentChatModel,
    getChatModelDisplay,
    toggleStreamMode,
    loadSettings
  }
}

```


## src/hooks/useChatQuickReplies.ts

```ts
import { useState, useRef, useEffect, useCallback, useMemo } from 'react'
import { usePromptStore } from '@/stores/promptStore'

export function useChatQuickReplies(inputContainerRef: React.RefObject<HTMLElement>) {
  const promptStore = usePromptStore()
  const [showQuickReplies, setShowQuickReplies] = useState(false)
  const quickRepliesContainerRef = useRef<HTMLDivElement>(null)

  const quickReplies = useMemo(() => {
    const messageCount = promptStore.chatMessages.length
    const baseReplies = ['è¯·ä½¿ç”¨ç›¸å…³æœ€ä½³å®è·µçš„æ¨èå»ºè®®']
    
    if (messageCount >= 6) {
      const hasReport = !!promptStore.promptData.requirementReport
      const actionText = hasReport ? 'é‡æ–°ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š' : 'å¼ºåˆ¶ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š'
      return [...baseReplies, actionText]
    }
    
    return baseReplies
  }, [promptStore.chatMessages.length, promptStore.promptData.requirementReport])

  const shouldShowQuickReplies = useMemo(() => {
    return promptStore.chatMessages.length >= 2 && showQuickReplies
  }, [promptStore.chatMessages.length, showQuickReplies])

  const checkForceGenerate = useCallback((userInput: string): boolean => {
    const forceKeywords = ['å¼ºåˆ¶ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š', 'é‡æ–°ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š']
    return forceKeywords.some(keyword => userInput.includes(keyword))
  }, [])

  const selectQuickReply = useCallback((reply: string, onSelect: (reply: string) => void) => {
    onSelect(reply)
    setShowQuickReplies(false)
  }, [])

  const handleClickOutside = useCallback((event: MouseEvent) => {
    const target = event.target as Node
    
    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨è¾“å…¥åŒºåŸŸå†…
    if (inputContainerRef.current?.contains(target)) {
      return
    }
    
    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å¿«æ·å›å¤åŒºåŸŸå†…
    if (quickRepliesContainerRef.current?.contains(target)) {
      return
    }
    
    // ç‚¹å‡»åœ¨å¤–éƒ¨ï¼Œéšè—å¿«æ·å›å¤
    setShowQuickReplies(false)
  }, [inputContainerRef])

  useEffect(() => {
    setTimeout(() => {
      document.addEventListener('mousedown', handleClickOutside)
    }, 100)
    
    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [handleClickOutside])

  return {
    showQuickReplies,
    setShowQuickReplies,
    quickReplies,
    quickRepliesContainerRef,
    shouldShowQuickReplies,
    checkForceGenerate,
    selectQuickReply
  }
}

```


## src/hooks/useConversationMessages.ts

```ts
import { useState, useCallback } from 'react'

export interface ConversationMessage {
  id: string
  role: 'ai' | 'user'
  content: string
  isEditing?: boolean
}

export function useConversationMessages() {
  const [messages, setMessages] = useState<ConversationMessage[]>([])

  const addMessage = useCallback((role: 'ai' | 'user' = 'user') => {
    const newMessage: ConversationMessage = {
      id: `msg-${Date.now()}-${Math.random()}`,
      role,
      content: '',
      isEditing: false
    }
    setMessages((prev) => [...prev, newMessage])
  }, [])

  const removeMessage = useCallback((id: string) => {
    setMessages((prev) => prev.filter((msg) => msg.id !== id))
  }, [])

  const updateMessage = useCallback((id: string, content: string) => {
    setMessages((prev) =>
      prev.map((msg) => (msg.id === id ? { ...msg, content } : msg))
    )
  }, [])

  const updateMessageRole = useCallback((id: string, role: 'ai' | 'user') => {
    setMessages((prev) =>
      prev.map((msg) => (msg.id === id ? { ...msg, role } : msg))
    )
  }, [])

  const startEdit = useCallback((id: string) => {
    setMessages((prev) =>
      prev.map((msg) => ({ ...msg, isEditing: msg.id === id }))
    )
  }, [])

  const cancelEdit = useCallback((id: string) => {
    setMessages((prev) =>
      prev.map((msg) => (msg.id === id ? { ...msg, isEditing: false } : msg))
    )
  }, [])

  const formatForAI = useCallback((): string => {
    if (messages.length === 0) return ''

    return messages
      .filter((msg) => msg.content.trim())
      .map((msg) => {
        const label = msg.role === 'ai' ? 'AIåŠ©æ‰‹' : 'ç”¨æˆ·'
        return `${label}: ${msg.content}`
      })
      .join('\n\n')
  }, [messages])

  const reset = useCallback(() => {
    setMessages([])
  }, [])

  const setMessagesState = useCallback((newMessages: ConversationMessage[]) => {
    setMessages(newMessages)
  }, [])

  return {
    messages,
    addMessage,
    removeMessage,
    updateMessage,
    updateMessageRole,
    startEdit,
    cancelEdit,
    formatForAI,
    reset,
    setMessagesState
  }
}

```


## src/hooks/useEnsureAIConfig.ts

```ts
import { useCallback } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import { useNotificationStore } from '@/stores/notificationStore'

/**
 * Hook: ç¡®ä¿ AI é…ç½®å·²æ­£ç¡®è®¾ç½®
 * éªŒè¯é€‰ä¸­çš„æä¾›å•†å’Œæ¨¡å‹æ˜¯å¦æœ‰æ•ˆï¼Œä¸è¿›è¡Œè‡ªåŠ¨é€‰æ‹©
 */
export function useEnsureAIConfig() {

  /**
   * ç¡®ä¿å½“å‰å·²é€‰æ‹©æœ‰æ•ˆçš„AIæä¾›å•†å’Œæ¨¡å‹
   * éªŒè¯è§„åˆ™ï¼š
   * 1. provider å¿…é¡»å­˜åœ¨
   * 2. provider å¿…é¡»æœ‰ API Key
   * 3. model å¿…é¡»å­˜åœ¨
   * @returns { provider, model } è¿”å›å¯ç”¨çš„æä¾›å•†å’Œæ¨¡å‹
   * @throws {Error} å¦‚æœé…ç½®æ— æ•ˆï¼ˆä¸å­˜åœ¨æˆ–ç¼ºå°‘ API Keyï¼‰
   */
  const ensureConfig = useCallback(async () => {
    console.log('[useEnsureAIConfig] å¼€å§‹ç¡®ä¿é…ç½®...')

    // è·å–æœ€æ–°çš„çŠ¶æ€ï¼ˆåœ¨å‡½æ•°å†…éƒ¨è·å–ï¼Œç¡®ä¿è·å–æœ€æ–°å€¼ï¼‰
    const providerStore = useProviderStore.getState()
    const notificationStore = useNotificationStore.getState()
    const safeProviders = providerStore.providers || []
    const safeEnabledProviders = providerStore.enabledProviders || []
    
    console.log('[useEnsureAIConfig] providerStore è¯¦ç»†çŠ¶æ€:', {
      isInitialized: providerStore.isInitialized,
      providers: safeProviders.map(p => ({
        id: p.id,
        name: p.name,
        hasApiKey: !!p.apiKey,
        apiKeyLength: p.apiKey ? p.apiKey.length : 0,
        modelsCount: (p.models || []).length
      })),
      enabledProviders: safeEnabledProviders.map(p => p.id),
      selectedProviderId: providerStore.selectedProviderId,
      selectedModelId: providerStore.selectedModelId
    })

    // å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
    if (!providerStore.isInitialized) {
      console.log('[useEnsureAIConfig] providerStore æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–...')
      try {
        await providerStore.initialize()
        console.log('[useEnsureAIConfig] åˆå§‹åŒ–æˆåŠŸ')
        // é‡æ–°è·å–çŠ¶æ€
        const updatedStore = useProviderStore.getState()
        if (!updatedStore.isInitialized) {
          throw new Error('åˆå§‹åŒ–åä»ç„¶æœªåˆå§‹åŒ–')
        }
      } catch (err) {
        console.error('[useEnsureAIConfig] åˆå§‹åŒ–å¤±è´¥:', err)
        notificationStore.error('AIæ¨¡å‹é…ç½®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™å†è¯•')
        throw new Error('Provider store not initialized')
      }
    }

    // é‡æ–°è·å–æœ€æ–°çŠ¶æ€
    const latestStore = useProviderStore.getState()
    const latestProviders = latestStore.providers || []
    
    // å…ˆå°è¯•ä»å·²é€‰æ‹©çš„ ID è·å– provider å’Œ model
    let provider = latestStore.currentProvider
    let model = latestStore.currentModel

    // å¦‚æœ currentProvider è¿”å› nullï¼Œä½† selectedProviderId æœ‰å€¼ï¼Œå°è¯•ç›´æ¥ä» providers æ•°ç»„æŸ¥æ‰¾
    if (!provider && latestStore.selectedProviderId) {
      const selectedProvider = latestProviders.find(p => p.id === latestStore.selectedProviderId)
      if (selectedProvider) {
        console.log('[useEnsureAIConfig] ä» providers æ•°ç»„ä¸­æ‰¾åˆ°é€‰ä¸­çš„æä¾›å•†:', selectedProvider.name)
        provider = selectedProvider
        
        // å¦‚æœæ‰¾åˆ° providerï¼Œå°è¯•æŸ¥æ‰¾å¯¹åº”çš„ model
        if (!model && latestStore.selectedModelId) {
          const providerModels = provider.models || []
          const selectedModel = providerModels.find(m => m.id === latestStore.selectedModelId)
          if (selectedModel) {
            console.log('[useEnsureAIConfig] ä» provider.models ä¸­æ‰¾åˆ°é€‰ä¸­çš„æ¨¡å‹:', selectedModel.name)
            model = selectedModel
          }
        }
      }
    }

    console.log('[useEnsureAIConfig] æ£€æŸ¥é…ç½®:', {
      provider: provider ? { id: provider.id, name: provider.name, hasApiKey: !!provider.apiKey } : null,
      model: model ? { id: model.id, name: model.name } : null,
      hasProvider: !!provider,
      hasModel: !!model,
      isInitialized: latestStore.isInitialized,
      providersCount: latestProviders.length,
      enabledProvidersCount: latestStore.enabledProviders.length,
      selectedProviderId: latestStore.selectedProviderId,
      selectedModelId: latestStore.selectedModelId
    })

    // éªŒè¯ provider æ˜¯å¦å­˜åœ¨
    if (!provider) {
      console.error('[useEnsureAIConfig] æœªæ‰¾åˆ°é€‰ä¸­çš„æä¾›å•†', {
        selectedProviderId: latestStore.selectedProviderId,
        providersCount: latestProviders.length
      })
      notificationStore.error('è¯·å…ˆåœ¨å¯¼èˆªæ é€‰æ‹©AIæä¾›å•†')
      throw new Error('Provider not found')
    }

    // éªŒè¯ provider æ˜¯å¦æœ‰ API Keyï¼ˆå¿…éœ€ï¼‰
    if (!provider.apiKey) {
      console.error('[useEnsureAIConfig] é€‰ä¸­çš„æä¾›å•†æ²¡æœ‰ API Key', {
        providerId: provider.id,
        providerName: provider.name
      })
      notificationStore.error(`æä¾›å•† "${provider.name}" æ²¡æœ‰é…ç½® API å¯†é’¥ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®`)
      throw new Error('Provider missing API key')
    }

    // éªŒè¯ model æ˜¯å¦å­˜åœ¨
    if (!model) {
      const providerModels = provider.models || []
      console.error('[useEnsureAIConfig] æœªæ‰¾åˆ°é€‰ä¸­çš„æ¨¡å‹', {
        providerId: provider.id,
        providerName: provider.name,
        selectedModelId: latestStore.selectedModelId,
        availableModels: providerModels.map(m => m.id)
      })
      notificationStore.error(`æä¾›å•† "${provider.name}" æ²¡æœ‰é€‰ä¸­çš„æ¨¡å‹ï¼Œè¯·åœ¨å¯¼èˆªæ é€‰æ‹©æ¨¡å‹`)
      throw new Error('Model not found')
    }

    console.log('[useEnsureAIConfig] é…ç½®éªŒè¯æˆåŠŸ:', provider.name, model.name)
    return { provider, model }
  }, [])

  return { ensureConfig }
}
```


## src/hooks/useOptimizeModule.ts

```ts
import { useCallback } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import { AIService } from '@/services/aiService'
import { PromptGeneratorService } from '@/services/promptGeneratorService'
import { promptConfigManager } from '@/config/prompts'
import { parseAIJsonResponse } from '@/utils/jsonParser'
import type { PromptAnalysis } from '@/stores/optimizeStore'

export function useOptimizeModule() {
  const providerStore = useProviderStore()
  const aiService = AIService.getInstance()
  const promptGenerator = PromptGeneratorService.getInstance()

  // åˆ†ææç¤ºè¯è´¨é‡
  const analyzePrompt = useCallback(
    async (
      prompt: string,
      _mode: 'system' | 'user',
      onStreamUpdate?: (chunk: string) => void
    ): Promise<PromptAnalysis> => {
      if (!prompt || !prompt.trim()) {
        throw new Error('è¯·è¾“å…¥æç¤ºè¯å†…å®¹')
      }

      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆé€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      // ä»é…ç½®ç®¡ç†å™¨è·å–è´¨é‡åˆ†æç³»ç»Ÿæç¤ºè¯
      const systemPrompt = promptConfigManager.getQualityAnalysisSystemPrompt()

      // ç”¨æˆ·æç¤ºè¯ç›´æ¥åœ¨ä»£ç ä¸­æ„å»º
      const userPrompt = `è¯·åˆ†æä»¥ä¸‹ç³»ç»Ÿæç¤ºè¯çš„è´¨é‡ï¼š

æç¤ºè¯å†…å®¹ï¼š
${prompt}

è¯·ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„JSONæ ¼å¼è¿”å›åˆ†æç»“æœã€‚`

      let fullResponse = ''

      // è®¾ç½®æµå¼å›è°ƒ
      if (onStreamUpdate) {
        aiService.setStreamUpdateCallback((chunk: string) => {
          fullResponse += chunk
          onStreamUpdate(fullResponse)
        })
      }

      try {
        const response = await aiService.callAI(
          [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userPrompt }
          ],
          currentProvider,
          currentModel.id,
          !!onStreamUpdate // ä½¿ç”¨æµå¼è¾“å‡º
        )

        // ä½¿ç”¨å®Œæ•´å“åº”è¿›è¡Œè§£æ
        const finalContent = response || fullResponse

        // è§£æåˆ†æç»“æœ - å¤„ç†markdownä»£ç å—åŒ…è£¹çš„JSON
        let result: PromptAnalysis
        try {
          result = parseAIJsonResponse(finalContent)
          console.log('âœ… Parsed analysis result:', result)
        } catch (parseError) {
          console.error('âŒ Failed to parse analysis response:', parseError)
          console.error('ğŸ“„ Original content:', finalContent)
          // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸºç¡€åˆ†æ
          result = {
            overall_score: 75,
            analysis: {
              role: { score: 75, status: 'good', feedback: 'è§’è‰²å®šä¹‰åŸºæœ¬å®Œå–„' },
              task: { score: 75, status: 'good', feedback: 'ä»»åŠ¡æè¿°è¾ƒä¸ºæ¸…æ™°' },
              format: { score: 65, status: 'needs_improvement', feedback: 'è¾“å‡ºæ ¼å¼å¯ä»¥æ›´è¯¦ç»†' },
              constraints: { score: 70, status: 'needs_improvement', feedback: 'çº¦æŸæ¡ä»¶å¯ä»¥æ›´æ˜ç¡®' },
              example: { score: 60, status: 'needs_improvement', feedback: 'å»ºè®®æ·»åŠ ç¤ºä¾‹è¯´æ˜' },
              language: { score: 80, status: 'good', feedback: 'è¯­è¨€è¡¨è¾¾æ¸…æ™°' }
            },
            suggestions: [],
            language: 'zh',
            word_count: prompt.length,
            estimated_tokens: Math.ceil(prompt.length / 4),
            issues: ['è§£æå¤±è´¥ï¼Œæ— æ³•è·å–è¯¦ç»†é—®é¢˜åˆ†æ']
          }
        }

        return result
      } catch (error: any) {
        console.error('Analysis failed:', error)
        // è¿”å›é»˜è®¤åˆ†æç»“æœ
        const defaultResult: PromptAnalysis = {
          overall_score: 70,
          analysis: {
            role: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' },
            task: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' },
            format: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' },
            constraints: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' },
            example: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' },
            language: { score: 70, status: 'needs_improvement', feedback: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯' }
          },
          suggestions: [{ area: 'general', suggestion: 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•' }],
          language: 'zh',
          word_count: prompt.length,
          estimated_tokens: Math.ceil(prompt.length / 4),
          issues: ['åˆ†æå¤±è´¥']
        }
        return defaultResult
      } finally {
        // æ¸…ç†æµå¼å›è°ƒ
        if (onStreamUpdate) {
          aiService.clearStreamUpdateCallback()
        }
      }
    },
    [providerStore, aiService]
  )

  // ç”Ÿæˆä¼˜åŒ–å»ºè®®
  const generateOptimizationAdvice = useCallback(
    async (
      prompt: string,
      promptType: 'system' | 'user',
      onStreamUpdate?: (chunk: string) => void
    ): Promise<string[]> => {
      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆé€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      const adviceList = await promptGenerator.getOptimizationAdvice(
        prompt,
        promptType,
        currentModel.id,
        'zh',
        [],
        currentProvider,
        onStreamUpdate
      )

      return adviceList
    },
    [providerStore, promptGenerator]
  )

  // åº”ç”¨ä¼˜åŒ–å»ºè®®ç”Ÿæˆæœ€ç»ˆæç¤ºè¯
  const applyOptimizationAdvice = useCallback(
    async (
      originalPrompt: string,
      advice: string[],
      promptType: 'system' | 'user',
      onStreamUpdate?: (content: string) => void
    ): Promise<string> => {
      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆé€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      const optimizedPrompt = await promptGenerator.applyOptimizationAdvice(
        originalPrompt,
        advice,
        promptType,
        currentModel.id,
        'zh',
        [],
        currentProvider,
        onStreamUpdate
      )

      return optimizedPrompt
    },
    [providerStore, promptGenerator]
  )

  return {
    analyzePrompt,
    generateOptimizationAdvice,
    applyOptimizationAdvice
  }
}

```


## src/hooks/usePreviewClipboard.ts

```ts
import { useState, useCallback } from 'react'
import { useNotificationStore } from '@/stores/notificationStore'
import { copyToClipboard as copyUtil } from '@/utils/clipboardUtils'

export function usePreviewClipboard() {
  const notificationStore = useNotificationStore()
  const [copyStatus, setCopyStatus] = useState<{ [key: string]: boolean }>({
    report: false,
    thinking: false,
    initial: false,
    advice: false,
    final: false
  })

  const copyToClipboard = useCallback(async (text: string, key: string) => {
    if (!text || text.trim() === '') {
      notificationStore.warning('å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶')
      return
    }

    try {
      await copyUtil(text)
      setCopyStatus(prev => ({ ...prev, [key]: true }))
      notificationStore.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
      
      setTimeout(() => {
        setCopyStatus(prev => ({ ...prev, [key]: false }))
      }, 2000)
    } catch (error) {
      notificationStore.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }, [notificationStore])

  return {
    copyStatus,
    copyToClipboard
  }
}

```


## src/hooks/usePreviewConversion.ts

```ts
import { useState, useMemo, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { useProviderStore } from '@/stores/providerStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { AIService, type ChatMessage } from '@/services/aiService'
import { cleanAIResponseForFormatting, cleanConvertedResponse } from '@/utils/aiResponseUtils'

export function usePreviewConversion() {
  const promptStore = usePromptStore()
  const providerStore = useProviderStore()
  const notificationStore = useNotificationStore()
  const aiService = AIService.getInstance()

  const [isConvertingFormat, setIsConvertingFormat] = useState(false)
  const [isConvertingLanguage, setIsConvertingLanguage] = useState(false)
  const [formatState, setFormatState] = useState<'markdown' | 'xml'>('markdown')
  const [languageState, setLanguageState] = useState<'zh' | 'en'>('zh')

  const currentGeneratedPrompt = useMemo(() => {
    const prompt = promptStore.promptData.generatedPrompt
    
    if (typeof prompt === 'string') {
      return prompt
    }
    
    if ('markdown' in prompt && 'xml' in prompt) {
      const format = formatState
      return languageState === 'zh' 
        ? prompt[format].zh 
        : prompt[format].en
    }
    
    return languageState === 'zh' 
      ? prompt.zh 
      : prompt.en
  }, [promptStore.promptData.generatedPrompt, formatState, languageState])

  const setCurrentGeneratedPrompt = useCallback((value: string) => {
    const state = promptStore.getState()
    const prompt = state.promptData.generatedPrompt
    
    if (typeof prompt === 'string') {
      promptStore.setState({ promptData: { ...state.promptData, generatedPrompt: value } })
      return
    }
    
    if ('markdown' in prompt && 'xml' in prompt) {
      const format = formatState
      const newPrompt = { ...prompt }
      if (languageState === 'zh') {
        newPrompt[format].zh = value
      } else {
        newPrompt[format].en = value
      }
      promptStore.setState({ promptData: { ...state.promptData, generatedPrompt: newPrompt } })
      return
    }
    
    const newPrompt = { ...prompt }
    if (languageState === 'zh') {
      newPrompt.zh = value
    } else {
      newPrompt.en = value
    }
    promptStore.setState({ promptData: { ...state.promptData, generatedPrompt: newPrompt } })
  }, [promptStore, formatState, languageState])

  const toggleFormat = useCallback(async () => {
    if (!currentGeneratedPrompt || isConvertingFormat || isConvertingLanguage) {
      return
    }

    const targetFormatCode = formatState === 'markdown' ? 'xml' : 'markdown'
    const state = promptStore.getState()
    const prompt = state.promptData.generatedPrompt
    
    if (typeof prompt !== 'string' && 'markdown' in prompt && 'xml' in prompt) {
      const targetContent = languageState === 'zh' 
        ? prompt[targetFormatCode].zh 
        : prompt[targetFormatCode].en
      
      if (targetContent) {
        setFormatState(targetFormatCode)
        notificationStore.success(`å·²åˆ‡æ¢ä¸º${targetFormatCode === 'xml' ? 'XML' : 'Markdown'}æ ¼å¼`)
        return
      }
    }

    const provider = providerStore.currentProvider
    const model = providerStore.currentModel

    if (!provider || !model) {
      notificationStore.error('è¯·å…ˆé…ç½®AIæ¨¡å‹')
      return
    }

    try {
      setIsConvertingFormat(true)
      const targetFormat = formatState === 'markdown' ? 'XML' : 'Markdown'
      const currentFormat = formatState === 'markdown' ? 'Markdown' : 'XML'

      const cleanedContent = cleanAIResponseForFormatting(currentGeneratedPrompt)

      const messages: ChatMessage[] = [
        {
          role: 'system',
          content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯æ ¼å¼è½¬æ¢åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æç¤ºè¯ä»${currentFormat}æ ¼å¼è½¬æ¢ä¸º${targetFormat}æ ¼å¼ï¼Œä¿æŒå†…å®¹å®Œå…¨ä¸€è‡´ï¼Œåªæ”¹å˜æ ¼å¼æ ·å¼ã€‚`
        },
        {
          role: 'user',
          content: `è¯·å°†ä»¥ä¸‹æç¤ºè¯ä»${currentFormat}æ ¼å¼è½¬æ¢ä¸º${targetFormat}æ ¼å¼ï¼š\n\n${cleanedContent}`
        }
      ]

      const response = await aiService.callAI(
        messages,
        provider,
        model.id,
        false
      )

      if (response && response.trim()) {
        const cleaned = cleanConvertedResponse(response)
        const currentState = promptStore.getState()
        const currentPrompt = currentState.promptData.generatedPrompt
        
        // å‡çº§åˆ°äºŒç»´å¯¹è±¡æ ¼å¼
        if (typeof currentPrompt === 'string') {
          const currentLang = languageState
          const newPrompt = {
            markdown: {
              zh: formatState === 'markdown' && currentLang === 'zh' ? currentPrompt : '',
              en: formatState === 'markdown' && currentLang === 'en' ? currentPrompt : ''
            },
            xml: {
              zh: formatState === 'xml' && currentLang === 'zh' ? currentPrompt : '',
              en: formatState === 'xml' && currentLang === 'en' ? currentPrompt : ''
            }
          }
          if (languageState === 'zh') {
            newPrompt[targetFormatCode].zh = cleaned
          } else {
            newPrompt[targetFormatCode].en = cleaned
          }
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        } else if (!('markdown' in currentPrompt)) {
          const newPrompt = {
            markdown: {
              zh: formatState === 'markdown' ? currentPrompt.zh : '',
              en: formatState === 'markdown' ? currentPrompt.en : ''
            },
            xml: {
              zh: formatState === 'xml' ? currentPrompt.zh : '',
              en: formatState === 'xml' ? currentPrompt.en : ''
            }
          }
          if (languageState === 'zh') {
            newPrompt[targetFormatCode].zh = cleaned
          } else {
            newPrompt[targetFormatCode].en = cleaned
          }
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        } else {
          const newPrompt = { ...currentPrompt }
          if (languageState === 'zh') {
            newPrompt[targetFormatCode].zh = cleaned
          } else {
            newPrompt[targetFormatCode].en = cleaned
          }
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        }
        
        setFormatState(targetFormatCode)
        notificationStore.success(`å·²è½¬æ¢ä¸º${targetFormat}æ ¼å¼`)
      } else {
        notificationStore.error('æ ¼å¼è½¬æ¢å¤±è´¥ï¼šè¿”å›å†…å®¹ä¸ºç©º')
      }
    } catch (error) {
      notificationStore.error('æ ¼å¼è½¬æ¢å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsConvertingFormat(false)
    }
  }, [currentGeneratedPrompt, formatState, languageState, isConvertingFormat, isConvertingLanguage, providerStore, notificationStore, aiService, promptStore, setCurrentGeneratedPrompt])

  const toggleLanguage = useCallback(async () => {
    if (!currentGeneratedPrompt || isConvertingFormat || isConvertingLanguage) {
      return
    }

    const targetLanguage = languageState === 'zh' ? 'en' : 'zh'
    const state = promptStore.getState()
    const prompt = state.promptData.generatedPrompt
    
    if (typeof prompt !== 'string' && 'markdown' in prompt && 'xml' in prompt) {
      const targetContent = prompt[formatState][targetLanguage]
      
      if (targetContent) {
        setLanguageState(targetLanguage)
        notificationStore.success(`å·²åˆ‡æ¢ä¸º${targetLanguage === 'zh' ? 'ä¸­æ–‡' : 'English'}`)
        return
      }
    } else if (typeof prompt !== 'string') {
      const targetContent = prompt[targetLanguage]
      
      if (targetContent) {
        setLanguageState(targetLanguage)
        notificationStore.success(`å·²åˆ‡æ¢ä¸º${targetLanguage === 'zh' ? 'ä¸­æ–‡' : 'English'}`)
        return
      }
    }

    const provider = providerStore.currentProvider
    const model = providerStore.currentModel

    if (!provider || !model) {
      notificationStore.error('è¯·å…ˆé…ç½®AIæ¨¡å‹')
      return
    }
    
    const currentState = promptStore.getState()
    const currentPrompt = currentState.promptData.generatedPrompt

    try {
      setIsConvertingLanguage(true)
      const targetLang = languageState === 'zh' ? 'English' : 'ä¸­æ–‡'

      const cleanedContent = cleanAIResponseForFormatting(currentGeneratedPrompt)

      const messages: ChatMessage[] = [
        {
          role: 'system',
          content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯ç¿»è¯‘åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æç¤ºè¯ç¿»è¯‘ä¸º${targetLang}ï¼Œä¿æŒæ ¼å¼å’Œç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªæ”¹å˜è¯­è¨€ã€‚`
        },
        {
          role: 'user',
          content: `è¯·å°†ä»¥ä¸‹æç¤ºè¯ç¿»è¯‘ä¸º${targetLang}ï¼š\n\n${cleanedContent}`
        }
      ]

      const response = await aiService.callAI(
        messages,
        provider,
        model.id,
        false
      )

      if (response && response.trim()) {
        const cleaned = cleanConvertedResponse(response)
        
        // å‡çº§åˆ°äºŒç»´å¯¹è±¡æ ¼å¼
        if (typeof currentPrompt === 'string') {
          const newPrompt = {
            markdown: {
              zh: formatState === 'markdown' && languageState === 'zh' ? currentPrompt : '',
              en: formatState === 'markdown' && languageState === 'en' ? currentPrompt : ''
            },
            xml: {
              zh: formatState === 'xml' && languageState === 'zh' ? currentPrompt : '',
              en: formatState === 'xml' && languageState === 'en' ? currentPrompt : ''
            }
          }
          newPrompt[formatState][targetLanguage] = cleaned
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        } else if (!('markdown' in currentPrompt)) {
          const newPrompt = {
            markdown: {
              zh: formatState === 'markdown' ? currentPrompt.zh : '',
              en: formatState === 'markdown' ? currentPrompt.en : ''
            },
            xml: {
              zh: formatState === 'xml' ? currentPrompt.zh : '',
              en: formatState === 'xml' ? currentPrompt.en : ''
            }
          }
          newPrompt[formatState][targetLanguage] = cleaned
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        } else {
          const newPrompt = { ...currentPrompt }
          newPrompt[formatState][targetLanguage] = cleaned
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: newPrompt } })
        }
        
        setLanguageState(targetLanguage)
        notificationStore.success(`å·²ç¿»è¯‘ä¸º${targetLang}`)
      } else {
        notificationStore.error('è¯­è¨€è½¬æ¢å¤±è´¥ï¼šè¿”å›å†…å®¹ä¸ºç©º')
      }
    } catch (error) {
      notificationStore.error('è¯­è¨€è½¬æ¢å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsConvertingLanguage(false)
    }
  }, [currentGeneratedPrompt, formatState, languageState, isConvertingFormat, isConvertingLanguage, providerStore, notificationStore, aiService, promptStore, setCurrentGeneratedPrompt])

  return {
    currentGeneratedPrompt,
    setCurrentGeneratedPrompt,
    isConvertingFormat,
    isConvertingLanguage,
    formatState,
    languageState,
    toggleFormat,
    toggleLanguage
  }
}

```


## src/hooks/usePreviewExecution.ts

```ts
import { useState, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'
import { useNotificationStore } from '@/stores/notificationStore'
import { PromptGeneratorService } from '@/services/promptGeneratorService'
import { AIGuideService } from '@/services/aiGuideService'
import { cleanConvertedResponse } from '@/utils/aiResponseUtils'
import { useEnsureAIConfig } from '@/hooks/useEnsureAIConfig'

interface UsePreviewExecutionParams {
  switchToTabWithScroll: (tab: string) => void
  scrollToBottomOfContent: () => void
}

export function usePreviewExecution({
  switchToTabWithScroll,
  scrollToBottomOfContent
}: UsePreviewExecutionParams) {
  const promptStore = usePromptStore()
  const notificationStore = useNotificationStore()
  const [isExecuting, setIsExecuting] = useState(false)

  // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
  const { ensureConfig } = useEnsureAIConfig()

  const regenerateRequirementReport = useCallback(async () => {
    const state = promptStore.getState()
    const hasConversationData = state.chatMessages && state.chatMessages.length > 0
    if (!hasConversationData) {
      notificationStore.warning('éœ€è¦å…ˆä¸AIåŠ©æ‰‹å¯¹è¯æ‰èƒ½é‡æ–°ç”Ÿæˆéœ€æ±‚æè¿°')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('report')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] regenerateRequirementReport é…ç½®æˆåŠŸ:', provider.name, model.name)

      const aiGuideService = AIGuideService.getInstance()

      // è·å–å¯¹è¯å†å²
      const validMessages = promptStore.getValidMessages()
      const conversationHistory = validMessages.map(msg => ({
        type: msg.type,
        content: msg.content,
        attachments: msg.attachments || []
      }))

      // è®¾ç½®æµå¼æ›´æ–°
      let streamContent = ''
      const onStreamUpdate = (chunk: string) => {
        streamContent += chunk
        const currentState = promptStore.getState()
        promptStore.setState({ promptData: { ...currentState.promptData, requirementReport: streamContent } })
        scrollToBottomOfContent()
      }

      // é‡æ–°ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š
      const requirementReport = await aiGuideService.generateRequirementReportFromConversation(
        conversationHistory,
        provider,
        model.id,
        onStreamUpdate
      )

      // ç¡®ä¿æœ€ç»ˆæ•°æ®æ­£ç¡®
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, requirementReport } })
      notificationStore.success('éœ€æ±‚æè¿°å·²é‡æ–°ç”Ÿæˆ')

    } catch (error) {
      notificationStore.error('é‡æ–°ç”Ÿæˆéœ€æ±‚æè¿°å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, scrollToBottomOfContent, ensureConfig])

  const executeFullWorkflow = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.requirementReport.trim()) {
      notificationStore.warning('è¯·å…ˆè¾“å…¥éœ€æ±‚æè¿°')
      return
    }

    try {
      setIsExecuting(true)

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      let provider, model
      try {
        const config = await ensureConfig()
        provider = config.provider
        model = config.model
        console.log('[usePreviewExecution] executeFullWorkflow é…ç½®æˆåŠŸ:', provider.name, model.name)
      } catch (configError) {
        // é…ç½®é”™è¯¯å·²ç»åœ¨ ensureConfig ä¸­å¤„ç†äº†é€šçŸ¥ï¼Œè¿™é‡Œåªéœ€è¦é‡ç½®çŠ¶æ€
        console.error('[usePreviewExecution] é…ç½®éªŒè¯å¤±è´¥:', configError)
        setIsExecuting(false)
        promptStore.setCurrentExecutionStep(null)
        return
      }

      const promptGeneratorService = PromptGeneratorService.getInstance()
      const requirementReport = state.promptData.requirementReport

      promptStore.setCurrentExecutionStep('thinking')
      let step1Content = ''
      let step1Initialized = false
      const onStep1Update = (chunk: string) => {
        step1Content += chunk

        // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶ç«‹å³åˆ‡æ¢æ ‡ç­¾é¡µ
        if (!step1Initialized && chunk.trim()) {
          step1Initialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('thinking')
        }

        const points = step1Content.split('\n').map(s => s.replace(/^[*-]\s*/, '').trim()).filter(Boolean)
        if (points.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: points } })
          scrollToBottomOfContent()
        }
      }
      
      const thinkingPoints = await promptGeneratorService.getSystemPromptThinkingPoints(
        requirementReport,
        model.id,
        'zh',
        [],
        provider,
        onStep1Update
      )
      
      const afterStep1State = promptStore.getState()
      promptStore.setState({ promptData: { ...afterStep1State.promptData, thinkingPoints } })
      
      promptStore.setCurrentExecutionStep('initial')
      let step2Content = ''
      let step2Initialized = false
      const onStep2Update = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶ç«‹å³åˆ‡æ¢æ ‡ç­¾é¡µ
        if (!step2Initialized && chunk.trim()) {
          step2Initialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('initial')
        }

        step2Content += chunk
        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œæ›´æ–°å†…å®¹
        if (step2Initialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.initialPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: chunk } })
          } else {
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: step2Content } })
          }
          scrollToBottomOfContent()
        }
      }
      
      const initialPrompt = await promptGeneratorService.generateSystemPrompt(
        requirementReport,
        model.id,
        'zh',
        [],
        thinkingPoints,
        provider,
        onStep2Update
      )
      
      const afterStep2State = promptStore.getState()
      promptStore.setState({ promptData: { ...afterStep2State.promptData, initialPrompt } })
      
      promptStore.setCurrentExecutionStep('advice')
      let step3Content = ''
      let step3Initialized = false
      const onStep3Update = (chunk: string) => {
        step3Content += chunk

        // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶ç«‹å³åˆ‡æ¢æ ‡ç­¾é¡µ
        if (!step3Initialized && chunk.trim()) {
          step3Initialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('advice')
        }

        const adviceList = step3Content.split('\n').map(s => s.replace(/^[*-]\s*/, '').trim()).filter(Boolean)
        if (adviceList.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: adviceList } })
          scrollToBottomOfContent()
        }
      }
      
      const advice = await promptGeneratorService.getOptimizationAdvice(
        initialPrompt,
        'system',
        model.id,
        'zh',
        [],
        provider,
        onStep3Update
      )
      
      const afterStep3State = promptStore.getState()
      promptStore.setState({ promptData: { ...afterStep3State.promptData, advice } })
      
      promptStore.setCurrentExecutionStep('final')
      let step4Content = ''
      let step4Initialized = false
      const onStep4Update = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æ•°æ®æ—¶ç«‹å³åˆ‡æ¢æ ‡ç­¾é¡µ
        if (!step4Initialized && chunk.trim()) {
          step4Initialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('zh')
        }

        step4Content += chunk
        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œæ›´æ–°å†…å®¹
        if (step4Initialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.generatedPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: chunk } })
          } else {
            const currentPrompt = typeof currentState.promptData.generatedPrompt === 'string' 
              ? currentState.promptData.generatedPrompt 
              : ''
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: currentPrompt + chunk } })
          }
          scrollToBottomOfContent()
        }
      }
      
      const finalPrompt = await promptGeneratorService.applyOptimizationAdvice(
        initialPrompt,
        advice,
        'system',
        model.id,
        'zh',
        [],
        provider,
        onStep4Update
      )
      
      const cleanedFinal = cleanConvertedResponse(finalPrompt)
      const afterStep4State = promptStore.getState()
      promptStore.setState({ promptData: { ...afterStep4State.promptData, generatedPrompt: cleanedFinal } })
      
      switchToTabWithScroll('zh')
      
    } catch (error) {
      console.error('[usePreviewExecution] executeFullWorkflow é”™è¯¯:', error)
      console.error('[usePreviewExecution] é”™è¯¯è¯¦æƒ…:', {
        message: error instanceof Error ? error.message : String(error),
        stack: error instanceof Error ? error.stack : undefined,
        errorType: error instanceof Error ? error.constructor.name : typeof error
      })
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      notificationStore.error(`è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯å¤±è´¥: ${errorMessage}`)
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const executeThinkingPoints = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.requirementReport.trim()) {
      notificationStore.warning('è¯·å…ˆè¾“å…¥éœ€æ±‚æŠ¥å‘Š')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('thinking')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] executeThinkingPoints é…ç½®æˆåŠŸ:', provider.name, model.name)

      const promptGeneratorService = PromptGeneratorService.getInstance()
      let streamContent = ''
      let hasInitialized = false

      const onStreamUpdate = (chunk: string) => {
        streamContent += chunk

        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('thinking')
        }

        // å®æ—¶è§£æå¹¶æ›´æ–°å…³é”®æŒ‡ä»¤
        const points = streamContent
          .split('\n')
          .map(s => s.replace(/^[*-]\s*/, '').trim())
          .filter(Boolean)

        if (points.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: points } })
          // æµå¼æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottomOfContent()
        }
      }

      const thinkingPoints = await promptGeneratorService.getSystemPromptThinkingPoints(
        state.promptData.requirementReport,
        model.id,
        'zh',
        [],
        provider,
         onStreamUpdate       )

      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, thinkingPoints } })

    } catch (error) {
      notificationStore.error('ç”Ÿæˆå…³é”®æŒ‡ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const executeInitialPrompt = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.requirementReport.trim() || !state.promptData.thinkingPoints || state.promptData.thinkingPoints.length === 0) {
      notificationStore.warning('è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('initial')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

      
      const promptGeneratorService = PromptGeneratorService.getInstance()
      let step2Content = ''
      let hasInitialized = false

      const onStep2Update = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('initial')
        }

        step2Content += chunk
        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œè¿½åŠ å†…å®¹ï¼›å¦åˆ™è®¾ç½®å†…å®¹
        if (hasInitialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.initialPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: chunk } })
          } else {
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: step2Content } })
          }
          scrollToBottomOfContent()
        }
      }

      const initialPrompt = await promptGeneratorService.generateSystemPrompt(
        state.promptData.requirementReport,
        model!.id,
        'zh',
        [],
        state.promptData.thinkingPoints,
        provider!,
         onStep2Update       )

      // æœ€ç»ˆç¡®ä¿æ•°æ®æ­£ç¡®æ€§ - æ¸…ç†ä»£ç å—æ ‡è®°
      const cleanedInitial = cleanConvertedResponse(initialPrompt)
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, initialPrompt: cleanedInitial } })

    } catch (error) {
      notificationStore.error('ç”Ÿæˆåˆå§‹æç¤ºè¯å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, scrollToBottomOfContent, switchToTabWithScroll, ensureConfig])

  const executeAdvice = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.initialPrompt || !state.promptData.initialPrompt.trim()) {
      notificationStore.warning('è¯·å…ˆç”Ÿæˆåˆå§‹æç¤ºè¯')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('advice')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

      
      const promptGeneratorService = PromptGeneratorService.getInstance()
      let step3Content = ''
      let hasInitialized = false

      const onStep3Update = (chunk: string) => {
        step3Content += chunk

        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('advice')
        }

        // å®æ—¶è§£æå¹¶æ›´æ–°ä¼˜åŒ–å»ºè®®
        const adviceList = step3Content
          .split('\n')
          .map(s => s.replace(/^[*-]\s*/, '').trim())
          .filter(Boolean)

        if (adviceList.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: adviceList } })
          scrollToBottomOfContent()
        }
      }

      const advice = await promptGeneratorService.getOptimizationAdvice(
        state.promptData.initialPrompt,
        'system',
        model!.id,
        'zh',
        [],
        provider!,
         onStep3Update       )

      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, advice } })

    } catch (error) {
      notificationStore.error('ç”Ÿæˆä¼˜åŒ–å»ºè®®å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, scrollToBottomOfContent, switchToTabWithScroll, ensureConfig])

  const executeFinalPrompt = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.initialPrompt || !state.promptData.advice || state.promptData.advice.length === 0) {
      notificationStore.warning('è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('final')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

      
      const promptGeneratorService = PromptGeneratorService.getInstance()
      let step4Content = ''
      let hasInitialized = false

      const onStep4Update = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('zh')
        }

        step4Content += chunk
        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œè¿½åŠ å†…å®¹ï¼›å¦åˆ™è®¾ç½®å†…å®¹
        if (hasInitialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.generatedPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: chunk } })
          } else {
            const currentPrompt = typeof currentState.promptData.generatedPrompt === 'string' 
              ? currentState.promptData.generatedPrompt 
              : ''
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: currentPrompt + chunk } })
          }
          scrollToBottomOfContent()
        }
      }

      const finalPrompt = await promptGeneratorService.applyOptimizationAdvice(
        state.promptData.initialPrompt,
        state.promptData.advice,
        'system',
        model!.id,
        'zh',
        [],
        provider!,
         onStep4Update       )

      const cleanedFinal = cleanConvertedResponse(finalPrompt)
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, generatedPrompt: cleanedFinal } })
      
      switchToTabWithScroll('zh')

    } catch (error) {
      notificationStore.error('ç”Ÿæˆæœ€ç»ˆæç¤ºè¯å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const regenerateThinkingPoints = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.requirementReport.trim()) {
      notificationStore.warning('è¯·å…ˆè¾“å…¥éœ€æ±‚æè¿°')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('thinking')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

            
      const promptGeneratorService = PromptGeneratorService.getInstance()

      // åˆå§‹åŒ–æµå¼æ›´æ–°çŠ¶æ€
      let streamContent = ''
      let hasInitialized = false

      // è®¾ç½®æµå¼å›è°ƒå‡½æ•°
      const onStreamUpdate = (chunk: string) => {
        streamContent += chunk

        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('thinking')
        }

        // å®æ—¶è§£æå¹¶æ›´æ–°å…³é”®æŒ‡ä»¤
        const points = streamContent
          .split('\n')
          .map(s => s.replace(/^[*-]\s*/, '').trim())
          .filter(Boolean)

        if (points.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, thinkingPoints: points } })
          // æµå¼æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottomOfContent()
        }
      }

      const thinkingPoints = await promptGeneratorService.getSystemPromptThinkingPoints(
        state.promptData.requirementReport,
        model.id,
        'zh',
        [],
        provider,
         onStreamUpdate       )

      // æœ€ç»ˆç¡®ä¿æ•°æ®æ­£ç¡®æ€§
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, thinkingPoints } })
      notificationStore.success('å…³é”®æŒ‡ä»¤å·²é‡æ–°ç”Ÿæˆ')

    } catch (error) {
      notificationStore.error('é‡æ–°ç”Ÿæˆå…³é”®æŒ‡ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const regenerateInitialPrompt = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.thinkingPoints || state.promptData.thinkingPoints.length === 0) {
      notificationStore.warning('è¯·å…ˆç”Ÿæˆå…³é”®æŒ‡ä»¤')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('initial')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

            
      const promptGeneratorService = PromptGeneratorService.getInstance()

      // åˆå§‹åŒ–æµå¼æ›´æ–°çŠ¶æ€
      let hasInitialized = false

      // è®¾ç½®æµå¼å›è°ƒå‡½æ•°
      const onStreamUpdate = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('initial')
        }

        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œè¿½åŠ å†…å®¹ï¼›å¦åˆ™è®¾ç½®å†…å®¹
        if (hasInitialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.initialPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: chunk } })
          } else {
            const currentContent = currentState.promptData.initialPrompt || ''
            promptStore.setState({ promptData: { ...currentState.promptData, initialPrompt: currentContent + chunk } })
          }
          // æµå¼æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottomOfContent()
        }
      }

      const initialPrompt = await promptGeneratorService.generateSystemPrompt(
        state.promptData.requirementReport,
        model.id,
        'zh',
        [],
        state.promptData.thinkingPoints,
        provider,
         onStreamUpdate       )

      // æœ€ç»ˆç¡®ä¿æ•°æ®æ­£ç¡®æ€§ - æ¸…ç†ä»£ç å—æ ‡è®°
      const cleanedInitial = cleanConvertedResponse(initialPrompt)
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, initialPrompt: cleanedInitial } })
      notificationStore.success('åˆå§‹æç¤ºè¯å·²é‡æ–°ç”Ÿæˆ')

    } catch (error) {
      notificationStore.error('é‡æ–°ç”Ÿæˆåˆå§‹æç¤ºè¯å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const regenerateAdvice = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.initialPrompt) {
      notificationStore.error('è¯·å…ˆç”Ÿæˆåˆå§‹æç¤ºè¯')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('advice')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

            
      const promptGeneratorService = PromptGeneratorService.getInstance()

      // åˆå§‹åŒ–æµå¼æ›´æ–°çŠ¶æ€
      let streamContent = ''
      let hasInitialized = false

      // è®¾ç½®æµå¼å›è°ƒå‡½æ•°
      const onStreamUpdate = (chunk: string) => {
        streamContent += chunk

        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: ['æ­£åœ¨ç”Ÿæˆ...'] } })
          switchToTabWithScroll('advice')
        }

        // å®æ—¶è§£æå¹¶æ›´æ–°ä¼˜åŒ–å»ºè®®
        const adviceList = streamContent
          .split('\n')
          .map(s => s.replace(/^[*-]\s*/, '').trim())
          .filter(Boolean)

        if (adviceList.length > 0) {
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, advice: adviceList } })
          // æµå¼æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottomOfContent()
        }
      }

      const advice = await promptGeneratorService.getOptimizationAdvice(
        state.promptData.initialPrompt,
        'system',
        model.id,
        'zh',
        [],
        provider,
         onStreamUpdate       )

      // æœ€ç»ˆç¡®ä¿æ•°æ®æ­£ç¡®æ€§
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, advice } })
      notificationStore.success('ä¼˜åŒ–å»ºè®®å·²é‡æ–°ç”Ÿæˆ')

    } catch (error) {
      notificationStore.error('é‡æ–°ç”Ÿæˆä¼˜åŒ–å»ºè®®å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  const regenerateFinalPrompt = useCallback(async () => {
    const state = promptStore.getState()
    if (!state.promptData.initialPrompt || !state.promptData.advice) {
      notificationStore.error('è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤')
      return
    }

    try {
      setIsExecuting(true)
      promptStore.setCurrentExecutionStep('final')

      // ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç¡®ä¿å‡½æ•°
      const { provider, model } = await ensureConfig()
      console.log('[usePreviewExecution] é…ç½®æˆåŠŸ:', provider.name, model.name)

            
      const promptGeneratorService = PromptGeneratorService.getInstance()

      // åˆå§‹åŒ–æµå¼æ›´æ–°çŠ¶æ€
      let hasInitialized = false

      // è®¾ç½®æµå¼å›è°ƒå‡½æ•°
      const onStreamUpdate = (chunk: string) => {
        // é¦–æ¬¡æ”¶åˆ°æœ‰æ•ˆæ•°æ®æ—¶ï¼Œç«‹å³åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µå¹¶åˆå§‹åŒ–
        if (!hasInitialized && chunk.trim()) {
          hasInitialized = true
          const currentState = promptStore.getState()
          promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: 'æ­£åœ¨ç”Ÿæˆ...' } })
          switchToTabWithScroll('zh')
        }

        // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œè¿½åŠ å†…å®¹ï¼›å¦åˆ™è®¾ç½®å†…å®¹
        if (hasInitialized) {
          const currentState = promptStore.getState()
          if (currentState.promptData.generatedPrompt === 'æ­£åœ¨ç”Ÿæˆ...') {
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: chunk } })
          } else {
            const currentPrompt = typeof currentState.promptData.generatedPrompt === 'string' 
              ? currentState.promptData.generatedPrompt 
              : ''
            promptStore.setState({ promptData: { ...currentState.promptData, generatedPrompt: currentPrompt + chunk } })
          }
          // æµå¼æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottomOfContent()
        }
      }

      const finalPrompt = await promptGeneratorService.applyOptimizationAdvice(
        state.promptData.initialPrompt,
        state.promptData.advice,
        'system',
        model.id,
        'zh',
        [],
        provider,
         onStreamUpdate       )

      // æœ€ç»ˆç¡®ä¿æ•°æ®æ­£ç¡®æ€§ - æ¸…ç†ä»£ç å—æ ‡è®°
      const cleanedFinal = cleanConvertedResponse(finalPrompt)
      const finalState = promptStore.getState()
      promptStore.setState({ promptData: { ...finalState.promptData, generatedPrompt: cleanedFinal } })
      notificationStore.success('æœ€ç»ˆæç¤ºè¯å·²é‡æ–°ç”Ÿæˆ')

    } catch (error) {
      notificationStore.error('é‡æ–°ç”Ÿæˆæœ€ç»ˆæç¤ºè¯å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsExecuting(false)
      promptStore.setCurrentExecutionStep(null)
    }
  }, [promptStore, notificationStore, switchToTabWithScroll, scrollToBottomOfContent, ensureConfig])

  return {
    isExecuting,
    regenerateRequirementReport,
    executeFullWorkflow,
    executeThinkingPoints,
    executeInitialPrompt,
    executeAdvice,
    executeFinalPrompt,
    regenerateThinkingPoints,
    regenerateInitialPrompt,
    regenerateAdvice,
    regenerateFinalPrompt
  }
}

```


## src/hooks/usePreviewHelpers.ts

```ts
import { useMemo, useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'

export function usePreviewHelpers() {
  const promptStore = usePromptStore()

  const hasAnyContent = useMemo(() => {
    return true // å§‹ç»ˆæ˜¾ç¤ºï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥è¾“å…¥éœ€æ±‚æè¿°
  }, [])

  const hasConversationData = useMemo(() => {
    return promptStore.chatMessages && promptStore.chatMessages.length > 0
  }, [promptStore.chatMessages])

  const getStepDisplayName = useCallback((step: string): string => {
    const stepNames: { [key: string]: string } = {
      'report': 'ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š',
      'thinking': 'æå–å…³é”®æŒ‡ä»¤', 
      'initial': 'ç”Ÿæˆåˆå§‹æç¤ºè¯',
      'advice': 'åˆ†æä¼˜åŒ–å»ºè®®',
      'final': 'åˆæˆæœ€ç»ˆæç¤ºè¯'
    }
    return stepNames[step] || 'ç”Ÿæˆ'
  }, [])

  return {
    hasAnyContent,
    hasConversationData,
    getStepDisplayName
  }
}

```


## src/hooks/usePreviewListOperations.ts

```ts
import { useCallback } from 'react'
import { usePromptStore } from '@/stores/promptStore'

export function usePreviewListOperations() {
  const promptStore = usePromptStore()

  const addThinkingPoint = useCallback(() => {
    const state = promptStore.getState()
    const currentPoints = state.promptData.thinkingPoints || []
    promptStore.setState({
      promptData: {
        ...state.promptData,
        thinkingPoints: [...currentPoints, '']
      }
    })
  }, [promptStore])

  const removeThinkingPoint = useCallback((index: number) => {
    const state = promptStore.getState()
    const currentPoints = state.promptData.thinkingPoints || []
    if (index >= 0 && index < currentPoints.length) {
      const newPoints = currentPoints.filter((_, i) => i !== index)
      promptStore.setState({
        promptData: {
          ...state.promptData,
          thinkingPoints: newPoints
        }
      })
    }
  }, [promptStore])

  const addAdviceItem = useCallback(() => {
    const state = promptStore.getState()
    const currentAdvice = state.promptData.advice || []
    promptStore.setState({
      promptData: {
        ...state.promptData,
        advice: [...currentAdvice, '']
      }
    })
  }, [promptStore])

  const removeAdviceItem = useCallback((index: number) => {
    const state = promptStore.getState()
    const currentAdvice = state.promptData.advice || []
    if (index >= 0 && index < currentAdvice.length) {
      const newAdvice = currentAdvice.filter((_, i) => i !== index)
      promptStore.setState({
        promptData: {
          ...state.promptData,
          advice: newAdvice
        }
      })
    }
  }, [promptStore])

  return {
    addThinkingPoint,
    removeThinkingPoint,
    addAdviceItem,
    removeAdviceItem
  }
}

```


## src/hooks/usePreviewScrollSync.ts

```ts
import { useRef, useCallback } from 'react'

export interface ScrollContainerRefs {
  reportScrollContainer?: HTMLElement | null
  thinkingScrollContainer?: HTMLElement | null
  initialScrollContainer?: HTMLElement | null
  adviceScrollContainer?: HTMLElement | null
  finalScrollContainer?: HTMLElement | null
}

export function usePreviewScrollSync() {
  const scrollContainerRefs = useRef<ScrollContainerRefs>({})
  
  const setScrollContainerRefs = useCallback((refs: Partial<ScrollContainerRefs>) => {
    scrollContainerRefs.current = { ...scrollContainerRefs.current, ...refs }
  }, [])

  const scrollToBottomOfContent = useCallback(() => {
    setTimeout(() => {
      const containers = [
        scrollContainerRefs.current.reportScrollContainer,
        scrollContainerRefs.current.thinkingScrollContainer,
        scrollContainerRefs.current.initialScrollContainer,
        scrollContainerRefs.current.adviceScrollContainer,
        scrollContainerRefs.current.finalScrollContainer
      ]

      containers.forEach(container => {
        if (container) {
          container.scrollTop = container.scrollHeight
        }
      })
    }, 0)
  }, [])

  const scrollContainerToBottom = useCallback((containerName: keyof ScrollContainerRefs) => {
    setTimeout(() => {
      const container = scrollContainerRefs.current[containerName]
      if (container) {
        container.scrollTop = container.scrollHeight
      }
    }, 0)
  }, [])

  return {
    setScrollContainerRefs,
    scrollToBottomOfContent,
    scrollContainerToBottom
  }
}

```


## src/hooks/usePreviewTabs.ts

```ts
import { useState, useRef, useCallback } from 'react'

export type TabType = 'report' | 'thinking' | 'initial' | 'advice' | 'zh' | 'en'

export interface TabRefs {
  tabContainer?: HTMLElement | null
  reportTab?: HTMLButtonElement | null
  thinkingTab?: HTMLButtonElement | null
  initialTab?: HTMLButtonElement | null
  adviceTab?: HTMLButtonElement | null
  zhTab?: HTMLButtonElement | null
}

export function usePreviewTabs() {
  const [activeTab, setActiveTab] = useState<TabType>('report')
  const [newContentTabs, setNewContentTabs] = useState<Set<string>>(new Set())
  const tabRefs = useRef<TabRefs>({})

  const setTabRefs = useCallback((refs: Partial<TabRefs>) => {
    tabRefs.current = { ...tabRefs.current, ...refs }
  }, [])

  const markTabAsViewed = useCallback((tab: string) => {
    setNewContentTabs(prev => {
      const newSet = new Set(prev)
      newSet.delete(tab)
      return newSet
    })
  }, [])

  const scrollToActiveTab = useCallback((tabName: string) => {
    const tabRefMap: Record<string, HTMLElement | null | undefined> = {
      'report': tabRefs.current.reportTab,
      'thinking': tabRefs.current.thinkingTab,
      'initial': tabRefs.current.initialTab,
      'advice': tabRefs.current.adviceTab,
      'zh': tabRefs.current.zhTab
    }

    const targetTab = tabRefMap[tabName]
    const container = tabRefs.current.tabContainer

    if (targetTab && container) {
      const containerRect = container.getBoundingClientRect()
      const tabRect = targetTab.getBoundingClientRect()

      const tabLeftRelativeToContainer = tabRect.left - containerRect.left + container.scrollLeft
      const tabRightRelativeToContainer = tabLeftRelativeToContainer + tabRect.width

      const containerWidth = containerRect.width
      const scrollLeft = container.scrollLeft
      const scrollRight = scrollLeft + containerWidth

      if (tabLeftRelativeToContainer < scrollLeft) {
        container.scrollTo({
          left: tabLeftRelativeToContainer - 20,
          behavior: 'smooth'
        })
      } else if (tabRightRelativeToContainer > scrollRight) {
        container.scrollTo({
          left: tabLeftRelativeToContainer - containerWidth + tabRect.width + 20,
          behavior: 'smooth'
        })
      }
    }
  }, [])

  const switchToTabWithScroll = useCallback((tab: string) => {
    setActiveTab(tab as TabType)
    setTimeout(() => {
      scrollToActiveTab(tab)
    }, 0)
  }, [scrollToActiveTab])

  const handleTabChange = useCallback((tab: string) => {
    setActiveTab(tab as TabType)
    markTabAsViewed(tab)
    setTimeout(() => {
      scrollToActiveTab(tab)
    }, 0)
  }, [markTabAsViewed, scrollToActiveTab])

  return {
    activeTab,
    newContentTabs,
    setNewContentTabs,
    setTabRefs,
    markTabAsViewed,
    scrollToActiveTab,
    switchToTabWithScroll,
    handleTabChange
  }
}

```


## src/hooks/useUserPromptQuickOptimize.ts

```ts
import { useState, useCallback, useMemo } from 'react'
import { useProviderStore } from '@/stores/providerStore'
import { useOptimizeStore } from '@/stores/optimizeStore'
import { promptConfigManager } from '@/config/prompts'
import { AIService } from '@/services/aiService'
import { parseAIJsonResponse } from '@/utils/jsonParser'
import { post } from '@/services/apiService'

/**
 * è´¨é‡åˆ†æç»´åº¦
 */
export interface QualityDimension {
  score: number
  feedback: string
}

/**
 * è´¨é‡åˆ†æç»“æœ
 */
export interface QualityAnalysisResult {
  overall_score: number
  analysis: {
    clarity?: QualityDimension
    specificity?: QualityDimension
    structure?: QualityDimension
    context?: QualityDimension
    completeness?: QualityDimension
    [key: string]: QualityDimension | undefined
  }
  issues?: string[]
}

/**
 * å¿«é€Ÿä¼˜åŒ–ç»“æœ
 */
export interface QuickOptimizeResult {
  originalPrompt: string
  qualityAnalysis: QualityAnalysisResult
  optimizedPrompt: string | { zh: string; en: string }
  metadata: {
    processingTime: number
    modelUsed: string
    timestamp: Date
  }
}

interface QuickOptimizeState {
  draftPrompt: string
  systemPrompt: string
  conversationHistory: string
  result: QuickOptimizeResult | null
  isOptimizing: boolean
  error: string | null
  isAnalyzing: boolean
  analysisText: string
  isOptimizingPrompt: boolean
  optimizedText: string
  enableQualityAnalysis: boolean
  languageState: 'zh' | 'en'
  isConvertingLanguage: boolean
}

const RESULT_STORAGE_KEY = 'user_prompt_optimize_result'

export function useUserPromptQuickOptimize() {
  const providerStore = useProviderStore()
  const optimizeStore = useOptimizeStore()
  const aiService = AIService.getInstance()

  // ä»localStorageåŠ è½½ä¹‹å‰çš„ç»“æœ
  const loadResult = useCallback((): QuickOptimizeResult | null => {
    try {
      const saved = localStorage.getItem(RESULT_STORAGE_KEY)
      if (saved) {
        const data = JSON.parse(saved)
        if (data.metadata && data.metadata.timestamp) {
          data.metadata.timestamp = new Date(data.metadata.timestamp)
        }
        return data
      }
    } catch (e) {
      console.error('åŠ è½½ä¼˜åŒ–ç»“æœå¤±è´¥:', e)
    }
    return null
  }, [])

  // ä¿å­˜ç»“æœåˆ°localStorage
  const saveResult = useCallback((result: QuickOptimizeResult | null) => {
    try {
      if (result) {
        localStorage.setItem(RESULT_STORAGE_KEY, JSON.stringify(result))
      } else {
        localStorage.removeItem(RESULT_STORAGE_KEY)
      }
    } catch (e) {
      console.error('ä¿å­˜ä¼˜åŒ–ç»“æœå¤±è´¥:', e)
    }
  }, [])

  const [state, setState] = useState<QuickOptimizeState>(() => ({
    draftPrompt: '',
    systemPrompt: '',
    conversationHistory: '',
    result: loadResult(),
    isOptimizing: false,
    error: null,
    isAnalyzing: false,
    analysisText: '',
    isOptimizingPrompt: false,
    optimizedText: '',
    enableQualityAnalysis: true,
    languageState: 'zh',
    isConvertingLanguage: false
  }))

  // è®¡ç®—å±æ€§
  const hasInput = useMemo(() => state.draftPrompt.trim().length > 0, [state.draftPrompt])
  const hasResult = useMemo(() => state.result !== null, [state.result])
  const hasError = useMemo(() => state.error !== null, [state.error])

  /**
   * æ£€æµ‹æ–‡æœ¬è¯­è¨€
   */
  const detectLanguage = useCallback((text: string): string => {
    const chinesePattern = /[\u4e00-\u9fa5]/
    if (chinesePattern.test(text)) {
      return 'ä¸­æ–‡'
    }
    return 'è‹±æ–‡'
  }, [])

  /**
   * è®¾ç½®è‰ç¨¿æç¤ºè¯
   */
  const setDraftPrompt = useCallback((prompt: string) => {
    setState((prev) => ({ ...prev, draftPrompt: prompt }))
    clearResult()
  }, [])

  /**
   * è®¾ç½®ç³»ç»Ÿæç¤ºè¯
   */
  const setSystemPrompt = useCallback((prompt: string) => {
    setState((prev) => ({ ...prev, systemPrompt: prompt }))
  }, [])

  /**
   * è®¾ç½®å¯¹è¯å†å²
   */
  const setConversationHistory = useCallback((history: string) => {
    setState((prev) => ({ ...prev, conversationHistory: history }))
  }, [])

  /**
   * æ¸…é™¤ç»“æœ
   */
  const clearResult = useCallback(() => {
    setState((prev) => ({
      ...prev,
      result: null,
      error: null,
      languageState: 'zh'
    }))
    saveResult(null)
  }, [saveResult])

  /**
   * å¿«é€Ÿä¼˜åŒ–ï¼šè´¨é‡åˆ†æ + ä¼˜åŒ–ç»“æœ
   */
  const quickOptimize = useCallback(async () => {
    if (!state.draftPrompt.trim()) {
      setState((prev) => ({ ...prev, error: 'è¯·è¾“å…¥è‰ç¨¿æç¤ºè¯' }))
      return
    }

    setState((prev) => ({
      ...prev,
      isOptimizing: true,
      error: null,
      analysisText: '',
      optimizedText: ''
    }))

    const startTime = performance.now()

    try {
      const detectedLanguage = detectLanguage(state.draftPrompt)

      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆåœ¨é¡¶éƒ¨é€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      // æ„å»ºè´¨é‡åˆ†æè¯·æ±‚
      const contextSection = state.conversationHistory
        ? `\n**å¯¹è¯ä¸Šä¸‹æ–‡ï¼š**\n${state.conversationHistory}\n`
        : ''
      const systemPromptSection = state.systemPrompt
        ? `\n**AIåŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ï¼š**\n${state.systemPrompt}\n`
        : ''

      const analysisSystemPrompt = `ä½ æ˜¯ä¸“ä¸šçš„ç”¨æˆ·æç¤ºè¯è´¨é‡åˆ†æå¸ˆã€‚

**ä»»åŠ¡ï¼š**åˆ†æç”¨æˆ·è‰ç¨¿æç¤ºè¯çš„è´¨é‡ï¼Œç»™å‡ºè¯„åˆ†å’Œå»ºè®®ã€‚
${systemPromptSection}${contextSection}
**â—ï¸ é‡è¦è§’è‰²è¯´æ˜ â—ï¸**
- **ç³»ç»Ÿæç¤ºè¯**ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰æ˜¯**AIåŠ©æ‰‹**çš„è§’è‰²è®¾å®šï¼Œä¸æ˜¯ç”¨æˆ·çš„è§’è‰²
- **ç”¨æˆ·è‰ç¨¿**æ˜¯ç”¨æˆ·å‘ç»™AIåŠ©æ‰‹çš„æ¶ˆæ¯ï¼Œç”¨æˆ·ä¸éœ€è¦æ‰®æ¼”AIåŠ©æ‰‹çš„è§’è‰²
- ä¾‹å¦‚ï¼šAIåŠ©æ‰‹æ˜¯åŒ»ç”Ÿï¼Œç”¨æˆ·æ˜¯æ‚£è€…ï¼›AIåŠ©æ‰‹æ˜¯ç¿»è¯‘ï¼Œç”¨æˆ·æ˜¯éœ€è¦ç¿»è¯‘æœåŠ¡çš„äºº

**åˆ†æåŸåˆ™ï¼š**
- âœ… è‰ç¨¿æ˜¯å¦ä¸**å¯¹è¯å†å²è¿è´¯**ï¼ˆä¾‹å¦‚ï¼šAIé—®"å¤šä¹…äº†"ï¼Œç”¨æˆ·ç­”"ä¸‰å¤©äº†"æ˜¯è¿è´¯çš„ï¼‰
- âœ… è‰ç¨¿æ˜¯å¦æ¸…æ™°åœ°å‘AIåŠ©æ‰‹**æå‡ºéœ€æ±‚æˆ–æä¾›ä¿¡æ¯**
- âŒ ä¸è¦è¦æ±‚ç”¨æˆ·è‰ç¨¿"ç¬¦åˆAIåŠ©æ‰‹çš„è§’è‰²"ï¼ˆç”¨æˆ·ä¸æ˜¯AIåŠ©æ‰‹ï¼ï¼‰
- âŒ ä¸è¦è¦æ±‚ç”¨æˆ·è‰ç¨¿åŒ…å«AIåŠ©æ‰‹æ‰åº”è¯¥æä¾›çš„å†…å®¹ï¼ˆå¦‚åŒ»ç”Ÿçš„è¯Šæ–­å»ºè®®ï¼‰

**åˆ†æç»´åº¦ï¼ˆåŸºäºä¸šç•Œæœ€ä½³å®è·µï¼‰ï¼š**
1. **æ¸…æ™°åº¦ (clarity)**: æ„å›¾æ˜¯å¦æ˜ç¡®ï¼Œè¡¨è¾¾æ˜¯å¦æ¸…æ™°ï¼Œé¿å…æ­§ä¹‰
2. **ç‰¹å®šæ€§ (specificity)**: æ˜¯å¦å…·ä½“ï¼Œç»†èŠ‚æ˜¯å¦å……åˆ†ï¼Œé¿å…æ¨¡ç³Šå’Œæ³›æ³›è€Œè°ˆ
3. **ç»“æ„ (structure)**: ä¿¡æ¯æ˜¯å¦æœ‰ç»„ç»‡ï¼Œé€»è¾‘æ˜¯å¦æ¸…æ™°ï¼Œå±‚æ¬¡æ˜¯å¦åˆ†æ˜
4. **ä¸Šä¸‹æ–‡ (context)**: æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„èƒŒæ™¯ä¿¡æ¯ã€ä½¿ç”¨åœºæ™¯ã€ç›®æ ‡å—ä¼—ç­‰ï¼›æ˜¯å¦ä¸å¯¹è¯å†å²è¿è´¯
5. **å®Œæ•´æ€§ (completeness)**: æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦å…ƒç´ ï¼ˆä»»åŠ¡ã€è¦æ±‚ã€é™åˆ¶ã€è¾“å‡ºæ ¼å¼ç­‰ï¼‰

**è¯„åˆ†æ ‡å‡†ï¼š**
- 90-100: ä¼˜ç§€ï¼Œå‡ ä¹æ— é—®é¢˜
- 70-89: è‰¯å¥½ï¼Œæœ‰å°é—®é¢˜ä½†ä¸å½±å“ä½¿ç”¨
- 50-69: ä¸€èˆ¬ï¼Œæœ‰æ˜æ˜¾é—®é¢˜éœ€è¦ä¼˜åŒ–
- <50: å·®ï¼Œé—®é¢˜è¾ƒå¤šå¿…é¡»ä¼˜åŒ–

**è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š**
\`\`\`json
{
  "overall_score": 75,
  "analysis": {
    "clarity": {
      "score": 80,
      "feedback": "æ„å›¾åŸºæœ¬æ˜ç¡®ï¼Œä½†æŸäº›è¡¨è¿°ç•¥æ˜¾æ¨¡ç³Š"
    },
    "specificity": {
      "score": 60,
      "feedback": "ç¼ºå°‘å…·ä½“ç»†èŠ‚ï¼Œè¿‡äºç¬¼ç»Ÿ"
    },
    "structure": {
      "score": 70,
      "feedback": "æœ‰åŸºæœ¬ç»“æ„ï¼Œä½†å±‚æ¬¡ä¸å¤Ÿæ¸…æ™°"
    },
    "context": {
      "score": 50,
      "feedback": "æœªæä¾›èƒŒæ™¯ä¿¡æ¯å’Œä½¿ç”¨åœºæ™¯"
    },
    "completeness": {
      "score": 65,
      "feedback": "ç¼ºå°‘è¾“å‡ºæ ¼å¼å’Œä¸€äº›å…³é”®è¦æ±‚"
    }
  },
  "issues": [
    "æç¤ºè¯ç¼ºå°‘å…·ä½“çš„ä½¿ç”¨åœºæ™¯å’Œç›®æ ‡å—ä¼—",
    "æœªæ˜ç¡®è¾“å‡ºæ ¼å¼å’Œå­—æ•°è¦æ±‚",
    "ç¼ºå°‘å¿…è¦çš„èƒŒæ™¯ä¿¡æ¯å’Œçº¦æŸæ¡ä»¶"
  ]
}
\`\`\`

**è‰ç¨¿æç¤ºè¯ï¼š**
${state.draftPrompt}

**è¯·ç›´æ¥è¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚**`

      const optimizationTemplate = promptConfigManager.getUserPromptQuickOptimization()
      const rules = promptConfigManager.getUserPromptRules()

      const optimizationSystemPrompt = optimizationTemplate
        .replace('{SYSTEM_PROMPT_RULES}', rules)
        .replace('{SYSTEM_PROMPT_CONTEXT}', state.systemPrompt || 'æ— ç³»ç»Ÿæç¤ºè¯')
        .replace('{CONVERSATION_HISTORY}', state.conversationHistory || 'æ— å¯¹è¯å†å²')
        .replace('{USER_DRAFT_PROMPT}', state.draftPrompt)
        .replace('{VARIABLES_SECTION}', '')
        .replace('{LANGUAGE}', detectedLanguage)

      const analysisMessages = [
        { role: 'system' as const, content: analysisSystemPrompt },
        { role: 'user' as const, content: 'è¯·åˆ†æè¿™ä¸ªè‰ç¨¿çš„é—®é¢˜' }
      ]

      const optimizationMessages = [
        { role: 'system' as const, content: optimizationSystemPrompt },
        { role: 'user' as const, content: 'è¯·è¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ï¼ˆåªè¾“å‡ºä¼˜åŒ–ç»“æœï¼Œä¸è¦è§£é‡Šï¼‰' }
      ]

      let qualityAnalysis: QualityAnalysisResult | null = null

      // å¦‚æœå¯ç”¨è´¨é‡åˆ†æï¼Œå…ˆæ‰§è¡Œåˆ†æ
      if (state.enableQualityAnalysis) {
        console.log('ğŸ” å¼€å§‹è´¨é‡åˆ†æï¼ˆæµå¼ï¼‰')

        setState((prev) => ({ ...prev, isAnalyzing: true }))

        let fullAnalysisText = ''
        aiService.setStreamUpdateCallback((chunk: string) => {
          fullAnalysisText += chunk
          setState((prev) => ({ ...prev, analysisText: fullAnalysisText }))
        })

        const qualityAnalysisText = await aiService.callAI(
          analysisMessages,
          currentProvider,
          currentModel.id,
          true
        )
        aiService.clearStreamUpdateCallback()
        setState((prev) => ({ ...prev, isAnalyzing: false }))

        qualityAnalysis = parseAIJsonResponse(qualityAnalysisText) as QualityAnalysisResult | null
        if (!qualityAnalysis) {
          throw new Error('è´¨é‡åˆ†æç»“æœæ ¼å¼é”™è¯¯')
        }

        console.log('âœ… è´¨é‡åˆ†æå®Œæˆï¼Œå¼€å§‹ä¼˜åŒ–ç»“æœï¼ˆæµå¼ï¼‰')

        // å°†è´¨é‡åˆ†æç»“æœæ³¨å…¥åˆ°ä¼˜åŒ–æç¤ºè¯ä¸­
        const analysisContext = `

**è´¨é‡åˆ†æç»“æœï¼ˆè¯·å‚è€ƒä»¥æ”¹è¿›ï¼‰ï¼š**
- æ•´ä½“è¯„åˆ†ï¼š${qualityAnalysis.overall_score}/100
- æ¸…æ™°åº¦ï¼š${qualityAnalysis.analysis.clarity?.score}/100 - ${qualityAnalysis.analysis.clarity?.feedback}
- ç‰¹å®šæ€§ï¼š${qualityAnalysis.analysis.specificity?.score}/100 - ${qualityAnalysis.analysis.specificity?.feedback}
- ç»“æ„ï¼š${qualityAnalysis.analysis.structure?.score}/100 - ${qualityAnalysis.analysis.structure?.feedback}
- ä¸Šä¸‹æ–‡ï¼š${qualityAnalysis.analysis.context?.score}/100 - ${qualityAnalysis.analysis.context?.feedback}
- å®Œæ•´æ€§ï¼š${qualityAnalysis.analysis.completeness?.score}/100 - ${qualityAnalysis.analysis.completeness?.feedback}
${
  qualityAnalysis.issues && qualityAnalysis.issues.length > 0
    ? `\n**å‘ç°çš„é—®é¢˜ï¼š**\n${qualityAnalysis.issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n')}`
    : ''
}

è¯·æ ¹æ®ä»¥ä¸Šåˆ†æç»“æœï¼Œé‡ç‚¹æ”¹è¿›ä½åˆ†ç»´åº¦ï¼Œç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯ã€‚`

        optimizationMessages[0].content += analysisContext
      } else {
        console.log('â­ï¸ è·³è¿‡è´¨é‡åˆ†æï¼Œç›´æ¥ä¼˜åŒ–')
      }

      // ä¼˜åŒ–ç»“æœæµ
      setState((prev) => ({ ...prev, isOptimizingPrompt: true }))
      let fullOptimizedText = ''
      aiService.setStreamUpdateCallback((chunk: string) => {
        fullOptimizedText += chunk
        setState((prev) => ({ ...prev, optimizedText: fullOptimizedText }))
      })

      const optimizedPrompt = await aiService.callAI(
        optimizationMessages,
        currentProvider,
        currentModel.id,
        true
      )
      aiService.clearStreamUpdateCallback()
      setState((prev) => ({ ...prev, isOptimizingPrompt: false }))

      console.log('âœ… ä¼˜åŒ–å®Œæˆ')

      const processingTime = performance.now() - startTime

      const result: QuickOptimizeResult = {
        originalPrompt: state.draftPrompt,
        qualityAnalysis:
          qualityAnalysis || {
            overall_score: 0,
            analysis: {},
            issues: []
          },
        optimizedPrompt: optimizedPrompt.trim(),
        metadata: {
          processingTime,
          modelUsed: providerStore.currentModel?.id || 'unknown',
          timestamp: new Date()
        }
      }

      setState((prev) => ({
        ...prev,
        result,
        languageState: 'zh'
      }))

      saveResult(result)
      console.log(`âœ… ä¼˜åŒ–å®Œæˆï¼Œæ€»è€—æ—¶: ${processingTime.toFixed(0)}ms`)
    } catch (error: any) {
      console.error('å¿«é€Ÿä¼˜åŒ–å¤±è´¥:', error)
      setState((prev) => ({
        ...prev,
        error: error.message || 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•',
        result: null,
        isAnalyzing: false,
        isOptimizingPrompt: false
      }))
      saveResult(null)
    } finally {
      setState((prev) => ({ ...prev, isOptimizing: false }))
    }
  }, [state, providerStore, aiService, detectLanguage, saveResult])

  /**
   * ä»…é‡æ–°ç”Ÿæˆä¼˜åŒ–ç»“æœ
   */
  const regenerateOptimization = useCallback(async () => {
    if (!state.result) {
      setState((prev) => ({ ...prev, error: 'æ²¡æœ‰å¯ç”¨çš„è´¨é‡åˆ†æç»“æœ' }))
      return
    }

    setState((prev) => ({
      ...prev,
      isOptimizing: true,
      error: null,
      optimizedText: ''
    }))

    const startTime = performance.now()

    try {
      const detectedLanguage = detectLanguage(state.draftPrompt)

      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆåœ¨é¡¶éƒ¨é€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      const optimizationTemplate = promptConfigManager.getUserPromptQuickOptimization()
      const rules = promptConfigManager.getUserPromptRules()

      const optimizationSystemPrompt = optimizationTemplate
        .replace('{SYSTEM_PROMPT_RULES}', rules)
        .replace('{SYSTEM_PROMPT_CONTEXT}', state.systemPrompt || 'æ— ç³»ç»Ÿæç¤ºè¯')
        .replace('{CONVERSATION_HISTORY}', state.conversationHistory || 'æ— å¯¹è¯å†å²')
        .replace('{USER_DRAFT_PROMPT}', state.draftPrompt)
        .replace('{VARIABLES_SECTION}', '')
        .replace('{LANGUAGE}', detectedLanguage)

      const optimizationMessages = [
        { role: 'system' as const, content: optimizationSystemPrompt },
        { role: 'user' as const, content: 'è¯·è¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ï¼ˆåªè¾“å‡ºä¼˜åŒ–ç»“æœï¼Œä¸è¦è§£é‡Šï¼‰' }
      ]

      // å¦‚æœæœ‰è´¨é‡åˆ†æç»“æœï¼Œæ³¨å…¥åˆ°ä¼˜åŒ–æç¤ºè¯ä¸­
      if (
        state.enableQualityAnalysis &&
        state.result.qualityAnalysis &&
        state.result.qualityAnalysis.overall_score > 0
      ) {
        const qualityAnalysis = state.result.qualityAnalysis
        const analysisContext = `

**è´¨é‡åˆ†æç»“æœï¼ˆè¯·å‚è€ƒä»¥æ”¹è¿›ï¼‰ï¼š**
- æ•´ä½“è¯„åˆ†ï¼š${qualityAnalysis.overall_score}/100
- æ¸…æ™°åº¦ï¼š${qualityAnalysis.analysis.clarity?.score}/100 - ${qualityAnalysis.analysis.clarity?.feedback}
- ç‰¹å®šæ€§ï¼š${qualityAnalysis.analysis.specificity?.score}/100 - ${qualityAnalysis.analysis.specificity?.feedback}
- ç»“æ„ï¼š${qualityAnalysis.analysis.structure?.score}/100 - ${qualityAnalysis.analysis.structure?.feedback}
- ä¸Šä¸‹æ–‡ï¼š${qualityAnalysis.analysis.context?.score}/100 - ${qualityAnalysis.analysis.context?.feedback}
- å®Œæ•´æ€§ï¼š${qualityAnalysis.analysis.completeness?.score}/100 - ${qualityAnalysis.analysis.completeness?.feedback}
${
  qualityAnalysis.issues && qualityAnalysis.issues.length > 0
    ? `\n**å‘ç°çš„é—®é¢˜ï¼š**\n${qualityAnalysis.issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n')}`
    : ''
}

è¯·æ ¹æ®ä»¥ä¸Šåˆ†æç»“æœï¼Œé‡ç‚¹æ”¹è¿›ä½åˆ†ç»´åº¦ï¼Œç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯ã€‚`

        optimizationMessages[0].content += analysisContext
      }

      // ä¼˜åŒ–ç»“æœæµ
      setState((prev) => ({ ...prev, isOptimizingPrompt: true }))
      let fullOptimizedText = ''
      aiService.setStreamUpdateCallback((chunk: string) => {
        fullOptimizedText += chunk
        setState((prev) => ({ ...prev, optimizedText: fullOptimizedText }))
      })

      const optimizedPrompt = await aiService.callAI(
        optimizationMessages,
        currentProvider,
        currentModel.id,
        true
      )
      aiService.clearStreamUpdateCallback()
      setState((prev) => ({ ...prev, isOptimizingPrompt: false }))

      console.log('âœ… é‡æ–°ç”Ÿæˆä¼˜åŒ–å®Œæˆ')

      const processingTime = performance.now() - startTime

      // ä¿ç•™åŸæœ‰çš„è´¨é‡åˆ†æç»“æœï¼Œåªæ›´æ–°ä¼˜åŒ–åçš„æç¤ºè¯
      const updatedResult: QuickOptimizeResult = {
        ...state.result,
        optimizedPrompt: optimizedPrompt.trim(),
        metadata: {
          processingTime,
          modelUsed: providerStore.currentModel?.id || 'unknown',
          timestamp: new Date()
        }
      }

      setState((prev) => ({
        ...prev,
        result: updatedResult,
        languageState: 'zh'
      }))

      saveResult(updatedResult)
      console.log(`âœ… é‡æ–°ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: ${processingTime.toFixed(0)}ms`)
    } catch (error: any) {
      console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error)
      setState((prev) => ({
        ...prev,
        error: error.message || 'é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•',
        isOptimizingPrompt: false
      }))
    } finally {
      setState((prev) => ({ ...prev, isOptimizing: false }))
    }
  }, [state, providerStore, aiService, detectLanguage, saveResult])

  /**
   * åˆ‡æ¢è¯­è¨€
   */
  const toggleLanguage = useCallback(async () => {
    if (!state.result || state.isConvertingLanguage) return

    const currentPrompt =
      typeof state.result.optimizedPrompt === 'string'
        ? state.result.optimizedPrompt
        : state.languageState === 'zh'
        ? state.result.optimizedPrompt.zh
        : state.result.optimizedPrompt.en

    if (!currentPrompt) return

    const targetLangCode = state.languageState === 'zh' ? 'en' : 'zh'

    // å¦‚æœå·²ç»æ˜¯å¯¹è±¡æ ¼å¼ä¸”ç›®æ ‡è¯­è¨€å·²ç¼“å­˜ï¼Œç›´æ¥åˆ‡æ¢
    if (typeof state.result.optimizedPrompt !== 'string') {
      const targetPrompt =
        targetLangCode === 'zh' ? state.result.optimizedPrompt.zh : state.result.optimizedPrompt.en
      if (targetPrompt) {
        setState((prev) => ({ ...prev, languageState: targetLangCode }))
        saveResult(state.result)
        console.log(`âœ… åˆ‡æ¢ä¸º${targetLangCode === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}ï¼ˆä»ç¼“å­˜ï¼‰`)
        return
      }
    }

    // éœ€è¦è°ƒç”¨APIç¿»è¯‘
    setState((prev) => ({ ...prev, isConvertingLanguage: true }))

    try {
      const currentProvider = providerStore.currentProvider
      const currentModel = providerStore.currentModel

      if (!currentProvider || !currentModel) {
        throw new Error('è¯·å…ˆåœ¨é¡¶éƒ¨é€‰æ‹©AIæä¾›å•†å’Œæ¨¡å‹')
      }

      const targetLanguage = targetLangCode === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡'
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæç¤ºè¯ç¿»è¯‘åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æç¤ºè¯ç¿»è¯‘ä¸º${targetLanguage}ï¼ŒåŒæ—¶ä¿æŒæç¤ºè¯çš„ä¸“ä¸šæ€§ã€å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

**é‡è¦è§„åˆ™**ï¼š
1. **å¿…é¡»ä¿ç•™æ‰€æœ‰åŸæœ‰çš„æ ¼å¼æ ‡è®°**ï¼ˆå¦‚ Markdown çš„ #ã€- æˆ– XML çš„æ ‡ç­¾ï¼‰
2. **ç¿»è¯‘å¿…é¡»å‡†ç¡®ä¼ è¾¾åŸæ„**ï¼Œç‰¹åˆ«æ˜¯æŠ€æœ¯æœ¯è¯­å’ŒæŒ‡ä»¤
3. **ä¿æŒæç¤ºè¯çš„ä¸“ä¸šè¯­æ°”å’Œç»“æ„**
4. **ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–è¯´æ˜**
5. **ç›´æ¥è¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½•å‰è¨€æˆ–åè®°**
6. **å¯¹äºä¸“æœ‰åè¯ã€æŠ€æœ¯æœ¯è¯­ï¼Œè¦ä½¿ç”¨è¡Œä¸šæ ‡å‡†è¯‘æ³•**`

      const messages = [
        { role: 'system' as const, content: systemPrompt },
        {
          role: 'user' as const,
          content: `è¯·å°†ä»¥ä¸‹AIæç¤ºè¯ç¿»è¯‘ä¸º${targetLanguage}ï¼š\n\n${currentPrompt}`
        }
      ]

      const response = await aiService.callAI(messages, currentProvider, currentModel.id, false)

      if (response && response.trim()) {
        const cleaned = response.trim()

        // å°†ç»“æœä¿å­˜ä¸ºå¯¹è±¡æ ¼å¼
        let updatedResult: QuickOptimizeResult
        if (typeof state.result.optimizedPrompt === 'string') {
          // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œè½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
          const oldContent = state.result.optimizedPrompt
          updatedResult = {
            ...state.result,
            optimizedPrompt: {
              zh: state.languageState === 'zh' ? oldContent : cleaned,
              en: state.languageState === 'en' ? oldContent : cleaned
            }
          }
        } else {
          // ç›´æ¥ä¿å­˜åˆ°å¯¹åº”è¯­è¨€
          updatedResult = {
            ...state.result,
            optimizedPrompt: {
              ...state.result.optimizedPrompt,
              [targetLangCode]: cleaned
            }
          }
        }

        setState((prev) => ({
          ...prev,
          result: updatedResult,
          languageState: targetLangCode,
          isConvertingLanguage: false
        }))
        saveResult(updatedResult)
        console.log(`âœ… ç¿»è¯‘ä¸º${targetLanguage}ï¼ˆå·²ç¼“å­˜ï¼‰`)
      } else {
        throw new Error('ç¿»è¯‘ç»“æœä¸ºç©º')
      }
    } catch (error: any) {
      console.error('è¯­è¨€è½¬æ¢å¤±è´¥:', error)
      setState((prev) => ({ ...prev, isConvertingLanguage: false }))
      throw error
    }
  }, [state, providerStore, aiService, saveResult])

  /**
   * å¤åˆ¶åˆ°å‰ªè´´æ¿
   */
  const copyToClipboard = useCallback(async (text: string): Promise<boolean> => {
    try {
      const { copyToClipboard: copyUtil } = await import('@/utils/clipboardUtils')
      await copyUtil(text)
      return true
    } catch (error) {
      console.error('å¤åˆ¶å¤±è´¥:', error)
      return false
    }
  }, [])

  /**
   * ä¿å­˜åˆ°æˆ‘çš„æç¤ºè¯
   */
  const saveToLibrary = useCallback(
    async (saveData: {
      title: string
      description: string
      tags: string[]
      isPublic: boolean
      systemPrompt: string
      conversationHistory: string
    }) => {
      if (!state.result) {
        throw new Error('æ²¡æœ‰å¯ä¿å­˜çš„ä¼˜åŒ–ç»“æœ')
      }

      try {
        // è·å–ä¼˜åŒ–åçš„æç¤ºè¯å†…å®¹
        const promptText =
          typeof state.result.optimizedPrompt === 'string'
            ? state.result.optimizedPrompt
            : state.result.optimizedPrompt.zh || state.result.optimizedPrompt.en

        // æ„å»ºä¸¥æ ¼æ ¼å¼çš„å¯¹è¯å†å²JSON
        let formattedConversation = ''
        if (saveData.conversationHistory.trim()) {
          try {
            const parsed = JSON.parse(saveData.conversationHistory)
            formattedConversation = JSON.stringify(parsed)
          } catch (e) {
            throw new Error('å¯¹è¯å†å²JSONæ ¼å¼é”™è¯¯')
          }
        }

        // ä»optimizeStoreè·å–loadedPromptId (å¦‚æœä»"æˆ‘çš„"é¡µé¢åŠ è½½)
        const currentPromptId = optimizeStore.loadedPromptId

        console.log('ğŸ’¾ ç”¨æˆ·æç¤ºè¯ä¿å­˜:', {
          promptId: currentPromptId,
          isUpdate: !!currentPromptId,
          title: saveData.title
        })

        // ç»Ÿä¸€è°ƒç”¨ä¿å­˜æ¥å£
        const requestBody = {
          ...(currentPromptId ? { id: currentPromptId } : {}),
          title: saveData.title,
          description: saveData.description,
          final_prompt: promptText,
          language: 'zh',
          format: 'markdown',
          prompt_type: 'user',
          tags: saveData.tags,
          is_public: saveData.isPublic ? 1 : 0,
          system_prompt: saveData.systemPrompt,
          conversation_history: formattedConversation,
          create_version: true,
          change_type: 'patch',
          change_summary: saveData.description || 'ä¼˜åŒ–ç”¨æˆ·æç¤ºè¯',
          change_log: 'é€šè¿‡ç”¨æˆ·æç¤ºè¯å¿«é€Ÿä¼˜åŒ–åŠŸèƒ½æ›´æ–°',
          version_tag: 'stable'
        }

        const result = await post('/api/prompts/', requestBody)

        if (result.code !== 200) {
          throw new Error(result.message || 'ä¿å­˜å¤±è´¥')
        }

        console.log('âœ… ä¿å­˜æˆåŠŸ:', {
          id: result.data.id,
          isNew: result.data.is_new,
          version: result.data.version,
          message: result.data.message
        })

        // å¦‚æœæ˜¯æ–°å»º,è®¾ç½®loadedPromptIdä»¥ä¾¿ä¸‹æ¬¡æ›´æ–°
        if (result.data.is_new) {
          optimizeStore.setLoadedPromptId(result.data.id)
          console.log('ğŸ†• æ–°å»ºæç¤ºè¯,è®¾ç½®loadedPromptId:', result.data.id)
        }

        return {
          success: true,
          id: result.data.id,
          version: result.data.version,
          message: result.data.message
        }
      } catch (error: any) {
        console.error('âŒ ä¿å­˜åˆ°æˆ‘çš„æç¤ºè¯å¤±è´¥:', error)
        throw error
      }
    },
    [state.result, optimizeStore]
  )

  /**
   * é‡ç½®çŠ¶æ€
   */
  const reset = useCallback(() => {
    setState({
      draftPrompt: '',
      systemPrompt: '',
      conversationHistory: '',
      result: null,
      error: null,
      isOptimizing: false,
      isAnalyzing: false,
      analysisText: '',
      isOptimizingPrompt: false,
      optimizedText: '',
      enableQualityAnalysis: true,
      languageState: 'zh',
      isConvertingLanguage: false
    })
  }, [])

  return {
    state,
    hasInput,
    hasResult,
    hasError,
    quickOptimize,
    regenerateOptimization,
    copyToClipboard,
    saveToLibrary,
    reset,
    clearResult,
    setDraftPrompt,
    setSystemPrompt,
    setConversationHistory,
    toggleLanguage,
    setEnableQualityAnalysis: (enable: boolean) => {
      setState((prev) => ({ ...prev, enableQualityAnalysis: enable }))
    }
  }
}

```


## src/main.tsx

```tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'
import './style.css'

// é¢„åŠ è½½è®¤è¯çŠ¶æ€
import { useAuthStore } from './stores/authStore'
import { useProviderStore } from './stores/providerStore'

useAuthStore.getState().initialize()
useProviderStore.getState().initialize()

// åœ¨å¼€å‘æ¨¡å¼ä¸‹ç¦ç”¨ StrictMode ä»¥é¿å…åŒæ¸²æŸ“å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
// ç”Ÿäº§ç¯å¢ƒä¸ä¼šå—åˆ°å½±å“
const rootElement = document.getElementById('root')!
const isDevelopment = import.meta.env.DEV

if (isDevelopment) {
  // å¼€å‘æ¨¡å¼ï¼šä¸ä½¿ç”¨ StrictMode ä»¥é¿å…æ€§èƒ½é—®é¢˜
  ReactDOM.createRoot(rootElement).render(
    <BrowserRouter>
      <App />
    </BrowserRouter>
  )
} else {
  // ç”Ÿäº§æ¨¡å¼ï¼šä½¿ç”¨ StrictMode è¿›è¡Œé¢å¤–æ£€æŸ¥
  ReactDOM.createRoot(rootElement).render(
    <React.StrictMode>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </React.StrictMode>
  )
}

```


## src/services/ai/errors/AIErrorHandler.ts

```ts
import { ErrorParser } from './ErrorParser'

/**
 * AIé”™è¯¯å¤„ç†å™¨
 * æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¥å£
 */
export class AIErrorHandler {
  private static errorParser = new ErrorParser()

  /**
   * è§£æAPIé”™è¯¯å¹¶è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
   */
  static parseError(error: any, apiType: string): string {
    return this.errorParser.parseAPIError(error, apiType)
  }

  /**
   * å¤„ç†ç½‘ç»œé”™è¯¯
   */
  static handleNetworkError(error: any): string {
    if (error.name === 'AbortError') {
      return 'è¯·æ±‚å·²è¢«å–æ¶ˆ'
    }
    
    if (error.name === 'TimeoutError') {
      return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
    }

    return 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºå¯é‡è¯•çš„é”™è¯¯
   */
  static isRetriableError(error: any): boolean {
    const message = error?.message?.toLowerCase() || ''
    const code = error?.error?.code || error?.code || ''

    // ç½‘ç»œç›¸å…³é”™è¯¯å¯é‡è¯•
    if (message.includes('network') || 
        message.includes('timeout') || 
        message.includes('connection')) {
      return true
    }

    // 429 é™æµé”™è¯¯å¯é‡è¯•
    if (code === '429' || message.includes('rate limit')) {
      return true
    }

    // 5xx æœåŠ¡å™¨é”™è¯¯å¯é‡è¯•
    if (code >= '500' && code < '600') {
      return true
    }

    return false
  }
}

```


## src/services/ai/errors/ErrorParser.ts

```ts
/**
 * AI APIé”™è¯¯è§£æå™¨
 */
export class ErrorParser {
  /**
   * è§£æAPIé”™è¯¯å¹¶æä¾›å‹å¥½çš„ç”¨æˆ·åé¦ˆ
   */
  parseAPIError(error: any, apiType: string): string {
    try {
      let errorMessage = ''
      let errorCode = ''

      // å°è¯•è§£æä¸åŒæ ¼å¼çš„é”™è¯¯å“åº”
      if (error.message && typeof error.message === 'string') {
        errorMessage = error.message
      } else if (error.error && error.error.message) {
        errorMessage = error.error.message
        errorCode = error.error.code || error.error.type || ''
      } else if (typeof error === 'string') {
        errorMessage = error
      } else {
        errorMessage = JSON.stringify(error)
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯MIMEç±»å‹ä¸æ”¯æŒçš„é”™è¯¯
      const mimeTypePattern = /Unsupported MIME type: ([^(]+)/i
      const mimeMatch = errorMessage.match(mimeTypePattern)

      if (mimeMatch) {
        return this.parseMimeTypeError(mimeMatch[1].trim(), apiType)
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯å…¶ä»–å¸¸è§çš„é™„ä»¶ç›¸å…³é”™è¯¯
      if (this.isAttachmentError(errorMessage)) {
        return `å½“å‰æ¨¡å‹ä¸æ”¯æŒé™„ä»¶åŠŸèƒ½ã€‚è¯·ç§»é™¤é™„ä»¶æˆ–åˆ‡æ¢åˆ°æ”¯æŒå¤šæ¨¡æ€çš„æ¨¡å‹ï¼ˆå¦‚GPT-4 Visionã€Claude 3.5+æˆ–Geminiï¼‰ã€‚`
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡å‹ä¸æ”¯æŒçš„é”™è¯¯
      if (this.isModelError(errorMessage)) {
        return `æ¨¡å‹ä¸å¯ç”¨æˆ–é…ç½®é”™è¯¯ã€‚è¯·æ£€æŸ¥æ¨¡å‹åç§°å’ŒAPIé…ç½®ã€‚`
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯APIå¯†é’¥ç›¸å…³é”™è¯¯
      if (this.isAuthError(errorMessage, errorCode)) {
        return `APIå¯†é’¥æ— æ•ˆæˆ–æœªæˆæƒã€‚è¯·æ£€æŸ¥æ‚¨çš„APIå¯†é’¥é…ç½®ã€‚`
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯é…é¢æˆ–é™åˆ¶é”™è¯¯
      if (this.isRateLimitError(errorMessage, errorCode)) {
        return `APIè°ƒç”¨é¢‘ç‡è¿‡é«˜æˆ–é…é¢å·²ç”¨å®Œã€‚è¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥æ‚¨çš„APIè´¦æˆ·çŠ¶æ€ã€‚`
      }

      // å¦‚æœæ˜¯ç½‘ç»œç›¸å…³é”™è¯¯
      if (this.isNetworkError(errorMessage)) {
        return `ç½‘ç»œè¿æ¥é”™è¯¯ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚`
      }

      // è¿”å›æ¸…ç†åçš„åŸå§‹é”™è¯¯ä¿¡æ¯
      return `APIè¯·æ±‚å¤±è´¥ï¼š${errorMessage}`

    } catch (parseError) {
      // è§£æé”™è¯¯æ—¶è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
      return `APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®åé‡è¯•ã€‚`
    }
  }

  private parseMimeTypeError(mimeType: string, apiType: string): string {
    const fileTypeHint = this.getFileTypeHint(mimeType)
    const modelSuggestion = this.getModelSuggestion(apiType)
    return `${fileTypeHint}æ ¼å¼ä¸å—å½“å‰æ¨¡å‹æ”¯æŒã€‚\n\n${modelSuggestion}ï¼Œæˆ–ç§»é™¤é™„ä»¶åé‡æ–°å‘é€ã€‚`
  }

  private getFileTypeHint(mimeType: string): string {
    if (mimeType.startsWith('application/vnd.openxmlformats-officedocument')) {
      if (mimeType.includes('wordprocessingml')) return 'Wordæ–‡æ¡£(.docx)'
      if (mimeType.includes('spreadsheetml')) return 'Excelè¡¨æ ¼(.xlsx)'
      if (mimeType.includes('presentationml')) return 'PowerPointæ¼”ç¤ºæ–‡ç¨¿(.pptx)'
      return 'Officeæ–‡æ¡£'
    }
    if (mimeType.startsWith('application/msword')) return 'Wordæ–‡æ¡£(.doc)'
    if (mimeType.startsWith('application/vnd.ms-excel')) return 'Excelè¡¨æ ¼(.xls)'
    if (mimeType.startsWith('application/vnd.ms-powerpoint')) return 'PowerPointæ¼”ç¤ºæ–‡ç¨¿(.ppt)'
    if (mimeType.startsWith('application/pdf')) return 'PDFæ–‡æ¡£'
    if (mimeType.startsWith('text/')) return 'æ–‡æœ¬æ–‡ä»¶'
    if (mimeType.startsWith('image/')) return 'å›¾ç‰‡æ–‡ä»¶'
    if (mimeType.startsWith('audio/')) return 'éŸ³é¢‘æ–‡ä»¶'
    if (mimeType.startsWith('video/')) return 'è§†é¢‘æ–‡ä»¶'
    return 'è¯¥æ–‡ä»¶'
  }

  private getModelSuggestion(apiType: string): string {
    switch (apiType) {
      case 'openai':
        return 'å½“å‰OpenAIæ¨¡å‹ä¸»è¦æ”¯æŒå›¾ç‰‡æ ¼å¼ã€‚å»ºè®®åˆ‡æ¢åˆ°æ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹çš„æ¨¡å‹ï¼ˆå¦‚Geminiï¼‰'
      case 'anthropic':
        return 'å½“å‰Claudeæ¨¡å‹æ”¯æŒå›¾ç‰‡å’ŒPDFæ–‡æ¡£æ ¼å¼ã€‚å»ºè®®åˆ‡æ¢åˆ°æ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹çš„æ¨¡å‹ï¼ˆå¦‚Geminiï¼‰ï¼Œæˆ–ä½¿ç”¨æ”¯æŒçš„æ ¼å¼'
      case 'google':
        return 'å½“å‰Geminiæ¨¡å‹ä¸æ”¯æŒæ­¤æ–‡ä»¶æ ¼å¼ã€‚å»ºè®®ä½¿ç”¨æ”¯æŒçš„æ ¼å¼ï¼ˆå›¾ç‰‡ã€PDFã€Officeæ–‡æ¡£ç­‰ï¼‰'
      default:
        return 'å½“å‰æ¨¡å‹ä¸æ”¯æŒæ­¤æ–‡ä»¶æ ¼å¼ã€‚å»ºè®®åˆ‡æ¢åˆ°æ”¯æŒå¤šæ¨¡æ€çš„æ¨¡å‹'
    }
  }

  private isAttachmentError(message: string): boolean {
    const lowerMessage = message.toLowerCase()
    return lowerMessage.includes('multimodal') ||
           lowerMessage.includes('attachment') ||
           lowerMessage.includes('file') ||
           lowerMessage.includes('image')
  }

  private isModelError(message: string): boolean {
    const lowerMessage = message.toLowerCase()
    return lowerMessage.includes('model') &&
           (lowerMessage.includes('not found') || lowerMessage.includes('invalid'))
  }

  private isAuthError(message: string, code: string): boolean {
    const lowerMessage = message.toLowerCase()
    return lowerMessage.includes('api key') ||
           lowerMessage.includes('unauthorized') ||
           lowerMessage.includes('authentication') ||
           code === '401'
  }

  private isRateLimitError(message: string, code: string): boolean {
    const lowerMessage = message.toLowerCase()
    return lowerMessage.includes('quota') ||
           lowerMessage.includes('limit') ||
           lowerMessage.includes('rate') ||
           code === '429'
  }

  private isNetworkError(message: string): boolean {
    const lowerMessage = message.toLowerCase()
    return lowerMessage.includes('network') ||
           lowerMessage.includes('timeout') ||
           lowerMessage.includes('connection')
  }
}

```


## src/services/ai/errors/index.ts

```ts
export { ErrorParser } from './ErrorParser'
export { AIErrorHandler } from './AIErrorHandler'

```


## src/services/ai/index.ts

```ts
export { BaseProvider } from './providers/BaseProvider'
export { OpenAIProvider } from './providers/OpenAIProvider'
export { AnthropicProvider } from './providers/AnthropicProvider'
export { GoogleProvider } from './providers/GoogleProvider'

export { StreamProcessor } from './streaming/StreamProcessor'
export { StreamFilter } from './streaming/StreamFilter'

export { AttachmentConverter } from './multimodal/AttachmentConverter'

export { AIErrorHandler } from './errors/AIErrorHandler'

export { ModelFetcher } from './utils/ModelFetcher'
export { ResponseCleaner } from './utils/ResponseCleaner'

export * from './types'
export type { APICallParams } from './types'

```


## src/services/ai/multimodal/AnthropicAttachmentHandler.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'
import type { MessageContent } from '../types'

/**
 * Anthropic Claude é™„ä»¶å¤„ç†å™¨
 * è´Ÿè´£å°†é™„ä»¶è½¬æ¢ä¸º Anthropic API æ ¼å¼
 */
export class AnthropicAttachmentHandler {
  /**
   * å°†é™„ä»¶è½¬æ¢ä¸º Anthropic æ ¼å¼çš„å†…å®¹
   * Claude 3.5+ æ”¯æŒå›¾ç‰‡æ ¼å¼å’ŒPDFæ–‡æ¡£ï¼ˆæœ€å¤š100é¡µï¼‰
   * @param attachments é™„ä»¶åˆ—è¡¨
   * @returns è½¬æ¢åçš„æ¶ˆæ¯å†…å®¹æ•°ç»„
   */
  static convertAttachments(attachments: MessageAttachment[]): MessageContent[] {
    return attachments
      .map(att => {
        if (att.type === 'image') {
          // Claude 3.5+æ”¯æŒå›¾ç‰‡æ ¼å¼
          return {
            type: 'image' as const,
            source: {
              type: 'base64' as const,
              media_type: att.mimeType,
              data: att.data
            }
          } as MessageContent
        } else if (att.type === 'document') {
          // Claude 3.5 SonnetåŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒPDFæ–‡æ¡£ï¼ˆæœ€å¤š100é¡µï¼‰
          const supportedDocumentTypes = [
            'application/pdf',
            'text/plain',
            'text/markdown',
            'application/json',
            'text/html',
            'text/csv'
          ]
          
          if (supportedDocumentTypes.includes(att.mimeType)) {
            // å¯¹äºæ”¯æŒçš„æ–‡æ¡£ç±»å‹ï¼Œä½¿ç”¨documentæ ¼å¼ä¼ é€’
            return {
              type: 'image' as const,  // Claude APIä½¿ç”¨ç›¸åŒçš„æ ¼å¼ç»“æ„
              source: {
                type: 'base64' as const,
                media_type: att.mimeType,
                data: att.data
              }
            } as MessageContent
          }
          
          return null
        }
        
        // Claude 3.5+ä¸»è¦æ”¯æŒå›¾ç‰‡å’ŒPDFæ–‡æ¡£ï¼Œå…¶ä»–ç±»å‹æš‚ä¸æ”¯æŒ
        return null
      })
      .filter((item): item is MessageContent => item !== null)
  }

  /**
   * æ£€æŸ¥é™„ä»¶æ˜¯å¦è¢« Anthropic æ”¯æŒ
   * @param attachment é™„ä»¶å¯¹è±¡
   * @returns æ˜¯å¦æ”¯æŒ
   */
  static isSupported(attachment: MessageAttachment): boolean {
    if (attachment.type === 'image') {
      return true
    }

    if (attachment.type === 'document') {
      const supportedDocumentTypes = [
        'application/pdf',
        'text/plain',
        'text/markdown',
        'application/json',
        'text/html',
        'text/csv'
      ]
      return supportedDocumentTypes.includes(attachment.mimeType)
    }

    return false
  }

  /**
   * è·å–æ”¯æŒçš„æ–‡ä»¶ç±»å‹åˆ—è¡¨
   * @returns æ”¯æŒçš„ MIME ç±»å‹æ•°ç»„
   */
  static getSupportedTypes(): string[] {
    return [
      // å›¾ç‰‡æ ¼å¼
      'image/png',
      'image/jpeg',
      'image/jpg',
      'image/webp',
      'image/gif',
      // æ–‡æ¡£æ ¼å¼
      'application/pdf',
      'text/plain',
      'text/markdown',
      'application/json',
      'text/html',
      'text/csv'
    ]
  }
}
```


## src/services/ai/multimodal/AttachmentConverter.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'
import type { MessageContent } from '../types'

export class AttachmentConverter {
  static convertToOpenAI(attachments: MessageAttachment[]): MessageContent[] {
    return attachments
      .map(att => {
        if (att.type === 'image') {
          const supportedImageTypes = [
            'image/png',
            'image/jpeg',
            'image/jpg',
            'image/webp',
            'image/gif'
          ]
          
          if (supportedImageTypes.includes(att.mimeType)) {
            return {
              type: 'image_url' as const,
              image_url: {
                url: `data:${att.mimeType};base64,${att.data}`
              }
            } as MessageContent
          } else {
            return null
          }
        }
        
        return null
      })
      .filter((item): item is MessageContent => item !== null)
  }

  static convertToAnthropic(attachments: MessageAttachment[]): MessageContent[] {
    return attachments
      .map(att => {
        if (att.type === 'image') {
          return {
            type: 'image' as const,
            source: {
              type: 'base64' as const,
              media_type: att.mimeType,
              data: att.data
            }
          } as MessageContent
        } else if (att.type === 'document') {
          const supportedDocumentTypes = [
            'application/pdf',
            'text/plain',
            'text/markdown',
            'application/json',
            'text/html',
            'text/csv'
          ]
          
          if (supportedDocumentTypes.includes(att.mimeType)) {
            return {
              type: 'image' as const,
              source: {
                type: 'base64' as const,
                media_type: att.mimeType,
                data: att.data
              }
            } as MessageContent
          }
          
          return null
        }
        
        return null
      })
      .filter((item): item is MessageContent => item !== null)
  }

  static convertToGemini(attachments: MessageAttachment[]): any[] {
    return attachments.map(att => {
      if (att.type === 'image') {
        return {
          inline_data: {
            mime_type: att.mimeType,
            data: att.data
          }
        }
      } else if (att.type === 'document') {
        const supportedDocumentTypes = [
          'text/plain',
          'text/html',
          'text/css',
          'text/javascript',
          'application/json',
          'text/markdown',
          'application/pdf',
          'text/csv',
          'text/xml',
          'application/xml',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          'application/vnd.openxmlformats-officedocument.presentationml.presentation',
          'application/msword',
          'application/vnd.ms-excel',
          'application/vnd.ms-powerpoint',
          'application/rtf'
        ]
        
        if (supportedDocumentTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      } else if (att.type === 'audio') {
        const supportedAudioTypes = [
          'audio/wav',
          'audio/mp3',
          'audio/mpeg',
          'audio/aac',
          'audio/ogg',
          'audio/flac'
        ]
        
        if (supportedAudioTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      } else if (att.type === 'video') {
        const supportedVideoTypes = [
          'video/mp4',
          'video/mpeg',
          'video/mov',
          'video/avi',
          'video/x-flv',
          'video/mpg',
          'video/webm',
          'video/wmv'
        ]
        
        if (supportedVideoTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      }
      
      return null
    }).filter(Boolean)
  }

  static isGeminiSupported(att: MessageAttachment): boolean {
    const supported = [
      'image/',
      'text/',
      'application/pdf',
      'application/json',
      'application/xml',
      'application/vnd.openxmlformats',
      'application/msword',
      'application/vnd.ms-',
      'audio/wav',
      'audio/mp3',
      'audio/mpeg',
      'audio/aac',
      'audio/ogg',
      'audio/flac',
      'video/mp4',
      'video/mpeg',
      'video/mov',
      'video/avi',
      'video/webm'
    ]
    
    return supported.some(prefix => att.mimeType.startsWith(prefix))
  }
}

```


## src/services/ai/multimodal/GoogleAttachmentHandler.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'

/**
 * Google Gemini é™„ä»¶å¤„ç†å™¨
 * è´Ÿè´£å°†é™„ä»¶è½¬æ¢ä¸º Gemini API æ ¼å¼
 */
export class GoogleAttachmentHandler {
  /**
   * å°†é™„ä»¶è½¬æ¢ä¸º Gemini æ ¼å¼çš„å†…å®¹
   * Gemini æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼šå›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘ã€è§†é¢‘
   * @param attachments é™„ä»¶åˆ—è¡¨
   * @returns è½¬æ¢åçš„æ¶ˆæ¯å†…å®¹æ•°ç»„
   */
  static convertAttachments(attachments: MessageAttachment[]): any[] {
    return attachments.map(att => {
      if (att.type === 'image') {
        // å›¾ç‰‡æ–‡ä»¶
        return {
          inline_data: {
            mime_type: att.mimeType,
            data: att.data
          }
        }
      } else if (att.type === 'document') {
        // æ–‡æ¡£æ–‡ä»¶ - Geminiæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼
        // æ”¯æŒçš„æ–‡æ¡£ç±»å‹åŒ…æ‹¬ï¼štext/plain, application/pdf, text/html, text/css, text/javascript, application/jsonç­‰
        const supportedDocumentTypes = [
          'text/plain',
          'text/html',
          'text/css',
          'text/javascript',
          'application/json',
          'text/markdown',
          'application/pdf',
          'text/csv',
          'text/xml',
          'application/xml',
          // Microsoft Office æ–‡æ¡£
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
          'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
          'application/msword', // .doc
          'application/vnd.ms-excel', // .xls
          'application/vnd.ms-powerpoint', // .ppt
          'application/rtf'
        ]
        
        if (supportedDocumentTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      } else if (att.type === 'audio') {
        // éŸ³é¢‘æ–‡ä»¶ - Geminiæ”¯æŒæŸäº›éŸ³é¢‘æ ¼å¼
        const supportedAudioTypes = [
          'audio/wav',
          'audio/mp3',
          'audio/mpeg',
          'audio/aac',
          'audio/ogg',
          'audio/flac'
        ]
        
        if (supportedAudioTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      } else if (att.type === 'video') {
        // è§†é¢‘æ–‡ä»¶ - Geminiæ”¯æŒæŸäº›è§†é¢‘æ ¼å¼
        const supportedVideoTypes = [
          'video/mp4',
          'video/mpeg',
          'video/mov',
          'video/avi',
          'video/x-flv',
          'video/mpg',
          'video/webm',
          'video/wmv'
        ]
        
        if (supportedVideoTypes.includes(att.mimeType)) {
          return {
            inline_data: {
              mime_type: att.mimeType,
              data: att.data
            }
          }
        } else {
          return null
        }
      }
      
      // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
      return null
    }).filter(Boolean)
  }

  /**
   * æ£€æŸ¥é™„ä»¶æ˜¯å¦è¢« Gemini æ”¯æŒ
   * @param attachment é™„ä»¶å¯¹è±¡
   * @returns æ˜¯å¦æ”¯æŒ
   */
  static isSupported(attachment: MessageAttachment): boolean {
    if (attachment.type === 'image') {
      return true
    } else if (attachment.type === 'document') {
      const supportedDocumentTypes = [
        'text/plain',
        'text/html',
        'text/css',
        'text/javascript',
        'application/json',
        'text/markdown',
        'application/pdf',
        'text/csv',
        'text/xml',
        'application/xml',
        // Microsoft Office æ–‡æ¡£
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
        'application/msword', // .doc
        'application/vnd.ms-excel', // .xls
        'application/vnd.ms-powerpoint', // .ppt
        'application/rtf'
      ]
      return supportedDocumentTypes.includes(attachment.mimeType)
    } else if (attachment.type === 'audio') {
      const supportedAudioTypes = [
        'audio/wav',
        'audio/mp3',
        'audio/mpeg',
        'audio/aac',
        'audio/ogg',
        'audio/flac'
      ]
      return supportedAudioTypes.includes(attachment.mimeType)
    } else if (attachment.type === 'video') {
      const supportedVideoTypes = [
        'video/mp4',
        'video/mpeg',
        'video/mov',
        'video/avi',
        'video/x-flv',
        'video/mpg',
        'video/webm',
        'video/wmv'
      ]
      return supportedVideoTypes.includes(attachment.mimeType)
    }
    
    return false
  }

  /**
   * è·å–æ”¯æŒçš„æ–‡ä»¶ç±»å‹åˆ—è¡¨
   * @returns æ”¯æŒçš„ MIME ç±»å‹æ•°ç»„
   */
  static getSupportedTypes(): string[] {
    return [
      // å›¾ç‰‡æ ¼å¼ - Geminiæ”¯æŒå¹¿æ³›çš„å›¾ç‰‡æ ¼å¼
      'image/png',
      'image/jpeg',
      'image/jpg',
      'image/webp',
      'image/gif',
      'image/bmp',
      'image/tiff',
      'image/svg+xml',
      'image/heic',
      // æ–‡æ¡£æ ¼å¼
      'text/plain',
      'text/html',
      'text/css',
      'text/javascript',
      'application/json',
      'text/markdown',
      'application/pdf',
      'text/csv',
      'text/xml',
      'application/xml',
      // Microsoft Office æ–‡æ¡£
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
      'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
      'application/msword', // .doc
      'application/vnd.ms-excel', // .xls
      'application/vnd.ms-powerpoint', // .ppt
      'application/rtf',
      // éŸ³é¢‘æ ¼å¼
      'audio/wav',
      'audio/mp3',
      'audio/mpeg',
      'audio/aac',
      'audio/ogg',
      'audio/flac',
      // è§†é¢‘æ ¼å¼
      'video/mp4',
      'video/mpeg',
      'video/mov',
      'video/avi',
      'video/x-flv',
      'video/mpg',
      'video/webm',
      'video/wmv'
    ]
  }
}
```


## src/services/ai/multimodal/OpenAIAttachmentHandler.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'
import type { MessageContent } from '../types'

/**
 * OpenAI é™„ä»¶å¤„ç†å™¨
 * è´Ÿè´£å°†é™„ä»¶è½¬æ¢ä¸º OpenAI API æ ¼å¼
 */
export class OpenAIAttachmentHandler {
  /**
   * å°†é™„ä»¶è½¬æ¢ä¸º OpenAI æ ¼å¼çš„å†…å®¹
   * OpenAI API æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼šPNG, JPEG, WEBP, GIF (éåŠ¨ç”»)
   * æ³¨æ„ï¼šChatGPTç½‘é¡µç‰ˆæ”¯æŒPDFã€Wordç­‰ï¼Œä½†APIä¸æ”¯æŒ
   * @param attachments é™„ä»¶åˆ—è¡¨
   * @returns è½¬æ¢åçš„æ¶ˆæ¯å†…å®¹æ•°ç»„
   */
  static convertAttachments(attachments: MessageAttachment[]): MessageContent[] {
    return attachments
      .map(att => {
        if (att.type === 'image') {
          // OpenAI API æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼šPNG, JPEG, WEBP, GIF (éåŠ¨ç”»)
          const supportedImageTypes = [
            'image/png',
            'image/jpeg',
            'image/jpg',
            'image/webp',
            'image/gif'
          ]
          
          if (supportedImageTypes.includes(att.mimeType)) {
            return {
              type: 'image_url' as const,
              image_url: {
                url: `data:${att.mimeType};base64,${att.data}`
              }
            } as MessageContent
          } else {
            return null
          }
        }
        
        // OpenAI API å½“å‰ä»…æ”¯æŒå›¾ç‰‡æ ¼å¼ï¼Œä¸æ”¯æŒæ–‡æ¡£ã€éŸ³é¢‘ã€è§†é¢‘
        // æ³¨æ„ï¼šChatGPTç½‘é¡µç‰ˆæ”¯æŒPDFã€Wordç­‰ï¼Œä½†APIä¸æ”¯æŒ
        return null
      })
      .filter((item): item is MessageContent => item !== null)
  }

  /**
   * æ£€æŸ¥é™„ä»¶æ˜¯å¦è¢« OpenAI æ”¯æŒ
   * @param attachment é™„ä»¶å¯¹è±¡
   * @returns æ˜¯å¦æ”¯æŒ
   */
  static isSupported(attachment: MessageAttachment): boolean {
    if (attachment.type !== 'image') {
      return false
    }

    const supportedImageTypes = [
      'image/png',
      'image/jpeg',
      'image/jpg',
      'image/webp',
      'image/gif'
    ]

    return supportedImageTypes.includes(attachment.mimeType)
  }

  /**
   * è·å–æ”¯æŒçš„æ–‡ä»¶ç±»å‹åˆ—è¡¨
   * @returns æ”¯æŒçš„ MIME ç±»å‹æ•°ç»„
   */
  static getSupportedTypes(): string[] {
    return [
      'image/png',
      'image/jpeg',
      'image/jpg',
      'image/webp',
      'image/gif'
    ]
  }
}
```


## src/services/ai/multimodal/index.ts

```ts
export { AttachmentConverter } from './AttachmentConverter'
export { OpenAIAttachmentHandler } from './OpenAIAttachmentHandler'
export { AnthropicAttachmentHandler } from './AnthropicAttachmentHandler'
export { GoogleAttachmentHandler } from './GoogleAttachmentHandler'
```


## src/services/ai/providers/AnthropicProvider.ts

```ts
import { BaseProvider } from './BaseProvider'
import type { ChatMessage, AIResponse, StreamChunk, MessageContent, APICallParams } from '../types'
import { AnthropicAttachmentHandler } from '../multimodal/AnthropicAttachmentHandler'
import { ResponseCleaner } from '../utils/ResponseCleaner'

/**
 * Anthropic Claude API æä¾›å•†å®ç°
 * æ”¯æŒ Claude ç³»åˆ—æ¨¡å‹å’Œå¤šæ¨¡æ€å†…å®¹
 */
export class AnthropicProvider extends BaseProvider {
  /**
   * è°ƒç”¨ Anthropic API
   * @param messages èŠå¤©æ¶ˆæ¯åˆ—è¡¨
   * @param stream æ˜¯å¦ä½¿ç”¨æµå¼å“åº”
   * @param params API è°ƒç”¨å‚æ•°
   * @returns Promise<AIResponse | ReadableStream<Uint8Array>>
   */
  async callAPI(
    messages: ChatMessage[],
    stream: boolean,
    params?: APICallParams,
    abortController?: AbortController
  ): Promise<AIResponse | ReadableStream<Uint8Array>> {
    // åˆ†ç¦»ç³»ç»Ÿæ¶ˆæ¯å’Œå¯¹è¯æ¶ˆæ¯
    const systemMessage = this.extractSystemMessageText(messages)
    const conversationMessages = messages.filter(m => m.role !== 'system')

    // æ„å»ºAnthropic API URL - æ™ºèƒ½å¤„ç†åŸºç¡€URLå’Œå®Œæ•´URL
    if (!this.config.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    let apiUrl = this.config.baseUrl.trim()
    if (!apiUrl.includes('/v1/messages')) {
      // å¦‚æœæ˜¯åŸºç¡€URLï¼Œéœ€è¦æ‹¼æ¥è·¯å¾„
      apiUrl = apiUrl.replace(/\/+$/, '') + '/v1/messages'
    }

    // ä½¿ç”¨ä¼ å…¥çš„æ¨¡å‹ID
    const modelId = this.modelId
    
    // å¯¹äºæ€è€ƒæ¨¡å‹ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´
    const isThinkingModel = modelId.includes('claude-3') || modelId.includes('thinking') || modelId.includes('sonnet')
    const timeoutMs = isThinkingModel ? 600000 : 300000 // æ€è€ƒæ¨¡å‹10åˆ†é’Ÿï¼Œæ™®é€šæ¨¡å‹5åˆ†é’Ÿ

    const response = await this.fetchWithTimeout(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': this.config.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: modelId,
        max_tokens: params?.maxTokens ?? 8192,
        temperature: params?.temperature ?? 1.0,
        top_p: params?.topP ?? 0.95,
        ...(params?.topK !== undefined && params.topK > 0 && { top_k: params.topK }),
        system: systemMessage,
        messages: conversationMessages.map(msg => ({
          role: msg.role === 'assistant' ? 'assistant' : 'user',
          content: this.hasMultimodalContent(msg) 
            ? this.convertToMultimodalContent(msg)
            : (typeof msg.content === 'string' ? msg.content : (Array.isArray(msg.content) ? msg.content[0]?.text || '' : String(msg.content)))
        })),
        ...(stream && { stream: true })
      })
    }, timeoutMs, abortController)

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      const error = new Error(`Anthropic API error: ${response.status} ${response.statusText}`)
      ;(error as any).error = errorData
      ;(error as any).status = response.status
      throw error
    }

    if (stream) {
      return response.body as ReadableStream<Uint8Array>
    } else {
      const data = await response.json()
      const result = data.content[0]?.text
      
      if (!result || result.trim() === '') {
        throw new Error('APIè¿”å›ç©ºå†…å®¹')
      }
      
      // æ¸…ç†thinkæ ‡ç­¾å†…å®¹
      const cleanedResult = ResponseCleaner.cleanThinkTags(result)
      
      return {
        content: cleanedResult,
        finishReason: data.stop_reason
      }
    }
  }

  /**
   * è§£æ Anthropic æµå¼å“åº”å—
   * @param data SSE æ•°æ®å­—ç¬¦ä¸²
   * @returns è§£æåçš„æµå¼å—æˆ– null
   */
  parseStreamChunk(data: string): StreamChunk | null {
    if (!data.trim()) {
      return null
    }

    try {
      const parsed = JSON.parse(data)
      
      if (parsed.type === 'content_block_delta') {
        const content = parsed.delta?.text
        if (content) {
          return {
            content,
            done: false
          }
        }
      } else if (parsed.type === 'message_stop') {
        return {
          content: '',
          done: true
        }
      }
      
      return null
    } catch (e) {
      // JSONè§£æé”™è¯¯ï¼Œè¿”å›null
      return null
    }
  }

  /**
   * æå–ç³»ç»Ÿæ¶ˆæ¯æ–‡æœ¬çš„è¾…åŠ©æ–¹æ³•
   * @param messages æ¶ˆæ¯åˆ—è¡¨
   * @returns ç³»ç»Ÿæ¶ˆæ¯æ–‡æœ¬
   */
  private extractSystemMessageText(messages: ChatMessage[]): string {
    const systemMsg = messages.find(m => m.role === 'system')
    if (!systemMsg) return ''
    if (typeof systemMsg.content === 'string') return systemMsg.content
    if (Array.isArray(systemMsg.content)) {
      // å¦‚æœæ˜¯MessageContent[]ï¼Œæå–æ‰€æœ‰æ–‡æœ¬å†…å®¹
      return systemMsg.content.map(c => c.text || '').join(' ')
    }
    return ''
  }

  /**
   * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å¤šæ¨¡æ€å†…å®¹
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns æ˜¯å¦åŒ…å«é™„ä»¶
   */
  private hasMultimodalContent(message: ChatMessage): boolean {
    return !!(message.attachments && message.attachments.length > 0)
  }

  /**
   * å°†æ¶ˆæ¯è½¬æ¢ä¸ºå¤šæ¨¡æ€å†…å®¹æ ¼å¼
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns å¤šæ¨¡æ€å†…å®¹æ•°ç»„
   */
  private convertToMultimodalContent(message: ChatMessage): MessageContent[] {
    const content: MessageContent[] = []
    
    // æ·»åŠ æ–‡æœ¬å†…å®¹
    if (typeof message.content === 'string' && message.content.trim()) {
      content.push({ type: 'text', text: message.content })
    }
    
    // æ·»åŠ é™„ä»¶å†…å®¹
    if (message.attachments && message.attachments.length > 0) {
      const anthropicAttachments = AnthropicAttachmentHandler.convertAttachments(message.attachments)
      content.push(...anthropicAttachments)
    }
    
    return content
  }
}

```


## src/services/ai/providers/BaseProvider.ts

```ts
import type { ChatMessage, AIResponse, ProviderConfig, StreamChunk, APICallParams } from '../types'

/**
 * AI æä¾›å•†åŸºç¡€æŠ½è±¡ç±»
 * å®šä¹‰æ‰€æœ‰ AI æä¾›å•†å¿…é¡»å®ç°çš„æ ¸å¿ƒæ¥å£
 */
export abstract class BaseProvider {
  protected config: ProviderConfig
  protected modelId: string

  constructor(config: ProviderConfig, modelId: string) {
    this.config = config
    this.modelId = modelId
  }

  /**
   * è°ƒç”¨ AI API
   * @param messages èŠå¤©æ¶ˆæ¯åˆ—è¡¨
   * @param stream æ˜¯å¦ä½¿ç”¨æµå¼å“åº”
   * @param params API è°ƒç”¨å‚æ•°ï¼ˆtemperature, maxTokens ç­‰ï¼‰
   * @returns Promise<AIResponse | ReadableStream<Uint8Array>>
   */
  abstract callAPI(
    messages: ChatMessage[],
    stream: boolean,
    params?: APICallParams,
    abortController?: AbortController
  ): Promise<AIResponse | ReadableStream<Uint8Array>>

  /**
   * è§£ææµå¼å“åº”å—
   * @param data SSE æ•°æ®å­—ç¬¦ä¸²
   * @returns è§£æåçš„æµå¼å—æˆ– null
   */
  abstract parseStreamChunk(data: string): StreamChunk | null

  /**
   * åˆ›å»ºå¸¦è¶…æ—¶çš„ fetch è¯·æ±‚
   * @param url è¯·æ±‚ URL
   * @param options è¯·æ±‚é€‰é¡¹
   * @param timeoutMs è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   * @returns Promise<Response>
   */
  protected async fetchWithTimeout(
    url: string,
    options: RequestInit,
    timeoutMs: number = 300000,
    abortController?: AbortController
  ): Promise<Response> {
    const controller = abortController ?? new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs)

    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      })
      return response
    } finally {
      clearTimeout(timeoutId)
    }
  }
}

```


## src/services/ai/providers/GoogleProvider.ts

```ts
import { BaseProvider } from './BaseProvider'
import type { ChatMessage, AIResponse, StreamChunk, APICallParams } from '../types'
import { GoogleAttachmentHandler } from '../multimodal/GoogleAttachmentHandler'
import { ResponseCleaner } from '../utils/ResponseCleaner'

/**
 * Google Gemini API æä¾›å•†å®ç°
 * æ”¯æŒ Gemini ç³»åˆ—æ¨¡å‹å’Œå¤šæ¨¡æ€å†…å®¹
 */
export class GoogleProvider extends BaseProvider {
  /**
   * è°ƒç”¨ Google Gemini API
   * @param messages èŠå¤©æ¶ˆæ¯åˆ—è¡¨
   * @param stream æ˜¯å¦ä½¿ç”¨æµå¼å“åº”
   * @param params API è°ƒç”¨å‚æ•°
   * @returns Promise<AIResponse | ReadableStream<Uint8Array>>
   */
  async callAPI(
    messages: ChatMessage[],
    stream: boolean,
    params?: APICallParams,
    abortController?: AbortController
  ): Promise<AIResponse | ReadableStream<Uint8Array>> {
    
    // Google Gemini APIæ ¼å¼è½¬æ¢
    const systemMessage = this.extractSystemMessageText(messages)
    
    const conversationMessages = messages.filter(m => m.role !== 'system')

    const contents = conversationMessages.map(msg => {
      const role = msg.role === 'assistant' ? 'model' : 'user'
      
      if (this.hasMultimodalContent(msg)) {
        const parts = this.convertToMultimodalContent(msg)
        return { role, parts }
      } else {
        const text = typeof msg.content === 'string' ? msg.content : msg.content[0]?.text || ''
        return { role, parts: [{ text }] }
      }
    })

    const requestBody: any = {
      contents,
      generationConfig: {
        temperature: params?.temperature ?? 1.0,
        maxOutputTokens: params?.maxTokens ?? 8192,
        topP: params?.topP ?? 0.95,
        ...(params?.topK !== undefined && params.topK > 0 && { topK: params.topK })
      }
    }

    // ä½¿ç”¨æ­£ç¡®çš„system_instructionå­—æ®µï¼ˆé¡¶çº§ï¼‰
    if (systemMessage) {
      requestBody.system_instruction = {
        parts: [
          {
            text: systemMessage
          }
        ]
      }
    } else {
    }
    


    // æ„å»ºGoogle Gemini API URL
    if (!this.config.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    let apiUrl = this.config.baseUrl.trim()
    // ç¡®ä¿ä»¥/v1betaç»“å°¾ï¼Œç„¶åæ‹¼æ¥æ¨¡å‹è·¯å¾„
    if (!apiUrl.endsWith('/v1beta')) {
      // å¦‚æœæ˜¯å®Œæ•´çš„generateContent URLï¼Œæå–baseURLéƒ¨åˆ†
      if (apiUrl.includes('/models/')) {
        apiUrl = apiUrl.split('/models/')[0]
      }
      // ç¡®ä¿ä»¥/v1betaç»“å°¾
      if (!apiUrl.endsWith('/v1beta')) {
        apiUrl = apiUrl.replace(/\/+$/, '') + '/v1beta'
      }
    }
    
    // ä½¿ç”¨ä¼ å…¥çš„æ¨¡å‹ID
    const modelId = this.modelId
    
    // æ‹¼æ¥æ¨¡å‹ç‰¹å®šè·¯å¾„
    if (stream) {
      apiUrl = `${apiUrl}/models/${modelId}:streamGenerateContent`
      // æ·»åŠ SSEå‚æ•°ï¼ˆæ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼‰
      const url = new URL(apiUrl)
      url.searchParams.set('alt', 'sse')
      apiUrl = url.toString()
    } else {
      apiUrl = `${apiUrl}/models/${modelId}:generateContent`
    }
    
    // å¯¹äºGoogleæ¨¡å‹ä½¿ç”¨è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
    const timeoutMs = 300000 // 5åˆ†é’Ÿ
    
    const response = await this.fetchWithTimeout(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-goog-api-key': this.config.apiKey  // ä½¿ç”¨å®˜æ–¹æ–‡æ¡£æ¨èçš„header
      },
      body: JSON.stringify(requestBody)
    }, timeoutMs, abortController)

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      const error = new Error(`Google Gemini API error: ${response.status} ${response.statusText}`)
      ;(error as any).error = errorData
      ;(error as any).status = response.status
      throw error
    }

    if (stream) {
      return response.body as ReadableStream<Uint8Array>
    } else {
      const data = await response.json()
      
      // åœ¨partsæ•°ç»„ä¸­æ‰¾åˆ°éæ€è€ƒå†…å®¹çš„æ–‡æœ¬
      const candidate = data.candidates?.[0]
      if (!candidate?.content?.parts) {
        throw new Error('APIè¿”å›æ•°æ®ç»“æ„å¼‚å¸¸')
      }
      
      // æŸ¥æ‰¾å®é™…çš„å›ç­”æ–‡æœ¬ï¼ˆæ’é™¤thoughtå†…å®¹ï¼‰
      let result = ''
      for (const part of candidate.content.parts) {
        if (part.text && !part.thought) {
          result = part.text
          break
        }
      }
      
      if (!result || result.trim() === '') {
        throw new Error('APIè¿”å›ç©ºå†…å®¹')
      }
      
      // æ¸…ç†thinkæ ‡ç­¾å†…å®¹
      const cleanedResult = ResponseCleaner.cleanThinkTags(result)
      
      return {
        content: cleanedResult,
        finishReason: candidate.finishReason
      }
    }
  }

  /**
   * è§£æ Google Gemini æµå¼å“åº”å—
   * @param data SSE æ•°æ®å­—ç¬¦ä¸²
   * @returns è§£æåçš„æµå¼å—æˆ– null
   */
  parseStreamChunk(data: string): StreamChunk | null {
    try {
      const parsed = JSON.parse(data)
      const candidate = parsed.candidates?.[0]
      if (candidate?.content?.parts) {
        for (const part of candidate.content.parts) {
          if (part.text && !part.thought) {
            return {
              content: part.text,
              done: false
            }
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦ç»“æŸ
      if (candidate?.finishReason) {
        return {
          content: '',
          done: true
        }
      }
      
      return null
    } catch (parseError) {
      // JSONè§£æé”™è¯¯ï¼Œè¿”å›null
      return null
    }
  }

  /**
   * æå–ç³»ç»Ÿæ¶ˆæ¯æ–‡æœ¬çš„è¾…åŠ©æ–¹æ³•
   * @param messages æ¶ˆæ¯åˆ—è¡¨
   * @returns ç³»ç»Ÿæ¶ˆæ¯æ–‡æœ¬
   */
  private extractSystemMessageText(messages: ChatMessage[]): string {
    const systemMsg = messages.find(m => m.role === 'system')
    if (!systemMsg) return ''
    if (typeof systemMsg.content === 'string') return systemMsg.content
    if (Array.isArray(systemMsg.content)) {
      return systemMsg.content.map(c => c.text || '').join(' ')
    }
    return ''
  }

  /**
   * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å¤šæ¨¡æ€å†…å®¹
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns æ˜¯å¦åŒ…å«é™„ä»¶
   */
  private hasMultimodalContent(message: ChatMessage): boolean {
    return !!(message.attachments && message.attachments.length > 0)
  }

  /**
   * å°†æ¶ˆæ¯è½¬æ¢ä¸ºå¤šæ¨¡æ€å†…å®¹æ ¼å¼
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns å¤šæ¨¡æ€å†…å®¹æ•°ç»„
   */
  private convertToMultimodalContent(message: ChatMessage): any[] {
    const parts: any[] = []
    
    // æ·»åŠ æ–‡æœ¬å†…å®¹
    if (typeof message.content === 'string' && message.content.trim()) {
      parts.push({ text: message.content })
    }
    
    // æ·»åŠ é™„ä»¶å†…å®¹
    if (message.attachments && message.attachments.length > 0) {
      const geminiAttachments = GoogleAttachmentHandler.convertAttachments(message.attachments)
      parts.push(...geminiAttachments)
      
      // å¯¹äºGeminiï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«è¿‡æ»¤çš„é™„ä»¶
      const originalCount = message.attachments.length
      const processedCount = geminiAttachments.length
      if (processedCount < originalCount) {
        // æœ‰é™„ä»¶è¢«è¿‡æ»¤ï¼Œæ·»åŠ æè¿°æ–‡æœ¬
        const unsupportedAttachments = message.attachments.filter((att) => {
          // é‡æ–°è¿è¡Œè½¬æ¢æ£€æŸ¥å“ªäº›è¢«è¿‡æ»¤äº†
          return !GoogleAttachmentHandler.isSupported(att)
        })
        
        if (unsupportedAttachments.length > 0) {
          const attachmentDescriptions = unsupportedAttachments.map(att => 
            `${att.name} (${att.type}, ${(att.size / 1024).toFixed(1)}KB)`
          ).join(', ')
          
          const attachmentInfoText = `[ç”¨æˆ·ä¸Šä¼ äº†ä»¥ä¸‹é™„ä»¶ï¼Œä½†å½“å‰æ— æ³•ç›´æ¥å¤„ç†: ${attachmentDescriptions}ã€‚ç”¨æˆ·è¯¢é—®å…³äºè¿™äº›é™„ä»¶çš„é—®é¢˜ã€‚]`
          
          parts.push({ text: attachmentInfoText })
        }
      }
    }
    
    return parts
  }
}

```


## src/services/ai/providers/OpenAIProvider.ts

```ts
import { BaseProvider } from './BaseProvider'
import type { ChatMessage, AIResponse, StreamChunk, MessageContent, APICallParams } from '../types'
import { OpenAIAttachmentHandler } from '../multimodal/OpenAIAttachmentHandler'
import { ResponseCleaner } from '../utils/ResponseCleaner'

/**
 * OpenAI API æä¾›å•†å®ç°
 * æ”¯æŒ GPT ç³»åˆ—æ¨¡å‹å’Œå¤šæ¨¡æ€å†…å®¹
 */
export class OpenAIProvider extends BaseProvider {
  /**
   * è°ƒç”¨ OpenAI API
   * @param messages èŠå¤©æ¶ˆæ¯åˆ—è¡¨
   * @param stream æ˜¯å¦ä½¿ç”¨æµå¼å“åº”
   * @param params API è°ƒç”¨å‚æ•°
   * @returns Promise<AIResponse | ReadableStream<Uint8Array>>
   */
  async callAPI(
    messages: ChatMessage[],
    stream: boolean,
    params?: APICallParams,
    abortController?: AbortController
  ): Promise<AIResponse | ReadableStream<Uint8Array>> {
    // æ„å»ºOpenAI API URL - æ™ºèƒ½å¤„ç†åŸºç¡€URLå’Œå®Œæ•´URL
    if (!this.config.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    let apiUrl = this.config.baseUrl.trim()
    
    if (apiUrl.includes('/chat/completions')) {
      // å·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨
    } else if (apiUrl.includes('/v1')) {
      // åŒ…å«v1ä½†æ²¡æœ‰chat/completionsï¼Œæ‹¼æ¥chat/completions
      apiUrl = apiUrl.replace(/\/+$/, '') + '/chat/completions'
    } else {
      // åŸºç¡€URLï¼Œéœ€è¦æ‹¼æ¥å®Œæ•´è·¯å¾„
      apiUrl = apiUrl.replace(/\/+$/, '') + '/v1/chat/completions'
    }
    
    // ä½¿ç”¨ä¼ å…¥çš„æ¨¡å‹ID
    const modelId = this.modelId
    
    // å¯¹äºæ€è€ƒæ¨¡å‹ï¼ˆå¦‚gpt-5-highï¼‰ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´
    const isThinkingModel = modelId.includes('gpt-5') || modelId.includes('o1') || modelId.includes('thinking')
    const timeoutMs = isThinkingModel ? 600000 : 300000 // æ€è€ƒæ¨¡å‹10åˆ†é’Ÿï¼Œæ™®é€šæ¨¡å‹5åˆ†é’Ÿ
    
    const response = await this.fetchWithTimeout(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.config.apiKey}`
      },
      body: JSON.stringify({
        model: modelId,
        messages: messages.map(msg => {
          // æ£€æŸ¥æ˜¯å¦æœ‰å¤šæ¨¡æ€å†…å®¹
          if (this.hasMultimodalContent(msg)) {
            const multimodalContent = this.convertToMultimodalContent(msg)
            return {
              role: msg.role,
              content: multimodalContent
            }
          } else {
            return {
              role: msg.role,
              content: typeof msg.content === 'string' ? msg.content : msg.content[0]?.text || ''
            }
          }
        }),
        temperature: params?.temperature ?? 1.0,
        max_tokens: params?.maxTokens ?? 8192,
        top_p: params?.topP ?? 0.95,
        ...(params?.frequencyPenalty !== undefined && { frequency_penalty: params.frequencyPenalty }),
        ...(params?.presencePenalty !== undefined && { presence_penalty: params.presencePenalty }),
        ...(stream && { stream: true })
      })
      }, timeoutMs, abortController)

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      const error = new Error(`OpenAI API error: ${response.status} ${response.statusText}`)
      ;(error as any).error = errorData
      ;(error as any).status = response.status
      throw error
    }

    if (stream) {
      return response.body as ReadableStream<Uint8Array>
    } else {
      const data = await response.json()
      
      // æ”¯æŒå¤šç§APIå“åº”æ ¼å¼çš„å†…å®¹æå–
      let result: string | undefined
      
      if (data.choices && data.choices[0]?.message?.content) {
        // OpenAI æ ¼å¼: {choices: [{message: {content: "text"}}]}
        result = data.choices[0].message.content
      } else if (data.candidates && data.candidates[0]?.content?.parts) {
        // Gemini æ ¼å¼: {candidates: [{content: {parts: [{text: "text"}]}}]}
        const parts = data.candidates[0].content.parts
        // æŸ¥æ‰¾åŒ…å«textçš„éƒ¨åˆ†ï¼ˆè¿‡æ»¤æ‰thoughtç­‰ï¼‰
        for (const part of parts) {
          if (part.text && !part.thought) {
            result = part.text
            break
          }
        }
      } else if (data.content && typeof data.content === 'string') {
        // ç›´æ¥è¿”å›å†…å®¹æ ¼å¼
        result = data.content
      } else if (data.text && typeof data.text === 'string') {
        // ç®€å•æ–‡æœ¬æ ¼å¼
        result = data.text
      }
      
      if (!result || result.trim() === '') {
        throw new Error('APIè¿”å›ç©ºå†…å®¹æˆ–æ— æ³•è§£æå“åº”æ ¼å¼')
      }
      
      // æ¸…ç†å“åº”å†…å®¹
      result = ResponseCleaner.cleanResponse(result)
      result = ResponseCleaner.cleanThinkTags(result)
      
      return {
        content: result,
        finishReason: data.choices?.[0]?.finish_reason
      }
    }
  }

  /**
   * è§£æ OpenAI æµå¼å“åº”å—
   * @param data SSE æ•°æ®å­—ç¬¦ä¸²
   * @returns è§£æåçš„æµå¼å—æˆ– null
   */
  parseStreamChunk(data: string): StreamChunk | null {
    if (!data.trim() || data.trim() === '[DONE]') {
      return { content: '', done: true }
    }
    
    // ä¸“é—¨è¿‡æ»¤OPENROUTERçš„å¤„ç†çŠ¶æ€ä¿¡æ¯
    if (data === ': OPENROUTER PROCESSING') {
      return null
    }
    
    // è¿‡æ»¤å…¶ä»–æ˜æ˜¾çš„çŠ¶æ€ä¿¡æ¯ï¼ˆæ›´ä¿å®ˆçš„æ–¹æ³•ï¼‰
    if (data.startsWith(': ') && data.toUpperCase().includes('PROCESSING')) {
      return null
    }
    
    try {
      const parsed = JSON.parse(data)
      let content: string | undefined
      
      // æ”¯æŒå¤šç§æµå¼å“åº”æ ¼å¼
      if (parsed.choices?.[0]?.delta?.content) {
        // OpenAI æµå¼æ ¼å¼
        content = parsed.choices[0].delta.content
      } else if (parsed.candidates?.[0]?.content?.parts) {
        // Gemini SSE æµå¼æ ¼å¼
        const parts = parsed.candidates[0].content.parts
        for (const part of parts) {
          if (part.text && !part.thought) {
            content = part.text
            break
          }
        }
      } else if (parsed.delta?.text) {
        // ç®€åŒ–æµå¼æ ¼å¼
        content = parsed.delta.text
      } else if (parsed.text) {
        // ç›´æ¥æ–‡æœ¬æ ¼å¼
        content = parsed.text
      }
      
      const finishReason = parsed.choices?.[0]?.finish_reason
      const done = !!(finishReason || parsed.done)
      
      return {
        content: content || '',
        done
      }
    } catch (e) {
      // JSONè§£æé”™è¯¯ï¼Œè¿”å›null
      return null
    }
  }

  /**
   * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å¤šæ¨¡æ€å†…å®¹
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns æ˜¯å¦åŒ…å«é™„ä»¶
   */
  private hasMultimodalContent(message: ChatMessage): boolean {
    return !!(message.attachments && message.attachments.length > 0)
  }

  /**
   * å°†æ¶ˆæ¯è½¬æ¢ä¸ºå¤šæ¨¡æ€å†…å®¹æ ¼å¼
   * @param message èŠå¤©æ¶ˆæ¯
   * @returns å¤šæ¨¡æ€å†…å®¹æ•°ç»„
   */
  private convertToMultimodalContent(message: ChatMessage): MessageContent[] {
    const content: MessageContent[] = []
    
    // æ·»åŠ æ–‡æœ¬å†…å®¹
    if (typeof message.content === 'string' && message.content.trim()) {
      content.push({ type: 'text', text: message.content })
    }
    
    // æ·»åŠ é™„ä»¶å†…å®¹
    if (message.attachments && message.attachments.length > 0) {
      const openaiAttachments = OpenAIAttachmentHandler.convertAttachments(message.attachments)
      content.push(...openaiAttachments)
    }
    
    return content
  }
}

```


## src/services/ai/providers/index.ts

```ts
export { BaseProvider } from './BaseProvider'
export { OpenAIProvider } from './OpenAIProvider'
export { AnthropicProvider } from './AnthropicProvider'
export { GoogleProvider } from './GoogleProvider'
```


## src/services/ai/streaming/SSEParser.ts

```ts
/**
 * Server-Sent Events (SSE) è§£æå™¨
 */
export class SSEParser {
  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆçš„SSEæ•°æ®è¡Œ
   */
  isValidSSELine(line: string): boolean {
    if (!line || typeof line !== 'string') {
      return false
    }

    const trimmedLine = line.trim()

    // å¿…é¡»ä»¥ "data: " å¼€å¤´
    if (!trimmedLine.startsWith('data: ')) {
      return false
    }

    // è·å–æ•°æ®éƒ¨åˆ†
    const data = trimmedLine.slice(6).trim()

    // ç©ºæ•°æ®æˆ–[DONE]éƒ½æ˜¯æœ‰æ•ˆçš„
    if (!data || data === '[DONE]') {
      return true
    }

    // ä¸“é—¨è¿‡æ»¤OPENROUTERçš„å¤„ç†çŠ¶æ€ä¿¡æ¯
    if (data === ': OPENROUTER PROCESSING') {
      return false
    }

    // è¿‡æ»¤å…¶ä»–æ˜æ˜¾çš„çŠ¶æ€ä¿¡æ¯
    if (data.startsWith(': ') && data.toUpperCase().includes('PROCESSING')) {
      return false
    }

    return true
  }

  /**
   * è§£æSSEè¡Œï¼Œæå–dataéƒ¨åˆ†
   */
  parseDataFromLine(line: string): string | null {
    if (!this.isValidSSELine(line)) {
      return null
    }

    const data = line.slice(6).trim()
    if (!data || data === '[DONE]') {
      return null
    }

    return data
  }
}

```


## src/services/ai/streaming/StreamFilter.ts

```ts
/**
 * æµå¼å†…å®¹è¿‡æ»¤å™¨
 * ç”¨äºè¿‡æ»¤AIå“åº”ä¸­çš„ç‰¹æ®Šæ ‡ç­¾ï¼ˆå¦‚<think>æ ‡ç­¾ï¼‰
 */
export class StreamFilter {
  private buffer: string = ''
  private inThinkTag: boolean = false
  private thinkTagContent: string = ''

  /**
   * é‡ç½®è¿‡æ»¤å™¨çŠ¶æ€
   */
  reset(): void {
    this.buffer = ''
    this.inThinkTag = false
    this.thinkTagContent = ''
  }

  /**
   * å¤„ç†æµå¼æ–‡æœ¬å—ï¼Œè¿‡æ»¤<think>æ ‡ç­¾
   */
  filterChunk(chunk: string): string {
    this.buffer += chunk
    let output = ''

    while (this.buffer.length > 0) {
      if (!this.inThinkTag) {
        const thinkStart = this.buffer.indexOf('<think>')
        
        if (thinkStart === -1) {
          // ä¿ç•™æœ€å7ä¸ªå­—ç¬¦ä»¥é˜²æ­¢æ ‡ç­¾è¢«åˆ†å‰²
          if (this.buffer.length > 7) {
            output += this.buffer.slice(0, -7)
            this.buffer = this.buffer.slice(-7)
          }
          break
        } else {
          // æ‰¾åˆ°<think>æ ‡ç­¾å¼€å§‹
          output += this.buffer.slice(0, thinkStart)
          this.buffer = this.buffer.slice(thinkStart + 7)
          this.inThinkTag = true
          this.thinkTagContent = ''
        }
      } else {
        // åœ¨thinkæ ‡ç­¾å†…
        const thinkEnd = this.buffer.indexOf('</think>')
        
        if (thinkEnd === -1) {
          // è¿˜æ²¡æ‰¾åˆ°ç»“æŸæ ‡ç­¾ï¼Œä¿ç•™æœ€å8ä¸ªå­—ç¬¦
          if (this.buffer.length > 8) {
            this.thinkTagContent += this.buffer.slice(0, -8)
            this.buffer = this.buffer.slice(-8)
          }
          break
        } else {
          // æ‰¾åˆ°</think>æ ‡ç­¾ç»“æŸ
          this.thinkTagContent += this.buffer.slice(0, thinkEnd)
          this.buffer = this.buffer.slice(thinkEnd + 8)
          this.inThinkTag = false
          this.thinkTagContent = ''
        }
      }
    }

    return output
  }

  /**
   * å®Œæˆè¿‡æ»¤ï¼Œè¿”å›ç¼“å†²åŒºå‰©ä½™å†…å®¹
   */
  finalize(): string {
    const remaining = this.buffer
    this.reset()
    return remaining
  }

  /**
   * ä»å®Œæ•´æ–‡æœ¬ä¸­ç§»é™¤<think>æ ‡ç­¾ï¼ˆç”¨äºéæµå¼å“åº”ï¼‰
   */
  static removeThinkTags(text: string): string {
    return text.replace(/<think>[\s\S]*?<\/think>/g, '')
  }
}

```


## src/services/ai/streaming/StreamProcessor.ts

```ts
import { SSEParser } from './SSEParser'
import { StreamFilter } from './StreamFilter'
import type { StreamChunk } from '../types'

/**
 * æµå¼å“åº”å¤„ç†å™¨
 * è´Ÿè´£åè°ƒSSEè§£æå’Œå†…å®¹è¿‡æ»¤
 */
export class StreamProcessor {
  private sseParser: SSEParser
  private streamFilter: StreamFilter

  constructor() {
    this.sseParser = new SSEParser()
    this.streamFilter = new StreamFilter()
  }

  /**
   * é‡ç½®å¤„ç†å™¨çŠ¶æ€
   */
  reset(): void {
    this.streamFilter.reset()
  }

  /**
   * å¤„ç†æµå¼å“åº”ï¼Œè¿”å›ä¸€ä¸ªå¼‚æ­¥è¿­ä»£å™¨
   */
  async* processStream(
    stream: ReadableStream<Uint8Array>,
    parseChunk: (data: string) => StreamChunk | null
  ): AsyncGenerator<string> {
    const reader = stream.getReader()
    const decoder = new TextDecoder()
    
    try {
      while (true) {
        const { done, value } = await reader.read()
        
        if (done) {
          // æµç»“æŸï¼Œè¾“å‡ºç¼“å†²åŒºå‰©ä½™å†…å®¹
          const remaining = this.streamFilter.finalize()
          if (remaining) {
            yield remaining
          }
          break
        }

        const chunk = decoder.decode(value, { stream: true })
        const lines = chunk.split('\n')

        for (const line of lines) {
          // è§£æSSEæ•°æ®
          const data = this.sseParser.parseDataFromLine(line)
          if (!data) continue

          // ä½¿ç”¨providerç‰¹å®šçš„è§£æå™¨è§£æchunk
          const parsed = parseChunk(data)
          if (!parsed || !parsed.content) continue

          // è¿‡æ»¤thinkæ ‡ç­¾å¹¶è¾“å‡º
          const filtered = this.streamFilter.filterChunk(parsed.content)
          if (filtered) {
            yield filtered
          }

          // å¦‚æœæµç»“æŸï¼Œè¾“å‡ºå‰©ä½™ç¼“å†²å†…å®¹
          if (parsed.done) {
            const remaining = this.streamFilter.finalize()
            if (remaining) {
              yield remaining
            }
            return
          }
        }
      }
    } finally {
      reader.releaseLock()
    }
  }
}

```


## src/services/ai/streaming/index.ts

```ts
export { SSEParser } from './SSEParser'
export { StreamFilter } from './StreamFilter'
export { StreamProcessor } from './StreamProcessor'

```


## src/services/ai/types.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'

export interface MessageContent {
  type: 'text' | 'image_url' | 'image' | 'document' | 'audio' | 'video'
  text?: string
  source?: {
    type: string
    media_type: string
    data: string
  }
  inline_data?: {
    mime_type: string
    data: string
  }
  image_url?: {
    url: string
  }
}

export interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string | MessageContent[]
  attachments?: MessageAttachment[]
}

export interface AIResponse {
  content: string
  finishReason?: string
}

// Re-export ProviderConfig from providerStore for consistency
export type { ProviderConfig } from '@/stores/providerStore'

export interface StreamChunk {
  content: string
  done: boolean
}

export interface AIProviderOptions {
  apiKey: string
  baseUrl?: string
  model: string
  temperature?: number
  maxTokens?: number
  timeout?: number
}

// API è°ƒç”¨å‚æ•°ï¼ˆä» ModelParams ä¼ å…¥ï¼‰
export interface APICallParams {
  temperature?: number
  maxTokens?: number
  topP?: number
  frequencyPenalty?: number
  presencePenalty?: number
  topK?: number
}

```


## src/services/ai/utils/ModelFetcher.ts

```ts
import type { ProviderConfig } from '@/stores/providerStore'

export class ModelFetcher {
  private static async fetchWithTimeout(url: string, options: RequestInit, timeoutMs: number = 30000): Promise<Response> {
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs)
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      })
      return response
    } finally {
      clearTimeout(timeoutId)
    }
  }

  static async getModels(provider: ProviderConfig, apiType?: 'openai' | 'anthropic' | 'google'): Promise<string[]> {
    const type = apiType || provider.type
    
    switch (type) {
      case 'openai':
        return await this.getOpenAIModels(provider)
      case 'anthropic':
        return await this.getAnthropicModels()
      case 'google':
        return await this.getGeminiModels(provider)
      case 'custom':
        return await this.getCustomProviderModels(provider, apiType)
      default:
        return await this.getOpenAIModels(provider)
    }
  }

  private static async getOpenAIModels(provider: ProviderConfig): Promise<string[]> {
    if (!provider.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    
    const apiUrl = this.buildOpenAIModelsUrl(provider.baseUrl)
    
    const response = await this.fetchWithTimeout(apiUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${provider.apiKey}`,
        'Content-Type': 'application/json'
      }
    })

    if (!response.ok) {
      throw new Error(`OpenAI Models API error: ${response.status} ${response.statusText}`)
    }

    const data = await response.json()
    
    if (data.data && Array.isArray(data.data)) {
      return data.data
        .map((model: any) => model.id)
        .filter((id: string) => id && typeof id === 'string')
        .sort()
    }
    
    throw new Error('OpenAI APIè¿”å›çš„æ¨¡å‹åˆ—è¡¨æ ¼å¼ä¸æ­£ç¡®')
  }

  private static async getGeminiModels(provider: ProviderConfig): Promise<string[]> {
    if (!provider.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    
    const apiUrl = this.buildGeminiModelsUrl(provider.baseUrl)
    const url = new URL(apiUrl)
    url.searchParams.set('key', provider.apiKey)
    
    const response = await this.fetchWithTimeout(url.toString(), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    })

    if (!response.ok) {
      throw new Error(`Gemini Models API error: ${response.status} ${response.statusText}`)
    }

    const data = await response.json()
    
    if (data.models && Array.isArray(data.models)) {
      return data.models
        .map((model: any) => {
          if (model.name && typeof model.name === 'string') {
            return model.name.replace(/^models\//, '')
          }
          return model.id || model.name
        })
        .filter((name: string) => name && typeof name === 'string')
        .sort()
    }
    
    throw new Error('Gemini APIè¿”å›çš„æ¨¡å‹åˆ—è¡¨æ ¼å¼ä¸æ­£ç¡®')
  }

  private static async getAnthropicModels(): Promise<string[]> {
    return [
      'claude-3-5-sonnet-20241022',
      'claude-3-5-haiku-20241022',
      'claude-3-opus-20240229',
      'claude-3-sonnet-20240229',
      'claude-3-haiku-20240307'
    ].sort()
  }

  private static async getCustomProviderModels(provider: ProviderConfig, preferredApiType?: 'openai' | 'anthropic' | 'google'): Promise<string[]> {
    if (preferredApiType) {
      switch (preferredApiType) {
        case 'openai':
          return await this.getOpenAIModels(provider)
        case 'anthropic':
          return await this.getAnthropicModels()
        case 'google':
          return await this.getGeminiModels(provider)
      }
    }
    
    const baseUrl = provider.baseUrl?.toLowerCase() || ''
    
    if (baseUrl.includes('googleapis.com') || 
        baseUrl.includes('generativelanguage') ||
        baseUrl.includes('/v1beta') ||
        baseUrl.includes('gemini')) {
      return await this.getGeminiModels(provider)
    }
    
    if (baseUrl.includes('anthropic.com') || baseUrl.includes('claude')) {
      return await this.getAnthropicModels()
    }
    
    try {
      return await this.getOpenAIModels(provider)
    } catch {
      try {
        return await this.getGeminiModels(provider)
      } catch {
        return await this.getGenericModels(provider)
      }
    }
  }

  private static async getGenericModels(provider: ProviderConfig): Promise<string[]> {
    if (!provider.baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    
    let apiUrl = provider.baseUrl.trim()
    
    if (!apiUrl.includes('/models')) {
      if (apiUrl.includes('/v1')) {
        apiUrl = apiUrl.replace(/\/+$/, '') + '/models'
      } else {
        apiUrl = apiUrl.replace(/\/+$/, '') + '/v1/models'
      }
    }
    
    const response = await this.fetchWithTimeout(apiUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${provider.apiKey}`,
        'Content-Type': 'application/json'
      }
    })

    if (!response.ok) {
      throw new Error(`Models API error: ${response.status} ${response.statusText}`)
    }

    const data = await response.json()
    
    let models: string[] = []
    
    if (data.data && Array.isArray(data.data)) {
      models = data.data
        .map((model: any) => model.id)
        .filter((id: string) => id && typeof id === 'string')
    } else if (data.models && Array.isArray(data.models)) {
      models = data.models
        .map((model: any) => {
          if (model.name && typeof model.name === 'string') {
            return model.name.replace(/^models\//, '')
          }
          return model.id || model.name
        })
        .filter((name: string) => name && typeof name === 'string')
    } else if (Array.isArray(data)) {
      models = data
        .map((item: any) => {
          if (typeof item === 'string') return item
          if (item.id) return item.id
          if (item.name) return item.name.replace(/^models\//, '')
          return null
        })
        .filter((name: string | null) => name && typeof name === 'string') as string[]
    }
    
    if (models.length > 0) {
      return models.sort()
    }
    
    throw new Error('æ— æ•ˆçš„æ¨¡å‹åˆ—è¡¨å“åº”æ ¼å¼')
  }

  private static buildOpenAIModelsUrl(baseUrl: string): string {
    if (!baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    
    let apiUrl = baseUrl.trim()
    
    if (apiUrl.endsWith('/models') || apiUrl.includes('/models?') || apiUrl.includes('/models/')) {
      return apiUrl
    } else if (apiUrl.includes('/v1')) {
      return apiUrl.replace(/\/+$/, '') + '/models'
    } else {
      return apiUrl.replace(/\/+$/, '') + '/v1/models'
    }
  }

  private static buildGeminiModelsUrl(baseUrl: string): string {
    if (!baseUrl) {
      throw new Error('API URL æœªé…ç½®')
    }
    
    let apiUrl = baseUrl.trim()
    
    if (apiUrl.includes('/models')) {
      return apiUrl
    } else if (apiUrl.includes('/v1beta')) {
      return apiUrl.replace(/\/+$/, '') + '/models'
    } else {
      return apiUrl.replace(/\/+$/, '') + '/v1beta/models'
    }
  }
}

```


## src/services/ai/utils/ResponseCleaner.ts

```ts
import { StreamFilter } from '../streaming/StreamFilter'

/**
 * AIå“åº”å†…å®¹æ¸…ç†å™¨
 * è´Ÿè´£æ¸…ç†AIå“åº”ä¸­çš„ç‰¹æ®Šæ ‡ç­¾å’Œè¯„ä¼°å†…å®¹
 */
export class ResponseCleaner {
  /**
   * æ¸…ç†AIå“åº”ä¸­çš„è¯„ä¼°æ ‡ç­¾å’Œå…¶ä»–ç‰¹æ®Šå†…å®¹
   * @param response AIå“åº”æ–‡æœ¬
   * @returns æ¸…ç†åçš„æ–‡æœ¬
   */
  static cleanResponse(response: string): string {
    try {
      // ç§»é™¤å®Œæ•´çš„è¯„ä¼°æ ‡ç­¾åŠå…¶å†…å®¹
      let cleaned = response.replace(/<ASSESSMENT>[\s\S]*?<\/ASSESSMENT>/gi, '').trim()
      
      // å¤„ç†æµå¼è¿‡ç¨‹ä¸­ä¸å®Œæ•´çš„è¯„ä¼°æ ‡ç­¾
      // å¦‚æœå‘ç°å¼€å§‹æ ‡ç­¾ä½†æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼Œæˆªæ–­åˆ°å¼€å§‹æ ‡ç­¾ä¹‹å‰
      const assessmentStart = cleaned.indexOf('<ASSESSMENT>')
      if (assessmentStart !== -1) {
        cleaned = cleaned.substring(0, assessmentStart).trim()
      }
      
      // å¤„ç†å…¶ä»–å¯èƒ½çš„ä¸å®Œæ•´æ ‡ç­¾æ¨¡å¼
      // æ³¨æ„ï¼šåªåœ¨æ£€æµ‹åˆ° ASSESSMENT æ ‡ç­¾ä¸Šä¸‹æ–‡æ—¶æ‰è¿›è¡Œå…³é”®è¯æˆªæ–­
      // é¿å…è¯¯ä¼¤æ­£å¸¸å†…å®¹ä¸­çš„è¿™äº›è¯ï¼ˆå¦‚ "Output Quality:"ï¼‰
      const hasAssessmentContext = cleaned.includes('ASSESSMENT') || 
                                     cleaned.includes('CONTEXT:') || 
                                     cleaned.includes('DECISION:')
      
      if (hasAssessmentContext) {
        const patterns = [
          /<ASSE[^>]*$/i,     // ä¸å®Œæ•´çš„å¼€å§‹æ ‡ç­¾
          /<\/ASSE[^>]*$/i,   // ä¸å®Œæ•´çš„ç»“æŸæ ‡ç­¾
          /\n\n<ASSE/i,       // æ¢è¡Œåçš„å¼€å§‹æ ‡ç­¾
          /\nCONTEXT:/i,        // è¯„ä¼°å†…å®¹çš„å…³é”®è¯ï¼ˆå¿…é¡»åœ¨æ–°è¡Œï¼‰
          /\nTASK:/i,
          /\nFORMAT:/i,
          /\nQUALITY:/i,
          /\nTURN_COUNT:/i,
          /\nDECISION:/i,
          /\nCONFIDENCE:/i
        ]
        
        for (const pattern of patterns) {
          const match = cleaned.search(pattern)
          if (match !== -1) {
            cleaned = cleaned.substring(0, match).trim()
            break
          }
        }
      }
      
      return cleaned
    } catch (error) {
      return response // æ¸…ç†å¤±è´¥æ—¶è¿”å›åŸå†…å®¹
    }
  }

  /**
   * æ¸…ç†å®Œæ•´æ–‡æœ¬ä¸­çš„<think></think>æ ‡ç­¾å†…å®¹ï¼ˆç”¨äºæœ€ç»ˆç»“æœå¤„ç†ï¼‰
   * ä½¿ç”¨ StreamFilter.removeThinkTags è¿›è¡Œthinkæ ‡ç­¾ç§»é™¤
   * @param text éœ€è¦æ¸…ç†çš„æ–‡æœ¬
   * @returns æ¸…ç†åçš„æ–‡æœ¬
   */
  static cleanThinkTags(text: string): string {
    if (!text) return text
    return StreamFilter.removeThinkTags(text)
  }
}

```


## src/services/ai/utils/apiUrlBuilder.ts

```ts
/**
 * API URLæ„å»ºå·¥å…·
 */

/**
 * æ„å»ºOpenAIèŠå¤©API URL
 */
export function buildOpenAIChatUrl(baseUrl: string): string {
  if (!baseUrl) {
    throw new Error('API URL æœªé…ç½®')
  }

  let apiUrl = baseUrl.trim()

  if (apiUrl.includes('/chat/completions')) {
    return apiUrl
  } else if (apiUrl.includes('/v1')) {
    return apiUrl.replace(/\/+$/, '') + '/chat/completions'
  } else {
    return apiUrl.replace(/\/+$/, '') + '/v1/chat/completions'
  }
}

/**
 * æ„å»ºOpenAIæ¨¡å‹åˆ—è¡¨URL
 */
export function buildOpenAIModelsUrl(baseUrl: string): string {
  if (!baseUrl) {
    throw new Error('API URL æœªé…ç½®')
  }

  let apiUrl = baseUrl.trim()

  if (apiUrl.endsWith('/models') || apiUrl.includes('/models?') || apiUrl.includes('/models/')) {
    return apiUrl
  } else if (apiUrl.includes('/v1')) {
    return apiUrl.replace(/\/+$/, '') + '/models'
  } else {
    return apiUrl.replace(/\/+$/, '') + '/v1/models'
  }
}

/**
 * æ„å»ºAnthropicæ¶ˆæ¯API URL
 */
export function buildAnthropicMessagesUrl(baseUrl: string): string {
  if (!baseUrl) {
    throw new Error('API URL æœªé…ç½®')
  }

  let apiUrl = baseUrl.trim()
  if (!apiUrl.includes('/v1/messages')) {
    apiUrl = apiUrl.replace(/\/+$/, '') + '/v1/messages'
  }
  return apiUrl
}

/**
 * æ„å»ºGemini API URL
 */
export function buildGeminiUrl(baseUrl: string, modelId: string, action: 'generateContent' | 'streamGenerateContent'): string {
  if (!baseUrl) {
    throw new Error('API URL æœªé…ç½®')
  }

  let apiUrl = baseUrl.trim()

  // ç¡®ä¿ä»¥/v1betaç»“å°¾
  if (!apiUrl.endsWith('/v1beta')) {
    if (apiUrl.includes('/models/')) {
      apiUrl = apiUrl.split('/models/')[0]
    }
    if (!apiUrl.endsWith('/v1beta')) {
      apiUrl = apiUrl.replace(/\/+$/, '') + '/v1beta'
    }
  }

  return `${apiUrl}/models/${modelId}:${action}`
}

/**
 * æ„å»ºGeminiæ¨¡å‹åˆ—è¡¨URL
 */
export function buildGeminiModelsUrl(baseUrl: string): string {
  if (!baseUrl) {
    throw new Error('API URL æœªé…ç½®')
  }

  let apiUrl = baseUrl.trim()

  if (apiUrl.includes('/models')) {
    return apiUrl
  } else if (apiUrl.includes('/v1beta')) {
    return apiUrl.replace(/\/+$/, '') + '/models'
  } else {
    return apiUrl.replace(/\/+$/, '') + '/v1beta/models'
  }
}

```


## src/services/ai/utils/index.ts

```ts
export { ResponseCleaner } from './ResponseCleaner'
export { ModelFetcher } from './ModelFetcher'
```


## src/services/ai/utils/responseCleaners.ts

```ts
export class ResponseCleaners {
  static cleanResponse(response: string): string {
    try {
      let cleaned = response.replace(/<ASSESSMENT>[\s\S]*?<\/ASSESSMENT>/gi, '').trim()
      
      const assessmentStart = cleaned.indexOf('<ASSESSMENT>')
      if (assessmentStart !== -1) {
        cleaned = cleaned.substring(0, assessmentStart).trim()
      }
      
      const patterns = [
        /<ASSE[^>]*$/i,
        /<\/ASSE[^>]*$/i,
        /\n\n<ASSE/i,
        /CONTEXT:/i,
        /TASK:/i,
        /FORMAT:/i,
        /QUALITY:/i,
        /TURN_COUNT:/i,
        /DECISION:/i,
        /CONFIDENCE:/i
      ]
      
      for (const pattern of patterns) {
        const match = cleaned.search(pattern)
        if (match !== -1) {
          cleaned = cleaned.substring(0, match).trim()
          break
        }
      }
      
      return cleaned
    } catch (error) {
      return response
    }
  }
  
  static cleanThinkTagsFromFullText(text: string): string {
    if (!text) return text
    return text.replace(/<think>[\s\S]*?<\/think>/g, '')
  }
}

```


## src/services/aiGuideService.ts

```ts
import { AIService } from './aiService'
import type { ChatMessage } from './aiService'
import type { ProviderConfig } from '@/stores/providerStore'
import type { MessageAttachment } from '@/stores/promptStore'
import { promptConfigManager } from '@/config/prompts'

export class AIGuideService {
  private static instance: AIGuideService
  private aiService: AIService

  private constructor() {
    this.aiService = AIService.getInstance()
  }

  // è·å–æµå¼æ¨¡å¼è®¾ç½®ï¼ˆä¸ChatInterfaceä¿æŒåŒæ­¥ï¼‰
  private getStreamMode(): boolean {
    try {
      const savedStreamMode = localStorage.getItem('yprompt_stream_mode')
      return savedStreamMode ? JSON.parse(savedStreamMode) : true // é»˜è®¤ä¸ºtrue
    } catch (error) {
      return true // é»˜è®¤ä¸ºæµå¼æ¨¡å¼
    }
  }

  public static getInstance(): AIGuideService {
    if (!AIGuideService.instance) {
      AIGuideService.instance = new AIGuideService()
    }
    return AIGuideService.instance
  }

  public interruptCurrentRequest() {
    this.aiService.abortCurrentRequest()
  }

  public async generateSimpleResponse(
    userInput: string,
    conversationHistory: Array<{ type: string; content: string; attachments?: MessageAttachment[] }>,
    provider: ProviderConfig,
    modelId: string,
    stream: boolean = false
  ): Promise<string> {
    
    const messages = this.buildSimpleConversationMessages(userInput, conversationHistory)
    
    // è°ƒç”¨AI API
    const response = await this.aiService.callAI(messages, provider, modelId, stream)
    
    if (!response || response.trim() === '') {
      throw new Error('AI APIè¿”å›äº†ç©ºå“åº”')
    }
    
    return response
  }

  // æ„å»ºç®€åŒ–çš„å¯¹è¯æ¶ˆæ¯
  private buildSimpleConversationMessages(
    userInput: string,
    conversationHistory: Array<{ type: string; content: string; attachments?: MessageAttachment[] }>
  ): ChatMessage[] {
    
    // ç³»ç»Ÿæ¶ˆæ¯ï¼šä½¿ç”¨å†…ç½®çš„ç”¨æˆ·å¼•å¯¼è§„åˆ™
    const systemMessage: ChatMessage = {
      role: 'system' as const,
      content: promptConfigManager.getUserGuidedPromptRules()
    }

    // å¯¹è¯å†å²
    const conversationMessages: ChatMessage[] = conversationHistory.map(msg => {
      const message: ChatMessage = {
        role: msg.type === 'user' ? 'user' as const : 'assistant' as const,
        content: msg.content,
        attachments: msg.attachments || []
      }
      
      
      return message
    })

    // æ„å»ºæ¶ˆæ¯æ•°ç»„
    const messages: ChatMessage[] = [systemMessage, ...conversationMessages]
    
    // åªæœ‰å½“userInputä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼ˆé¿å…é‡å¤ï¼‰
    if (userInput.trim()) {
      messages.push({
        role: 'user' as const,
        content: userInput
      })
    }


    return messages
  }

  // è·å–æ­¥éª¤ä¿¡æ¯
  private getStepInfo(stepId: string) {
    const steps = [
      { 
        id: 'taskDefinition', 
        title: 'ä»»åŠ¡å®šä¹‰', 
        description: 'æ˜ç¡®AIåŠ©æ‰‹çš„æ ¸å¿ƒä»»åŠ¡å’Œä¸»è¦åŠŸèƒ½',
        focus: 'é‡ç‚¹äº†è§£ç”¨æˆ·å¸Œæœ›AIå®Œæˆä»€ä¹ˆæ ·çš„å·¥ä½œ'
      },
      { 
        id: 'context', 
        title: 'ä½¿ç”¨åœºæ™¯', 
        description: 'äº†è§£AIçš„ä½¿ç”¨ç¯å¢ƒå’Œç›®æ ‡ç”¨æˆ·',
        focus: 'é‡ç‚¹äº†è§£åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ã€é¢å‘ä»€ä¹ˆæ ·çš„ç”¨æˆ·'
      },
      { 
        id: 'outputFormat', 
        title: 'è¾“å‡ºæ ¼å¼', 
        description: 'å®šä¹‰AIå›ç­”çš„ç»“æ„ã€æ ¼å¼å’Œé£æ ¼',
        focus: 'é‡ç‚¹äº†è§£å¸Œæœ›AIå¦‚ä½•ç»„ç»‡å’Œå‘ˆç°ç­”æ¡ˆ'
      },
      { 
        id: 'qualityCriteria', 
        title: 'è´¨é‡è¦æ±‚', 
        description: 'ç¡®å®šæˆåŠŸæ ‡å‡†å’Œè´¨é‡æœŸæœ›',
        focus: 'é‡ç‚¹äº†è§£å¯¹å‡†ç¡®æ€§ã€å®Œæ•´æ€§ç­‰æ–¹é¢çš„è¦æ±‚'
      },
      { 
        id: 'executionParams', 
        title: 'å·¥ä½œæ–¹å¼', 
        description: 'è®¾å®šAIçš„æ€è€ƒæ–¹å¼å’Œäº’åŠ¨é£æ ¼',
        focus: 'é‡ç‚¹äº†è§£å¸Œæœ›AIé‡‡ç”¨ä»€ä¹ˆæ ·çš„å·¥ä½œæ–¹å¼å’Œè¯­è°ƒ'
      },
      { 
        id: 'optimization', 
        title: 'æœ€ç»ˆç¡®è®¤', 
        description: 'ç¡®è®¤ä¿¡æ¯å®Œæ•´æ€§å¹¶ç”Ÿæˆæç¤ºè¯',
        focus: 'æ±‡æ€»æ‰€æœ‰ä¿¡æ¯å¹¶ç”Ÿæˆæœ€ç»ˆæç¤ºè¯'
      }
    ]

    return steps.find(step => step.id === stepId) || steps[0]
  }

  // è·å–æ­¥éª¤çš„åˆå§‹é—®é¢˜ - ä½¿ç”¨AIç”Ÿæˆ
  public async getInitialQuestion(
    stepId: string, 
    provider?: ProviderConfig, 
    modelId?: string,
    stream: boolean = false
  ): Promise<string> {
    if (!provider || !modelId) {
      throw new Error('éœ€è¦é…ç½®AIæä¾›å•†å’Œæ¨¡å‹')
    }
    
    return await this.generateInitialQuestionWithAI(stepId, provider, modelId, stream)
  }

  // ä½¿ç”¨AIç”Ÿæˆåˆå§‹é—®é¢˜
  private async generateInitialQuestionWithAI(
    stepId: string,
    provider: ProviderConfig,
    modelId: string,
    stream: boolean = false
  ): Promise<string> {
    const currentStep = this.getStepInfo(stepId)
    
    const systemMessage = {
      role: 'system' as const,
      content: promptConfigManager.getUserGuidedPromptRules()
    }

    const userMessage = {
      role: 'user' as const,
      content: `è¯·ä¸º"${currentStep.title}"æ­¥éª¤ç”Ÿæˆä¸€ä¸ªåˆé€‚çš„å¼€åœºé—®é¢˜ã€‚è¿™ä¸ªæ­¥éª¤çš„ç›®æ ‡æ˜¯ï¼š${currentStep.description}`
    }

    const response = await this.aiService.callAI([systemMessage, userMessage], provider, modelId, stream)
    return response
  }

  // åŸºäºå¯¹è¯å†å²ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š
  public async generateRequirementReportFromConversation(
    conversationHistory: Array<{ type: string; content: string; attachments?: MessageAttachment[] }>,
    provider?: ProviderConfig,
    modelId?: string,
    onStreamUpdate?: (content: string) => void
  ): Promise<string> {
    if (!provider || !modelId) {
      throw new Error('éœ€è¦é…ç½®AIæä¾›å•†å’Œæ¨¡å‹')
    }
    
    return await this.generateReportFromConversationWithAI(conversationHistory, provider, modelId, onStreamUpdate)
  }

  // ä½¿ç”¨AIåŸºäºå¯¹è¯å†å²ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š
  private async generateReportFromConversationWithAI(
    conversationHistory: Array<{ type: string; content: string; attachments?: MessageAttachment[] }>,
    provider: ProviderConfig,
    modelId: string,
    onStreamUpdate?: (content: string) => void
  ): Promise<string> {
    const systemMessage = {
      role: 'system' as const,
      content: promptConfigManager.getRequirementReportRules()
    }

    const conversationSummary = conversationHistory
      .map(msg => {
        let content = `${msg.type === 'user' ? 'User' : 'AI'}: ${msg.content}`
        
        // å¦‚æœæœ‰é™„ä»¶ï¼Œæ·»åŠ é™„ä»¶ä¿¡æ¯
        if (msg.attachments && msg.attachments.length > 0) {
          const attachmentInfo = msg.attachments.map(att => 
            `[é™„ä»¶: ${att.name} (${att.type}, ${att.size} bytes)]`
          ).join(', ')
          content += `\né™„ä»¶: ${attachmentInfo}`
        }
        
        return content
      })
      .join('\n\n')

    const userMessage = {
      role: 'user' as const,
      content: `åŸºäºä»¥ä¸‹å¯¹è¯å†å²ç”Ÿæˆéœ€æ±‚æ€»ç»“æŠ¥å‘Šï¼š

**å¯¹è¯å†å²ï¼š**
${conversationSummary}

è¯·ç”Ÿæˆå®Œæ•´çš„éœ€æ±‚æ€»ç»“æŠ¥å‘Šï¼Œç¡®ä¿æ‰€æœ‰5ä¸ªéƒ¨åˆ†éƒ½æœ‰å…·ä½“å†…å®¹ã€‚`
    }

    const streamMode = this.getStreamMode()
    
    // å¦‚æœæœ‰æµå¼å›è°ƒä¸”å¯ç”¨æµå¼æ¨¡å¼ï¼Œè®¾ç½®æµå¼æ›´æ–°
    if (onStreamUpdate && streamMode) {
      this.aiService.setStreamUpdateCallback((chunk: string) => {
        onStreamUpdate(chunk)
      })
    }
    
    const response = await this.aiService.callAI([systemMessage, userMessage], provider, modelId, streamMode)
    
    // æ¸…ç†æµå¼å›è°ƒ
    if (onStreamUpdate && streamMode) {
      this.aiService.clearStreamUpdateCallback()
    }
    
    return response
  }

  
}
```


## src/services/aiService.ts

```ts
import type { ProviderConfig } from '@/stores/providerStore'
import type { ChatMessage as PromptChatMessage, MessageAttachment } from '@/stores/promptStore'
import { 
  OpenAIProvider, 
  AnthropicProvider, 
  GoogleProvider,
  StreamProcessor,
  AIErrorHandler,
  ModelFetcher,
  ResponseCleaner,
  type ChatMessage as AIChatMessage,
  type BaseProvider,
  type MessageContent,
  type APICallParams
} from './ai'

export type { MessageContent } from './ai/types'

export interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string | MessageContent[]
  attachments?: MessageAttachment[]
}

export class AIService {
  private static instance: AIService
  private providers: Map<string, BaseProvider> = new Map()
  private streamProcessor: StreamProcessor
  private onStreamUpdate?: (content: string) => void
  private abortController?: AbortController

  private constructor() {
    this.streamProcessor = new StreamProcessor()
  }

  public static getInstance(): AIService {
    if (!AIService.instance) {
      AIService.instance = new AIService()
    }
    return AIService.instance
  }

  private getProvider(provider: ProviderConfig, modelId: string): BaseProvider {
    const key = `${provider.type}-${provider.baseUrl}-${modelId}`
    
    if (this.providers.has(key)) {
      return this.providers.get(key)!
    }

    const model = provider.models.find(m => m.id === modelId)
    const apiType = model?.apiType || provider.type

    let providerInstance: BaseProvider

    switch (apiType) {
      case 'openai':
        providerInstance = new OpenAIProvider(provider, modelId)
        break
      case 'anthropic':
        providerInstance = new AnthropicProvider(provider, modelId)
        break
      case 'google':
        providerInstance = new GoogleProvider(provider, modelId)
        break
      default:
        providerInstance = new OpenAIProvider(provider, modelId)
    }

    this.providers.set(key, providerInstance)
    return providerInstance
  }

  private convertMessagesToAI(messages: ChatMessage[] | PromptChatMessage[]): AIChatMessage[] {
    return messages.map(msg => {
      if ('role' in msg) {
        return {
          role: msg.role,
          content: msg.content,
          attachments: msg.attachments
        } as AIChatMessage
      } else {
        const role = msg.type === 'ai' ? 'assistant' : 'user'
        return {
          role,
          content: msg.content,
          attachments: msg.attachments
        } as AIChatMessage
      }
    })
  }

  async callAI(
    messages: ChatMessage[] | PromptChatMessage[],
    provider: ProviderConfig,
    modelId: string,
    stream: boolean = false,
    streamCallback?: (chunk: string) => void
  ): Promise<string> {
    const model = provider.models.find(m => m.id === modelId)
    const apiType = model?.apiType || provider.type

    const abortController = new AbortController()
    this.abortController = abortController

    // è·å–æ¨¡å‹å‚æ•°é…ç½®
    const modelParams = (model as any)?.params
    const apiParams: APICallParams | undefined = modelParams ? {
      temperature: modelParams.temperature,
      maxTokens: modelParams.maxTokens,
      topP: modelParams.topP,
      frequencyPenalty: modelParams.frequencyPenalty,
      presencePenalty: modelParams.presencePenalty,
      topK: modelParams.topK
    } : undefined

    try {
      const convertedMessages = this.convertMessagesToAI(messages)
      const providerInstance = this.getProvider(provider, modelId)

      if (stream) {
        return await this.callWithStream(providerInstance, convertedMessages, apiParams, streamCallback, abortController)
      } else {
        const response = await providerInstance.callAPI(convertedMessages, false, apiParams, abortController)
        if (typeof response !== 'object' || !('content' in response)) {
          throw new Error('Expected AIResponse object')
        }
        let content = response.content
        content = ResponseCleaner.cleanResponse(content)
        content = ResponseCleaner.cleanThinkTags(content)
        return content
      }
    } catch (error) {
      if ((error as any)?.name === 'AbortError') {
        throw error
      }
      const friendlyErrorMessage = AIErrorHandler.parseError(error, apiType)
      throw new Error(friendlyErrorMessage)
    } finally {
      if (this.abortController === abortController) {
        this.abortController = undefined
      }
    }
  }

  private async callWithStream(
    provider: BaseProvider,
    messages: AIChatMessage[],
    params: APICallParams | undefined,
    streamCallback?: (chunk: string) => void,
    abortController?: AbortController
  ): Promise<string> {
    // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å›è°ƒï¼Œå…¶æ¬¡ä½¿ç”¨å…¨å±€å›è°ƒ
    const callback = streamCallback || this.onStreamUpdate
    const hasGlobalCallback = !!this.onStreamUpdate

    try {
      const stream = await provider.callAPI(messages, true, params, abortController)
      if (typeof stream === 'string' || !('getReader' in stream)) {
        throw new Error('Expected ReadableStream for streaming')
      }

      let fullContent = ''
      this.streamProcessor.reset()

      const parseChunk = provider.parseStreamChunk.bind(provider)

      for await (const chunk of this.streamProcessor.processStream(stream, parseChunk)) {
        fullContent += chunk
        if (callback) {
          callback(chunk)
        }
      }

      if (!fullContent || fullContent.trim() === '') {
        throw new Error('APIè¿”å›ç©ºå†…å®¹')
      }

      let result = ResponseCleaner.cleanResponse(fullContent)
      result = ResponseCleaner.cleanThinkTags(result)

      return result
    } finally {
      if (hasGlobalCallback) {
        this.clearStreamUpdateCallback()
      }
    }
  }

  setStreamUpdateCallback(callback: (content: string) => void) {
    this.onStreamUpdate = callback
  }

  clearStreamUpdateCallback() {
    this.onStreamUpdate = undefined
  }

  abortCurrentRequest() {
    if (this.abortController) {
      this.abortController.abort()
      this.abortController = undefined
    }
    this.clearStreamUpdateCallback()
  }

  async getAvailableModels(
    provider: ProviderConfig, 
    preferredApiType?: 'openai' | 'anthropic' | 'google'
  ): Promise<string[]> {
    return await ModelFetcher.getModels(provider, preferredApiType)
  }

  async testConnection(provider: ProviderConfig, modelId: string): Promise<boolean> {
    try {
      const testMessages: PromptChatMessage[] = [
        { type: 'user', content: 'test', timestamp: new Date().toISOString() }
      ]
      await this.callAI(testMessages, provider, modelId, false)
      return true
    } catch (error) {
      return false
    }
  }
}

```


## src/services/apiService.ts

```ts
/**
 * APIæœåŠ¡å°è£…
 * ç»Ÿä¸€å¤„ç†APIè¯·æ±‚ï¼Œè‡ªåŠ¨æºå¸¦token
 * æ”¯æŒ debug æ¨¡å¼ï¼Œåœ¨ debug æ¨¡å¼ä¸‹ä½¿ç”¨ mock API
 */

import { isDebugMode, mockRequest } from './mockApiService'

// ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨å®Œæ•´URL
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''

/**
 * è·å–token
 */
function getToken(): string | null {
  return localStorage.getItem('yprompt_token')
}

/**
 * é€šç”¨è¯·æ±‚æ–¹æ³•
 */
async function request<T = any>(
  url: string,
  options: RequestInit = {}
): Promise<T> {
  // Debug æ¨¡å¼ï¼šä½¿ç”¨ mock API
  if (isDebugMode()) {
    const method = options.method || 'GET'
    const body = options.body ? JSON.parse(options.body as string) : undefined
    return mockRequest<T>(method, url, body)
  }
  
  // æ­£å¸¸æ¨¡å¼ï¼šä½¿ç”¨çœŸå® API
  const token = getToken()
  
  // åˆå¹¶headers
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
    ...(options.headers as Record<string, string>),
  }
  
  // å¦‚æœæœ‰tokenï¼Œæ·»åŠ Authorization header
  if (token) {
    headers['Authorization'] = `Bearer ${token}`
  }
  
  const response = await fetch(`${API_BASE_URL}${url}`, {
    ...options,
    headers,
  })
  
  // æ£€æŸ¥å“åº”çŠ¶æ€
  if (!response.ok) {
    // å°è¯•è§£æJSONé”™è¯¯å“åº”
    let errorMessage = 'è¯·æ±‚å¤±è´¥'
    try {
      const errorData = await response.json()
      errorMessage = errorData.message || errorMessage
      
      // å¦‚æœtokenè¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°token
      if (errorData.code === 401) {
        localStorage.removeItem('yprompt_token')
        localStorage.removeItem('yprompt_user')
        throw new Error('æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•')
      }
    } catch (parseError) {
      // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨çŠ¶æ€æ–‡æœ¬
      errorMessage = `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`
    }
    throw new Error(errorMessage)
  }
  
  // è§£æJSONå“åº”
  let result
  try {
    result = await response.json()
  } catch (parseError) {
    throw new Error(`å“åº”è§£æå¤±è´¥: ${parseError instanceof Error ? parseError.message : 'æœªçŸ¥é”™è¯¯'}`)
  }
  
  // å¦‚æœtokenè¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°token
  if (result.code === 401) {
    localStorage.removeItem('yprompt_token')
    localStorage.removeItem('yprompt_user')
    throw new Error('æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•')
  }
  
  return result
}

/**
 * GETè¯·æ±‚
 */
export async function get<T = any>(url: string): Promise<T> {
  return request<T>(url, { method: 'GET' })
}

/**
 * POSTè¯·æ±‚
 */
export async function post<T = any>(url: string, data?: any): Promise<T> {
  return request<T>(url, {
    method: 'POST',
    body: data ? JSON.stringify(data) : undefined,
  })
}

/**
 * PUTè¯·æ±‚
 */
export async function put<T = any>(url: string, data?: any): Promise<T> {
  return request<T>(url, {
    method: 'PUT',
    body: data ? JSON.stringify(data) : undefined,
  })
}

/**
 * DELETEè¯·æ±‚
 */
export async function del<T = any>(url: string): Promise<T> {
  return request<T>(url, { method: 'DELETE' })
}

// ============ æç¤ºè¯ç›¸å…³API ============

export interface SavePromptData {
  title: string
  description?: string
  requirement_report?: string
  thinking_points?: string[]
  initial_prompt?: string
  advice?: string[]
  final_prompt: string
  language?: string
  format?: string
  prompt_type?: string
  tags?: string[]
}

export interface Prompt {
  id: number
  user_id: number
  title: string
  description?: string
  requirement_report?: string
  thinking_points?: string
  initial_prompt?: string
  advice?: string
  final_prompt: string
  language: string
  format: string
  prompt_type: string
  is_favorite: number
  is_public: number
  view_count: number
  use_count: number
  tags?: string
  create_time: string
  update_time: string
  current_version?: string
  total_versions?: number
}

/**
 * ä¿å­˜æç¤ºè¯
 */
export async function savePrompt(data: SavePromptData) {
  return post('/api/prompts', data)
}

/**
 * è·å–æç¤ºè¯åˆ—è¡¨
 */
export async function getPrompts(params?: {
  page?: number
  limit?: number
  search?: string
  is_favorite?: boolean
  tags?: string[]
  language?: string
  format?: string
}) {
  const query = new URLSearchParams()
  if (params) {
    Object.entries(params).forEach(([key, value]) => {
      if (value !== undefined && value !== null) {
        if (Array.isArray(value)) {
          query.append(key, value.join(','))
        } else {
          query.append(key, String(value))
        }
      }
    })
  }
  
  const queryString = query.toString()
  return get<{
    code: number
    data: {
      total: number
      page: number
      limit: number
      items: Prompt[]
    }
  }>(`/api/prompts${queryString ? '?' + queryString : ''}`)
}

/**
 * è·å–æç¤ºè¯è¯¦æƒ…
 */
export async function getPrompt(id: number) {
  return get<{ code: number; data: Prompt }>(`/api/prompts/${id}`)
}

/**
 * æ›´æ–°æç¤ºè¯
 */
export async function updatePrompt(id: number, data: Partial<SavePromptData>) {
  return put(`/api/prompts/${id}`, data)
}

/**
 * åˆ é™¤æç¤ºè¯
 */
export async function deletePrompt(id: number) {
  return del(`/api/prompts/${id}`)
}

/**
 * æ”¶è—/å–æ¶ˆæ”¶è—æç¤ºè¯
 */
export async function toggleFavorite(id: number, is_favorite: boolean) {
  return post(`/api/prompts/${id}/favorite`, { is_favorite })
}

/**
 * è®°å½•æç¤ºè¯ä½¿ç”¨æ¬¡æ•°
 */
export async function recordPromptUse(id: number) {
  return post(`/api/prompts/${id}/use`)
}

// ============ æ ‡ç­¾ç›¸å…³API ============

/**
 * è·å–ç”¨æˆ·æ ‡ç­¾åˆ—è¡¨
 */
export async function getTags() {
  return get('/api/tags')
}

/**
 * è·å–çƒ­é—¨æ ‡ç­¾
 */
export async function getPopularTags(limit = 10) {
  return get(`/api/tags/popular?limit=${limit}`)
}

/**
 * åˆ›å»ºæ ‡ç­¾
 */
export async function createTag(tag_name: string) {
  return post('/api/tags', { tag_name })
}

/**
 * åˆ é™¤æ ‡ç­¾
 */
export async function deleteTag(id: number) {
  return del(`/api/tags/${id}`)
}

// ============ æç¤ºè¯è§„åˆ™ç›¸å…³API ============

export interface PromptRules {
  id?: number
  user_id?: number
  system_prompt_rules?: string
  user_guided_prompt_rules?: string
  requirement_report_rules?: string
  thinking_points_extraction_prompt?: string
  thinking_points_system_message?: string
  system_prompt_generation_prompt?: string
  system_prompt_system_message?: string
  optimization_advice_prompt?: string
  optimization_advice_system_message?: string
  optimization_application_prompt?: string
  optimization_application_system_message?: string
  quality_analysis_system_prompt?: string
  user_prompt_quality_analysis?: string
  user_prompt_quick_optimization?: string
  user_prompt_rules?: string
  create_time?: string
  update_time?: string
}

/**
 * è·å–ç”¨æˆ·çš„æç¤ºè¯è§„åˆ™
 */
export async function getUserPromptRules() {
  return get<{ code: number; data: PromptRules | null; message?: string }>('/api/prompt-rules')
}

/**
 * ä¿å­˜ç”¨æˆ·çš„æç¤ºè¯è§„åˆ™
 */
export async function saveUserPromptRules(rules: PromptRules) {
  return post<{ code: number; data: PromptRules; message: string }>('/api/prompt-rules', rules)
}

/**
 * åˆ é™¤ç”¨æˆ·çš„æç¤ºè¯è§„åˆ™ï¼ˆé‡ç½®ä¸ºé»˜è®¤ï¼‰
 * @param fields è¦åˆ é™¤çš„å­—æ®µåˆ—è¡¨ï¼Œå¦‚æœä¸ä¼ åˆ™åˆ é™¤æ‰€æœ‰
 */
export async function deleteUserPromptRules(fields?: string[]) {
  if (fields && fields.length > 0) {
    // åˆ é™¤æŒ‡å®šå­—æ®µï¼šä¼ ç©ºå€¼
    const emptyData: Record<string, null> = {}
    fields.forEach(field => {
      emptyData[field] = null
    })
    return post<{ code: number; message: string }>('/api/prompt-rules', emptyData)
  } else {
    // åˆ é™¤æ‰€æœ‰
    return del<{ code: number; message: string }>('/api/prompt-rules')
  }
}


```


## src/services/capabilityDetector.ts

```ts
import type { ProviderConfig } from '@/stores/providerStore'
import type { ModelCapabilities, ReasoningType, SupportedParams } from '@/stores/settingsStore'
import { AIService } from './aiService'
import type { ChatMessage } from './aiService'

export class CapabilityDetector {
  private static instance: CapabilityDetector
  private testCache = new Map<string, ModelCapabilities>()
  private aiService = AIService.getInstance()

  private constructor() {}

  public static getInstance(): CapabilityDetector {
    if (!CapabilityDetector.instance) {
      CapabilityDetector.instance = new CapabilityDetector()
    }
    return CapabilityDetector.instance
  }

  async detectCapabilities(
    provider: ProviderConfig, 
    modelId: string,
    forceRefresh: boolean = false
  ): Promise<ModelCapabilities> {
    const cacheKey = `${provider.id}:${modelId}`
    
    // æ£€æŸ¥ç¼“å­˜ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰- é™¤éå¼ºåˆ¶åˆ·æ–°
    if (!forceRefresh && this.testCache.has(cacheKey)) {
      const cached = this.testCache.get(cacheKey)!
      const age = Date.now() - (cached.testResult?.timestamp.getTime() || 0)
      if (age < 24 * 60 * 60 * 1000) { // 24å°æ—¶ç¼“å­˜
        return cached
      }
    }
    
    // æ‰§è¡Œæ£€æµ‹
    const capabilities = await this.performCapabilityTest(provider, modelId)
    
    // ç¼“å­˜ç»“æœ
    this.testCache.set(cacheKey, capabilities)
    
    return capabilities
  }

  // å¿«é€Ÿè¿æ¥æµ‹è¯•+å¼‚æ­¥æ€è€ƒæ£€æµ‹
  async detectCapabilitiesWithCallback(
    provider: ProviderConfig, 
    modelId: string,
    onConnectionResult: (connected: boolean, responseTime: number, error?: string) => void,
    onThinkingResult: (capabilities: ModelCapabilities) => void,
    forceRefresh: boolean = false,
    abortController?: AbortController
  ): Promise<void> {
    const cacheKey = `${provider.id}:${modelId}`
    
    // æ£€æŸ¥ç¼“å­˜ - é™¤éå¼ºåˆ¶åˆ·æ–°
    if (!forceRefresh && this.testCache.has(cacheKey)) {
      const cached = this.testCache.get(cacheKey)!
      const age = Date.now() - (cached.testResult?.timestamp.getTime() || 0)
      if (age < 24 * 60 * 60 * 1000) {
        // ç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›ç»“æœ
        onConnectionResult(
          cached.testResult?.connected || false,
          cached.testResult?.responseTime || 0,
          cached.testResult?.error
        )
        onThinkingResult(cached)
        return
      }
    }
    
    const apiType = this.getAPIType(provider, modelId)
    const startTime = Date.now()
    
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        return
      }
      
      // ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿè¿æ¥æµ‹è¯•
      const basicResult = await this.testBasicConnection(provider, modelId)
      const connectionTime = Date.now() - startTime
      
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        return
      }
      
      onConnectionResult(basicResult.connected, connectionTime, basicResult.error)
      
      if (!basicResult.connected) {
        const failedCapabilities = this.createFailedCapabilities(basicResult, apiType)
        onThinkingResult(failedCapabilities)
        this.testCache.set(cacheKey, failedCapabilities)
        return
      }
      
      // ç¬¬äºŒé˜¶æ®µï¼šå¼‚æ­¥æ€è€ƒèƒ½åŠ›æµ‹è¯•ï¼ˆä¸é˜»å¡UIï¼‰
      const timeoutId = setTimeout(async () => {
        try {
          // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
          if (abortController?.signal.aborted) {
            return
          }
          
          const thinkingResult = await this.testThinkingCapability(provider, modelId, apiType, basicResult.preferStream, abortController)
          
          // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­ï¼ˆå› ä¸º testThinkingCapability å¯èƒ½æ˜¯é•¿æ—¶é—´è¿è¡Œçš„ï¼‰
          if (abortController?.signal.aborted) {
            return
          }
          
          const finalCapabilities: ModelCapabilities = {
            reasoning: thinkingResult.reasoning,
            reasoningType: thinkingResult.reasoningType,
            supportedParams: thinkingResult.supportedParams,
            testResult: {
              connected: true,
              reasoning: thinkingResult.reasoning,
              responseTime: connectionTime,
              timestamp: new Date()
            }
          }
          
          // ç¼“å­˜å¹¶å›è°ƒæœ€ç»ˆç»“æœ
          this.testCache.set(cacheKey, finalCapabilities)
          onThinkingResult(finalCapabilities)
        } catch (thinkingError) {
          // å¦‚æœæ˜¯ä¸­æ­¢é”™è¯¯ï¼Œç›´æ¥è¿”å›
          if (thinkingError instanceof Error && thinkingError.name === 'AbortError') {
            return
          }
          
          // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
          if (abortController?.signal.aborted) {
            return
          }
          
          // æ€è€ƒæµ‹è¯•å¤±è´¥ï¼Œä½†è¿æ¥æ˜¯æˆåŠŸçš„
          const partialCapabilities: ModelCapabilities = {
            reasoning: false,
            reasoningType: null,
            supportedParams: this.getDefaultCapabilities(apiType).supportedParams,
            testResult: {
              connected: true,
              reasoning: false,
              responseTime: connectionTime,
              timestamp: new Date()
            }
          }
          
          this.testCache.set(cacheKey, partialCapabilities)
          onThinkingResult(partialCapabilities)
        }
      }, 100) // çŸ­æš‚å»¶è¿Ÿï¼Œè®©UIå…ˆæ›´æ–°è¿æ¥çŠ¶æ€
      
      // ç›‘å¬ä¸­æ­¢ä¿¡å·ï¼Œæ¸…ç†setTimeout
      if (abortController) {
        abortController.signal.addEventListener('abort', () => {
          clearTimeout(timeoutId)
        })
      }
      
    } catch (error) {
      const failedResult = {
        connected: false,
        error: error instanceof Error ? error.message : String(error)
      }
      
      onConnectionResult(false, Date.now() - startTime, failedResult.error)
      
      const failedCapabilities = this.createFailedCapabilities(failedResult, apiType)
      onThinkingResult(failedCapabilities)
      this.testCache.set(cacheKey, failedCapabilities)
    }
  }

  private async performCapabilityTest(
    provider: ProviderConfig, 
    modelId: string
  ): Promise<ModelCapabilities> {
    const apiType = this.getAPIType(provider, modelId)
    const startTime = Date.now()
    
    try {
      // 1. åŸºç¡€è¿æ¥æµ‹è¯•
      const basicResult = await this.testBasicConnection(provider, modelId)
      if (!basicResult.connected) {
        return this.createFailedCapabilities(basicResult, apiType)
      }
      
      // 2. æ€è€ƒèƒ½åŠ›æµ‹è¯•
      const thinkingResult = await this.testThinkingCapability(provider, modelId, apiType, basicResult.preferStream)
      
      return {
        reasoning: thinkingResult.reasoning,
        reasoningType: thinkingResult.reasoningType,
        supportedParams: thinkingResult.supportedParams,
        testResult: {
          connected: true,
          reasoning: thinkingResult.reasoning,
          responseTime: Date.now() - startTime,
          timestamp: new Date()
        }
      }
    } catch (error) {
      return this.createFailedCapabilities({
        connected: false,
        error: error instanceof Error ? error.message : String(error)
      }, apiType)
    }
  }

  private async testBasicConnection(
    provider: ProviderConfig, 
    modelId: string
  ): Promise<{ connected: boolean; preferStream?: boolean; error?: string }> {
    const testMessages: ChatMessage[] = [
      { role: 'user', content: 'Hi' }
    ]
    
    try {
      // æ–¹æ³•1ï¼šä¼˜å…ˆå°è¯•æµå¼è°ƒç”¨ï¼ˆç°ä»£AI APIçš„ä¸»æµæ–¹å¼ï¼‰
      const streamResponse = await this.aiService.callAI(testMessages, provider, modelId, true)
      const streamConnected = Boolean(streamResponse && typeof streamResponse === 'string' && streamResponse.trim().length > 0)
      
      if (streamConnected) {
        return { connected: true, preferStream: true }
      }
    } catch (streamError) {
    }
    
    try {
      // æ–¹æ³•2ï¼šå›é€€åˆ°éæµå¼è°ƒç”¨
      const response = await this.aiService.callAI(testMessages, provider, modelId, false)
      const connected = Boolean(response && typeof response === 'string' && response.trim().length > 0)
      
      if (connected) {
        return { connected: true, preferStream: false }
      }
    } catch (nonStreamError) {
      return {
        connected: false,
        error: nonStreamError instanceof Error ? nonStreamError.message : String(nonStreamError)
      }
    }
    
    return { connected: false, error: 'æµå¼å’Œéæµå¼æµ‹è¯•éƒ½å¤±è´¥' }
  }

  private async testThinkingCapability(
    provider: ProviderConfig, 
    modelId: string, 
    apiType: string,
    preferStream?: boolean,
    abortController?: AbortController
  ): Promise<{
    reasoning: boolean
    reasoningType: ReasoningType | null
    supportedParams: SupportedParams
  }> {
    // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
    if (abortController?.signal.aborted) {
      throw new Error('AbortError')
    }
    
    switch (apiType) {
      case 'openai':
        return await this.testOpenAIThinking(provider, modelId, preferStream, abortController)
      case 'google':
        return await this.testGeminiThinking(provider, modelId, preferStream, abortController)
      case 'anthropic':
        return await this.testClaudeThinking(provider, modelId, preferStream, abortController)
      default:
        return this.getDefaultCapabilities(apiType)
    }
  }

  private async testOpenAIThinking(
    provider: ProviderConfig, 
    modelId: string,
    preferStream?: boolean,
    abortController?: AbortController
  ): Promise<{
    reasoning: boolean
    reasoningType: ReasoningType | null
    supportedParams: SupportedParams
  }> {
    // ä½¿ç”¨æ•°å­¦æ¨ç†é—®é¢˜ï¼ˆä¸šç•Œæœ€ä½³å®è·µï¼‰
    const testMessage: ChatMessage[] = [{
      role: 'user',
      content: 'ä¸€å®¶å•†åº—åŸä»·100å…ƒçš„å•†å“ï¼Œå…ˆæ‰“8æŠ˜ï¼Œå†æ‰“9æŠ˜ï¼Œæœ€ç»ˆä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿè¯·è¯¦ç»†å±•ç¤ºä½ çš„è®¡ç®—å’Œæ¨ç†è¿‡ç¨‹ã€‚'
    }]
    
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      // æ£€æµ‹æ˜¯å¦ä¸ºo1ç³»åˆ—
      if (this.isO1Model(modelId)) {
        // o1ç³»åˆ—æ¨¡å‹çš„ç‰¹æ®Šæ£€æµ‹é€»è¾‘
        const response = await this.callOpenAIWithO1Params(provider, modelId, testMessage)
        return {
          reasoning: !!response.choices?.[0]?.message?.reasoning,
          reasoningType: 'openai-reasoning',
          supportedParams: {
            temperature: false,
            maxTokens: 'max_completion_tokens',
            streaming: false,
            systemMessage: true
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      // å¸¸è§„OpenAIæ¨¡å‹çš„æ€è€ƒèƒ½åŠ›æµ‹è¯•
      const response = await this.callOpenAIWithThinkingInstructions(provider, modelId, testMessage, preferStream)
      const hasThinking = this.detectThinkingInResponse(response, 'openai')
      
      return {
        reasoning: hasThinking,
        reasoningType: hasThinking ? 'generic-cot' : null,
        supportedParams: {
          temperature: true,
          maxTokens: 'max_tokens',
          streaming: true,
          systemMessage: true
        }
      }
    } catch (error) {
      if (error instanceof Error && error.message === 'AbortError') {
        throw error
      }
      return this.getDefaultCapabilities('openai')
    }
  }

  private async testGeminiThinking(
    provider: ProviderConfig, 
    modelId: string,
    preferStream?: boolean,
    abortController?: AbortController
  ): Promise<{
    reasoning: boolean
    reasoningType: ReasoningType | null
    supportedParams: SupportedParams
  }> {
    // Geminiçš„æ€è€ƒèƒ½åŠ›æ£€æµ‹ï¼šé€šè¿‡APIå“åº”ç»“æ„åˆ¤æ–­æ˜¯å¦æ”¯æŒthoughtå­—æ®µ
    const testMessage: ChatMessage[] = [{
      role: 'user',
      content: 'è¯·æ€è€ƒå¹¶å›ç­”ï¼šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ'
    }]
    
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      // ç›´æ¥è°ƒç”¨APIï¼Œæ£€æŸ¥åŸå§‹å“åº”ç»“æ„
      const rawResponse = await this.callGeminiAPIRaw(provider, modelId, testMessage, preferStream)
      
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      // æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«thoughtå­—æ®µ
      const hasThoughtField = this.detectGeminiThoughtField(rawResponse)
      
      // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°thoughtå­—æ®µï¼Œé€šè¿‡æ¨¡å‹åç§°åˆ¤æ–­æ˜¯å¦ä¸ºæ”¯æŒthinkingçš„ç‰ˆæœ¬
      let hasThinking = hasThoughtField
      if (!hasThoughtField) {
        hasThinking = this.isGeminiThinkingModel(modelId)
      }
      
      return {
        reasoning: hasThinking,
        reasoningType: hasThinking ? 'gemini-thought' : null,
        supportedParams: {
          temperature: true,
          maxTokens: 'max_tokens',
          streaming: true,
          systemMessage: true
        }
      }
    } catch (error) {
      if (error instanceof Error && error.message === 'AbortError') {
        throw error
      }
      return this.getDefaultCapabilities('google')
    }
  }

  private async testClaudeThinking(
    provider: ProviderConfig, 
    modelId: string,
    preferStream?: boolean,
    abortController?: AbortController
  ): Promise<{
    reasoning: boolean
    reasoningType: ReasoningType | null
    supportedParams: SupportedParams
  }> {
    // Claudeçš„æ€è€ƒèƒ½åŠ›æ£€æµ‹ï¼šé€šè¿‡æµ‹è¯•<thinking>æ ‡ç­¾æ˜¯å¦è¢«æ”¯æŒ
    const testMessage: ChatMessage[] = [{
      role: 'user',
      content: 'è¯·ç”¨<thinking>æ ‡ç­¾å±•ç¤ºä½ çš„æ€è€ƒè¿‡ç¨‹ï¼Œç„¶åå›ç­”ï¼šä»€ä¹ˆæ˜¯AIï¼Ÿ'
    }]
    
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      const response = await this.aiService.callAI(testMessage, provider, modelId, preferStream || false)
      
      // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
      if (abortController?.signal.aborted) {
        throw new Error('AbortError')
      }
      
      // Claudeçš„æ€è€ƒèƒ½åŠ›åˆ¤æ–­ï¼šæ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«<thinking>æ ‡ç­¾
      const hasThinkingTags = typeof response === 'string' && 
                             (response.includes('<thinking>') && response.includes('</thinking>'))
      
      // å¦‚æœæ²¡æœ‰thinkingæ ‡ç­¾ï¼Œå°è¯•æ£€æµ‹æ˜¯å¦æ˜¯æ”¯æŒthinkingçš„Claudeæ¨¡å‹
      let hasThinking = hasThinkingTags
      if (!hasThinkingTags) {
        // æŸäº›Claudeæ¨¡å‹æ”¯æŒthinkingä½†å¯èƒ½ä¸ä¼šåœ¨ç®€å•æµ‹è¯•ä¸­ä½¿ç”¨
        // é€šè¿‡æ¨¡å‹åç§°åˆ¤æ–­æ˜¯å¦ä¸ºæ”¯æŒthinkingçš„ç‰ˆæœ¬
        hasThinking = this.isClaudeThinkingModel(modelId)
      }
      
      return {
        reasoning: hasThinking,
        reasoningType: hasThinking ? 'claude-thinking' : null,
        supportedParams: {
          temperature: true,
          maxTokens: 'max_tokens',
          streaming: true,
          systemMessage: true
        }
      }
    } catch (error) {
      if (error instanceof Error && error.message === 'AbortError') {
        throw error
      }
      return this.getDefaultCapabilities('anthropic')
    }
  }

  // è¾…åŠ©æ–¹æ³•
  private getAPIType(provider: ProviderConfig, modelId: string): string {
    const model = provider.models.find(m => m.id === modelId)
    return model?.apiType || provider.type
  }

  private isO1Model(modelId: string): boolean {
    return modelId.toLowerCase().includes('o1')
  }

  private isClaudeThinkingModel(modelId: string): boolean {
    const modelName = modelId.toLowerCase()
    // Claude 3.5åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒthinkingæ ‡ç­¾å’Œå¤šæ¨¡æ€ï¼ˆå›¾ç‰‡+PDFæ–‡æ¡£æœ€å¤š100é¡µï¼‰
    return modelName.includes('claude-3.5') || 
           modelName.includes('claude-3.7') ||
           modelName.includes('claude-4') ||
           modelName.includes('sonnet') ||
           modelName.includes('opus')
  }

  private isGeminiThinkingModel(modelId: string): boolean {
    const modelName = modelId.toLowerCase()
    // Gemini 2.0ä»¥ä¸Šç‰ˆæœ¬æ”¯æŒthoughtå­—æ®µ
    return modelName.includes('gemini-2.') || 
           modelName.includes('gemini-pro') ||
           modelName.includes('thinking') ||
           modelName.includes('exp')
  }

  private detectGeminiThoughtField(response: any): boolean {
    try {
      // å¦‚æœå“åº”æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸ºJSON
      if (typeof response === 'string') {
        try {
          response = JSON.parse(response)
        } catch {
          return false
        }
      }

      // æ£€æŸ¥Gemini APIå“åº”ç»“æ„ä¸­çš„thoughtå­—æ®µ
      if (response && response.candidates && Array.isArray(response.candidates)) {
        for (const candidate of response.candidates) {
          if (candidate.content && candidate.content.parts) {
            for (const part of candidate.content.parts) {
              if (part.thought) {
                return true
              }
            }
          }
        }
      }

      return false
    } catch {
      return false
    }
  }

  private detectThinkingInResponse(response: any, apiType: string): boolean {
    if (typeof response !== 'string') {
      return false
    }
    
    const responseText = response.toLowerCase()
    
    switch (apiType) {
      case 'openai':
        return this.detectOpenAIThinking(response)
      case 'google':
        return responseText.includes('æ€è€ƒ') || responseText.includes('åˆ†æ') || responseText.includes('reasoning') || 
               this.hasStructuredThinking(response)
      case 'anthropic':
        return responseText.includes('<thinking>') || responseText.includes('è®©æˆ‘æ€è€ƒ') || 
               responseText.includes('åˆ†æ') || this.hasStructuredThinking(response)
      default:
        return false
    }
  }

  private detectOpenAIThinking(response: string): boolean {
    const responseText = response.toLowerCase()
    
    // æ€è€ƒè¿‡ç¨‹æŒ‡ç¤ºè¯ï¼ˆåŸºäºæœ€ä½³å®è·µï¼‰
    const thinkingIndicators = [
      // ç›´æ¥æ€è€ƒæ ‡è®°
      '<thinking>', 'thinking:', 'æ€è€ƒï¼š', 'åˆ†æï¼š', 'æ¨ç†ï¼š',
      
      // æ­¥éª¤æ€§è¯æ±‡  
      'é¦–å…ˆ', 'ç„¶å', 'æ¥ç€', 'æœ€å', 'ç¬¬ä¸€æ­¥', 'ç¬¬äºŒæ­¥', 'ç¬¬ä¸‰æ­¥',
      'step 1', 'step 2', 'step 3', 'æ­¥éª¤1', 'æ­¥éª¤2',
      
      // è®¡ç®—è¿‡ç¨‹è¯æ±‡
      'è®¡ç®—', 'è®¡ç®—è¿‡ç¨‹', 'è§£é¢˜', 'æ¨å¯¼', 'éªŒè¯',
      'åŸä»·', 'æ‰“æŠ˜', 'æŠ˜æ‰£', 'æœ€ç»ˆä»·æ ¼',
      
      // åˆ†ææ€§è¯æ±‡
      'è®©æˆ‘', 'æˆ‘éœ€è¦', 'æˆ‘ä»¬æ¥', 'åˆ†æä¸€ä¸‹', 'è€ƒè™‘åˆ°',
      'å› æ­¤', 'æ‰€ä»¥', 'ç”±æ­¤å¯è§', 'å¯ä»¥å¾—å‡º',
      
      // æ¨ç†è¿‡ç¨‹
      'æ ¹æ®', 'åŸºäº', 'è€ƒè™‘', 'å‡è®¾', 'å¦‚æœ', 'é‚£ä¹ˆ'
    ]
    
    // è®¡ç®—åŒ¹é…çš„æŒ‡ç¤ºè¯æ•°é‡
    const indicatorCount = thinkingIndicators.filter(indicator => 
      responseText.includes(indicator)
    ).length
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æ„åŒ–æ€è€ƒ
    const hasStructure = this.hasStructuredThinking(response)
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°å­¦è®¡ç®—è¿‡ç¨‹
    const hasMathProcess = this.hasMathematicalReasoning(response)
    
    // ç»¼åˆåˆ¤æ–­ï¼š
    // 1. è‡³å°‘2ä¸ªæ€è€ƒæŒ‡ç¤ºè¯ + ç»“æ„åŒ–æ€ç»´
    // 2. è‡³å°‘3ä¸ªæ€è€ƒæŒ‡ç¤ºè¯ï¼ˆå³ä½¿æ²¡æœ‰æ˜æ˜¾ç»“æ„ï¼‰
    // 3. æœ‰æ˜ç¡®çš„æ•°å­¦æ¨ç†è¿‡ç¨‹
    // 4. æœ‰thinkingæ ‡ç­¾æˆ–æ˜ç¡®çš„åˆ†æè¿‡ç¨‹
    return (indicatorCount >= 2 && hasStructure) || 
           (indicatorCount >= 3) ||
           hasMathProcess ||
           responseText.includes('<thinking>') ||
           responseText.includes('åˆ†æè¿‡ç¨‹')
  }

  private hasStructuredThinking(response: string): boolean {
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–å·åˆ—è¡¨ (1. 2. 3. æˆ– ä¸€ã€äºŒã€ä¸‰ã€æˆ– æ­¥éª¤1ã€æ­¥éª¤2)
    const hasNumberedList = /[1-9]\.|[ä¸€äºŒä¸‰å››äº”]\s*ã€|æ­¥éª¤\s*[1-9]/.test(response)
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šæ®µè½ç»“æ„ï¼ˆè¶…è¿‡2ä¸ªæ¢è¡Œï¼‰
    const paragraphCount = response.split('\n').filter(line => line.trim().length > 0).length
    const hasMultipleParagraphs = paragraphCount > 2
    
    // æ£€æŸ¥é€»è¾‘è¿æ¥è¯å¯†åº¦
    const logicalWords = ['å› ä¸º', 'æ‰€ä»¥', 'ç„¶è€Œ', 'ä½†æ˜¯', 'å› æ­¤', 'ç”±äº', 'ç”±æ­¤', 'å¯è§']
    const logicalWordCount = logicalWords.filter(word => response.includes(word)).length
    
    return hasNumberedList || (hasMultipleParagraphs && logicalWordCount >= 2)
  }

  private hasMathematicalReasoning(response: string): boolean {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦è®¡ç®—è¿‡ç¨‹
    const mathPatterns = [
      /\d+\s*[Ã—*]\s*\d+/,           // ä¹˜æ³•ï¼š100 Ã— 0.8
      /\d+\s*[Ã·/]\s*\d+/,           // é™¤æ³•ï¼š100 Ã· 2  
      /\d+\s*[+]\s*\d+/,            // åŠ æ³•ï¼š80 + 20
      /\d+\s*[-]\s*\d+/,            // å‡æ³•ï¼š100 - 20
      /=\s*\d+/,                    // ç­‰å·ç»“æœï¼š= 72
      /0\.\d+/,                     // å°æ•°ï¼š0.8, 0.9
      /\d+%/,                       // ç™¾åˆ†æ¯”ï¼š80%
      /æ‰“.*æŠ˜/,                     // æ‰“æŠ˜ï¼šæ‰“8æŠ˜
      /æŠ˜æ‰£/,                       // æŠ˜æ‰£è¯æ±‡
    ]
    
    return mathPatterns.some(pattern => pattern.test(response))
  }

  private getDefaultCapabilities(apiType: string): {
    reasoning: boolean
    reasoningType: ReasoningType | null
    supportedParams: SupportedParams
  } {
    const defaultParams: SupportedParams = {
      temperature: true,
      maxTokens: 'max_tokens',
      streaming: true,
      systemMessage: true
    }

    if (apiType === 'openai') {
      return {
        reasoning: false,
        reasoningType: null,
        supportedParams: { ...defaultParams }
      }
    } else if (apiType === 'google') {
      return {
        reasoning: false,
        reasoningType: null,
        supportedParams: { ...defaultParams }
      }
    } else if (apiType === 'anthropic') {
      return {
        reasoning: false,
        reasoningType: null,
        supportedParams: { ...defaultParams }
      }
    }

    return {
      reasoning: false,
      reasoningType: null,
      supportedParams: defaultParams
    }
  }

  private createFailedCapabilities(
    basicResult: { connected: boolean; error?: string }, 
    apiType: string
  ): ModelCapabilities {
    return {
      reasoning: false,
      reasoningType: null,
      supportedParams: this.getDefaultCapabilities(apiType).supportedParams,
      testResult: {
        connected: basicResult.connected,
        reasoning: false,
        responseTime: 0,
        error: basicResult.error,
        timestamp: new Date()
      }
    }
  }

  // OpenAI o1ç³»åˆ—æ¨¡å‹çš„ç‰¹æ®Šè°ƒç”¨æ–¹æ³•
  private async callOpenAIWithO1Params(
    provider: ProviderConfig, 
    modelId: string, 
    messages: ChatMessage[]
  ): Promise<any> {
    // ç›´æ¥è°ƒç”¨OpenAI APIä»¥æ£€æµ‹o1ç³»åˆ—çš„reasoningå­—æ®µ
    try {
      if (!provider.baseUrl) {
        throw new Error('API URL æœªé…ç½®')
      }
      
      let apiUrl = provider.baseUrl.trim()
      if (apiUrl.includes('/chat/completions')) {
        // å·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨
      } else if (apiUrl.includes('/v1')) {
        apiUrl = apiUrl.replace(/\/+$/, '') + '/chat/completions'
      } else {
        apiUrl = apiUrl.replace(/\/+$/, '') + '/v1/chat/completions'
      }
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${provider.apiKey}`
        },
        body: JSON.stringify({
          model: modelId,
          messages: messages.map(msg => ({
            role: msg.role,
            content: msg.content
          })),
          max_completion_tokens: 100 // o1ç³»åˆ—ä½¿ç”¨max_completion_tokens
        })
      })

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`)
      }

      return await response.json()
    } catch (error) {
      throw error
    }
  }

  private async callOpenAIWithThinkingInstructions(
    provider: ProviderConfig, 
    modelId: string, 
    messages: ChatMessage[],
    preferStream?: boolean
  ): Promise<any> {
    // ä½¿ç”¨æœ€ä½³å®è·µçš„æ€è€ƒæŒ‡ä»¤
    const enhancedMessages: ChatMessage[] = [
      { 
        role: 'system', 
        content: 'è¯·åœ¨å›ç­”é—®é¢˜æ—¶å±•ç¤ºä½ çš„å®Œæ•´æ€è€ƒè¿‡ç¨‹ã€‚åŒ…æ‹¬ï¼š1ï¼‰åˆ†æé—®é¢˜ 2ï¼‰åˆ¶å®šè§£å†³æ­¥éª¤ 3ï¼‰æ‰§è¡Œè®¡ç®—æˆ–æ¨ç† 4ï¼‰éªŒè¯ç­”æ¡ˆã€‚è¯·æ˜ç¡®æ ‡å‡ºæ¯ä¸ªæ­¥éª¤ã€‚'
      },
      ...messages
    ]
    return await this.aiService.callAI(enhancedMessages, provider, modelId, preferStream || false)
  }


  private async callGeminiAPIRaw(
    provider: ProviderConfig, 
    modelId: string, 
    messages: ChatMessage[],
    _preferStream?: boolean
  ): Promise<any> {
    // ç›´æ¥è°ƒç”¨Gemini APIä»¥è·å–åŸå§‹å“åº”ç»“æ„
    try {
      // æ„å»ºGemini API URL
      if (!provider.baseUrl) {
        throw new Error('API URL æœªé…ç½®')
      }
      let apiUrl = provider.baseUrl.trim()
      
      // ç¡®ä¿ä»¥/v1betaç»“å°¾ï¼Œç„¶åæ‹¼æ¥æ¨¡å‹è·¯å¾„
      if (!apiUrl.endsWith('/v1beta')) {
        if (apiUrl.includes('/models/')) {
          apiUrl = apiUrl.split('/models/')[0]
        }
        if (!apiUrl.endsWith('/v1beta')) {
          apiUrl = apiUrl.replace(/\/+$/, '') + '/v1beta'
        }
      }
      
      // æ‹¼æ¥æ¨¡å‹ç‰¹å®šè·¯å¾„
      apiUrl = `${apiUrl}/models/${modelId}:generateContent`
      
      // æ·»åŠ API keyå‚æ•°
      const url = new URL(apiUrl)
      url.searchParams.set('key', provider.apiKey)
      
      // è½¬æ¢æ¶ˆæ¯æ ¼å¼
      const contents = messages.map(msg => ({
        role: msg.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: msg.content }]
      }))

      const requestBody = {
        contents,
        generationConfig: {
          temperature: 0.7
        }
      }

      const response = await fetch(url.toString(), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })

      if (!response.ok) {
        throw new Error(`Gemini API error: ${response.status} ${response.statusText}`)
      }

      return await response.json()
    } catch (error) {
      throw error
    }
  }


  // æ¸…ç†ç¼“å­˜
  public clearCache(): void {
    this.testCache.clear()
  }

  // è·å–ç¼“å­˜ç»Ÿè®¡
  public getCacheStats(): { size: number; keys: string[] } {
    return {
      size: this.testCache.size,
      keys: Array.from(this.testCache.keys())
    }
  }
}
```


## src/services/mockApiService.ts

```ts
/**
 * Mock API æœåŠ¡
 * åœ¨ debug æ¨¡å¼ä¸‹æ¨¡æ‹Ÿåç«¯ API å“åº”ï¼Œå®Œå…¨ä¸ä¾èµ–åç«¯
 */

// Mock æ•°æ®å­˜å‚¨ï¼ˆä½¿ç”¨ localStorage æŒä¹…åŒ–ï¼‰
const MOCK_STORAGE_KEY = 'yprompt_mock_data'

interface MockData {
  user: {
    id: number
    username: string
    name: string
    avatar: string
    email?: string
    auth_type: 'local'
    is_admin: number
    last_login_time?: string
  }
  prompts: any[]
  tags: any[]
  promptRules: any
}

// åˆå§‹åŒ– Mock æ•°æ®
function initMockData(): MockData {
  const stored = localStorage.getItem(MOCK_STORAGE_KEY)
  if (stored) {
    try {
      return JSON.parse(stored)
    } catch (e) {
      // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
    }
  }
  
  return {
    user: {
      id: 1,
      username: 'admin',
      name: 'ç®¡ç†å‘˜',
      avatar: '',
      email: 'admin@example.com',
      auth_type: 'local',
      is_admin: 1,
      last_login_time: new Date().toISOString()
    },
    prompts: [],
    tags: [],
    promptRules: null
  }
}

// ä¿å­˜ Mock æ•°æ®
function saveMockData(data: MockData) {
  localStorage.setItem(MOCK_STORAGE_KEY, JSON.stringify(data))
}

// è·å– Mock æ•°æ®
function getMockData(): MockData {
  return initMockData()
}

// æ¨¡æ‹Ÿå»¶è¿Ÿ
function delay(ms: number = 300): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms))
}

// ç”Ÿæˆç®€å•çš„ JWT tokenï¼ˆä»…ç”¨äº mockï¼‰
function generateMockToken(): string {
  return `mock_token_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
}

// Mock API å®ç°
export const mockApiService = {
  // ç™»å½•
  async login(username: string, password: string) {
    await delay(500)
    
    // éªŒè¯ç”¨æˆ·åå¯†ç ï¼ˆdebug æ¨¡å¼æ¥å—ä»»ä½•ç”¨æˆ·åå¯†ç ï¼Œæˆ–ä½¿ç”¨é»˜è®¤çš„ admin/admin123ï¼‰
    if (username === 'admin' && password === 'admin123') {
      const data = getMockData()
      const token = generateMockToken()
      
      // æ›´æ–°ç™»å½•æ—¶é—´
      data.user.last_login_time = new Date().toISOString()
      saveMockData(data)
      
      return {
        code: 200,
        message: 'ç™»å½•æˆåŠŸ',
        data: {
          token,
          user: data.user
        }
      }
    } else {
      // debug æ¨¡å¼ä¸‹ä¹Ÿå…è®¸å…¶ä»–ç”¨æˆ·åå¯†ç ç™»å½•ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
      const data = getMockData()
      const token = generateMockToken()
      
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      data.user.username = username
      data.user.name = username
      data.user.last_login_time = new Date().toISOString()
      saveMockData(data)
      
      return {
        code: 200,
        message: 'ç™»å½•æˆåŠŸï¼ˆDebug æ¨¡å¼ï¼‰',
        data: {
          token,
          user: data.user
        }
      }
    }
  },

  // è·å–è®¤è¯é…ç½®
  async getAuthConfig() {
    await delay(200)
    return {
      code: 200,
      data: {
        local_auth_enabled: true,
        login_username: 'admin'
      }
    }
  },

  // åˆ·æ–° Token
  async refreshToken(_oldToken: string) {
    await delay(200)
    const newToken = generateMockToken()
    return {
      code: 200,
      message: 'åˆ·æ–°æˆåŠŸ',
      data: {
        token: newToken
      }
    }
  },

  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getUserInfo() {
    await delay(200)
    const data = getMockData()
    return {
      code: 200,
      data: data.user
    }
  },

  // ç™»å‡º
  async logout() {
    await delay(200)
    return {
      code: 200,
      message: 'ç™»å‡ºæˆåŠŸ'
    }
  },

  // è·å–æç¤ºè¯åˆ—è¡¨
  async getPrompts(params?: any) {
    await delay(300)
    const data = getMockData()
    let prompts = [...data.prompts]
    
    // ç®€å•çš„è¿‡æ»¤é€»è¾‘
    if (params?.search) {
      const search = params.search.toLowerCase()
      prompts = prompts.filter(p => 
        p.title?.toLowerCase().includes(search) ||
        p.description?.toLowerCase().includes(search)
      )
    }
    
    if (params?.is_favorite) {
      prompts = prompts.filter(p => p.is_favorite === 1)
    }
    
    if (params?.tags && params.tags.length > 0) {
      prompts = prompts.filter(p => {
        const promptTags = (p.tags || '').split(',').map((t: string) => t.trim())
        return params.tags.some((tag: string) => promptTags.includes(tag))
      })
    }
    
    // åˆ†é¡µ
    const page = params?.page || 1
    const limit = params?.limit || 20
    const start = (page - 1) * limit
    const end = start + limit
    const items = prompts.slice(start, end)
    
    return {
      code: 200,
      data: {
        total: prompts.length,
        page,
        limit,
        items
      }
    }
  },

  // è·å–æç¤ºè¯è¯¦æƒ…
  async getPrompt(id: number) {
    await delay(200)
    const data = getMockData()
    const prompt = data.prompts.find((p: any) => p.id === id)
    
    if (!prompt) {
      return {
        code: 404,
        message: 'æç¤ºè¯ä¸å­˜åœ¨'
      }
    }
    
    return {
      code: 200,
      data: prompt
    }
  },

  // ä¿å­˜æç¤ºè¯
  async savePrompt(promptData: any) {
    await delay(500)
    const data = getMockData()
    const newPrompt = {
      id: Date.now(),
      user_id: data.user.id,
      ...promptData,
      is_favorite: 0,
      is_public: 0,
      view_count: 0,
      use_count: 0,
      create_time: new Date().toISOString(),
      update_time: new Date().toISOString(),
      current_version: '1.0.0',
      total_versions: 1
    }
    
    data.prompts.unshift(newPrompt)
    saveMockData(data)
    
    return {
      code: 200,
      message: 'ä¿å­˜æˆåŠŸ',
      data: newPrompt
    }
  },

  // æ›´æ–°æç¤ºè¯
  async updatePrompt(id: number, promptData: any) {
    await delay(500)
    const data = getMockData()
    const index = data.prompts.findIndex((p: any) => p.id === id)
    
    if (index === -1) {
      return {
        code: 404,
        message: 'æç¤ºè¯ä¸å­˜åœ¨'
      }
    }
    
    data.prompts[index] = {
      ...data.prompts[index],
      ...promptData,
      update_time: new Date().toISOString()
    }
    saveMockData(data)
    
    return {
      code: 200,
      message: 'æ›´æ–°æˆåŠŸ',
      data: data.prompts[index]
    }
  },

  // åˆ é™¤æç¤ºè¯
  async deletePrompt(id: number) {
    await delay(300)
    const data = getMockData()
    const index = data.prompts.findIndex((p: any) => p.id === id)
    
    if (index === -1) {
      return {
        code: 404,
        message: 'æç¤ºè¯ä¸å­˜åœ¨'
      }
    }
    
    data.prompts.splice(index, 1)
    saveMockData(data)
    
    return {
      code: 200,
      message: 'åˆ é™¤æˆåŠŸ'
    }
  },

  // æ”¶è—/å–æ¶ˆæ”¶è—
  async toggleFavorite(id: number, is_favorite: boolean) {
    await delay(300)
    const data = getMockData()
    const prompt = data.prompts.find((p: any) => p.id === id)
    
    if (!prompt) {
      return {
        code: 404,
        message: 'æç¤ºè¯ä¸å­˜åœ¨'
      }
    }
    
    prompt.is_favorite = is_favorite ? 1 : 0
    saveMockData(data)
    
    return {
      code: 200,
      message: is_favorite ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—æˆåŠŸ'
    }
  },

  // è®°å½•ä½¿ç”¨æ¬¡æ•°
  async recordPromptUse(id: number) {
    await delay(200)
    const data = getMockData()
    const prompt = data.prompts.find((p: any) => p.id === id)
    
    if (prompt) {
      prompt.use_count = (prompt.use_count || 0) + 1
      saveMockData(data)
    }
    
    return {
      code: 200,
      message: 'è®°å½•æˆåŠŸ'
    }
  },

  // è·å–æ ‡ç­¾åˆ—è¡¨
  async getTags() {
    await delay(200)
    const data = getMockData()
    return {
      code: 200,
      data: data.tags || []
    }
  },

  // è·å–çƒ­é—¨æ ‡ç­¾
  async getPopularTags(limit: number = 10) {
    await delay(200)
    const data = getMockData()
    // ç®€å•çš„çƒ­é—¨æ ‡ç­¾é€»è¾‘ï¼ˆæŒ‰ä½¿ç”¨æ¬¡æ•°æ’åºï¼‰
    const tags = [...(data.tags || [])]
      .sort((a: any, b: any) => (b.use_count || 0) - (a.use_count || 0))
      .slice(0, limit)
    
    return {
      code: 200,
      data: tags
    }
  },

  // åˆ›å»ºæ ‡ç­¾
  async createTag(tag_name: string) {
    await delay(300)
    const data = getMockData()
    const existingTag = data.tags.find((t: any) => t.tag_name === tag_name)
    
    if (existingTag) {
      return {
        code: 400,
        message: 'æ ‡ç­¾å·²å­˜åœ¨'
      }
    }
    
    const newTag = {
      id: Date.now(),
      tag_name,
      user_id: data.user.id,
      use_count: 0,
      create_time: new Date().toISOString()
    }
    
    data.tags.push(newTag)
    saveMockData(data)
    
    return {
      code: 200,
      message: 'åˆ›å»ºæˆåŠŸ',
      data: newTag
    }
  },

  // åˆ é™¤æ ‡ç­¾
  async deleteTag(id: number) {
    await delay(300)
    const data = getMockData()
    const index = data.tags.findIndex((t: any) => t.id === id)
    
    if (index === -1) {
      return {
        code: 404,
        message: 'æ ‡ç­¾ä¸å­˜åœ¨'
      }
    }
    
    data.tags.splice(index, 1)
    saveMockData(data)
    
    return {
      code: 200,
      message: 'åˆ é™¤æˆåŠŸ'
    }
  },

  // è·å–ç”¨æˆ·æç¤ºè¯è§„åˆ™
  async getUserPromptRules() {
    await delay(200)
    const data = getMockData()
    return {
      code: 200,
      data: data.promptRules || null,
      message: data.promptRules ? 'è·å–æˆåŠŸ' : 'ä½¿ç”¨é»˜è®¤è§„åˆ™'
    }
  },

  // ä¿å­˜ç”¨æˆ·æç¤ºè¯è§„åˆ™
  async saveUserPromptRules(rules: any) {
    await delay(500)
    const data = getMockData()
    data.promptRules = {
      ...data.promptRules,
      ...rules,
      user_id: data.user.id,
      update_time: new Date().toISOString()
    }
    saveMockData(data)
    
    return {
      code: 200,
      message: 'ä¿å­˜æˆåŠŸ',
      data: data.promptRules
    }
  },

  // åˆ é™¤ç”¨æˆ·æç¤ºè¯è§„åˆ™
  async deleteUserPromptRules(fields?: string[]) {
    await delay(300)
    const data = getMockData()
    
    if (!fields || fields.length === 0) {
      // åˆ é™¤æ‰€æœ‰
      data.promptRules = null
    } else {
      // åˆ é™¤æŒ‡å®šå­—æ®µ
      if (!data.promptRules) {
        data.promptRules = {}
      }
      fields.forEach(field => {
        delete (data.promptRules as any)[field]
      })
    }
    
    saveMockData(data)
    
    return {
      code: 200,
      message: 'åˆ é™¤æˆåŠŸ'
    }
  }
}

// æ£€æŸ¥æ˜¯å¦å¯ç”¨ debug æ¨¡å¼
export function isDebugMode(): boolean {
  return import.meta.env.VITE_DEBUG_MODE === 'true' || 
         import.meta.env.MODE === 'debug' ||
         localStorage.getItem('yprompt_debug_mode') === 'true'
}

// é€šç”¨è¯·æ±‚æ–¹æ³•ï¼ˆåœ¨ debug æ¨¡å¼ä¸‹ä½¿ç”¨ mockï¼‰
export async function mockRequest<T = any>(
  method: string,
  url: string,
  data?: any
): Promise<T> {
  if (!isDebugMode()) {
    throw new Error('Mock API åªèƒ½åœ¨ debug æ¨¡å¼ä¸‹ä½¿ç”¨')
  }
  
  // è§£æ URL å’Œå‚æ•°
  const [path, queryString] = url.split('?')
  const params: any = {}
  if (queryString) {
    queryString.split('&').forEach(param => {
      const [key, value] = param.split('=')
      params[key] = decodeURIComponent(value || '')
    })
  }
  
  // è·¯ç”±åˆ°å¯¹åº”çš„ mock API
  if (path === '/api/auth/local/login' && method === 'POST') {
    return mockApiService.login(data.username, data.password) as T
  }
  
  if (path === '/api/auth/config' && method === 'GET') {
    return mockApiService.getAuthConfig() as T
  }
  
  if (path === '/api/auth/refresh' && method === 'POST') {
    const token = localStorage.getItem('yprompt_token') || ''
    return mockApiService.refreshToken(token) as T
  }
  
  if (path === '/api/auth/userinfo' && method === 'GET') {
    return mockApiService.getUserInfo() as T
  }
  
  if (path === '/api/auth/logout' && method === 'POST') {
    return mockApiService.logout() as T
  }
  
  if (path.startsWith('/api/prompts') && method === 'GET') {
    if (path.match(/^\/api\/prompts\/(\d+)$/)) {
      const id = parseInt(path.match(/^\/api\/prompts\/(\d+)$/)![1])
      return mockApiService.getPrompt(id) as T
    } else {
      return mockApiService.getPrompts(params) as T
    }
  }
  
  if (path === '/api/prompts' && method === 'POST') {
    return mockApiService.savePrompt(data) as T
  }
  
  if (path.match(/^\/api\/prompts\/(\d+)$/) && method === 'PUT') {
    const id = parseInt(path.match(/^\/api\/prompts\/(\d+)$/)![1])
    return mockApiService.updatePrompt(id, data) as T
  }
  
  if (path.match(/^\/api\/prompts\/(\d+)$/) && method === 'DELETE') {
    const id = parseInt(path.match(/^\/api\/prompts\/(\d+)$/)![1])
    return mockApiService.deletePrompt(id) as T
  }
  
  if (path.match(/^\/api\/prompts\/(\d+)\/favorite$/) && method === 'POST') {
    const id = parseInt(path.match(/^\/api\/prompts\/(\d+)\/favorite$/)![1])
    return mockApiService.toggleFavorite(id, data.is_favorite) as T
  }
  
  if (path.match(/^\/api\/prompts\/(\d+)\/use$/) && method === 'POST') {
    const id = parseInt(path.match(/^\/api\/prompts\/(\d+)\/use$/)![1])
    return mockApiService.recordPromptUse(id) as T
  }
  
  if (path === '/api/tags' && method === 'GET') {
    return mockApiService.getTags() as T
  }
  
  if (path === '/api/tags/popular' && method === 'GET') {
    return mockApiService.getPopularTags(params.limit) as T
  }
  
  if (path === '/api/tags' && method === 'POST') {
    return mockApiService.createTag(data.tag_name) as T
  }
  
  if (path.match(/^\/api\/tags\/(\d+)$/) && method === 'DELETE') {
    const id = parseInt(path.match(/^\/api\/tags\/(\d+)$/)![1])
    return mockApiService.deleteTag(id) as T
  }
  
  if (path === '/api/prompt-rules' && method === 'GET') {
    return mockApiService.getUserPromptRules() as T
  }
  
  if (path === '/api/prompt-rules' && method === 'POST') {
    return mockApiService.saveUserPromptRules(data) as T
  }
  
  if (path === '/api/prompt-rules' && method === 'DELETE') {
    return mockApiService.deleteUserPromptRules() as T
  }
  
  // é»˜è®¤è¿”å› 404
  return {
    code: 404,
    message: `Mock API æœªå®ç°: ${method} ${path}`
  } as T
}

```


## src/services/playground/aiPlaygroundService.ts

```ts
import type { PlaygroundCapability } from '@/config/playgroundInstructions'
import { AIService, type ChatMessage } from '@/services/aiService'
import type { ProviderConfig } from '@/stores/providerStore'

export interface PlaygroundMessage {
  id: string
  role: 'user' | 'assistant' | 'system'
  content: string
  timestamp: number
}

export interface PlaygroundAIOptions {
  messages: PlaygroundMessage[]
  provider: ProviderConfig
  modelId: string
  capability?: PlaygroundCapability
  stream?: boolean
  onChunk?: (chunk: string) => void
  systemPrompt?: string
}

export class PlaygroundAIService {
  private static instance: PlaygroundAIService
  private aiService: AIService

  private constructor() {
    this.aiService = AIService.getInstance()
  }

  static getInstance() {
    if (!this.instance) {
      this.instance = new PlaygroundAIService()
    }
    return this.instance
  }

  async send(options: PlaygroundAIOptions) {
    const { messages, provider, modelId, capability, stream = true, onChunk, systemPrompt } = options
    const aiMessages: ChatMessage[] = []

    const trimmedSystemPrompt = systemPrompt?.trim()
    if (trimmedSystemPrompt) {
      aiMessages.push({
        role: 'system',
        content: trimmedSystemPrompt
      })
    }

    if (capability?.prompt) {
      aiMessages.push({
        role: 'system',
        content: capability.prompt
      })
    }

    aiMessages.push(
      ...messages.map((msg) => ({
        role: (msg.role === 'assistant' ? 'assistant' : 'user') as ChatMessage['role'],
        content: msg.content
      }))
    )

    // é»˜è®¤å…è®¸æµå¼è¾“å‡ºï¼Œé™¤éæ˜ç¡®ç¦ç”¨
    const allowStream = true
    const useStream = stream && allowStream

    return await this.aiService.callAI(aiMessages, provider, modelId, useStream, onChunk)
  }
}

```


## src/services/playground/artifactParser.ts

````ts
export type ArtifactType =
  | 'html'
  | 'drawio'
  | 'mermaid'
  | 'echarts'
  | 'svg'
  | 'markdown'
  | 'mindmap'
  | 'json'

export interface Artifact {
  type: ArtifactType
  content: string
}

const extractMarkdown = (text: string) => {
  const startRegex = /```(markdown|md)/gi
  let match: RegExpExecArray | null
  let lastStartIndex = -1
  let lastLang: string | null = null

  while ((match = startRegex.exec(text)) !== null) {
    lastStartIndex = match.index
    lastLang = match[1]
  }

  if (lastStartIndex === -1) return null

  const startFence = lastLang === 'md' ? '```md' : '```markdown'
  const contentStart = lastStartIndex + startFence.length

  const closingIndex = text.lastIndexOf('```')
  if (closingIndex <= contentStart) {
    return null
  }

  return text.slice(contentStart, closingIndex).trim()
}

export const extractArtifact = (text: string): Artifact | null => {
  const markdownContent = extractMarkdown(text)
  if (markdownContent) {
    return { type: 'markdown', content: markdownContent }
  }

  const xmlMatch = text.match(/```xml\s*([\s\S]*?)```/i)
  if (xmlMatch) {
    const content = xmlMatch[1].trim()
    if (content.includes('<mxfile') || content.includes('<mxGraphModel')) {
      return { type: 'drawio', content }
    }
  }

  const mermaidMatch = text.match(/```mermaid\s*([\s\S]*?)```/i)
  if (mermaidMatch) return { type: 'mermaid', content: mermaidMatch[1].trim() }

  const echartsMatch = text.match(/```echarts\s*([\s\S]*?)```/i)
  if (echartsMatch) return { type: 'echarts', content: echartsMatch[1].trim() }

  const svgMatch = text.match(/```(?:svg)\s*([\s\S]*?)```/i)
  if (svgMatch) {
    const content = svgMatch[1].trim()
    if (content.startsWith('<svg')) {
      return { type: 'svg', content }
    }
  }

  const htmlMatch = text.match(/```html\s*([\s\S]*?)```/i)
  if (htmlMatch) return { type: 'html', content: htmlMatch[1].trim() }

  const mdMatch = text.match(/```markdown\s*([\s\S]*?)```/i)
  if (mdMatch) return { type: 'markdown', content: mdMatch[1].trim() }

  const jsonMatch = text.match(/```json\s*([\s\S]*?)```/i)
  if (jsonMatch) {
    let content = jsonMatch[1].trim()
    const firstBrace = content.indexOf('{')
    const lastBrace = content.lastIndexOf('}')

    if (firstBrace !== -1 && lastBrace !== -1) {
      const jsonCandidate = content.substring(firstBrace, lastBrace + 1)

      try {
        const parsed = JSON.parse(jsonCandidate)
        const normalized = parsed && typeof parsed === 'object'
          ? (parsed.mindmap ?? parsed)
          : null

        if (normalized && typeof normalized === 'object') {
          const hasTreeStructure =
            Array.isArray(normalized.children) ||
            Array.isArray((normalized as any).nodes)

          const hasNaming =
            !!(normalized as any).name ||
            !!(normalized as any).title ||
            !!(parsed as any).mindmap

          if (hasTreeStructure && hasNaming) {
            return { type: 'mindmap', content: jsonCandidate }
          }
        }
      } catch {
        // ignore parse errors and fallback to string heuristics
      }

      if (jsonCandidate.includes('"series"') || jsonCandidate.includes('"xAxis"')) {
        return { type: 'echarts', content: jsonCandidate }
      }

      if (
        jsonCandidate.includes('"children"') &&
        (jsonCandidate.includes('"name"') || jsonCandidate.includes('"title"'))
      ) {
        return { type: 'mindmap', content: jsonCandidate }
      }

      if (jsonCandidate.includes('"mindmap"') && jsonCandidate.includes('"nodes"')) {
        return { type: 'mindmap', content: jsonCandidate }
      }

      return { type: 'json', content: jsonCandidate }
    }
  }

  return null
}

````


## src/services/promptGeneratorService.ts

````ts
import { AIService } from './aiService'
import type { ProviderConfig } from '@/stores/providerStore'
import { useProviderStore } from '@/stores/providerStore'
import { promptConfigManager } from '@/config/prompts'

export class PromptGeneratorService {
  private static instance: PromptGeneratorService
  private aiService: AIService

  private constructor() {
    this.aiService = AIService.getInstance()
  }

  public static getInstance(): PromptGeneratorService {
    if (!PromptGeneratorService.instance) {
      PromptGeneratorService.instance = new PromptGeneratorService()
    }
    return PromptGeneratorService.instance
  }

  // æ ¼å¼åŒ–å˜é‡ä¸ºæç¤ºè¯éƒ¨åˆ†
  private formatVariablesForPrompt(variables: string[]): string {
    if (!variables || variables.length === 0 || variables.every(v => v.trim() === '')) {
      return ''
    }
    const nonEmptyVariables = variables.filter(v => v.trim() !== '')
    if (nonEmptyVariables.length === 0) {
      return ''
    }
    
    return `
---
Variable Integration:
The final prompt must be designed to be used in a programmatic context. As such, it needs to include specific placeholders or variables. You must incorporate the following variables into the generated prompt where it makes logical sense to do so.

Variable List:
${nonEmptyVariables.map(v => `- \`${v}\``).join('\n')}

For example, if a variable is \`{{user_topic}}\`, you might include a sentence like "The user will provide the \`{{user_topic}}\` for you to write about."
---
    `
  }

  // è·å–æµå¼æ¨¡å¼è®¾ç½®ï¼ˆä¸providerStoreä¿æŒåŒæ­¥ï¼‰
  private getStreamMode(): boolean {
    const providerStore = useProviderStore()
    return providerStore.streamMode
  }

  // è·å–ç³»ç»Ÿæç¤ºè¯å…³é”®æŒ‡ä»¤
  public async getSystemPromptThinkingPoints(
    description: string,
    model: string,
    language: string,
    variables: string[],
    provider?: ProviderConfig,
    onStreamUpdate?: (content: string) => void
  ): Promise<string[]> {
    const variablesSection = this.formatVariablesForPrompt(variables)

    // è·å–é…ç½®çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™
    const finalRules = promptConfigManager.getFinalPromptGenerationRules()
    
    const systemContent = finalRules.THINKING_POINTS_EXTRACTION.replace('{language}', language)

    const masterPrompt = `${variablesSection}
User's Description for AI Persona:
---
${description}
---`

    const systemMessage = {
      role: 'system' as const,
      content: systemContent
    }

    const userMessage = {
      role: 'user' as const,
      content: masterPrompt
    }
    

    if (!provider) {
      throw new Error('è¯·å…ˆé…ç½®AIæä¾›å•†')
    }

    const streamMode = this.getStreamMode()
    
    // å¦‚æœæœ‰æµå¼å›è°ƒä¸”å¯ç”¨æµå¼æ¨¡å¼ï¼Œè®¾ç½®æµå¼æ›´æ–°
    if (onStreamUpdate && streamMode) {
      this.aiService.setStreamUpdateCallback((chunk: string) => {
        onStreamUpdate(chunk)
      })
    }
    
    const response = await this.aiService.callAI([systemMessage, userMessage], provider, model, streamMode)
    
    // æ¸…ç†æµå¼å›è°ƒ
    if (onStreamUpdate && streamMode) {
      this.aiService.clearStreamUpdateCallback()
    }
    
    // è§£æç»“æœ
    const points = response
      .split('\n')
      .map(s => s.replace(/^[*-]\s*/, '').trim())
      .filter(Boolean)
    
    return points
  }

  // ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
  public async generateSystemPrompt(
    description: string,
    model: string,
    language: string,
    variables: string[],
    thinkingPoints?: string[],
    provider?: ProviderConfig,
    onStreamUpdate?: (content: string) => void
  ): Promise<string> {
    // ä½¿ç”¨å†…ç½®çš„ç³»ç»Ÿæç¤ºè¯è§„åˆ™
    const SYSTEM_PROMPT_RULES = promptConfigManager.getSystemPromptRules()

    const variablesSection = this.formatVariablesForPrompt(variables)
    const thinkingPointsSection = (thinkingPoints && thinkingPoints.length > 0 && thinkingPoints.some(p => p.trim() !== ''))
      ? `
---
Key Directives to Incorporate:
You must intelligently integrate the following specific directives into the final System Prompt. These are non-negotiable and should guide the core logic and personality of the AI.

Directives:
${thinkingPoints.filter(p => p.trim() !== '').map(p => `- ${p}`).join('\n')}
---
      `
      : ''

    // è·å–é…ç½®çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™
    const finalRules = promptConfigManager.getFinalPromptGenerationRules()
    
    const languageDisplay = language === 'zh' ? 'ä¸­æ–‡' : 'English'
    
    const systemContent = `${finalRules.SYSTEM_PROMPT_GENERATION}

---
Here are the prompt engineering rules I will follow:
${SYSTEM_PROMPT_RULES}
---`.replace('{language_display}', languageDisplay)

    const masterPrompt = `${variablesSection}
${thinkingPointsSection}
User's Original Description:
---
${description}
---`

    const systemMessage = {
      role: 'system' as const,
      content: systemContent
    }

    const userMessage = {
      role: 'user' as const,
      content: masterPrompt
    }

    if (!provider) {
      throw new Error('è¯·å…ˆé…ç½®AIæä¾›å•†')
    }

    const streamMode = this.getStreamMode()
    
    // å¦‚æœæœ‰æµå¼å›è°ƒä¸”å¯ç”¨æµå¼æ¨¡å¼ï¼Œè®¾ç½®æµå¼æ›´æ–°
    if (onStreamUpdate && streamMode) {
      this.aiService.setStreamUpdateCallback((chunk: string) => {
        onStreamUpdate(chunk)
      })
    }
    
    const response = await this.aiService.callAI([systemMessage, userMessage], provider, model, streamMode)
    
    // æ¸…ç†æµå¼å›è°ƒ
    if (onStreamUpdate && streamMode) {
      this.aiService.clearStreamUpdateCallback()
    }
    
    // æ¸…ç†markdownä»£ç å—æ ¼å¼
    let cleaned = response.replace(/```/g, '').trim()
    
    // å¦‚æœå¼€å¤´æœ‰"markdown"å­—ç¬¦ï¼Œç§»é™¤å®ƒ
    if (cleaned.startsWith('markdown\n')) {
      cleaned = cleaned.substring(9) // ç§»é™¤"markdown\n"
    } else if (cleaned.startsWith('markdown')) {
      cleaned = cleaned.substring(8) // ç§»é™¤"markdown"
    }
    
    return cleaned.trim()
  }

  // è·å–ä¼˜åŒ–å»ºè®®
  public async getOptimizationAdvice(
    promptToAnalyze: string,
    promptType: 'system' | 'user',
    model: string,
    language: string,
    variables: string[],
    provider?: ProviderConfig,
    onStreamUpdate?: (content: string) => void
  ): Promise<string[]> {
    const variablesSection = this.formatVariablesForPrompt(variables)

    // è·å–é…ç½®çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™
    const finalRules = promptConfigManager.getFinalPromptGenerationRules()
    
    const promptTypeCapitalized = promptType.charAt(0).toUpperCase() + promptType.slice(1)
    
    const systemContent = finalRules.OPTIMIZATION_ADVICE_GENERATION.replace('{promptType}', promptType).replace('{language}', language)

    const masterPrompt = `${variablesSection}
${promptTypeCapitalized} Prompt to Analyze:
---
${promptToAnalyze}
---`

    const systemMessage = {
      role: 'system' as const,
      content: systemContent
    }

    const userMessage = {
      role: 'user' as const,
      content: masterPrompt
    }

    if (!provider) {
      throw new Error('è¯·å…ˆé…ç½®AIæä¾›å•†')
    }

    const streamMode = this.getStreamMode()
    
    // å¦‚æœæœ‰æµå¼å›è°ƒä¸”å¯ç”¨æµå¼æ¨¡å¼ï¼Œè®¾ç½®æµå¼æ›´æ–°
    if (onStreamUpdate && streamMode) {
      this.aiService.setStreamUpdateCallback((chunk: string) => {
        onStreamUpdate(chunk)
      })
    }
    
    const response = await this.aiService.callAI([systemMessage, userMessage], provider, model, streamMode)
    
    // æ¸…ç†æµå¼å›è°ƒ
    if (onStreamUpdate && streamMode) {
      this.aiService.clearStreamUpdateCallback()
    }
    
    // è§£æç»“æœ
    const advice = response
      .split('\n')
      .map(s => s.replace(/^[*-]\s*/, '').trim())
      .filter(Boolean)
    
    return advice
  }

  // åº”ç”¨ä¼˜åŒ–å»ºè®®
  public async applyOptimizationAdvice(
    originalPrompt: string,
    advice: string[],
    promptType: 'system' | 'user',
    model: string,
    language: string,
    variables: string[],
    provider?: ProviderConfig,
    onStreamUpdate?: (content: string) => void
  ): Promise<string> {
    // ä½¿ç”¨å†…ç½®çš„ç³»ç»Ÿæç¤ºè¯è§„åˆ™
    const SYSTEM_PROMPT_RULES = promptConfigManager.getSystemPromptRules()

    const variablesSection = this.formatVariablesForPrompt(variables)
    const adviceSection = advice.map(a => `- ${a}`).join('\n')

    // è·å–é…ç½®çš„æœ€ç»ˆæç¤ºè¯ç”Ÿæˆè§„åˆ™
    const finalRules = promptConfigManager.getFinalPromptGenerationRules()
    
    const languageDisplay = language === 'zh' ? 'ä¸­æ–‡' : 'English'
    const promptTypeCapitalized = promptType.charAt(0).toUpperCase() + promptType.slice(1)
    
    const systemContent = `${finalRules.OPTIMIZATION_APPLICATION}

---
Here are the core principles of elite prompt engineering I will follow:
${SYSTEM_PROMPT_RULES}
---`.replace('{promptType}', promptType)
      .replace('{language_display}', languageDisplay)
      .replace('{promptType_capitalized}', promptTypeCapitalized)

    const masterPrompt = `${variablesSection}
Original ${promptTypeCapitalized} Prompt:
---
${originalPrompt}
---

Optimization Suggestions to Apply:
---
${adviceSection}
---`

    const systemMessage = {
      role: 'system' as const,
      content: systemContent
    }

    const userMessage = {
      role: 'user' as const,
      content: masterPrompt
    }
    

    if (!provider) {
      throw new Error('è¯·å…ˆé…ç½®AIæä¾›å•†')
    }

    const streamMode = this.getStreamMode()
    
    // å¦‚æœæœ‰æµå¼å›è°ƒä¸”å¯ç”¨æµå¼æ¨¡å¼ï¼Œè®¾ç½®æµå¼æ›´æ–°
    if (onStreamUpdate && streamMode) {
      this.aiService.setStreamUpdateCallback((chunk: string) => {
        onStreamUpdate(chunk)
      })
    }
    
    const response = await this.aiService.callAI([systemMessage, userMessage], provider, model, streamMode)
    
    // æ¸…ç†æµå¼å›è°ƒ
    if (onStreamUpdate && streamMode) {
      this.aiService.clearStreamUpdateCallback()
    }
    
    // æ¸…ç†markdownä»£ç å—æ ¼å¼
    let cleaned = response.replace(/```/g, '').trim()
    
    // å¦‚æœå¼€å¤´æœ‰"markdown"å­—ç¬¦ï¼Œç§»é™¤å®ƒ
    if (cleaned.startsWith('markdown\n')) {
      cleaned = cleaned.substring(9) // ç§»é™¤"markdown\n"
    } else if (cleaned.startsWith('markdown')) {
      cleaned = cleaned.substring(8) // ç§»é™¤"markdown"
    }
    
    return cleaned.trim()
  }
}
````


## src/services/promptOptimizationService.ts

```ts
// @ts-nocheck
import { AIService } from './aiService'
import { useProviderStore } from '@/stores/providerStore'
import PROMPT_OPTIMIZATION_CONFIG from '@/config/prompts/promptOptimization'
import type { Suggestion, PromptAnalysis, ModelTestConfig, TestResult } from '@/stores/optimizeStore'

/**
 * æç¤ºè¯ä¼˜åŒ–æœåŠ¡ç±»
 * é›†æˆAIæœåŠ¡ï¼Œæä¾›æç¤ºè¯åˆ†æå’Œä¼˜åŒ–åŠŸèƒ½
 */
export class PromptOptimizationService {
  private static instance: PromptOptimizationService
  private aiService: AIService

  private constructor() {
    this.aiService = AIService.getInstance()
  }

  public static getInstance(): PromptOptimizationService {
    if (!PromptOptimizationService.instance) {
      PromptOptimizationService.instance = new PromptOptimizationService()
    }
    return PromptOptimizationService.instance
  }

  /**
   * åˆ†ææç¤ºè¯è´¨é‡
   */
  async analyzePrompt(prompt: string, type: 'system' | 'user'): Promise<PromptAnalysis> {
    const providerStore = useProviderStore()
    const currentProvider = providerStore.currentProvider
    const currentModel = providerStore.currentModel

    const messages = [
      {
        role: 'system' as const,
        content: PROMPT_OPTIMIZATION_CONFIG.PROMPT_ANALYSIS_PROMPT
      },
      {
        role: 'user' as const,
        content: `${PROMPT_OPTIMIZATION_CONFIG.PROMPT_ANALYSIS_PROMPT}\n\n${prompt}`
      }
    ]

    try {
      const response = await this.aiService.callAI(
        messages,
        currentProvider,
        currentModel?.id || ''
      )

      // å°è¯•è§£æJSONå“åº”
      let analysisData: PromptAnalysis
      try {
        analysisData = JSON.parse(response)
      } catch (error) {
        console.warn('Failed to parse AI analysis response, using fallback:', error)
        // åˆ›å»ºé»˜è®¤åˆ†æç»“æœ
        analysisData = this.createFallbackAnalysis(prompt, type)
      }

      return analysisData
    } catch (error) {
      console.error('Prompt analysis failed:', error)
      throw new Error('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®')
    }
  }

  /**
   * ç”Ÿæˆä¼˜åŒ–å»ºè®®
   */
  async generateSuggestions(
    systemPrompt: string,
    userPrompt: string
  ): Promise<Suggestion[]> {
    const providerStore = useProviderStore()
    const currentProvider = providerStore.currentProvider
    const currentModel = providerStore.currentModel
    const allSuggestions: Suggestion[] = []

    // å¹¶è¡Œç”Ÿæˆç³»ç»Ÿå’Œç”¨æˆ·æç¤ºè¯çš„å»ºè®®
    const promises = []

    if (systemPrompt.trim()) {
      promises.push(this.generateSuggestionsForPrompt(
        systemPrompt,
        'system',
        PROMPT_OPTIMIZATION_CONFIG.SYSTEM_OPTIMIZATION_PROMPT,
        currentProvider,
        currentModel?.id || ''
      ))
    }

    if (userPrompt.trim()) {
      promises.push(this.generateSuggestionsForPrompt(
        userPrompt,
        'user',
        PROMPT_OPTIMIZATION_CONFIG.USER_OPTIMIZATION_PROMPT,
        currentProvider,
        currentModel?.id || ''
      ))
    }

    try {
      const results = await Promise.all(promises)
      results.forEach(suggestions => {
        allSuggestions.push(...suggestions)
      })

      return allSuggestions
    } catch (error) {
      console.error('Generate suggestions failed:', error)
      throw new Error('ç”Ÿæˆå»ºè®®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®')
    }
  }

  /**
   * ä¸ºç‰¹å®šæç¤ºè¯ç”Ÿæˆå»ºè®®
   */
  private async generateSuggestionsForPrompt(
    prompt: string,
    type: 'system' | 'user',
    systemPrompt: string,
    provider: any,
    modelId: string
  ): Promise<Suggestion[]> {
    const messages = [
      {
        role: 'system' as const,
        content: systemPrompt
      },
      {
        role: 'user' as const,
        content: prompt
      }
    ]

    const response = await this.aiService.callAI(messages, provider, modelId)

    try {
      const data = JSON.parse(response)
      return (data.suggestions || []).map((s: any, index: number) => ({
        id: `${type}_sug_${Date.now()}_${index}`,
        type: s.type || 'modify',
        category: s.category || 'general',
        title: s.title || 'ä¼˜åŒ–å»ºè®®',
        description: s.description || '',
        reason: s.reason || '',
        expectedEffect: s.expectedEffect || '',
        priority: s.priority || 'medium',
        content: s.content || '',
        applied: false
      }))
    } catch (error) {
      console.warn('Failed to parse suggestions response:', error)
      return []
    }
  }

  /**
   * åº”ç”¨ä¼˜åŒ–å»ºè®®
   */
  async applySuggestions(
    originalPrompt: string,
    suggestions: Suggestion[],
    _promptType: 'system' | 'user'
  ): Promise<string> {
    const providerStore = useProviderStore()
    const currentProvider = providerStore.currentProvider
    const currentModel = providerStore.currentModel

    const messages = [
      {
        role: 'system' as const,
        content: PROMPT_OPTIMIZATION_CONFIG.APPLY_SUGGESTIONS_PROMPT
      },
      {
        role: 'user' as const,
        content: PROMPT_OPTIMIZATION_CONFIG.APPLY_SUGGESTIONS_PROMPT
          .replace('{originalPrompt}', originalPrompt)
          .replace('{suggestions}', JSON.stringify(suggestions, null, 2))
      }
    ]

    try {
      return await this.aiService.callAI(messages, currentProvider, currentModel?.id || '')
    } catch (error) {
      console.error('Apply suggestions failed:', error)
      throw new Error('åº”ç”¨å»ºè®®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®')
    }
  }

  /**
   * æµ‹è¯•æç¤ºè¯æ•ˆæœ
   */
  async testPrompt(
    systemPrompt: string,
    userPrompt: string,
    testCase: string,
    config: ModelTestConfig
  ): Promise<TestResult> {
    try {
      // æ„å»ºæµ‹è¯•æ¶ˆæ¯
      const messages: Array<{role: 'system' | 'user' | 'assistant', content: string}> = []
      
      if (systemPrompt.trim()) {
        messages.push({
          role: 'system' as const,
          content: systemPrompt
        })
      }

      if (userPrompt.trim()) {
        messages.push({
          role: 'user' as const,
          content: userPrompt
        })
      }

      messages.push({
        role: 'user' as const,
        content: testCase
      })

      // è°ƒç”¨AIæœåŠ¡
      const startTime = Date.now()
      const response = await this.aiService.callAI(
        messages,
        config.provider,
        config.modelId,
        false // ä¸ä½¿ç”¨æµå¼è¾“å‡º
      )
      const endTime = Date.now()

      // ä¼°ç®—tokenæ•°é‡ï¼ˆç®€å•å®ç°ï¼‰
      const tokenCount = Math.ceil(response.length / 4)

      return {
        id: `test_${Date.now()}_${Math.random()}`,
        testCase,
        response,
        responseTime: endTime - startTime,
        tokenCount,
        modelId: config.modelId,
        modelName: config.modelId,
        status: 'success',
        rating: 0
      }
    } catch (error) {
      console.error('Prompt test failed:', error)
      return {
        id: `test_${Date.now()}_${Math.random()}`,
        testCase,
        response: `Error: ${error}`,
        responseTime: 0,
        tokenCount: 0,
        modelId: config.modelId,
        modelName: config.modelId,
        status: 'failed',
        rating: 0
      }
    }
  }

  /**
   * æ‰¹é‡æµ‹è¯•
   */
  async batchTest(
    systemPrompt: string,
    userPrompt: string,
    testCases: string[],
    configs: ModelTestConfig[]
  ): Promise<TestResult[]> {
    const results: TestResult[] = []

    for (const testCase of testCases) {
      for (const config of configs) {
        const result = await this.testPrompt(systemPrompt, userPrompt, testCase, config)
        results.push(result)
      }
    }

    return results
  }

  /**
   * å¿«é€Ÿä¼˜åŒ–ï¼ˆå•æ­¥éª¤ä¼˜åŒ–ï¼‰
   */
  async quickOptimize(prompt: string, _type: 'system' | 'user'): Promise<string> {
    const providerStore = useProviderStore()
    const currentProvider = providerStore.currentProvider
    const currentModel = providerStore.currentModel

    const messages = [
      {
        role: 'system' as const,
        content: PROMPT_OPTIMIZATION_CONFIG.QUICK_OPTIMIZATION_PROMPT
      },
      {
        role: 'user' as const,
        content: `${PROMPT_OPTIMIZATION_CONFIG.QUICK_OPTIMIZATION_PROMPT}\n\n${prompt}`
      }
    ]

    try {
      return await this.aiService.callAI(messages, currentProvider, currentModel?.id || '')
    } catch (error) {
      console.error('Quick optimization failed:', error)
      throw new Error('å¿«é€Ÿä¼˜åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®')
    }
  }

  /**
   * åˆ›å»ºå¤‡ç”¨åˆ†æç»“æœ
   */
  private createFallbackAnalysis(prompt: string, type: 'system' | 'user'): PromptAnalysis {
    const wordCount = prompt.length
    const estimated_tokens = Math.ceil(wordCount / 4)
    
    // åŸºäºç®€å•è§„åˆ™çš„è¯„åˆ†
    let overallScore = 70
    
    if (type === 'system') {
      if (prompt.includes('ä½ æ˜¯ä¸€ä¸ª') || prompt.includes('You are a')) {
        overallScore += 10
      }
      if (prompt.includes('ä½ çš„ä»»åŠ¡æ˜¯') || prompt.includes('Your task is')) {
        overallScore += 5
      }
      if (prompt.includes('è¯·æŒ‰ç…§') || prompt.includes('Please follow')) {
        overallScore += 5
      }
    } else {
      if (prompt.length > 50) {
        overallScore += 5
      }
      if (prompt.includes('è¯·') || prompt.includes('Please')) {
        overallScore += 5
      }
    }

    return {
      overall_score: Math.min(overallScore, 100),
      analysis: {
        role: { score: overallScore, status: 'good', feedback: 'è§’è‰²å®šä¹‰åŸºæœ¬å®Œå–„' },
        task: { score: overallScore, status: 'good', feedback: 'ä»»åŠ¡æè¿°è¾ƒä¸ºæ¸…æ™°' },
        format: { score: overallScore - 10, status: 'needs_improvement', feedback: 'è¾“å‡ºæ ¼å¼éœ€è¦æ›´è¯¦ç»†çš„è¯´æ˜' },
        constraints: { score: overallScore - 5, status: 'needs_improvement', feedback: 'çº¦æŸæ¡ä»¶å¯ä»¥æ›´æ˜ç¡®' },
        example: { score: overallScore - 20, status: 'needs_improvement', feedback: 'ç¼ºå°‘ç¤ºä¾‹è¯´æ˜' },
        language: { score: overallScore, status: 'good', feedback: 'è¯­è¨€è¡¨è¾¾æ¸…æ™°' }
      },
      suggestions: [
        { area: 'format', suggestion: 'æ·»åŠ è¯¦ç»†çš„è¾“å‡ºæ ¼å¼è¯´æ˜' },
        { area: 'example', suggestion: 'æä¾›è¾“å…¥è¾“å‡ºç¤ºä¾‹' }
      ],
      language: 'zh',
      word_count: wordCount,
      estimated_tokens
    }
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const promptOptimizationService = PromptOptimizationService.getInstance()
```


## src/services/settingsApi.ts

```ts
/**
 * Settings API Service
 * Handles communication with backend settings API
 */

import type { ProviderConfig } from '@/stores/providerStore'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''

export interface Settings {
  providers: ProviderConfig[]
}

export interface SettingsResponse {
  code: number
  data: Settings
  message?: string
}

/**
 * Get settings from backend
 */
export async function getSettings(): Promise<Settings> {
  const token = localStorage.getItem('yprompt_token')

  console.log('[settingsApi] è¯·æ±‚é…ç½®ï¼ŒAPI URL:', `${API_BASE_URL}/api/settings/`)

  const response = await fetch(`${API_BASE_URL}/api/settings/`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  })

  // å¦‚æœ API è¯·æ±‚æˆåŠŸï¼Œä½¿ç”¨ API æ•°æ®
  if (response.ok) {
    const result: SettingsResponse = await response.json()
    console.log('[settingsApi] API å®Œæ•´å“åº”:', JSON.stringify(result, null, 2))

    if (result.code === 200 && result.data && result.data.providers) {
      console.log('[settingsApi] ä½¿ç”¨ API æ•°æ®ï¼Œproviders æ•°é‡:', result.data.providers.length)
      return result.data
    }
  }

  // å¦‚æœ API å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é…ç½®ä½œä¸ºåå¤‡æ–¹æ¡ˆ
  console.warn('[settingsApi] API è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é…ç½®ä½œä¸ºåå¤‡æ–¹æ¡ˆ')

  // è¿”å›ç¡¬ç¼–ç çš„é…ç½®ï¼ˆåŸºäº .setting.jsonï¼‰
  const fallbackSettings: Settings = {
    providers: [
      {
        id: "DeepSeek",
        name: "DeepSeek-Offical",
        type: "openai",
        apiKey: "sk-c092ab16b28f4860910202f8fb9cd480",
        baseUrl: "https://api.deepseek.com/v1",
        models: [
          { id: "deepseek-chat", name: "deepseek-chat", apiType: "openai" },
          { id: "deepseek-reasoner", name: "deepseek-reasoner", apiType: "openai" }
        ]
      },
      {
        id: "MoonShot",
        name: "MoonShot-Offical",
        type: "openai",
        apiKey: "sk-vcaBs3TQXlpczsaJxKR8JftXIWEr8OfFWSiSfc8qNCnI2dCv",
        baseUrl: "https://api.moonshot.cn/v1",
        models: [
          { id: "kimi-k2-0905-preview", name: "kimi-k2-0905-preview", apiType: "openai" },
          { id: "kimi-k2-thinking", name: "kimi-k2-thinking", apiType: "openai" }
        ]
      }
    ]
  }

  console.log('[settingsApi] ä½¿ç”¨åå¤‡é…ç½®ï¼Œproviders æ•°é‡:', fallbackSettings.providers.length)
  return fallbackSettings
}



```


## src/services/versionService.ts

```ts
export interface VersionInfo {
  id: number
  prompt_id: number
  version_number: string
  version_tag: string | null
  version_type: 'manual' | 'auto' | 'rollback' | 'import'
  change_summary: string
  change_log: string | null
  change_type: 'major' | 'minor' | 'patch'
  created_by: number
  author_name: string
  author_avatar: string | null
  use_count: number
  rollback_count: number
  content_size: number
  create_time: string
  parent_version_id: number | null
  
  title?: string
  description?: string
  final_prompt?: string
  language?: string
  format?: string
  tags?: string[]
  
  // ç”¨æˆ·æç¤ºè¯ä¸Šä¸‹æ–‡
  system_prompt?: string
  conversation_history?: string
}

export interface VersionListResponse {
  code: number
  message?: string
  data: {
    total: number
    page: number
    limit: number
    items: VersionInfo[]
  }
}

export interface VersionDetailResponse {
  code: number
  message?: string
  data: VersionInfo
}

export interface CreateVersionRequest {
  change_type: 'major' | 'minor' | 'patch'
  change_summary: string
  change_log?: string
  version_tag?: string
}

export interface CreateVersionResponse {
  code: number
  message: string
  data: {
    version_id: number
    version_number: string
    create_time: string
  }
}

export interface RollbackRequest {
  change_summary?: string
}

export interface RollbackResponse {
  code: number
  message: string
  data: {
    new_version: string
    rollback_to_version: string
  }
}

export class VersionService {
  private static getApiBaseUrl() {
    return import.meta.env.VITE_API_BASE_URL || ''
  }

  private static getAuthHeaders() {
    const token = localStorage.getItem('yprompt_token')
    if (!token) {
      throw new Error('è¯·å…ˆç™»å½•')
    }
    return {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  }

  static async getVersionList(
    promptId: number, 
    page: number = 1, 
    limit: number = 20,
    tag?: string
  ): Promise<VersionListResponse> {
    const params = new URLSearchParams({
      page: page.toString(),
      limit: limit.toString()
    })
    if (tag) {
      params.append('tag', tag)
    }

    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}/versions?${params}`, {
      headers: this.getAuthHeaders()
    })

    return response.json()
  }

  static async getVersionDetail(
    promptId: number, 
    versionId: number
  ): Promise<VersionDetailResponse> {
    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}/versions/${versionId}`, {
      headers: this.getAuthHeaders()
    })

    return response.json()
  }

  static async createVersion(
    promptId: number, 
    data: CreateVersionRequest
  ): Promise<CreateVersionResponse> {
    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}`, {
      method: 'POST',
      headers: this.getAuthHeaders(),
      body: JSON.stringify(data)
    })

    return response.json()
  }

  static async rollbackToVersion(
    promptId: number, 
    versionId: number, 
    data?: RollbackRequest
  ): Promise<RollbackResponse> {
    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}/versions/${versionId}/rollback`, {
      method: 'POST',
      headers: this.getAuthHeaders(),
      body: JSON.stringify(data || {})
    })

    return response.json()
  }

  static async updateVersionTag(
    promptId: number, 
    versionId: number, 
    versionTag: string
  ): Promise<{ code: number; message: string }> {
    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}/versions/${versionId}/tag`, {
      method: 'PUT',
      headers: this.getAuthHeaders(),
      body: JSON.stringify({ version_tag: versionTag })
    })

    return response.json()
  }

  static async deleteVersion(
    promptId: number, 
    versionId: number
  ): Promise<{ code: number; message: string }> {
    const response = await fetch(`${this.getApiBaseUrl()}/api/versions/${promptId}/versions/${versionId}`, {
      method: 'DELETE',
      headers: this.getAuthHeaders()
    })

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }

    return response.json()
  }
}

```


## src/stores/authStore.ts

```ts
/**
 * è®¤è¯çŠ¶æ€ç®¡ç†
 * ç®¡ç†ç”¨æˆ·ç™»å½•ã€tokenã€ç”¨æˆ·ä¿¡æ¯
 * æ”¯æŒ debug æ¨¡å¼ï¼Œåœ¨ debug æ¨¡å¼ä¸‹ä½¿ç”¨ mock API
 */
import { create } from 'zustand'
import { isDebugMode, mockRequest } from '@/services/mockApiService'

export interface User {
  id: number
  username: string
  name: string
  avatar: string
  email?: string
  auth_type: 'local'
  is_admin: number
  last_login_time?: string
}

interface AuthState {
  token: string | null
  user: User | null
  isLoading: boolean
  
  setToken: (token: string | null) => void
  setUser: (user: User | null) => void
  restoreUser: () => void
  loginWithPassword: (username: string, password: string) => Promise<{ success: boolean; message?: string }>
  getAuthConfig: () => Promise<{ local_auth_enabled: boolean; login_username?: string } | null>
  refreshToken: () => Promise<boolean>
  fetchUserInfo: () => Promise<boolean>
  logout: () => Promise<void>
  initialize: () => Promise<void>
}

export const useAuthStore = create<AuthState>((set, get) => ({
  token: localStorage.getItem('yprompt_token'),
  user: null,
  isLoading: false,
  
  setToken: (newToken: string | null) => {
    set({ token: newToken })
    if (newToken) {
      localStorage.setItem('yprompt_token', newToken)
    } else {
      localStorage.removeItem('yprompt_token')
    }
  },
  
  setUser: (newUser: User | null) => {
    set({ user: newUser })
    if (newUser) {
      localStorage.setItem('yprompt_user', JSON.stringify(newUser))
    } else {
      localStorage.removeItem('yprompt_user')
    }
  },
  
  restoreUser: () => {
    const savedUser = localStorage.getItem('yprompt_user')
    if (savedUser) {
      try {
        const user = JSON.parse(savedUser)
        set({ user })
      } catch (error) {
        localStorage.removeItem('yprompt_user')
      }
    }
  },
  
  loginWithPassword: async (username: string, password: string) => {
    set({ isLoading: true })
    try {
      let result: any
      
      if (isDebugMode()) {
        result = await mockRequest('POST', '/api/auth/local/login', { username, password })
      } else {
        const apiBaseUrl = import.meta.env.VITE_API_BASE_URL || ''
        const url = `${apiBaseUrl}/api/auth/local/login`
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        })
        
        if (!response.ok) {
          try {
            const errorResult = await response.json()
            return {
              success: false,
              message: errorResult.message || `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`
            }
          } catch (parseError) {
            return {
              success: false,
              message: `ç½‘ç»œé”™è¯¯: ${response.status} ${response.statusText}`
            }
          }
        }
        
        result = await response.json()
      }
      
      if (result.code === 200 && result.data) {
        get().setToken(result.data.token)
        get().setUser(result.data.user)
        
        // ç™»å½•æˆåŠŸåï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½äº‘ç«¯æç¤ºè¯é…ç½®
        try {
          const { promptConfigManager } = await import('@/config/prompts')
          await promptConfigManager.forceReloadFromCloud()
        } catch (error) {
          console.error('ç™»å½•ååŠ è½½äº‘ç«¯é…ç½®å¤±è´¥:', error)
        }
        
        return { success: true }
      } else {
        return {
          success: false,
          message: result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
        }
      }
    } catch (error) {
      console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error)
      if (error instanceof TypeError && error.message.includes('fetch')) {
        return {
          success: false,
          message: 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ API åœ°å€é…ç½®'
        }
      }
      return {
        success: false,
        message: error instanceof Error ? error.message : 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
      }
    } finally {
      set({ isLoading: false })
    }
  },
  
  getAuthConfig: async () => {
    try {
      let result: any
      
      if (isDebugMode()) {
        result = await mockRequest('GET', '/api/auth/config')
      } else {
        const response = await fetch(`${import.meta.env.VITE_API_BASE_URL || ''}/api/auth/config`)
        result = await response.json()
      }
      
      if (result.code === 200 && result.data) {
        return result.data
      }
      return null
    } catch (error) {
      return null
    }
  },
  
  refreshToken: async () => {
    const { token } = get()
    if (!token) return false
    
    try {
      let result: any
      
      if (isDebugMode()) {
        result = await mockRequest('POST', '/api/auth/refresh')
      } else {
        const response = await fetch(`${import.meta.env.VITE_API_BASE_URL || ''}/api/auth/refresh`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        })
        result = await response.json()
      }
      
      if (result.code === 200 && result.data) {
        get().setToken(result.data.token)
        return true
      }
      return false
    } catch (error) {
      return false
    }
  },
  
  fetchUserInfo: async () => {
    const { token } = get()
    if (!token) return false
    
    try {
      let result: any
      
      if (isDebugMode()) {
        result = await mockRequest('GET', '/api/auth/userinfo')
      } else {
        const response = await fetch(`${import.meta.env.VITE_API_BASE_URL || ''}/api/auth/userinfo`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        })
        result = await response.json()
      }
      
      if (result.code === 200 && result.data) {
        get().setUser(result.data)
        return true
      }
      return false
    } catch (error) {
      return false
    }
  },
  
  logout: async () => {
    const { token } = get()
    if (token) {
      try {
        if (isDebugMode()) {
          await mockRequest('POST', '/api/auth/logout')
        } else {
          await fetch(`${import.meta.env.VITE_API_BASE_URL || ''}/api/auth/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
            },
          })
        }
      } catch (error) {
        // å¿½ç•¥ç™»å‡ºé”™è¯¯ï¼Œç»§ç»­æ¸…é™¤æœ¬åœ°çŠ¶æ€
      }
    }
    
    get().setToken(null)
    get().setUser(null)
    
    sessionStorage.removeItem('yprompt_config_session_loaded')
    
    const keysToRemove = [
      'user_prompt_optimize_data',
      'yprompt_optimize_active_mode',
      'yprompt_optimize_cache',
      'yprompt_user_optimize_active_tab',
      'yprompt_optimize_loaded_user_prompt',
      'yprompt_optimize_result',
      'yprompt_generate_messages',
      'yprompt_generate_prompt_data',
      'yprompt_settings_cache',
    ]
    
    keysToRemove.forEach(key => {
      localStorage.removeItem(key)
    })
    
    const allKeys = Object.keys(localStorage)
    allKeys.forEach(key => {
      if (key.startsWith('yprompt_') || key.startsWith('user_prompt_')) {
        if (key !== 'yprompt_token' && key !== 'yprompt_user') {
          localStorage.removeItem(key)
        }
      }
    })
  },
  
  initialize: async () => {
    get().restoreUser()
    
    const { token, user } = get()
    if (token && !user) {
      await get().fetchUserInfo()
    }
  }
}))

```


## src/stores/navigationStore.ts

```ts
import { create } from 'zustand'

export type ModuleType = 'generate' | 'optimize' | 'playground' | 'library'

export interface ModuleConfig {
  id: ModuleType
  name: string
  icon: string
  path: string
  color: string
}

interface NavigationState {
  currentModule: ModuleType
  modules: ModuleConfig[]
  setCurrentModule: (module: ModuleType) => void
  getModuleByPath: (path: string) => ModuleConfig | undefined
  getCurrentModuleConfig: () => ModuleConfig
}

const modules: ModuleConfig[] = [
  {
    id: 'generate',
    name: 'ç”Ÿæˆ',
    icon: 'ğŸ ',
    path: '/generate',
    color: '#3B82F6'
  },
  {
    id: 'optimize',
    name: 'ä¼˜åŒ–',
    icon: 'âš¡',
    path: '/optimize',
    color: '#F59E0B'
  },
  {
    id: 'playground',
    name: 'æ“ç»ƒåœº',
    icon: 'ğŸ¯',
    path: '/playground',
    color: '#10B981'
  },
  {
    id: 'library',
    name: 'æ¨¡æ¿åº“',
    icon: 'ğŸ“š',
    path: '/library',
    color: '#8B5CF6'
  }
]

export const useNavigationStore = create<NavigationState>((set, get) => ({
  currentModule: 'generate',
  modules,
  
  setCurrentModule: (module: ModuleType) => {
    set({ currentModule: module })
  },
  
  getModuleByPath: (path: string) => {
    return modules.find(m => m.path === path)
  },
  
  getCurrentModuleConfig: () => {
    const { currentModule } = get()
    return modules.find(m => m.id === currentModule) || modules[0]
  }
}))

```


## src/stores/notificationStore.ts

```ts
import { create } from 'zustand'

export interface Notification {
  id: string
  message: string
  type: 'success' | 'error' | 'warning' | 'info'
  duration?: number
}

export interface ConfirmDialog {
  id: string
  message: string
  confirmText?: string
  cancelText?: string
  type?: 'warning' | 'info'
  resolve: (value: boolean) => void
}

interface NotificationState {
  notifications: Notification[]
  confirmDialog: ConfirmDialog | null
  addNotification: (notification: Omit<Notification, 'id'>) => string
  removeNotification: (id: string) => void
  showConfirmDialog: (options: Omit<ConfirmDialog, 'id' | 'resolve'>) => Promise<boolean>
  closeConfirmDialog: (confirmed: boolean) => void
  success: (message: string, duration?: number) => string
  error: (message: string, duration?: number) => string
  warning: (message: string, duration?: number) => string
  info: (message: string, duration?: number) => string
}

export const useNotificationStore = create<NotificationState>((set, get) => ({
  notifications: [],
  confirmDialog: null,
  
  addNotification: (notification: Omit<Notification, 'id'>) => {
    const id = Date.now().toString()
    const newNotification: Notification = {
      id,
      ...notification,
      duration: notification.duration ?? 3000,
    }
    
    set((state) => ({
      notifications: [...state.notifications, newNotification]
    }))
    
    // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
    if (newNotification.duration && newNotification.duration > 0) {
      setTimeout(() => {
        get().removeNotification(id)
      }, newNotification.duration)
    }
    
    return id
  },
  
  removeNotification: (id: string) => {
    set((state) => ({
      notifications: state.notifications.filter(n => n.id !== id)
    }))
  },
  
  showConfirmDialog: (options: Omit<ConfirmDialog, 'id' | 'resolve'>): Promise<boolean> => {
    return new Promise((resolve) => {
      const id = `confirm-${Date.now()}`
      set({
        confirmDialog: {
          id,
          ...options,
          resolve
        }
      })
    })
  },
  
  closeConfirmDialog: (confirmed: boolean) => {
    const dialog = get().confirmDialog
    if (dialog) {
      dialog.resolve(confirmed)
      set({ confirmDialog: null })
    }
  },
  
  success: (message: string, duration?: number) => {
    return get().addNotification({ message, type: 'success', duration })
  },
  
  error: (message: string, duration?: number) => {
    return get().addNotification({ message, type: 'error', duration })
  },
  
  warning: (message: string, duration?: number) => {
    return get().addNotification({ message, type: 'warning', duration })
  },
  
  info: (message: string, duration?: number) => {
    return get().addNotification({ message, type: 'info', duration })
  }
}))

```


## src/stores/optimizeStore.ts

```ts
import { create } from 'zustand'

// ç±»å‹å®šä¹‰
export interface Suggestion {
  id: string
  type: 'add' | 'modify' | 'remove'
  category: 'role' | 'profile' | 'skills' | 'goal' | 'rules' | 'workflow' | 'format' | 'example' | 'initialization' | 'task' | 'context' | 'constraints' | 'language'
  title: string
  description: string
  reason: string
  expectedEffect: string
  priority: 'high' | 'medium' | 'low'
  content?: string
  applied?: boolean
}

export interface PromptAnalysis {
  overall_score: number
  analysis: {
    role: { score: number; status: string; feedback: string }
    task: { score: number; status: string; feedback: string }
    format: { score: number; status: string; feedback: string }
    constraints: { score: number; status: string; feedback: string }
    example: { score: number; status: string; feedback: string }
    language: { score: number; status: string; feedback: string }
  }
  suggestions: Array<{ area: string; suggestion: string }>
  language: 'zh' | 'en'
  word_count: number
  estimated_tokens: number
  issues?: string[]
}

export interface Version {
  id: string
  version: string
  systemPrompt: string
  userPrompt: string
  changes: Change[]
  appliedSuggestions: string[]
  createdAt: Date
  note?: string
  tag?: 'initial' | 'draft' | 'beta' | 'stable' | 'production' | 'archived' | 'rollback'
}

export interface Change {
  type: 'add' | 'modify' | 'remove'
  field: 'system' | 'user'
  content: string
  position?: { start: number; end: number }
}

export interface TestResult {
  id: string
  testCase: string
  response: string
  responseTime: number
  tokenCount: number
  modelId: string
  modelName: string
  status: 'success' | 'failed'
  rating: number
}

export interface ModelTestConfig {
  provider: string
  modelId: string
  temperature: number
  maxTokens: number
  promptVersion: 'original' | 'optimized'
}

export interface SingleTestResult {
  response: string
  responseTime: number
  tokenCount: number
  model: string
}

interface OptimizeState {
  // è¾“å…¥çŠ¶æ€
  systemPrompt: string
  userPrompt: string
  importedPromptId: string | null
  loadedPromptId: number | null

  // åˆ†æçŠ¶æ€
  analysis: PromptAnalysis | null
  isAnalyzing: boolean

  // ä¼˜åŒ–çŠ¶æ€
  suggestions: Suggestion[]
  selectedSuggestions: string[]
  optimizedPrompts: {
    system: string
    user: string
  }
  isGeneratingSuggestions: boolean
  isApplyingSuggestions: boolean

  // ç‰ˆæœ¬ç®¡ç†
  versions: Version[]
  currentVersion: string
  isVersionLoading: boolean

  // æµ‹è¯•çŠ¶æ€
  testCases: string[]
  currentTestCase: string
  testResults: TestResult[]
  isTesting: boolean

  // UI çŠ¶æ€
  activeTab: 'input' | 'optimize' | 'test'
  showDiffView: boolean
  showVersionHistory: boolean

  // Actions
  resetOptimization: () => void
  setPrompts: (system: string, user: string, promptId?: string) => void
  setLoadedPromptId: (promptId: number | null) => void
  setAnalysis: (analysisData: PromptAnalysis) => void
  setSuggestions: (suggestionsData: Suggestion[]) => void
  toggleSuggestion: (suggestionId: string) => void
  selectAllSuggestions: () => void
  deselectAllSuggestions: () => void
  setOptimizedPrompts: (system: string, user: string) => void
  addTestCase: (testCase: string) => void
  setCurrentTestCase: (testCase: string) => void
  setTestResults: (results: TestResult[]) => void
  switchTab: (tab: 'input' | 'optimize' | 'test') => void
  toggleDiffView: () => void
  toggleVersionHistory: () => void
  switchVersion: (version: string) => void
}

export const useOptimizeStore = create<OptimizeState>((set, get) => ({
  // State
  systemPrompt: '',
  userPrompt: '',
  importedPromptId: null,
  loadedPromptId: null,
  analysis: null,
  isAnalyzing: false,
  suggestions: [],
  selectedSuggestions: [],
  optimizedPrompts: {
    system: '',
    user: ''
  },
  isGeneratingSuggestions: false,
  isApplyingSuggestions: false,
  versions: [],
  currentVersion: 'original',
  isVersionLoading: false,
  testCases: [],
  currentTestCase: '',
  testResults: [],
  isTesting: false,
  activeTab: 'input',
  showDiffView: false,
  showVersionHistory: false,

  // Actions
  resetOptimization: () => {
    set({
      systemPrompt: '',
      userPrompt: '',
      importedPromptId: null,
      loadedPromptId: null,
      analysis: null,
      suggestions: [],
      selectedSuggestions: [],
      optimizedPrompts: { system: '', user: '' },
      versions: [],
      currentVersion: 'original',
      testCases: [],
      testResults: [],
      activeTab: 'input'
    })
  },

  setPrompts: (system: string, user: string, promptId?: string) => {
    set({
      systemPrompt: system,
      userPrompt: user,
      importedPromptId: promptId || null
    })
  },

  setLoadedPromptId: (promptId: number | null) => {
    set({ loadedPromptId: promptId })
  },

  setAnalysis: (analysisData: PromptAnalysis) => {
    set({ analysis: analysisData })
  },

  setSuggestions: (suggestionsData: Suggestion[]) => {
    set({
      suggestions: suggestionsData,
      selectedSuggestions: suggestionsData.map((s) => s.id)
    })
  },

  toggleSuggestion: (suggestionId: string) => {
    const state = get()
    const index = state.selectedSuggestions.indexOf(suggestionId)
    if (index > -1) {
      set({
        selectedSuggestions: state.selectedSuggestions.filter((id) => id !== suggestionId)
      })
    } else {
      set({
        selectedSuggestions: [...state.selectedSuggestions, suggestionId]
      })
    }
  },

  selectAllSuggestions: () => {
    const state = get()
    set({
      selectedSuggestions: state.suggestions.map((s) => s.id)
    })
  },

  deselectAllSuggestions: () => {
    set({ selectedSuggestions: [] })
  },

  setOptimizedPrompts: (system: string, user: string) => {
    const state = get()
    const newVersion: Version = {
      id: `v_${Date.now()}`,
      version: `V${state.versions.length + 1}`,
      systemPrompt: system,
      userPrompt: user,
      changes: generateChanges(state.systemPrompt, system, state.userPrompt, user),
      appliedSuggestions: [...state.selectedSuggestions],
      createdAt: new Date(),
      tag: 'draft'
    }
    set({
      optimizedPrompts: { system, user },
      versions: [...state.versions, newVersion],
      currentVersion: newVersion.version
    })
  },

  addTestCase: (testCase: string) => {
    const state = get()
    if (testCase.trim() && !state.testCases.includes(testCase.trim())) {
      set({
        testCases: [...state.testCases, testCase.trim()]
      })
    }
  },

  setCurrentTestCase: (testCase: string) => {
    set({ currentTestCase: testCase })
  },

  setTestResults: (results: TestResult[]) => {
    set({ testResults: results })
  },

  switchTab: (tab: 'input' | 'optimize' | 'test') => {
    set({ activeTab: tab })
  },

  toggleDiffView: () => {
    set((state) => ({ showDiffView: !state.showDiffView }))
  },

  toggleVersionHistory: () => {
    set((state) => ({ showVersionHistory: !state.showVersionHistory }))
  },

  switchVersion: (version: string) => {
    const state = get()
    const versionData = state.versions.find((v) => v.version === version)
    if (versionData) {
      set({
        currentVersion: version,
        optimizedPrompts: {
          system: versionData.systemPrompt,
          user: versionData.userPrompt
        }
      })
    }
  }
}))

// è¾…åŠ©å‡½æ•°
function generateChanges(
  oldSystem: string,
  newSystem: string,
  oldUser: string,
  newUser: string
): Change[] {
  const changes: Change[] = []

  if (oldSystem !== newSystem) {
    changes.push({
      type: 'modify',
      field: 'system',
      content: newSystem
    })
  }

  if (oldUser !== newUser) {
    changes.push({
      type: 'modify',
      field: 'user',
      content: newUser
    })
  }

  return changes
}

```


## src/stores/promptStore.ts

```ts
import { create } from 'zustand'
import { savePrompt, type SavePromptData } from '@/services/apiService'

export interface MessageAttachment {
  id: string
  name: string
  type: 'image' | 'document' | 'audio' | 'video'
  mimeType: string
  size: number
  data: string // Base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
  url?: string // ç”¨äºé¢„è§ˆçš„ä¸´æ—¶URLï¼ˆå¦‚æœéœ€è¦ï¼‰
}

export interface ChatMessage {
  id?: string  // æ¶ˆæ¯IDï¼Œç”¨äºæ›´æ–°æ¶ˆæ¯
  type: 'user' | 'ai'
  content: string
  timestamp: string
  isProgress?: boolean  // æ ‡è®°æ˜¯å¦ä¸ºè¿›åº¦æ¶ˆæ¯
  isDeleted?: boolean   // æ ‡è®°æ˜¯å¦è¢«åˆ é™¤
  isEditing?: boolean   // æ ‡è®°æ˜¯å¦æ­£åœ¨ç¼–è¾‘
  originalContent?: string  // ç¼–è¾‘æ—¶ä¿å­˜åŸå§‹å†…å®¹
  attachments?: MessageAttachment[]  // é™„ä»¶åˆ—è¡¨
}

export interface CollectedData {
  taskDefinition: string
  context: string
  outputFormat: string
  qualityCriteria: string
  executionParams: string
}

export interface PromptData {
  requirementReport: string // éœ€æ±‚æ€»ç»“æŠ¥å‘Š
  thinkingPoints?: string[] // GPromptå…³é”®æŒ‡ä»¤
  initialPrompt?: string    // GPromptåˆå§‹æç¤ºè¯
  advice?: string[]         // GPromptä¼˜åŒ–å»ºè®®
  generatedPrompt: string | {
    zh: string
    en: string
  } | {
    markdown: { zh: string, en: string }
    xml: { zh: string, en: string }
  }  // æ”¯æŒäºŒç»´ç¼“å­˜ï¼šæ ¼å¼ x è¯­è¨€
  optimizedPrompt: {
    zh: string
    en: string
  }
}

interface Step {
  id: string
  title: string
  description: string
}

interface PromptState {
  currentStep: number
  currentStepUserMessages: number
  chatMessages: ChatMessage[]
  isTyping: boolean
  isGenerating: boolean
  showPreview: boolean
  currentLanguage: 'zh' | 'en'
  isAutoMode: boolean
  isInitialized: boolean
  currentExecutionStep: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null
  collectedData: CollectedData
  promptData: PromptData
  steps: Step[]
  
  // Zustand compatibility methods
  getState: () => PromptState
  setState: (partial: Partial<PromptState> | ((state: PromptState) => Partial<PromptState>)) => void
  
  // Actions
  addMessage: (type: 'user' | 'ai', content: string, attachments?: MessageAttachment[], options?: { id?: string, isProgress?: boolean }) => void
  addOrUpdateProgressMessage: (content: string, messageId?: string) => void
  clearChat: () => void
  nextStep: () => void
  updateCollectedData: (stepId: string, value: string) => void
  deleteMessage: (messageId: string) => void
  updateMessage: (messageId: string, content: string) => void
  startEditMessage: (messageId: string) => void
  saveEditMessage: (messageId: string, newContent: string) => void
  cancelEditMessage: (messageId: string) => void
  getValidMessages: () => ChatMessage[]
  clearProgressMessages: () => void
  savePromptToLibrary: (data: SavePromptData) => Promise<void>
  saveToBackend: (title: string, description?: string, tags?: string[], promptType?: string) => Promise<{ success: boolean; promptId?: number; error?: string }>
  setShowPreview: (show: boolean) => void
  setCurrentLanguage: (lang: 'zh' | 'en') => void
  setIsAutoMode: (auto: boolean) => void
  setIsGenerating: (generating: boolean) => void
  setIsTyping: (typing: boolean) => void
  setCurrentExecutionStep: (step: 'report' | 'thinking' | 'initial' | 'advice' | 'final' | null) => void
}

const steps: Step[] = [
  {
    id: 'taskDefinition',
    title: 'ä»»åŠ¡å®šä¹‰',
    description: 'æ˜ç¡®AIåŠ©æ‰‹çš„æ ¸å¿ƒä»»åŠ¡å’Œä¸»è¦åŠŸèƒ½'
  },
  {
    id: 'context',
    title: 'ä½¿ç”¨åœºæ™¯',
    description: 'äº†è§£AIçš„ä½¿ç”¨ç¯å¢ƒå’Œç›®æ ‡ç”¨æˆ·'
  },
  {
    id: 'outputFormat',
    title: 'è¾“å‡ºæ ¼å¼',
    description: 'å®šä¹‰AIå›ç­”çš„ç»“æ„ã€æ ¼å¼å’Œé£æ ¼'
  },
  {
    id: 'qualityCriteria',
    title: 'è´¨é‡è¦æ±‚',
    description: 'ç¡®å®šæˆåŠŸæ ‡å‡†å’Œè´¨é‡æœŸæœ›'
  },
  {
    id: 'executionParams',
    title: 'å·¥ä½œæ–¹å¼',
    description: 'è®¾å®šAIçš„æ€è€ƒæ–¹å¼å’Œäº’åŠ¨é£æ ¼'
  },
  {
    id: 'optimization',
    title: 'æœ€ç»ˆç¡®è®¤',
    description: 'ç¡®è®¤ä¿¡æ¯å®Œæ•´æ€§å¹¶ç”Ÿæˆæç¤ºè¯'
  }
]

export const usePromptStore = create<PromptState>((set, get) => ({
  currentStep: 0,
  currentStepUserMessages: 0,
  chatMessages: [],
  isTyping: false,
  isGenerating: false,
  showPreview: false,
  currentLanguage: 'zh',
  isAutoMode: true,
  isInitialized: false,
  currentExecutionStep: null,
  collectedData: {
    taskDefinition: '',
    context: '',
    outputFormat: '',
    qualityCriteria: '',
    executionParams: ''
  },
  promptData: {
    requirementReport: '',
    generatedPrompt: '', // æ”¹ä¸ºå­—ç¬¦ä¸²åˆå§‹åŒ–
    optimizedPrompt: {
      zh: '',
      en: ''
    }
  },
  steps,
  
  addMessage: (type, content, attachments, options) => {
    const message: ChatMessage = {
      id: options?.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type,
      content,
      timestamp: new Date().toISOString(),
      isProgress: options?.isProgress || false,
      attachments: attachments && attachments.length > 0 ? attachments : []
    }
    
    set((state) => ({
      chatMessages: [...state.chatMessages, message],
      currentStepUserMessages: type === 'user' ? state.currentStepUserMessages + 1 : state.currentStepUserMessages
    }))
  },
  
  addOrUpdateProgressMessage: (content, messageId = 'progress_message') => {
    const state = get()
    const existingIndex = state.chatMessages.findIndex(msg => msg.id === messageId)
    
    if (existingIndex !== -1) {
      // æ›´æ–°ç°æœ‰æ¶ˆæ¯
      const updatedMessages = [...state.chatMessages]
      updatedMessages[existingIndex] = {
        ...updatedMessages[existingIndex],
        content,
        timestamp: new Date().toISOString()
      }
      set({ chatMessages: updatedMessages })
    } else {
      // æ·»åŠ æ–°çš„è¿›åº¦æ¶ˆæ¯
      get().addMessage('ai', content, undefined, { id: messageId, isProgress: true })
    }
  },
  
  clearChat: () => {
    set({
      chatMessages: [],
      currentStep: 0,
      currentStepUserMessages: 0,
      showPreview: false,
      isInitialized: false,
      currentExecutionStep: null,
      collectedData: {
        taskDefinition: '',
        context: '',
        outputFormat: '',
        qualityCriteria: '',
        executionParams: ''
      },
      promptData: {
        requirementReport: '',
        generatedPrompt: {
          zh: '',
          en: ''
        },
        optimizedPrompt: {
          zh: '',
          en: ''
        }
      }
    })
  },
  
  nextStep: () => {
    const state = get()
    if (state.currentStep < steps.length - 1) {
      set({
        currentStep: state.currentStep + 1,
        currentStepUserMessages: 0
      })
    }
  },
  
  updateCollectedData: (stepId, value) => {
    const state = get()
    if (stepId in state.collectedData) {
      const current = state.collectedData[stepId as keyof CollectedData]
      set({
        collectedData: {
          ...state.collectedData,
          [stepId]: current ? current + '\n' + value : value
        }
      })
    }
  },
  
  deleteMessage: (messageId) => {
    const state = get()
    const updatedMessages = state.chatMessages.map(msg =>
      msg.id === messageId ? { ...msg, isDeleted: true } : msg
    )
    set({ chatMessages: updatedMessages })
  },
  
  updateMessage: (messageId, content) => {
    const state = get()
    const updatedMessages = state.chatMessages.map(msg =>
      msg.id === messageId ? { ...msg, content, timestamp: new Date().toISOString() } : msg
    )
    set({ chatMessages: updatedMessages })
  },
  
  startEditMessage: (messageId) => {
    const state = get()
    const updatedMessages = state.chatMessages.map(msg => {
      if (msg.id === messageId) {
        return {
          ...msg,
          isEditing: true,
          originalContent: msg.content
        }
      }
      return msg
    })
    set({ chatMessages: updatedMessages })
  },
  
  saveEditMessage: (messageId, newContent) => {
    const state = get()
    const updatedMessages = state.chatMessages.map(msg => {
      if (msg.id === messageId) {
        return {
          ...msg,
          content: newContent.trim(),
          isEditing: false,
          originalContent: undefined,
          timestamp: new Date().toISOString()
        }
      }
      return msg
    })
    set({ chatMessages: updatedMessages })
  },
  
  cancelEditMessage: (messageId) => {
    const state = get()
    const updatedMessages = state.chatMessages.map(msg => {
      if (msg.id === messageId && msg.originalContent !== undefined) {
        return {
          ...msg,
          content: msg.originalContent,
          isEditing: false,
          originalContent: undefined
        }
      }
      return msg
    })
    set({ chatMessages: updatedMessages })
  },
  
  getValidMessages: () => {
    const state = get()
    return state.chatMessages.filter(msg => !msg.isDeleted && !msg.isProgress)
  },
  
  clearProgressMessages: () => {
    const state = get()
    set({ chatMessages: state.chatMessages.filter(msg => !msg.isProgress) })
  },
  
  savePromptToLibrary: async (data: SavePromptData) => {
    await savePrompt(data)
  },
  
  saveToBackend: async (title, description, tags, promptType = 'system') => {
    const { useAuthStore } = await import('./authStore')
    const authStore = useAuthStore.getState()
    
    if (!authStore.token || !authStore.user) {
      return {
        success: false,
        error: 'è¯·å…ˆç™»å½•åå†ä¿å­˜æç¤ºè¯'
      }
    }
    
    const state = get()
    let finalPrompt: string
    const gp = state.promptData.generatedPrompt
    if (typeof gp === 'string') {
      finalPrompt = gp
    } else if ('markdown' in gp && 'xml' in gp) {
      finalPrompt = gp.markdown.zh || gp.markdown.en || gp.xml.zh || gp.xml.en
    } else {
      finalPrompt = gp[state.currentLanguage]
    }
    
    if (!finalPrompt || !finalPrompt.trim()) {
      return {
        success: false,
        error: 'æ²¡æœ‰å¯ä¿å­˜çš„æç¤ºè¯'
      }
    }
    
    try {
      const saveData: SavePromptData = {
        title: title.trim(),
        description: description?.trim(),
        requirement_report: state.promptData.requirementReport,
        thinking_points: state.promptData.thinkingPoints,
        initial_prompt: state.promptData.initialPrompt,
        advice: state.promptData.advice,
        final_prompt: finalPrompt,
        language: state.currentLanguage,
        format: 'markdown',
        prompt_type: promptType,
        tags
      }
      
      const result = await savePrompt(saveData)
      
      if (result.code === 200 && result.data) {
        return {
          success: true,
          promptId: result.data.id
        }
      } else {
        return {
          success: false,
          error: result.message || 'ä¿å­˜å¤±è´¥'
        }
      }
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
      }
    }
  },
  
  setShowPreview: (show) => {
    set({ showPreview: show })
  },
  
  setCurrentLanguage: (lang) => {
    set({ currentLanguage: lang })
  },
  
  setIsAutoMode: (auto) => {
    set({ isAutoMode: auto })
  },
  
  setIsGenerating: (generating) => {
    set({ isGenerating: generating })
  },
  
  setIsTyping: (typing) => {
    set({ isTyping: typing })
  },
  
  setCurrentExecutionStep: (step) => {
    set({ currentExecutionStep: step })
  },
  
  // Zustand compatibility methods
  getState: () => get(),
  setState: (partial) => {
    if (typeof partial === 'function') {
      set(partial(get()))
    } else {
      set(partial)
    }
  }
}))

// ä¸ºäº†å‘åå…¼å®¹ï¼Œä¹Ÿå¯¼å‡º store å®ä¾‹çš„æ–¹æ³•
export const promptStore = {
  getState: () => usePromptStore.getState(),
  setState: (partial: Partial<PromptState> | ((state: PromptState) => Partial<PromptState>)) => {
    if (typeof partial === 'function') {
      usePromptStore.setState(partial(usePromptStore.getState()))
    } else {
      usePromptStore.setState(partial)
    }
  }
}

```


## src/stores/providerStore.ts

```ts
/**
 * Provider Store - åªè¯»é…ç½®ç®¡ç†
 * æ‰€æœ‰é…ç½®ä»åç«¯ API è¯»å–ï¼ˆ.setting.jsonï¼‰ï¼Œä¸æ”¯æŒå‰ç«¯ç¼–è¾‘
 */
import { create } from 'zustand'
import { getSettings } from '@/services/settingsApi'

export interface ModelConfig {
  id: string
  name: string
  apiType?: 'openai' | 'anthropic' | 'google'
}

export interface ProviderConfig {
  id: string
  name: string
  type: 'openai' | 'anthropic' | 'google' | 'custom'
  apiKey: string
  baseUrl?: string
  models: ModelConfig[]
}

interface ProviderState {
  providers: ProviderConfig[]
  lastRefreshedAt: Date | null
  isLoading: boolean
  error: string | null
  isInitialized: boolean
  selectedProviderId: string
  selectedModelId: string
  streamMode: boolean
  showApiKeys: boolean
  
  // Getters
  allProviders: ProviderConfig[]
  enabledProviders: ProviderConfig[]
  currentProvider: ProviderConfig | null
  currentModel: ModelConfig | null
  availableModels: ModelConfig[]
  
  // Actions
  getProviderById: (id: string) => ProviderConfig | undefined
  getAvailableModelsByProvider: (providerId: string) => ModelConfig[]
  refreshProviders: () => Promise<void>
  refreshSettings: () => Promise<void> // åˆ«åï¼Œä¸ Vue å®ç°ä¿æŒä¸€è‡´
  setSelectedProvider: (providerId: string) => void
  setSelectedModel: (modelId: string) => void
  setStreamMode: (enabled: boolean) => void
  setShowApiKeys: (show: boolean) => void
  initialize: () => Promise<void>
}

export const useProviderStore = create<ProviderState>((set, get) => ({
  providers: [],
  lastRefreshedAt: null,
  isLoading: false,
  error: null,
  isInitialized: false,
  selectedProviderId: localStorage.getItem('yprompt_selected_provider') || '',
  selectedModelId: localStorage.getItem('yprompt_selected_model') || '',
  streamMode: localStorage.getItem('yprompt_stream_mode') !== 'false',
  showApiKeys: JSON.parse(localStorage.getItem('yprompt_show_api_keys') || 'false'),
  
  get allProviders() {
    return get().providers
  },
  
  get enabledProviders() {
    return get().providers.filter(p => p.apiKey)
  },
  
  get currentProvider() {
    const { providers, selectedProviderId } = get()
    const provider = providers.find(p => p.id === selectedProviderId) || null
    console.log('[providerStore] currentProvider getter:', {
      providersCount: providers.length,
      selectedProviderId,
      foundProvider: provider?.name || 'null'
    })
    return provider
  },

  get currentModel() {
    const provider = get().currentProvider
    if (!provider) {
      console.log('[providerStore] currentModel getter: no provider found')
      return null
    }
    const { selectedModelId } = get()
    const model = provider.models.find(m => m.id === selectedModelId) || null
    console.log('[providerStore] currentModel getter:', {
      providerName: provider.name,
      selectedModelId,
      foundModel: model?.name || 'null',
      providerModelsCount: provider.models.length
    })
    return model
  },
  
  get availableModels() {
    const provider = get().currentProvider
    if (!provider) return []
    return provider.models
  },
  
  getProviderById: (id: string) => {
    return get().providers.find(p => p.id === id)
  },
  
  getAvailableModelsByProvider: (providerId: string) => {
    const provider = get().getProviderById(providerId)
    if (!provider) return []
    return provider.models
  },
  
  refreshProviders: async () => {
    const currentState = get()
    console.log('[providerStore] å¼€å§‹åˆ·æ–°é…ç½®ï¼Œå½“å‰çŠ¶æ€:', {
      isInitialized: currentState.isInitialized,
      providersCount: currentState.providers.length,
      isLoading: currentState.isLoading
    })
    
    set({ isLoading: true, error: null })
    try {
      // ä»åç«¯ API è·å– .setting.json é…ç½®
      // API ç«¯ç‚¹: GET /api/settings/
      const settings = await getSettings()
      console.log('[providerStore] getSettings è¿”å›:', settings)
      
      // ç¡®ä¿ providers æ˜¯æ•°ç»„
      let providers: ProviderConfig[] = []
      console.log('[providerStore] settings å¯¹è±¡:', settings)
      console.log('[providerStore] settings.providers åŸå§‹å€¼:', settings.providers)
      console.log('[providerStore] settings.providers ç±»å‹:', typeof settings.providers)
      console.log('[providerStore] settings.providers æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(settings.providers))
      
      if (Array.isArray(settings.providers)) {
        providers = settings.providers
        console.log('[providerStore] providers æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨')
      } else if (settings.providers && typeof settings.providers === 'object') {
        // å¯èƒ½æ˜¯å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„ï¼Œå°è¯•è½¬æ¢ä¸ºæ•°ç»„
        console.warn('[providerStore] providers ä¸æ˜¯æ•°ç»„ï¼Œæ˜¯å¯¹è±¡ï¼Œå°è¯•è½¬æ¢:', settings.providers)
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¯¹è±¡æ•°ç»„çš„åŒ…è£…
        if (settings.providers && 'length' in settings.providers) {
          // å¯èƒ½æ˜¯ç±»æ•°ç»„å¯¹è±¡
          providers = Array.from(settings.providers as any)
        } else {
          // å•ä¸ªå¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
          providers = [settings.providers as any]
        }
      } else if (!settings.providers) {
        console.warn('[providerStore] settings.providers ä¸å­˜åœ¨æˆ–ä¸º null/undefined')
        providers = []
      } else {
        console.warn('[providerStore] providers æ ¼å¼æœªçŸ¥:', settings.providers)
        providers = []
      }
      
      console.log('[providerStore] è§£æåçš„ providers:', providers)
      console.log('[providerStore] providers æ•°é‡:', providers.length)
      if (providers.length > 0) {
        console.log('[providerStore] ç¬¬ä¸€ä¸ª provider ç¤ºä¾‹:', providers[0])
      }
      
      // éªŒè¯æ¯ä¸ª provider çš„ç»“æ„
      providers.forEach((provider, index) => {
        if (!provider.id || !provider.name) {
          console.warn(`[providerStore] Provider ${index} ç¼ºå°‘å¿…è¦å­—æ®µ:`, provider)
        }
      })
      
      // è·å–å½“å‰é€‰ä¸­çš„ provider å’Œ modelï¼ˆä» state ä¸­è·å–ï¼Œå¯èƒ½æ¥è‡ª localStorageï¼‰
      const currentProviderId = get().selectedProviderId
      const currentModelId = get().selectedModelId
      const wasInitialized = get().isInitialized
      
      // æ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ä¿å­˜çš„é€‰æ‹©ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡ä½¿ç”¨ï¼‰
      const savedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
      const savedModelId = localStorage.getItem('yprompt_selected_model') || ''
      const isFirstTime = !savedProviderId && !savedModelId
      
      // è·å–å¯ç”¨çš„æä¾›å•†ï¼ˆæœ‰ API Key çš„ï¼‰
      const enabledProviders = providers.filter(p => p.apiKey)
      
      console.log('[providerStore] å½“å‰é€‰æ‹©çŠ¶æ€:', {
        currentProviderId,
        currentModelId,
        wasInitialized,
        savedProviderId,
        savedModelId,
        isFirstTime,
        enabledProvidersCount: enabledProviders.length
      })
      
      if (enabledProviders.length > 0) {
        console.log('[providerStore] ç¬¬ä¸€ä¸ªå¯ç”¨æä¾›å•†:', enabledProviders[0].name, enabledProviders[0].id, 'æ¨¡å‹æ•°é‡:', enabledProviders[0].models.length)
      }
      
      // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†å’Œæ¨¡å‹
      let newProviderId = currentProviderId
      let newModelId = currentModelId
      
      if (enabledProviders.length > 0) {
        const firstProvider = enabledProviders[0]
        
        // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼ˆlocalStorage ä¸­æ²¡æœ‰ä¿å­˜çš„é€‰æ‹©ï¼‰ï¼Œå¼ºåˆ¶é€‰æ‹©ç¬¬ä¸€ä¸ª
        if (isFirstTime) {
          newProviderId = firstProvider.id
          console.log('[providerStore] âœ… é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†:', firstProvider.name)
          
          // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
          if (firstProvider.models.length > 0) {
            newModelId = firstProvider.models[0].id
            console.log('[providerStore] âœ… è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹:', firstProvider.models[0].name)
          } else {
            newModelId = ''
            console.warn('[providerStore] âš ï¸ ç¬¬ä¸€ä¸ªæä¾›å•†æ²¡æœ‰æ¨¡å‹')
          }
        } else if (!currentProviderId || currentProviderId.trim() === '') {
          // å¦‚æœå½“å‰æ²¡æœ‰é€‰æ‹©ï¼ˆä½† localStorage ä¸­å¯èƒ½æœ‰æ— æ•ˆå€¼ï¼‰ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
          newProviderId = firstProvider.id
          console.log('[providerStore] å½“å‰æ²¡æœ‰é€‰æ‹©ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†:', firstProvider.name)
          
          if (firstProvider.models.length > 0) {
            newModelId = firstProvider.models[0].id
            console.log('[providerStore] è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹:', firstProvider.models[0].name)
          } else {
            newModelId = ''
          }
        } else {
          // å¦‚æœå·²é€‰æ‹©æä¾›å•†ï¼Œæ£€æŸ¥è¯¥æä¾›å•†æ˜¯å¦ä»ç„¶å­˜åœ¨
          const selectedProvider = enabledProviders.find(p => p.id === currentProviderId)
          if (!selectedProvider) {
            // å¦‚æœé€‰ä¸­çš„æä¾›å•†ä¸å­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
            newProviderId = firstProvider.id
            console.log('[providerStore] é€‰ä¸­çš„æä¾›å•†ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª:', firstProvider.name)
            
            // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
            if (firstProvider.models.length > 0) {
              newModelId = firstProvider.models[0].id
              console.log('[providerStore] è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹:', firstProvider.models[0].name)
            } else {
              newModelId = ''
            }
          } else {
            // æä¾›å•†å­˜åœ¨ï¼Œæ£€æŸ¥æ¨¡å‹
            if (!currentModelId || currentModelId.trim() === '') {
              // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ¨¡å‹ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
              if (selectedProvider.models.length > 0) {
                newModelId = selectedProvider.models[0].id
                console.log('[providerStore] æ²¡æœ‰é€‰æ‹©æ¨¡å‹ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª:', selectedProvider.models[0].name)
              } else {
                newModelId = ''
              }
            } else {
              // æ£€æŸ¥é€‰ä¸­çš„æ¨¡å‹æ˜¯å¦ä»ç„¶å­˜åœ¨
              const selectedModel = selectedProvider.models.find(m => m.id === currentModelId)
              if (!selectedModel) {
                // å¦‚æœé€‰ä¸­çš„æ¨¡å‹ä¸å­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                if (selectedProvider.models.length > 0) {
                  newModelId = selectedProvider.models[0].id
                  console.log('[providerStore] é€‰ä¸­çš„æ¨¡å‹ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª:', selectedProvider.models[0].name)
                } else {
                  newModelId = ''
                }
              }
              // å¦‚æœæ¨¡å‹å­˜åœ¨ï¼Œä¿æŒå½“å‰é€‰æ‹©
            }
          }
        }
      } else {
        // æ²¡æœ‰å¯ç”¨çš„æä¾›å•†ï¼Œæ¸…ç©ºé€‰æ‹©
        newProviderId = ''
        newModelId = ''
        console.warn('[providerStore] æ²¡æœ‰å¯ç”¨çš„æä¾›å•†ï¼ˆæ‰€æœ‰æä¾›å•†éƒ½æ²¡æœ‰ API Keyï¼‰')
      }
      
      set({
        providers,
        selectedProviderId: newProviderId,
        selectedModelId: newModelId,
        lastRefreshedAt: new Date(),
        isInitialized: true,
        isLoading: false,
        error: null
      })
      
      // å¦‚æœè‡ªåŠ¨é€‰æ‹©äº†æ–°çš„å€¼ï¼Œæ›´æ–° localStorage
      if (newProviderId !== currentProviderId) {
        localStorage.setItem('yprompt_selected_provider', newProviderId)
      }
      if (newModelId !== currentModelId) {
        localStorage.setItem('yprompt_selected_model', newModelId)
      }
      
      console.log('[providerStore] é…ç½®æ›´æ–°å®Œæˆï¼Œæ–°çš„ providers æ•°é‡:', providers.length)
      console.log('[providerStore] å½“å‰é€‰ä¸­çš„æä¾›å•†:', newProviderId)
      console.log('[providerStore] å½“å‰é€‰ä¸­çš„æ¨¡å‹:', newModelId)
      
      // å¦‚æœ providers ä¸ºç©ºï¼Œè®°å½•è­¦å‘Šä½†ä¸æŠ›å‡ºé”™è¯¯ï¼ˆå¯èƒ½æ˜¯é…ç½®æ–‡ä»¶ä¸­ç¡®å®æ²¡æœ‰é…ç½®ï¼‰
      if (providers.length === 0) {
        console.warn('[providerStore] è­¦å‘Š: ä» .setting.json åŠ è½½çš„ providers ä¸ºç©ºï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®æ–‡ä»¶')
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'åŠ è½½é…ç½®å¤±è´¥'
      console.error('[providerStore] åŠ è½½é…ç½®å¤±è´¥:', error)
      console.error('[providerStore] é”™è¯¯è¯¦æƒ…:', {
        message: errorMessage,
        stack: error instanceof Error ? error.stack : undefined
      })
      
      set({
        error: errorMessage,
        isLoading: false,
        isInitialized: false // å¤±è´¥æ—¶é‡ç½®åˆå§‹åŒ–çŠ¶æ€
      })
      
      // æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“å¤±è´¥äº†
      throw error
    }
  },
  
  // refreshSettings ä½œä¸º refreshProviders çš„åˆ«åï¼Œä¸ Vue å®ç°ä¿æŒä¸€è‡´
  refreshSettings: async () => {
    return get().refreshProviders()
  },
  
  setSelectedProvider: (providerId: string) => {
    set({ selectedProviderId: providerId })
    localStorage.setItem('yprompt_selected_provider', providerId)
  },
  
  setSelectedModel: (modelId: string) => {
    set({ selectedModelId: modelId })
    localStorage.setItem('yprompt_selected_model', modelId)
  },
  
  setStreamMode: (enabled: boolean) => {
    set({ streamMode: enabled })
    localStorage.setItem('yprompt_stream_mode', String(enabled))
  },
  
  setShowApiKeys: (show: boolean) => {
    set({ showApiKeys: show })
    localStorage.setItem('yprompt_show_api_keys', JSON.stringify(show))
  },
  
  initialize: async () => {
    const state = get()
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–ï¼šå¦‚æœæ­£åœ¨åŠ è½½æˆ–å·²åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
    if (state.isInitialized || state.isLoading) return
    
    // è®¾ç½®åŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢å¹¶å‘è°ƒç”¨
    set({ isLoading: true })
    try {
      await get().refreshProviders()
    } catch (error) {
      // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œé‡ç½® isLoading çŠ¶æ€ï¼Œå…è®¸é‡è¯•
      set({ isLoading: false, isInitialized: false })
      throw error
    }
  }
}))

```


## src/stores/settingsStore.ts

```ts
import { create } from 'zustand'
import { promptConfigManager } from '@/config/prompts'
import { THINKING_POINTS_EXTRACTION_PROMPT } from '@/config/prompts/thinkingPointsExtraction'
import { SYSTEM_PROMPT_GENERATION_PROMPT } from '@/config/prompts/systemPromptGeneration'
import { OPTIMIZATION_ADVICE_PROMPT } from '@/config/prompts/optimizationAdvice'
import { OPTIMIZATION_APPLICATION_PROMPT } from '@/config/prompts/optimizationApplication'
import { QUALITY_ANALYSIS_SYSTEM_PROMPT } from '@/config/prompts/qualityAnalysis'
import { USER_PROMPT_OPTIMIZATION_CONFIG } from '@/config/prompts/userPromptOptimization'
import { USER_PROMPT_QUALITY_ANALYSIS } from '@/config/prompts/userPromptQualityAnalysis'

// æ¨¡å‹å‚æ•°ç±»å‹
export interface ModelParams {
  temperature: number
  maxTokens: number
  topP: number
  frequencyPenalty: number
  presencePenalty: number
  topK: number
}

// æ¨ç†ç±»å‹
export type ReasoningType = 
  | 'openai-reasoning' 
  | 'generic-cot' 
  | 'gemini-thought' 
  | 'claude-thinking' 
  | null

// æ”¯æŒçš„å‚æ•°é…ç½®
export interface SupportedParams {
  temperature: boolean | string
  maxTokens: string | boolean
  streaming: boolean
  systemMessage: boolean
}

// æµ‹è¯•ç»“æœ
export interface TestResult {
  connected: boolean
  reasoning: boolean
  responseTime: number
  timestamp: Date
  error?: string
}

// æ¨¡å‹èƒ½åŠ›
export interface ModelCapabilities {
  reasoning: boolean
  reasoningType: ReasoningType
  supportedParams: SupportedParams
  testResult?: TestResult
}

interface EditingFinalPromptRules {
  THINKING_POINTS_EXTRACTION: string
  SYSTEM_PROMPT_GENERATION: string
  OPTIMIZATION_ADVICE_GENERATION: string
  OPTIMIZATION_APPLICATION: string
}

interface EditingQualityAnalysisRules {
  systemPrompt: string
}

interface EditingUserPromptOptimizationRules {
  qualityAnalysis: string
  quickOptimization: string
}

interface SettingsState {
  showSettings: boolean
  globalModelParams: ModelParams
  useSlimRules: boolean
  editingSystemRules: string
  editingUserRules: string
  editingRequirementReportRules: string
  editingFinalPromptRules: EditingFinalPromptRules
  editingQualityAnalysisRules: EditingQualityAnalysisRules
  editingUserPromptOptimizationRules: EditingUserPromptOptimizationRules
  setShowSettings: (show: boolean) => void
  saveSettings: () => void
  loadSettings: () => void
  openPromptEditor: (type: string) => void
}

// ä» localStorage åŠ è½½é»˜è®¤å‚æ•°
const loadDefaultParams = (): ModelParams => {
  const saved = localStorage.getItem('yprompt_global_model_params')
  if (saved) {
    try {
      return JSON.parse(saved)
    } catch {
      // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
    }
  }
  return {
    temperature: 1.0,
    maxTokens: 8192,
    topP: 0.95,
    frequencyPenalty: 0,
    presencePenalty: 0,
    topK: 0
  }
}

// åŠ è½½é»˜è®¤çš„æç¤ºè¯è§„åˆ™
const loadDefaultEditingRules = () => {
  // ä» localStorage åŠ è½½ useSlimRules çŠ¶æ€
  const savedUseSlimRules = localStorage.getItem('yprompt_use_slim_rules')
  const useSlimRules = savedUseSlimRules === 'true'
  
  // è®¾ç½® promptConfigManager çš„çŠ¶æ€
  promptConfigManager.setUseSlimRules(useSlimRules)
  
  return {
    useSlimRules,
    editingSystemRules: promptConfigManager.getSystemPromptRules(),
    editingUserRules: promptConfigManager.getUserGuidedPromptRules(),
    editingRequirementReportRules: promptConfigManager.getRequirementReportRules(),
    editingFinalPromptRules: {
      THINKING_POINTS_EXTRACTION: THINKING_POINTS_EXTRACTION_PROMPT,
      SYSTEM_PROMPT_GENERATION: SYSTEM_PROMPT_GENERATION_PROMPT,
      OPTIMIZATION_ADVICE_GENERATION: OPTIMIZATION_ADVICE_PROMPT,
      OPTIMIZATION_APPLICATION: OPTIMIZATION_APPLICATION_PROMPT
    },
    editingQualityAnalysisRules: {
      systemPrompt: QUALITY_ANALYSIS_SYSTEM_PROMPT
    },
    editingUserPromptOptimizationRules: {
      qualityAnalysis: USER_PROMPT_QUALITY_ANALYSIS,
      quickOptimization: USER_PROMPT_OPTIMIZATION_CONFIG.quick
    }
  }
}

export const useSettingsStore = create<SettingsState>((set, get) => ({
  showSettings: false,
  globalModelParams: loadDefaultParams(),
  ...loadDefaultEditingRules(),
  setShowSettings: (show: boolean) => set({ showSettings: show }),
  saveSettings: () => {
    const state = get()
    const params = state.globalModelParams
    localStorage.setItem('yprompt_global_model_params', JSON.stringify(params))
    // ä¿å­˜ useSlimRules çŠ¶æ€
    localStorage.setItem('yprompt_use_slim_rules', String(state.useSlimRules))
  },
  loadSettings: () => {
    const saved = localStorage.getItem('yprompt_global_model_params')
    if (saved) {
      try {
        const params = JSON.parse(saved) as ModelParams
        set({ globalModelParams: params })
      } catch {
        // è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
      }
    }
    // åŠ è½½ useSlimRules çŠ¶æ€
    const savedUseSlimRules = localStorage.getItem('yprompt_use_slim_rules')
    if (savedUseSlimRules !== null) {
      const useSlimRules = savedUseSlimRules === 'true'
      // æ›´æ–°çŠ¶æ€å¹¶åŒæ­¥ promptConfigManager
      promptConfigManager.setUseSlimRules(useSlimRules)
      set({ 
        useSlimRules,
        // æ ¹æ®çŠ¶æ€æ›´æ–°ç¼–è¾‘ä¸­çš„ç³»ç»Ÿæç¤ºè¯è§„åˆ™
        editingSystemRules: promptConfigManager.getSystemPromptRules()
      })
    }
  },
  openPromptEditor: (_type: string) => {
    // æ‰“å¼€æç¤ºè¯ç¼–è¾‘å™¨æ—¶çš„åˆå§‹åŒ–é€»è¾‘
    // ç¡®ä¿ editingSystemRules ä¸å½“å‰çš„ useSlimRules çŠ¶æ€åŒæ­¥
    const state = get()
    promptConfigManager.setUseSlimRules(state.useSlimRules)
    set({ 
      editingSystemRules: promptConfigManager.getSystemPromptRules()
    })
  }
}))

```


## src/style/playground.css

```css
.playground-container {
  font-family: 'Google Sans', 'Inter', system-ui, -apple-system, sans-serif;
  background-color: #f0f4f9;
}

.markdown-body {
  font-size: 15px;
  line-height: 1.6;
  color: #374151;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.markdown-body p {
  margin-bottom: 0.75rem;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.markdown-body p:last-child {
  margin-bottom: 0;
}

.playground-code-block,
.markdown-body pre {
  background: #f7f8ff;
  padding: 1rem 1.25rem;
  border-radius: 0.8rem;
  overflow-x: auto;
  margin: 0.75rem 0;
  border: 1px solid #dbe1ff;
  color: #0f172a;
  box-shadow: inset 0 1px 1px rgba(15, 23, 42, 0.06);
  white-space: pre-wrap;
  word-break: break-word;
}

.markdown-body code {
  font-family: 'Roboto Mono', monospace;
  font-size: 0.85em;
  background: rgba(99, 102, 241, 0.12);
  padding: 0.15rem 0.35rem;
  border-radius: 0.35rem;
  color: #312e81;
}

.markdown-body pre code {
  background: transparent;
  padding: 0;
  color: inherit;
  font-size: 0.9em;
}

.markdown-body ul {
  list-style-type: disc;
  padding-left: 1.5rem;
  margin-bottom: 0.75rem;
}

.markdown-body ol {
  list-style-type: decimal;
  padding-left: 1.5rem;
  margin-bottom: 0.75rem;
}

.markdown-body li {
  margin-bottom: 0.25rem;
}

.markdown-body blockquote {
  border-left: 4px solid #cbd5e1;
  padding-left: 1rem;
  color: #64748b;
  margin: 0.75rem 0;
  font-style: italic;
}

.markdown-body strong {
  font-weight: 600;
  color: #111827;
}

.markdown-body em {
  font-style: italic;
}

.markdown-body a {
  color: #2563eb;
  text-decoration: underline;
  font-weight: 500;
}

.markdown-body a:hover {
  color: #1d4ed8;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4 {
  font-weight: 600;
  margin-top: 1.25rem;
  margin-bottom: 0.75rem;
  color: #111827;
  line-height: 1.3;
}

.markdown-body h1 {
  font-size: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 0.5rem;
}

.markdown-body h2 {
  font-size: 1.25rem;
}

.markdown-body h3 {
  font-size: 1.1rem;
}

.markdown-body table {
  width: 100%;
  border-collapse: collapse;
  margin: 0.75rem 0;
  font-size: 0.9em;
}

.markdown-body th,
.markdown-body td {
  border: 1px solid #e5e7eb;
  padding: 0.5rem;
  text-align: left;
}

.markdown-body th {
  background-color: #f9fafb;
  font-weight: 600;
}

.markdown-body tr:nth-child(even) {
  background-color: #f9fafb;
}

.markdown-body hr {
  border: 0;
  border-top: 1px solid #e5e7eb;
  margin: 1.5rem 0;
}

.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.hide-scrollbar::-webkit-scrollbar {
  display: none;
}

```


## src/style.css

```css
/* ==========================================================================
   Corporate Trust Design System for YPrompt
   ========================================================================== */

@tailwind base;
@tailwind components;
@tailwind utilities;

/* ==========================================================================
   1. Design Tokens & CSS Variables
   ========================================================================== */

:root {
  /* 1.1. Color Palette - Corporate Trust */
  --ct-indigo-50: #EEF2FF;
  --ct-indigo-100: #E0E7FF;
  --ct-indigo-200: #C7D2FE;
  --ct-indigo-300: #A5B4FC;
  --ct-indigo-400: #818CF8;
  --ct-indigo-500: #6366F1;
  --ct-indigo-600: #4F46E5; /* Primary Start */
  --ct-indigo-700: #4338CA;
  --ct-indigo-800: #3730A3;
  --ct-indigo-900: #312E81;

  --ct-violet-50: #F5F3FF;
  --ct-violet-100: #EDE9FE;
  --ct-violet-200: #DDD6FE;
  --ct-violet-300: #C4B5FD;
  --ct-violet-400: #A78BFA;
  --ct-violet-500: #8B5CF6;
  --ct-violet-600: #7C3AED; /* Primary End */
  --ct-violet-700: #6D28D9;
  --ct-violet-800: #5B21B6;
  --ct-violet-900: #4C1D95;

  --ct-slate-50: #F8FAFC;
  --ct-slate-100: #F1F5F9;
  --ct-slate-200: #E2E8F0;
  --ct-slate-300: #CBD5E1;
  --ct-slate-400: #94A3B8;
  --ct-slate-500: #64748B;
  --ct-slate-600: #475569;
  --ct-slate-700: #334155;
  --ct-slate-800: #1E293B;
  --ct-slate-900: #0F172A;

  --ct-emerald-50: #ECFDF5;
  --ct-emerald-500: #10B981;
  --ct-emerald-600: #059669;

  /* 1.2. Gradients */
  --ct-gradient-primary: linear-gradient(135deg, var(--ct-indigo-600) 0%, var(--ct-violet-600) 100%);
  --ct-gradient-primary-hover: linear-gradient(135deg, var(--ct-indigo-500) 0%, var(--ct-violet-500) 100%);
  --ct-gradient-text: linear-gradient(135deg, var(--ct-indigo-600) 0%, var(--ct-violet-600) 100%);
  --ct-gradient-bg-subtle: linear-gradient(135deg, var(--ct-indigo-50) 0%, var(--ct-violet-50) 100%);
  --ct-gradient-atmospheric: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(79, 70, 229, 0.15), transparent);

  /* 1.3. Typography */
  --ct-font-family-sans: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;

  /* 1.4. Shadows - Corporate Trust Colored Shadows */
  --ct-shadow-soft: 0 4px 20px -2px rgba(79, 70, 229, 0.1);
  --ct-shadow-soft-hover: 0 10px 25px -5px rgba(79, 70, 229, 0.15), 0 8px 10px -6px rgba(79, 70, 229, 0.1);
  --ct-shadow-button: 0 4px 14px 0 rgba(79, 70, 229, 0.3);
  --ct-shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);

  /* 1.5. Spacing Scale (Consistent with Tailwind) */
  --ct-space-1: 0.25rem;   /* 4px */
  --ct-space-2: 0.5rem;    /* 8px */
  --ct-space-3: 0.75rem;   /* 12px */
  --ct-space-4: 1rem;      /* 16px */
  --ct-space-5: 1.25rem;   /* 20px */
  --ct-space-6: 1.5rem;    /* 24px */
  --ct-space-8: 2rem;      /* 32px */
  --ct-space-10: 2.5rem;   /* 40px */
  --ct-space-12: 3rem;     /* 48px */
  --ct-space-16: 4rem;     /* 64px */
  --ct-space-24: 6rem;     /* 96px */

  /* 1.6. Border Radius */
  --ct-radius-sm: 0.25rem;
  --ct-radius: 0.5rem;
  --ct-radius-lg: 0.75rem;
  --ct-radius-xl: 1rem;
  --ct-radius-2xl: 1.5rem;
  --ct-radius-full: 9999px;
}

/* ==========================================================================
   2. Base & Global Styles
   ========================================================================== */

* {
  box-sizing: border-box;
}

body {
  font-family: var(--ct-font-family-sans);
  font-size: 14px;
  line-height: 1.6;
  color: var(--ct-slate-900);
  background-color: var(--ct-slate-50);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  margin: 0;
  padding: 0;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--ct-slate-100);
}

::-webkit-scrollbar-thumb {
  background: var(--ct-slate-300);
  border-radius: var(--ct-radius-full);
  transition: background 0.2s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ct-slate-400);
}

/* ==========================================================================
   3. Typography System
   ========================================================================== */

h1, h2, h3, h4, h5, h6 {
  color: var(--ct-slate-900);
  font-weight: 700;
  line-height: 1.1;
  letter-spacing: -0.02em;
}

h1 { font-size: 3rem; }      /* 48px */
h2 { font-size: 2.25rem; }   /* 36px */
h3 { font-size: 1.875rem; }  /* 30px */

a {
  color: var(--ct-indigo-600);
  text-decoration: none;
  transition: color 0.2s ease-in-out;
}

a:hover {
  color: var(--ct-violet-600);
}

/* ==========================================================================
   4. Corporate Trust Utility Classes
   ========================================================================== */

/* Gradient Text */
.text-gradient {
  background: var(--ct-gradient-text);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Colored Shadow */
.shadow-soft {
  box-shadow: var(--ct-shadow-soft);
  transition: box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.shadow-soft:hover {
  box-shadow: var(--ct-shadow-soft-hover);
}

.shadow-glow {
  box-shadow: var(--ct-shadow-glow);
}

/* Elevated Card */
.card-elevated {
  background-color: #FFFFFF;
  border: 1px solid var(--ct-slate-200);
  border-radius: var(--ct-radius-xl);
  box-shadow: var(--ct-shadow-soft);
  transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
}

.card-elevated:hover {
  transform: translateY(-2px);
  box-shadow: var(--ct-shadow-soft-hover);
}

/* Gradient Button */
.btn-gradient {
  background: var(--ct-gradient-primary);
  color: #FFFFFF;
  padding: var(--ct-space-3) var(--ct-space-6);
  border-radius: var(--ct-radius-lg);
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--ct-space-2);
  border: none;
  cursor: pointer;
  box-shadow: var(--ct-shadow-button);
  transition: all 0.2s ease-out;
  transform: translateY(0);
}

.btn-gradient:hover {
  background: var(--ct-gradient-primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 6px 20px -5px rgba(124, 58, 237, 0.4);
}

.btn-gradient:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px -5px rgba(79, 70, 229, 0.3);
}

/* Atmospheric Background */
.atmospheric-bg {
  position: relative;
  overflow: hidden;
}

.atmospheric-bg::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--ct-gradient-atmospheric);
  z-index: -1;
  pointer-events: none;
}

/* ==========================================================================
   5. Component-Specific Styles
   ========================================================================== */

/* Navigation */
.nav-container {
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.nav-logo {
  background: var(--ct-gradient-bg-subtle);
  border: 1px solid var(--ct-slate-200);
}

/* Interactive Elements */
.interactive {
  transition: all 0.15s ease-out;
}

.interactive-hover:hover {
  transform: translateY(-1px);
}

/* Focus Styles */
.focus-ring:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.focus-ring:focus-visible {
  outline: 2px solid var(--ct-indigo-500);
  outline-offset: 2px;
}

/* ==========================================================================
   6. Keyframe Animations
   ========================================================================== */

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-4px); }
}

@keyframes pulse-glow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fade {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

@keyframes shrink {
  from {
    width: 100%;
  }
  to {
    width: 0%;
  }
}

.animate-float {
  animation: float 4s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 3s ease-in-out infinite;
}

/* ==========================================================================
   7. Tailwind Component Extensions
   ========================================================================== */

@layer components {
  /* Card Component */
  .card {
    @apply bg-white rounded-xl border border-slate-200 shadow-soft;
  }

  /* Input Component */
  .input {
    @apply bg-white border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 transition-all duration-200;
  }

  /* Button Component */
  .btn {
    @apply inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 focus-ring;
  }

  .btn-primary {
    @apply btn btn-gradient;
  }

  .btn-secondary {
    @apply btn bg-white border border-slate-200 text-slate-700 hover:bg-slate-50;
  }
  
  /* Gradient radial for background orbs */
  .bg-gradient-radial {
    background: radial-gradient(circle, var(--tw-gradient-stops));
  }
  
  /* Scrollbar hide */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
}
```


## src/types/global.d.ts

```ts
export {}

declare global {
  interface Window {
    marked?: {
      parse: (input: string, options?: any) => string
    }
    hljs?: {
      highlightElement: (el: HTMLElement) => void
      registerLanguage: (name: string, language: any) => void
    }
    lucide?: {
      createIcons: () => void
    }
  }
}


```


## src/types/optimize.ts

```ts
export interface QualityCheckResult {
  length: number
  lengthRatio: number
  lengthStatus: 'good' | 'warning' | 'error'
  hasStructureMarkers: boolean
  warnings?: string[]
}

export interface Message {
  role: 'system' | 'user' | 'assistant'
  content: string
}
```


## src/types/prompt.ts

```ts
/**
 * æç¤ºè¯ç›¸å…³ç±»å‹å®šä¹‰
 */
export interface Prompt {
  id: number
  user_id: number
  title: string
  description?: string
  requirement_report?: string
  thinking_points?: string
  initial_prompt?: string
  advice?: string
  final_prompt: string
  language: string
  format: string
  prompt_type: string
  is_favorite: number
  is_public: number
  view_count: number
  use_count: number
  tags?: string[] | string  // æ”¯æŒæ•°ç»„å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼
  current_version?: string
  total_versions?: number
  last_version_time?: string
  create_time: string
  update_time: string
  system_prompt?: string  // ç³»ç»Ÿæç¤ºè¯ï¼ˆç”¨æˆ·æç¤ºè¯ä¸“ç”¨ï¼‰
  conversation_history?: string  // å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·æç¤ºè¯ä¸“ç”¨ï¼‰
}

export interface PromptListItem {
  id: number
  user_id: number
  title: string
  description?: string
  final_prompt: string
  language: string
  format: string
  prompt_type: string
  is_favorite: number
  is_public: number
  view_count: number
  use_count: number
  tags?: string[] | string
  current_version?: string
  total_versions?: number
  last_version_time?: string
  create_time: string
  update_time: string
  requirement_report?: string
  thinking_points?: string
  initial_prompt?: string
  advice?: string
  system_prompt?: string
  conversation_history?: string
}

export type PromptFormData = Omit<Prompt, 'id' | 'user_id' | 'view_count' | 'use_count' | 'create_time' | 'update_time'>
```


## src/utils/aiResponseUtils.ts

````ts
/**
 * AIå“åº”å¤„ç†å·¥å…·å‡½æ•°
 */

/**
 * æ¸…ç†AIå“åº”ä¸­çš„è¯„ä¼°æ ‡ç­¾å’Œmarkdownä»£ç å—æ ‡è®°
 */
export const cleanAIResponse = (response: string): string => {
  try {
    // ç§»é™¤å®Œæ•´çš„thinkæ ‡ç­¾åŠå…¶å†…å®¹
    let cleaned = response.replace(/<think>[\s\S]*?<\/think>/gi, '').trim()
    
    // ç§»é™¤å®Œæ•´çš„è¯„ä¼°æ ‡ç­¾åŠå…¶å†…å®¹
    cleaned = cleaned.replace(/<ASSESSMENT>[\s\S]*?<\/ASSESSMENT>/gi, '').trim()
    
    // å¤„ç†æµå¼è¿‡ç¨‹ä¸­ä¸å®Œæ•´çš„thinkæ ‡ç­¾
    const thinkStart = cleaned.indexOf('<think>')
    if (thinkStart !== -1) {
      cleaned = cleaned.substring(0, thinkStart).trim()
    }
    
    // å¤„ç†æµå¼è¿‡ç¨‹ä¸­ä¸å®Œæ•´çš„è¯„ä¼°æ ‡ç­¾
    // å¦‚æœå‘ç°å¼€å§‹æ ‡ç­¾ä½†æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼Œæˆªæ–­åˆ°å¼€å§‹æ ‡ç­¾ä¹‹å‰
    const assessmentStart = cleaned.indexOf('<ASSESSMENT>')
    if (assessmentStart !== -1) {
      cleaned = cleaned.substring(0, assessmentStart).trim()
    }
    
    // å¤„ç†å…¶ä»–å¯èƒ½çš„ä¸å®Œæ•´æ ‡ç­¾æ¨¡å¼
    const patterns = [
      /<thin[^>]*$/i,     // ä¸å®Œæ•´çš„thinkå¼€å§‹æ ‡ç­¾
      /<\/thin[^>]*$/i,   // ä¸å®Œæ•´çš„thinkç»“æŸæ ‡ç­¾
      /\n\n<thin/i,       // æ¢è¡Œåçš„thinkæ ‡ç­¾
      /<ASSE[^>]*$/i,     // ä¸å®Œæ•´çš„è¯„ä¼°å¼€å§‹æ ‡ç­¾
      /<\/ASSE[^>]*$/i,   // ä¸å®Œæ•´çš„è¯„ä¼°ç»“æŸæ ‡ç­¾
      /\n\n<ASSE/i,       // æ¢è¡Œåçš„è¯„ä¼°æ ‡ç­¾
      /CONTEXT:/i,        // è¯„ä¼°å†…å®¹çš„å…³é”®è¯
      /TASK:/i,
      /FORMAT:/i,
      /QUALITY:/i,
      /TURN_COUNT:/i,
      /DECISION:/i,
      /CONFIDENCE:/i
    ]
    
    for (const pattern of patterns) {
      const match = cleaned.search(pattern)
      if (match !== -1) {
        cleaned = cleaned.substring(0, match).trim()
        break
      }
    }
    
    return cleaned
  } catch (error) {
    return response // æ¸…ç†å¤±è´¥æ—¶è¿”å›åŸå†…å®¹
  }
}

/**
 * æ¸…ç†AIå“åº”ä¸­çš„markdownä»£ç å—æ ‡è®°å’Œå¤šä½™æè¿°ï¼ˆç”¨äºæ ¼å¼è½¬æ¢ï¼‰
 */
export const cleanAIResponseForFormatting = (response: string): string => {
  let cleaned = response
    // ç§»é™¤thinkæ ‡ç­¾ï¼ˆé˜²å¾¡æ€§æ¸…ç†ï¼‰
    .replace(/<think>[\s\S]*?<\/think>/gi, '')
    // ç§»é™¤å¸¸è§çš„AIä»‹ç»æ€§æ–‡å­—
    .replace(/^Here is the.*?translation.*?:\s*/i, '')
    .replace(/^Here is the.*?converted.*?:\s*/i, '')
    .replace(/^Here is.*?:\s*/i, '')
    .replace(/^ä»¥ä¸‹æ˜¯.*?ç¿»è¯‘.*?ï¼š\s*/i, '')
    .replace(/^ä»¥ä¸‹æ˜¯.*?è½¬æ¢.*?ï¼š\s*/i, '')
    .replace(/^ä»¥ä¸‹æ˜¯.*?ï¼š\s*/i, '')
    .replace(/^.*?ç¿»è¯‘ç»“æœ.*?ï¼š\s*/i, '')
    .replace(/^.*?è½¬æ¢ç»“æœ.*?ï¼š\s*/i, '')
    .trim()
  
  // ç§»é™¤ä»£ç å—æ ‡è®° (```xml, ```markdown, ``` ç­‰)
  // åŒ¹é…å¼€å¤´çš„ä»£ç å—æ ‡è®°
  cleaned = cleaned.replace(/^```[\w]*\n?/, '')
  // åŒ¹é…ç»“å°¾çš„ä»£ç å—æ ‡è®°
  cleaned = cleaned.replace(/\n?```$/, '')
  
  return cleaned.trim()
}

/**
 * æ¸…ç†æ ¼å¼/è¯­è¨€è½¬æ¢åçš„AIå“åº”ï¼ˆæ›´å½»åº•çš„æ¸…ç†ï¼‰
 */
export const cleanConvertedResponse = (response: string): string => {
  if (!response) return ''
  
  let cleaned = response.trim()
  
  // ç§»é™¤ä»£ç å—æ ‡è®°ï¼ˆå¼€å¤´ï¼‰
  // åŒ¹é… ```xml, ```markdown, ```plaintext, ``` ç­‰
  cleaned = cleaned.replace(/^```[a-z]*\n?/i, '')
  
  // ç§»é™¤ä»£ç å—æ ‡è®°ï¼ˆç»“å°¾ï¼‰
  cleaned = cleaned.replace(/\n?```\s*$/i, '')
  
  // ç§»é™¤AIä»‹ç»æ€§æ–‡å­—ï¼ˆå¼€å¤´ï¼‰
  const introPatterns = [
    /^Here\s+is\s+the.*?:\s*/i,
    /^ä»¥ä¸‹æ˜¯.*?ï¼š\s*/i,
    /^è¿™æ˜¯.*?ï¼š\s*/i,
    /^.*?å¦‚ä¸‹.*?ï¼š\s*/i,
    /^.*?ç»“æœ.*?ï¼š\s*/i
  ]
  
  for (const pattern of introPatterns) {
    cleaned = cleaned.replace(pattern, '')
  }
  
  return cleaned.trim()
}

/**
 * æ£€æŸ¥AIå“åº”ä¸­æ˜¯å¦åŒ…å«ç»“æŸå¯¹è¯çš„å†³ç­–
 */
export const checkAIDecision = (response: string): boolean => {
  try {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«è¯„ä¼°æ ‡ç­¾
    const assessmentMatch = response.match(/<ASSESSMENT>([\s\S]*?)<\/ASSESSMENT>/i)
    if (!assessmentMatch) {
      return false // æ²¡æœ‰è¯„ä¼°æ ‡ç­¾ï¼Œç»§ç»­å¯¹è¯
    }
    
    const assessmentContent = assessmentMatch[1]
    
    // æå–DECISIONå­—æ®µ
    const decisionMatch = assessmentContent.match(/DECISION:\s*\[([^\]]+)\]/i)
    if (decisionMatch) {
      const decision = decisionMatch[1].trim().toUpperCase()
      return decision === 'END_NOW'
    }
    
    return false
  } catch (error) {
    return false // è§£æé”™è¯¯æ—¶ç»§ç»­å¯¹è¯
  }
}
````


## src/utils/chartLazyLoader.ts

```ts
/**
 * å›¾è¡¨åº“æ‡’åŠ è½½å·¥å…·
 * ç»Ÿä¸€ç®¡ç† EChartsã€D3 ç­‰é‡å‹å›¾è¡¨åº“çš„æŒ‰éœ€åŠ è½½
 */

// åº“å®ä¾‹ç¼“å­˜
let echartsInstance: any = null
let d3Instance: any = null
let mermaidInstance: any = null

// åŠ è½½çŠ¶æ€
const loadingStates = {
  echarts: false,
  d3: false,
  mermaid: false
}

// åŠ è½½ Promise ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
const loadingPromises = {
  echarts: null as Promise<any> | null,
  d3: null as Promise<any> | null,
  mermaid: null as Promise<any> | null
}

/**
 * æ‡’åŠ è½½ ECharts
 * @returns Promise<ECharts>
 */
export async function loadECharts(): Promise<any> {
  // å¦‚æœå·²åŠ è½½ï¼Œç›´æ¥è¿”å›
  if (echartsInstance) {
    return echartsInstance
  }

  // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œè¿”å›åŠ è½½ä¸­çš„ Promise
  if (loadingPromises.echarts) {
    return loadingPromises.echarts
  }

  // å¼€å§‹åŠ è½½
  loadingStates.echarts = true
  loadingPromises.echarts = import('echarts').then((module) => {
    echartsInstance = module.default || module
    loadingStates.echarts = false
    loadingPromises.echarts = null
    return echartsInstance
  }).catch((error) => {
    loadingStates.echarts = false
    loadingPromises.echarts = null
    console.error('Failed to load ECharts:', error)
    throw error
  })

  return loadingPromises.echarts
}

/**
 * æ‡’åŠ è½½ D3
 * @returns Promise<D3>
 */
export async function loadD3(): Promise<any> {
  // å¦‚æœå·²åŠ è½½ï¼Œç›´æ¥è¿”å›
  if (d3Instance) {
    return d3Instance
  }

  // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œè¿”å›åŠ è½½ä¸­çš„ Promise
  if (loadingPromises.d3) {
    return loadingPromises.d3
  }

  // å¼€å§‹åŠ è½½
  loadingStates.d3 = true
  loadingPromises.d3 = import('d3').then((module) => {
    d3Instance = module
    loadingStates.d3 = false
    loadingPromises.d3 = null
    return d3Instance
  }).catch((error) => {
    loadingStates.d3 = false
    loadingPromises.d3 = null
    console.error('Failed to load D3:', error)
    throw error
  })

  return loadingPromises.d3
}

/**
 * æ‡’åŠ è½½ Mermaid
 * @returns Promise<Mermaid>
 */
export async function loadMermaid(): Promise<any> {
  // å¦‚æœå·²åŠ è½½ï¼Œç›´æ¥è¿”å›
  if (mermaidInstance) {
    return mermaidInstance
  }

  // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œè¿”å›åŠ è½½ä¸­çš„ Promise
  if (loadingPromises.mermaid) {
    return loadingPromises.mermaid
  }

  // å¼€å§‹åŠ è½½
  loadingStates.mermaid = true
  loadingPromises.mermaid = import('mermaid').then((module) => {
    mermaidInstance = module.default || module
    loadingStates.mermaid = false
    loadingPromises.mermaid = null
    return mermaidInstance
  }).catch((error) => {
    loadingStates.mermaid = false
    loadingPromises.mermaid = null
    console.error('Failed to load Mermaid:', error)
    throw error
  })

  return loadingPromises.mermaid
}

/**
 * é¢„åŠ è½½æ‰€æœ‰å›¾è¡¨åº“ï¼ˆå¯é€‰ï¼Œç”¨äºæå‰åŠ è½½ï¼‰
 */
export async function preloadAllCharts(): Promise<void> {
  await Promise.all([
    loadECharts().catch(() => {}),
    loadD3().catch(() => {}),
    loadMermaid().catch(() => {})
  ])
}

/**
 * æ£€æŸ¥åº“æ˜¯å¦æ­£åœ¨åŠ è½½
 */
export function isLoading(library: 'echarts' | 'd3' | 'mermaid'): boolean {
  return loadingStates[library]
}

/**
 * æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
 */
export function isLoaded(library: 'echarts' | 'd3' | 'mermaid'): boolean {
  switch (library) {
    case 'echarts':
      return echartsInstance !== null
    case 'd3':
      return d3Instance !== null
    case 'mermaid':
      return mermaidInstance !== null
    default:
      return false
  }
}

/**
 * æ¸…é™¤ç¼“å­˜ï¼ˆç”¨äºæµ‹è¯•æˆ–é‡æ–°åŠ è½½ï¼‰
 */
export function clearCache(): void {
  echartsInstance = null
  d3Instance = null
  mermaidInstance = null
  loadingPromises.echarts = null
  loadingPromises.d3 = null
  loadingPromises.mermaid = null
}

```


## src/utils/clipboardUtils.ts

```ts
/**
 * è·¨æµè§ˆå™¨å¤åˆ¶åˆ°å‰ªè´´æ¿å·¥å…·å‡½æ•°
 * æ”¯æŒç°ä»£ Clipboard API å’Œä¼ ç»Ÿ execCommand é™çº§æ–¹æ¡ˆ
 */

/**
 * å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿ï¼ˆæ”¯æŒ HTTP ç¯å¢ƒï¼‰
 * @param text è¦å¤åˆ¶çš„æ–‡æœ¬
 * @returns Promise<void>
 */
export async function copyToClipboard(text: string): Promise<void> {
  // æ–¹æ¡ˆ1: å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API (ä»…åœ¨ HTTPS æˆ– localhost å¯ç”¨)
  if (navigator.clipboard && window.isSecureContext) {
    try {
      await navigator.clipboard.writeText(text)
      return
    } catch (err) {
      console.warn('Clipboard API å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ:', err)
      // å¦‚æœå¤±è´¥ï¼Œç»§ç»­å°è¯•é™çº§æ–¹æ¡ˆ
    }
  }

  // æ–¹æ¡ˆ2: ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand (å…¼å®¹ HTTP ç¯å¢ƒ)
  return fallbackCopyToClipboard(text)
}

/**
 * é™çº§å¤åˆ¶æ–¹æ¡ˆ - ä½¿ç”¨ document.execCommand
 * å…¼å®¹ä¸æ”¯æŒ Clipboard API æˆ–éå®‰å…¨ä¸Šä¸‹æ–‡çš„ç¯å¢ƒ
 */
function fallbackCopyToClipboard(text: string): Promise<void> {
  return new Promise((resolve, reject) => {
    // åˆ›å»ºä¸´æ—¶ textarea å…ƒç´ 
    const textarea = document.createElement('textarea')
    textarea.value = text
    
    // è®¾ç½®æ ·å¼ï¼Œä½¿å…¶ä¸å¯è§
    textarea.style.position = 'fixed'
    textarea.style.top = '0'
    textarea.style.left = '0'
    textarea.style.width = '2em'
    textarea.style.height = '2em'
    textarea.style.padding = '0'
    textarea.style.border = 'none'
    textarea.style.outline = 'none'
    textarea.style.boxShadow = 'none'
    textarea.style.background = 'transparent'
    textarea.style.opacity = '0'
    
    // æ·»åŠ åˆ° DOM
    document.body.appendChild(textarea)
    
    // èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
    textarea.focus()
    textarea.select()
    
    // iOS å…¼å®¹
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      const range = document.createRange()
      range.selectNodeContents(textarea)
      const selection = window.getSelection()
      if (selection) {
        selection.removeAllRanges()
        selection.addRange(range)
      }
      textarea.setSelectionRange(0, 999999)
    }
    
    try {
      // æ‰§è¡Œå¤åˆ¶å‘½ä»¤
      const successful = document.execCommand('copy')
      
      // ç§»é™¤ä¸´æ—¶å…ƒç´ 
      document.body.removeChild(textarea)
      
      if (successful) {
        resolve()
      } else {
        reject(new Error('execCommand("copy") è¿”å› false'))
      }
    } catch (err) {
      // ç§»é™¤ä¸´æ—¶å…ƒç´ 
      document.body.removeChild(textarea)
      reject(err)
    }
  })
}

/**
 * æ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦æ”¯æŒ Clipboard API
 */
export function isClipboardAPISupported(): boolean {
  return !!(navigator.clipboard && window.isSecureContext)
}

/**
 * è·å–å‰ªè´´æ¿æ”¯æŒä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
 */
export function getClipboardSupportInfo(): {
  hasClipboardAPI: boolean
  isSecureContext: boolean
  protocol: string
  fallbackOnly: boolean
} {
  return {
    hasClipboardAPI: !!navigator.clipboard,
    isSecureContext: window.isSecureContext,
    protocol: window.location.protocol,
    fallbackOnly: !navigator.clipboard || !window.isSecureContext
  }
}

```


## src/utils/ensureAIConfig.ts

```ts
import { useProviderStore } from '@/stores/providerStore'
import { useNotificationStore } from '@/stores/notificationStore'

/**
 * ç¡®ä¿ AI é…ç½®å·²æ­£ç¡®è®¾ç½®
 * å¦‚æœæ²¡æœ‰é€‰æ‹©æä¾›å•†/æ¨¡å‹ï¼Œä¼šå°è¯•è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„
 * @returns { provider, model } è¿”å›å¯ç”¨çš„æä¾›å•†å’Œæ¨¡å‹ï¼Œå¦‚æœæ— æ³•è·å–åˆ™æŠ›å‡ºé”™è¯¯
 */
export async function ensureAIConfig(): Promise<{ provider: any; model: any }> {
  const providerStore = useProviderStore()
  const notificationStore = useNotificationStore()

  // ç¡®ä¿å·²åˆå§‹åŒ–
  if (!providerStore.isInitialized) {
    notificationStore.error('AIæ¨¡å‹é…ç½®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™å†è¯•')
    throw new Error('Provider store not initialized')
  }

  let provider = providerStore.currentProvider
  let model = providerStore.currentModel

  // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œå°è¯•è‡ªåŠ¨é€‰æ‹©
  if (!provider || !model) {
    if (providerStore.enabledProviders.length > 0) {
      const firstProvider = providerStore.enabledProviders[0]
      providerStore.setSelectedProvider(firstProvider.id)
      if (firstProvider.models.length > 0) {
        providerStore.setSelectedModel(firstProvider.models[0].id)
      }

      // é‡æ–°è·å–
      provider = providerStore.currentProvider
      model = providerStore.currentModel

      if (!provider || !model) {
        notificationStore.warning('è¯·å…ˆåœ¨å¯¼èˆªæ é€‰æ‹©AIæ¨¡å‹')
        throw new Error('No valid model selection')
      }

      console.log('[ensureAIConfig] è‡ªåŠ¨é€‰æ‹©æ¨¡å‹æˆåŠŸ:', provider.name, model.name)
    } else {
      notificationStore.error('è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPIå¯†é’¥')
      throw new Error('No configured providers')
    }
  }

  return { provider, model }
}
```


## src/utils/fileUtils.ts

```ts
import type { MessageAttachment } from '@/stores/promptStore'

// æ”¯æŒçš„æ–‡ä»¶ç±»å‹é…ç½®
export const FILE_CONFIG = {
  // å›¾ç‰‡ç±»å‹
  image: {
    types: [
      'image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif', 
      'image/bmp', 'image/tiff', 'image/svg+xml', 'image/heic', 'image/heif',
      'image/x-icon'
    ],
    extensions: [
      '.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp', '.tiff', '.tif', 
      '.svg', '.heic', '.heif', '.ico'
    ],
    maxSize: 20 * 1024 * 1024, // 20MB
    icon: 'ğŸ–¼ï¸'
  },
  // æ–‡æ¡£ç±»å‹
  document: {
    types: [
      'application/pdf', 'text/plain', 'text/markdown', 'text/csv',
      'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'application/rtf', 'application/json', 'application/xml', 'text/xml',
      'text/html', 'text/css', 'text/javascript', 'text/typescript', 'application/javascript',
      'text/x-python', 'text/x-java', 'text/x-c', 'text/x-cpp',
      'application/x-yaml', 'text/yaml'
    ],
    extensions: [
      '.pdf', '.txt', '.md', '.csv', '.doc', '.docx', '.xls', '.xlsx', 
      '.ppt', '.pptx', '.rtf', '.json', '.xml', '.html', '.htm', '.css', 
      '.js', '.ts', '.jsx', '.tsx', '.py', '.java', '.c', '.cpp', '.h', '.hpp', 
      '.yaml', '.yml', '.log', '.ini', '.cfg', '.conf', '.sh', '.bat', '.ps1',
      '.sql', '.go', '.rs', '.php', '.rb', '.swift', '.kt', '.scala', '.r'
    ],
    maxSize: 25 * 1024 * 1024, // 25MB
    icon: 'ğŸ“„'
  },
  // éŸ³é¢‘ç±»å‹
  audio: {
    types: [
      'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg', 'audio/aac', 
      'audio/flac', 'audio/m4a', 'audio/x-ms-wma', 'audio/webm'
    ],
    extensions: [
      '.mp3', '.wav', '.ogg', '.aac', '.flac', '.m4a', '.wma', '.webm'
    ],
    maxSize: 50 * 1024 * 1024, // 50MB
    icon: 'ğŸµ'
  },
  // è§†é¢‘ç±»å‹
  video: {
    types: [
      'video/mp4', 'video/webm', 'video/ogg', 'video/x-msvideo', 'video/quicktime', 
      'video/x-ms-wmv', 'video/x-flv', 'video/x-matroska'
    ],
    extensions: [
      '.mp4', '.webm', '.ogv', '.avi', '.mov', '.wmv', '.flv', '.mkv', '.qt'
    ],
    maxSize: 100 * 1024 * 1024, // 100MB
    icon: 'ğŸ¬'
  }
}

// è·å–æ‰€æœ‰æ”¯æŒçš„MIMEç±»å‹
export const getAllSupportedTypes = (): string[] => {
  return Object.values(FILE_CONFIG).flatMap(config => config.types)
}

// è·å–æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å
export const getAllSupportedExtensions = (): string[] => {
  return Object.values(FILE_CONFIG).flatMap(config => config.extensions)
}

// æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–æ–‡ä»¶ç±»å‹åˆ†ç±»
export const getFileTypeCategoryByExtension = (fileName: string): 'image' | 'document' | 'audio' | 'video' | null => {
  const extension = '.' + fileName.split('.').pop()?.toLowerCase()
  
  for (const [category, config] of Object.entries(FILE_CONFIG)) {
    if (config.extensions.includes(extension)) {
      return category as 'image' | 'document' | 'audio' | 'video'
    }
  }
  return null
}

// æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–MIMEç±»å‹
export const getMimeTypeByExtension = (fileName: string): string => {
  const extension = '.' + fileName.split('.').pop()?.toLowerCase()
  
  // å®Œæ•´çš„æ–‡ä»¶æ‰©å±•ååˆ°MIMEç±»å‹æ˜ å°„
  const extensionToMimeType: Record<string, string> = {
    // å›¾ç‰‡ç±»å‹
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.png': 'image/png',
    '.gif': 'image/gif',
    '.webp': 'image/webp',
    '.bmp': 'image/bmp',
    '.tiff': 'image/tiff',
    '.tif': 'image/tiff',
    '.svg': 'image/svg+xml',
    '.heic': 'image/heic',
    '.heif': 'image/heif',
    '.ico': 'image/x-icon',
    
    // æ–‡æ¡£ç±»å‹
    '.pdf': 'application/pdf',
    '.txt': 'text/plain',
    '.md': 'text/markdown',
    '.csv': 'text/csv',
    '.doc': 'application/msword',
    '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    '.xls': 'application/vnd.ms-excel',
    '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    '.ppt': 'application/vnd.ms-powerpoint',
    '.pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    '.rtf': 'application/rtf',
    '.json': 'application/json',
    '.xml': 'application/xml',
    '.html': 'text/html',
    '.htm': 'text/html',
    '.css': 'text/css',
    '.js': 'text/javascript',
    '.ts': 'text/typescript',
    '.py': 'text/x-python',
    '.java': 'text/x-java',
    '.c': 'text/x-c',
    '.cpp': 'text/x-cpp',
    '.h': 'text/x-c',
    '.hpp': 'text/x-cpp',
    '.yaml': 'application/x-yaml',
    '.yml': 'application/x-yaml',
    '.log': 'text/plain',
    '.ini': 'text/plain',
    '.cfg': 'text/plain',
    '.conf': 'text/plain',
    
    // éŸ³é¢‘ç±»å‹
    '.mp3': 'audio/mpeg',
    '.wav': 'audio/wav',
    '.ogg': 'audio/ogg',
    '.aac': 'audio/aac',
    '.flac': 'audio/flac',
    '.m4a': 'audio/m4a',
    '.wma': 'audio/x-ms-wma',
    
    // è§†é¢‘ç±»å‹
    '.mp4': 'video/mp4',
    '.webm': 'video/webm',
    '.ogv': 'video/ogg',
    '.avi': 'video/x-msvideo',
    '.mov': 'video/quicktime',
    '.wmv': 'video/x-ms-wmv',
    '.flv': 'video/x-flv',
    '.mkv': 'video/x-matroska',
    '.qt': 'video/quicktime'
  }
  
  return extensionToMimeType[extension] || 'application/octet-stream'
}
export const getFileTypeCategory = (mimeType: string, fileName?: string): 'image' | 'document' | 'audio' | 'video' | null => {
  // é¦–å…ˆå°è¯•é€šè¿‡MIMEç±»å‹åˆ¤æ–­
  for (const [category, config] of Object.entries(FILE_CONFIG)) {
    if (config.types.includes(mimeType)) {
      return category as 'image' | 'document' | 'audio' | 'video'
    }
  }
  
  // å¦‚æœMIMEç±»å‹åˆ¤æ–­å¤±è´¥ï¼Œå°è¯•é€šè¿‡æ–‡ä»¶æ‰©å±•ååˆ¤æ–­
  if (fileName) {
    return getFileTypeCategoryByExtension(fileName)
  }
  
  // å¯¹äºä¸€äº›å¸¸è§çš„é€šç”¨MIMEç±»å‹ï¼Œå°è¯•é€šè¿‡æ‰©å±•ååˆ¤æ–­
  if (mimeType === 'application/octet-stream' || mimeType === '' || !mimeType) {
    if (fileName) {
      return getFileTypeCategoryByExtension(fileName)
    }
  }
  
  return null
}

// æ ¹æ®æ–‡ä»¶ç±»å‹è·å–å›¾æ ‡
export const getFileIcon = (type: 'image' | 'document' | 'audio' | 'video'): string => {
  const config = FILE_CONFIG[type as keyof typeof FILE_CONFIG]
  return config?.icon || 'ğŸ“'
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
export const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 B'
  
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]
}

// éªŒè¯æ–‡ä»¶ç±»å‹
export const validateFileType = (file: File): { valid: boolean; error?: string } => {
  const category = getFileTypeCategory(file.type, file.name)
  
  if (!category) {
    const supportedExtensions = getAllSupportedExtensions().join(', ')
    return {
      valid: false,
      error: `ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ã€‚æ”¯æŒçš„æ ¼å¼ï¼š${supportedExtensions}`
    }
  }
  
  return { valid: true }
}

// éªŒè¯æ–‡ä»¶å¤§å°
export const validateFileSize = (file: File): { valid: boolean; error?: string } => {
  const category = getFileTypeCategory(file.type, file.name)
  if (!category) {
    return { valid: false, error: 'æœªçŸ¥çš„æ–‡ä»¶ç±»å‹' }
  }
  
  const config = FILE_CONFIG[category as keyof typeof FILE_CONFIG]
  if (!config) {
    return { valid: false, error: 'æœªçŸ¥çš„æ–‡ä»¶ç±»å‹é…ç½®' }
  }
  
  if (file.size > config.maxSize) {
    return {
      valid: false,
      error: `æ–‡ä»¶è¿‡å¤§ã€‚æœ€å¤§æ”¯æŒ ${formatFileSize(config.maxSize)}`
    }
  }
  
  return { valid: true }
}

// å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
export const fileToBase64 = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = () => {
      const result = reader.result as string
      // ç§»é™¤data:image/jpeg;base64,å‰ç¼€ï¼Œåªä¿ç•™Base64æ•°æ®
      const base64Data = result.split(',')[1]
      
      
      resolve(base64Data)
    }
    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
    reader.readAsDataURL(file)
  })
}

// åˆ›å»ºMessageAttachmentå¯¹è±¡
export const createMessageAttachment = async (file: File): Promise<MessageAttachment> => {
  
  // ä¼˜å…ˆé€šè¿‡æ–‡ä»¶æ‰©å±•åç¡®å®šMIMEç±»å‹ï¼Œè¿™æ ·æ›´å‡†ç¡®
  const inferredMimeType = getMimeTypeByExtension(file.name)
  const finalMimeType = inferredMimeType !== 'application/octet-stream' ? inferredMimeType : file.type
  
  
  // éªŒè¯æ–‡ä»¶ï¼ˆä½¿ç”¨æ¨æ–­çš„MIMEç±»å‹ï¼‰
  const mockFileForValidation = {
    ...file,
    type: finalMimeType
  } as File
  
  const typeValidation = validateFileType(mockFileForValidation)
  if (!typeValidation.valid) {
    throw new Error(typeValidation.error)
  }
  
  const sizeValidation = validateFileSize(mockFileForValidation)
  if (!sizeValidation.valid) {
    throw new Error(sizeValidation.error)
  }
  
  // è½¬æ¢ä¸ºBase64
  const data = await fileToBase64(file)
  
  // è·å–æ–‡ä»¶ç±»å‹åˆ†ç±»ï¼ˆä½¿ç”¨æœ€ç»ˆç¡®å®šçš„MIMEç±»å‹ï¼‰
  const type = getFileTypeCategory(finalMimeType, file.name)!
  
  
  return {
    id: `attachment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    name: file.name,
    type,
    mimeType: finalMimeType, // ä½¿ç”¨æ¨æ–­çš„MIMEç±»å‹
    size: file.size,
    data,
    url: URL.createObjectURL(file) // ç”¨äºé¢„è§ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
  }
}

// æ‰¹é‡å¤„ç†æ–‡ä»¶
export const processFiles = async (files: File[]): Promise<{
  attachments: MessageAttachment[]
  errors: string[]
}> => {
  const attachments: MessageAttachment[] = []
  const errors: string[] = []
  
  for (const file of files) {
    try {
      const attachment = await createMessageAttachment(file)
      attachments.push(attachment)
    } catch (error) {
      errors.push(`${file.name}: ${error instanceof Error ? error.message : 'å¤„ç†å¤±è´¥'}`)
    }
  }
  
  return { attachments, errors }
}

// æ¸…ç†ä¸´æ—¶URL
export const cleanupAttachmentUrls = (attachments: MessageAttachment[]) => {
  attachments.forEach(attachment => {
    if (attachment.url) {
      URL.revokeObjectURL(attachment.url)
    }
  })
}

// æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€
export const isMultimodalSupported = (modelId: string): boolean => {
  const modelName = modelId.toLowerCase()
  
  // OpenAIæ¨¡å‹
  if (modelName.includes('gpt-4') && (modelName.includes('vision') || modelName.includes('4o'))) {
    return true
  }
  
  // Geminiæ¨¡å‹
  if (modelName.includes('gemini') && (modelName.includes('1.5') || modelName.includes('2.'))) {
    return true
  }
  
  // Claudeæ¨¡å‹
  if (modelName.includes('claude') && modelName.includes('3')) {
    return true
  }
  
  return false
}

```


## src/utils/jsonParser.ts

````ts
/**
 * ä»AIå“åº”ä¸­æå–å¹¶è§£æJSON
 * å¤„ç†markdownä»£ç å—åŒ…è£¹çš„JSON (```json\n{...}\n```)
 */
export function parseAIJsonResponse(content: string): any {
  if (!content) {
    throw new Error('Empty content')
  }

  // å°è¯•ç›´æ¥è§£æ
  try {
    return JSON.parse(content)
  } catch {
    // å¦‚æœç›´æ¥è§£æå¤±è´¥,å°è¯•ä»markdownä»£ç å—ä¸­æå–
  }

  // åŒ¹é… ```json ... ``` æˆ– ``` ... ```
  const codeBlockRegex = /```(?:json)?\s*\n?([\s\S]*?)\n?```/
  const match = content.match(codeBlockRegex)
  
  if (match && match[1]) {
    try {
      return JSON.parse(match[1].trim())
    } catch (e) {
      throw new Error(`Failed to parse JSON from code block: ${e}`)
    }
  }

  // å¦‚æœæ²¡æœ‰ä»£ç å—,å°è¯•æ‰¾åˆ°ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª }
  const firstBrace = content.indexOf('{')
  const lastBrace = content.lastIndexOf('}')
  
  if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
    try {
      const jsonStr = content.substring(firstBrace, lastBrace + 1)
      return JSON.parse(jsonStr)
    } catch (e) {
      throw new Error(`Failed to parse extracted JSON: ${e}`)
    }
  }

  throw new Error('No valid JSON found in content')
}

````


## src/utils/playgroundGlobals.ts

```ts
import { marked } from 'marked'
import hljs from 'highlight.js/lib/core'
import javascript from 'highlight.js/lib/languages/javascript'
import typescript from 'highlight.js/lib/languages/typescript'
import xml from 'highlight.js/lib/languages/xml'
import jsonLang from 'highlight.js/lib/languages/json'
import python from 'highlight.js/lib/languages/python'
import markdown from 'highlight.js/lib/languages/markdown'
import bash from 'highlight.js/lib/languages/bash'
import shell from 'highlight.js/lib/languages/shell'
import ruby from 'highlight.js/lib/languages/ruby'
import go from 'highlight.js/lib/languages/go'
import java from 'highlight.js/lib/languages/java'
import csharp from 'highlight.js/lib/languages/csharp'
import cssLang from 'highlight.js/lib/languages/css'
import scss from 'highlight.js/lib/languages/scss'
import sql from 'highlight.js/lib/languages/sql'
import 'highlight.js/styles/github.css'

const win = typeof window !== 'undefined' ? window : undefined

if (win) {
  if (!win.marked) {
    win.marked = marked
  }

  if (!win.hljs) {
    hljs.registerLanguage('javascript', javascript)
    hljs.registerLanguage('typescript', typescript)
    hljs.registerLanguage('xml', xml)
    hljs.registerLanguage('json', jsonLang)
    hljs.registerLanguage('python', python)
    hljs.registerLanguage('markdown', markdown)
    hljs.registerLanguage('bash', bash)
    hljs.registerLanguage('shell', shell)
    hljs.registerLanguage('ruby', ruby)
    hljs.registerLanguage('go', go)
    hljs.registerLanguage('java', java)
    hljs.registerLanguage('csharp', csharp)
    hljs.registerLanguage('css', cssLang)
    hljs.registerLanguage('scss', scss)
    hljs.registerLanguage('sql', sql)
    win.hljs = hljs
  }

  if (!win.lucide) {
    win.lucide = { createIcons: () => {} }
  }
}

```


## src/views/LoginView.tsx

```tsx
import { useState, useEffect } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { Eye, EyeOff, AlertCircle, Loader2 } from 'lucide-react'
import { useAuthStore } from '@/stores/authStore'
import { isDebugMode as checkDebugMode } from '@/services/mockApiService'

export default function LoginView() {
  const navigate = useNavigate()
  const [searchParams] = useSearchParams()
  // ä½¿ç”¨é€‰æ‹©å™¨é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  const getAuthConfig = useAuthStore((state) => state.getAuthConfig)
  const loginWithPassword = useAuthStore((state) => state.loginWithPassword)
  const token = useAuthStore((state) => state.token)
  const user = useAuthStore((state) => state.user)
  
  const isDebugMode = checkDebugMode()
  
  const [authConfig, setAuthConfig] = useState({
    local_auth_enabled: true
  })
  
  const [loginForm, setLoginForm] = useState({
    password: ''
  })
  
  const [isLoading, setIsLoading] = useState(true)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [errorMessage, setErrorMessage] = useState('')
  const [showPassword, setShowPassword] = useState(false)
  const [rememberMe, setRememberMe] = useState(true)
  
  const [loginErrors, setLoginErrors] = useState<{
    password?: string
  }>({})
  
  const validatePassword = (password: string): string | null => {
    if (!password) return 'è¯·è¾“å…¥å¯†ç '
    return null
  }
  
  const validateLoginForm = () => {
    const errors: { password?: string } = {}
    const passwordError = validatePassword(loginForm.password)
    
    if (passwordError) errors.password = passwordError
    
    setLoginErrors(errors)
    return Object.keys(errors).length === 0
  }
  
  const clearFieldError = (field: 'password') => {
    if (loginErrors[field]) {
      setLoginErrors(prev => {
        const newErrors = { ...prev }
        delete newErrors[field]
        return newErrors
      })
    }
  }
  
  const isLoginFormValid = loginForm.password.length > 0 && Object.keys(loginErrors).length === 0
  
  const fetchAuthConfig = async () => {
    try {
      const config = await getAuthConfig()
      if (config) {
        setAuthConfig(config)
      }
    } catch (error) {
      console.error('è·å–è®¤è¯é…ç½®å¤±è´¥:', error)
    } finally {
      setIsLoading(false)
    }
  }
  
  const saveRememberMe = () => {
    if (rememberMe) {
      localStorage.setItem('yprompt_remember_me', 'true')
    } else {
      localStorage.removeItem('yprompt_remember_me')
    }
  }
  
  const handleLocalLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!validateLoginForm()) {
      return
    }
    
    setErrorMessage('')
    setIsSubmitting(true)
    
    try {
      const result = await loginWithPassword(
        'admin',  // å›ºå®šç”¨æˆ·å
        loginForm.password
      )
      
      if (result.success) {
        saveRememberMe()
        // ç™»å½•æˆåŠŸåç«‹å³è·³è½¬
        const redirect = searchParams.get('redirect')
        if (redirect && redirect !== '/login') {
          navigate(redirect, { replace: true })
        } else {
          navigate('/generate', { replace: true })
        }
      } else {
        setErrorMessage(result.message || 'å¯†ç é”™è¯¯')
      }
    } catch (error) {
      setErrorMessage(error instanceof Error ? error.message : 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      console.error('ç™»å½•å¤±è´¥:', error)
    } finally {
      setIsSubmitting(false)
    }
  }
  
  useEffect(() => {
    const isLoggedIn = !!token && !!user
    if (isLoggedIn) {
      navigate('/generate', { replace: true })
      return
    }
    
    const savedRememberMe = localStorage.getItem('yprompt_remember_me')
    if (savedRememberMe === 'true') {
      setRememberMe(true)
    }
    
    fetchAuthConfig()
  }, [token, user, navigate])
  
  return (
    <div className="login-container min-h-screen flex items-center justify-center bg-gradient-to-br from-[#667eea] to-[#764ba2] p-5 relative overflow-hidden">
      <div className="login-container-bg absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-[radial-gradient(circle,rgba(255,255,255,0.1)_1px,transparent_1px)] bg-[length:50px_50px] animate-[float_20s_linear_infinite] pointer-events-none" />
      
      <div className="login-card bg-white rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.15)] w-full max-w-[420px] p-10 relative z-10 animate-[slideUp_0.4s_ease-out]">
        {/* Logoå’Œæ ‡é¢˜ */}
        <div className="login-header text-center mb-8">
          <div className="logo-wrapper mb-4 flex justify-center">
            <div className="logo-icon w-16 h-16 bg-gradient-to-br from-[#667eea] to-[#764ba2] rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-[0_4px_12px_rgba(102,126,234,0.3)]">
              YP
            </div>
          </div>
          <h1 className="login-title text-[32px] font-bold text-[#1a202c] m-0 mb-2 tracking-tight">
            YPrompt
          </h1>
          <p className="login-subtitle text-sm text-[#718096] m-0">
            æç¤ºè¯ç®¡ç†ç³»ç»Ÿ
          </p>
          {/* Debug æ¨¡å¼æç¤º */}
          {isDebugMode && (
            <div className="debug-badge inline-flex items-center gap-1.5 mt-3 px-3 py-1.5 bg-[rgba(255,193,7,0.1)] border border-[rgba(255,193,7,0.3)] rounded-lg text-xs text-[#856404] font-medium">
              <span className="debug-icon text-sm">ğŸ›</span>
              <span>Debug æ¨¡å¼ï¼ˆMock APIï¼‰</span>
            </div>
          )}
        </div>

        {/* åŠ è½½çŠ¶æ€ */}
        {isLoading ? (
          <div className="loading-state text-center py-[60px]">
            <div className="loading-spinner w-12 h-12 border-4 border-[#e2e8f0] border-t-[#667eea] rounded-full animate-spin mx-auto mb-4" />
            <p className="loading-text text-[#718096] text-sm">æ­£åœ¨åŠ è½½...</p>
          </div>
        ) : (
          /* ç™»å½•è¡¨å• */
          <div className="login-content">
            {authConfig.local_auth_enabled && (
              <div className="login-section mb-5">
                <form onSubmit={handleLocalLogin} className="login-form mt-5">
                  {/* å¯†ç  */}
                  <div className="form-group mb-5">
                    <label htmlFor="password" className="block mb-2 text-sm font-medium text-[#4a5568]">
                      å¯†ç 
                    </label>
                    <div className="input-wrapper relative flex items-center">
                      <input
                        id="password"
                        type={showPassword ? 'text' : 'password'}
                        value={loginForm.password}
                        onChange={(e) => {
                          setLoginForm({ password: e.target.value })
                          clearFieldError('password')
                        }}
                        onBlur={validateLoginForm}
                        className={`form-input w-full px-4 py-3 pr-11 border-2 rounded-lg text-sm transition-all bg-white ${
                          loginErrors.password
                            ? 'border-[#e53e3e] focus:border-[#e53e3e] focus:shadow-[0_0_0_4px_rgba(229,62,62,0.1)]'
                            : 'border-[#e2e8f0] focus:border-[#667eea] focus:shadow-[0_0_0_4px_rgba(102,126,234,0.1)]'
                        } ${isSubmitting ? 'bg-[#f7fafc] cursor-not-allowed opacity-70' : ''}`}
                        placeholder="è¯·è¾“å…¥å¯†ç "
                        disabled={isSubmitting}
                        autoComplete="current-password"
                      />
                      <button
                        type="button"
                        className="password-toggle absolute right-3 bg-none border-0 text-[#718096] cursor-pointer p-1 flex items-center justify-center transition-colors hover:text-[#4a5568] disabled:cursor-not-allowed disabled:opacity-50"
                        onClick={() => setShowPassword(!showPassword)}
                        disabled={isSubmitting}
                        tabIndex={-1}
                      >
                        {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                      </button>
                    </div>
                    {loginErrors.password && (
                      <div className="field-error mt-1.5 text-xs text-[#e53e3e] flex items-center gap-1">
                        {loginErrors.password}
                      </div>
                    )}
                  </div>

                  {/* è®°ä½æˆ‘ */}
                  <div className="form-options flex justify-between items-center mb-5">
                    <label className="checkbox-label flex items-center gap-2 text-sm text-[#4a5568] cursor-pointer select-none">
                      <input
                        type="checkbox"
                        checked={rememberMe}
                        onChange={(e) => setRememberMe(e.target.checked)}
                        className="checkbox-input w-4 h-4 cursor-pointer accent-[#667eea]"
                        disabled={isSubmitting}
                      />
                      <span>è®°ä½æˆ‘</span>
                    </label>
                  </div>

                  {/* é”™è¯¯æç¤º */}
                  {errorMessage && (
                    <div className="error-message px-4 py-3 bg-[#fed7d7] text-[#c53030] rounded-lg text-sm mb-4 flex items-center gap-2 border border-[#fc8181] animate-[fade_0.3s_ease]">
                      <AlertCircle size={16} />
                      <span>{errorMessage}</span>
                    </div>
                  )}

                  {/* ç™»å½•æŒ‰é’® */}
                  <button
                    type="submit"
                    className="btn btn-primary btn-block w-full px-6 py-3 rounded-lg text-[15px] font-medium cursor-pointer transition-all inline-flex items-center justify-center gap-2 bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white shadow-[0_4px_12px_rgba(102,126,234,0.3)] hover:translate-y-[-1px] hover:shadow-[0_6px_16px_rgba(102,126,234,0.4)] active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none"
                    disabled={isSubmitting || !isLoginFormValid}
                  >
                    {isSubmitting ? (
                      <>
                        <Loader2 size={18} className="spinning animate-spin" />
                        <span>ç™»å½•ä¸­...</span>
                      </>
                    ) : (
                      <span>ç™»å½•</span>
                    )}
                  </button>
                </form>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  )
}

```


## tailwind.config.js

```js
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [
    require('@tailwindcss/typography'),
  ],
}
```


## test-auto-generation.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯æµ‹è¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-ok {
      color: #10b981;
      font-weight: bold;
    }
    .status-error {
      color: #ef4444;
      font-weight: bold;
    }
    .status-warning {
      color: #f59e0b;
      font-weight: bold;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    h2 {
      color: #1f2937;
      margin-bottom: 15px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .step {
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #4F46E5;
      background: #f9fafb;
    }
    .step-error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    .step-success {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½æµ‹è¯•</h1>
    <p>æµ‹è¯•è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹å’Œä½¿ç”¨ AI æ¨¡å‹é…ç½®</p>
  </div>

  <div class="container">
    <h2>1. æµ‹è¯•æ­¥éª¤</h2>
    <button onclick="runFullTest()" id="test-btn">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <button onclick="checkConsoleLogs()">æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</button>
    <div id="test-status"></div>
  </div>

  <div class="container">
    <h2>2. æµ‹è¯•æµç¨‹</h2>
    <div id="test-flow"></div>
  </div>

  <div class="container">
    <h2>3. é…ç½®çŠ¶æ€</h2>
    <div id="config-status"></div>
  </div>

  <div class="container">
    <h2>4. æµ‹è¯•æ—¥å¿—</h2>
    <pre id="test-log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</pre>
  </div>

  <script>
    function log(message, type = 'info') {
      const logEl = document.getElementById('test-log')
      const timestamp = new Date().toLocaleTimeString()
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        debug: 'ğŸ”'
      }
      logEl.textContent += `[${timestamp}] ${emoji[type] || 'â„¹ï¸'} ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('test-status')
      const className = type === 'success' ? 'status-ok' :
                       type === 'error' ? 'status-error' : 'status-warning'

      statusEl.innerHTML = `<p class="${className}">${message}</p>`
    }

    function addStep(title, message, type = 'info') {
      const flowEl = document.getElementById('test-flow')
      const className = type === 'success' ? 'step-success' :
                       type === 'error' ? 'step-error' : ''

      flowEl.innerHTML += `
        <div class="step ${className}">
          <strong>${title}</strong>
          <div>${message}</div>
        </div>
      `
    }

    function checkConsoleLogs() {
      log('è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—', 'info')
    }

    function getProviderStoreState() {
      // å°è¯•ä» localStorage è·å–ä¸€äº›çŠ¶æ€ä¿¡æ¯
      const providerId = localStorage.getItem('yprompt_selected_provider') || '(æœªè®¾ç½®)'
      const modelId = localStorage.getItem('yprompt_selected_model') || '(æœªè®¾ç½®)'
      const streamMode = localStorage.getItem('yprompt_stream_mode') || 'true'

      return {
        providerId,
        modelId,
        streamMode: streamMode === 'true',
        hasProvider: providerId !== '(æœªè®¾ç½®)',
        hasModel: modelId !== '(æœªè®¾ç½®)'
      }
    }

    function updateConfigStatus() {
      const configStatus = getProviderStoreState()
      const configEl = document.getElementById('config-status')

      configEl.innerHTML = `
        <h3>å½“å‰é…ç½®çŠ¶æ€:</h3>
        <pre>${JSON.stringify(configStatus, null, 2)}</pre>
        <p class="${configStatus.hasProvider && configStatus.hasModel ? 'status-ok' : 'status-warning'}">
          ${configStatus.hasProvider && configStatus.hasModel ? 'âœ… é…ç½®å®Œæ•´' : 'âš ï¸ é…ç½®ä¸å®Œæ•´'}
        </p>
      `
    }

    async function runFullTest() {
      const testBtn = document.getElementById('test-btn')
      testBtn.disabled = true
      testBtn.textContent = 'æµ‹è¯•ä¸­...'

      log('ğŸš€ å¼€å§‹è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯åŠŸèƒ½æµ‹è¯•', 'info')
      updateStatus('æ­£åœ¨æµ‹è¯•...', 'info')

      try {
        // æ­¥éª¤ 1: æ£€æŸ¥é…ç½®çŠ¶æ€
        addStep('æ­¥éª¤ 1', 'æ£€æŸ¥ AI æ¨¡å‹é…ç½®çŠ¶æ€', 'info')
        const configStatus = getProviderStoreState()

        if (!configStatus.hasProvider || !configStatus.hasModel) {
          addStep('æ­¥éª¤ 1 - å¤±è´¥', 'ç¼ºå°‘æœ‰æ•ˆçš„ AI æ¨¡å‹é…ç½®', 'error')
          updateStatus('é…ç½®ä¸å®Œæ•´ï¼Œè¯·å…ˆåœ¨å¯¼èˆªæ é€‰æ‹© AI æ¨¡å‹', 'warning')
          log('âŒ é…ç½®ä¸å®Œæ•´: provider=' + configStatus.providerId + ', model=' + configStatus.modelId, 'error')
          testBtn.disabled = false
          testBtn.textContent = 'é‡æ–°æµ‹è¯•'
          return
        }

        addStep('æ­¥éª¤ 1 - æˆåŠŸ', 'æ£€æµ‹åˆ°æœ‰æ•ˆçš„ AI æ¨¡å‹é…ç½®', 'success')
        log('âœ… é…ç½®æ£€æŸ¥é€šè¿‡: provider=' + configStatus.providerId + ', model=' + configStatus.modelId, 'success')

        // æ­¥éª¤ 2: æ¨¡æ‹Ÿè¿›å…¥ç”Ÿæˆé¡µé¢
        addStep('æ­¥éª¤ 2', 'æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®ç”Ÿæˆé¡µé¢', 'info')
        updateConfigStatus()

        // è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°è¯•è®¿é—®ä¸»åº”ç”¨æ¥æµ‹è¯•å®é™…çš„è‡ªåŠ¨ç”ŸæˆåŠŸèƒ½
        const mainAppUrl = window.location.origin + '/'

        addStep('æ­¥éª¤ 2 - å®Œæˆ', 'å‡†å¤‡æµ‹è¯•è‡ªåŠ¨ç”ŸæˆåŠŸèƒ½', 'success')
        log('âœ… é…ç½®æ£€æŸ¥å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•å®é™…åŠŸèƒ½', 'success')

        // æ­¥éª¤ 3: æä¾›æµ‹è¯•é€‰é¡¹
        addStep('æ­¥éª¤ 3', 'å»ºè®®æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½:', 'info')
        log('ğŸ’¡ å»ºè®®æµ‹è¯•æµç¨‹:', 'info')
        log('1. æ‰“å¼€ä¸»åº”ç”¨ (ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®)', 'info')
        log('2. åœ¨ Chat ç•Œé¢è¾“å…¥éœ€æ±‚æè¿°', 'info')
        log('3. ç­‰å¾… AI ç”Ÿæˆéœ€æ±‚æŠ¥å‘Š', 'info')
        log('4. ç‚¹å‡»"è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯"æŒ‰é’®', 'info')
        log('5. éªŒè¯æ˜¯å¦èƒ½æ­£å¸¸æ‰§è¡Œ 4 ä¸ªæ­¥éª¤', 'info')

        updateStatus('âœ… é…ç½®æ£€æŸ¥é€šè¿‡ï¼è¯·åˆ°ä¸»åº”ç”¨æµ‹è¯•å®é™…åŠŸèƒ½', 'success')

      } catch (error) {
        addStep('æµ‹è¯•å¤±è´¥', error.message, 'error')
        updateStatus('æµ‹è¯•å¤±è´¥: ' + error.message, 'error')
        log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error')
      } finally {
        testBtn.disabled = false
        testBtn.textContent = 'é‡æ–°æµ‹è¯•'
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é…ç½®çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info')
      updateConfigStatus()
    })
  </script>
</body>
</html>
```


## test-fix.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯• AI é…ç½®ä¿®å¤</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-ok {
      color: #10b981;
      font-weight: bold;
    }
    .status-error {
      color: #ef4444;
      font-weight: bold;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 10px 0;
      font-size: 12px;
    }
    h2 {
      color: #1f2937;
      margin-bottom: 15px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ AI é…ç½®ä¿®å¤æµ‹è¯•</h1>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„ AI æ¨¡å‹é…ç½®æ£€æµ‹åŠŸèƒ½</p>
  </div>

  <div class="container">
    <h2>1. é‡ç½®é…ç½®çŠ¶æ€</h2>
    <p>æ¸…é™¤å½“å‰çš„ localStorage é…ç½®ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨çš„åœºæ™¯</p>
    <button onclick="clearLocalStorage()" class="danger">æ¸…ç©º localStorage</button>
    <button onclick="checkLocalStorage()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
    <div id="localStorage-status"></div>
  </div>

  <div class="container">
    <h2>2. æµ‹è¯• API è¿æ¥</h2>
    <p>æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸åŠ è½½æä¾›å•†é…ç½®ï¼ˆåŒ…å«åå¤‡æ–¹æ¡ˆï¼‰</p>
    <button onclick="testAPI()" class="success">æµ‹è¯• API é…ç½®åŠ è½½</button>
    <div id="api-status"></div>
  </div>

  <div class="container">
    <h2>3. æ¨¡æ‹Ÿé…ç½®æµç¨‹</h2>
    <p>æ¨¡æ‹Ÿ providerStore çš„å®Œæ•´åˆå§‹åŒ–å’Œé…ç½®é€‰æ‹©æµç¨‹</p>
    <button onclick="simulateConfigFlow()" class="success">è¿è¡Œé…ç½®æµç¨‹</button>
    <div id="flow-status"></div>
  </div>

  <div class="container">
    <h2>4. éªŒè¯ä¿®å¤æ•ˆæœ</h2>
    <p>æµ‹è¯• Chat æ¨¡å—æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹åˆ°å·²é…ç½®çš„ AI æ¨¡å‹</p>
    <button onclick="testChatDetection()">æµ‹è¯• Chat æ£€æµ‹</button>
    <button onclick="openMainApp()" class="success">æ‰“å¼€ä¸»åº”ç”¨æµ‹è¯•</button>
    <div id="chat-status"></div>
  </div>

  <div class="container">
    <h2>5. å®Œæ•´æµ‹è¯•æ—¥å¿—</h2>
    <pre id="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</pre>
  </div>

  <script>
    const KEYS = {
      provider: 'yprompt_selected_provider',
      model: 'yprompt_selected_model',
      stream: 'yprompt_stream_mode',
      apiKeys: 'yprompt_show_api_keys'
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('log')
      const timestamp = new Date().toLocaleTimeString()
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        debug: 'ğŸ”'
      }
      logEl.textContent += `[${timestamp}] ${emoji[type] || 'â„¹ï¸'} ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function clearLocalStorage() {
      Object.values(KEYS).forEach(key => {
        localStorage.removeItem(key)
      })
      document.getElementById('localStorage-status').innerHTML = '<p class="status-ok">âœ… localStorage å·²æ¸…ç©º</p>'
      log('localStorage å·²æ¸…ç©ºï¼Œæ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨åœºæ™¯', 'success')
    }

    function checkLocalStorage() {
      const data = {}
      Object.entries(KEYS).forEach(([key, storageKey]) => {
        data[key] = localStorage.getItem(storageKey) || '(ç©º)'
      })

      const statusEl = document.getElementById('localStorage-status')
      const hasConfig = data.provider !== '(ç©º)' && data.model !== '(ç©º)'

      statusEl.innerHTML = `
        <h3>å½“å‰ localStorage çŠ¶æ€:</h3>
        <pre>${JSON.stringify(data, null, 2)}</pre>
        <p class="${hasConfig ? 'status-ok' : 'status-error'}">
          ${hasConfig ? 'âœ… å·²æœ‰é…ç½®' : 'âŒ æ— é…ç½®'}
        </p>
      `

      log(`localStorage æ£€æŸ¥: ${data.provider} / ${data.model}`, hasConfig ? 'success' : 'warning')
    }

    async function testAPI() {
      const statusEl = document.getElementById('api-status')
      log('å¼€å§‹æµ‹è¯• API é…ç½®åŠ è½½...', 'info')

      try {
        // æ¨¡æ‹Ÿ settingsApi.getSettings()
        const API_BASE_URL = 'http://localhost:5173' // é€šè¿‡ä»£ç†
        const token = localStorage.getItem('yprompt_token')

        console.log('API URL:', `${API_BASE_URL}/api/settings/`)
        console.log('Token:', token || 'null')

        const response = await fetch(`${API_BASE_URL}/api/settings/`, {
          method: 'GET',
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
          }
        })

        console.log('Response status:', response.status)
        console.log('Response ok:', response.ok)

        let settings = null

        if (response.ok) {
          const result = await response.json()
          console.log('API result:', result)

          if (result.code === 200 && result.data && result.data.providers) {
            settings = result.data
            log(`âœ… API æˆåŠŸï¼Œè·å–åˆ° ${settings.providers.length} ä¸ªæä¾›å•†`, 'success')
          } else {
            log('API å“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ', 'warning')
          }
        } else {
          log(`API è¯·æ±‚å¤±è´¥ (${response.status})ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ`, 'warning')
        }

        // å¦‚æœ API å¤±è´¥ï¼Œä½¿ç”¨åå¤‡é…ç½®
        if (!settings) {
          settings = {
            providers: [
              {
                id: "DeepSeek",
                name: "DeepSeek-Offical",
                type: "openai",
                apiKey: "sk-c092ab16b28f4860910202f8fb9cd480",
                baseUrl: "https://api.deepseek.com/v1",
                models: [
                  { id: "deepseek-chat", name: "deepseek-chat", apiType: "openai" },
                  { id: "deepseek-reasoner", name: "deepseek-reasoner", apiType: "openai" }
                ]
              },
              {
                id: "MoonShot",
                name: "MoonShot-Offical",
                type: "openai",
                apiKey: "sk-vcaBs3TQXlpczsaJxKR8JftXIWEr8OfFWSiSfc8qNCnI2dCv",
                baseUrl: "https://api.moonshot.cn/v1",
                models: [
                  { id: "kimi-k2-0905-preview", name: "kimi-k2-0905-preview", apiType: "openai" },
                  { id: "kimi-k2-thinking", name: "kimi-k2-thinking", apiType: "openai" }
                ]
              }
            ]
          }
          log(`âœ… ä½¿ç”¨åå¤‡é…ç½®ï¼ŒåŒ…å« ${settings.providers.length} ä¸ªæä¾›å•†`, 'success')
        }

        statusEl.innerHTML = `
          <div class="test-result">
            <h4>é…ç½®åŠ è½½ç»“æœ:</h4>
            <p>æä¾›å•†æ•°é‡: ${settings.providers.length}</p>
            <p>å¯ç”¨æä¾›å•†: ${settings.providers.filter(p => p.apiKey).length}</p>
            <details>
              <summary>è¯¦ç»†é…ç½®</summary>
              <pre>${JSON.stringify(settings, null, 2)}</pre>
            </details>
          </div>
        `

        return settings

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ API æµ‹è¯•å¤±è´¥: ${error.message}</p>`
        log(`API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        return null
      }
    }

    async function simulateConfigFlow() {
      const statusEl = document.getElementById('flow-status')
      log('å¼€å§‹æ¨¡æ‹Ÿ providerStore é…ç½®æµç¨‹...', 'info')

      try {
        // 1. è·å–é…ç½®
        const settings = await testAPI()
        if (!settings) {
          throw new Error('æ— æ³•è·å–é…ç½®')
        }

        // 2. æ¨¡æ‹Ÿ providerStore.refreshProviders() é€»è¾‘
        const providers = settings.providers
        const enabledProviders = providers.filter(p => p.apiKey)

        log(`é…ç½®åŠ è½½: ${providers.length} ä¸ªæä¾›å•†ï¼Œ${enabledProviders.length} ä¸ªå·²å¯ç”¨`, 'info')

        // 3. æ£€æŸ¥ localStorage ä¸­çš„é€‰æ‹©
        const savedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const savedModelId = localStorage.getItem('yprompt_selected_model') || ''
        const isFirstTime = !savedProviderId && !savedModelId

        log(`é€‰æ‹©çŠ¶æ€: savedProviderId="${savedProviderId}", savedModelId="${savedModelId}", é¦–æ¬¡ä½¿ç”¨=${isFirstTime}`, 'info')

        // 4. æ¨¡æ‹Ÿè‡ªåŠ¨é€‰æ‹©é€»è¾‘
        let selectedProvider = null
        let selectedModel = null

        if (enabledProviders.length > 0) {
          const firstProvider = enabledProviders[0]

          if (isFirstTime) {
            selectedProvider = firstProvider
            log(`âœ… é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†: ${firstProvider.name}`, 'success')

            if (firstProvider.models.length > 0) {
              selectedModel = firstProvider.models[0]
              log(`âœ… è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹: ${selectedModel.name}`, 'success')
            }
          } else {
            selectedProvider = enabledProviders.find(p => p.id === savedProviderId) || firstProvider
            log(`âœ… æ¢å¤æä¾›å•†é€‰æ‹©: ${selectedProvider.name}`, 'success')

            if (selectedProvider.models.length > 0) {
              selectedModel = selectedProvider.models.find(m => m.id === savedModelId) || selectedProvider.models[0]
              log(`âœ… æ¢å¤/é€‰æ‹©æ¨¡å‹: ${selectedModel.name}`, 'success')
            }
          }

          // 5. ä¿å­˜åˆ° localStorage
          localStorage.setItem('yprompt_selected_provider', selectedProvider.id)
          localStorage.setItem('yprompt_selected_model', selectedModel.id)

          log(`ğŸ’¾ ä¿å­˜é€‰æ‹©åˆ° localStorage: ${selectedProvider.id} / ${selectedModel.id}`, 'success')
        }

        statusEl.innerHTML = `
          <div class="test-result">
            <h4>é…ç½®æµç¨‹ç»“æœ:</h4>
            <p class="status-ok">âœ… é…ç½®æµç¨‹å®Œæˆ</p>
            <p>é€‰æ‹©çš„æä¾›å•†: ${selectedProvider?.name || 'null'}</p>
            <p>é€‰æ‹©çš„æ¨¡å‹: ${selectedModel?.name || 'null'}</p>
            <p>é¦–æ¬¡ä½¿ç”¨: ${isFirstTime ? 'æ˜¯' : 'å¦'}</p>
          </div>
        `

        log(`é…ç½®æµç¨‹å®Œæˆ: ${selectedProvider?.name} / ${selectedModel?.name}`, 'success')

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ é…ç½®æµç¨‹å¤±è´¥: ${error.message}</p>`
        log(`é…ç½®æµç¨‹å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function testChatDetection() {
      const statusEl = document.getElementById('chat-status')
      log('æµ‹è¯• Chat æ¨¡å—çš„æ¨¡å‹æ£€æµ‹é€»è¾‘...', 'info')

      try {
        // æ¨¡æ‹Ÿ useChatModel.getCurrentChatModel() çš„é€»è¾‘
        const selectedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const selectedModelId = localStorage.getItem('yprompt_selected_model') || ''

        log(`æ£€æµ‹é€»è¾‘: selectedProviderId="${selectedProviderId}", selectedModelId="${selectedModelId}"`, 'debug')

        if (!selectedProviderId || !selectedModelId) {
          statusEl.innerHTML = `<p class="status-error">âŒ æ¨¡å‹æ£€æµ‹å¤±è´¥: ç¼ºå°‘é€‰æ‹©æ•°æ®</p>`
          log('âŒ æ¨¡å‹æ£€æµ‹å¤±è´¥: localStorage ä¸­ç¼ºå°‘ provider æˆ– model ID', 'error')
          return
        }

        // ç®€åŒ–çš„æ£€æµ‹é€»è¾‘ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šä» providerStore è·å–å®Œæ•´å¯¹è±¡ï¼‰
        const hasProvider = true // å‡è®¾èƒ½æ‰¾åˆ°å¯¹åº”çš„ provider
        const hasModel = true    // å‡è®¾èƒ½æ‰¾åˆ°å¯¹åº”çš„ model

        if (hasProvider && hasModel) {
          statusEl.innerHTML = `
            <div class="test-result">
              <p class="status-ok">âœ… Chat æ¨¡å—èƒ½æ£€æµ‹åˆ°å·²é…ç½®çš„æ¨¡å‹</p>
              <p>Provider ID: ${selectedProviderId}</p>
              <p>Model ID: ${selectedModelId}</p>
              <p>âœ… ä¸åº”å†æç¤º"è¯·å…ˆé…ç½®"é”™è¯¯</p>
            </div>
          `
          log('âœ… Chat æ¨¡å—æ£€æµ‹æˆåŠŸ: ä¸åº”å†æ˜¾ç¤ºé…ç½®é”™è¯¯æç¤º', 'success')
        } else {
          statusEl.innerHTML = `<p class="status-error">âŒ Chat æ¨¡å—æ£€æµ‹å¤±è´¥</p>`
          log('âŒ Chat æ¨¡å—æ£€æµ‹å¤±è´¥: æ‰¾ä¸åˆ°å¯¹åº”çš„ provider æˆ– model', 'error')
        }

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ æ£€æµ‹æµ‹è¯•å¤±è´¥: ${error.message}</p>`
        log(`æ£€æµ‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function openMainApp() {
      log('æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œå®é™…æµ‹è¯•...', 'info')
      window.open('/', '_blank')
    }

    // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ AI é…ç½®ä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info')
      checkLocalStorage()
    })
  </script>
</body>
</html>
```


## test_persist.html

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>localStorage æŒä¹…åŒ–æµ‹è¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #4F46E5;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 6px;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #4338CA;
    }
    button.danger {
      background: #EF4444;
    }
    button.danger:hover {
      background: #DC2626;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ localStorage æŒä¹…åŒ–æµ‹è¯•</h1>

    <div class="section">
      <h3>å½“å‰ localStorage å†…å®¹ï¼š</h3>
      <pre id="current-storage"></pre>
    </div>

    <div class="section">
      <h3>æ“ä½œï¼š</h3>
      <button onclick="testSave()">ä¿å­˜æµ‹è¯•æ•°æ®</button>
      <button onclick="testRead()">è¯»å–æ•°æ®</button>
      <button onclick="testClear()" class="danger">æ¸…ç©ºæ•°æ®</button>
      <button onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
      <div id="status"></div>
    </div>

    <div class="section">
      <h3>æ“ä½œæ—¥å¿—ï¼š</h3>
      <pre id="log"></pre>
    </div>
  </div>

  <script>
    const KEYS = {
      provider: 'yprompt_selected_provider',
      model: 'yprompt_selected_model',
      stream: 'yprompt_stream_mode',
      apiKeys: 'yprompt_show_api_keys'
    }

    function log(message) {
      const logEl = document.getElementById('log')
      const timestamp = new Date().toLocaleTimeString()
      logEl.textContent += `[${timestamp}] ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('status')
      statusEl.className = `status ${type}`
      statusEl.textContent = message
    }

    function updateDisplay() {
      const currentStorage = {}
      Object.entries(KEYS).forEach(([key, storageKey]) => {
        const value = localStorage.getItem(storageKey)
        currentStorage[key] = value || '(ç©º)'
      })

      document.getElementById('current-storage').textContent =
        JSON.stringify(currentStorage, null, 2)
    }

    function testSave() {
      try {
        localStorage.setItem(KEYS.provider, 'DeepSeek')
        localStorage.setItem(KEYS.model, 'deepseek-chat')
        localStorage.setItem(KEYS.stream, 'true')
        localStorage.setItem(KEYS.apiKeys, 'false')

        log('âœ… æˆåŠŸä¿å­˜æµ‹è¯•æ•°æ®')
        showStatus('æ•°æ®å·²ä¿å­˜åˆ° localStorage', 'success')
        updateDisplay()
      } catch (error) {
        log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`)
        showStatus(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function testRead() {
      try {
        const data = {
          provider: localStorage.getItem(KEYS.provider),
          model: localStorage.getItem(KEYS.model),
          stream: localStorage.getItem(KEYS.stream),
          apiKeys: localStorage.getItem(KEYS.apiKeys)
        }

        log(`ğŸ“– è¯»å–æ•°æ®: ${JSON.stringify(data, null, 2)}`)
        showStatus('æ•°æ®è¯»å–æˆåŠŸ', 'success')
        updateDisplay()
      } catch (error) {
        log(`âŒ è¯»å–å¤±è´¥: ${error.message}`)
        showStatus(`è¯»å–å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function testClear() {
      try {
        Object.values(KEYS).forEach(key => {
          localStorage.removeItem(key)
        })

        log('ğŸ—‘ï¸  å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®')
        showStatus('æ•°æ®å·²æ¸…ç©º', 'success')
        updateDisplay()
      } catch (error) {
        log(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`)
        showStatus(`æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error')
      }
    }

    function refreshPage() {
      log('ğŸ”„ å³å°†åˆ·æ–°é¡µé¢...')
      setTimeout(() => {
        location.reload()
      }, 500)
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ')
      updateDisplay()
    })
  </script>
</body>
</html>

```


## tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": [
      "ES2020",
      "DOM",
      "DOM.Iterable"
    ],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "src/*"
      ]
    }
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx"
  ],
  "exclude": [
    "node_modules",
    "src/components/modules/optimize/**/*",
    "src/services/promptOptimizationService.ts"
  ]
}
```


## vite.config.ts

```ts
import { defineConfig, Plugin } from 'vite'
import react from '@vitejs/plugin-react'
import { resolve } from 'path'
import fs from 'fs'
import { execSync } from 'child_process'

// åˆ›å»ºæ³¨å…¥ git commit ä¿¡æ¯çš„æ’ä»¶
function gitCommitPlugin(): Plugin {
  const commitHash = getGitCommitHash()
  const commitDate = getGitCommitDate()
  
  return {
    name: 'git-commit-plugin',
    config(config) {
      // é€šè¿‡ define æ³¨å…¥åˆ°ä»£ç ä¸­
      const existingDefine = config.define || {}
      return {
        define: {
          ...existingDefine,
          'import.meta.env.VITE_GIT_COMMIT_HASH': JSON.stringify(commitHash),
          'import.meta.env.VITE_GIT_COMMIT_DATE': JSON.stringify(commitDate)
        }
      }
    }
  }
}

export default defineConfig({
  plugins: [
    react(),
    gitCommitPlugin()
  ],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    },
    extensions: ['.tsx', '.ts', '.jsx', '.js']
  },
  build: {
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html')
      }
    }
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8888',
        changeOrigin: true,
        secure: false
      }
    }
  },
  esbuild: {
    // ä¿æŒä»£ç çš„å¯è¯»æ€§ä»¥ä¾¿è°ƒè¯•
    minify: false
  },
  define: {
  }
})


// è·å– git commit hashï¼ˆç¼©å†™ï¼Œ7ä½ï¼‰
function getGitCommitHash(): string {
  // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆGitHub Actions ç­‰ CI/CD ç¯å¢ƒï¼‰
  if (process.env.GITHUB_SHA) {
    const hash = process.env.GITHUB_SHA.substring(0, 7)
    console.log('âœ… Git commit hash (from GITHUB_SHA):', hash)
    return hash
  }
  
  // å°è¯•ä» git å‘½ä»¤è·å–
  try {
    // å°è¯•å¤šä¸ªå¯èƒ½çš„ git ä»“åº“è·¯å¾„ï¼ˆä»æœ€å¯èƒ½åˆ°æœ€ä¸å¯èƒ½ï¼‰
    const possiblePaths = [
      resolve(__dirname, '..'),  // é¡¹ç›®æ ¹ç›®å½•ï¼ˆæœ€å¯èƒ½ï¼‰
      process.cwd(),              // å½“å‰å·¥ä½œç›®å½•
      __dirname                   // frontend ç›®å½•
    ]
    
    for (const gitPath of possiblePaths) {
      try {
        // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ git ä»“åº“ï¼ˆé™é»˜æ£€æŸ¥ï¼‰
        execSync('git rev-parse --git-dir', {
          encoding: 'utf-8',
          cwd: gitPath,
          stdio: ['ignore', 'pipe', 'ignore']
        })
        
        // æ˜¯ git ä»“åº“ï¼Œè·å– commit hash
        const hash = execSync('git rev-parse --short HEAD', { 
          encoding: 'utf-8',
          cwd: gitPath,
          stdio: ['ignore', 'pipe', 'ignore']
        }).trim()
        
        if (hash) {
          console.log(`âœ… Git commit hash (from ${gitPath}):`, hash)
          return hash
        }
      } catch (pathError) {
        // è¿™ä¸ªè·¯å¾„ä¸æ˜¯ git ä»“åº“æˆ–å‘½ä»¤å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
        continue
      }
    }
    
    console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ git ä»“åº“')
    return ''
  } catch (error) {
    console.warn('âš ï¸ è·å– git commit hash å¤±è´¥:', error instanceof Error ? error.message : String(error))
    return ''
  }
}

// è·å– git commit æ—¥æœŸ
function getGitCommitDate(): string {
  // GitHub Actions ä¸ç›´æ¥æä¾›æ—¥æœŸï¼Œéœ€è¦ä» git è·å–
  // å°è¯•ä» git å‘½ä»¤è·å–
  try {
    // å°è¯•å¤šä¸ªå¯èƒ½çš„ git ä»“åº“è·¯å¾„ï¼ˆä»æœ€å¯èƒ½åˆ°æœ€ä¸å¯èƒ½ï¼‰
    const possiblePaths = [
      resolve(__dirname, '..'),  // é¡¹ç›®æ ¹ç›®å½•ï¼ˆæœ€å¯èƒ½ï¼‰
      process.cwd(),              // å½“å‰å·¥ä½œç›®å½•
      __dirname                   // frontend ç›®å½•
    ]
    
    for (const gitPath of possiblePaths) {
      try {
        // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ git ä»“åº“ï¼ˆé™é»˜æ£€æŸ¥ï¼‰
        execSync('git rev-parse --git-dir', {
          encoding: 'utf-8',
          cwd: gitPath,
          stdio: ['ignore', 'pipe', 'ignore']
        })
        
        // æ˜¯ git ä»“åº“ï¼Œè·å– commit æ—¥æœŸ
        // å¦‚æœ GITHUB_SHA å­˜åœ¨ï¼Œä½¿ç”¨å®ƒæ¥è·å–æ—¥æœŸ
        let date = ''
        if (process.env.GITHUB_SHA) {
          // ä½¿ç”¨æŒ‡å®šçš„ commit è·å–æ—¥æœŸ
          date = execSync(`git log -1 --format=%ci ${process.env.GITHUB_SHA}`, { 
            encoding: 'utf-8',
            cwd: gitPath,
            stdio: ['ignore', 'pipe', 'ignore']
          }).trim()
        } else {
          // è·å–å½“å‰ HEAD çš„æ—¥æœŸ
          date = execSync('git log -1 --format=%ci', { 
            encoding: 'utf-8',
            cwd: gitPath,
            stdio: ['ignore', 'pipe', 'ignore']
          }).trim()
        }
        
        if (date) {
          console.log(`âœ… Git commit date (from ${gitPath}):`, date)
          return date
        }
      } catch (pathError) {
        // è¿™ä¸ªè·¯å¾„ä¸æ˜¯ git ä»“åº“æˆ–å‘½ä»¤å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
        continue
      }
    }
    
    console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ git ä»“åº“æˆ–æ— æ³•è·å– commit æ—¥æœŸ')
    return ''
  } catch (error) {
    console.warn('âš ï¸ è·å– git commit date å¤±è´¥:', error instanceof Error ? error.message : String(error))
    return ''
  }
}

```

