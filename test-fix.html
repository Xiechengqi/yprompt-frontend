<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯• AI é…ç½®ä¿®å¤</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-ok {
      color: #10b981;
      font-weight: bold;
    }
    .status-error {
      color: #ef4444;
      font-weight: bold;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 10px 0;
      font-size: 12px;
    }
    h2 {
      color: #1f2937;
      margin-bottom: 15px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ AI é…ç½®ä¿®å¤æµ‹è¯•</h1>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„ AI æ¨¡å‹é…ç½®æ£€æµ‹åŠŸèƒ½</p>
  </div>

  <div class="container">
    <h2>1. é‡ç½®é…ç½®çŠ¶æ€</h2>
    <p>æ¸…é™¤å½“å‰çš„ localStorage é…ç½®ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨çš„åœºæ™¯</p>
    <button onclick="clearLocalStorage()" class="danger">æ¸…ç©º localStorage</button>
    <button onclick="checkLocalStorage()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
    <div id="localStorage-status"></div>
  </div>

  <div class="container">
    <h2>2. æµ‹è¯• API è¿æ¥</h2>
    <p>æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸åŠ è½½æä¾›å•†é…ç½®ï¼ˆåŒ…å«åå¤‡æ–¹æ¡ˆï¼‰</p>
    <button onclick="testAPI()" class="success">æµ‹è¯• API é…ç½®åŠ è½½</button>
    <div id="api-status"></div>
  </div>

  <div class="container">
    <h2>3. æ¨¡æ‹Ÿé…ç½®æµç¨‹</h2>
    <p>æ¨¡æ‹Ÿ providerStore çš„å®Œæ•´åˆå§‹åŒ–å’Œé…ç½®é€‰æ‹©æµç¨‹</p>
    <button onclick="simulateConfigFlow()" class="success">è¿è¡Œé…ç½®æµç¨‹</button>
    <div id="flow-status"></div>
  </div>

  <div class="container">
    <h2>4. éªŒè¯ä¿®å¤æ•ˆæœ</h2>
    <p>æµ‹è¯• Chat æ¨¡å—æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹åˆ°å·²é…ç½®çš„ AI æ¨¡å‹</p>
    <button onclick="testChatDetection()">æµ‹è¯• Chat æ£€æµ‹</button>
    <button onclick="openMainApp()" class="success">æ‰“å¼€ä¸»åº”ç”¨æµ‹è¯•</button>
    <div id="chat-status"></div>
  </div>

  <div class="container">
    <h2>5. å®Œæ•´æµ‹è¯•æ—¥å¿—</h2>
    <pre id="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</pre>
  </div>

  <script>
    const KEYS = {
      provider: 'yprompt_selected_provider',
      model: 'yprompt_selected_model',
      stream: 'yprompt_stream_mode',
      apiKeys: 'yprompt_show_api_keys'
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('log')
      const timestamp = new Date().toLocaleTimeString()
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        debug: 'ğŸ”'
      }
      logEl.textContent += `[${timestamp}] ${emoji[type] || 'â„¹ï¸'} ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function clearLocalStorage() {
      Object.values(KEYS).forEach(key => {
        localStorage.removeItem(key)
      })
      document.getElementById('localStorage-status').innerHTML = '<p class="status-ok">âœ… localStorage å·²æ¸…ç©º</p>'
      log('localStorage å·²æ¸…ç©ºï¼Œæ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨åœºæ™¯', 'success')
    }

    function checkLocalStorage() {
      const data = {}
      Object.entries(KEYS).forEach(([key, storageKey]) => {
        data[key] = localStorage.getItem(storageKey) || '(ç©º)'
      })

      const statusEl = document.getElementById('localStorage-status')
      const hasConfig = data.provider !== '(ç©º)' && data.model !== '(ç©º)'

      statusEl.innerHTML = `
        <h3>å½“å‰ localStorage çŠ¶æ€:</h3>
        <pre>${JSON.stringify(data, null, 2)}</pre>
        <p class="${hasConfig ? 'status-ok' : 'status-error'}">
          ${hasConfig ? 'âœ… å·²æœ‰é…ç½®' : 'âŒ æ— é…ç½®'}
        </p>
      `

      log(`localStorage æ£€æŸ¥: ${data.provider} / ${data.model}`, hasConfig ? 'success' : 'warning')
    }

    async function testAPI() {
      const statusEl = document.getElementById('api-status')
      log('å¼€å§‹æµ‹è¯• API é…ç½®åŠ è½½...', 'info')

      try {
        // æ¨¡æ‹Ÿ settingsApi.getSettings()
        const API_BASE_URL = 'http://localhost:5173' // é€šè¿‡ä»£ç†
        const token = localStorage.getItem('yprompt_token')

        console.log('API URL:', `${API_BASE_URL}/api/settings/`)
        console.log('Token:', token || 'null')

        const response = await fetch(`${API_BASE_URL}/api/settings/`, {
          method: 'GET',
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
          }
        })

        console.log('Response status:', response.status)
        console.log('Response ok:', response.ok)

        let settings = null

        if (response.ok) {
          const result = await response.json()
          console.log('API result:', result)

          if (result.code === 200 && result.data && result.data.providers) {
            settings = result.data
            log(`âœ… API æˆåŠŸï¼Œè·å–åˆ° ${settings.providers.length} ä¸ªæä¾›å•†`, 'success')
          } else {
            log('API å“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ', 'warning')
          }
        } else {
          log(`API è¯·æ±‚å¤±è´¥ (${response.status})ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ`, 'warning')
        }

        // å¦‚æœ API å¤±è´¥ï¼Œä½¿ç”¨åå¤‡é…ç½®
        if (!settings) {
          settings = {
            providers: [
              {
                id: "DeepSeek",
                name: "DeepSeek-Offical",
                type: "openai",
                apiKey: "sk-c092ab16b28f4860910202f8fb9cd480",
                baseUrl: "https://api.deepseek.com/v1",
                models: [
                  { id: "deepseek-chat", name: "deepseek-chat", apiType: "openai" },
                  { id: "deepseek-reasoner", name: "deepseek-reasoner", apiType: "openai" }
                ]
              },
              {
                id: "MoonShot",
                name: "MoonShot-Offical",
                type: "openai",
                apiKey: "sk-vcaBs3TQXlpczsaJxKR8JftXIWEr8OfFWSiSfc8qNCnI2dCv",
                baseUrl: "https://api.moonshot.cn/v1",
                models: [
                  { id: "kimi-k2-0905-preview", name: "kimi-k2-0905-preview", apiType: "openai" },
                  { id: "kimi-k2-thinking", name: "kimi-k2-thinking", apiType: "openai" }
                ]
              }
            ]
          }
          log(`âœ… ä½¿ç”¨åå¤‡é…ç½®ï¼ŒåŒ…å« ${settings.providers.length} ä¸ªæä¾›å•†`, 'success')
        }

        statusEl.innerHTML = `
          <div class="test-result">
            <h4>é…ç½®åŠ è½½ç»“æœ:</h4>
            <p>æä¾›å•†æ•°é‡: ${settings.providers.length}</p>
            <p>å¯ç”¨æä¾›å•†: ${settings.providers.filter(p => p.apiKey).length}</p>
            <details>
              <summary>è¯¦ç»†é…ç½®</summary>
              <pre>${JSON.stringify(settings, null, 2)}</pre>
            </details>
          </div>
        `

        return settings

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ API æµ‹è¯•å¤±è´¥: ${error.message}</p>`
        log(`API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        return null
      }
    }

    async function simulateConfigFlow() {
      const statusEl = document.getElementById('flow-status')
      log('å¼€å§‹æ¨¡æ‹Ÿ providerStore é…ç½®æµç¨‹...', 'info')

      try {
        // 1. è·å–é…ç½®
        const settings = await testAPI()
        if (!settings) {
          throw new Error('æ— æ³•è·å–é…ç½®')
        }

        // 2. æ¨¡æ‹Ÿ providerStore.refreshProviders() é€»è¾‘
        const providers = settings.providers
        const enabledProviders = providers.filter(p => p.apiKey)

        log(`é…ç½®åŠ è½½: ${providers.length} ä¸ªæä¾›å•†ï¼Œ${enabledProviders.length} ä¸ªå·²å¯ç”¨`, 'info')

        // 3. æ£€æŸ¥ localStorage ä¸­çš„é€‰æ‹©
        const savedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const savedModelId = localStorage.getItem('yprompt_selected_model') || ''
        const isFirstTime = !savedProviderId && !savedModelId

        log(`é€‰æ‹©çŠ¶æ€: savedProviderId="${savedProviderId}", savedModelId="${savedModelId}", é¦–æ¬¡ä½¿ç”¨=${isFirstTime}`, 'info')

        // 4. æ¨¡æ‹Ÿè‡ªåŠ¨é€‰æ‹©é€»è¾‘
        let selectedProvider = null
        let selectedModel = null

        if (enabledProviders.length > 0) {
          const firstProvider = enabledProviders[0]

          if (isFirstTime) {
            selectedProvider = firstProvider
            log(`âœ… é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†: ${firstProvider.name}`, 'success')

            if (firstProvider.models.length > 0) {
              selectedModel = firstProvider.models[0]
              log(`âœ… è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹: ${selectedModel.name}`, 'success')
            }
          } else {
            selectedProvider = enabledProviders.find(p => p.id === savedProviderId) || firstProvider
            log(`âœ… æ¢å¤æä¾›å•†é€‰æ‹©: ${selectedProvider.name}`, 'success')

            if (selectedProvider.models.length > 0) {
              selectedModel = selectedProvider.models.find(m => m.id === savedModelId) || selectedProvider.models[0]
              log(`âœ… æ¢å¤/é€‰æ‹©æ¨¡å‹: ${selectedModel.name}`, 'success')
            }
          }

          // 5. ä¿å­˜åˆ° localStorage
          localStorage.setItem('yprompt_selected_provider', selectedProvider.id)
          localStorage.setItem('yprompt_selected_model', selectedModel.id)

          log(`ğŸ’¾ ä¿å­˜é€‰æ‹©åˆ° localStorage: ${selectedProvider.id} / ${selectedModel.id}`, 'success')
        }

        statusEl.innerHTML = `
          <div class="test-result">
            <h4>é…ç½®æµç¨‹ç»“æœ:</h4>
            <p class="status-ok">âœ… é…ç½®æµç¨‹å®Œæˆ</p>
            <p>é€‰æ‹©çš„æä¾›å•†: ${selectedProvider?.name || 'null'}</p>
            <p>é€‰æ‹©çš„æ¨¡å‹: ${selectedModel?.name || 'null'}</p>
            <p>é¦–æ¬¡ä½¿ç”¨: ${isFirstTime ? 'æ˜¯' : 'å¦'}</p>
          </div>
        `

        log(`é…ç½®æµç¨‹å®Œæˆ: ${selectedProvider?.name} / ${selectedModel?.name}`, 'success')

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ é…ç½®æµç¨‹å¤±è´¥: ${error.message}</p>`
        log(`é…ç½®æµç¨‹å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function testChatDetection() {
      const statusEl = document.getElementById('chat-status')
      log('æµ‹è¯• Chat æ¨¡å—çš„æ¨¡å‹æ£€æµ‹é€»è¾‘...', 'info')

      try {
        // æ¨¡æ‹Ÿ useChatModel.getCurrentChatModel() çš„é€»è¾‘
        const selectedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const selectedModelId = localStorage.getItem('yprompt_selected_model') || ''

        log(`æ£€æµ‹é€»è¾‘: selectedProviderId="${selectedProviderId}", selectedModelId="${selectedModelId}"`, 'debug')

        if (!selectedProviderId || !selectedModelId) {
          statusEl.innerHTML = `<p class="status-error">âŒ æ¨¡å‹æ£€æµ‹å¤±è´¥: ç¼ºå°‘é€‰æ‹©æ•°æ®</p>`
          log('âŒ æ¨¡å‹æ£€æµ‹å¤±è´¥: localStorage ä¸­ç¼ºå°‘ provider æˆ– model ID', 'error')
          return
        }

        // ç®€åŒ–çš„æ£€æµ‹é€»è¾‘ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šä» providerStore è·å–å®Œæ•´å¯¹è±¡ï¼‰
        const hasProvider = true // å‡è®¾èƒ½æ‰¾åˆ°å¯¹åº”çš„ provider
        const hasModel = true    // å‡è®¾èƒ½æ‰¾åˆ°å¯¹åº”çš„ model

        if (hasProvider && hasModel) {
          statusEl.innerHTML = `
            <div class="test-result">
              <p class="status-ok">âœ… Chat æ¨¡å—èƒ½æ£€æµ‹åˆ°å·²é…ç½®çš„æ¨¡å‹</p>
              <p>Provider ID: ${selectedProviderId}</p>
              <p>Model ID: ${selectedModelId}</p>
              <p>âœ… ä¸åº”å†æç¤º"è¯·å…ˆé…ç½®"é”™è¯¯</p>
            </div>
          `
          log('âœ… Chat æ¨¡å—æ£€æµ‹æˆåŠŸ: ä¸åº”å†æ˜¾ç¤ºé…ç½®é”™è¯¯æç¤º', 'success')
        } else {
          statusEl.innerHTML = `<p class="status-error">âŒ Chat æ¨¡å—æ£€æµ‹å¤±è´¥</p>`
          log('âŒ Chat æ¨¡å—æ£€æµ‹å¤±è´¥: æ‰¾ä¸åˆ°å¯¹åº”çš„ provider æˆ– model', 'error')
        }

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ æ£€æµ‹æµ‹è¯•å¤±è´¥: ${error.message}</p>`
        log(`æ£€æµ‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
      }
    }

    function openMainApp() {
      log('æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œå®é™…æµ‹è¯•...', 'info')
      window.open('/', '_blank')
    }

    // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹çŠ¶æ€
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ AI é…ç½®ä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info')
      checkLocalStorage()
    })
  </script>
</body>
</html>