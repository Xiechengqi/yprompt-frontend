<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI é…ç½®è°ƒè¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-ok {
      color: #10b981;
      font-weight: bold;
    }
    .status-error {
      color: #ef4444;
      font-weight: bold;
    }
    .status-warning {
      color: #f59e0b;
      font-weight: bold;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 10px 0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border-radius: 6px;
    }
    h2 {
      color: #1f2937;
      margin-bottom: 10px;
    }
    .test-button {
      background: #10b981;
    }
    .test-button:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” AI é…ç½®çŠ¶æ€è°ƒè¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºè°ƒè¯• AI æ¨¡å‹é…ç½®æ£€æµ‹é—®é¢˜</p>
  </div>

  <div class="container">
    <h2>1. localStorage çŠ¶æ€</h2>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
    <button onclick="clearLocalStorage()" style="background: #ef4444;">æ¸…ç©º localStorage</button>
    <div id="localStorage-status"></div>
  </div>

  <div class="container">
    <h2>2. åç«¯ API çŠ¶æ€</h2>
    <button onclick="testBackendAPI()" class="test-button">æµ‹è¯•åç«¯ API</button>
    <div id="backend-status"></div>
  </div>

  <div class="container">
    <h2>3. æ¨¡æ‹Ÿ providerStore çŠ¶æ€</h2>
    <button onclick="simulateProviderStore()" class="test-button">æ¨¡æ‹ŸåŠ è½½ providerStore</button>
    <div id="provider-status"></div>
  </div>

  <div class="container">
    <h2>4. å®Œæ•´æµ‹è¯•æµç¨‹</h2>
    <button onclick="runFullTest()" style="background: #8b5cf6;">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <div id="test-output"></div>
  </div>

  <div class="container">
    <h2>5. æ“ä½œæ—¥å¿—</h2>
    <pre id="log">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <script>
    const KEYS = {
      provider: 'yprompt_selected_provider',
      model: 'yprompt_selected_model',
      stream: 'yprompt_stream_mode',
      apiKeys: 'yprompt_show_api_keys'
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('log')
      const timestamp = new Date().toLocaleTimeString()
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      }
      logEl.textContent += `[${timestamp}] ${emoji[type] || 'â„¹ï¸'} ${message}\n`
      logEl.scrollTop = logEl.scrollHeight
    }

    function checkLocalStorage() {
      const statusEl = document.getElementById('localStorage-status')
      let html = '<h3>localStorage å†…å®¹:</h3><pre>'

      const data = {}
      Object.entries(KEYS).forEach(([key, storageKey]) => {
        const value = localStorage.getItem(storageKey)
        data[key] = value || '(ç©º)'
      })

      html += JSON.stringify(data, null, 2)
      html += '</pre>'

      // çŠ¶æ€æ£€æŸ¥
      if (data.provider === '(ç©º)' || data.model === '(ç©º)') {
        html += '<p class="status-error">âŒ ç¼ºå°‘ provider æˆ– model é…ç½®</p>'
        log('localStorage ä¸­ç¼ºå°‘é…ç½®æ•°æ®', 'error')
      } else {
        html += '<p class="status-ok">âœ… localStorage ä¸­æœ‰é…ç½®æ•°æ®</p>'
        log(`localStorage é…ç½®: ${data.provider} / ${data.model}`, 'success')
      }

      statusEl.innerHTML = html
    }

    function clearLocalStorage() {
      Object.values(KEYS).forEach(key => {
        localStorage.removeItem(key)
      })
      document.getElementById('localStorage-status').innerHTML = '<p class="status-warning">âš ï¸ localStorage å·²æ¸…ç©º</p>'
      log('localStorage å·²æ¸…ç©º', 'warning')
    }

    async function testBackendAPI() {
      const statusEl = document.getElementById('backend-status')
      log('æµ‹è¯•åç«¯ API è¿æ¥...', 'info')

      try {
        // å…ˆå°è¯•è®¿é—®ç™»å½•é¡µé¢è·å–è®¤è¯çŠ¶æ€
        const loginResponse = await fetch('http://localhost:8888/api/auth/config')

        if (loginResponse.ok) {
          const loginData = await loginResponse.json()
          log(`åç«¯è®¤è¯é…ç½®: ${JSON.stringify(loginData)}`, 'success')

          // å°è¯•è·å–è®¾ç½®ï¼ˆå¯èƒ½éœ€è¦è®¤è¯ï¼‰
          try {
            const settingsResponse = await fetch('http://localhost:8888/api/settings/', {
              headers: {
                'Content-Type': 'application/json'
              }
            })

            if (settingsResponse.ok) {
              const settingsData = await settingsResponse.json()
              statusEl.innerHTML = `<p class="status-ok">âœ… åç«¯ API æ­£å¸¸ï¼Œè·å–åˆ° ${settingsData.providers?.length || 0} ä¸ªæä¾›å•†</p>`
              log(`æˆåŠŸè·å–è®¾ç½®æ•°æ®: ${JSON.stringify(settingsData).substring(0, 200)}...`, 'success')
            } else {
              statusEl.innerHTML = `<p class="status-warning">âš ï¸ åç«¯ API éœ€è¦è®¤è¯ (${settingsResponse.status})</p>`
              log(`éœ€è¦è®¤è¯: ${settingsResponse.status}`, 'warning')
            }
          } catch (settingsError) {
            statusEl.innerHTML = `<p class="status-error">âŒ è®¾ç½® API å¤±è´¥: ${settingsError.message}</p>`
            log(`è®¾ç½® API é”™è¯¯: ${settingsError.message}`, 'error')
          }
        } else {
          statusEl.innerHTML = `<p class="status-error">âŒ åç«¯è®¤è¯ API å¤±è´¥ (${loginResponse.status})</p>`
          log(`è®¤è¯ API å¤±è´¥: ${loginResponse.status}`, 'error')
        }
      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}</p>`
        log(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error')
      }
    }

    async function simulateProviderStore() {
      const statusEl = document.getElementById('provider-status')
      log('æ¨¡æ‹Ÿ providerStore åˆå§‹åŒ–è¿‡ç¨‹...', 'info')

      try {
        // 1. ä» localStorage è¯»å–é€‰æ‹©
        const savedProviderId = localStorage.getItem('yprompt_selected_provider') || ''
        const savedModelId = localStorage.getItem('yprompt_selected_model') || ''
        log(`ä» localStorage æ¢å¤: ${savedProviderId} / ${savedModelId}`, 'info')

        // 2. æ¨¡æ‹Ÿä»åç«¯åŠ è½½é…ç½®
        const settingsResponse = await fetch('http://localhost:8888/api/settings/')
        let providers = []

        if (settingsResponse.ok) {
          const settings = await settingsResponse.json()
          providers = settings.providers || []
          log(`ä»åç«¯åŠ è½½äº† ${providers.length} ä¸ªæä¾›å•†`, 'success')
        } else {
          // æ¨¡æ‹Ÿ .setting.json å†…å®¹
          providers = [
            {
              id: "DeepSeek",
              name: "DeepSeek-Offical",
              type: "openai",
              apiKey: "sk-c092ab16b28f4860910202f8fb9cd480",
              baseUrl: "https://api.deepseek.com/v1",
              models: [
                { id: "deepseek-chat", name: "deepseek-chat", apiType: "openai" },
                { id: "deepseek-reasoner", name: "deepseek-reasoner", apiType: "openai" }
              ]
            }
          ]
          log('ä½¿ç”¨æ¨¡æ‹Ÿé…ç½®æ•°æ®', 'warning')
        }

        // 3. æ¨¡æ‹Ÿ providerStore çš„é€»è¾‘
        const enabledProviders = providers.filter(p => p.apiKey)
        log(`å¯ç”¨çš„æä¾›å•†: ${enabledProviders.length}`, 'info')

        let currentProvider = null
        let currentModel = null

        if (enabledProviders.length > 0) {
          const firstProvider = enabledProviders[0]

          if (!savedProviderId) {
            // é¦–æ¬¡ä½¿ç”¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
            currentProvider = firstProvider
            localStorage.setItem('yprompt_selected_provider', firstProvider.id)
            log(`é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæä¾›å•†: ${firstProvider.name}`, 'success')
          } else {
            // æŸ¥æ‰¾ä¿å­˜çš„æä¾›å•†
            currentProvider = enabledProviders.find(p => p.id === savedProviderId) || firstProvider
            log(`æ¢å¤æä¾›å•†é€‰æ‹©: ${currentProvider.name}`, 'info')
          }

          // å¤„ç†æ¨¡å‹é€‰æ‹©
          if (currentProvider.models.length > 0) {
            if (!savedModelId || !currentProvider.models.find(m => m.id === savedModelId)) {
              currentModel = currentProvider.models[0]
              localStorage.setItem('yprompt_selected_model', currentModel.id)
              log(`è‡ªåŠ¨é€‰æ‹©æ¨¡å‹: ${currentModel.name}`, 'success')
            } else {
              currentModel = currentProvider.models.find(m => m.id === savedModelId)
              log(`æ¢å¤æ¨¡å‹é€‰æ‹©: ${currentModel.name}`, 'info')
            }
          }
        }

        // 4. æ˜¾ç¤ºç»“æœ
        const resultHtml = currentProvider && currentModel
          ? `<p class="status-ok">âœ… æ¨¡æ‹ŸæˆåŠŸ: ${currentProvider.name} / ${currentModel.name}</p>`
          : `<p class="status-error">âŒ æ¨¡æ‹Ÿå¤±è´¥: æ²¡æœ‰å¯ç”¨çš„æä¾›å•†æˆ–æ¨¡å‹</p>`

        statusEl.innerHTML = resultHtml + '<pre>' + JSON.stringify({
          providersCount: providers.length,
          enabledProviders: enabledProviders.length,
          currentProvider: currentProvider?.name || null,
          currentModel: currentModel?.name || null
        }, null, 2) + '</pre>'

        log(`æ¨¡æ‹Ÿå®Œæˆ: ${currentProvider?.name || 'null'} / ${currentModel?.name || 'null'}`, currentProvider ? 'success' : 'error')

      } catch (error) {
        statusEl.innerHTML = `<p class="status-error">âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</p>`
        log(`æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error')
      }
    }

    async function runFullTest() {
      const outputEl = document.getElementById('test-output')
      outputEl.innerHTML = '<p>ğŸ”„ è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...</p>'

      log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹', 'info')

      // 1. æ¸…ç©ºå¹¶é‡æ–°è®¾ç½®
      clearLocalStorage()
      await new Promise(resolve => setTimeout(resolve, 100))

      // 2. æ¨¡æ‹Ÿé¦–æ¬¡ä½¿ç”¨
      await simulateProviderStore()
      await new Promise(resolve => setTimeout(resolve, 100))

      // 3. æ£€æŸ¥çŠ¶æ€
      checkLocalStorage()

      // 4. æ€»ç»“
      const savedProvider = localStorage.getItem('yprompt_selected_provider')
      const savedModel = localStorage.getItem('yprompt_selected_model')

      if (savedProvider && savedModel) {
        outputEl.innerHTML = `
          <p class="status-ok">âœ… å®Œæ•´æµ‹è¯•é€šè¿‡</p>
          <p>é…ç½®ç»“æœ: ${savedProvider} / ${savedModel}</p>
          <button onclick="window.open('/', '_blank')" style="background: #10b981;">æµ‹è¯•ä¸»åº”ç”¨</button>
        `
        log('å®Œæ•´æµ‹è¯•é€šè¿‡ï¼é…ç½®å·²æ­£ç¡®è®¾ç½®', 'success')
      } else {
        outputEl.innerHTML = `<p class="status-error">âŒ å®Œæ•´æµ‹è¯•å¤±è´¥ï¼Œé…ç½®æœªæ­£ç¡®è®¾ç½®</p>`
        log('å®Œæ•´æµ‹è¯•å¤±è´¥', 'error')
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ', 'info')
      checkLocalStorage()
    })
  </script>
</body>
</html>