var P=Object.defineProperty;var E=(m,e,t)=>e in m?P(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var y=(m,e,t)=>E(m,typeof e!="symbol"?e+"":e,t);import{a as S}from"./ModelDialog.vue_vue_type_script_setup_true_lang-BIaTfaUb.js";import"./index-BSeMGRGF.js";const d=class d{constructor(){y(this,"testCache",new Map);y(this,"aiService",S.getInstance())}static getInstance(){return d.instance||(d.instance=new d),d.instance}async detectCapabilities(e,t,a=!1){var n;const s=`${e.id}:${t}`;if(!a&&this.testCache.has(s)){const r=this.testCache.get(s);if(Date.now()-(((n=r.testResult)==null?void 0:n.timestamp.getTime())||0)<24*60*60*1e3)return r}const i=await this.performCapabilityTest(e,t);return this.testCache.set(s,i),i}async detectCapabilitiesWithCallback(e,t,a,s,i=!1,n){var g,T,w,k;const r=`${e.id}:${t}`;if(!i&&this.testCache.has(r)){const h=this.testCache.get(r);if(Date.now()-(((g=h.testResult)==null?void 0:g.timestamp.getTime())||0)<24*60*60*1e3){a(((T=h.testResult)==null?void 0:T.connected)||!1,((w=h.testResult)==null?void 0:w.responseTime)||0,(k=h.testResult)==null?void 0:k.error),s(h);return}}const c=this.getAPIType(e,t),u=Date.now();try{if(n!=null&&n.signal.aborted)return;const h=await this.testBasicConnection(e,t),p=Date.now()-u;if(n!=null&&n.signal.aborted)return;if(a(h.connected,p,h.error),!h.connected){const o=this.createFailedCapabilities(h,c);s(o),this.testCache.set(r,o);return}const l=setTimeout(async()=>{try{if(n!=null&&n.signal.aborted)return;const o=await this.testThinkingCapability(e,t,c,h.preferStream,n);if(n!=null&&n.signal.aborted)return;const f={reasoning:o.reasoning,reasoningType:o.reasoningType,supportedParams:o.supportedParams,testResult:{connected:!0,reasoning:o.reasoning,responseTime:p,timestamp:new Date}};this.testCache.set(r,f),s(f)}catch(o){if(o instanceof Error&&o.name==="AbortError"||n!=null&&n.signal.aborted)return;const f={reasoning:!1,reasoningType:null,supportedParams:this.getDefaultCapabilities(c).supportedParams,testResult:{connected:!0,reasoning:!1,responseTime:p,timestamp:new Date}};this.testCache.set(r,f),s(f)}},100);n&&n.signal.addEventListener("abort",()=>{clearTimeout(l)})}catch(h){const p={connected:!1,error:h instanceof Error?h.message:String(h)};a(!1,Date.now()-u,p.error);const l=this.createFailedCapabilities(p,c);s(l),this.testCache.set(r,l)}}async performCapabilityTest(e,t){const a=this.getAPIType(e,t),s=Date.now();try{const i=await this.testBasicConnection(e,t);if(!i.connected)return this.createFailedCapabilities(i,a);const n=await this.testThinkingCapability(e,t,a,i.preferStream);return{reasoning:n.reasoning,reasoningType:n.reasoningType,supportedParams:n.supportedParams,testResult:{connected:!0,reasoning:n.reasoning,responseTime:Date.now()-s,timestamp:new Date}}}catch(i){return this.createFailedCapabilities({connected:!1,error:i instanceof Error?i.message:String(i)},a)}}async testBasicConnection(e,t){const a=[{role:"user",content:"Hi"}];try{const s=await this.aiService.callAI(a,e,t,!0);if(!!(s&&typeof s=="string"&&s.trim().length>0))return{connected:!0,preferStream:!0}}catch{}try{const s=await this.aiService.callAI(a,e,t,!1);if(!!(s&&typeof s=="string"&&s.trim().length>0))return{connected:!0,preferStream:!1}}catch(s){return{connected:!1,error:s instanceof Error?s.message:String(s)}}return{connected:!1,error:"流式和非流式测试都失败"}}async testThinkingCapability(e,t,a,s,i){if(i!=null&&i.signal.aborted)throw new Error("AbortError");switch(a){case"openai":return await this.testOpenAIThinking(e,t,s,i);case"google":return await this.testGeminiThinking(e,t,s,i);case"anthropic":return await this.testClaudeThinking(e,t,s,i);default:return this.getDefaultCapabilities(a)}}async testOpenAIThinking(e,t,a,s){var n,r,c;const i=[{role:"user",content:"一家商店原价100元的商品，先打8折，再打9折，最终价格是多少？请详细展示你的计算和推理过程。"}];try{if(s!=null&&s.signal.aborted)throw new Error("AbortError");if(this.isO1Model(t))return{reasoning:!!((c=(r=(n=(await this.callOpenAIWithO1Params(e,t,i)).choices)==null?void 0:n[0])==null?void 0:r.message)!=null&&c.reasoning),reasoningType:"openai-reasoning",supportedParams:{temperature:!1,maxTokens:"max_completion_tokens",streaming:!1,systemMessage:!0}};if(s!=null&&s.signal.aborted)throw new Error("AbortError");const u=await this.callOpenAIWithThinkingInstructions(e,t,i,a),g=this.detectThinkingInResponse(u,"openai");return{reasoning:g,reasoningType:g?"generic-cot":null,supportedParams:{temperature:!0,maxTokens:"max_tokens",streaming:!0,systemMessage:!0}}}catch(u){if(u instanceof Error&&u.message==="AbortError")throw u;return this.getDefaultCapabilities("openai")}}async testGeminiThinking(e,t,a,s){const i=[{role:"user",content:"请思考并回答：什么是人工智能？"}];try{if(s!=null&&s.signal.aborted)throw new Error("AbortError");const n=await this.callGeminiAPIRaw(e,t,i,a);if(s!=null&&s.signal.aborted)throw new Error("AbortError");const r=this.detectGeminiThoughtField(n);let c=r;return r||(c=this.isGeminiThinkingModel(t)),{reasoning:c,reasoningType:c?"gemini-thought":null,supportedParams:{temperature:!0,maxTokens:"max_tokens",streaming:!0,systemMessage:!0}}}catch(n){if(n instanceof Error&&n.message==="AbortError")throw n;return this.getDefaultCapabilities("google")}}async testClaudeThinking(e,t,a,s){const i=[{role:"user",content:"请用<thinking>标签展示你的思考过程，然后回答：什么是AI？"}];try{if(s!=null&&s.signal.aborted)throw new Error("AbortError");const n=await this.aiService.callAI(i,e,t,a||!1);if(s!=null&&s.signal.aborted)throw new Error("AbortError");const r=typeof n=="string"&&n.includes("<thinking>")&&n.includes("</thinking>");let c=r;return r||(c=this.isClaudeThinkingModel(t)),{reasoning:c,reasoningType:c?"claude-thinking":null,supportedParams:{temperature:!0,maxTokens:"max_tokens",streaming:!0,systemMessage:!0}}}catch(n){if(n instanceof Error&&n.message==="AbortError")throw n;return this.getDefaultCapabilities("anthropic")}}getAPIType(e,t){const a=e.models.find(s=>s.id===t);return(a==null?void 0:a.apiType)||e.type}isO1Model(e){return e.toLowerCase().includes("o1")}isClaudeThinkingModel(e){const t=e.toLowerCase();return t.includes("claude-3.5")||t.includes("claude-3.7")||t.includes("claude-4")||t.includes("sonnet")||t.includes("opus")}isGeminiThinkingModel(e){const t=e.toLowerCase();return t.includes("gemini-2.")||t.includes("gemini-pro")||t.includes("thinking")||t.includes("exp")}detectGeminiThoughtField(e){try{if(typeof e=="string")try{e=JSON.parse(e)}catch{return!1}if(e&&e.candidates&&Array.isArray(e.candidates)){for(const t of e.candidates)if(t.content&&t.content.parts){for(const a of t.content.parts)if(a.thought)return!0}}return!1}catch{return!1}}detectThinkingInResponse(e,t){if(typeof e!="string")return!1;const a=e.toLowerCase();switch(t){case"openai":return this.detectOpenAIThinking(e);case"google":return a.includes("思考")||a.includes("分析")||a.includes("reasoning")||this.hasStructuredThinking(e);case"anthropic":return a.includes("<thinking>")||a.includes("让我思考")||a.includes("分析")||this.hasStructuredThinking(e);default:return!1}}detectOpenAIThinking(e){const t=e.toLowerCase(),s=["<thinking>","thinking:","思考：","分析：","推理：","首先","然后","接着","最后","第一步","第二步","第三步","step 1","step 2","step 3","步骤1","步骤2","计算","计算过程","解题","推导","验证","原价","打折","折扣","最终价格","让我","我需要","我们来","分析一下","考虑到","因此","所以","由此可见","可以得出","根据","基于","考虑","假设","如果","那么"].filter(r=>t.includes(r)).length,i=this.hasStructuredThinking(e),n=this.hasMathematicalReasoning(e);return s>=2&&i||s>=3||n||t.includes("<thinking>")||t.includes("分析过程")}hasStructuredThinking(e){const t=/[1-9]\.|[一二三四五]\s*、|步骤\s*[1-9]/.test(e),s=e.split(`
`).filter(r=>r.trim().length>0).length>2,n=["因为","所以","然而","但是","因此","由于","由此","可见"].filter(r=>e.includes(r)).length;return t||s&&n>=2}hasMathematicalReasoning(e){return[/\d+\s*[×*]\s*\d+/,/\d+\s*[÷/]\s*\d+/,/\d+\s*[+]\s*\d+/,/\d+\s*[-]\s*\d+/,/=\s*\d+/,/0\.\d+/,/\d+%/,/打.*折/,/折扣/].some(a=>a.test(e))}getDefaultCapabilities(e){const t={temperature:!0,maxTokens:"max_tokens",streaming:!0,systemMessage:!0};return e==="openai"?{reasoning:!1,reasoningType:null,supportedParams:{...t}}:e==="google"?{reasoning:!1,reasoningType:null,supportedParams:{...t}}:e==="anthropic"?{reasoning:!1,reasoningType:null,supportedParams:{...t}}:{reasoning:!1,reasoningType:null,supportedParams:t}}createFailedCapabilities(e,t){return{reasoning:!1,reasoningType:null,supportedParams:this.getDefaultCapabilities(t).supportedParams,testResult:{connected:e.connected,reasoning:!1,responseTime:0,error:e.error,timestamp:new Date}}}async callOpenAIWithO1Params(e,t,a){try{if(!e.baseUrl)throw new Error("API URL 未配置");let s=e.baseUrl.trim();s.includes("/chat/completions")||(s.includes("/v1")?s=s.replace(/\/+$/,"")+"/chat/completions":s=s.replace(/\/+$/,"")+"/v1/chat/completions");const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:t,messages:a.map(n=>({role:n.role,content:n.content})),max_completion_tokens:100})});if(!i.ok)throw new Error(`OpenAI API error: ${i.status} ${i.statusText}`);return await i.json()}catch(s){throw s}}async callOpenAIWithThinkingInstructions(e,t,a,s){const i=[{role:"system",content:"请在回答问题时展示你的完整思考过程。包括：1）分析问题 2）制定解决步骤 3）执行计算或推理 4）验证答案。请明确标出每个步骤。"},...a];return await this.aiService.callAI(i,e,t,s||!1)}async callGeminiAPIRaw(e,t,a,s){try{if(!e.baseUrl)throw new Error("API URL 未配置");let i=e.baseUrl.trim();i.endsWith("/v1beta")||(i.includes("/models/")&&(i=i.split("/models/")[0]),i.endsWith("/v1beta")||(i=i.replace(/\/+$/,"")+"/v1beta")),i=`${i}/models/${t}:generateContent`;const n=new URL(i);n.searchParams.set("key",e.apiKey);const c={contents:a.map(g=>({role:g.role==="assistant"?"model":"user",parts:[{text:g.content}]})),generationConfig:{temperature:.7}},u=await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!u.ok)throw new Error(`Gemini API error: ${u.status} ${u.statusText}`);return await u.json()}catch(i){throw i}}clearCache(){this.testCache.clear()}getCacheStats(){return{size:this.testCache.size,keys:Array.from(this.testCache.keys())}}};y(d,"instance");let A=d;export{A as CapabilityDetector};
