const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SavePromptDialog.vue_vue_type_script_setup_true_lang-BQATbsYD.js","assets/index-FUvL6nQC.js","assets/index-D1UliziT.css"])))=>i.map(i=>d[i]);
import{c as rt,x as wt,r as g,a as K,I as je,P as Xe,d as Ce,o as Be,B as ee,e as i,s as n,f as e,g as F,h as O,n as q,j as d,i as de,N as Ae,F as ue,y as pe,t as z,L as ie,v as he,D as _t,Q as kt,H as Pt,w as at,X as lt,R as $t,m as nt,E as it,M as dt,z as ut,l as we,p as Ve,K as St,S as ct,J as tt,_ as Ct}from"./index-FUvL6nQC.js";import{a as Fe,R as Se,A as Ne,d as zt,T as Mt,C as De}from"./ModelDialog.vue_vue_type_script_setup_true_lang-D7nKHo9R.js";import{c as Je,_ as It}from"./SavePromptDialog.vue_vue_type_script_setup_true_lang-BQATbsYD.js";import{P as At,A as mt,C as pt,h as Ot,T as Tt,_ as Lt,f as Ut,b as Et,g as Ge,d as st}from"./FinalTab.vue_vue_type_script_setup_true_lang-CEfr8fxx.js";import{F as Qe,_ as ot,S as Rt,a as jt}from"./SettingsModal.vue_vue_type_script_setup_true_lang-C1M4OPhj.js";import{C as gt}from"./check-mMMgFnhj.js";/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=rt("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=rt("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]),We=wt("optimize",()=>{const C=g(""),o=g(""),l=g(null),_=g(null),a=g(null),f=g(!1),k=g([]),t=g([]),U=g({system:"",user:""}),A=g(!1),B=g(!1),R=g([]),y=g("original"),P=g(!1),E=g([]),M=g(""),p=g([]),$=g(!1),I=g("input"),L=g(!1),r=g(!1),c=K(()=>C.value.trim()||o.value.trim()),s=K(()=>U.value.system.trim()||U.value.user.trim()),S=K(()=>k.value.filter(N=>t.value.includes(N.id))),j=K(()=>R.value.find(N=>N.version===y.value)),V=()=>{C.value="",o.value="",l.value=null,_.value=null,a.value=null,k.value=[],t.value=[],U.value={system:"",user:""},R.value=[],y.value="original",E.value=[],p.value=[],I.value="input"},Y=(N,J,me)=>{C.value=N,o.value=J,me&&(l.value=me)},X=N=>{_.value=N},h=N=>{a.value=N},b=N=>{k.value=N,t.value=N.map(J=>J.id)},w=N=>{const J=t.value.indexOf(N);J>-1?t.value.splice(J,1):t.value.push(N)},D=()=>{t.value=k.value.map(N=>N.id)},ne=()=>{t.value=[]},re=(N,J)=>{U.value={system:N,user:J};const me={id:`v_${Date.now()}`,version:`V${R.value.length+1}`,systemPrompt:N,userPrompt:J,changes:ce(C.value,N,o.value,J),appliedSuggestions:[...t.value],createdAt:new Date,tag:"draft"};R.value.push(me),y.value=me.version},ce=(N,J,me,Z)=>{const te=[];return N!==J&&te.push({type:"modify",field:"system",content:J}),me!==Z&&te.push({type:"modify",field:"user",content:Z}),te};return{systemPrompt:C,userPrompt:o,importedPromptId:l,loadedPromptId:_,analysis:a,isAnalyzing:f,suggestions:k,selectedSuggestions:t,optimizedPrompts:U,isGeneratingSuggestions:A,isApplyingSuggestions:B,versions:R,currentVersion:y,isVersionLoading:P,testCases:E,currentTestCase:M,testResults:p,isTesting:$,activeTab:I,showDiffView:L,showVersionHistory:r,hasPromptContent:c,hasOptimizedPrompt:s,selectedSuggestionObjects:S,currentVersionData:j,resetOptimization:V,setPrompts:Y,setLoadedPromptId:X,setAnalysis:h,setSuggestions:b,toggleSuggestion:w,selectAllSuggestions:D,deselectAllSuggestions:ne,setOptimizedPrompts:re,addTestCase:N=>{N.trim()&&!E.value.includes(N.trim())&&E.value.push(N.trim())},setCurrentTestCase:N=>{M.value=N},setTestResults:N=>{p.value=N},switchTab:N=>{I.value=N},toggleDiffView:()=>{L.value=!L.value},toggleVersionHistory:()=>{r.value=!r.value},switchVersion:N=>{y.value=N;const J=R.value.find(me=>me.version===N);J&&(U.value={system:J.systemPrompt,user:J.userPrompt})}}});function vt(C){if(!C)throw new Error("Empty content");try{return JSON.parse(C)}catch{}const o=/```(?:json)?\s*\n?([\s\S]*?)\n?```/,l=C.match(o);if(l&&l[1])try{return JSON.parse(l[1].trim())}catch(f){throw new Error(`Failed to parse JSON from code block: ${f}`)}const _=C.indexOf("{"),a=C.lastIndexOf("}");if(_!==-1&&a!==-1&&a>_)try{const f=C.substring(_,a+1);return JSON.parse(f)}catch(f){throw new Error(`Failed to parse extracted JSON: ${f}`)}throw new Error("No valid JSON found in content")}function Vt(){const C=je(),o=Fe.getInstance(),l=Xe({mode:"system",systemConfig:{leftSystemPrompt:"",rightSystemPrompt:"",sharedUserInput:""},leftMessages:[],rightMessages:[],userConfig:{sharedSystemPrompt:"",leftUserPrompt:"",rightUserPrompt:""},leftUserMessages:[],rightUserMessages:[],isLeftGenerating:!1,isRightGenerating:!1}),_=K(()=>l.isLeftGenerating||l.isRightGenerating),a=(y,P)=>{l.mode="system",l.systemConfig.leftSystemPrompt=y,l.systemConfig.rightSystemPrompt=P,l.systemConfig.sharedUserInput="",l.leftMessages=[],l.rightMessages=[],console.log("🔵 初始化系统提示词对比:",{leftLength:y.length,rightLength:P.length})},f=(y,P,E)=>{l.mode="user",l.userConfig.sharedSystemPrompt=y,l.userConfig.leftUserPrompt=P,l.userConfig.rightUserPrompt=E,l.leftUserMessages=[],l.rightUserMessages=[],console.log("🔵 初始化用户提示词对比:",{systemPromptLength:y.length,leftLength:P.length,rightLength:E.length})},k=async()=>{if(!l.systemConfig.sharedUserInput.trim()||_.value)return;const y=C.getAvailableProviders().find(L=>L.id===C.selectedProvider),P=C.selectedModel;if(!y||!P)throw new Error("请先选择AI提供商和模型");const E=l.systemConfig.sharedUserInput.trim(),M=`user-${Date.now()}`,p={id:M,role:"user",content:E,timestamp:new Date};l.leftMessages.push({...p,id:`left-${M}`}),l.rightMessages.push({...p,id:`right-${M}`}),l.systemConfig.sharedUserInput="";const $=A("left",l.systemConfig.leftSystemPrompt,l.leftMessages),I=A("right",l.systemConfig.rightSystemPrompt,l.rightMessages);await Promise.all([$,I])},t=async()=>{if(!l.userConfig.leftUserPrompt.trim()||l.isLeftGenerating)return;const y=C.getAvailableProviders().find($=>$.id===C.selectedProvider),P=C.selectedModel;if(!y||!P)throw new Error("请先选择AI提供商和模型");const E=l.userConfig.leftUserPrompt.trim(),p={id:`left-user-${Date.now()}`,role:"user",content:E,timestamp:new Date};l.leftUserMessages.push(p),l.userConfig.leftUserPrompt="",await A("left",l.userConfig.sharedSystemPrompt,l.leftUserMessages)},U=async()=>{if(!l.userConfig.rightUserPrompt.trim()||l.isRightGenerating)return;const y=C.getAvailableProviders().find($=>$.id===C.selectedProvider),P=C.selectedModel;if(!y||!P)throw new Error("请先选择AI提供商和模型");const E=l.userConfig.rightUserPrompt.trim(),p={id:`right-user-${Date.now()}`,role:"user",content:E,timestamp:new Date};l.rightUserMessages.push(p),l.userConfig.rightUserPrompt="",await A("right",l.userConfig.sharedSystemPrompt,l.rightUserMessages)},A=async(y,P,E)=>{const M=C.getAvailableProviders().find(L=>L.id===C.selectedProvider),p=C.selectedModel;if(!M||!p)throw new Error("请先选择AI提供商和模型");y==="left"?l.isLeftGenerating=!0:l.isRightGenerating=!0;const $=`${y}-ai-${Date.now()}`,I={id:$,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};E.push(I);try{const L=[{role:"system",content:P},...E.filter(S=>S.id!==$).map(S=>({role:S.role,content:S.content}))],r=S=>{const j=E.find(V=>V.id===$);j&&(j.content+=S)},c=await o.callAI(L,M,p,!0,r),s=E.find(S=>S.id===$);s&&(s.content=c,s.isStreaming=!1)}catch(L){console.error(`${y} AI call failed:`,L);const r=E.find(c=>c.id===$);r&&(r.content=`❌ 错误: ${L.message}`,r.isStreaming=!1)}finally{y==="left"?l.isLeftGenerating=!1:l.isRightGenerating=!1}};return{state:l,isGenerating:_,initSystemComparison:a,initUserComparison:f,sendSystemMessage:k,sendLeftUserMessage:t,sendRightUserMessage:U,clearHistory:y=>{l.mode==="system"?((!y||y==="left")&&(l.leftMessages=[]),(!y||y==="right")&&(l.rightMessages=[])):((!y||y==="left")&&(l.leftUserMessages=[]),(!y||y==="right")&&(l.rightUserMessages=[]))},reset:()=>{l.systemConfig={leftSystemPrompt:"",rightSystemPrompt:"",sharedUserInput:""},l.userConfig={sharedSystemPrompt:"",leftUserPrompt:"",rightUserPrompt:""},l.leftMessages=[],l.rightMessages=[],l.leftUserMessages=[],l.rightUserMessages=[],l.isLeftGenerating=!1,l.isRightGenerating=!1}}}const Nt={class:"h-full min-h-0 overflow-hidden flex flex-col"},Dt={class:"flex-1 min-h-0 grid grid-cols-2 gap-4 mb-4"},Jt={class:"flex flex-col bg-white rounded-lg shadow-sm overflow-hidden"},Bt={class:"p-4 border-b border-gray-200 flex-shrink-0"},Ft={class:"flex justify-between items-center"},Gt={class:"flex items-center space-x-2"},Kt=["title"],qt={class:"flex items-center gap-2"},Qt={key:0,class:"px-4 pb-2 border-b border-gray-200 bg-gray-50"},Yt={class:"py-2 space-y-2"},Xt={class:"flex items-center justify-between"},Wt={class:"flex flex-col gap-2"},Zt=["value"],es=["disabled"],ts=["value"],ss={class:"text-xs text-gray-500"},os={key:0},rs={key:1},as={key:2},ls={class:"flex-1 flex flex-col min-h-0"},ns={key:0,class:"flex items-center justify-center h-full text-gray-400"},is={class:"text-center"},ds={class:"flex flex-col w-full max-w-xs lg:max-w-md"},us=["innerHTML"],cs={key:1,class:"whitespace-pre-wrap"},ms={key:0,class:"animate-pulse"},ps={key:0,class:"p-3 border-t border-gray-200"},gs={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},vs={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},fs=["disabled"],ys={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},hs=["disabled"],bs={class:"flex flex-col bg-white rounded-lg shadow-sm overflow-hidden"},xs={class:"p-4 border-b border-gray-200 flex-shrink-0"},ws={class:"flex justify-between items-center"},_s={class:"flex items-center space-x-2"},ks=["title"],Ps={class:"flex items-center gap-2"},$s={key:0,class:"px-4 pb-2 border-b border-gray-200 bg-gray-50"},Ss={class:"py-2 space-y-2"},Cs={class:"flex items-center justify-between"},zs={class:"flex flex-col gap-2"},Ms=["value"],Is=["disabled"],As=["value"],Os={class:"text-xs text-gray-500"},Ts={key:0},Ls={key:1},Us={key:2},Es={class:"flex-1 flex flex-col min-h-0"},Rs={key:0,class:"flex items-center justify-center h-full text-gray-400"},js={class:"text-center"},Hs={class:"flex flex-col w-full max-w-xs lg:max-w-md"},Vs=["innerHTML"],Ns={key:1,class:"whitespace-pre-wrap"},Ds={key:0,class:"animate-pulse"},Js={key:0,class:"p-3 border-t border-gray-200"},Bs={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},Fs={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},Gs=["disabled"],Ks={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},qs=["disabled"],Qs={class:"flex-shrink-0"},Ys={key:0,class:"bg-white rounded-lg shadow-md border border-gray-200 p-3"},Xs={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},Ws={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},Zs=["disabled"],eo={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},to=["disabled"],so=Ce({__name:"ComparisonPanel",setup(C){const o=Vt(),l=je(),_=g(null),a=g(null),f=g("user"),k=g(""),t=g(""),U=g(""),A=g(""),B=g(""),R=g(!1),y=g(!1),P=g(!1),E=g(!1),M=g(!1),p=g(""),$=g(""),I=g(""),L=g(""),r=g(""),c=g(""),s=K(()=>o.state.leftMessages),S=K(()=>o.state.rightMessages),j=K(()=>o.state.leftUserMessages),V=K(()=>o.state.rightUserMessages),Y=K(()=>o.isGenerating.value),X=K(()=>o.state.isLeftGenerating),h=K(()=>o.state.isRightGenerating),b=K(()=>l.getAvailableProviders()),w=K(()=>I.value?l.getAvailableModels(I.value):[]),D=K(()=>r.value?l.getAvailableModels(r.value):[]),ne=K(()=>{if(!I.value||!L.value)return"使用全局模型";const H=b.value.find(m=>m.id===I.value),u=w.value.find(m=>m.id===L.value);return u?`${H==null?void 0:H.name} - ${u.name}`:"使用全局模型"}),re=K(()=>{if(!r.value||!c.value)return"使用全局模型";const H=b.value.find(m=>m.id===r.value),u=D.value.find(m=>m.id===c.value);return u?`${H==null?void 0:H.name} - ${u.name}`:"使用全局模型"});Be(()=>{try{const u=localStorage.getItem("yprompt_comparison_model_config");if(u){const m=JSON.parse(u);I.value=m.leftProvider||"",L.value=m.leftModel||"",r.value=m.rightProvider||"",c.value=m.rightModel||"",console.log("🟢 加载保存的模型配置:",m)}}catch(u){console.error("加载模型配置失败:",u)}try{const u=localStorage.getItem("yprompt_comparison_data");if(u){const m=JSON.parse(u);console.log("🟢 ComparisonPanel 加载数据:",m),R.value=!0,m.mode==="system"?(f.value="system",o.initSystemComparison(m.originalPrompt,m.optimizedPrompt)):m.mode==="user"&&(f.value="user",o.initUserComparison(m.systemPrompt||"",m.originalPrompt,m.optimizedPrompt),A.value=m.originalPrompt,B.value=m.optimizedPrompt,t.value=m.originalPrompt,U.value=m.optimizedPrompt,m.conversationHistory&&(console.log("🟢 加载对话上下文:",m.conversationHistory),xe(m.conversationHistory)))}else console.warn("⚠️ 没有找到对比数据，显示默认空白对话框")}catch(u){console.error("加载对比数据失败:",u)}const H=()=>{const u=["yprompt_token","yprompt_user","yprompt_settings","yprompt_comparison_model_config"];Object.keys(localStorage).forEach(fe=>{u.includes(fe)||localStorage.removeItem(fe)}),console.log("🧹 浏览器关闭，已清理所有数据（保留用户信息）")};return window.addEventListener("beforeunload",H),()=>{window.removeEventListener("beforeunload",H)}});const ce=async()=>{k.value.trim()&&(o.state.systemConfig.sharedUserInput=k.value,await o.sendSystemMessage(),k.value="")},se=async()=>{t.value.trim()&&(o.state.userConfig.leftUserPrompt=t.value,await o.sendLeftUserMessage())},ae=async()=>{U.value.trim()&&(o.state.userConfig.rightUserPrompt=U.value,await o.sendRightUserMessage())},le=()=>{confirm("确定清空左侧对话历史吗？")&&o.clearHistory("left")},be=()=>{confirm("确定清空右侧对话历史吗？")&&o.clearHistory("right")},xe=H=>{try{const u=JSON.parse(H);if(Array.isArray(u)){u.forEach(m=>{const fe=new Date,Me=m.role==="assistant"?"assistant":"user";o.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:Me,content:m.content,timestamp:fe}),o.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:Me,content:m.content,timestamp:fe})}),console.log("✅ 对话上下文加载完成（JSON格式）:",u.length,"条消息");return}}catch{console.log("⚠️ JSON解析失败，尝试旧格式")}try{const u=H.split(`
`).filter(m=>m.trim());for(const m of u){const fe=m.match(/^User:\s*(.+)$/i),Me=m.match(/^Assistant:\s*(.+)$/i);if(fe){const Ie=fe[1].trim(),Pe=new Date;o.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:"user",content:Ie,timestamp:Pe}),o.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:"user",content:Ie,timestamp:Pe})}else if(Me){const Ie=Me[1].trim(),Pe=new Date;o.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:"assistant",content:Ie,timestamp:Pe}),o.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:"assistant",content:Ie,timestamp:Pe})}}console.log("✅ 对话上下文加载完成（旧格式）")}catch(u){console.error("加载对话上下文失败:",u)}};ee(()=>o.state.systemConfig.leftSystemPrompt,H=>{p.value=H},{immediate:!0}),ee(()=>o.state.systemConfig.rightSystemPrompt,H=>{$.value=H},{immediate:!0}),ee(()=>o.state.userConfig.sharedSystemPrompt,H=>{f.value==="user"&&(p.value=H,$.value=H)},{immediate:!0}),ee([I,L,r,c],()=>{const H={leftProvider:I.value,leftModel:L.value,rightProvider:r.value,rightModel:c.value};localStorage.setItem("yprompt_comparison_model_config",JSON.stringify(H)),console.log("💾 保存模型配置:",H)});const ge=()=>{f.value==="system"?o.state.systemConfig.leftSystemPrompt=p.value:o.state.userConfig.sharedSystemPrompt=p.value},_e=()=>{f.value==="system"?o.state.systemConfig.rightSystemPrompt=$.value:o.state.userConfig.sharedSystemPrompt=$.value},N=H=>{H.key==="Enter"&&!H.shiftKey&&(H.preventDefault(),k.value.trim()&&!Y.value&&ce())},J=H=>{H.key==="Enter"&&!H.shiftKey&&(H.preventDefault(),t.value.trim()&&!X.value&&se())},me=H=>{H.key==="Enter"&&!H.shiftKey&&(H.preventDefault(),U.value.trim()&&!h.value&&ae())},Z=()=>{L.value=""},te=()=>{c.value=""},Oe=()=>{I.value="",L.value=""},ke=()=>{r.value="",c.value=""},Te=()=>{confirm("确定要重置所有数据吗？这将清空所有对话和设置。")&&(o.clearHistory("left"),o.clearHistory("right"),o.state.systemConfig.leftSystemPrompt="",o.state.systemConfig.rightSystemPrompt="",o.state.systemConfig.sharedUserInput="",o.state.userConfig.sharedSystemPrompt="",o.state.userConfig.leftUserPrompt="",o.state.userConfig.rightUserPrompt="",k.value="",t.value="",U.value="",p.value="",$.value="",localStorage.removeItem("yprompt_comparison_data"),localStorage.removeItem("yprompt_trigger_compare"))},ze=()=>{localStorage.removeItem("yprompt_trigger_compare");const H=f.value==="system"?"system":"user";localStorage.setItem("yprompt_optimize_active_mode",H),localStorage.setItem("yprompt_back_to_optimize","true")},ve=H=>{_t(()=>{H&&(H.scrollTop=H.scrollHeight)})};ee(()=>s.value.length,()=>{ve(_.value)}),ee(()=>S.value.length,()=>{ve(a.value)}),ee(()=>j.value.length,()=>{ve(_.value)}),ee(()=>V.value.length,()=>{ve(a.value)}),ee(()=>o.state.isLeftGenerating,()=>{ve(_.value)}),ee(()=>o.state.isRightGenerating,()=>{ve(a.value)}),ee(()=>(f.value==="system"?s.value:j.value).map(u=>u.content).join(""),()=>{ve(_.value)},{deep:!0}),ee(()=>(f.value==="system"?S.value:V.value).map(u=>u.content).join(""),()=>{ve(a.value)},{deep:!0});const He=H=>{try{return zt(H)}catch(u){return console.error("Markdown渲染失败:",u),H}};return(H,u)=>(n(),i("div",Nt,[e("div",Dt,[e("div",Jt,[e("div",Bt,[e("div",Ft,[e("div",Gt,[u[16]||(u[16]=e("h2",{class:"font-semibold text-gray-800"},"优化前",-1)),e("button",{onClick:u[0]||(u[0]=m=>y.value=!0),class:q(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm",d(o).state.systemConfig.leftSystemPrompt.trim()||d(o).state.userConfig.sharedSystemPrompt.trim()?"text-green-600":"text-gray-400"]),title:"设置系统提示词"},[F(d(Qe),{class:"w-4 h-4"})],2),e("button",{onClick:u[1]||(u[1]=m=>E.value=!E.value),class:q(["p-1 hover:bg-gray-100 rounded transition-colors",L.value?"text-green-600":"text-gray-600"]),title:ne.value},[...u[15]||(u[15]=[e("svg",{class:"w-4 h-4 hover:text-gray-800",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"})],-1)])],10,Kt)]),e("div",qt,[e("button",{onClick:Te,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置所有数据"},[F(d(Se),{class:"w-4 h-4"}),u[17]||(u[17]=e("span",null,"重置",-1))]),s.value.length>0||j.value.length>0?(n(),i("button",{key:0,onClick:le,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"清空对话"},[F(d(Se),{class:"w-4 h-4"}),u[18]||(u[18]=e("span",null,"清空",-1))])):O("",!0)])])]),E.value?(n(),i("div",Qt,[e("div",Yt,[e("div",Xt,[u[19]||(u[19]=e("label",{class:"text-sm font-medium text-gray-700"},"选择AI模型",-1)),I.value?(n(),i("button",{key:0,onClick:Oe,class:"px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置为全局模型"}," 重置 ")):O("",!0)]),e("div",Wt,[de(e("select",{"onUpdate:modelValue":u[2]||(u[2]=m=>I.value=m),onChange:Z,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[u[20]||(u[20]=e("option",{value:""},"使用全局模型",-1)),(n(!0),i(ue,null,pe(b.value,m=>(n(),i("option",{key:m.id,value:m.id},z(m.name),9,Zt))),128))],544),[[Ae,I.value]]),de(e("select",{"onUpdate:modelValue":u[3]||(u[3]=m=>L.value=m),disabled:!I.value,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"},[u[21]||(u[21]=e("option",{value:""},"选择模型",-1)),(n(!0),i(ue,null,pe(w.value,m=>(n(),i("option",{key:m.id,value:m.id},z(m.name),9,ts))),128))],8,es),[[Ae,L.value]])]),e("div",ss,[I.value?L.value?(n(),i("span",as,"当前: "+z(ne.value),1)):(n(),i("span",rs,"请选择模型")):(n(),i("span",os,"当前: 跟随全局模型设置"))])])])):O("",!0),e("div",ls,[e("div",{ref_key:"leftChatContainer",ref:_,class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},[(f.value==="system"?s.value:j.value).length===0?(n(),i("div",ns,[e("div",is,[F(d(Ye),{class:"w-12 h-12 mx-auto mb-2 opacity-50"}),u[22]||(u[22]=e("p",{class:"text-sm"},"暂无对话",-1))])])):O("",!0),(n(!0),i(ue,null,pe(f.value==="system"?s.value:j.value,m=>(n(),i("div",{key:m.id,class:q(["flex group",m.role==="user"?"justify-end":"justify-start"])},[e("div",ds,[e("div",{class:q([m.role==="user"?"bg-blue-500 text-white px-4 py-3 rounded-lg ml-auto":"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg mr-auto","transition-all duration-300 relative"])},[m.role==="assistant"?(n(),i("div",{key:0,innerHTML:He(m.content),class:"prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"},null,8,us)):(n(),i("div",cs,[ie(z(m.content),1),m.isStreaming?(n(),i("span",ms,"▋")):O("",!0)]))],2)])],2))),128))],512),f.value==="user"?(n(),i("div",ps,[e("div",gs,[e("div",vs,[de(e("textarea",{"onUpdate:modelValue":u[4]||(u[4]=m=>t.value=m),onKeydown:J,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:X.value,rows:"1"},null,40,fs),[[he,t.value]])]),e("div",ys,[u[23]||(u[23]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:se,disabled:!t.value.trim()||X.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"},[F(d(Ne),{class:"w-4 h-4"})],8,hs)])])])):O("",!0)])]),e("div",bs,[e("div",xs,[e("div",ws,[e("div",_s,[u[25]||(u[25]=e("h2",{class:"font-semibold text-gray-800"},"优化后",-1)),e("button",{onClick:u[5]||(u[5]=m=>P.value=!0),class:q(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm",d(o).state.systemConfig.rightSystemPrompt.trim()||d(o).state.userConfig.sharedSystemPrompt.trim()?"text-green-600":"text-gray-400"]),title:"设置系统提示词"},[F(d(Qe),{class:"w-4 h-4"})],2),e("button",{onClick:u[6]||(u[6]=m=>M.value=!M.value),class:q(["p-1 hover:bg-gray-100 rounded transition-colors",c.value?"text-green-600":"text-gray-600"]),title:re.value},[...u[24]||(u[24]=[e("svg",{class:"w-4 h-4 hover:text-gray-800",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"})],-1)])],10,ks)]),e("div",Ps,[S.value.length>0||V.value.length>0?(n(),i("button",{key:0,onClick:be,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"清空对话"},[F(d(Se),{class:"w-4 h-4"}),u[26]||(u[26]=e("span",null,"清空",-1))])):O("",!0),R.value?(n(),i("button",{key:1,onClick:ze,class:"flex items-center gap-1 px-3 py-1 text-sm bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors",title:"返回优化页面"},[F(d(Ht),{class:"w-4 h-4"}),u[27]||(u[27]=e("span",null,"返回",-1))])):O("",!0)])])]),M.value?(n(),i("div",$s,[e("div",Ss,[e("div",Cs,[u[28]||(u[28]=e("label",{class:"text-sm font-medium text-gray-700"},"选择AI模型",-1)),r.value?(n(),i("button",{key:0,onClick:ke,class:"px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置为全局模型"}," 重置 ")):O("",!0)]),e("div",zs,[de(e("select",{"onUpdate:modelValue":u[7]||(u[7]=m=>r.value=m),onChange:te,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[u[29]||(u[29]=e("option",{value:""},"使用全局模型",-1)),(n(!0),i(ue,null,pe(b.value,m=>(n(),i("option",{key:m.id,value:m.id},z(m.name),9,Ms))),128))],544),[[Ae,r.value]]),de(e("select",{"onUpdate:modelValue":u[8]||(u[8]=m=>c.value=m),disabled:!r.value,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"},[u[30]||(u[30]=e("option",{value:""},"选择模型",-1)),(n(!0),i(ue,null,pe(D.value,m=>(n(),i("option",{key:m.id,value:m.id},z(m.name),9,As))),128))],8,Is),[[Ae,c.value]])]),e("div",Os,[r.value?c.value?(n(),i("span",Us,"当前: "+z(re.value),1)):(n(),i("span",Ls,"请选择模型")):(n(),i("span",Ts,"当前: 跟随全局模型设置"))])])])):O("",!0),e("div",Es,[e("div",{ref_key:"rightChatContainer",ref:a,class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},[(f.value==="system"?S.value:V.value).length===0?(n(),i("div",Rs,[e("div",js,[F(d(Ye),{class:"w-12 h-12 mx-auto mb-2 opacity-50"}),u[31]||(u[31]=e("p",{class:"text-sm"},"暂无对话",-1))])])):O("",!0),(n(!0),i(ue,null,pe(f.value==="system"?S.value:V.value,m=>(n(),i("div",{key:m.id,class:q(["flex group",m.role==="user"?"justify-end":"justify-start"])},[e("div",Hs,[e("div",{class:q([m.role==="user"?"bg-blue-500 text-white px-4 py-3 rounded-lg ml-auto":"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg mr-auto","transition-all duration-300 relative"])},[m.role==="assistant"?(n(),i("div",{key:0,innerHTML:He(m.content),class:"prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"},null,8,Vs)):(n(),i("div",Ns,[ie(z(m.content),1),m.isStreaming?(n(),i("span",Ds,"▋")):O("",!0)]))],2)])],2))),128))],512),f.value==="user"?(n(),i("div",Js,[e("div",Bs,[e("div",Fs,[de(e("textarea",{"onUpdate:modelValue":u[9]||(u[9]=m=>U.value=m),onKeydown:me,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:h.value,rows:"1"},null,40,Gs),[[he,U.value]])]),e("div",Ks,[u[32]||(u[32]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:ae,disabled:!U.value.trim()||h.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"},[F(d(Ne),{class:"w-4 h-4"})],8,qs)])])])):O("",!0)])])]),e("div",Qs,[f.value==="system"?(n(),i("div",Ys,[e("div",Xs,[e("div",Ws,[de(e("textarea",{"onUpdate:modelValue":u[10]||(u[10]=m=>k.value=m),onKeydown:N,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:Y.value,rows:"1"},null,40,Zs),[[he,k.value]])]),e("div",eo,[u[33]||(u[33]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:ce,disabled:!k.value.trim()||Y.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto",title:"同时发送到两侧"},[F(d(Ne),{class:"w-4 h-4"})],8,to)])])])):O("",!0)]),F(ot,{"is-open":y.value,modelValue:p.value,"onUpdate:modelValue":u[11]||(u[11]=m=>p.value=m),onClose:u[12]||(u[12]=m=>y.value=!1),onSave:ge,title:f.value==="system"?"系统提示词（左 - 优化前）":"共用系统提示词"},null,8,["is-open","modelValue","title"]),F(ot,{"is-open":P.value,modelValue:$.value,"onUpdate:modelValue":u[13]||(u[13]=m=>$.value=m),onClose:u[14]||(u[14]=m=>P.value=!1),onSave:_e,title:f.value==="system"?"系统提示词（右 - 优化后）":"共用系统提示词"},null,8,["is-open","modelValue","title"])]))}});function oo(){const C=je(),o=We(),l=kt.getInstance(),_=Fe.getInstance(),a="user_prompt_optimize_result",f=()=>{try{const s=localStorage.getItem(a);if(s){const S=JSON.parse(s);return S.metadata&&S.metadata.timestamp&&(S.metadata.timestamp=new Date(S.metadata.timestamp)),S}}catch(s){console.error("加载优化结果失败:",s)}return null},k=s=>{try{s?localStorage.setItem(a,JSON.stringify(s)):localStorage.removeItem(a)}catch(S){console.error("保存优化结果失败:",S)}},t=Xe({draftPrompt:"",systemPrompt:"",conversationHistory:"",result:f(),isOptimizing:!1,error:null,isAnalyzing:!1,analysisText:"",isOptimizingPrompt:!1,optimizedText:"",enableQualityAnalysis:!0,languageState:"zh",isConvertingLanguage:!1}),U=K(()=>t.draftPrompt.trim().length>0),A=K(()=>t.result!==null),B=K(()=>t.error!==null),R=s=>/[\u4e00-\u9fa5]/.test(s)?"中文":"英文",y=async()=>{var S,j,V,Y,X,h,b,w,D,ne;if(!t.result){t.error="没有可用的质量分析结果";return}t.isOptimizing=!0,t.error=null,t.optimizedText="";const s=performance.now();try{const re=R(t.draftPrompt),se=C.getAvailableProviders().find(J=>J.id===C.selectedProvider),ae=C.selectedModel;if(!se||!ae)throw new Error("请先在顶部选择AI提供商和模型");const le=l.getUserPromptQuickOptimization(),be=l.getUserPromptRules(),ge=[{role:"system",content:le.replace("{SYSTEM_PROMPT_RULES}",be).replace("{SYSTEM_PROMPT_CONTEXT}",t.systemPrompt||"无系统提示词").replace("{CONVERSATION_HISTORY}",t.conversationHistory||"无对话历史").replace("{USER_DRAFT_PROMPT}",t.draftPrompt).replace("{VARIABLES_SECTION}","").replace("{LANGUAGE}",re)},{role:"user",content:"请输出优化后的提示词（只输出优化结果，不要解释）"}];if(t.enableQualityAnalysis&&t.result.qualityAnalysis&&t.result.qualityAnalysis.overall_score>0){const J=t.result.qualityAnalysis,me=`

**质量分析结果（请参考以改进）：**
- 整体评分：${J.overall_score}/100
- 清晰度：${(S=J.analysis.clarity)==null?void 0:S.score}/100 - ${(j=J.analysis.clarity)==null?void 0:j.feedback}
- 特定性：${(V=J.analysis.specificity)==null?void 0:V.score}/100 - ${(Y=J.analysis.specificity)==null?void 0:Y.feedback}
- 结构：${(X=J.analysis.structure)==null?void 0:X.score}/100 - ${(h=J.analysis.structure)==null?void 0:h.feedback}
- 上下文：${(b=J.analysis.context)==null?void 0:b.score}/100 - ${(w=J.analysis.context)==null?void 0:w.feedback}
- 完整性：${(D=J.analysis.completeness)==null?void 0:D.score}/100 - ${(ne=J.analysis.completeness)==null?void 0:ne.feedback}
${J.issues&&J.issues.length>0?`
**发现的问题：**
${J.issues.map((Z,te)=>`${te+1}. ${Z}`).join(`
`)}`:""}

请根据以上分析结果，重点改进低分维度，生成优化后的提示词。`;ge[0].content+=me}t.isOptimizingPrompt=!0,_.setStreamUpdateCallback(J=>{t.optimizedText+=J});const _e=await _.callAI(ge,se,ae,!0);_.clearStreamUpdateCallback(),t.isOptimizingPrompt=!1,console.log("✅ 重新生成优化完成");const N=performance.now()-s;t.result={...t.result,optimizedPrompt:_e.trim(),metadata:{processingTime:N,modelUsed:C.selectedModel||"unknown",timestamp:new Date}},t.languageState="zh",k(t.result),console.log(`✅ 重新生成完成，耗时: ${N.toFixed(0)}ms`)}catch(re){console.error("重新生成失败:",re),t.error=re.message||"重新生成失败，请重试",t.isOptimizingPrompt=!1}finally{t.isOptimizing=!1}},P=async()=>{var S,j,V,Y,X,h,b,w,D,ne;if(!U.value){t.error="请输入草稿提示词";return}t.isOptimizing=!0,t.error=null,t.analysisText="",t.optimizedText="";const s=performance.now();try{const re=R(t.draftPrompt),se=C.getAvailableProviders().find(ke=>ke.id===C.selectedProvider),ae=C.selectedModel;if(!se||!ae)throw new Error("请先在顶部选择AI提供商和模型");const le=t.conversationHistory?`
**对话上下文：**
${t.conversationHistory}
`:"",xe=`你是专业的用户提示词质量分析师。

**任务：**分析用户草稿提示词的质量，给出评分和建议。
${t.systemPrompt?`
**AI助手的系统提示词：**
${t.systemPrompt}
`:""}${le}
**❗️ 重要角色说明 ❗️**
- **系统提示词**（如上所示）是**AI助手**的角色设定，不是用户的角色
- **用户草稿**是用户发给AI助手的消息，用户不需要扮演AI助手的角色
- 例如：AI助手是医生，用户是患者；AI助手是翻译，用户是需要翻译服务的人

**分析原则：**
- ✅ 草稿是否与**对话历史连贯**（例如：AI问"多久了"，用户答"三天了"是连贯的）
- ✅ 草稿是否清晰地向AI助手**提出需求或提供信息**
- ❌ 不要要求用户草稿"符合AI助手的角色"（用户不是AI助手！）
- ❌ 不要要求用户草稿包含AI助手才应该提供的内容（如医生的诊断建议）

**角色立场示例：**

场景：AI助手是医生，对话历史：用户"我牙疼" → AI"牙疼多久了"
- 用户草稿："三天了"
- ❌ 错误分析："不符合AI助手作为医生的角色，无法进行诊断"（用户不是医生！）
- ✅ 正确分析："与对话连贯，但信息过于简略，建议补充症状细节"

**分析维度（基于业界最佳实践）：**
1. **清晰度 (clarity)**: 意图是否明确，表达是否清晰，避免歧义
2. **特定性 (specificity)**: 是否具体，细节是否充分，避免模糊和泛泛而谈
3. **结构 (structure)**: 信息是否有组织，逻辑是否清晰，层次是否分明
4. **上下文 (context)**: 是否提供了足够的背景信息、使用场景、目标受众等；是否与对话历史连贯
5. **完整性 (completeness)**: 是否包含所有必要元素（任务、要求、限制、输出格式等）

**评分标准：**
- 90-100: 优秀，几乎无问题
- 70-89: 良好，有小问题但不影响使用
- 50-69: 一般，有明显问题需要优化
- <50: 差，问题较多必须优化

**输出格式（JSON）：**
\`\`\`json
{
  "overall_score": 75,
  "analysis": {
    "clarity": {
      "score": 80,
      "feedback": "意图基本明确，但某些表述略显模糊"
    },
    "specificity": {
      "score": 60,
      "feedback": "缺少具体细节，过于笼统"
    },
    "structure": {
      "score": 70,
      "feedback": "有基本结构，但层次不够清晰"
    },
    "context": {
      "score": 50,
      "feedback": "未提供背景信息和使用场景"
    },
    "completeness": {
      "score": 65,
      "feedback": "缺少输出格式和一些关键要求"
    }
  },
  "issues": [
    "提示词缺少具体的使用场景和目标受众",
    "未明确输出格式和字数要求",
    "缺少必要的背景信息和约束条件"
  ]
}
\`\`\`

**草稿提示词：**
${t.draftPrompt}

**请直接输出JSON，不要其他内容。**`,ge=l.getUserPromptQuickOptimization(),_e=l.getUserPromptRules(),N=ge.replace("{SYSTEM_PROMPT_RULES}",_e).replace("{SYSTEM_PROMPT_CONTEXT}",t.systemPrompt||"无系统提示词").replace("{CONVERSATION_HISTORY}",t.conversationHistory||"无对话历史").replace("{USER_DRAFT_PROMPT}",t.draftPrompt).replace("{VARIABLES_SECTION}","").replace("{LANGUAGE}",re),J=[{role:"system",content:xe},{role:"user",content:"请分析这个草稿的问题"}],me=[{role:"system",content:N},{role:"user",content:"请输出优化后的提示词（只输出优化结果，不要解释）"}];let Z=null;if(t.enableQualityAnalysis){console.log("🔍 开始质量分析（流式）"),t.isAnalyzing=!0,_.setStreamUpdateCallback(ze=>{t.analysisText+=ze});const ke=await _.callAI(J,se,ae,!0);if(_.clearStreamUpdateCallback(),t.isAnalyzing=!1,Z=vt(ke),!Z)throw new Error("质量分析结果格式错误");console.log("✅ 质量分析完成，开始优化结果（流式）");const Te=`

**质量分析结果（请参考以改进）：**
- 整体评分：${Z.overall_score}/100
- 清晰度：${(S=Z.analysis.clarity)==null?void 0:S.score}/100 - ${(j=Z.analysis.clarity)==null?void 0:j.feedback}
- 特定性：${(V=Z.analysis.specificity)==null?void 0:V.score}/100 - ${(Y=Z.analysis.specificity)==null?void 0:Y.feedback}
- 结构：${(X=Z.analysis.structure)==null?void 0:X.score}/100 - ${(h=Z.analysis.structure)==null?void 0:h.feedback}
- 上下文：${(b=Z.analysis.context)==null?void 0:b.score}/100 - ${(w=Z.analysis.context)==null?void 0:w.feedback}
- 完整性：${(D=Z.analysis.completeness)==null?void 0:D.score}/100 - ${(ne=Z.analysis.completeness)==null?void 0:ne.feedback}
${Z.issues&&Z.issues.length>0?`
**发现的问题：**
${Z.issues.map((ze,ve)=>`${ve+1}. ${ze}`).join(`
`)}`:""}

请根据以上分析结果，重点改进低分维度，生成优化后的提示词。`;me[0].content+=Te}else console.log("⏭️ 跳过质量分析，直接优化");t.isOptimizingPrompt=!0,_.setStreamUpdateCallback(ke=>{t.optimizedText+=ke});const te=await _.callAI(me,se,ae,!0);_.clearStreamUpdateCallback(),t.isOptimizingPrompt=!1,console.log("✅ 优化完成");const Oe=performance.now()-s;t.result={originalPrompt:t.draftPrompt,qualityAnalysis:Z||{overall_score:0,analysis:{},issues:[]},optimizedPrompt:te.trim(),metadata:{processingTime:Oe,modelUsed:C.selectedModel||"unknown",timestamp:new Date}},t.languageState="zh",k(t.result),console.log(`✅ 优化完成，总耗时: ${Oe.toFixed(0)}ms`)}catch(re){console.error("快速优化失败:",re),t.error=re.message||"优化失败，请重试",t.result=null,t.isAnalyzing=!1,t.isOptimizingPrompt=!1,k(null)}finally{t.isOptimizing=!1}},E=async s=>{try{const{copyToClipboard:S}=await Pt(async()=>{const{copyToClipboard:j}=await import("./SavePromptDialog.vue_vue_type_script_setup_true_lang-BQATbsYD.js").then(V=>V.a);return{copyToClipboard:j}},__vite__mapDeps([0,1,2]));return await S(s),!0}catch(S){return console.error("复制失败:",S),!1}},M=async s=>{if(!t.result)throw new Error("没有可保存的优化结果");const S="",j=localStorage.getItem("yprompt_token");if(!j)throw new Error("请先登录后才能保存提示词");try{const V=typeof t.result.optimizedPrompt=="string"?t.result.optimizedPrompt:t.result.optimizedPrompt.zh||t.result.optimizedPrompt.en;let Y="";if(s.conversationHistory.trim())try{const D=JSON.parse(s.conversationHistory);Y=JSON.stringify(D)}catch{throw new Error("对话历史JSON格式错误")}const X=o.loadedPromptId;console.log("💾 用户提示词保存:",{promptId:X,isUpdate:!!X,title:s.title});const h={...X?{id:X}:{},title:s.title,description:s.description,final_prompt:V,language:"zh",format:"markdown",prompt_type:"user",tags:s.tags,is_public:s.isPublic?1:0,system_prompt:s.systemPrompt,conversation_history:Y,create_version:!0,change_type:"patch",change_summary:s.description||"优化用户提示词",change_log:"通过用户提示词快速优化功能更新",version_tag:"stable"};console.log("📤 发送保存请求:",{hasId:!!X,createVersion:!0,changeType:"patch"});const w=await(await fetch(`${S}/api/prompts/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`},body:JSON.stringify(h)})).json();if(w.code!==200)throw new Error(w.message||"保存失败");return console.log("✅ 保存成功:",{id:w.data.id,isNew:w.data.is_new,version:w.data.version,message:w.data.message}),w.data.is_new&&(o.setLoadedPromptId(w.data.id),console.log("🆕 新建提示词,设置loadedPromptId:",w.data.id)),{success:!0,id:w.data.id,version:w.data.version,message:w.data.message}}catch(V){throw console.error("❌ 保存到我的提示词失败:",V),V}},p=()=>{t.draftPrompt="",t.systemPrompt="",t.conversationHistory="",t.result=null,t.error=null,t.languageState="zh"},$=()=>{t.result=null,t.error=null,t.languageState="zh",k(null)};return{state:t,hasInput:U,hasResult:A,hasError:B,quickOptimize:P,regenerateOptimization:y,copyToClipboard:E,saveToLibrary:M,reset:p,clearResult:$,setDraftPrompt:s=>{t.draftPrompt=s,$()},setSystemPrompt:s=>{t.systemPrompt=s},setConversationHistory:s=>{t.conversationHistory=s},toggleLanguage:async()=>{if(!t.result||t.isConvertingLanguage)return;const s=typeof t.result.optimizedPrompt=="string"?t.result.optimizedPrompt:t.languageState==="zh"?t.result.optimizedPrompt.zh:t.result.optimizedPrompt.en;if(!s)return;const S=t.languageState==="zh"?"en":"zh";if(typeof t.result.optimizedPrompt!="string"&&(S==="zh"?t.result.optimizedPrompt.zh:t.result.optimizedPrompt.en)){t.languageState=S,k(t.result),console.log(`✅ 切换为${S==="zh"?"中文":"英文"}（从缓存）`);return}t.isConvertingLanguage=!0;try{const V=C.getAvailableProviders().find(D=>D.id===C.selectedProvider),Y=C.selectedModel;if(!V||!Y)throw new Error("请先在顶部选择AI提供商和模型");const X=S==="zh"?"中文":"英文",b=[{role:"system",content:`你是一个专业的AI提示词翻译助手。你的任务是将提示词翻译为${X}，同时保持提示词的专业性、准确性和完整性。

**重要规则**：
1. **必须保留所有原有的格式标记**（如 Markdown 的 #、- 或 XML 的标签）
2. **翻译必须准确传达原意**，特别是技术术语和指令
3. **保持提示词的专业语气和结构**
4. **不要添加任何额外的解释或说明**
5. **直接输出翻译结果，不要包含任何前言或后记**
6. **对于专有名词、技术术语，要使用行业标准译法**`},{role:"user",content:`请将以下AI提示词翻译为${X}：

${s}`}],w=await _.callAI(b,V,Y,!1);if(w&&w.trim()){const D=w.trim();if(typeof t.result.optimizedPrompt=="string"){const ne=t.result.optimizedPrompt;t.result.optimizedPrompt={zh:t.languageState==="zh"?ne:D,en:t.languageState==="en"?ne:D}}else S==="en"?t.result.optimizedPrompt.en=D:t.result.optimizedPrompt.zh=D;t.languageState=S,k(t.result),console.log(`✅ 翻译为${X}（已缓存）`)}else throw new Error("翻译结果为空")}catch(j){throw console.error("语言转换失败:",j),j}finally{t.isConvertingLanguage=!1}}}}function ro(){const C=Xe({messages:[]});return{state:C,addMessage:(A="user")=>{const B={id:`msg-${Date.now()}-${Math.random()}`,role:A,content:"",isEditing:!1};C.messages.push(B)},removeMessage:A=>{const B=C.messages.findIndex(R=>R.id===A);B!==-1&&C.messages.splice(B,1)},updateMessage:(A,B)=>{const R=C.messages.find(y=>y.id===A);R&&(R.content=B)},updateMessageRole:(A,B)=>{const R=C.messages.find(y=>y.id===A);R&&(R.role=B)},startEdit:A=>{C.messages.forEach(B=>{B.isEditing=B.id===A})},cancelEdit:A=>{const B=C.messages.find(R=>R.id===A);B&&(B.isEditing=!1)},formatForAI:()=>C.messages.length===0?"":C.messages.filter(A=>A.content.trim()).map(A=>`${A.role==="ai"?"AI助手":"用户"}: ${A.content}`).join(`

`),reset:()=>{C.messages=[]}}}const ao={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col"},lo={class:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700"},no={class:"flex-1 overflow-y-auto p-4"},io=["value"],uo={class:"flex items-center justify-end gap-3 p-4 border-t border-gray-200 dark:border-gray-700"},co=Ce({__name:"SystemPromptModal",props:{isOpen:{type:Boolean},modelValue:{}},emits:["close","update:modelValue","save"],setup(C,{emit:o}){const l=o,_=()=>{l("save"),l("close")};return(a,f)=>a.isOpen?(n(),i("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:f[3]||(f[3]=at(k=>a.$emit("close"),["self"]))},[e("div",ao,[e("div",lo,[f[4]||(f[4]=e("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"系统提示词设置",-1)),e("button",{onClick:f[0]||(f[0]=k=>a.$emit("close")),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"},[F(d(lt),{class:"w-5 h-5"})])]),e("div",no,[f[5]||(f[5]=e("p",{class:"text-sm text-gray-600 dark:text-gray-400 mb-3"}," 设置系统提示词可以帮助AI更好地理解对话上下文，提供更准确的优化建议。 ",-1)),e("textarea",{value:a.modelValue,onInput:f[1]||(f[1]=k=>a.$emit("update:modelValue",k.target.value)),class:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white",rows:"8",placeholder:"例如：你是一个专业的编程助手，擅长解决代码问题和提供技术建议。"},null,40,io)]),e("div",uo,[e("button",{onClick:f[2]||(f[2]=k=>a.$emit("close")),class:"px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),e("button",{onClick:_,class:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"}," 确定 ")])])])):O("",!0)}}),mo={class:"h-full flex flex-col bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"},po={class:"p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0"},go={class:"flex justify-between items-center"},vo={class:"flex items-center space-x-3"},fo=["title"],yo={class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},ho={key:0,class:"flex-shrink-0"},bo={class:"flex flex-col w-full"},xo={key:0,class:"relative"},wo={class:"relative border border-blue-300 rounded-2xl overflow-hidden bg-white dark:bg-gray-800"},_o={class:"relative"},ko=["value","onInput","onKeydown"],Po={key:0,class:"text-sm opacity-50"},$o={key:1,class:"text-sm whitespace-pre-wrap break-words"},So=["onClick"],Co=["onClick"],zo=["onClick"],Mo=["onClick","title"],Io=["onClick"],Ao=["onClick"],Oo={key:0,class:"flex items-center justify-center h-full text-center py-12"},To={class:"p-3 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 rounded-b-lg"},Lo={class:"flex items-center gap-2 mb-2"},Uo={class:"text-xs text-gray-500 dark:text-gray-400"},Eo={class:"relative border border-gray-300 dark:border-gray-600 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},Ro={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},jo={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent"},Ho={class:"text-xs text-gray-500 dark:text-gray-400 ml-2"},Vo={key:0,class:"ml-2 text-blue-600 dark:text-blue-400"},No={class:"flex gap-2"},Do=["disabled"],Jo=["disabled"],Ke="user_prompt_optimize_data",Bo=Ce({__name:"QuickOptimizeInput",props:{modelValue:{},systemPrompt:{},conversationHistory:{},isOptimizing:{type:Boolean}},emits:["update:modelValue","update:systemPrompt","update:conversationHistory","optimize","restart"],setup(C,{emit:o}){const l=C,_=o,a=ro(),f=g(!1),k=g(l.systemPrompt),t=g("user"),U=g(""),A=()=>{if(l.conversationHistory.trim())try{const r=JSON.parse(l.conversationHistory);if(Array.isArray(r)&&(a.state.messages=r.map((c,s)=>({id:`msg-${Date.now()}-${s}`,role:c.role==="assistant"?"ai":"user",content:c.content,isEditing:!1})),l.modelValue.trim())){a.addMessage("user");const c=a.state.messages[a.state.messages.length-1];a.updateMessage(c.id,l.modelValue)}}catch(r){console.error("解析对话历史JSON失败:",r)}else if(l.modelValue.trim()){a.addMessage("user");const r=a.state.messages[a.state.messages.length-1];a.updateMessage(r.id,l.modelValue)}};Be(()=>{if(localStorage.getItem("yprompt_optimize_loaded_user_prompt")){console.log("🔵 检测到从库加载数据，跳过本地编辑数据加载");return}try{const c=localStorage.getItem(Ke);if(c){const s=JSON.parse(c);s.messages&&(a.state.messages=s.messages),s.systemPrompt&&(k.value=s.systemPrompt,_("update:systemPrompt",s.systemPrompt)),console.log("🟢 已加载上次编辑的数据")}}catch(c){console.error("加载保存数据失败:",c)}});let B=!1;ee(()=>l.conversationHistory,(r,c)=>{!B&&r!==c&&(console.log("🔵 检测到conversationHistory变化，准备加载:",r==null?void 0:r.substring(0,50)),A())}),ee(()=>l.modelValue,(r,c)=>{var s;!B&&r!==c&&(r!=null&&r.trim())&&!((s=l.conversationHistory)!=null&&s.trim())&&(console.log("🔵 检测到draftPrompt变化(无对话历史)，准备加载:",r.substring(0,50)),A())});const R=()=>{try{const r={messages:a.state.messages,systemPrompt:k.value};localStorage.setItem(Ke,JSON.stringify(r))}catch(r){console.error("保存数据失败:",r)}};ee(()=>l.systemPrompt,r=>{k.value=r}),ee(()=>a.state.messages,()=>{if(B=!0,a.state.messages.length>1){const c=a.state.messages.slice(0,-1).filter(s=>s.content.trim()).map(s=>({role:s.role==="ai"?"assistant":"user",content:s.content}));_("update:conversationHistory",JSON.stringify(c,null,2))}else _("update:conversationHistory","");if(a.state.messages.length>0){const r=a.state.messages[a.state.messages.length-1];_("update:modelValue",r.content)}else _("update:modelValue","");R(),setTimeout(()=>{B=!1},0)},{deep:!0});const y=()=>{if(!U.value.trim())return;const r=t.value;a.addMessage(r);const c=a.state.messages[a.state.messages.length-1];a.updateMessage(c.id,U.value),U.value=""},P=r=>{r.key==="Enter"&&r.shiftKey||r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),y())},E=(r,c)=>{r.key==="Enter"&&r.shiftKey||(r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),a.cancelEdit(c),R()),r.key==="Escape"&&a.cancelEdit(c))},M=()=>{a.state.messages.length===0||l.isOptimizing||_("optimize")},p=()=>{confirm("确定要重新开始吗？这将清除所有对话历史、系统提示词和优化结果。")&&(a.reset(),U.value="",k.value="",_("update:modelValue",""),_("update:systemPrompt",""),_("update:conversationHistory",""),_("restart"),localStorage.removeItem(Ke))},$=()=>{_("update:systemPrompt",k.value),R()},I=async r=>{try{await Je(r)}catch(c){console.error("复制失败:",c)}},L=r=>r<=20?"短草稿":r<=100?"中等草稿":r<=300?"长草稿":"超长草稿";return(r,c)=>(n(),i("div",mo,[e("div",po,[e("div",go,[c[6]||(c[6]=e("h2",{class:"font-semibold text-gray-800 dark:text-white"},"构建对话上下文",-1)),e("div",vo,[e("button",{onClick:c[0]||(c[0]=s=>f.value=!0),class:q(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors text-sm",k.value.trim()?"text-green-600 dark:text-green-400":"text-gray-400 dark:text-gray-500"]),title:k.value.trim()?"系统提示词已设置":"设置系统提示词"},[F(d(Qe),{class:"w-4 h-4"}),e("span",null,z(k.value.trim()?"系统提示词已设置":"设置系统提示词"),1)],10,fo),e("button",{onClick:p,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"重新开始"},[F(d(Se),{class:"w-4 h-4"}),c[5]||(c[5]=e("span",null,"重新开始",-1))])])])]),e("div",yo,[(n(!0),i(ue,null,pe(d(a).state.messages,s=>(n(),i("div",{key:s.id,class:q(["flex group",s.role==="user"?"justify-end":"justify-start"])},[e("div",{class:q(["flex flex-col w-full",s.isEditing?"max-w-full sm:max-w-2xl":"max-w-xs lg:max-w-md"])},[e("div",{class:q(["flex gap-2",[s.role==="user"?"flex-row-reverse":"flex-row",s.isEditing&&"items-start"]])},[s.isEditing?O("",!0):(n(),i("div",ho,[e("div",{class:q(["w-8 h-8 rounded-full flex items-center justify-center text-sm",s.role==="user"?"bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300":"bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300"])},z(s.role==="user"?"👤":"🤖"),3)])),e("div",bo,[s.isEditing?(n(),i("div",xo,[e("div",wo,[e("div",_o,[e("textarea",{value:s.content,onInput:S=>d(a).updateMessage(s.id,S.target.value),onKeydown:S=>E(S,s.id),class:"w-full p-4 border-0 resize-none focus:outline-none text-gray-800 dark:text-white bg-white dark:bg-gray-800 min-h-[80px] max-h-[200px] overflow-y-auto text-base",placeholder:"编辑消息内容..."},null,40,ko)])])])):(n(),i("div",{key:1,class:q(["rounded-lg px-4 py-3 transition-all duration-300",[s.role==="user"?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white",s.role==="user"?"ml-auto":"mr-auto"]])},[s.content?(n(),i("div",$o,z(s.content),1)):(n(),i("div",Po,z(s.role==="ai"?"输入AI助手的回复...":"输入你的消息..."),1))],2)),e("div",{class:q(["flex space-x-1 mt-2 transition-opacity duration-200",[s.isEditing?"opacity-100 justify-end":"opacity-0 group-hover:opacity-100 "+(s.role==="user"?"justify-end":"justify-start")]])},[s.isEditing?(n(),i(ue,{key:0},[e("button",{onClick:S=>d(a).cancelEdit(s.id),class:"p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:"取消编辑"},[F(d(lt),{class:"w-3.5 h-3.5"})],8,So),e("button",{onClick:S=>{d(a).cancelEdit(s.id),R()},class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:"保存"},[F(d(gt),{class:"w-3.5 h-3.5"})],8,Co)],64)):(n(),i(ue,{key:1},[e("button",{onClick:S=>d(a).startEdit(s.id),class:"p-1.5 text-gray-500 hover:text-green-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:"编辑消息"},[F(d(At),{class:"w-3.5 h-3.5"})],8,zo),e("button",{onClick:S=>{d(a).updateMessageRole(s.id,s.role==="user"?"ai":"user"),R()},class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:s.role==="user"?"切换为AI助手":"切换为用户"},[F(d(mt),{class:"w-3.5 h-3.5"})],8,Mo),e("button",{onClick:S=>{d(a).removeMessage(s.id),R()},class:"p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:"删除消息"},[F(d(Mt),{class:"w-3.5 h-3.5"})],8,Io),e("button",{onClick:S=>I(s.content),class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",title:"复制内容"},[F(d(pt),{class:"w-3.5 h-3.5"})],8,Ao)],64))],2)])],2)],2)],2))),128)),d(a).state.messages.length===0?(n(),i("div",Oo,[e("div",null,[F(d(Ye),{class:"w-12 h-12 mx-auto mb-3 text-gray-300 dark:text-gray-600"}),c[7]||(c[7]=e("p",{class:"text-sm text-gray-500 dark:text-gray-400 mb-1"},"暂无对话历史",-1)),c[8]||(c[8]=e("p",{class:"text-xs text-gray-400 dark:text-gray-500"},"在下方输入框添加对话消息构建上下文",-1))])])):O("",!0)]),e("div",To,[e("div",Lo,[de(e("select",{"onUpdate:modelValue":c[1]||(c[1]=s=>t.value=s),class:"text-xs px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[...c[9]||(c[9]=[e("option",{value:"user"},"👤 用户",-1),e("option",{value:"ai"},"🤖 AI助手",-1)])],512),[[Ae,t.value]]),e("span",Uo,z(t.value==="user"?"以用户身份发送消息":"以AI助手身份发送消息"),1)]),e("div",Eo,[e("div",Ro,[de(e("textarea",{"onUpdate:modelValue":c[2]||(c[2]=s=>U.value=s),onKeydown:P,placeholder:"输入消息内容 (Shift+Enter换行)",class:"w-full h-full px-4 pt-3 pb-1 border-0 outline-none resize-none text-base overflow-y-auto bg-transparent text-gray-800 dark:text-white",rows:"1"},null,544),[[he,U.value]])]),e("div",jo,[e("div",Ho,[ie(z(U.value.length)+" 字 ",1),U.value.length>0?(n(),i("span",Vo," · "+z(L(U.value.length)),1)):O("",!0)]),e("div",No,[e("button",{onClick:y,disabled:!U.value.trim(),class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center",title:"发送消息到对话历史"},[F(d(Ne),{class:"w-4 h-4"})],8,Do),e("button",{onClick:M,disabled:d(a).state.messages.length===0||r.isOptimizing,class:"px-4 py-1.5 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 dark:disabled:bg-gray-600 text-white text-sm rounded-full transition-colors disabled:cursor-not-allowed",title:"开始优化最后一条消息"},z(r.isOptimizing?"优化中...":"优化"),9,Jo)])])])]),F(co,{"is-open":f.value,modelValue:k.value,"onUpdate:modelValue":c[3]||(c[3]=s=>k.value=s),onClose:c[4]||(c[4]=s=>f.value=!1),onSave:$},null,8,["is-open","modelValue"])]))}}),Fo={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},Go={class:"p-6 space-y-4"},Ko={class:"mt-1 text-xs text-gray-500"},qo={class:"mt-1 text-xs text-gray-500"},Qo={class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},Yo={key:0,class:"flex items-center gap-1 text-green-600 text-xs"},Xo={key:1,class:"flex items-center gap-1 text-gray-400 text-xs"},Wo={class:"mt-1 text-xs text-gray-500"},Zo={key:0,class:"mt-1 text-xs text-red-600"},er={key:1,class:"mt-1 text-xs text-gray-500"},tr={key:2,class:"mt-2 p-3 bg-blue-50 border border-blue-200 rounded text-xs"},sr={class:"flex flex-wrap gap-2 mb-2"},or=["onClick"],rr={class:"flex gap-2"},ar={class:"flex items-center"},lr={class:"p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto text-sm text-gray-600 font-mono"},nr={class:"mt-1 text-xs text-gray-500"},ir={class:"flex justify-end gap-3 p-6 border-t bg-gray-50"},dr=["disabled"],ur={key:0,class:"flex items-center"},cr={key:1},mr=`[
  {
    "role": "user",
    "content": "我牙疼"
  },
  {
    "role": "assistant",
    "content": "牙疼多久了？有什么特别的症状吗？"
  },
  {
    "role": "user",
    "content": "三天了，主要是吃冷热食物时特别疼"
  }
]`,pr=Ce({__name:"SaveUserPromptDialog",props:{isOpen:{type:Boolean},promptContent:{},systemPrompt:{},conversationHistory:{},isSaving:{type:Boolean}},emits:["save","cancel"],setup(C,{emit:o}){const l=C,_=o,a=g({title:"",description:"",systemPrompt:"",conversationHistory:"",tags:["用户提示词","快速优化"],isPublic:!1}),f=g(""),k=g(!1),t=g(""),U=M=>{if(!M.trim())return"";try{const p=JSON.parse(M);if(!Array.isArray(p))return"必须是数组格式";for(let $=0;$<p.length;$++){const I=p[$];if(!I.role||!I.content)return`第${$+1}条消息缺少role或content字段`;if(!["user","assistant","system"].includes(I.role))return`第${$+1}条消息的role必须是user、assistant或system`}return""}catch(p){return p.message||"JSON格式错误"}};ee(()=>a.value.conversationHistory,M=>{t.value=U(M)});const A=()=>{try{const M=JSON.parse(a.value.conversationHistory);a.value.conversationHistory=JSON.stringify(M,null,2),t.value=""}catch{t.value="JSON格式错误，无法格式化"}},B=K(()=>a.value.title.trim()&&l.promptContent&&!t.value);ee(()=>l.isOpen,M=>{if(M){const p=l.promptContent.substring(0,50);a.value.title=`用户提示词 - ${p}${l.promptContent.length>50?"...":""}`,a.value.description="",a.value.systemPrompt=l.systemPrompt||"",a.value.conversationHistory=l.conversationHistory||"",a.value.tags=["用户提示词","快速优化"],a.value.isPublic=!1,t.value="",k.value=!1}});const R=()=>{const M=f.value.trim();M&&!a.value.tags.includes(M)&&a.value.tags.length<10&&(a.value.tags.push(M),f.value="")},y=M=>{a.value.tags=a.value.tags.filter(p=>p!==M)},P=()=>{B.value&&_("save",{title:a.value.title.trim(),description:a.value.description.trim(),tags:a.value.tags,isPublic:a.value.isPublic,systemPrompt:a.value.systemPrompt.trim(),conversationHistory:a.value.conversationHistory.trim()})},E=()=>{_("cancel")};return(M,p)=>M.isOpen?(n(),i("div",Fo,[e("div",{class:"bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",onClick:p[7]||(p[7]=at(()=>{},["stop"]))},[e("div",{class:"flex items-center justify-between p-6 border-b"},[p[9]||(p[9]=e("h2",{class:"text-xl font-semibold text-gray-900"},"保存用户提示词",-1)),e("button",{onClick:E,class:"text-gray-400 hover:text-gray-600"},[...p[8]||(p[8]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",Go,[e("div",null,[p[10]||(p[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[ie(" 标题 "),e("span",{class:"text-red-500"},"*")],-1)),de(e("input",{"onUpdate:modelValue":p[0]||(p[0]=$=>a.value.title=$),type:"text",placeholder:"请输入提示词标题",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",maxlength:"200"},null,512),[[he,a.value.title]]),e("p",Ko,z(a.value.title.length)+"/200",1)]),e("div",null,[p[11]||(p[11]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," 描述 ",-1)),de(e("textarea",{"onUpdate:modelValue":p[1]||(p[1]=$=>a.value.description=$),placeholder:"简短描述这个提示词的用途（可选）",rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",maxlength:"500"},null,512),[[he,a.value.description]]),e("p",qo,z(a.value.description.length)+"/500",1)]),e("div",null,[e("label",Qo,[p[14]||(p[14]=e("span",null,"系统提示词（AI助手角色）",-1)),a.value.systemPrompt.trim()?(n(),i("span",Yo,[...p[12]||(p[12]=[e("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1),ie(" 系统提示词已设置 ",-1)])])):(n(),i("span",Xo,[...p[13]||(p[13]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),ie(" 设置系统提示词（可选） ",-1)])]))]),de(e("textarea",{"onUpdate:modelValue":p[2]||(p[2]=$=>a.value.systemPrompt=$),placeholder:"输入AI助手的系统提示词（可选）",rows:"4",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm",maxlength:"5000"},null,512),[[he,a.value.systemPrompt]]),e("p",Wo,z(a.value.systemPrompt.length)+"/5000 字符",1)]),e("div",null,[p[16]||(p[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[ie(" 对话上下文 "),e("span",{class:"text-xs text-gray-500 ml-2"},"(严格JSON格式，可将来复用)")],-1)),de(e("textarea",{"onUpdate:modelValue":p[3]||(p[3]=$=>a.value.conversationHistory=$),placeholder:'请输入对话历史，格式：[{"role":"user","content":"..."},{"role":"assistant","content":"..."}]',rows:"6",class:q(["w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-xs",{"border-red-500":t.value}])},null,2),[[he,a.value.conversationHistory]]),t.value?(n(),i("p",Zo," ⚠️ JSON格式错误："+z(t.value),1)):(n(),i("p",er,[ie(z(a.value.conversationHistory.length)+"/10000 字符 ",1),a.value.conversationHistory?(n(),i("button",{key:0,onClick:A,class:"ml-2 text-blue-600 hover:text-blue-700 underline"}," 格式化 ")):O("",!0),e("button",{onClick:p[4]||(p[4]=$=>k.value=!k.value),class:"ml-2 text-blue-600 hover:text-blue-700 underline"},z(k.value?"隐藏":"查看")+"示例 ",1)])),k.value?(n(),i("div",tr,[p[15]||(p[15]=e("p",{class:"font-semibold mb-1"},"标准格式示例：",-1)),e("pre",{class:"bg-white p-2 rounded overflow-x-auto"},z(mr))])):O("",!0)]),e("div",null,[p[17]||(p[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," 标签 ",-1)),e("div",sr,[(n(!0),i(ue,null,pe(a.value.tags,$=>(n(),i("span",{key:$,class:"inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"},[ie(z($)+" ",1),e("button",{onClick:I=>y($),class:"ml-2 text-blue-500 hover:text-blue-700"},"×",8,or)]))),128))]),e("div",rr,[de(e("input",{"onUpdate:modelValue":p[5]||(p[5]=$=>f.value=$),type:"text",placeholder:"输入标签后按回车添加",onKeyup:$t(R,["enter"]),class:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,544),[[he,f.value]]),e("button",{onClick:R,class:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"}," 添加 ")])]),e("div",ar,[de(e("input",{"onUpdate:modelValue":p[6]||(p[6]=$=>a.value.isPublic=$),type:"checkbox",id:"isPublic",class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"},null,512),[[nt,a.value.isPublic]]),p[18]||(p[18]=e("label",{for:"isPublic",class:"ml-2 text-sm text-gray-700"}," 公开分享（其他用户可以看到完整的系统提示词和对话记录） ",-1))]),e("div",null,[p[19]||(p[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[ie(" 用户提示词内容 "),e("span",{class:"text-red-500"},"*")],-1)),e("div",lr,z(M.promptContent.slice(0,200))+z(M.promptContent.length>200?"...":""),1),e("p",nr,"共 "+z(M.promptContent.length)+" 个字符",1)])]),e("div",ir,[e("button",{onClick:E,class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"}," 取消 "),e("button",{onClick:P,disabled:!B.value||M.isSaving,class:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[M.isSaving?(n(),i("span",ur,[...p[20]||(p[20]=[e("svg",{class:"w-4 h-4 mr-2 animate-spin",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),ie(" 保存中... ",-1)])])):(n(),i("span",cr,"保存"))],8,dr)])])])):O("",!0)}}),gr={class:"bg-white rounded-lg shadow-sm flex flex-col h-full min-h-0 overflow-hidden"},vr={class:"p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0"},fr={class:"flex items-center space-x-2"},yr={class:"flex items-center cursor-pointer"},hr=["disabled"],br={key:0,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},xr={class:"flex-1 flex items-center justify-center"},wr={class:"text-center text-gray-400"},_r={key:1,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},kr={key:0,class:"flex space-x-2 mb-4 flex-shrink-0"},Pr={key:1,class:"flex-1 flex flex-col min-h-0"},$r={key:0,class:"flex-1 flex flex-col overflow-hidden"},Sr={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},Cr={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},zr={key:1,class:"flex-1 flex flex-col min-h-0"},Mr={class:"flex-1 overflow-y-auto space-y-4 pr-2"},Ir={class:"border border-gray-200 rounded-lg p-4"},Ar={class:"flex items-center justify-between mb-3"},Or={class:"w-full bg-gray-200 rounded-full h-3"},Tr={class:"grid grid-cols-2 gap-3"},Lr={class:"flex items-center justify-between mb-2"},Ur={class:"text-xs font-medium text-gray-700"},Er={class:"text-xs text-gray-600"},Rr={key:0,class:"border border-orange-200 bg-orange-50 rounded-lg p-4"},jr={class:"space-y-2"},Hr={class:"text-orange-600 mr-2 flex-shrink-0"},Vr={class:"flex-1"},Nr={key:2,class:"flex-1 flex flex-col min-h-0"},Dr={key:0,class:"flex-1 flex flex-col overflow-hidden"},Jr={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},Br={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},Fr={key:1,class:"border rounded-lg overflow-hidden flex flex-col flex-1"},Gr={class:"bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 flex items-center justify-between flex-shrink-0"},Kr={class:"flex items-center space-x-2"},qr=["disabled"],Qr={class:"p-3 bg-white flex-1 flex flex-col overflow-hidden"},Yr={key:0,class:"space-y-2 pt-4 flex-shrink-0"},Xr={class:"flex space-x-2"},Wr=["disabled"],Zr=["disabled"],ea={class:"flex"},Ue="yprompt_user_optimize_active_tab",ta=Ce({__name:"UserPromptQuickOptimize",setup(C){const o=oo(),l=it(),_=dt(),a=g("analysis"),f=g(!0),k=g(!1),t=g(!1),U=g(!1),A=g(""),B=g(!1);try{const h=localStorage.getItem(Ue);h&&["analysis","result"].includes(h)&&(a.value=h)}catch(h){console.error("读取activeTab失败:",h)}const R=K(()=>!o.state.isOptimizing&&!o.hasResult.value?0:o.state.enableQualityAnalysis?o.state.isAnalyzing?1:!o.state.isAnalyzing&&(o.state.isOptimizingPrompt||o.hasResult.value)?2:0:o.state.isOptimizingPrompt||o.hasResult.value?2:0),y=()=>{_.isMobile&&(f.value=!0,k.value=!1)},P=()=>{_.isMobile&&(f.value=!1,k.value=!0)},E=async()=>{const h=o.state.enableQualityAnalysis?"analysis":"result";a.value=h,localStorage.setItem(Ue,h),_.isMobile&&(f.value=!1,k.value=!0),await o.quickOptimize()},M=async()=>{a.value="result",localStorage.setItem(Ue,"result"),_.isMobile&&(f.value=!1,k.value=!0),await o.regenerateOptimization()},p=async h=>{await o.copyToClipboard(h)?(t.value=!0,l.success("已复制到剪贴板"),setTimeout(()=>t.value=!1,2e3)):l.error("复制失败")},$=()=>{B.value=!0},I=async h=>{U.value=!0;try{const b=await o.saveToLibrary(h);typeof b=="object"&&b.version?l.success(`提示词已更新至版本 ${b.version}`):l.success("已保存到我的提示词"),B.value=!1}catch(b){l.error(b.message||"保存失败")}finally{U.value=!1}},L=()=>{B.value=!1};ee(()=>o.state.isAnalyzing,(h,b)=>{b&&!h&&o.state.isOptimizingPrompt&&setTimeout(()=>{a.value="result",localStorage.setItem(Ue,"result")},300)}),ee(a,h=>{try{localStorage.setItem(Ue,h)}catch(b){console.error("保存activeTab失败:",b)}});const r=K(()=>{var h;return(h=o.state.result)!=null&&h.optimizedPrompt?typeof o.state.result.optimizedPrompt=="string"?o.state.result.optimizedPrompt:o.state.languageState==="zh"?o.state.result.optimizedPrompt.zh:o.state.result.optimizedPrompt.en:""});ee(r,h=>{h&&(A.value=h)},{immediate:!0});const c=h=>h>=90?"text-green-600":h>=70?"text-blue-600":h>=50?"text-yellow-600":"text-red-600",s=h=>h>=90?"bg-green-500":h>=70?"bg-blue-500":h>=50?"bg-yellow-500":"bg-red-500",S=h=>({clarity:"清晰度",specificity:"特定性",structure:"结构",context:"上下文",completeness:"完整性"})[h]||h,j=async()=>{try{await o.toggleLanguage(),l.success("语言转换成功")}catch(h){l.error(h.message||"语言转换失败")}},V=()=>{o.clearResult(),a.value="analysis",localStorage.setItem(Ue,"analysis"),t.value=!1,A.value="",l.success("已重置所有数据")},Y=()=>{if(!o.state.draftPrompt||!o.hasResult.value||!o.state.result){l.warning("需要先完成优化才能对比");return}const h=typeof o.state.result.optimizedPrompt=="string"?o.state.result.optimizedPrompt:o.state.languageState==="zh"?o.state.result.optimizedPrompt.zh:o.state.result.optimizedPrompt.en,b={mode:"user",systemPrompt:o.state.systemPrompt||"",originalPrompt:o.state.draftPrompt,optimizedPrompt:h,conversationHistory:o.state.conversationHistory||""};localStorage.setItem("yprompt_comparison_data",JSON.stringify(b)),localStorage.setItem("yprompt_trigger_compare","true"),console.log("🔵 准备用户提示词对比:",b)},X=()=>{var h,b,w,D,ne,re;try{const ce=localStorage.getItem("yprompt_optimize_loaded_user_prompt");if(ce){const se=JSON.parse(ce);console.log("🟢 UserPromptQuickOptimize: 从库加载数据:",{draftPrompt:(h=se.draftPrompt)==null?void 0:h.substring(0,50),systemPrompt:(b=se.systemPrompt)==null?void 0:b.substring(0,50),conversationHistory:(w=se.conversationHistory)==null?void 0:w.substring(0,50)}),o.setDraftPrompt(se.draftPrompt||""),o.setSystemPrompt(se.systemPrompt||""),o.setConversationHistory(se.conversationHistory||""),console.log("🟢 已设置到optimizeState:",{draftPrompt:(D=o.state.draftPrompt)==null?void 0:D.substring(0,50),systemPrompt:(ne=o.state.systemPrompt)==null?void 0:ne.substring(0,50),conversationHistory:(re=o.state.conversationHistory)==null?void 0:re.substring(0,50)}),localStorage.removeItem("yprompt_optimize_loaded_user_prompt"),_.isMobile&&(f.value=!0,k.value=!1)}}catch(ce){console.error("加载用户提示词失败:",ce)}};return Be(()=>{X()}),ee(()=>localStorage.getItem("yprompt_optimize_loaded_user_prompt"),h=>{h&&requestAnimationFrame(()=>{X()})},{immediate:!1}),(h,b)=>(n(),i(ue,null,[e("div",{class:q(["h-full min-h-0 overflow-hidden",d(_).isMobile?"flex flex-col":"grid grid-cols-2 gap-4"])},[d(_).isMobile&&!f.value?(n(),i("div",{key:0,onClick:y,class:"bg-white rounded-lg shadow-sm p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors flex-shrink-0 mb-2"},[b[8]||(b[8]=e("h3",{class:"font-semibold text-gray-800"},"构建对话上下文",-1)),F(d(De),{class:"w-5 h-5 text-gray-500"})])):O("",!0),!d(_).isMobile||f.value?(n(),i("div",{key:1,class:q(["flex flex-col min-h-0",d(_).isMobile?"flex-1 mb-2":""])},[F(Bo,{modelValue:d(o).state.draftPrompt,"onUpdate:modelValue":b[0]||(b[0]=w=>d(o).state.draftPrompt=w),"system-prompt":d(o).state.systemPrompt,"onUpdate:systemPrompt":b[1]||(b[1]=w=>d(o).state.systemPrompt=w),"conversation-history":d(o).state.conversationHistory,"onUpdate:conversationHistory":b[2]||(b[2]=w=>d(o).state.conversationHistory=w),"is-optimizing":d(o).state.isOptimizing,onOptimize:E,onRestart:V},null,8,["modelValue","system-prompt","conversation-history","is-optimizing"])],2)):O("",!0),d(_).isMobile&&!k.value?(n(),i("div",{key:2,onClick:P,class:"bg-white rounded-lg shadow-sm p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors flex-shrink-0"},[b[9]||(b[9]=e("h3",{class:"font-semibold text-gray-800"},"优化结果",-1)),F(d(De),{class:"w-5 h-5 text-gray-500"})])):O("",!0),!d(_).isMobile||k.value?(n(),i("div",{key:3,class:q(["flex flex-col min-h-0",d(_).isMobile?"flex-1":""])},[e("div",gr,[e("div",vr,[b[12]||(b[12]=e("h2",{class:"font-semibold text-gray-800"},"优化预览",-1)),e("div",fr,[e("label",yr,[de(e("input",{"onUpdate:modelValue":b[3]||(b[3]=w=>d(o).state.enableQualityAnalysis=w),disabled:d(o).state.isOptimizing,type:"checkbox",class:"sr-only peer"},null,8,hr),[[nt,d(o).state.enableQualityAnalysis]]),b[10]||(b[10]=e("span",{class:"text-sm text-gray-600 mr-2"},"质量分析：",-1)),b[11]||(b[11]=e("div",{class:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"},null,-1))])])]),R.value===0?(n(),i("div",br,[e("div",xr,[e("div",wr,[F(d(Rt),{class:"w-16 h-16 mx-auto mb-4 opacity-50"}),b[13]||(b[13]=e("p",{class:"text-sm"},'输入草稿提示词后点击"开始优化"',-1))])])])):O("",!0),R.value>=1?(n(),i("div",_r,[d(o).state.enableQualityAnalysis?(n(),i("div",kr,[e("button",{onClick:b[4]||(b[4]=w=>a.value="analysis"),class:q(["px-4 py-2 rounded-lg font-medium transition-colors text-sm",a.value==="analysis"?"bg-blue-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])}," 质量分析 ",2),R.value>=2?(n(),i("button",{key:0,onClick:b[5]||(b[5]=w=>a.value="result"),class:q(["px-4 py-2 rounded-lg font-medium transition-colors text-sm",a.value==="result"?"bg-green-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])}," 优化结果 ",2)):O("",!0)])):O("",!0),d(o).state.enableQualityAnalysis&&a.value==="analysis"?(n(),i("div",Pr,[d(o).state.isAnalyzing?(n(),i("div",$r,[e("div",Sr,[e("pre",Cr,z(d(o).state.analysisText||"AI正在分析中..."),1)])])):d(o).hasResult.value?(n(),i("div",zr,[e("div",Mr,[e("div",Ir,[e("div",Ar,[b[14]||(b[14]=e("h4",{class:"text-sm font-medium text-gray-700"},"整体评分",-1)),e("span",{class:q([c(d(o).state.result.qualityAnalysis.overall_score),"text-2xl font-bold"])},z(d(o).state.result.qualityAnalysis.overall_score)+"/100 ",3)]),e("div",Or,[e("div",{class:q([s(d(o).state.result.qualityAnalysis.overall_score),"h-3 rounded-full transition-all duration-500"]),style:ut({width:`${d(o).state.result.qualityAnalysis.overall_score}%`})},null,6)])]),e("div",Tr,[(n(!0),i(ue,null,pe(d(o).state.result.qualityAnalysis.analysis,(w,D)=>(n(),i("div",{key:String(D),class:"border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow"},[e("div",Lr,[e("span",Ur,z(S(String(D))),1),e("span",{class:q(["text-lg font-bold",c((w==null?void 0:w.score)??0)])},z((w==null?void 0:w.score)??0),3)]),e("p",Er,z((w==null?void 0:w.feedback)??""),1)]))),128))]),d(o).state.result.qualityAnalysis.issues&&d(o).state.result.qualityAnalysis.issues.length>0?(n(),i("div",Rr,[b[15]||(b[15]=e("h4",{class:"text-sm font-semibold text-orange-900 mb-3 flex items-center"},[e("svg",{class:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})]),ie(" 发现的具体问题 ")],-1)),e("ul",jr,[(n(!0),i(ue,null,pe(d(o).state.result.qualityAnalysis.issues,(w,D)=>(n(),i("li",{key:D,class:"text-sm text-orange-800 flex items-start"},[e("span",Hr,z(D+1)+".",1),e("span",Vr,z(w),1)]))),128))])])):O("",!0)])])):O("",!0)])):O("",!0),!d(o).state.enableQualityAnalysis||a.value==="result"?(n(),i("div",Nr,[d(o).state.isOptimizingPrompt?(n(),i("div",Dr,[e("div",Jr,[e("pre",Br,z(d(o).state.optimizedText||"AI正在优化中..."),1)])])):d(o).hasResult.value?(n(),i("div",Fr,[e("div",Gr,[b[16]||(b[16]=e("span",null,"最终提示词",-1)),e("div",Kr,[e("button",{onClick:M,disabled:d(o).state.isOptimizing,class:"text-blue-500 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",title:"重新生成"},[F(d(Se),{class:q(["w-4 h-4",d(o).state.isOptimizing&&"animate-spin"])},null,8,["class"])],8,qr),e("button",{onClick:b[6]||(b[6]=w=>p(r.value)),class:"text-blue-500 hover:text-blue-600",title:"复制到剪贴板"},[t.value?(n(),we(d(gt),{key:0,class:"w-4 h-4"})):(n(),we(d(pt),{key:1,class:"w-4 h-4"}))])])]),e("div",Qr,[de(e("textarea",{"onUpdate:modelValue":b[7]||(b[7]=w=>A.value=w),class:"w-full flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none"},null,512),[[he,A.value]]),r.value?(n(),i("div",Yr,[e("div",Xr,[e("button",{onClick:j,disabled:d(o).state.isConvertingLanguage,class:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[d(o).state.isConvertingLanguage?(n(),we(d(Se),{key:0,class:"w-4 h-4 animate-spin"})):O("",!0),e("span",null,z(d(o).state.isConvertingLanguage?"转换中...":d(o).state.languageState==="zh"?"转为英文":"转为中文"),1)],8,Wr),e("button",{onClick:$,disabled:U.value,class:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[U.value?(n(),we(d(Se),{key:0,class:"w-4 h-4 animate-spin"})):O("",!0),e("span",null,z(U.value?"保存中...":"保存到数据库"),1)],8,Zr)]),e("div",ea,[e("button",{onClick:Y,class:"w-full flex items-center justify-center space-x-1 px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[F(d(mt),{class:"w-4 h-4"}),b[17]||(b[17]=e("span",null,"对比优化效果",-1))])])])):O("",!0)])])):O("",!0)])):O("",!0)])):O("",!0)])],2)):O("",!0)],2),F(pr,{"is-open":B.value,"prompt-content":r.value,"system-prompt":d(o).state.systemPrompt,"conversation-history":d(o).state.conversationHistory,"is-saving":U.value,onSave:I,onCancel:L},null,8,["is-open","prompt-content","system-prompt","conversation-history","is-saving"])],64))}}),sa={class:"bg-white rounded-lg shadow-sm flex flex-col h-full p-4 min-h-0 overflow-hidden"},oa={class:"mb-4 flex-shrink-0 flex items-center justify-between"},ra={class:"flex-1 flex flex-col min-h-0"},aa={class:"flex items-center justify-between text-xs text-gray-500 mt-2 flex-shrink-0"},la={class:"mt-4 flex justify-end flex-shrink-0"},na=["disabled"],ia={key:0,class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},da={class:"bg-white rounded-lg shadow-sm flex flex-col h-full min-h-0 overflow-hidden"},ua={class:"p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0"},ca={class:"flex items-center space-x-3"},ma={class:"flex items-center space-x-2"},pa={class:"flex items-center cursor-pointer"},ga=["checked"],va={class:"text-sm text-gray-600"},fa={key:0,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},ya={key:1,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},ha={key:0,class:"flex-1 flex flex-col min-h-0"},ba={key:0,class:"flex-1 flex flex-col overflow-hidden"},xa={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},wa={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},_a={key:1,class:"flex-1 flex flex-col min-h-0"},ka={class:"flex-1 overflow-y-auto space-y-4 pr-2"},Pa={class:"border border-gray-200 rounded-lg p-4"},$a={class:"flex items-center justify-between mb-3"},Sa={class:"w-full bg-gray-200 rounded-full h-3"},Ca={class:"grid grid-cols-2 gap-3"},za={class:"flex items-center justify-between mb-2"},Ma={class:"text-xs font-medium text-gray-700"},Ia={class:"text-xs text-gray-600"},Aa={key:0,class:"border border-orange-200 bg-orange-50 rounded-lg p-4"},Oa={class:"space-y-2"},Ta={class:"text-orange-600 mr-2 flex-shrink-0"},La={class:"flex-1"},Ua={key:0,class:"pt-4 mt-4 border-t border-gray-100 flex justify-end flex-shrink-0"},Ea=["disabled"],Ra={key:0,class:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},qe="yprompt_optimize_cache",ja="yprompt_optimize_active_mode",Ha=Ce({__name:"OptimizeSectionRedesign",props:{activeMode:{default:"system"}},emits:["update:active-mode"],setup(C,{emit:o}){const l=C,_=o,a=We(),f=je(),k=dt(),t=it(),U=Fe.getInstance(),A=Et.getInstance(),B="",R=g(!0),y=g(!0),P=g(!1),E=()=>{k.isMobile&&(y.value?(y.value=!1,P.value=!0):(y.value=!0,P.value=!1))},M=()=>{k.isMobile&&(P.value?(P.value=!1,y.value=!0):(P.value=!0,y.value=!1))},p=K({get:()=>l.activeMode,set:v=>{_("update:active-mode",v);try{localStorage.setItem(ja,v)}catch(x){console.error("保存activeMode失败:",x)}}}),$=()=>{try{const v=localStorage.getItem(qe);return v?JSON.parse(v):null}catch{return null}},I=v=>{try{const G={...$()||{},...v};localStorage.setItem(qe,JSON.stringify(G))}catch(x){console.error("Failed to save optimize cache:",x)}},L=()=>{try{localStorage.removeItem(qe)}catch(v){console.error("Failed to clear optimize cache:",v)}},r=$(),c=g((r==null?void 0:r.originalSystemPrompt)||"");g("");const s=g((r==null?void 0:r.optimizedSystemPrompt)||""),S=g(""),j=g((r==null?void 0:r.systemSuggestions)||[]);g([]);const V=g(!1);g(!1);const Y=g((r==null?void 0:r.systemAnalysisResult)||null),X=g(null),h=g(!1),b=g((r==null?void 0:r.analysisStreamingText)||""),w=g((r==null?void 0:r.systemOptimizationStage)||0);g(0);const D=g((r==null?void 0:r.activeOptimizeTab)||"analysis"),ne=g(!1),re=g(!1),ce=g(!1),se=g(!1),ae=g((r==null?void 0:r.formatState)||"markdown"),le=g((r==null?void 0:r.languageState)||"zh");ct();const be=g(!1),xe=g(!1),ge=g((r==null?void 0:r.currentPromptId)||null),_e=g((r==null?void 0:r.currentPromptTitle)||""),N=K(()=>j.value.map(v=>v.description)),J=K({get:()=>typeof s.value=="string"?s.value:le.value==="zh"?s.value.zh:s.value.en,set:v=>{typeof s.value=="string"?s.value=v:le.value==="zh"?s.value.zh=v:s.value.en=v}}),me=g(`你是一个专业的助手。

主要职责：
1. 仔细分析用户的需求和问题
2. 提供准确、实用的解决方案
3. 确保解释清晰易懂

请始终保持专业、友好、耐心的语调，确保用户能够获得满意的帮助。`);g("你是一个专业的编程助手，擅长分析代码问题和提供解决方案。"),g([{role:"user",content:"我在Python中遇到了一个列表去重的问题。我有一个列表 `[1, 2, 2, 3, 4, 3, 5]`，想要得到去重后的结果 `[1, 2, 3, 4, 5]`，但想保持原来的顺序。请问有什么好的方法吗？"},{role:"assistant",content:`这是一个很好的问题！Python中有几种方法可以实现去重并保持顺序：

1. 使用dict.fromkeys()（Python 3.7+最简单）
2. 使用OrderedDict
3. 使用列表推导式

你想了解哪种方法的具体实现吗？`}]),K(()=>a.optimizedPrompts),K(()=>a.testResults),K(()=>a.isTesting);const Z=a.setOptimizedPrompts;a.setTestResults;const te=K({get:()=>a.systemPrompt||me.value,set:v=>{a.systemPrompt=v}}),Oe=async(v,x)=>{if(!(!v||!v.trim())){h.value=!0;try{const G=f.getAvailableProviders().find(Ee=>Ee.id===f.selectedProvider),Q=f.selectedModel;if(!G||!Q)throw new Error("请先选择AI提供商和模型");const oe=St.getQualityAnalysisSystemPrompt(),T=`请分析以下系统提示词的质量：

提示词内容：
${v}

请严格按照指定的JSON格式返回分析结果。`;b.value="";let W="";U.setStreamUpdateCallback(Ee=>{W+=Ee,b.value=W});const Le=await U.callAI([{role:"system",content:oe},{role:"user",content:T}],G,Q,!0);let $e;try{$e=vt(Le),console.log("✅ Parsed analysis result:",$e),console.log("📊 Issues found:",$e.issues),console.log("📝 Suggestions:",$e.suggestions)}catch(Ee){console.error("❌ Failed to parse analysis response:",Ee),console.error("📄 Original content:",Le),$e={overall_score:75,analysis:{role:{score:75,status:"good",feedback:"角色定义基本完善"},task:{score:75,status:"good",feedback:"任务描述较为清晰"},format:{score:65,status:"needs_improvement",feedback:"输出格式可以更详细"},constraints:{score:70,status:"needs_improvement",feedback:"约束条件可以更明确"},example:{score:60,status:"needs_improvement",feedback:"建议添加示例说明"},language:{score:80,status:"good",feedback:"语言表达清晰"}},issues:["解析失败，无法获取详细问题分析"]}}return x==="system"&&(Y.value=$e,I({systemAnalysisResult:$e,analysisStreamingText:W})),$e}catch(G){console.error("Analysis failed:",G);const Q={overall_score:70,analysis:{role:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},task:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},format:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},constraints:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},example:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},language:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"}},suggestions:["分析失败，请检查网络连接或重试"]};return Y.value=Q,Q}finally{h.value=!1}}},ke=()=>{confirm("确定要重新开始吗？这将清除所有输入和优化结果。")&&(te.value="",c.value="",Y.value=null,s.value="",j.value=[],w.value=0,V.value=!1,b.value="",D.value="analysis",ae.value="markdown",le.value="zh",se.value=!1,ce.value=!1,ne.value=!1,re.value=!1,ge.value=null,_e.value="",L(),t.success("已重置所有数据"))},Te=async()=>{if(!(!(te!=null&&te.value)||!te.value.trim())){k.isMobile&&(y.value=!1,P.value=!0),c.value=te.value,V.value=!0,w.value=0,b.value="",ae.value="markdown",le.value="zh",I({originalSystemPrompt:te.value,formatState:"markdown",languageState:"zh"});try{const v=f.getAvailableProviders().find(T=>T.id===f.selectedProvider),x=f.selectedModel;if(!v||!x)throw new Error("请先选择AI提供商和模型");w.value=1,I({systemOptimizationStage:1}),h.value=!0,await Oe(te.value,"system"),h.value=!1,w.value=2,I({systemOptimizationStage:2});let G="",Q=!1;const oe=await A.getOptimizationAdvice(te.value,"system",x,"zh",[],v,T=>{G+=T,!Q&&T.trim()&&(Q=!0,j.value=[{id:"temp",type:"clarity",description:"正在生成...",priority:"medium",example:""}]);const W=G.split(`
`).map(ye=>ye.replace(/^[*-]\s*/,"").trim()).filter(Boolean);W.length>0&&(j.value=W.map((ye,Le)=>({id:`sys_${Le}`,type:"clarity",description:ye,priority:"medium",example:""})))});if(j.value=oe.map((T,W)=>({id:`sys_${W}`,type:"clarity",description:T,priority:"medium",example:""})),I({systemSuggestions:j.value}),R.value){w.value=3,I({systemOptimizationStage:3}),ae.value="markdown",le.value="zh",I({formatState:"markdown",languageState:"zh"});let T=!1;s.value=await A.applyOptimizationAdvice(te.value,oe,"system",x,"zh",[],v,W=>{!T&&W.trim()&&(T=!0,s.value="正在生成..."),T&&(s.value==="正在生成..."?s.value=W:s.value+=W)}),Z(s.value,S.value),I({optimizedSystemPrompt:s.value,activeOptimizeTab:"final"}),D.value="final"}}catch(v){console.error("System optimization failed:",v),j.value=[{id:"sys_fallback",type:"clarity",description:"增加更清晰的角色定义和职责说明",priority:"high",example:"优化了表达方式"}]}finally{V.value=!1}}},ze=async()=>{if(c.value){V.value=!0,w.value=2;try{const v=f.getAvailableProviders().find(T=>T.id===f.selectedProvider),x=f.selectedModel;if(!v||!x)throw new Error("请先选择AI提供商和模型");let G="",Q=!1;const oe=await A.getOptimizationAdvice(c.value,"system",x,"zh",[],v,T=>{G+=T,!Q&&T.trim()&&(Q=!0,j.value=[{id:"temp",type:"clarity",description:"正在生成...",priority:"medium",example:""}]);const W=G.split(`
`).map(ye=>ye.replace(/^[*-]\s*/,"").trim()).filter(Boolean);W.length>0&&(j.value=W.map((ye,Le)=>({id:`sys_${Le}`,type:"clarity",description:ye,priority:"medium",example:""})))});j.value=oe.map((T,W)=>({id:`sys_${W}`,type:"clarity",description:T,priority:"medium",example:""}))}catch(v){console.error("Failed to generate advice:",v)}finally{V.value=!1}}};ee(()=>w.value,v=>{v>=1&&v<2&&(D.value="analysis")}),ee(()=>j.value,v=>{v&&v.length>0&&w.value>=2&&setTimeout(()=>{D.value="advice"},500)}),ee(()=>s.value,v=>{v&&w.value>=3&&setTimeout(()=>{D.value="final"},500)});const ve=async()=>{w.value=2,await Te()},He=async()=>{const v=N.value.join(`
`);try{await Je(v),ne.value=!0,setTimeout(()=>{ne.value=!1},2e3)}catch(x){console.error("Failed to copy:",x)}},H=()=>{j.value.push({id:`sys_${Date.now()}`,type:"clarity",description:"新建议",priority:"medium",example:""})},u=v=>{j.value.splice(v,1)},m=(v,x)=>{j.value[v]&&(j.value[v].description=x)},fe=async()=>{w.value=3,V.value=!0,ae.value="markdown",le.value="zh",I({formatState:"markdown",languageState:"zh"});try{const v=f.getAvailableProviders().find(Q=>Q.id===f.selectedProvider),x=f.selectedModel;if(!v||!x)throw new Error("请先选择AI提供商和模型");let G=!1;s.value=await A.applyOptimizationAdvice(c.value,N.value,"system",x,"zh",[],v,Q=>{!G&&Q.trim()&&(G=!0,s.value="正在生成..."),G&&(s.value==="正在生成..."?s.value=Q:s.value+=Q)}),Z(s.value,S.value)}catch(v){console.error("Failed to generate optimized prompt:",v),s.value=c.value+`

（已应用优化建议）`}finally{V.value=!1}},Me=async()=>{const v=ae.value,x=le.value;await fe(),v==="xml"&&s.value&&await Pe(),x==="en"&&s.value&&await Ze()},Ie=async()=>{try{await Je(s.value),re.value=!0,setTimeout(()=>{re.value=!1},2e3)}catch(v){console.error("Failed to copy:",v)}},Pe=async()=>{if(!s.value||ce.value||se.value)return;const v=f.getAvailableProviders().find(G=>G.id===f.selectedProvider),x=f.selectedModel;if(!v||!x){t.error("请先选择AI提供商和模型");return}try{ce.value=!0;const G=ae.value==="markdown"?"XML":"Markdown",Q=ae.value==="markdown"?"Markdown":"XML",oe=await U.callAI([{role:"system",content:`你是一个专业的提示词格式转换助手。你的任务是将提示词从${Q}格式转换为${G}格式，保持内容完全一致，只改变格式样式。

**重要规则**：
1. **绝对不能添加、删除或修改任何实质性内容**
2. **只能改变格式标记（如 Markdown 的 # 标题改为 XML 的 <section> 标签）**
3. **必须保留原文的所有信息和语义**
4. **不要添加任何解释、说明或额外的文字**
5. **直接输出转换后的结果，不要包含任何前言或后记**

${G==="XML"?`使用标准 XML 格式组织内容，遵循以下结构规范：
- 使用 <prompt> 作为根标签
- 使用 <section title="标题名"> 标记各个章节（注意：必须使用 title 属性，不要使用 name 或其他属性）
- 对于 Role 章节，格式为：<section title="Role">角色描述内容</section>
- 使用 <item> 标记列表项
- 使用 <rule> 标记规则条目
- 使用 <example> 标记示例

示例结构：
<prompt>
  <section title="Role">角色描述</section>
  <section title="Profile">
    <item>Author: xxx</item>
  </section>
</prompt>`:"使用 Markdown 语法：# 标题，- 列表，**粗体** 等组织内容。"}`},{role:"user",content:`请将以下提示词从${Q}格式转换为${G}格式：

${s.value}`}],v,x,!1);if(oe&&oe.trim()){const T=st(oe);s.value=T,ae.value=ae.value==="markdown"?"xml":"markdown",I({optimizedSystemPrompt:T,formatState:ae.value}),t.success(`已转换为${G}格式`)}else t.error("格式转换失败：返回内容为空")}catch(G){console.error("Format conversion failed:",G),t.error("格式转换失败，请重试")}finally{ce.value=!1}},Ze=async()=>{const v=typeof s.value=="string"?s.value:le.value==="zh"?s.value.zh:s.value.en;if(!v||ce.value||se.value)return;const x=f.getAvailableProviders().find(oe=>oe.id===f.selectedProvider),G=f.selectedModel;if(!x||!G){t.error("请先选择AI提供商和模型");return}const Q=le.value==="zh"?"en":"zh";if(typeof s.value!="string"&&(Q==="zh"?s.value.zh:s.value.en)){le.value=Q,I({languageState:Q}),t.success(`已切换为${Q==="zh"?"中文":"英文"}版本`);return}try{se.value=!0;const oe=Q==="zh"?"中文":"英文",T=await U.callAI([{role:"system",content:`你是一个专业的AI提示词翻译助手。你的任务是将提示词翻译为${oe}，同时保持提示词的专业性、准确性和完整性。

**重要规则**：
1. **必须保留所有原有的格式标记**（如 Markdown 的 #、- 或 XML 的标签）
2. **翻译必须准确传达原意**，特别是技术术语和指令
3. **保持提示词的专业语气和结构**
4. **不要添加任何额外的解释或说明**
5. **直接输出翻译结果，不要包含任何前言或后记**
6. **对于专有名词、技术术语，要使用行业标准译法**`},{role:"user",content:`请将以下AI提示词翻译为${oe}：

${v}`}],x,G,!1);if(T&&T.trim()){const W=st(T);if(typeof s.value=="string"){const ye=s.value;s.value={zh:le.value==="zh"?ye:W,en:le.value==="en"?ye:W}}else Q==="en"?s.value.en=W:s.value.zh=W;le.value=Q,I({optimizedSystemPrompt:s.value,languageState:Q}),t.success(`已翻译为${oe}版本`)}else t.error("语言转换失败：返回内容为空")}catch(oe){console.error("Language conversion failed:",oe),t.error("语言转换失败，请重试")}finally{se.value=!1}},ft=()=>{var v;if(!((v=s.value)!=null&&v.trim())){t.warning("没有可保存的优化结果");return}xe.value=!0},yt=async v=>{try{be.value=!0;const x=localStorage.getItem("yprompt_token");if(!x){t.error("请先登录");return}const G=a.loadedPromptId||ge.value;console.log("💾 系统提示词保存:",{promptId:G,isUpdate:!!G,title:v.title,loadedPromptId:a.loadedPromptId,currentPromptId:ge.value});const Q={...G?{id:G}:{},title:v.title,description:v.description,final_prompt:s.value,language:"zh",format:"markdown",prompt_type:v.promptType,tags:v.tags,is_public:v.isPublic?1:0,create_version:!0,change_type:"patch",change_summary:v.description||"优化系统提示词",change_log:"通过系统提示词优化功能更新",version_tag:"stable"};console.log("📤 发送保存请求:",{hasId:!!G,createVersion:!0,changeType:"patch"});const T=await(await fetch(`${B}/api/prompts/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify(Q)})).json();if(T.code===200)console.log("✅ 保存成功:",{id:T.data.id,isNew:T.data.is_new,version:T.data.version,message:T.data.message}),ge.value=T.data.id,_e.value=v.title,T.data.is_new&&(a.setLoadedPromptId(T.data.id),console.log("🆕 新建提示词,设置loadedPromptId:",T.data.id)),I({currentPromptId:T.data.id,currentPromptTitle:v.title}),t.success(T.data.message||"保存成功"),xe.value=!1;else throw new Error(T.message||"保存失败")}catch(x){console.error("保存提示词失败:",x),t.error(`保存失败: ${x.message}`)}finally{be.value=!1}},ht=()=>{if(!c.value||!s.value){t.warning("需要先完成优化才能对比");return}_("update:active-mode","compare");const v={mode:"system",originalPrompt:c.value,optimizedPrompt:typeof s.value=="string"?s.value:le.value==="zh"?s.value.zh:s.value.en};localStorage.setItem("yprompt_comparison_data",JSON.stringify(v)),console.log("🔵 准备系统提示词对比:",v)},et=v=>v>=80?"text-green-600":v>=60?"text-yellow-600":"text-red-600",bt=v=>v>=80?"bg-green-500":v>=60?"bg-yellow-500":"bg-red-500",xt=v=>({role:"角色定义",task:"任务描述",format:"输出格式",constraints:"约束条件",example:"示例质量",language:"语言表达"})[v]||v;return(v,x)=>{var G,Q,oe;return p.value==="user"?(n(),we(ta,{key:0})):p.value==="compare"?(n(),we(so,{key:1})):p.value==="system"?(n(),i("div",{key:2,class:q(["h-full min-h-0 overflow-hidden",d(k).isMobile?"flex flex-col":"grid grid-cols-2 gap-4"])},[d(k).isMobile&&!y.value?(n(),i("div",{key:0,onClick:E,class:"bg-white rounded-lg shadow-sm p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors flex-shrink-0 mb-2"},[x[7]||(x[7]=e("h3",{class:"font-semibold text-gray-800"},"系统提示词输入",-1)),F(d(De),{class:"w-5 h-5 text-gray-500"})])):O("",!0),!d(k).isMobile||y.value?(n(),i("div",{key:1,class:q(["flex flex-col min-h-0",d(k).isMobile?"flex-1 mb-2":""])},[e("div",sa,[e("div",oa,[x[9]||(x[9]=e("div",null,[e("h3",{class:"text-base font-semibold text-gray-800 mb-2"},"系统提示词")],-1)),e("button",{onClick:ke,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"重新开始"},[F(d(Se),{class:"w-4 h-4"}),x[8]||(x[8]=e("span",null,"重新开始",-1))])]),e("div",ra,[de(e("textarea",{"onUpdate:modelValue":x[0]||(x[0]=T=>te.value=T),placeholder:`在此输入系统提示词...

例如：你是一个专业的英语老师`,class:"w-full h-full p-3 border border-gray-300 rounded-lg focus:outline-none resize-none text-sm"},null,512),[[he,te.value]]),e("div",aa,[e("span",null,z(((G=te.value)==null?void 0:G.length)||0)+" 字符",1),e("span",null,z(Math.ceil((((Q=te.value)==null?void 0:Q.length)||0)/4))+" tokens",1)])]),e("div",la,[e("button",{onClick:Te,disabled:!((oe=te.value)!=null&&oe.trim())||V.value,class:"px-6 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"},[V.value?(n(),i("svg",ia,[...x[10]||(x[10]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):O("",!0),e("span",null,z(V.value?"分析优化中...":"分析并优化"),1)],8,na)])])],2)):O("",!0),d(k).isMobile&&!P.value?(n(),i("div",{key:2,onClick:M,class:"bg-white rounded-lg shadow-sm p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors flex-shrink-0"},[x[11]||(x[11]=e("h3",{class:"font-semibold text-gray-800"},"优化预览",-1)),F(d(De),{class:"w-5 h-5 text-gray-500"})])):O("",!0),!d(k).isMobile||P.value?(n(),i("div",{key:3,class:q(["flex flex-col min-h-0",d(k).isMobile?"flex-1 mb-2":""])},[e("div",da,[e("div",ua,[x[13]||(x[13]=e("h2",{class:"font-semibold text-gray-800"},"优化预览",-1)),e("div",ca,[e("div",ma,[e("label",pa,[e("input",{checked:R.value,onChange:x[1]||(x[1]=T=>R.value=!R.value),type:"checkbox",class:"sr-only peer"},null,40,ga),e("span",va,z(R.value?"自动：":"手动："),1),x[12]||(x[12]=e("div",{class:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"},null,-1))])])])]),w.value===0?(n(),i("div",fa,[F(Ot)])):O("",!0),w.value>=1?(n(),i("div",ya,[F(Tt,{"is-generating":V.value},{default:Ve(()=>[F(Ge,{"is-active":D.value==="analysis","active-class":"bg-orange-500 text-white",onClick:x[2]||(x[2]=T=>D.value="analysis")},{default:Ve(()=>[...x[14]||(x[14]=[ie(" 质量分析 ",-1)])]),_:1},8,["is-active"]),w.value>=2?(n(),we(Ge,{key:0,"is-active":D.value==="advice","active-class":"bg-yellow-500 text-white",onClick:x[3]||(x[3]=T=>D.value="advice")},{default:Ve(()=>[...x[15]||(x[15]=[ie(" 优化建议 ",-1)])]),_:1},8,["is-active"])):O("",!0),w.value>=3?(n(),we(Ge,{key:1,"is-active":D.value==="final","active-class":"bg-blue-500 text-white",onClick:x[4]||(x[4]=T=>D.value="final")},{default:Ve(()=>[...x[16]||(x[16]=[ie(" 优化结果 ",-1)])]),_:1},8,["is-active"])):O("",!0)]),_:1},8,["is-generating"]),D.value==="analysis"?(n(),i("div",ha,[h.value?(n(),i("div",ba,[e("div",xa,[e("pre",wa,z(b.value||"AI正在分析中..."),1)])])):Y.value?(n(),i("div",_a,[e("div",ka,[e("div",Pa,[e("div",$a,[x[17]||(x[17]=e("h4",{class:"text-sm font-medium text-gray-700"},"整体评分",-1)),e("span",{class:q([et(Y.value.overall_score),"text-2xl font-bold"])},z(Y.value.overall_score)+"/100 ",3)]),e("div",Sa,[e("div",{class:q([bt(Y.value.overall_score),"h-3 rounded-full transition-all duration-500"]),style:ut({width:`${Y.value.overall_score}%`})},null,6)])]),e("div",Ca,[(n(!0),i(ue,null,pe(Y.value.analysis,(T,W)=>(n(),i("div",{key:W,class:"border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow"},[e("div",za,[e("span",Ma,z(xt(W)),1),e("span",{class:q(["text-lg font-bold",et(T.score)])},z(T.score),3)]),e("p",Ia,z(T.feedback),1)]))),128))]),Y.value.issues&&Y.value.issues.length>0?(n(),i("div",Aa,[x[18]||(x[18]=e("h4",{class:"text-sm font-semibold text-orange-900 mb-3 flex items-center"},[e("svg",{class:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})]),ie(" 发现的具体问题 ")],-1)),e("ul",Oa,[(n(!0),i(ue,null,pe(Y.value.issues,(T,W)=>(n(),i("li",{key:W,class:"text-sm text-orange-800 flex items-start"},[e("span",Ta,z(W+1)+".",1),e("span",La,z(T),1)]))),128))])])):O("",!0)]),!R.value&&w.value===1?(n(),i("div",Ua,[e("button",{onClick:ze,disabled:V.value,class:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"},[V.value?(n(),i("svg",Ra,[...x[19]||(x[19]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):O("",!0),e("span",null,z(V.value?"生成中...":"生成优化建议"),1)],8,Ea)])):O("",!0)])):O("",!0)])):O("",!0),D.value==="advice"?(n(),we(Lt,{key:1,advice:N.value,"is-mobile":!1,"is-auto-mode":R.value,"is-executing":V.value,"is-generating":V.value,"current-execution-step":w.value===3?"final":"advice","is-copied":ne.value,onRegenerate:ve,onCopy:He,onAddItem:H,onRemoveItem:u,onUpdateItem:m,onExecuteFinal:fe},null,8,["advice","is-auto-mode","is-executing","is-generating","current-execution-step","is-copied"])):O("",!0),D.value==="final"?(n(),we(Ut,{key:2,"generated-prompt":J.value,"onUpdate:generatedPrompt":x[5]||(x[5]=T=>J.value=T),"is-executing":!1,"is-generating":V.value,"current-execution-step":null,"is-copied":re.value,"is-converting-format":ce.value,"is-converting-language":se.value,"is-saving":be.value,"format-state":ae.value,"language-state":le.value,"show-compare-button":!0,onRegenerate:Me,onCopy:Ie,onToggleFormat:Pe,onToggleLanguage:Ze,onSavePrompt:ft,onCompare:ht},null,8,["generated-prompt","is-generating","is-copied","is-converting-format","is-converting-language","is-saving","format-state","language-state"])):O("",!0)])):O("",!0)])],2)):O("",!0),F(It,{"is-open":xe.value,"prompt-content":J.value,"is-saving":be.value,onSave:yt,onCancel:x[6]||(x[6]=T=>xe.value=!1)},null,8,["is-open","prompt-content","is-saving"])],2)):O("",!0)}}}),Va={class:"diff-viewer"},Na={class:"flex items-center justify-between mb-4"},Da={class:"flex items-center space-x-2"},Ja={class:"text-sm text-gray-600"},Ba={class:"flex space-x-4 mb-4 border-b"},Fa={class:"bg-white border rounded-lg overflow-hidden"},Ga={class:"max-h-96 overflow-y-auto"},Ka={class:"font-mono text-sm"},qa={class:"flex items-start"},Qa={class:"inline-block w-8 text-xs text-gray-400 select-none"},Ya={class:"flex-1 whitespace-pre-wrap"},Xa={class:"mt-4 flex items-center justify-between text-sm text-gray-600"},Wa={class:"flex items-center space-x-4"},Za={class:"flex items-center"},el={class:"flex items-center"},tl={class:"flex items-center"},sl=Ce({__name:"DiffViewer",props:{leftContent:{},rightContent:{},leftLabel:{default:"原始版本"},rightLabel:{default:"当前版本"}},emits:["close"],setup(C,{emit:o}){const l=C,_=g("system"),a=(y,P)=>{const E=y.split(`
`),M=P.split(`
`),p=[];let $=0,I=0;for(;$<E.length||I<M.length;){const L=E[$],r=M[I];$>=E.length?(p.push({type:"insert",content:r,rightLine:I+1}),I++):I>=M.length?(p.push({type:"delete",content:L,leftLine:$+1}),$++):L===r?(p.push({type:"equal",content:L,leftLine:$+1,rightLine:I+1}),$++,I++):(p.push({type:"delete",content:L,leftLine:$+1}),p.push({type:"insert",content:r,rightLine:I+1}),$++,I++)}return p},f=K(()=>({left:l.leftContent,right:l.rightContent})),k=K(()=>a(f.value.left,f.value.right)),t=K(()=>{let y=0,P=0,E=0;return k.value.forEach(M=>{M.type==="insert"?y++:M.type==="delete"?P++:M.type==="modify"&&E++}),{additions:y,deletions:P,modifications:E}}),U=y=>{switch(y.type){case"insert":return"bg-green-50 border-l-4 border-green-400";case"delete":return"bg-red-50 border-l-4 border-red-400";case"modify":return"bg-blue-50 border-l-4 border-blue-400";default:return"bg-gray-50"}},A=(y,P)=>y.type==="equal"?`${y.leftLine||""}`:y.type==="insert"?y.rightLine?`${y.rightLine}`:"":y.type==="delete"&&y.leftLine?`${y.leftLine}`:"",B=y=>y.content,R=()=>{const y=k.value.map(P=>`${P.type==="insert"?"+":P.type==="delete"?"-":" "}${P.content}`).join(`
`);Je(y).then(()=>{console.log("Diff copied to clipboard")})};return ee([()=>l.leftContent,()=>l.rightContent],()=>{},{immediate:!0}),(y,P)=>(n(),i("div",Va,[e("div",Na,[P[4]||(P[4]=e("h3",{class:"text-lg font-semibold text-gray-800"},"版本对比",-1)),e("div",Da,[e("span",Ja,z(y.leftLabel)+" vs "+z(y.rightLabel),1),e("button",{onClick:P[0]||(P[0]=E=>y.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[...P[3]||(P[3]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])]),e("div",Ba,[e("button",{onClick:P[1]||(P[1]=E=>_.value="system"),class:q(["px-4 py-2 text-sm font-medium transition-colors border-b-2",_.value==="system"?"text-blue-600 border-blue-600":"text-gray-500 border-transparent hover:text-gray-700"])}," 系统提示词 ",2),e("button",{onClick:P[2]||(P[2]=E=>_.value="user"),class:q(["px-4 py-2 text-sm font-medium transition-colors border-b-2",_.value==="user"?"text-blue-600 border-blue-600":"text-gray-500 border-transparent hover:text-gray-700"])}," 用户提示词 ",2)]),e("div",Fa,[e("div",Ga,[e("div",Ka,[(n(!0),i(ue,null,pe(k.value,(E,M)=>(n(),i("div",{key:M,class:q([U(E),"px-4 py-1 border-b border-gray-100 last:border-b-0"])},[e("div",qa,[e("span",Qa,z(A(E)),1),e("span",Ya,z(B(E)),1)])],2))),128))])])]),e("div",Xa,[e("div",Wa,[e("span",Za,[P[5]||(P[5]=e("span",{class:"w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"},null,-1)),ie(" 新增 "+z(t.value.additions)+" 行 ",1)]),e("span",el,[P[6]||(P[6]=e("span",{class:"w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"},null,-1)),ie(" 删除 "+z(t.value.deletions)+" 行 ",1)]),e("span",tl,[P[7]||(P[7]=e("span",{class:"w-3 h-3 bg-blue-100 border border-blue-300 rounded mr-1"},null,-1)),ie(" 修改 "+z(t.value.modifications)+" 行 ",1)])]),e("button",{onClick:R,class:"text-blue-600 hover:text-blue-700 flex items-center gap-1"},[...P[8]||(P[8]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),ie(" 复制Diff ",-1)])])])]))}}),ol={class:"h-full flex flex-col overflow-hidden p-2"},rl={class:"bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0"},al={class:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"},ll={class:"flex items-center gap-2 flex-shrink-0 flex-wrap sm:flex-nowrap"},nl={class:"flex items-center gap-2 flex-wrap sm:flex-nowrap"},il=["value"],dl=["disabled"],ul=["value"],cl={class:"flex space-x-2 mt-4"},ml=["onClick"],pl={class:"flex-1 overflow-hidden"},gl={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},vl={class:"bg-white rounded-lg p-6 max-w-4xl max-h-[90vh] w-[90vw] overflow-hidden"},Re="yprompt_optimize_active_mode",fl=Ce({__name:"OptimizeModule",setup(C){const o=ct(),l=je(),_=We();Fe.getInstance();const{activeTab:a,systemPrompt:f,optimizedPrompts:k,switchTab:t}=_,U=g(!1),A=g("system"),B=g(window.innerWidth),R=g(!1);if(!o.params.id)try{const L=localStorage.getItem(Re);L&&["system","user","compare"].includes(L)&&(A.value=L)}catch(L){console.error("读取activeMode失败:",L)}K(()=>B.value>=1200);const y=K(()=>l.getAvailableProviders()),P=K(()=>l.getAvailableModels(l.selectedProvider)),E=[{key:"system",label:"系统提示词优化"},{key:"user",label:"用户提示词优化"},{key:"compare",label:"效果对比"}],M=L=>{A.value=L;try{localStorage.setItem(Re,L)}catch(r){console.error("保存activeMode失败:",r)}},p=()=>{l.selectedModel="",l.saveSettings()},$=()=>{B.value=window.innerWidth},I=async L=>{var r,c,s,S;R.value=!0;try{const j="",V=localStorage.getItem("yprompt_token");if(!V)throw new Error("请先登录");const X=await(await fetch(`${j}/api/prompts/${L}`,{headers:{Authorization:`Bearer ${V}`}})).json();if(X.code===200){const h=X.data;if(console.log("🟢 加载提示词成功:",{id:h.id,title:h.title,type:h.prompt_type,final_prompt_length:(r=h.final_prompt)==null?void 0:r.length,system_prompt_length:(c=h.system_prompt)==null?void 0:c.length,conversation_history_length:(s=h.conversation_history)==null?void 0:s.length}),h.prompt_type==="user"){A.value="user",_.setLoadedPromptId(h.id),console.log("🔵 用户提示词 - 设置loadedPromptId:",h.id);const b={draftPrompt:h.final_prompt||"",systemPrompt:h.system_prompt||"",conversationHistory:h.conversation_history||""};console.log("🔵 保存用户提示词数据到localStorage:",b),localStorage.setItem("yprompt_optimize_loaded_user_prompt",JSON.stringify(b))}else A.value="system",_.systemPrompt=h.final_prompt,_.setLoadedPromptId(h.id),console.log("🔵 系统提示词 - 设置loadedPromptId:",h.id),console.log("🔵 设置系统提示词到store:",(S=h.final_prompt)==null?void 0:S.substring(0,50));localStorage.setItem(Re,A.value)}else throw new Error(X.message||"加载失败")}catch(j){console.error("加载提示词失败:",j),alert(`加载失败: ${j.message}`)}finally{R.value=!1}};return ee(()=>o.params.id,L=>{L&&I(Number(L))},{immediate:!0}),Be(()=>{window.addEventListener("resize",$),l.loadSettings();const L=setInterval(()=>{if(localStorage.getItem("yprompt_trigger_compare")==="true"&&(console.log("🟢 检测到对比触发，切换到compare模式"),A.value="compare",localStorage.removeItem("yprompt_trigger_compare"),localStorage.setItem(Re,"compare")),localStorage.getItem("yprompt_back_to_optimize")==="true"){console.log("🟢 检测到返回触发，切换回优化模式");const s=localStorage.getItem(Re);s&&["system","user"].includes(s)&&(A.value=s),localStorage.removeItem("yprompt_back_to_optimize")}},100);tt(()=>{clearInterval(L)})}),tt(()=>{window.removeEventListener("resize",$)}),(L,r)=>(n(),i(ue,null,[e("div",ol,[e("div",rl,[e("div",al,[r[8]||(r[8]=e("div",{class:"min-w-0"},[e("h1",{class:"text-xl lg:text-2xl font-bold text-gray-800 mb-1"},"提示词优化")],-1)),e("div",ll,[e("div",nl,[r[7]||(r[7]=e("label",{class:"text-sm font-medium text-gray-700 whitespace-nowrap"},"AI模型:",-1)),de(e("select",{"onUpdate:modelValue":r[0]||(r[0]=c=>d(l).selectedProvider=c),onChange:p,class:"px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 min-w-0 flex-1 sm:flex-none"},[r[5]||(r[5]=e("option",{value:""},"选择提供商",-1)),(n(!0),i(ue,null,pe(y.value,c=>(n(),i("option",{key:c.id,value:c.id},z(c.name),9,il))),128))],544),[[Ae,d(l).selectedProvider]]),de(e("select",{"onUpdate:modelValue":r[1]||(r[1]=c=>d(l).selectedModel=c),onChange:r[2]||(r[2]=(...c)=>d(l).saveSettings&&d(l).saveSettings(...c)),disabled:!d(l).selectedProvider,class:"px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 min-w-0 flex-1 sm:flex-none"},[r[6]||(r[6]=e("option",{value:""},"选择模型",-1)),(n(!0),i(ue,null,pe(P.value,c=>(n(),i("option",{key:c.id,value:c.id},z(c.name),9,ul))),128))],40,dl),[[Ae,d(l).selectedModel]])])])]),e("div",cl,[(n(),i(ue,null,pe(E,c=>e("button",{key:c.key,onClick:s=>M(c.key),class:q(["px-4 py-2 rounded-lg text-sm font-medium transition-colors",A.value===c.key?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},z(c.label),11,ml)),64))])]),e("div",pl,[F(Ha,{"active-mode":A.value,"onUpdate:activeMode":r[3]||(r[3]=c=>A.value=c)},null,8,["active-mode"])]),U.value?(n(),i("div",gl,[e("div",vl,[F(sl,{"left-content":d(f),"right-content":d(k).system,"left-label":"原始版本","right-label":"优化版本",onClose:r[4]||(r[4]=c=>U.value=!1)},null,8,["left-content","right-content"])])])):O("",!0)]),F(jt)],64))}}),kl=Ct(fl,[["__scopeId","data-v-799df3c9"]]);export{kl as default};
