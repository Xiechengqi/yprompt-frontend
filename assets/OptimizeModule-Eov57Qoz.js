const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SavePromptDialog.vue_vue_type_script_setup_true_lang-Byq4kPDr.js","assets/index-CgStLW2f.js","assets/index-By8FnadM.css"])))=>i.map(i=>d[i]);
import{c as tt,s as vt,r as f,a as G,N as je,K as Je,Z as Ye,d as Se,o as Be,B as Z,e as p,q as i,f as e,h as B,g as E,n as Y,k as b,R as $e,i as ne,$ as Re,F as ie,x as de,t as A,O as re,a0 as fe,E as ft,a1 as yt,H as st,w as ot,X as rt,y as at,a2 as ht,l as lt,G as nt,z as it,j as be,m as Ve,M as xt,a3 as ut,I as bt,J as We,_ as wt}from"./index-CgStLW2f.js";import{c as De,_ as _t}from"./SavePromptDialog.vue_vue_type_script_setup_true_lang-Byq4kPDr.js";import{C as dt,P as Pt,A as ct,T as kt,i as $t,f as St,g as Ct,h as zt,b as Mt,_ as Fe,d as Ze}from"./FinalTab.vue_vue_type_script_setup_true_lang-Be1GIgUz.js";import{A as Ne,d as It}from"./marked.esm-B0Ieip5I.js";import{F as qe,_ as et,S as At}from"./SystemPromptModal.vue_vue_type_script_setup_true_lang-Bk0iFTTq.js";/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=tt("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=tt("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]),Xe=vt("optimize",()=>{const z=f(""),s=f(""),a=f(null),S=f(null),r=f(null),h=f(!1),P=f([]),t=f([]),R=f({system:"",user:""}),N=f(!1),T=f(!1),H=f([]),w=f("original"),k=f(!1),L=f([]),g=f(""),c=f([]),o=f(!1),I=f("input"),C=f(!1),u=f(!1),x=G(()=>z.value.trim()||s.value.trim()),n=G(()=>R.value.system.trim()||R.value.user.trim()),l=G(()=>P.value.filter(j=>t.value.includes(j.id))),y=G(()=>H.value.find(j=>j.version===w.value)),_=()=>{z.value="",s.value="",a.value=null,S.value=null,r.value=null,P.value=[],t.value=[],R.value={system:"",user:""},H.value=[],w.value="original",L.value=[],c.value=[],I.value="input"},M=(j,V,le)=>{z.value=j,s.value=V,le&&(a.value=le)},K=j=>{S.value=j},se=j=>{r.value=j},W=j=>{P.value=j,t.value=j.map(V=>V.id)},D=j=>{const V=t.value.indexOf(j);V>-1?t.value.splice(V,1):t.value.push(j)},q=()=>{t.value=P.value.map(j=>j.id)},Q=()=>{t.value=[]},ae=(j,V)=>{R.value={system:j,user:V};const le={id:`v_${Date.now()}`,version:`V${H.value.length+1}`,systemPrompt:j,userPrompt:V,changes:pe(z.value,j,s.value,V),appliedSuggestions:[...t.value],createdAt:new Date,tag:"draft"};H.value.push(le),w.value=le.version},pe=(j,V,le,ee)=>{const ge=[];return j!==V&&ge.push({type:"modify",field:"system",content:V}),le!==ee&&ge.push({type:"modify",field:"user",content:ee}),ge};return{systemPrompt:z,userPrompt:s,importedPromptId:a,loadedPromptId:S,analysis:r,isAnalyzing:h,suggestions:P,selectedSuggestions:t,optimizedPrompts:R,isGeneratingSuggestions:N,isApplyingSuggestions:T,versions:H,currentVersion:w,isVersionLoading:k,testCases:L,currentTestCase:g,testResults:c,isTesting:o,activeTab:I,showDiffView:C,showVersionHistory:u,hasPromptContent:x,hasOptimizedPrompt:n,selectedSuggestionObjects:l,currentVersionData:y,resetOptimization:_,setPrompts:M,setLoadedPromptId:K,setAnalysis:se,setSuggestions:W,toggleSuggestion:D,selectAllSuggestions:q,deselectAllSuggestions:Q,setOptimizedPrompts:ae,addTestCase:j=>{j.trim()&&!L.value.includes(j.trim())&&L.value.push(j.trim())},setCurrentTestCase:j=>{g.value=j},setTestResults:j=>{c.value=j},switchTab:j=>{I.value=j},toggleDiffView:()=>{C.value=!C.value},toggleVersionHistory:()=>{u.value=!u.value},switchVersion:j=>{w.value=j;const V=H.value.find(le=>le.version===j);V&&(R.value={system:V.systemPrompt,user:V.userPrompt})}}});function mt(z){if(!z)throw new Error("Empty content");try{return JSON.parse(z)}catch{}const s=/```(?:json)?\s*\n?([\s\S]*?)\n?```/,a=z.match(s);if(a&&a[1])try{return JSON.parse(a[1].trim())}catch(h){throw new Error(`Failed to parse JSON from code block: ${h}`)}const S=z.indexOf("{"),r=z.lastIndexOf("}");if(S!==-1&&r!==-1&&r>S)try{const h=z.substring(S,r+1);return JSON.parse(h)}catch(h){throw new Error(`Failed to parse extracted JSON: ${h}`)}throw new Error("No valid JSON found in content")}function Tt(){const z=je(),s=Je.getInstance(),a=Ye({mode:"system",systemConfig:{leftSystemPrompt:"",rightSystemPrompt:"",sharedUserInput:""},leftMessages:[],rightMessages:[],userConfig:{sharedSystemPrompt:"",leftUserPrompt:"",rightUserPrompt:""},leftUserMessages:[],rightUserMessages:[],isLeftGenerating:!1,isRightGenerating:!1}),S=G(()=>a.isLeftGenerating||a.isRightGenerating),r=(w,k)=>{a.mode="system",a.systemConfig.leftSystemPrompt=w,a.systemConfig.rightSystemPrompt=k,a.systemConfig.sharedUserInput="",a.leftMessages=[],a.rightMessages=[],console.log("🔵 初始化系统提示词对比:",{leftLength:w.length,rightLength:k.length})},h=(w,k,L)=>{a.mode="user",a.userConfig.sharedSystemPrompt=w,a.userConfig.leftUserPrompt=k,a.userConfig.rightUserPrompt=L,a.leftUserMessages=[],a.rightUserMessages=[],console.log("🔵 初始化用户提示词对比:",{systemPromptLength:w.length,leftLength:k.length,rightLength:L.length})},P=async()=>{if(!a.systemConfig.sharedUserInput.trim()||S.value)return;const w=z.getAvailableProviders().find(C=>C.id===z.selectedProvider),k=z.selectedModel;if(!w||!k)throw new Error("请先选择AI提供商和模型");const L=a.systemConfig.sharedUserInput.trim(),g=`user-${Date.now()}`,c={id:g,role:"user",content:L,timestamp:new Date};a.leftMessages.push({...c,id:`left-${g}`}),a.rightMessages.push({...c,id:`right-${g}`}),a.systemConfig.sharedUserInput="";const o=N("left",a.systemConfig.leftSystemPrompt,a.leftMessages),I=N("right",a.systemConfig.rightSystemPrompt,a.rightMessages);await Promise.all([o,I])},t=async()=>{if(!a.userConfig.leftUserPrompt.trim()||a.isLeftGenerating)return;const w=z.getAvailableProviders().find(o=>o.id===z.selectedProvider),k=z.selectedModel;if(!w||!k)throw new Error("请先选择AI提供商和模型");const L=a.userConfig.leftUserPrompt.trim(),c={id:`left-user-${Date.now()}`,role:"user",content:L,timestamp:new Date};a.leftUserMessages.push(c),a.userConfig.leftUserPrompt="",await N("left",a.userConfig.sharedSystemPrompt,a.leftUserMessages)},R=async()=>{if(!a.userConfig.rightUserPrompt.trim()||a.isRightGenerating)return;const w=z.getAvailableProviders().find(o=>o.id===z.selectedProvider),k=z.selectedModel;if(!w||!k)throw new Error("请先选择AI提供商和模型");const L=a.userConfig.rightUserPrompt.trim(),c={id:`right-user-${Date.now()}`,role:"user",content:L,timestamp:new Date};a.rightUserMessages.push(c),a.userConfig.rightUserPrompt="",await N("right",a.userConfig.sharedSystemPrompt,a.rightUserMessages)},N=async(w,k,L)=>{const g=z.getAvailableProviders().find(C=>C.id===z.selectedProvider),c=z.selectedModel;if(!g||!c)throw new Error("请先选择AI提供商和模型");w==="left"?a.isLeftGenerating=!0:a.isRightGenerating=!0;const o=`${w}-ai-${Date.now()}`,I={id:o,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};L.push(I);try{const C=[{role:"system",content:k},...L.filter(l=>l.id!==o).map(l=>({role:l.role,content:l.content}))],u=l=>{const y=L.find(_=>_.id===o);y&&(y.content+=l)},x=await s.callAI(C,g,c,!0,u),n=L.find(l=>l.id===o);n&&(n.content=x,n.isStreaming=!1)}catch(C){console.error(`${w} AI call failed:`,C);const u=L.find(x=>x.id===o);u&&(u.content=`❌ 错误: ${C.message}`,u.isStreaming=!1)}finally{w==="left"?a.isLeftGenerating=!1:a.isRightGenerating=!1}};return{state:a,isGenerating:S,initSystemComparison:r,initUserComparison:h,sendSystemMessage:P,sendLeftUserMessage:t,sendRightUserMessage:R,clearHistory:w=>{a.mode==="system"?((!w||w==="left")&&(a.leftMessages=[]),(!w||w==="right")&&(a.rightMessages=[])):((!w||w==="left")&&(a.leftUserMessages=[]),(!w||w==="right")&&(a.rightUserMessages=[]))},reset:()=>{a.systemConfig={leftSystemPrompt:"",rightSystemPrompt:"",sharedUserInput:""},a.userConfig={sharedSystemPrompt:"",leftUserPrompt:"",rightUserPrompt:""},a.leftMessages=[],a.rightMessages=[],a.leftUserMessages=[],a.rightUserMessages=[],a.isLeftGenerating=!1,a.isRightGenerating=!1}}}const Lt={class:"h-full min-h-0 overflow-hidden flex flex-col"},Ut={class:"flex-1 min-h-0 grid grid-cols-2 gap-4 mb-4"},Et={class:"flex flex-col bg-white rounded-lg shadow-sm overflow-hidden"},Rt={class:"p-4 border-b border-gray-200 flex-shrink-0"},jt={class:"flex justify-between items-center"},Ht={class:"flex items-center space-x-2"},Vt=["title"],Nt={class:"flex items-center gap-2"},Dt={key:0,class:"px-4 pb-2 border-b border-gray-200 bg-gray-50"},Jt={class:"py-2 space-y-2"},Bt={class:"flex items-center justify-between"},Ft={class:"flex flex-col gap-2"},Gt=["value"],Kt=["disabled"],qt=["value"],Qt={class:"text-xs text-gray-500"},Yt={key:0},Xt={key:1},Wt={key:2},Zt={class:"flex-1 flex flex-col min-h-0"},es={key:0,class:"flex items-center justify-center h-full text-gray-400"},ts={class:"text-center"},ss={class:"flex flex-col w-full max-w-xs lg:max-w-md"},os=["innerHTML"],rs={key:1,class:"whitespace-pre-wrap"},as={key:0,class:"animate-pulse"},ls={key:0,class:"p-3 border-t border-gray-200"},ns={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},is={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},us=["disabled"],ds={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},cs=["disabled"],ms={class:"flex flex-col bg-white rounded-lg shadow-sm overflow-hidden"},ps={class:"p-4 border-b border-gray-200 flex-shrink-0"},gs={class:"flex justify-between items-center"},vs={class:"flex items-center space-x-2"},fs=["title"],ys={class:"flex items-center gap-2"},hs={key:0,class:"px-4 pb-2 border-b border-gray-200 bg-gray-50"},xs={class:"py-2 space-y-2"},bs={class:"flex items-center justify-between"},ws={class:"flex flex-col gap-2"},_s=["value"],Ps=["disabled"],ks=["value"],$s={class:"text-xs text-gray-500"},Ss={key:0},Cs={key:1},zs={key:2},Ms={class:"flex-1 flex flex-col min-h-0"},Is={key:0,class:"flex items-center justify-center h-full text-gray-400"},As={class:"text-center"},Os={class:"flex flex-col w-full max-w-xs lg:max-w-md"},Ts=["innerHTML"],Ls={key:1,class:"whitespace-pre-wrap"},Us={key:0,class:"animate-pulse"},Es={key:0,class:"p-3 border-t border-gray-200"},Rs={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},js={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},Hs=["disabled"],Vs={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},Ns=["disabled"],Ds={class:"flex-shrink-0"},Js={key:0,class:"bg-white rounded-lg shadow-md border border-gray-200 p-3"},Bs={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},Fs={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},Gs=["disabled"],Ks={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent pointer-events-none"},qs=["disabled"],Qs=Se({__name:"ComparisonPanel",setup(z){const s=Tt(),a=je(),S=f(null),r=f(null),h=f("user"),P=f(""),t=f(""),R=f(""),N=f(""),T=f(""),H=f(!1),w=f(!1),k=f(!1),L=f(!1),g=f(!1),c=f(""),o=f(""),I=f(""),C=f(""),u=f(""),x=f(""),n=G(()=>s.state.leftMessages),l=G(()=>s.state.rightMessages),y=G(()=>s.state.leftUserMessages),_=G(()=>s.state.rightUserMessages),M=G(()=>s.isGenerating.value),K=G(()=>s.state.isLeftGenerating),se=G(()=>s.state.isRightGenerating),W=G(()=>a.getAvailableProviders()),D=G(()=>I.value?a.getAvailableModels(I.value):[]),q=G(()=>u.value?a.getAvailableModels(u.value):[]),Q=G(()=>{if(!I.value||!C.value)return"使用全局模型";const U=W.value.find(m=>m.id===I.value),d=D.value.find(m=>m.id===C.value);return d?`${U==null?void 0:U.name} - ${d.name}`:"使用全局模型"}),ae=G(()=>{if(!u.value||!x.value)return"使用全局模型";const U=W.value.find(m=>m.id===u.value),d=q.value.find(m=>m.id===x.value);return d?`${U==null?void 0:U.name} - ${d.name}`:"使用全局模型"});Be(()=>{try{const d=localStorage.getItem("yprompt_comparison_model_config");if(d){const m=JSON.parse(d);I.value=m.leftProvider||"",C.value=m.leftModel||"",u.value=m.rightProvider||"",x.value=m.rightModel||"",console.log("🟢 加载保存的模型配置:",m)}}catch(d){console.error("加载模型配置失败:",d)}try{const d=localStorage.getItem("yprompt_comparison_data");if(d){const m=JSON.parse(d);console.log("🟢 ComparisonPanel 加载数据:",m),H.value=!0,m.mode==="system"?(h.value="system",s.initSystemComparison(m.originalPrompt,m.optimizedPrompt)):m.mode==="user"&&(h.value="user",s.initUserComparison(m.systemPrompt||"",m.originalPrompt,m.optimizedPrompt),N.value=m.originalPrompt,T.value=m.optimizedPrompt,t.value=m.originalPrompt,R.value=m.optimizedPrompt,m.conversationHistory&&(console.log("🟢 加载对话上下文:",m.conversationHistory),Ce(m.conversationHistory)))}else console.warn("⚠️ 没有找到对比数据，显示默认空白对话框")}catch(d){console.error("加载对比数据失败:",d)}const U=()=>{const d=["yprompt_token","yprompt_user","yprompt_settings","yprompt_comparison_model_config"];Object.keys(localStorage).forEach(xe=>{d.includes(xe)||localStorage.removeItem(xe)}),console.log("🧹 浏览器关闭，已清理所有数据（保留用户信息）")};return window.addEventListener("beforeunload",U),()=>{window.removeEventListener("beforeunload",U)}});const pe=async()=>{P.value.trim()&&(s.state.systemConfig.sharedUserInput=P.value,await s.sendSystemMessage(),P.value="")},ue=async()=>{t.value.trim()&&(s.state.userConfig.leftUserPrompt=t.value,await s.sendLeftUserMessage())},ce=async()=>{R.value.trim()&&(s.state.userConfig.rightUserPrompt=R.value,await s.sendRightUserMessage())},ye=()=>{confirm("确定清空左侧对话历史吗？")&&s.clearHistory("left")},we=()=>{confirm("确定清空右侧对话历史吗？")&&s.clearHistory("right")},Ce=U=>{try{const d=JSON.parse(U);if(Array.isArray(d)){d.forEach(m=>{const xe=new Date,Me=m.role==="assistant"?"assistant":"user";s.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:Me,content:m.content,timestamp:xe}),s.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:Me,content:m.content,timestamp:xe})}),console.log("✅ 对话上下文加载完成（JSON格式）:",d.length,"条消息");return}}catch{console.log("⚠️ JSON解析失败，尝试旧格式")}try{const d=U.split(`
`).filter(m=>m.trim());for(const m of d){const xe=m.match(/^User:\s*(.+)$/i),Me=m.match(/^Assistant:\s*(.+)$/i);if(xe){const Ie=xe[1].trim(),Pe=new Date;s.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:"user",content:Ie,timestamp:Pe}),s.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:"user",content:Ie,timestamp:Pe})}else if(Me){const Ie=Me[1].trim(),Pe=new Date;s.state.leftUserMessages.push({id:`left-${Date.now()}-${Math.random()}`,role:"assistant",content:Ie,timestamp:Pe}),s.state.rightUserMessages.push({id:`right-${Date.now()}-${Math.random()}`,role:"assistant",content:Ie,timestamp:Pe})}}console.log("✅ 对话上下文加载完成（旧格式）")}catch(d){console.error("加载对话上下文失败:",d)}};Z(()=>s.state.systemConfig.leftSystemPrompt,U=>{c.value=U},{immediate:!0}),Z(()=>s.state.systemConfig.rightSystemPrompt,U=>{o.value=U},{immediate:!0}),Z(()=>s.state.userConfig.sharedSystemPrompt,U=>{h.value==="user"&&(c.value=U,o.value=U)},{immediate:!0}),Z([I,C,u,x],()=>{const U={leftProvider:I.value,leftModel:C.value,rightProvider:u.value,rightModel:x.value};localStorage.setItem("yprompt_comparison_model_config",JSON.stringify(U)),console.log("💾 保存模型配置:",U)});const he=()=>{h.value==="system"?s.state.systemConfig.leftSystemPrompt=c.value:s.state.userConfig.sharedSystemPrompt=c.value},oe=()=>{h.value==="system"?s.state.systemConfig.rightSystemPrompt=o.value:s.state.userConfig.sharedSystemPrompt=o.value},j=U=>{U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),P.value.trim()&&!M.value&&pe())},V=U=>{U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),t.value.trim()&&!K.value&&ue())},le=U=>{U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),R.value.trim()&&!se.value&&ce())},ee=()=>{C.value=""},ge=()=>{x.value=""},Ae=()=>{I.value="",C.value=""},_e=()=>{u.value="",x.value=""},Le=()=>{confirm("确定要重置所有数据吗？这将清空所有对话和设置。")&&(s.clearHistory("left"),s.clearHistory("right"),s.state.systemConfig.leftSystemPrompt="",s.state.systemConfig.rightSystemPrompt="",s.state.systemConfig.sharedUserInput="",s.state.userConfig.sharedSystemPrompt="",s.state.userConfig.leftUserPrompt="",s.state.userConfig.rightUserPrompt="",P.value="",t.value="",R.value="",c.value="",o.value="",localStorage.removeItem("yprompt_comparison_data"),localStorage.removeItem("yprompt_trigger_compare"))},ze=()=>{localStorage.removeItem("yprompt_trigger_compare");const U=h.value==="system"?"system":"user";localStorage.setItem("yprompt_optimize_active_mode",U),localStorage.setItem("yprompt_back_to_optimize","true")},me=U=>{ft(()=>{U&&(U.scrollTop=U.scrollHeight)})};Z(()=>n.value.length,()=>{me(S.value)}),Z(()=>l.value.length,()=>{me(r.value)}),Z(()=>y.value.length,()=>{me(S.value)}),Z(()=>_.value.length,()=>{me(r.value)}),Z(()=>s.state.isLeftGenerating,()=>{me(S.value)}),Z(()=>s.state.isRightGenerating,()=>{me(r.value)}),Z(()=>(h.value==="system"?n.value:y.value).map(d=>d.content).join(""),()=>{me(S.value)},{deep:!0}),Z(()=>(h.value==="system"?l.value:_.value).map(d=>d.content).join(""),()=>{me(r.value)},{deep:!0});const He=U=>{try{return It(U)}catch(d){return console.error("Markdown渲染失败:",d),U}};return(U,d)=>(i(),p("div",Lt,[e("div",Ut,[e("div",Et,[e("div",Rt,[e("div",jt,[e("div",Ht,[d[16]||(d[16]=e("h4",{class:"font-semibold text-gray-800"},"优化前",-1)),e("button",{onClick:d[0]||(d[0]=m=>w.value=!0),class:Y(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm",b(s).state.systemConfig.leftSystemPrompt.trim()||b(s).state.userConfig.sharedSystemPrompt.trim()?"text-green-600":"text-gray-400"]),title:"设置系统提示词"},[B(b(qe),{class:"w-4 h-4"})],2),e("button",{onClick:d[1]||(d[1]=m=>L.value=!L.value),class:Y(["p-1 hover:bg-gray-100 rounded transition-colors",C.value?"text-green-600":"text-gray-600"]),title:Q.value},[...d[15]||(d[15]=[e("svg",{class:"w-4 h-4 hover:text-gray-800",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"})],-1)])],10,Vt)]),e("div",Nt,[e("button",{onClick:Le,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置所有数据"},[B(b($e),{class:"w-4 h-4"}),d[17]||(d[17]=e("span",null,"重置",-1))]),n.value.length>0||y.value.length>0?(i(),p("button",{key:0,onClick:ye,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"清空对话"},[B(b($e),{class:"w-4 h-4"}),d[18]||(d[18]=e("span",null,"清空",-1))])):E("",!0)])])]),L.value?(i(),p("div",Dt,[e("div",Jt,[e("div",Bt,[d[19]||(d[19]=e("label",{class:"text-sm font-medium text-gray-700"},"选择AI模型",-1)),I.value?(i(),p("button",{key:0,onClick:Ae,class:"px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置为全局模型"}," 重置 ")):E("",!0)]),e("div",Ft,[ne(e("select",{"onUpdate:modelValue":d[2]||(d[2]=m=>I.value=m),onChange:ee,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[d[20]||(d[20]=e("option",{value:""},"使用全局模型",-1)),(i(!0),p(ie,null,de(W.value,m=>(i(),p("option",{key:m.id,value:m.id},A(m.name),9,Gt))),128))],544),[[Re,I.value]]),ne(e("select",{"onUpdate:modelValue":d[3]||(d[3]=m=>C.value=m),disabled:!I.value,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"},[d[21]||(d[21]=e("option",{value:""},"选择模型",-1)),(i(!0),p(ie,null,de(D.value,m=>(i(),p("option",{key:m.id,value:m.id},A(m.name),9,qt))),128))],8,Kt),[[Re,C.value]])]),e("div",Qt,[I.value?C.value?(i(),p("span",Wt,"当前: "+A(Q.value),1)):(i(),p("span",Xt,"请选择模型")):(i(),p("span",Yt,"当前: 跟随全局模型设置"))])])])):E("",!0),e("div",Zt,[e("div",{ref_key:"leftChatContainer",ref:S,class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},[(h.value==="system"?n.value:y.value).length===0?(i(),p("div",es,[e("div",ts,[B(b(Qe),{class:"w-12 h-12 mx-auto mb-2 opacity-50"}),d[22]||(d[22]=e("p",{class:"text-sm"},"暂无对话",-1))])])):E("",!0),(i(!0),p(ie,null,de(h.value==="system"?n.value:y.value,m=>(i(),p("div",{key:m.id,class:Y(["flex group",m.role==="user"?"justify-end":"justify-start"])},[e("div",ss,[e("div",{class:Y([m.role==="user"?"bg-blue-500 text-white px-4 py-3 rounded-lg ml-auto":"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg mr-auto","transition-all duration-300 relative"])},[m.role==="assistant"?(i(),p("div",{key:0,innerHTML:He(m.content),class:"prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"},null,8,os)):(i(),p("div",rs,[re(A(m.content),1),m.isStreaming?(i(),p("span",as,"▋")):E("",!0)]))],2)])],2))),128))],512),h.value==="user"?(i(),p("div",ls,[e("div",ns,[e("div",is,[ne(e("textarea",{"onUpdate:modelValue":d[4]||(d[4]=m=>t.value=m),onKeydown:V,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:K.value,rows:"1"},null,40,us),[[fe,t.value]])]),e("div",ds,[d[23]||(d[23]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:ue,disabled:!t.value.trim()||K.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"},[B(b(Ne),{class:"w-4 h-4"})],8,cs)])])])):E("",!0)])]),e("div",ms,[e("div",ps,[e("div",gs,[e("div",vs,[d[25]||(d[25]=e("h4",{class:"font-semibold text-gray-800"},"优化后",-1)),e("button",{onClick:d[5]||(d[5]=m=>k.value=!0),class:Y(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm",b(s).state.systemConfig.rightSystemPrompt.trim()||b(s).state.userConfig.sharedSystemPrompt.trim()?"text-green-600":"text-gray-400"]),title:"设置系统提示词"},[B(b(qe),{class:"w-4 h-4"})],2),e("button",{onClick:d[6]||(d[6]=m=>g.value=!g.value),class:Y(["p-1 hover:bg-gray-100 rounded transition-colors",x.value?"text-green-600":"text-gray-600"]),title:ae.value},[...d[24]||(d[24]=[e("svg",{class:"w-4 h-4 hover:text-gray-800",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h12m0 0l-4 4m4-4l-4-4m0 6H4m0 0l4 4m-4-4l4-4"})],-1)])],10,fs)]),e("div",ys,[l.value.length>0||_.value.length>0?(i(),p("button",{key:0,onClick:we,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"清空对话"},[B(b($e),{class:"w-4 h-4"}),d[26]||(d[26]=e("span",null,"清空",-1))])):E("",!0),H.value?(i(),p("button",{key:1,onClick:ze,class:"flex items-center gap-1 px-3 py-1 text-sm bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors",title:"返回优化页面"},[B(b(Ot),{class:"w-4 h-4"}),d[27]||(d[27]=e("span",null,"返回",-1))])):E("",!0)])])]),g.value?(i(),p("div",hs,[e("div",xs,[e("div",bs,[d[28]||(d[28]=e("label",{class:"text-sm font-medium text-gray-700"},"选择AI模型",-1)),u.value?(i(),p("button",{key:0,onClick:_e,class:"px-2 py-1 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",title:"重置为全局模型"}," 重置 ")):E("",!0)]),e("div",ws,[ne(e("select",{"onUpdate:modelValue":d[7]||(d[7]=m=>u.value=m),onChange:ge,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[d[29]||(d[29]=e("option",{value:""},"使用全局模型",-1)),(i(!0),p(ie,null,de(W.value,m=>(i(),p("option",{key:m.id,value:m.id},A(m.name),9,_s))),128))],544),[[Re,u.value]]),ne(e("select",{"onUpdate:modelValue":d[8]||(d[8]=m=>x.value=m),disabled:!u.value,class:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:bg-gray-100"},[d[30]||(d[30]=e("option",{value:""},"选择模型",-1)),(i(!0),p(ie,null,de(q.value,m=>(i(),p("option",{key:m.id,value:m.id},A(m.name),9,ks))),128))],8,Ps),[[Re,x.value]])]),e("div",$s,[u.value?x.value?(i(),p("span",zs,"当前: "+A(ae.value),1)):(i(),p("span",Cs,"请选择模型")):(i(),p("span",Ss,"当前: 跟随全局模型设置"))])])])):E("",!0),e("div",Ms,[e("div",{ref_key:"rightChatContainer",ref:r,class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},[(h.value==="system"?l.value:_.value).length===0?(i(),p("div",Is,[e("div",As,[B(b(Qe),{class:"w-12 h-12 mx-auto mb-2 opacity-50"}),d[31]||(d[31]=e("p",{class:"text-sm"},"暂无对话",-1))])])):E("",!0),(i(!0),p(ie,null,de(h.value==="system"?l.value:_.value,m=>(i(),p("div",{key:m.id,class:Y(["flex group",m.role==="user"?"justify-end":"justify-start"])},[e("div",Os,[e("div",{class:Y([m.role==="user"?"bg-blue-500 text-white px-4 py-3 rounded-lg ml-auto":"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg mr-auto","transition-all duration-300 relative"])},[m.role==="assistant"?(i(),p("div",{key:0,innerHTML:He(m.content),class:"prose prose-sm max-w-none prose-headings:text-gray-800 prose-p:text-gray-800 prose-li:text-gray-800 prose-strong:text-gray-800"},null,8,Ts)):(i(),p("div",Ls,[re(A(m.content),1),m.isStreaming?(i(),p("span",Us,"▋")):E("",!0)]))],2)])],2))),128))],512),h.value==="user"?(i(),p("div",Es,[e("div",Rs,[e("div",js,[ne(e("textarea",{"onUpdate:modelValue":d[9]||(d[9]=m=>R.value=m),onKeydown:le,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:se.value,rows:"1"},null,40,Hs),[[fe,R.value]])]),e("div",Vs,[d[32]||(d[32]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:ce,disabled:!R.value.trim()||se.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto"},[B(b(Ne),{class:"w-4 h-4"})],8,Ns)])])])):E("",!0)])])]),e("div",Ds,[h.value==="system"?(i(),p("div",Js,[e("div",Bs,[e("div",Fs,[ne(e("textarea",{"onUpdate:modelValue":d[10]||(d[10]=m=>P.value=m),onKeydown:j,placeholder:"Shift+Enter换行",class:"w-full h-full px-2 pt-3 pb-1 border-0 outline-none resize-none disabled:opacity-50 text-base overflow-y-auto bg-transparent",disabled:M.value,rows:"1"},null,40,Gs),[[fe,P.value]])]),e("div",Ks,[d[33]||(d[33]=e("div",{class:"w-8 h-8"},null,-1)),e("button",{onClick:pe,disabled:!P.value.trim()||M.value,class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center pointer-events-auto",title:"同时发送到两侧"},[B(b(Ne),{class:"w-4 h-4"})],8,qs)])])])):E("",!0)]),B(et,{"is-open":w.value,modelValue:c.value,"onUpdate:modelValue":d[11]||(d[11]=m=>c.value=m),onClose:d[12]||(d[12]=m=>w.value=!1),onSave:he,title:h.value==="system"?"系统提示词（左 - 优化前）":"共用系统提示词"},null,8,["is-open","modelValue","title"]),B(et,{"is-open":k.value,modelValue:o.value,"onUpdate:modelValue":d[13]||(d[13]=m=>o.value=m),onClose:d[14]||(d[14]=m=>k.value=!1),onSave:oe,title:h.value==="system"?"系统提示词（右 - 优化后）":"共用系统提示词"},null,8,["is-open","modelValue","title"])]))}});function Ys(){const z=je(),s=Xe(),a=yt.getInstance(),S=Je.getInstance(),r="user_prompt_optimize_result",h=()=>{try{const n=localStorage.getItem(r);if(n){const l=JSON.parse(n);return l.metadata&&l.metadata.timestamp&&(l.metadata.timestamp=new Date(l.metadata.timestamp)),l}}catch(n){console.error("加载优化结果失败:",n)}return null},P=n=>{try{n?localStorage.setItem(r,JSON.stringify(n)):localStorage.removeItem(r)}catch(l){console.error("保存优化结果失败:",l)}},t=Ye({draftPrompt:"",systemPrompt:"",conversationHistory:"",result:h(),isOptimizing:!1,error:null,isAnalyzing:!1,analysisText:"",isOptimizingPrompt:!1,optimizedText:"",enableQualityAnalysis:!0,languageState:"zh",isConvertingLanguage:!1}),R=G(()=>t.draftPrompt.trim().length>0),N=G(()=>t.result!==null),T=G(()=>t.error!==null),H=n=>/[\u4e00-\u9fa5]/.test(n)?"中文":"英文",w=async()=>{var l,y,_,M,K,se,W,D,q,Q;if(!t.result){t.error="没有可用的质量分析结果";return}t.isOptimizing=!0,t.error=null,t.optimizedText="";const n=performance.now();try{const ae=H(t.draftPrompt),ue=z.getAvailableProviders().find(V=>V.id===z.selectedProvider),ce=z.selectedModel;if(!ue||!ce)throw new Error("请先在顶部选择AI提供商和模型");const ye=a.getUserPromptQuickOptimization(),we=a.getUserPromptRules(),he=[{role:"system",content:ye.replace("{SYSTEM_PROMPT_RULES}",we).replace("{SYSTEM_PROMPT_CONTEXT}",t.systemPrompt||"无系统提示词").replace("{CONVERSATION_HISTORY}",t.conversationHistory||"无对话历史").replace("{USER_DRAFT_PROMPT}",t.draftPrompt).replace("{VARIABLES_SECTION}","").replace("{LANGUAGE}",ae)},{role:"user",content:"请输出优化后的提示词（只输出优化结果，不要解释）"}];if(t.enableQualityAnalysis&&t.result.qualityAnalysis&&t.result.qualityAnalysis.overall_score>0){const V=t.result.qualityAnalysis,le=`

**质量分析结果（请参考以改进）：**
- 整体评分：${V.overall_score}/100
- 清晰度：${(l=V.analysis.clarity)==null?void 0:l.score}/100 - ${(y=V.analysis.clarity)==null?void 0:y.feedback}
- 特定性：${(_=V.analysis.specificity)==null?void 0:_.score}/100 - ${(M=V.analysis.specificity)==null?void 0:M.feedback}
- 结构：${(K=V.analysis.structure)==null?void 0:K.score}/100 - ${(se=V.analysis.structure)==null?void 0:se.feedback}
- 上下文：${(W=V.analysis.context)==null?void 0:W.score}/100 - ${(D=V.analysis.context)==null?void 0:D.feedback}
- 完整性：${(q=V.analysis.completeness)==null?void 0:q.score}/100 - ${(Q=V.analysis.completeness)==null?void 0:Q.feedback}
${V.issues&&V.issues.length>0?`
**发现的问题：**
${V.issues.map((ee,ge)=>`${ge+1}. ${ee}`).join(`
`)}`:""}

请根据以上分析结果，重点改进低分维度，生成优化后的提示词。`;he[0].content+=le}t.isOptimizingPrompt=!0,S.setStreamUpdateCallback(V=>{t.optimizedText+=V});const oe=await S.callAI(he,ue,ce,!0);S.clearStreamUpdateCallback(),t.isOptimizingPrompt=!1,console.log("✅ 重新生成优化完成");const j=performance.now()-n;t.result={...t.result,optimizedPrompt:oe.trim(),metadata:{processingTime:j,modelUsed:z.selectedModel||"unknown",timestamp:new Date}},t.languageState="zh",P(t.result),console.log(`✅ 重新生成完成，耗时: ${j.toFixed(0)}ms`)}catch(ae){console.error("重新生成失败:",ae),t.error=ae.message||"重新生成失败，请重试",t.isOptimizingPrompt=!1}finally{t.isOptimizing=!1}},k=async()=>{var l,y,_,M,K,se,W,D,q,Q;if(!R.value){t.error="请输入草稿提示词";return}t.isOptimizing=!0,t.error=null,t.analysisText="",t.optimizedText="";const n=performance.now();try{const ae=H(t.draftPrompt),ue=z.getAvailableProviders().find(_e=>_e.id===z.selectedProvider),ce=z.selectedModel;if(!ue||!ce)throw new Error("请先在顶部选择AI提供商和模型");const ye=t.conversationHistory?`
**对话上下文：**
${t.conversationHistory}
`:"",Ce=`你是专业的用户提示词质量分析师。

**任务：**分析用户草稿提示词的质量，给出评分和建议。
${t.systemPrompt?`
**AI助手的系统提示词：**
${t.systemPrompt}
`:""}${ye}
**❗️ 重要角色说明 ❗️**
- **系统提示词**（如上所示）是**AI助手**的角色设定，不是用户的角色
- **用户草稿**是用户发给AI助手的消息，用户不需要扮演AI助手的角色
- 例如：AI助手是医生，用户是患者；AI助手是翻译，用户是需要翻译服务的人

**分析原则：**
- ✅ 草稿是否与**对话历史连贯**（例如：AI问"多久了"，用户答"三天了"是连贯的）
- ✅ 草稿是否清晰地向AI助手**提出需求或提供信息**
- ❌ 不要要求用户草稿"符合AI助手的角色"（用户不是AI助手！）
- ❌ 不要要求用户草稿包含AI助手才应该提供的内容（如医生的诊断建议）

**角色立场示例：**

场景：AI助手是医生，对话历史：用户"我牙疼" → AI"牙疼多久了"
- 用户草稿："三天了"
- ❌ 错误分析："不符合AI助手作为医生的角色，无法进行诊断"（用户不是医生！）
- ✅ 正确分析："与对话连贯，但信息过于简略，建议补充症状细节"

**分析维度（基于业界最佳实践）：**
1. **清晰度 (clarity)**: 意图是否明确，表达是否清晰，避免歧义
2. **特定性 (specificity)**: 是否具体，细节是否充分，避免模糊和泛泛而谈
3. **结构 (structure)**: 信息是否有组织，逻辑是否清晰，层次是否分明
4. **上下文 (context)**: 是否提供了足够的背景信息、使用场景、目标受众等；是否与对话历史连贯
5. **完整性 (completeness)**: 是否包含所有必要元素（任务、要求、限制、输出格式等）

**评分标准：**
- 90-100: 优秀，几乎无问题
- 70-89: 良好，有小问题但不影响使用
- 50-69: 一般，有明显问题需要优化
- <50: 差，问题较多必须优化

**输出格式（JSON）：**
\`\`\`json
{
  "overall_score": 75,
  "analysis": {
    "clarity": {
      "score": 80,
      "feedback": "意图基本明确，但某些表述略显模糊"
    },
    "specificity": {
      "score": 60,
      "feedback": "缺少具体细节，过于笼统"
    },
    "structure": {
      "score": 70,
      "feedback": "有基本结构，但层次不够清晰"
    },
    "context": {
      "score": 50,
      "feedback": "未提供背景信息和使用场景"
    },
    "completeness": {
      "score": 65,
      "feedback": "缺少输出格式和一些关键要求"
    }
  },
  "issues": [
    "提示词缺少具体的使用场景和目标受众",
    "未明确输出格式和字数要求",
    "缺少必要的背景信息和约束条件"
  ]
}
\`\`\`

**草稿提示词：**
${t.draftPrompt}

**请直接输出JSON，不要其他内容。**`,he=a.getUserPromptQuickOptimization(),oe=a.getUserPromptRules(),j=he.replace("{SYSTEM_PROMPT_RULES}",oe).replace("{SYSTEM_PROMPT_CONTEXT}",t.systemPrompt||"无系统提示词").replace("{CONVERSATION_HISTORY}",t.conversationHistory||"无对话历史").replace("{USER_DRAFT_PROMPT}",t.draftPrompt).replace("{VARIABLES_SECTION}","").replace("{LANGUAGE}",ae),V=[{role:"system",content:Ce},{role:"user",content:"请分析这个草稿的问题"}],le=[{role:"system",content:j},{role:"user",content:"请输出优化后的提示词（只输出优化结果，不要解释）"}];let ee=null;if(t.enableQualityAnalysis){console.log("🔍 开始质量分析（流式）"),t.isAnalyzing=!0,S.setStreamUpdateCallback(ze=>{t.analysisText+=ze});const _e=await S.callAI(V,ue,ce,!0);if(S.clearStreamUpdateCallback(),t.isAnalyzing=!1,ee=mt(_e),!ee)throw new Error("质量分析结果格式错误");console.log("✅ 质量分析完成，开始优化结果（流式）");const Le=`

**质量分析结果（请参考以改进）：**
- 整体评分：${ee.overall_score}/100
- 清晰度：${(l=ee.analysis.clarity)==null?void 0:l.score}/100 - ${(y=ee.analysis.clarity)==null?void 0:y.feedback}
- 特定性：${(_=ee.analysis.specificity)==null?void 0:_.score}/100 - ${(M=ee.analysis.specificity)==null?void 0:M.feedback}
- 结构：${(K=ee.analysis.structure)==null?void 0:K.score}/100 - ${(se=ee.analysis.structure)==null?void 0:se.feedback}
- 上下文：${(W=ee.analysis.context)==null?void 0:W.score}/100 - ${(D=ee.analysis.context)==null?void 0:D.feedback}
- 完整性：${(q=ee.analysis.completeness)==null?void 0:q.score}/100 - ${(Q=ee.analysis.completeness)==null?void 0:Q.feedback}
${ee.issues&&ee.issues.length>0?`
**发现的问题：**
${ee.issues.map((ze,me)=>`${me+1}. ${ze}`).join(`
`)}`:""}

请根据以上分析结果，重点改进低分维度，生成优化后的提示词。`;le[0].content+=Le}else console.log("⏭️ 跳过质量分析，直接优化");t.isOptimizingPrompt=!0,S.setStreamUpdateCallback(_e=>{t.optimizedText+=_e});const ge=await S.callAI(le,ue,ce,!0);S.clearStreamUpdateCallback(),t.isOptimizingPrompt=!1,console.log("✅ 优化完成");const Ae=performance.now()-n;t.result={originalPrompt:t.draftPrompt,qualityAnalysis:ee||{overall_score:0,analysis:{},issues:[]},optimizedPrompt:ge.trim(),metadata:{processingTime:Ae,modelUsed:z.selectedModel||"unknown",timestamp:new Date}},t.languageState="zh",P(t.result),console.log(`✅ 优化完成，总耗时: ${Ae.toFixed(0)}ms`)}catch(ae){console.error("快速优化失败:",ae),t.error=ae.message||"优化失败，请重试",t.result=null,t.isAnalyzing=!1,t.isOptimizingPrompt=!1,P(null)}finally{t.isOptimizing=!1}},L=async n=>{try{const{copyToClipboard:l}=await st(async()=>{const{copyToClipboard:y}=await import("./SavePromptDialog.vue_vue_type_script_setup_true_lang-Byq4kPDr.js").then(_=>_.a);return{copyToClipboard:y}},__vite__mapDeps([0,1,2]));return await l(n),!0}catch(l){return console.error("复制失败:",l),!1}},g=async n=>{if(!t.result)throw new Error("没有可保存的优化结果");const l="https://api.prompt-ui.xiechengqi.top",y=localStorage.getItem("yprompt_token");if(!y)throw new Error("请先登录后才能保存提示词");try{const _=typeof t.result.optimizedPrompt=="string"?t.result.optimizedPrompt:t.result.optimizedPrompt.zh||t.result.optimizedPrompt.en;let M="";if(n.conversationHistory.trim())try{const q=JSON.parse(n.conversationHistory);M=JSON.stringify(q)}catch{throw new Error("对话历史JSON格式错误")}const K=s.loadedPromptId;console.log("💾 用户提示词保存:",{promptId:K,isUpdate:!!K,title:n.title});const se={...K?{id:K}:{},title:n.title,description:n.description,final_prompt:_,language:"zh",format:"markdown",prompt_type:"user",tags:n.tags,is_public:n.isPublic?1:0,system_prompt:n.systemPrompt,conversation_history:M,create_version:!0,change_type:"patch",change_summary:n.description||"优化用户提示词",change_log:"通过用户提示词快速优化功能更新",version_tag:"stable"};console.log("📤 发送保存请求:",{hasId:!!K,createVersion:!0,changeType:"patch"});const D=await(await fetch(`${l}/api/prompts/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`},body:JSON.stringify(se)})).json();if(D.code!==200)throw new Error(D.message||"保存失败");return console.log("✅ 保存成功:",{id:D.data.id,isNew:D.data.is_new,version:D.data.version,message:D.data.message}),D.data.is_new&&(s.setLoadedPromptId(D.data.id),console.log("🆕 新建提示词,设置loadedPromptId:",D.data.id)),{success:!0,id:D.data.id,version:D.data.version,message:D.data.message}}catch(_){throw console.error("❌ 保存到我的提示词失败:",_),_}},c=()=>{t.draftPrompt="",t.systemPrompt="",t.conversationHistory="",t.result=null,t.error=null,t.languageState="zh"},o=()=>{t.result=null,t.error=null,t.languageState="zh",P(null)};return{state:t,hasInput:R,hasResult:N,hasError:T,quickOptimize:k,regenerateOptimization:w,copyToClipboard:L,saveToLibrary:g,reset:c,clearResult:o,setDraftPrompt:n=>{t.draftPrompt=n,o()},setSystemPrompt:n=>{t.systemPrompt=n},setConversationHistory:n=>{t.conversationHistory=n},toggleLanguage:async()=>{if(!t.result||t.isConvertingLanguage)return;const n=typeof t.result.optimizedPrompt=="string"?t.result.optimizedPrompt:t.languageState==="zh"?t.result.optimizedPrompt.zh:t.result.optimizedPrompt.en;if(!n)return;const l=t.languageState==="zh"?"en":"zh";if(typeof t.result.optimizedPrompt!="string"&&(l==="zh"?t.result.optimizedPrompt.zh:t.result.optimizedPrompt.en)){t.languageState=l,P(t.result),console.log(`✅ 切换为${l==="zh"?"中文":"英文"}（从缓存）`);return}t.isConvertingLanguage=!0;try{const _=z.getAvailableProviders().find(q=>q.id===z.selectedProvider),M=z.selectedModel;if(!_||!M)throw new Error("请先在顶部选择AI提供商和模型");const K=l==="zh"?"中文":"英文",W=[{role:"system",content:`你是一个专业的AI提示词翻译助手。你的任务是将提示词翻译为${K}，同时保持提示词的专业性、准确性和完整性。

**重要规则**：
1. **必须保留所有原有的格式标记**（如 Markdown 的 #、- 或 XML 的标签）
2. **翻译必须准确传达原意**，特别是技术术语和指令
3. **保持提示词的专业语气和结构**
4. **不要添加任何额外的解释或说明**
5. **直接输出翻译结果，不要包含任何前言或后记**
6. **对于专有名词、技术术语，要使用行业标准译法**`},{role:"user",content:`请将以下AI提示词翻译为${K}：

${n}`}],D=await S.callAI(W,_,M,!1);if(D&&D.trim()){const q=D.trim();if(typeof t.result.optimizedPrompt=="string"){const Q=t.result.optimizedPrompt;t.result.optimizedPrompt={zh:t.languageState==="zh"?Q:q,en:t.languageState==="en"?Q:q}}else l==="en"?t.result.optimizedPrompt.en=q:t.result.optimizedPrompt.zh=q;t.languageState=l,P(t.result),console.log(`✅ 翻译为${K}（已缓存）`)}else throw new Error("翻译结果为空")}catch(y){throw console.error("语言转换失败:",y),y}finally{t.isConvertingLanguage=!1}}}}function Xs(){const z=Ye({messages:[]});return{state:z,addMessage:(N="user")=>{const T={id:`msg-${Date.now()}-${Math.random()}`,role:N,content:"",isEditing:!1};z.messages.push(T)},removeMessage:N=>{const T=z.messages.findIndex(H=>H.id===N);T!==-1&&z.messages.splice(T,1)},updateMessage:(N,T)=>{const H=z.messages.find(w=>w.id===N);H&&(H.content=T)},updateMessageRole:(N,T)=>{const H=z.messages.find(w=>w.id===N);H&&(H.role=T)},startEdit:N=>{z.messages.forEach(T=>{T.isEditing=T.id===N})},cancelEdit:N=>{const T=z.messages.find(H=>H.id===N);T&&(T.isEditing=!1)},formatForAI:()=>z.messages.length===0?"":z.messages.filter(N=>N.content.trim()).map(N=>`${N.role==="ai"?"AI助手":"用户"}: ${N.content}`).join(`

`),reset:()=>{z.messages=[]}}}const Ws={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col"},Zs={class:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700"},eo={class:"flex-1 overflow-y-auto p-4"},to=["value"],so={class:"flex items-center justify-end gap-3 p-4 border-t border-gray-200 dark:border-gray-700"},oo=Se({__name:"SystemPromptModal",props:{isOpen:{type:Boolean},modelValue:{}},emits:["close","update:modelValue","save"],setup(z,{emit:s}){const a=s,S=()=>{a("save"),a("close")};return(r,h)=>r.isOpen?(i(),p("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:h[3]||(h[3]=ot(P=>r.$emit("close"),["self"]))},[e("div",Ws,[e("div",Zs,[h[4]||(h[4]=e("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"系统提示词设置",-1)),e("button",{onClick:h[0]||(h[0]=P=>r.$emit("close")),class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"},[B(b(rt),{class:"w-5 h-5"})])]),e("div",eo,[h[5]||(h[5]=e("p",{class:"text-sm text-gray-600 dark:text-gray-400 mb-3"}," 设置系统提示词可以帮助AI更好地理解对话上下文，提供更准确的优化建议。 ",-1)),e("textarea",{value:r.modelValue,onInput:h[1]||(h[1]=P=>r.$emit("update:modelValue",P.target.value)),class:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white",rows:"8",placeholder:"例如：你是一个专业的编程助手，擅长解决代码问题和提供技术建议。"},null,40,to)]),e("div",so,[e("button",{onClick:h[2]||(h[2]=P=>r.$emit("close")),class:"px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),e("button",{onClick:S,class:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"}," 确定 ")])])])):E("",!0)}}),ro={class:"h-full flex flex-col bg-white rounded-lg shadow-sm border border-gray-200"},ao={class:"p-4 border-b border-gray-200 flex-shrink-0"},lo={class:"flex justify-between items-center"},no={class:"flex items-center space-x-3"},io=["title"],uo={class:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0"},co={key:0,class:"flex-shrink-0"},mo={class:"flex flex-col w-full"},po={key:0,class:"relative"},go={class:"relative border border-blue-300 rounded-2xl overflow-hidden bg-white"},vo={class:"relative"},fo=["value","onInput","onKeydown"],yo={key:0,class:"text-sm opacity-50"},ho={key:1,class:"text-sm whitespace-pre-wrap break-words"},xo=["onClick"],bo=["onClick"],wo=["onClick"],_o=["onClick","title"],Po=["onClick"],ko=["onClick"],$o={key:0,class:"flex items-center justify-center h-full text-center py-12"},So={class:"p-3 border-t border-gray-200 bg-white flex-shrink-0 rounded-b-lg"},Co={class:"flex items-center gap-2 mb-2"},zo={class:"text-xs text-gray-500"},Mo={class:"relative border border-gray-300 rounded-2xl focus-within:outline-none focus-within:border-gray-300 overflow-hidden",style:{height:"120px"}},Io={class:"absolute top-0 left-0 right-0",style:{bottom:"48px"}},Ao={class:"absolute bottom-0 left-0 right-0 h-12 flex justify-between items-center px-2 bg-transparent"},Oo={class:"text-xs text-gray-500 ml-2"},To={key:0,class:"ml-2 text-blue-600"},Lo={class:"flex gap-2"},Uo=["disabled"],Eo=["disabled"],Ge="user_prompt_optimize_data",Ro=Se({__name:"QuickOptimizeInput",props:{modelValue:{},systemPrompt:{},conversationHistory:{},isOptimizing:{type:Boolean}},emits:["update:modelValue","update:systemPrompt","update:conversationHistory","optimize","restart"],setup(z,{emit:s}){const a=z,S=s,r=Xs(),h=f(!1),P=f(a.systemPrompt),t=f("user"),R=f(""),N=()=>{if(a.conversationHistory.trim())try{const u=JSON.parse(a.conversationHistory);if(Array.isArray(u)&&(r.state.messages=u.map((x,n)=>({id:`msg-${Date.now()}-${n}`,role:x.role==="assistant"?"ai":"user",content:x.content,isEditing:!1})),a.modelValue.trim())){r.addMessage("user");const x=r.state.messages[r.state.messages.length-1];r.updateMessage(x.id,a.modelValue)}}catch(u){console.error("解析对话历史JSON失败:",u)}else if(a.modelValue.trim()){r.addMessage("user");const u=r.state.messages[r.state.messages.length-1];r.updateMessage(u.id,a.modelValue)}};Be(()=>{if(!localStorage.getItem("yprompt_optimize_loaded_user_prompt"))try{const x=localStorage.getItem(Ge);if(x){const n=JSON.parse(x);n.messages&&(r.state.messages=n.messages),n.systemPrompt&&(P.value=n.systemPrompt,S("update:systemPrompt",n.systemPrompt))}}catch(x){console.error("加载保存数据失败:",x)}});let T=!1;Z(()=>a.conversationHistory,(u,x)=>{!T&&u!==x&&N()}),Z(()=>a.modelValue,(u,x)=>{var n;!T&&u!==x&&(u!=null&&u.trim())&&!((n=a.conversationHistory)!=null&&n.trim())&&N()});const H=()=>{try{const u={messages:r.state.messages,systemPrompt:P.value};localStorage.setItem(Ge,JSON.stringify(u))}catch(u){console.error("保存数据失败:",u)}};Z(()=>a.systemPrompt,u=>{P.value=u}),Z(()=>r.state.messages,()=>{if(T=!0,r.state.messages.length>1){const x=r.state.messages.slice(0,-1).filter(n=>n.content.trim()).map(n=>({role:n.role==="ai"?"assistant":"user",content:n.content}));S("update:conversationHistory",JSON.stringify(x,null,2))}else S("update:conversationHistory","");if(r.state.messages.length>0){const u=r.state.messages[r.state.messages.length-1];S("update:modelValue",u.content)}else S("update:modelValue","");H(),setTimeout(()=>{T=!1},0)},{deep:!0});const w=()=>{if(!R.value.trim())return;const u=t.value;r.addMessage(u);const x=r.state.messages[r.state.messages.length-1];r.updateMessage(x.id,R.value),R.value=""},k=u=>{u.key==="Enter"&&u.shiftKey||u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),w())},L=(u,x)=>{u.key==="Enter"&&u.shiftKey||(u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),r.cancelEdit(x),H()),u.key==="Escape"&&r.cancelEdit(x))},g=()=>{r.state.messages.length===0||a.isOptimizing||S("optimize")},c=()=>{confirm("确定要重新开始吗？这将清除所有对话历史、系统提示词和优化结果。")&&(r.reset(),R.value="",P.value="",S("update:modelValue",""),S("update:systemPrompt",""),S("update:conversationHistory",""),S("restart"),localStorage.removeItem(Ge))},o=()=>{S("update:systemPrompt",P.value),H()},I=async u=>{try{await De(u)}catch(x){console.error("复制失败:",x)}},C=u=>u<=20?"短草稿":u<=100?"中等草稿":u<=300?"长草稿":"超长草稿";return(u,x)=>(i(),p("div",ro,[e("div",ao,[e("div",lo,[x[6]||(x[6]=e("h4",{class:"font-semibold text-gray-800"},"构建对话上下文",-1)),e("div",no,[e("button",{onClick:x[0]||(x[0]=n=>h.value=!0),class:Y(["flex items-center gap-1 px-2 py-1 hover:bg-gray-100 rounded transition-colors text-sm",P.value.trim()?"text-green-600":"text-gray-400"]),title:P.value.trim()?"系统提示词已设置":"设置系统提示词"},[B(b(qe),{class:"w-4 h-4"}),e("span",null,A(P.value.trim()?"系统提示词已设置":"设置系统提示词"),1)],10,io),e("button",{onClick:c,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"重新开始"},[B(b($e),{class:"w-4 h-4"}),x[5]||(x[5]=e("span",null,"重新开始",-1))])])])]),e("div",uo,[(i(!0),p(ie,null,de(b(r).state.messages,n=>(i(),p("div",{key:n.id,class:Y(["flex group",n.role==="user"?"justify-end":"justify-start"])},[e("div",{class:Y(["flex flex-col w-full",n.isEditing?"max-w-full sm:max-w-2xl":"max-w-xs lg:max-w-md"])},[e("div",{class:Y(["flex gap-2",[n.role==="user"?"flex-row-reverse":"flex-row",n.isEditing&&"items-start"]])},[n.isEditing?E("",!0):(i(),p("div",co,[e("div",{class:Y(["w-8 h-8 rounded-full flex items-center justify-center text-sm",n.role==="user"?"bg-blue-100 text-blue-700":"bg-gray-200 text-gray-700"])},A(n.role==="user"?"👤":"🤖"),3)])),e("div",mo,[n.isEditing?(i(),p("div",po,[e("div",go,[e("div",vo,[e("textarea",{value:n.content,onInput:l=>b(r).updateMessage(n.id,l.target.value),onKeydown:l=>L(l,n.id),class:"w-full p-4 border-0 resize-none focus:outline-none text-gray-800 bg-white min-h-[80px] max-h-[200px] overflow-y-auto text-base",placeholder:"编辑消息内容..."},null,40,fo)])])])):(i(),p("div",{key:1,class:Y(["rounded-lg px-4 py-3 transition-all duration-300",[n.role==="user"?"bg-blue-500 text-white":"bg-gray-100 text-gray-800",n.role==="user"?"ml-auto":"mr-auto"]])},[n.content?(i(),p("div",ho,A(n.content),1)):(i(),p("div",yo,A(n.role==="ai"?"输入AI助手的回复...":"输入你的消息..."),1))],2)),e("div",{class:Y(["flex space-x-1 mt-2 transition-opacity duration-200",[n.isEditing?"opacity-100 justify-end":"opacity-0 group-hover:opacity-100 "+(n.role==="user"?"justify-end":"justify-start")]])},[n.isEditing?(i(),p(ie,{key:0},[e("button",{onClick:l=>b(r).cancelEdit(n.id),class:"p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100",title:"取消编辑"},[B(b(rt),{class:"w-3.5 h-3.5"})],8,xo),e("button",{onClick:l=>{b(r).cancelEdit(n.id),H()},class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100",title:"保存"},[B(b(dt),{class:"w-3.5 h-3.5"})],8,bo)],64)):(i(),p(ie,{key:1},[e("button",{onClick:l=>b(r).startEdit(n.id),class:"p-1.5 text-gray-500 hover:text-green-600 transition-colors rounded-lg hover:bg-gray-100",title:"编辑消息"},[B(b(Pt),{class:"w-3.5 h-3.5"})],8,wo),e("button",{onClick:l=>{b(r).updateMessageRole(n.id,n.role==="user"?"ai":"user"),H()},class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100",title:n.role==="user"?"切换为AI助手":"切换为用户"},[B(b(ct),{class:"w-3.5 h-3.5"})],8,_o),e("button",{onClick:l=>{b(r).removeMessage(n.id),H()},class:"p-1.5 text-gray-500 hover:text-red-600 transition-colors rounded-lg hover:bg-gray-100",title:"删除消息"},[B(b(kt),{class:"w-3.5 h-3.5"})],8,Po),e("button",{onClick:l=>I(n.content),class:"p-1.5 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100",title:"复制内容"},[B(b(at),{class:"w-3.5 h-3.5"})],8,ko)],64))],2)])],2)],2)],2))),128)),b(r).state.messages.length===0?(i(),p("div",$o,[e("div",null,[B(b(Qe),{class:"w-12 h-12 mx-auto mb-3 text-gray-300"}),x[7]||(x[7]=e("p",{class:"text-sm text-gray-500 mb-1"},"暂无对话历史",-1)),x[8]||(x[8]=e("p",{class:"text-xs text-gray-400"},"在下方输入框添加对话消息构建上下文",-1))])])):E("",!0)]),e("div",So,[e("div",Co,[ne(e("select",{"onUpdate:modelValue":x[1]||(x[1]=n=>t.value=n),class:"text-xs px-2 py-1 border border-gray-300 rounded bg-white text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[...x[9]||(x[9]=[e("option",{value:"user"},"👤 用户",-1),e("option",{value:"ai"},"🤖 AI助手",-1)])],512),[[Re,t.value]]),e("span",zo,A(t.value==="user"?"以用户身份发送消息":"以AI助手身份发送消息"),1)]),e("div",Mo,[e("div",Io,[ne(e("textarea",{"onUpdate:modelValue":x[2]||(x[2]=n=>R.value=n),onKeydown:k,placeholder:"输入消息内容 (Shift+Enter换行)",class:"w-full h-full px-4 pt-3 pb-1 border-0 outline-none resize-none text-base overflow-y-auto bg-transparent text-gray-800",rows:"1"},null,544),[[fe,R.value]])]),e("div",Ao,[e("div",Oo,[re(A(R.value.length)+" 字 ",1),R.value.length>0?(i(),p("span",To," · "+A(C(R.value.length)),1)):E("",!0)]),e("div",Lo,[e("button",{onClick:w,disabled:!R.value.trim(),class:"w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center",title:"发送消息到对话历史"},[B(b(Ne),{class:"w-4 h-4"})],8,Uo),e("button",{onClick:g,disabled:b(r).state.messages.length===0||u.isOptimizing,class:"px-4 py-1.5 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white text-sm rounded-full transition-colors disabled:cursor-not-allowed",title:"开始优化最后一条消息"},A(u.isOptimizing?"优化中...":"优化"),9,Eo)])])])]),B(oo,{"is-open":h.value,modelValue:P.value,"onUpdate:modelValue":x[3]||(x[3]=n=>P.value=n),onClose:x[4]||(x[4]=n=>h.value=!1),onSave:o},null,8,["is-open","modelValue"])]))}}),jo={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},Ho={class:"p-6 space-y-4"},Vo={class:"mt-1 text-xs text-gray-500"},No={class:"mt-1 text-xs text-gray-500"},Do={class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},Jo={key:0,class:"flex items-center gap-1 text-green-600 text-xs"},Bo={key:1,class:"flex items-center gap-1 text-gray-400 text-xs"},Fo={class:"mt-1 text-xs text-gray-500"},Go={key:0,class:"mt-1 text-xs text-red-600"},Ko={key:1,class:"mt-1 text-xs text-gray-500"},qo={key:2,class:"mt-2 p-3 bg-blue-50 border border-blue-200 rounded text-xs"},Qo={class:"flex flex-wrap gap-2 mb-2"},Yo=["onClick"],Xo={class:"flex gap-2"},Wo={class:"flex items-center"},Zo={class:"p-3 bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto text-sm text-gray-600 font-mono"},er={class:"mt-1 text-xs text-gray-500"},tr={class:"flex justify-end gap-3 p-6 border-t bg-gray-50"},sr=["disabled"],or={key:0,class:"flex items-center"},rr={key:1},ar=`[
  {
    "role": "user",
    "content": "我牙疼"
  },
  {
    "role": "assistant",
    "content": "牙疼多久了？有什么特别的症状吗？"
  },
  {
    "role": "user",
    "content": "三天了，主要是吃冷热食物时特别疼"
  }
]`,lr=Se({__name:"SaveUserPromptDialog",props:{isOpen:{type:Boolean},promptContent:{},systemPrompt:{},conversationHistory:{},isSaving:{type:Boolean}},emits:["save","cancel"],setup(z,{emit:s}){const a=z,S=s,r=f({title:"",description:"",systemPrompt:"",conversationHistory:"",tags:["用户提示词","快速优化"],isPublic:!1}),h=f(""),P=f(!1),t=f(""),R=g=>{if(!g.trim())return"";try{const c=JSON.parse(g);if(!Array.isArray(c))return"必须是数组格式";for(let o=0;o<c.length;o++){const I=c[o];if(!I.role||!I.content)return`第${o+1}条消息缺少role或content字段`;if(!["user","assistant","system"].includes(I.role))return`第${o+1}条消息的role必须是user、assistant或system`}return""}catch(c){return c.message||"JSON格式错误"}};Z(()=>r.value.conversationHistory,g=>{t.value=R(g)});const N=()=>{try{const g=JSON.parse(r.value.conversationHistory);r.value.conversationHistory=JSON.stringify(g,null,2),t.value=""}catch{t.value="JSON格式错误，无法格式化"}},T=G(()=>r.value.title.trim()&&a.promptContent&&!t.value);Z(()=>a.isOpen,g=>{if(g){const c=a.promptContent.substring(0,50);r.value.title=`用户提示词 - ${c}${a.promptContent.length>50?"...":""}`,r.value.description="",r.value.systemPrompt=a.systemPrompt||"",r.value.conversationHistory=a.conversationHistory||"",r.value.tags=["用户提示词","快速优化"],r.value.isPublic=!1,t.value="",P.value=!1}});const H=()=>{const g=h.value.trim();g&&!r.value.tags.includes(g)&&r.value.tags.length<10&&(r.value.tags.push(g),h.value="")},w=g=>{r.value.tags=r.value.tags.filter(c=>c!==g)},k=()=>{T.value&&S("save",{title:r.value.title.trim(),description:r.value.description.trim(),tags:r.value.tags,isPublic:r.value.isPublic,systemPrompt:r.value.systemPrompt.trim(),conversationHistory:r.value.conversationHistory.trim()})},L=()=>{S("cancel")};return(g,c)=>g.isOpen?(i(),p("div",jo,[e("div",{class:"bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",onClick:c[7]||(c[7]=ot(()=>{},["stop"]))},[e("div",{class:"flex items-center justify-between p-6 border-b"},[c[9]||(c[9]=e("h2",{class:"text-xl font-semibold text-gray-900"},"保存用户提示词",-1)),e("button",{onClick:L,class:"text-gray-400 hover:text-gray-600"},[...c[8]||(c[8]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",Ho,[e("div",null,[c[10]||(c[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[re(" 标题 "),e("span",{class:"text-red-500"},"*")],-1)),ne(e("input",{"onUpdate:modelValue":c[0]||(c[0]=o=>r.value.title=o),type:"text",placeholder:"请输入提示词标题",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",maxlength:"200"},null,512),[[fe,r.value.title]]),e("p",Vo,A(r.value.title.length)+"/200",1)]),e("div",null,[c[11]||(c[11]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," 描述 ",-1)),ne(e("textarea",{"onUpdate:modelValue":c[1]||(c[1]=o=>r.value.description=o),placeholder:"简短描述这个提示词的用途（可选）",rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",maxlength:"500"},null,512),[[fe,r.value.description]]),e("p",No,A(r.value.description.length)+"/500",1)]),e("div",null,[e("label",Do,[c[14]||(c[14]=e("span",null,"系统提示词（AI助手角色）",-1)),r.value.systemPrompt.trim()?(i(),p("span",Jo,[...c[12]||(c[12]=[e("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1),re(" 系统提示词已设置 ",-1)])])):(i(),p("span",Bo,[...c[13]||(c[13]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),re(" 设置系统提示词（可选） ",-1)])]))]),ne(e("textarea",{"onUpdate:modelValue":c[2]||(c[2]=o=>r.value.systemPrompt=o),placeholder:"输入AI助手的系统提示词（可选）",rows:"4",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm",maxlength:"5000"},null,512),[[fe,r.value.systemPrompt]]),e("p",Fo,A(r.value.systemPrompt.length)+"/5000 字符",1)]),e("div",null,[c[16]||(c[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[re(" 对话上下文 "),e("span",{class:"text-xs text-gray-500 ml-2"},"(严格JSON格式，可将来复用)")],-1)),ne(e("textarea",{"onUpdate:modelValue":c[3]||(c[3]=o=>r.value.conversationHistory=o),placeholder:'请输入对话历史，格式：[{"role":"user","content":"..."},{"role":"assistant","content":"..."}]',rows:"6",class:Y(["w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-xs",{"border-red-500":t.value}])},null,2),[[fe,r.value.conversationHistory]]),t.value?(i(),p("p",Go," ⚠️ JSON格式错误："+A(t.value),1)):(i(),p("p",Ko,[re(A(r.value.conversationHistory.length)+"/10000 字符 ",1),r.value.conversationHistory?(i(),p("button",{key:0,onClick:N,class:"ml-2 text-blue-600 hover:text-blue-700 underline"}," 格式化 ")):E("",!0),e("button",{onClick:c[4]||(c[4]=o=>P.value=!P.value),class:"ml-2 text-blue-600 hover:text-blue-700 underline"},A(P.value?"隐藏":"查看")+"示例 ",1)])),P.value?(i(),p("div",qo,[c[15]||(c[15]=e("p",{class:"font-semibold mb-1"},"标准格式示例：",-1)),e("pre",{class:"bg-white p-2 rounded overflow-x-auto"},A(ar))])):E("",!0)]),e("div",null,[c[17]||(c[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," 标签 ",-1)),e("div",Qo,[(i(!0),p(ie,null,de(r.value.tags,o=>(i(),p("span",{key:o,class:"inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"},[re(A(o)+" ",1),e("button",{onClick:I=>w(o),class:"ml-2 text-blue-500 hover:text-blue-700"},"×",8,Yo)]))),128))]),e("div",Xo,[ne(e("input",{"onUpdate:modelValue":c[5]||(c[5]=o=>h.value=o),type:"text",placeholder:"输入标签后按回车添加",onKeyup:ht(H,["enter"]),class:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,544),[[fe,h.value]]),e("button",{onClick:H,class:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"}," 添加 ")])]),e("div",Wo,[ne(e("input",{"onUpdate:modelValue":c[6]||(c[6]=o=>r.value.isPublic=o),type:"checkbox",id:"isPublic",class:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"},null,512),[[lt,r.value.isPublic]]),c[18]||(c[18]=e("label",{for:"isPublic",class:"ml-2 text-sm text-gray-700"}," 公开分享（其他用户可以看到完整的系统提示词和对话记录） ",-1))]),e("div",null,[c[19]||(c[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[re(" 用户提示词内容 "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Zo,A(g.promptContent.slice(0,200))+A(g.promptContent.length>200?"...":""),1),e("p",er,"共 "+A(g.promptContent.length)+" 个字符",1)])]),e("div",tr,[e("button",{onClick:L,class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"}," 取消 "),e("button",{onClick:k,disabled:!T.value||g.isSaving,class:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center"},[g.isSaving?(i(),p("span",or,[...c[20]||(c[20]=[e("svg",{class:"w-4 h-4 mr-2 animate-spin",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),re(" 保存中... ",-1)])])):(i(),p("span",rr,"保存"))],8,sr)])])])):E("",!0)}}),nr={class:"h-full min-h-0 overflow-hidden grid grid-cols-2 gap-4"},ir={class:"flex flex-col min-h-0"},ur={class:"flex flex-col min-h-0"},dr={class:"bg-white rounded-lg shadow-sm flex flex-col h-full min-h-0 overflow-hidden"},cr={class:"p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0"},mr={class:"flex items-center space-x-2"},pr={class:"flex items-center cursor-pointer"},gr=["disabled"],vr={key:0,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},fr={class:"flex-1 flex items-center justify-center"},yr={class:"text-center text-gray-400"},hr={key:1,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},xr={key:0,class:"flex space-x-2 mb-4 flex-shrink-0"},br={key:1,class:"flex-1 flex flex-col min-h-0"},wr={key:0,class:"flex-1 flex flex-col overflow-hidden"},_r={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},Pr={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},kr={key:1,class:"flex-1 flex flex-col min-h-0"},$r={class:"flex-1 overflow-y-auto space-y-4 pr-2"},Sr={class:"border border-gray-200 rounded-lg p-4"},Cr={class:"flex items-center justify-between mb-3"},zr={class:"w-full bg-gray-200 rounded-full h-3"},Mr={class:"grid grid-cols-2 gap-3"},Ir={class:"flex items-center justify-between mb-2"},Ar={class:"text-xs font-medium text-gray-700"},Or={class:"text-xs text-gray-600"},Tr={key:0,class:"border border-orange-200 bg-orange-50 rounded-lg p-4"},Lr={class:"space-y-2"},Ur={class:"text-orange-600 mr-2 flex-shrink-0"},Er={class:"flex-1"},Rr={key:2,class:"flex-1 flex flex-col min-h-0"},jr={key:0,class:"flex-1 flex flex-col overflow-hidden"},Hr={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},Vr={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},Nr={key:1,class:"border rounded-lg overflow-hidden flex flex-col flex-1"},Dr={class:"bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 flex items-center justify-between flex-shrink-0"},Jr={class:"flex items-center space-x-2"},Br=["disabled"],Fr={class:"p-3 bg-white flex-1 flex flex-col overflow-hidden"},Gr={key:0,class:"space-y-2 pt-4 flex-shrink-0"},Kr={class:"flex space-x-2"},qr=["disabled"],Qr=["disabled"],Yr={class:"flex"},Te="yprompt_user_optimize_active_tab",Xr=Se({__name:"UserPromptQuickOptimize",setup(z){const s=Ys(),a=nt(),S=f("analysis"),r=f(!1),h=f(!1),P=f(""),t=f(!1);try{const l=localStorage.getItem(Te);l&&["analysis","result"].includes(l)&&(S.value=l)}catch(l){console.error("读取activeTab失败:",l)}const R=G(()=>!s.state.isOptimizing&&!s.hasResult.value?0:s.state.enableQualityAnalysis?s.state.isAnalyzing?1:!s.state.isAnalyzing&&(s.state.isOptimizingPrompt||s.hasResult.value)?2:0:s.state.isOptimizingPrompt||s.hasResult.value?2:0),N=async()=>{const l=s.state.enableQualityAnalysis?"analysis":"result";S.value=l,localStorage.setItem(Te,l),await s.quickOptimize()},T=async()=>{S.value="result",localStorage.setItem(Te,"result"),await s.regenerateOptimization()},H=async l=>{await s.copyToClipboard(l)?(r.value=!0,a.success("已复制到剪贴板"),setTimeout(()=>r.value=!1,2e3)):a.error("复制失败")},w=()=>{t.value=!0},k=async l=>{h.value=!0;try{const y=await s.saveToLibrary(l);typeof y=="object"&&y.version?a.success(`提示词已更新至版本 ${y.version}`):a.success("已保存到我的提示词"),t.value=!1}catch(y){a.error(y.message||"保存失败")}finally{h.value=!1}},L=()=>{t.value=!1};Z(()=>s.state.isAnalyzing,(l,y)=>{y&&!l&&s.state.isOptimizingPrompt&&setTimeout(()=>{S.value="result",localStorage.setItem(Te,"result")},300)}),Z(S,l=>{try{localStorage.setItem(Te,l)}catch(y){console.error("保存activeTab失败:",y)}});const g=G(()=>{var l;return(l=s.state.result)!=null&&l.optimizedPrompt?typeof s.state.result.optimizedPrompt=="string"?s.state.result.optimizedPrompt:s.state.languageState==="zh"?s.state.result.optimizedPrompt.zh:s.state.result.optimizedPrompt.en:""});Z(g,l=>{l&&(P.value=l)},{immediate:!0});const c=l=>l>=90?"text-green-600":l>=70?"text-blue-600":l>=50?"text-yellow-600":"text-red-600",o=l=>l>=90?"bg-green-500":l>=70?"bg-blue-500":l>=50?"bg-yellow-500":"bg-red-500",I=l=>({clarity:"清晰度",specificity:"特定性",structure:"结构",context:"上下文",completeness:"完整性"})[l]||l,C=async()=>{try{await s.toggleLanguage(),a.success("语言转换成功")}catch(l){a.error(l.message||"语言转换失败")}},u=()=>{s.clearResult(),S.value="analysis",localStorage.setItem(Te,"analysis"),r.value=!1,P.value="",a.success("已重置所有数据")},x=()=>{if(!s.state.draftPrompt||!s.hasResult.value||!s.state.result){a.warning("需要先完成优化才能对比");return}const l=typeof s.state.result.optimizedPrompt=="string"?s.state.result.optimizedPrompt:s.state.languageState==="zh"?s.state.result.optimizedPrompt.zh:s.state.result.optimizedPrompt.en,y={mode:"user",systemPrompt:s.state.systemPrompt||"",originalPrompt:s.state.draftPrompt,optimizedPrompt:l,conversationHistory:s.state.conversationHistory||""};localStorage.setItem("yprompt_comparison_data",JSON.stringify(y)),localStorage.setItem("yprompt_trigger_compare","true"),console.log("🔵 准备用户提示词对比:",y)},n=()=>{var l,y,_,M,K,se;try{const W=localStorage.getItem("yprompt_optimize_loaded_user_prompt");if(W){const D=JSON.parse(W);console.log("🟢 UserPromptQuickOptimize: 从库加载数据:",{draftPrompt:(l=D.draftPrompt)==null?void 0:l.substring(0,50),systemPrompt:(y=D.systemPrompt)==null?void 0:y.substring(0,50),conversationHistory:(_=D.conversationHistory)==null?void 0:_.substring(0,50)}),s.setDraftPrompt(D.draftPrompt||""),s.setSystemPrompt(D.systemPrompt||""),s.setConversationHistory(D.conversationHistory||""),console.log("🟢 已设置到optimizeState:",{draftPrompt:(M=s.state.draftPrompt)==null?void 0:M.substring(0,50),systemPrompt:(K=s.state.systemPrompt)==null?void 0:K.substring(0,50),conversationHistory:(se=s.state.conversationHistory)==null?void 0:se.substring(0,50)}),localStorage.removeItem("yprompt_optimize_loaded_user_prompt")}}catch(W){console.error("加载用户提示词失败:",W)}};return Be(()=>{n()}),Z(()=>localStorage.getItem("yprompt_optimize_loaded_user_prompt"),l=>{l&&requestAnimationFrame(()=>{n()})},{immediate:!1}),(l,y)=>(i(),p(ie,null,[e("div",nr,[e("div",ir,[B(Ro,{modelValue:b(s).state.draftPrompt,"onUpdate:modelValue":y[0]||(y[0]=_=>b(s).state.draftPrompt=_),"system-prompt":b(s).state.systemPrompt,"onUpdate:systemPrompt":y[1]||(y[1]=_=>b(s).state.systemPrompt=_),"conversation-history":b(s).state.conversationHistory,"onUpdate:conversationHistory":y[2]||(y[2]=_=>b(s).state.conversationHistory=_),"is-optimizing":b(s).state.isOptimizing,onOptimize:N,onRestart:u},null,8,["modelValue","system-prompt","conversation-history","is-optimizing"])]),e("div",ur,[e("div",dr,[e("div",cr,[y[10]||(y[10]=e("h4",{class:"font-semibold text-gray-800"},"优化预览",-1)),e("div",mr,[e("label",pr,[ne(e("input",{"onUpdate:modelValue":y[3]||(y[3]=_=>b(s).state.enableQualityAnalysis=_),disabled:b(s).state.isOptimizing,type:"checkbox",class:"sr-only peer"},null,8,gr),[[lt,b(s).state.enableQualityAnalysis]]),y[8]||(y[8]=e("span",{class:"text-sm text-gray-600 mr-2"},"质量分析：",-1)),y[9]||(y[9]=e("div",{class:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"},null,-1))])])]),R.value===0?(i(),p("div",vr,[e("div",fr,[e("div",yr,[B(b(At),{class:"w-16 h-16 mx-auto mb-4 opacity-50"}),y[11]||(y[11]=e("p",{class:"text-sm"},'输入草稿提示词后点击"开始优化"',-1))])])])):E("",!0),R.value>=1?(i(),p("div",hr,[b(s).state.enableQualityAnalysis?(i(),p("div",xr,[e("button",{onClick:y[4]||(y[4]=_=>S.value="analysis"),class:Y(["px-4 py-2 rounded-lg font-medium transition-colors text-sm",S.value==="analysis"?"bg-blue-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])}," 质量分析 ",2),R.value>=2?(i(),p("button",{key:0,onClick:y[5]||(y[5]=_=>S.value="result"),class:Y(["px-4 py-2 rounded-lg font-medium transition-colors text-sm",S.value==="result"?"bg-green-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])}," 优化结果 ",2)):E("",!0)])):E("",!0),b(s).state.enableQualityAnalysis&&S.value==="analysis"?(i(),p("div",br,[b(s).state.isAnalyzing?(i(),p("div",wr,[e("div",_r,[e("pre",Pr,A(b(s).state.analysisText||"AI正在分析中..."),1)])])):b(s).hasResult.value?(i(),p("div",kr,[e("div",$r,[e("div",Sr,[e("div",Cr,[y[12]||(y[12]=e("h4",{class:"text-sm font-medium text-gray-700"},"整体评分",-1)),e("span",{class:Y([c(b(s).state.result.qualityAnalysis.overall_score),"text-2xl font-bold"])},A(b(s).state.result.qualityAnalysis.overall_score)+"/100 ",3)]),e("div",zr,[e("div",{class:Y([o(b(s).state.result.qualityAnalysis.overall_score),"h-3 rounded-full transition-all duration-500"]),style:it({width:`${b(s).state.result.qualityAnalysis.overall_score}%`})},null,6)])]),e("div",Mr,[(i(!0),p(ie,null,de(b(s).state.result.qualityAnalysis.analysis,(_,M)=>(i(),p("div",{key:String(M),class:"border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow"},[e("div",Ir,[e("span",Ar,A(I(String(M))),1),e("span",{class:Y(["text-lg font-bold",c((_==null?void 0:_.score)??0)])},A((_==null?void 0:_.score)??0),3)]),e("p",Or,A((_==null?void 0:_.feedback)??""),1)]))),128))]),b(s).state.result.qualityAnalysis.issues&&b(s).state.result.qualityAnalysis.issues.length>0?(i(),p("div",Tr,[y[13]||(y[13]=e("h4",{class:"text-sm font-semibold text-orange-900 mb-3 flex items-center"},[e("svg",{class:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})]),re(" 发现的具体问题 ")],-1)),e("ul",Lr,[(i(!0),p(ie,null,de(b(s).state.result.qualityAnalysis.issues,(_,M)=>(i(),p("li",{key:M,class:"text-sm text-orange-800 flex items-start"},[e("span",Ur,A(M+1)+".",1),e("span",Er,A(_),1)]))),128))])])):E("",!0)])])):E("",!0)])):E("",!0),!b(s).state.enableQualityAnalysis||S.value==="result"?(i(),p("div",Rr,[b(s).state.isOptimizingPrompt?(i(),p("div",jr,[e("div",Hr,[e("pre",Vr,A(b(s).state.optimizedText||"AI正在优化中..."),1)])])):b(s).hasResult.value?(i(),p("div",Nr,[e("div",Dr,[y[14]||(y[14]=e("span",null,"最终提示词",-1)),e("div",Jr,[e("button",{onClick:T,disabled:b(s).state.isOptimizing,class:"text-blue-500 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",title:"重新生成"},[B(b($e),{class:Y(["w-4 h-4",b(s).state.isOptimizing&&"animate-spin"])},null,8,["class"])],8,Br),e("button",{onClick:y[6]||(y[6]=_=>H(g.value)),class:"text-blue-500 hover:text-blue-600",title:"复制到剪贴板"},[r.value?(i(),be(b(dt),{key:0,class:"w-4 h-4"})):(i(),be(b(at),{key:1,class:"w-4 h-4"}))])])]),e("div",Fr,[ne(e("textarea",{"onUpdate:modelValue":y[7]||(y[7]=_=>P.value=_),class:"w-full flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none"},null,512),[[fe,P.value]]),g.value?(i(),p("div",Gr,[e("div",Kr,[e("button",{onClick:C,disabled:b(s).state.isConvertingLanguage,class:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[b(s).state.isConvertingLanguage?(i(),be(b($e),{key:0,class:"w-4 h-4 animate-spin"})):E("",!0),e("span",null,A(b(s).state.isConvertingLanguage?"转换中...":b(s).state.languageState==="zh"?"转为英文":"转为中文"),1)],8,qr),e("button",{onClick:w,disabled:h.value,class:"flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[h.value?(i(),be(b($e),{key:0,class:"w-4 h-4 animate-spin"})):E("",!0),e("span",null,A(h.value?"保存中...":"保存到数据库"),1)],8,Qr)]),e("div",Yr,[e("button",{onClick:x,class:"w-full flex items-center justify-center space-x-1 px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[B(b(ct),{class:"w-4 h-4"}),y[15]||(y[15]=e("span",null,"对比优化效果",-1))])])])):E("",!0)])])):E("",!0)])):E("",!0)])):E("",!0)])])]),B(lr,{"is-open":t.value,"prompt-content":g.value,"system-prompt":b(s).state.systemPrompt,"conversation-history":b(s).state.conversationHistory,"is-saving":h.value,onSave:k,onCancel:L},null,8,["is-open","prompt-content","system-prompt","conversation-history","is-saving"])],64))}}),Wr={key:2,class:"w-full h-full min-h-0 overflow-hidden flex flex-row gap-4"},Zr={class:"flex flex-col flex-1 min-h-0"},ea={class:"bg-white rounded-lg shadow-sm flex flex-col h-full p-4 min-h-0 overflow-hidden"},ta={class:"mb-4 flex-shrink-0 flex items-center justify-between"},sa={class:"flex-1 flex flex-col min-h-0"},oa={class:"flex items-center justify-between text-xs text-gray-500 mt-2 flex-shrink-0"},ra={class:"mt-4 flex justify-end flex-shrink-0"},aa=["disabled"],la={key:0,class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},na={class:"flex flex-col flex-1 min-h-0"},ia={class:"bg-white rounded-lg shadow-sm flex flex-col h-full min-h-0 overflow-hidden"},ua={class:"p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0"},da={class:"flex items-center space-x-3"},ca={class:"flex items-center space-x-2"},ma={class:"flex items-center cursor-pointer"},pa=["checked"],ga={class:"text-sm text-gray-600"},va={key:0,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},fa={key:1,class:"flex-1 flex flex-col min-h-0 overflow-hidden p-4"},ya={key:0,class:"flex-1 flex flex-col min-h-0"},ha={key:0,class:"flex-1 flex flex-col overflow-hidden"},xa={class:"flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4"},ba={class:"text-xs text-gray-700 whitespace-pre-wrap font-mono"},wa={key:1,class:"flex-1 flex flex-col min-h-0"},_a={class:"flex-1 overflow-y-auto space-y-4 pr-2"},Pa={class:"border border-gray-200 rounded-lg p-4"},ka={class:"flex items-center justify-between mb-3"},$a={class:"w-full bg-gray-200 rounded-full h-3"},Sa={class:"grid grid-cols-2 gap-3"},Ca={class:"flex items-center justify-between mb-2"},za={class:"text-xs font-medium text-gray-700"},Ma={class:"text-xs text-gray-600"},Ia={key:0,class:"border border-orange-200 bg-orange-50 rounded-lg p-4"},Aa={class:"space-y-2"},Oa={class:"text-orange-600 mr-2 flex-shrink-0"},Ta={class:"flex-1"},La={key:0,class:"pt-4 mt-4 border-t border-gray-100 flex justify-end flex-shrink-0"},Ua=["disabled"],Ea={key:0,class:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},Ke="yprompt_optimize_cache",Ra="yprompt_optimize_active_mode",ja=Se({__name:"OptimizeSectionRedesign",props:{activeMode:{default:"system"}},emits:["update:active-mode"],setup(z,{emit:s}){const a=z,S=s,r=Xe(),h=je(),P=nt(),t=Je.getInstance(),R=Mt.getInstance(),N="https://api.prompt-ui.xiechengqi.top",T=f(!0),H=G({get:()=>a.activeMode,set:v=>{S("update:active-mode",v);try{localStorage.setItem(Ra,v)}catch($){console.error("保存activeMode失败:",$)}}}),w=()=>{try{const v=localStorage.getItem(Ke);return v?JSON.parse(v):null}catch{return null}},k=v=>{try{const J={...w()||{},...v};localStorage.setItem(Ke,JSON.stringify(J))}catch($){console.error("Failed to save optimize cache:",$)}},L=()=>{try{localStorage.removeItem(Ke)}catch(v){console.error("Failed to clear optimize cache:",v)}},g=w(),c=f((g==null?void 0:g.originalSystemPrompt)||"");f("");const o=f((g==null?void 0:g.optimizedSystemPrompt)||""),I=f(""),C=f((g==null?void 0:g.systemSuggestions)||[]);f([]);const u=f(!1);f(!1);const x=f((g==null?void 0:g.systemAnalysisResult)||null),n=f(null),l=f(!1),y=f((g==null?void 0:g.analysisStreamingText)||""),_=f((g==null?void 0:g.systemOptimizationStage)||0);f(0);const M=f((g==null?void 0:g.activeOptimizeTab)||"analysis"),K=f(!1),se=f(!1),W=f(!1),D=f(!1),q=f((g==null?void 0:g.formatState)||"markdown"),Q=f((g==null?void 0:g.languageState)||"zh");ut();const ae=f(!1),pe=f(!1),ue=f((g==null?void 0:g.currentPromptId)||null),ce=f((g==null?void 0:g.currentPromptTitle)||""),ye=G(()=>C.value.map(v=>v.description)),we=G({get:()=>typeof o.value=="string"?o.value:Q.value==="zh"?o.value.zh:o.value.en,set:v=>{typeof o.value=="string"?o.value=v:Q.value==="zh"?o.value.zh=v:o.value.en=v}}),Ce=f(`你是一个专业的助手。

主要职责：
1. 仔细分析用户的需求和问题
2. 提供准确、实用的解决方案
3. 确保解释清晰易懂

请始终保持专业、友好、耐心的语调，确保用户能够获得满意的帮助。`);f("你是一个专业的编程助手，擅长分析代码问题和提供解决方案。"),f([{role:"user",content:"我在Python中遇到了一个列表去重的问题。我有一个列表 `[1, 2, 2, 3, 4, 3, 5]`，想要得到去重后的结果 `[1, 2, 3, 4, 5]`，但想保持原来的顺序。请问有什么好的方法吗？"},{role:"assistant",content:`这是一个很好的问题！Python中有几种方法可以实现去重并保持顺序：

1. 使用dict.fromkeys()（Python 3.7+最简单）
2. 使用OrderedDict
3. 使用列表推导式

你想了解哪种方法的具体实现吗？`}]),G(()=>r.optimizedPrompts),G(()=>r.testResults),G(()=>r.isTesting);const he=r.setOptimizedPrompts;r.setTestResults;const oe=G({get:()=>r.systemPrompt||Ce.value,set:v=>{r.systemPrompt=v}}),j=async(v,$)=>{if(!(!v||!v.trim())){l.value=!0;try{const J=h.getAvailableProviders().find(Ue=>Ue.id===h.selectedProvider),F=h.selectedModel;if(!J||!F)throw new Error("请先选择AI提供商和模型");const te=xt.getQualityAnalysisSystemPrompt(),O=`请分析以下系统提示词的质量：

提示词内容：
${v}

请严格按照指定的JSON格式返回分析结果。`;y.value="";let X="";t.setStreamUpdateCallback(Ue=>{X+=Ue,y.value=X});const Oe=await t.callAI([{role:"system",content:te},{role:"user",content:O}],J,F,!0);let ke;try{ke=mt(Oe),console.log("✅ Parsed analysis result:",ke),console.log("📊 Issues found:",ke.issues),console.log("📝 Suggestions:",ke.suggestions)}catch(Ue){console.error("❌ Failed to parse analysis response:",Ue),console.error("📄 Original content:",Oe),ke={overall_score:75,analysis:{role:{score:75,status:"good",feedback:"角色定义基本完善"},task:{score:75,status:"good",feedback:"任务描述较为清晰"},format:{score:65,status:"needs_improvement",feedback:"输出格式可以更详细"},constraints:{score:70,status:"needs_improvement",feedback:"约束条件可以更明确"},example:{score:60,status:"needs_improvement",feedback:"建议添加示例说明"},language:{score:80,status:"good",feedback:"语言表达清晰"}},issues:["解析失败，无法获取详细问题分析"]}}return $==="system"&&(x.value=ke,k({systemAnalysisResult:ke,analysisStreamingText:X})),ke}catch(J){console.error("Analysis failed:",J);const F={overall_score:70,analysis:{role:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},task:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},format:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},constraints:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},example:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"},language:{score:70,status:"needs_improvement",feedback:"分析失败，请检查提示词"}},suggestions:["分析失败，请检查网络连接或重试"]};return x.value=F,F}finally{l.value=!1}}},V=()=>{confirm("确定要重新开始吗？这将清除所有输入和优化结果。")&&(oe.value="",c.value="",x.value=null,o.value="",C.value=[],_.value=0,u.value=!1,y.value="",M.value="analysis",q.value="markdown",Q.value="zh",D.value=!1,W.value=!1,K.value=!1,se.value=!1,ue.value=null,ce.value="",L(),P.success("已重置所有数据"))},le=async()=>{if(!(!(oe!=null&&oe.value)||!oe.value.trim())){c.value=oe.value,u.value=!0,_.value=0,y.value="",q.value="markdown",Q.value="zh",k({originalSystemPrompt:oe.value,formatState:"markdown",languageState:"zh"});try{const v=h.getAvailableProviders().find(O=>O.id===h.selectedProvider),$=h.selectedModel;if(!v||!$)throw new Error("请先选择AI提供商和模型");_.value=1,k({systemOptimizationStage:1}),l.value=!0,await j(oe.value,"system"),l.value=!1,_.value=2,k({systemOptimizationStage:2});let J="",F=!1;const te=await R.getOptimizationAdvice(oe.value,"system",$,"zh",[],v,O=>{J+=O,!F&&O.trim()&&(F=!0,C.value=[{id:"temp",type:"clarity",description:"正在生成...",priority:"medium",example:""}]);const X=J.split(`
`).map(ve=>ve.replace(/^[*-]\s*/,"").trim()).filter(Boolean);X.length>0&&(C.value=X.map((ve,Oe)=>({id:`sys_${Oe}`,type:"clarity",description:ve,priority:"medium",example:""})))});if(C.value=te.map((O,X)=>({id:`sys_${X}`,type:"clarity",description:O,priority:"medium",example:""})),k({systemSuggestions:C.value}),T.value){_.value=3,k({systemOptimizationStage:3}),q.value="markdown",Q.value="zh",k({formatState:"markdown",languageState:"zh"});let O=!1;o.value=await R.applyOptimizationAdvice(oe.value,te,"system",$,"zh",[],v,X=>{!O&&X.trim()&&(O=!0,o.value="正在生成..."),O&&(o.value==="正在生成..."?o.value=X:o.value+=X)}),he(o.value,I.value),k({optimizedSystemPrompt:o.value,activeOptimizeTab:"final"}),M.value="final"}}catch(v){console.error("System optimization failed:",v),C.value=[{id:"sys_fallback",type:"clarity",description:"增加更清晰的角色定义和职责说明",priority:"high",example:"优化了表达方式"}]}finally{u.value=!1}}},ee=async()=>{if(c.value){u.value=!0,_.value=2;try{const v=h.getAvailableProviders().find(O=>O.id===h.selectedProvider),$=h.selectedModel;if(!v||!$)throw new Error("请先选择AI提供商和模型");let J="",F=!1;const te=await R.getOptimizationAdvice(c.value,"system",$,"zh",[],v,O=>{J+=O,!F&&O.trim()&&(F=!0,C.value=[{id:"temp",type:"clarity",description:"正在生成...",priority:"medium",example:""}]);const X=J.split(`
`).map(ve=>ve.replace(/^[*-]\s*/,"").trim()).filter(Boolean);X.length>0&&(C.value=X.map((ve,Oe)=>({id:`sys_${Oe}`,type:"clarity",description:ve,priority:"medium",example:""})))});C.value=te.map((O,X)=>({id:`sys_${X}`,type:"clarity",description:O,priority:"medium",example:""}))}catch(v){console.error("Failed to generate advice:",v)}finally{u.value=!1}}};Z(()=>_.value,v=>{v>=1&&v<2&&(M.value="analysis")}),Z(()=>C.value,v=>{v&&v.length>0&&_.value>=2&&setTimeout(()=>{M.value="advice"},500)}),Z(()=>o.value,v=>{v&&_.value>=3&&setTimeout(()=>{M.value="final"},500)});const ge=async()=>{_.value=2,await le()},Ae=async()=>{const v=ye.value.join(`
`);try{await De(v),K.value=!0,setTimeout(()=>{K.value=!1},2e3)}catch($){console.error("Failed to copy:",$)}},_e=()=>{C.value.push({id:`sys_${Date.now()}`,type:"clarity",description:"新建议",priority:"medium",example:""})},Le=v=>{C.value.splice(v,1)},ze=(v,$)=>{C.value[v]&&(C.value[v].description=$)},me=async()=>{_.value=3,u.value=!0,q.value="markdown",Q.value="zh",k({formatState:"markdown",languageState:"zh"});try{const v=h.getAvailableProviders().find(F=>F.id===h.selectedProvider),$=h.selectedModel;if(!v||!$)throw new Error("请先选择AI提供商和模型");let J=!1;o.value=await R.applyOptimizationAdvice(c.value,ye.value,"system",$,"zh",[],v,F=>{!J&&F.trim()&&(J=!0,o.value="正在生成..."),J&&(o.value==="正在生成..."?o.value=F:o.value+=F)}),he(o.value,I.value)}catch(v){console.error("Failed to generate optimized prompt:",v),o.value=c.value+`

（已应用优化建议）`}finally{u.value=!1}},He=async()=>{const v=q.value,$=Q.value;await me(),v==="xml"&&o.value&&await d(),$==="en"&&o.value&&await m()},U=async()=>{try{await De(o.value),se.value=!0,setTimeout(()=>{se.value=!1},2e3)}catch(v){console.error("Failed to copy:",v)}},d=async()=>{if(!o.value||W.value||D.value)return;const v=h.getAvailableProviders().find(J=>J.id===h.selectedProvider),$=h.selectedModel;if(!v||!$){P.error("请先选择AI提供商和模型");return}try{W.value=!0;const J=q.value==="markdown"?"XML":"Markdown",F=q.value==="markdown"?"Markdown":"XML",te=await t.callAI([{role:"system",content:`你是一个专业的提示词格式转换助手。你的任务是将提示词从${F}格式转换为${J}格式，保持内容完全一致，只改变格式样式。

**重要规则**：
1. **绝对不能添加、删除或修改任何实质性内容**
2. **只能改变格式标记（如 Markdown 的 # 标题改为 XML 的 <section> 标签）**
3. **必须保留原文的所有信息和语义**
4. **不要添加任何解释、说明或额外的文字**
5. **直接输出转换后的结果，不要包含任何前言或后记**

${J==="XML"?`使用标准 XML 格式组织内容，遵循以下结构规范：
- 使用 <prompt> 作为根标签
- 使用 <section title="标题名"> 标记各个章节（注意：必须使用 title 属性，不要使用 name 或其他属性）
- 对于 Role 章节，格式为：<section title="Role">角色描述内容</section>
- 使用 <item> 标记列表项
- 使用 <rule> 标记规则条目
- 使用 <example> 标记示例

示例结构：
<prompt>
  <section title="Role">角色描述</section>
  <section title="Profile">
    <item>Author: xxx</item>
  </section>
</prompt>`:"使用 Markdown 语法：# 标题，- 列表，**粗体** 等组织内容。"}`},{role:"user",content:`请将以下提示词从${F}格式转换为${J}格式：

${o.value}`}],v,$,!1);if(te&&te.trim()){const O=Ze(te);o.value=O,q.value=q.value==="markdown"?"xml":"markdown",k({optimizedSystemPrompt:O,formatState:q.value}),P.success(`已转换为${J}格式`)}else P.error("格式转换失败：返回内容为空")}catch(J){console.error("Format conversion failed:",J),P.error("格式转换失败，请重试")}finally{W.value=!1}},m=async()=>{const v=typeof o.value=="string"?o.value:Q.value==="zh"?o.value.zh:o.value.en;if(!v||W.value||D.value)return;const $=h.getAvailableProviders().find(te=>te.id===h.selectedProvider),J=h.selectedModel;if(!$||!J){P.error("请先选择AI提供商和模型");return}const F=Q.value==="zh"?"en":"zh";if(typeof o.value!="string"&&(F==="zh"?o.value.zh:o.value.en)){Q.value=F,k({languageState:F}),P.success(`已切换为${F==="zh"?"中文":"英文"}版本`);return}try{D.value=!0;const te=F==="zh"?"中文":"英文",O=await t.callAI([{role:"system",content:`你是一个专业的AI提示词翻译助手。你的任务是将提示词翻译为${te}，同时保持提示词的专业性、准确性和完整性。

**重要规则**：
1. **必须保留所有原有的格式标记**（如 Markdown 的 #、- 或 XML 的标签）
2. **翻译必须准确传达原意**，特别是技术术语和指令
3. **保持提示词的专业语气和结构**
4. **不要添加任何额外的解释或说明**
5. **直接输出翻译结果，不要包含任何前言或后记**
6. **对于专有名词、技术术语，要使用行业标准译法**`},{role:"user",content:`请将以下AI提示词翻译为${te}：

${v}`}],$,J,!1);if(O&&O.trim()){const X=Ze(O);if(typeof o.value=="string"){const ve=o.value;o.value={zh:Q.value==="zh"?ve:X,en:Q.value==="en"?ve:X}}else F==="en"?o.value.en=X:o.value.zh=X;Q.value=F,k({optimizedSystemPrompt:o.value,languageState:F}),P.success(`已翻译为${te}版本`)}else P.error("语言转换失败：返回内容为空")}catch(te){console.error("Language conversion failed:",te),P.error("语言转换失败，请重试")}finally{D.value=!1}},xe=()=>{var v;if(!((v=o.value)!=null&&v.trim())){P.warning("没有可保存的优化结果");return}pe.value=!0},Me=async v=>{try{ae.value=!0;const $=localStorage.getItem("yprompt_token");if(!$){P.error("请先登录");return}const J=r.loadedPromptId||ue.value;console.log("💾 系统提示词保存:",{promptId:J,isUpdate:!!J,title:v.title,loadedPromptId:r.loadedPromptId,currentPromptId:ue.value});const F={...J?{id:J}:{},title:v.title,description:v.description,final_prompt:o.value,language:"zh",format:"markdown",prompt_type:v.promptType,tags:v.tags,is_public:v.isPublic?1:0,create_version:!0,change_type:"patch",change_summary:v.description||"优化系统提示词",change_log:"通过系统提示词优化功能更新",version_tag:"stable"};console.log("📤 发送保存请求:",{hasId:!!J,createVersion:!0,changeType:"patch"});const O=await(await fetch(`${N}/api/prompts/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$}`},body:JSON.stringify(F)})).json();if(O.code===200)console.log("✅ 保存成功:",{id:O.data.id,isNew:O.data.is_new,version:O.data.version,message:O.data.message}),ue.value=O.data.id,ce.value=v.title,O.data.is_new&&(r.setLoadedPromptId(O.data.id),console.log("🆕 新建提示词,设置loadedPromptId:",O.data.id)),k({currentPromptId:O.data.id,currentPromptTitle:v.title}),P.success(O.data.message||"保存成功"),pe.value=!1;else throw new Error(O.message||"保存失败")}catch($){console.error("保存提示词失败:",$),P.error(`保存失败: ${$.message}`)}finally{ae.value=!1}},Ie=()=>{if(!c.value||!o.value){P.warning("需要先完成优化才能对比");return}S("update:active-mode","compare");const v={mode:"system",originalPrompt:c.value,optimizedPrompt:typeof o.value=="string"?o.value:Q.value==="zh"?o.value.zh:o.value.en};localStorage.setItem("yprompt_comparison_data",JSON.stringify(v)),console.log("🔵 准备系统提示词对比:",v)},Pe=v=>v>=80?"text-green-600":v>=60?"text-yellow-600":"text-red-600",pt=v=>v>=80?"bg-green-500":v>=60?"bg-yellow-500":"bg-red-500",gt=v=>({role:"角色定义",task:"任务描述",format:"输出格式",constraints:"约束条件",example:"示例质量",language:"语言表达"})[v]||v;return(v,$)=>{var J,F,te;return H.value==="user"?(i(),be(Xr,{key:0})):H.value==="compare"?(i(),be(Qs,{key:1})):H.value==="system"?(i(),p("div",Wr,[e("div",Zr,[e("div",ea,[e("div",ta,[$[8]||($[8]=e("div",null,[e("h4",{class:"text-base font-semibold text-gray-800 mb-2"},"系统提示词")],-1)),e("button",{onClick:V,class:"flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"重新开始"},[B(b($e),{class:"w-4 h-4"}),$[7]||($[7]=e("span",null,"重新开始",-1))])]),e("div",sa,[ne(e("textarea",{"onUpdate:modelValue":$[0]||($[0]=O=>oe.value=O),placeholder:`在此输入系统提示词...

例如：你是一个专业的英语老师`,class:"w-full h-full p-3 border border-gray-300 rounded-lg focus:outline-none resize-none text-sm"},null,512),[[fe,oe.value]]),e("div",oa,[e("span",null,A(((J=oe.value)==null?void 0:J.length)||0)+" 字符",1),e("span",null,A(Math.ceil((((F=oe.value)==null?void 0:F.length)||0)/4))+" tokens",1)])]),e("div",ra,[e("button",{onClick:le,disabled:!((te=oe.value)!=null&&te.trim())||u.value,class:"px-6 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"},[u.value?(i(),p("svg",la,[...$[9]||($[9]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):E("",!0),e("span",null,A(u.value?"分析优化中...":"分析并优化"),1)],8,aa)])])]),e("div",na,[e("div",ia,[e("div",ua,[$[11]||($[11]=e("h4",{class:"font-semibold text-gray-800"},"优化预览",-1)),e("div",da,[e("div",ca,[e("label",ma,[e("input",{checked:T.value,onChange:$[1]||($[1]=O=>T.value=!T.value),type:"checkbox",class:"sr-only peer"},null,40,pa),e("span",ga,A(T.value?"自动：":"手动："),1),$[10]||($[10]=e("div",{class:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"},null,-1))])])])]),_.value===0?(i(),p("div",va,[B($t)])):E("",!0),_.value>=1?(i(),p("div",fa,[B(St,{"is-generating":u.value},{default:Ve(()=>[B(Fe,{"is-active":M.value==="analysis","active-class":"bg-orange-500 text-white",onClick:$[2]||($[2]=O=>M.value="analysis")},{default:Ve(()=>[...$[12]||($[12]=[re(" 质量分析 ",-1)])]),_:1},8,["is-active"]),_.value>=2?(i(),be(Fe,{key:0,"is-active":M.value==="advice","active-class":"bg-yellow-500 text-white",onClick:$[3]||($[3]=O=>M.value="advice")},{default:Ve(()=>[...$[13]||($[13]=[re(" 优化建议 ",-1)])]),_:1},8,["is-active"])):E("",!0),_.value>=3?(i(),be(Fe,{key:1,"is-active":M.value==="final","active-class":"bg-blue-500 text-white",onClick:$[4]||($[4]=O=>M.value="final")},{default:Ve(()=>[...$[14]||($[14]=[re(" 优化结果 ",-1)])]),_:1},8,["is-active"])):E("",!0)]),_:1},8,["is-generating"]),M.value==="analysis"?(i(),p("div",ya,[l.value?(i(),p("div",ha,[e("div",xa,[e("pre",ba,A(y.value||"AI正在分析中..."),1)])])):x.value?(i(),p("div",wa,[e("div",_a,[e("div",Pa,[e("div",ka,[$[15]||($[15]=e("h4",{class:"text-sm font-medium text-gray-700"},"整体评分",-1)),e("span",{class:Y([Pe(x.value.overall_score),"text-2xl font-bold"])},A(x.value.overall_score)+"/100 ",3)]),e("div",$a,[e("div",{class:Y([pt(x.value.overall_score),"h-3 rounded-full transition-all duration-500"]),style:it({width:`${x.value.overall_score}%`})},null,6)])]),e("div",Sa,[(i(!0),p(ie,null,de(x.value.analysis,(O,X)=>(i(),p("div",{key:X,class:"border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow"},[e("div",Ca,[e("span",za,A(gt(X)),1),e("span",{class:Y(["text-lg font-bold",Pe(O.score)])},A(O.score),3)]),e("p",Ma,A(O.feedback),1)]))),128))]),x.value.issues&&x.value.issues.length>0?(i(),p("div",Ia,[$[16]||($[16]=e("h4",{class:"text-sm font-semibold text-orange-900 mb-3 flex items-center"},[e("svg",{class:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})]),re(" 发现的具体问题 ")],-1)),e("ul",Aa,[(i(!0),p(ie,null,de(x.value.issues,(O,X)=>(i(),p("li",{key:X,class:"text-sm text-orange-800 flex items-start"},[e("span",Oa,A(X+1)+".",1),e("span",Ta,A(O),1)]))),128))])])):E("",!0)]),!T.value&&_.value===1?(i(),p("div",La,[e("button",{onClick:ee,disabled:u.value,class:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"},[u.value?(i(),p("svg",Ea,[...$[17]||($[17]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):E("",!0),e("span",null,A(u.value?"生成中...":"生成优化建议"),1)],8,Ua)])):E("",!0)])):E("",!0)])):E("",!0),M.value==="advice"?(i(),be(Ct,{key:1,advice:ye.value,"is-auto-mode":T.value,"is-executing":u.value,"is-generating":u.value,"current-execution-step":_.value===3?"final":"advice","is-copied":K.value,onRegenerate:ge,onCopy:Ae,onAddItem:_e,onRemoveItem:Le,onUpdateItem:ze,onExecuteFinal:me},null,8,["advice","is-auto-mode","is-executing","is-generating","current-execution-step","is-copied"])):E("",!0),M.value==="final"?(i(),be(zt,{key:2,"generated-prompt":we.value,"onUpdate:generatedPrompt":$[5]||($[5]=O=>we.value=O),"is-executing":!1,"is-generating":u.value,"current-execution-step":null,"is-copied":se.value,"is-converting-format":W.value,"is-converting-language":D.value,"is-saving":ae.value,"format-state":q.value,"language-state":Q.value,"show-compare-button":!0,onRegenerate:He,onCopy:U,onToggleFormat:d,onToggleLanguage:m,onSavePrompt:xe,onCompare:Ie},null,8,["generated-prompt","is-generating","is-copied","is-converting-format","is-converting-language","is-saving","format-state","language-state"])):E("",!0)])):E("",!0)])]),B(_t,{"is-open":pe.value,"prompt-content":we.value,"is-saving":ae.value,onSave:Me,onCancel:$[6]||($[6]=O=>pe.value=!1)},null,8,["is-open","prompt-content","is-saving"])])):E("",!0)}}}),Ha={class:"diff-viewer"},Va={class:"flex items-center justify-between mb-4"},Na={class:"flex items-center space-x-2"},Da={class:"text-sm text-gray-600"},Ja={class:"flex space-x-4 mb-4 border-b"},Ba={class:"bg-white border rounded-lg overflow-hidden"},Fa={class:"max-h-96 overflow-y-auto"},Ga={class:"font-mono text-sm"},Ka={class:"flex items-start"},qa={class:"inline-block w-8 text-xs text-gray-400 select-none"},Qa={class:"flex-1 whitespace-pre-wrap"},Ya={class:"mt-4 flex items-center justify-between text-sm text-gray-600"},Xa={class:"flex items-center space-x-4"},Wa={class:"flex items-center"},Za={class:"flex items-center"},el={class:"flex items-center"},tl=Se({__name:"DiffViewer",props:{leftContent:{},rightContent:{},leftLabel:{default:"原始版本"},rightLabel:{default:"当前版本"}},emits:["close"],setup(z,{emit:s}){const a=z,S=f("system"),r=(w,k)=>{const L=w.split(`
`),g=k.split(`
`),c=[];let o=0,I=0;for(;o<L.length||I<g.length;){const C=L[o],u=g[I];o>=L.length?(c.push({type:"insert",content:u,rightLine:I+1}),I++):I>=g.length?(c.push({type:"delete",content:C,leftLine:o+1}),o++):C===u?(c.push({type:"equal",content:C,leftLine:o+1,rightLine:I+1}),o++,I++):(c.push({type:"delete",content:C,leftLine:o+1}),c.push({type:"insert",content:u,rightLine:I+1}),o++,I++)}return c},h=G(()=>({left:a.leftContent,right:a.rightContent})),P=G(()=>r(h.value.left,h.value.right)),t=G(()=>{let w=0,k=0,L=0;return P.value.forEach(g=>{g.type==="insert"?w++:g.type==="delete"?k++:g.type==="modify"&&L++}),{additions:w,deletions:k,modifications:L}}),R=w=>{switch(w.type){case"insert":return"bg-green-50 border-l-4 border-green-400";case"delete":return"bg-red-50 border-l-4 border-red-400";case"modify":return"bg-blue-50 border-l-4 border-blue-400";default:return"bg-gray-50"}},N=(w,k)=>w.type==="equal"?`${w.leftLine||""}`:w.type==="insert"?w.rightLine?`${w.rightLine}`:"":w.type==="delete"&&w.leftLine?`${w.leftLine}`:"",T=w=>w.content,H=()=>{const w=P.value.map(k=>`${k.type==="insert"?"+":k.type==="delete"?"-":" "}${k.content}`).join(`
`);De(w).then(()=>{console.log("Diff copied to clipboard")})};return Z([()=>a.leftContent,()=>a.rightContent],()=>{},{immediate:!0}),(w,k)=>(i(),p("div",Ha,[e("div",Va,[k[4]||(k[4]=e("h3",{class:"text-lg font-semibold text-gray-800"},"版本对比",-1)),e("div",Na,[e("span",Da,A(w.leftLabel)+" vs "+A(w.rightLabel),1),e("button",{onClick:k[0]||(k[0]=L=>w.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[...k[3]||(k[3]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])]),e("div",Ja,[e("button",{onClick:k[1]||(k[1]=L=>S.value="system"),class:Y(["px-4 py-2 text-sm font-medium transition-colors border-b-2",S.value==="system"?"text-blue-600 border-blue-600":"text-gray-500 border-transparent hover:text-gray-700"])}," 系统提示词 ",2),e("button",{onClick:k[2]||(k[2]=L=>S.value="user"),class:Y(["px-4 py-2 text-sm font-medium transition-colors border-b-2",S.value==="user"?"text-blue-600 border-blue-600":"text-gray-500 border-transparent hover:text-gray-700"])}," 用户提示词 ",2)]),e("div",Ba,[e("div",Fa,[e("div",Ga,[(i(!0),p(ie,null,de(P.value,(L,g)=>(i(),p("div",{key:g,class:Y([R(L),"px-4 py-1 border-b border-gray-100 last:border-b-0"])},[e("div",Ka,[e("span",qa,A(N(L)),1),e("span",Qa,A(T(L)),1)])],2))),128))])])]),e("div",Ya,[e("div",Xa,[e("span",Wa,[k[5]||(k[5]=e("span",{class:"w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"},null,-1)),re(" 新增 "+A(t.value.additions)+" 行 ",1)]),e("span",Za,[k[6]||(k[6]=e("span",{class:"w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"},null,-1)),re(" 删除 "+A(t.value.deletions)+" 行 ",1)]),e("span",el,[k[7]||(k[7]=e("span",{class:"w-3 h-3 bg-blue-100 border border-blue-300 rounded mr-1"},null,-1)),re(" 修改 "+A(t.value.modifications)+" 行 ",1)])]),e("button",{onClick:H,class:"text-blue-600 hover:text-blue-700 flex items-center gap-1"},[...k[8]||(k[8]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),re(" 复制Diff ",-1)])])])]))}}),sl={class:"w-full h-full flex flex-col overflow-hidden p-2"},ol={class:"bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0"},rl={class:"flex space-x-2 mt-4"},al=["onClick"],ll={class:"flex-1 min-h-0 overflow-hidden"},nl={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},il={class:"bg-white rounded-lg p-6 max-w-4xl max-h-[90vh] w-[90vw] overflow-hidden"},Ee="yprompt_optimize_active_mode",ul=Se({__name:"OptimizeModule",setup(z){const s=ut(),a=je(),S=bt(),r=Xe();Je.getInstance();const{activeTab:h,systemPrompt:P,optimizedPrompts:t,switchTab:R}=r,N=f(!1),T=f("system"),H=f(window.innerWidth),w=f(!1);if(!s.params.id)try{const o=localStorage.getItem(Ee);o&&["system","user","compare"].includes(o)&&(T.value=o)}catch(o){console.error("读取activeMode失败:",o)}G(()=>H.value>=1200);const k=[{key:"system",label:"系统提示词优化"},{key:"user",label:"用户提示词优化"},{key:"compare",label:"效果对比"}],L=o=>{T.value=o;try{localStorage.setItem(Ee,o)}catch(I){console.error("保存activeMode失败:",I)}},g=()=>{H.value=window.innerWidth},c=async o=>{var I,C,u,x;w.value=!0;try{const n="https://api.prompt-ui.xiechengqi.top",l=localStorage.getItem("yprompt_token");if(!l)throw new Error("请先登录");const _=await(await fetch(`${n}/api/prompts/${o}`,{headers:{Authorization:`Bearer ${l}`}})).json();if(_.code===200){const M=_.data;if(console.log("🟢 加载提示词成功:",{id:M.id,title:M.title,type:M.prompt_type,final_prompt_length:(I=M.final_prompt)==null?void 0:I.length,system_prompt_length:(C=M.system_prompt)==null?void 0:C.length,conversation_history_length:(u=M.conversation_history)==null?void 0:u.length}),M.prompt_type==="user"){T.value="user",r.setLoadedPromptId(M.id),console.log("🔵 用户提示词 - 设置loadedPromptId:",M.id);const K={draftPrompt:M.final_prompt||"",systemPrompt:M.system_prompt||"",conversationHistory:M.conversation_history||""};console.log("🔵 保存用户提示词数据到localStorage:",K),localStorage.setItem("yprompt_optimize_loaded_user_prompt",JSON.stringify(K))}else T.value="system",r.systemPrompt=M.final_prompt,r.setLoadedPromptId(M.id),console.log("🔵 系统提示词 - 设置loadedPromptId:",M.id),console.log("🔵 设置系统提示词到store:",(x=M.final_prompt)==null?void 0:x.substring(0,50));localStorage.setItem(Ee,T.value)}else throw new Error(_.message||"加载失败")}catch(n){console.error("加载提示词失败:",n);const{useNotificationStore:l}=await st(async()=>{const{useNotificationStore:_}=await import("./index-CgStLW2f.js").then(M=>M.ac);return{useNotificationStore:_}},__vite__mapDeps([1,2]));l().error(`加载失败: ${n.message}`,3e3)}finally{w.value=!1}};return Z(()=>s.params.id,o=>{o&&c(Number(o))},{immediate:!0}),Be(()=>{window.addEventListener("resize",g),a.loadSettings(),S.isInitialized||S.initialize();const o=setInterval(()=>{if(localStorage.getItem("yprompt_trigger_compare")==="true"&&(console.log("🟢 检测到对比触发，切换到compare模式"),T.value="compare",localStorage.removeItem("yprompt_trigger_compare"),localStorage.setItem(Ee,"compare")),localStorage.getItem("yprompt_back_to_optimize")==="true"){console.log("🟢 检测到返回触发，切换回优化模式");const u=localStorage.getItem(Ee);u&&["system","user"].includes(u)&&(T.value=u),localStorage.removeItem("yprompt_back_to_optimize")}},100);We(()=>{clearInterval(o)})}),We(()=>{window.removeEventListener("resize",g)}),(o,I)=>(i(),p("div",sl,[e("div",ol,[I[2]||(I[2]=e("div",{class:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"},[e("div",{class:"min-w-0"},[e("h2",{class:"text-xl lg:text-2xl font-bold text-gray-800 mb-1"},"提示词优化")])],-1)),e("div",rl,[(i(),p(ie,null,de(k,C=>e("button",{key:C.key,onClick:u=>L(C.key),class:Y(["px-4 py-2 rounded-lg text-sm font-medium transition-colors",T.value===C.key?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"])},A(C.label),11,al)),64))])]),e("div",ll,[B(ja,{"active-mode":T.value,"onUpdate:activeMode":I[0]||(I[0]=C=>T.value=C)},null,8,["active-mode"])]),N.value?(i(),p("div",nl,[e("div",il,[B(tl,{"left-content":b(P),"right-content":b(t).system,"left-label":"原始版本","right-label":"优化版本",onClose:I[1]||(I[1]=C=>N.value=!1)},null,8,["left-content","right-content"])])])):E("",!0)]))}}),vl=wt(ul,[["__scopeId","data-v-69e5658e"]]);export{vl as default};
